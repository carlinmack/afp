<div id="Data">
<div class="head">
<h1>Theory Data</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Data›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory defines the data types and notations, and some preliminary results about them.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Data
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Function notations›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ε</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span>  <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">;;</span>_"</span> 20<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">;;</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> None <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Data-dom_combination_dom_union"><span class="command">lemma</span></span> dom_combination_dom_union<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="free">τ</span><span class="main">;;</span><span class="free">τ'</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">τ</span> <span class="main">∪</span> dom <span class="free">τ'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Values, expressions and execution contexts›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> const <span class="main">=</span> Unit <span class="main">|</span> F <span class="main">|</span> T

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>RID<span class="hidden">⇩</span><sub>V</sub><span class="main">:</span> <span class="tfree">'r</span><span class="main">,</span> LID<span class="hidden">⇩</span><sub>V</sub><span class="main">:</span> <span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> val <span class="main">=</span> 
  CV <span class="quoted">const</span>
<span class="main">|</span> Var <span class="tfree"><span class="quoted"><span class="tfree">'v</span></span></span>
<span class="main">|</span> Loc <span class="tfree"><span class="quoted"><span class="tfree">'l</span></span></span>
<span class="main">|</span> Rid <span class="tfree"><span class="quoted"><span class="tfree">'r</span></span></span>
<span class="main">|</span> Lambda <span class="tfree"><span class="quoted"><span class="tfree">'v</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="main">(</span>RID<span class="hidden">⇩</span><sub>E</sub><span class="main">:</span> <span class="tfree">'r</span><span class="main">,</span> LID<span class="hidden">⇩</span><sub>E</sub><span class="main">:</span> <span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">=</span>
  VE <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> val"</span></span>
<span class="main">|</span> Apply <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>
<span class="main">|</span> Ite <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>
<span class="main">|</span> Ref <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>
<span class="main">|</span> Read <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>
<span class="main">|</span> Assign <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>
<span class="main">|</span> Rfork <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>
<span class="main">|</span> Rjoin <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>RID<span class="hidden">⇩</span><sub>C</sub><span class="main">:</span> <span class="tfree">'r</span><span class="main">,</span> LID<span class="hidden">⇩</span><sub>C</sub><span class="main">:</span> <span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> cntxt <span class="main">=</span> 
  Hole <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">□</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>
<span class="main">|</span> ApplyL<span class="hidden">⇩</span><sub>ℰ</sub> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> cntxt"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span> 
<span class="main">|</span> ApplyR<span class="hidden">⇩</span><sub>ℰ</sub> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> val"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> cntxt"</span></span>
<span class="main">|</span> Ite<span class="hidden">⇩</span><sub>ℰ</sub> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> cntxt"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>
<span class="main">|</span> Ref<span class="hidden">⇩</span><sub>ℰ</sub> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> cntxt"</span></span>
<span class="main">|</span> Read<span class="hidden">⇩</span><sub>ℰ</sub> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> cntxt"</span></span>
<span class="main">|</span> AssignL<span class="hidden">⇩</span><sub>ℰ</sub> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> cntxt"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>
<span class="main">|</span> AssignR<span class="hidden">⇩</span><sub>ℰ</sub> <span class="tfree"><span class="quoted"><span class="tfree">'l</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> cntxt"</span></span>
<span class="main">|</span> Rjoin<span class="hidden">⇩</span><sub>ℰ</sub> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> cntxt"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Plugging and decomposing›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">plug</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> cntxt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊲</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">□</span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"ApplyL<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Apply <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"ApplyR<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Apply <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"Ite<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Ite <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"Ref<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Ref <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"Read<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Read <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"AssignL<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Assign <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"AssignR<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Assign <span class="main">(</span>VE <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"Rjoin<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Rjoin <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="free">ℰ</span><span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="free">ℰ</span> <span class="main">⊲</span> <span class="free">x</span>"</span>

<span class="keyword1" id="Data-injective_cntxt"><span class="command">lemma</span></span> injective_cntxt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℰ</span><span class="main">[</span><span class="free">e1</span><span class="main">]</span> <span class="main">=</span> <span class="free">ℰ</span><span class="main">[</span><span class="free">e2</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ℰ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Data-VE_empty_cntxt"><span class="command">lemma</span></span> VE_empty_cntxt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>VE <span class="free">v</span> <span class="main">=</span> <span class="free">ℰ</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ℰ</span> <span class="main">=</span> <span class="main">□</span> <span class="main">∧</span> VE <span class="free">v</span> <span class="main">=</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ℰ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">redex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Apply <span class="main">(</span>VE <span class="main">(</span>Lambda <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> iteTrue<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Ite <span class="main">(</span>VE <span class="main">(</span>CV T<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> iteFalse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Ite <span class="main">(</span>VE <span class="main">(</span>CV F<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> ref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Ref <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> read<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Read <span class="main">(</span>VE <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Assign <span class="main">(</span>VE <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> rfork<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Rfork <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> rjoin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">redex</span> <span class="main">(</span>Rjoin <span class="main">(</span>VE <span class="main">(</span>Rid <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_simps</span></span> redex_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"redex <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> redexE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"redex <span class="free">e</span>"</span></span>

<span class="keyword1" id="Data-plugged_redex_not_val"><span class="command">lemma</span></span> plugged_redex_not_val <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"redex <span class="free">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ℰ</span> <span class="main">⊲</span> <span class="free">r</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span>VE <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ℰ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">decompose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> cntxt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  top_redex<span class="main">:</span> <span class="quoted"><span class="quoted">"redex <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟹</span> <span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">□</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> lapply<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span>redex <span class="main">(</span>Apply <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">decompose</span> <span class="main">(</span>Apply <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>ApplyL<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> rapply<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span>redex <span class="main">(</span>Apply <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">decompose</span> <span class="main">(</span>Apply <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>ApplyR<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> ite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span>redex <span class="main">(</span>Ite <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>3</sub></span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">decompose</span> <span class="main">(</span>Ite <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>3</sub></span></span></span><span class="main">)</span> <span class="main">(</span>Ite<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>3</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> ref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span>redex <span class="main">(</span>Ref <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">decompose</span> <span class="main">(</span>Ref <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>Ref<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> read<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span>redex <span class="main">(</span>Read <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">decompose</span> <span class="main">(</span>Read <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>Read<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> lassign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span>redex <span class="main">(</span>Assign <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">decompose</span> <span class="main">(</span>Assign <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>AssignL<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> rassign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span>redex <span class="main">(</span>Assign <span class="main">(</span>VE <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">decompose</span> <span class="main">(</span>Assign <span class="main">(</span>VE <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>AssignR<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> rjoin<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span>redex <span class="main">(</span>Rjoin <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">decompose</span> <span class="main">(</span>Rjoin <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>Rjoin<span class="hidden">⇩</span><sub>ℰ</sub> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> decomposeE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"decompose <span class="free">e</span> <span class="free">ℰ</span> <span class="free">r</span>"</span></span>

<span class="keyword1" id="Data-plug_decomposition_equivalence"><span class="command">lemma</span></span> plug_decomposition_equivalence<span class="main">:</span> <span class="quoted"><span class="quoted">"redex <span class="free">r</span> <span class="main">⟹</span> decompose <span class="free">e</span> <span class="free">ℰ</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">ℰ</span><span class="main">[</span><span class="free">r</span><span class="main">]</span> <span class="main">=</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose <span class="free">e</span> <span class="free">ℰ</span> <span class="free">r</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℰ</span><span class="main">[</span><span class="free">r</span><span class="main">]</span> <span class="main">=</span> <span class="free">e</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> x <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main">:</span> decompose.induct›</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>top_redex <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">□</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lapply <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ℰ</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ApplyL<span class="hidden">⇩</span><sub>ℰ</sub> <span class="skolem">ℰ</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">[</span><span class="skolem">r</span><span class="main">]</span> <span class="main">=</span> Apply <span class="main">(</span><span class="skolem">ℰ</span><span class="main">[</span><span class="skolem">r</span><span class="main">]</span><span class="main">)</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Apply <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ℰ</span><span class="main">[</span><span class="skolem">r</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> red<span class="main">:</span> <span class="quoted"><span class="quoted">"redex <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℰ</span><span class="main">[</span><span class="free">r</span><span class="main">]</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decompose <span class="main">(</span><span class="free">ℰ</span><span class="main">[</span><span class="free">r</span><span class="main">]</span><span class="main">)</span> <span class="free">ℰ</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ℰ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> red <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">:</span> decompose.intros›</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"decompose <span class="free">e</span> <span class="free">ℰ</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Data-unique_decomposition"><span class="command">lemma</span></span> unique_decomposition<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose <span class="free">e</span> <span class="free">ℰ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> decompose <span class="free">e</span> <span class="free">ℰ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">ℰ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">ℰ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ℰ<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> decompose.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Data-completion_eq"><span class="command">lemma</span></span> completion_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    red_e<span class="main">:</span> <span class="quoted"><span class="quoted">"redex <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    red_e'<span class="main">:</span> <span class="quoted"><span class="quoted">"redex <span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℰ</span><span class="main">[</span><span class="free">r</span><span class="main">]</span> <span class="main">=</span> <span class="free">ℰ'</span><span class="main">[</span><span class="free">r'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ℰ</span> <span class="main">=</span> <span class="free">ℰ'</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℰ</span><span class="main">[</span><span class="free">r</span><span class="main">]</span> <span class="main">=</span> <span class="free">ℰ'</span><span class="main">[</span><span class="free">r'</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">ℰ</span> <span class="main">=</span> <span class="free">ℰ'</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℰ</span><span class="main">[</span><span class="free">r</span><span class="main">]</span> <span class="main">=</span> <span class="free">ℰ'</span><span class="main">[</span><span class="free">r'</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decompose <span class="main">(</span><span class="free">ℰ</span><span class="main">[</span><span class="free">r</span><span class="main">]</span><span class="main">)</span> <span class="free">ℰ</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> plug_decomposition_equivalence red_e <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> fst_decomp<span class="main">:</span><span class="quoted"><span class="quoted">"decompose <span class="main">(</span><span class="free">ℰ'</span><span class="main">[</span><span class="free">r'</span><span class="main">]</span><span class="main">)</span> <span class="free">ℰ</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> snd_decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose <span class="main">(</span><span class="free">ℰ'</span><span class="main">[</span><span class="free">r'</span><span class="main">]</span><span class="main">)</span> <span class="free">ℰ'</span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> plug_decomposition_equivalence red_e' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> cntxts_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℰ</span> <span class="main">=</span> <span class="free">ℰ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fst_decomp snd_decomp unique_decomposition <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cntxts_eq eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Stores and states›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> store <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'l</span> <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> val"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> local_state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> store <span class="main">×</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> store <span class="main">×</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'r</span> <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> local_state"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">doms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> local_state <span class="main">⇒</span> <span class="tfree">'l</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">doms</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">∪</span> dom <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">LID_snapshot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> local_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> store"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span>"</span> 200<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LID_snapshot</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">LID_local_store</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> local_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> store"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇩</span><sub>τ</sub></span>"</span> 200<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LID_local_store</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">LID_expression</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> local_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇩</span><sub>e</sub></span>"</span> 200<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LID_expression</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Occurrences">
<div class="head">
<h1>Theory Occurrences</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="plain_text">Occurrences</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains all of the definitions and laws required for reasoning about
  identifiers that occur in the data structures of the concurrent revisions model.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Occurrences
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Data.html">Data</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="plain_text">Definitions</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Revision identifiers›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">RID<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> store <span class="main">⇒</span> <span class="tfree">'r</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RID<span class="hidden">⇩</span><sub>S</sub></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="main">(</span>RID<span class="hidden">⇩</span><sub>V</sub> <span class="main">`</span> ran <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">RID<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> local_state <span class="main">⇒</span> <span class="tfree">'r</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RID<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">τ</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="bound">σ</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="bound">τ</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="bound">e</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">RID<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> <span class="tfree">'r</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RID<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> dom <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∪</span> <span class="main">⋃</span> <span class="main">(</span>RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">`</span> ran <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Location identifiers›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LID<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> store <span class="main">⇒</span> <span class="tfree">'l</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LID<span class="hidden">⇩</span><sub>S</sub></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> dom <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">∪</span> <span class="main">⋃</span> <span class="main">(</span>LID<span class="hidden">⇩</span><sub>V</sub> <span class="main">`</span> ran <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LID<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> local_state <span class="main">⇒</span> <span class="tfree">'l</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LID<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">τ</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="bound">σ</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="bound">τ</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="bound">e</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LID<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> <span class="tfree">'l</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LID<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="main">(</span>LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">`</span> ran <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inference rules›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Introduction and elimination rules›</span></span>

<span class="keyword1" id="Occurrences-RID"><span class="command">lemma</span></span> RID<span class="hidden">⇩</span><sub>S</sub>I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">l</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RID<span class="hidden">⇩</span><sub>S</sub>_def ran_def<span class="main">)</span>

<span class="keyword1" id="Occurrences-RID"><span class="command">lemma</span></span> RID<span class="hidden">⇩</span><sub>S</sub>E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">l</span> <span class="bound">v</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">l</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="bound">v</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RID<span class="hidden">⇩</span><sub>S</sub>_def ran_def<span class="main">)</span>

<span class="keyword1" id="Occurrences-RID"><span class="command">lemma</span></span> RID<span class="hidden">⇩</span><sub>L</sub>I <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RID<span class="hidden">⇩</span><sub>L</sub>_def assms<span class="main">)</span>

<span class="keyword1" id="Occurrences-RID"><span class="command">lemma</span></span> RID<span class="hidden">⇩</span><sub>L</sub>E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="free">s</span><span class="main">;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span> <span class="bound">e</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">τ</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="bound">τ</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="bound">e</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RID<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">)</span>

<span class="keyword1" id="Occurrences-RID"><span class="command">lemma</span></span> RID<span class="hidden">⇩</span><sub>G</sub>I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r'</span> <span class="main">=</span> Some <span class="free">ls</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RID<span class="hidden">⇩</span><sub>G</sub>_def domI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> RID<span class="hidden">⇩</span><sub>G</sub>_def UN_I UnI2 ranI<span class="main">)</span>

<span class="keyword1" id="Occurrences-RID"><span class="command">lemma</span></span> RID<span class="hidden">⇩</span><sub>G</sub>E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> dom <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r'</span> <span class="bound">ls</span><span class="main">.</span> <span class="free">s</span> <span class="bound">r'</span> <span class="main">=</span> Some <span class="bound">ls</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="bound">ls</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RID<span class="hidden">⇩</span><sub>G</sub>_def ran_def<span class="main">)</span>

<span class="keyword1" id="Occurrences-LID"><span class="command">lemma</span></span> LID<span class="hidden">⇩</span><sub>S</sub>I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">l</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">l'</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LID<span class="hidden">⇩</span><sub>S</sub>_def ran_def<span class="main">)</span>

<span class="keyword1" id="Occurrences-LID"><span class="command">lemma</span></span> LID<span class="hidden">⇩</span><sub>S</sub>E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> dom <span class="free">σ</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l'</span> <span class="bound">v</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">l'</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="bound">v</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LID<span class="hidden">⇩</span><sub>S</sub>_def ran_def<span class="main">)</span>

<span class="keyword1" id="Occurrences-LID"><span class="command">lemma</span></span> LID<span class="hidden">⇩</span><sub>L</sub>I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="free">s</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="free">s</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LID<span class="hidden">⇩</span><sub>L</sub>_def assms<span class="main">)</span>

<span class="keyword1" id="Occurrences-LID"><span class="command">lemma</span></span> LID<span class="hidden">⇩</span><sub>L</sub>E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="free">s</span><span class="main">;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span> <span class="bound">e</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span> <span class="bound">τ</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="bound">τ</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="bound">e</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LID<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">)</span>

<span class="keyword1" id="Occurrences-LID"><span class="command">lemma</span></span> LID<span class="hidden">⇩</span><sub>G</sub>I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">ls</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LID<span class="hidden">⇩</span><sub>G</sub>_def LID<span class="hidden">⇩</span><sub>L</sub>_def ran_def<span class="main">)</span>

<span class="keyword1" id="Occurrences-LID"><span class="command">lemma</span></span> LID<span class="hidden">⇩</span><sub>G</sub>E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">r</span> <span class="bound">ls</span><span class="main">.</span> <span class="free">s</span> <span class="bound">r</span> <span class="main">=</span> Some <span class="bound">ls</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="bound">ls</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LID<span class="hidden">⇩</span><sub>G</sub>_def ran_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Distributive laws›</span></span>

<span class="keyword1" id="Occurrences-ID_distr_completion"><span class="command">lemma</span></span> ID_distr_completion <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="free">ℰ</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> RID<span class="hidden">⇩</span><sub>C</sub> <span class="free">ℰ</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="free">ℰ</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>C</sub> <span class="free">ℰ</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> plug.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Occurrences-ID_restricted_store_subset_store"><span class="command">lemma</span></span> ID_restricted_store_subset_store<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">≠</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">=</span> Some <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">l'</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">=</span> Some <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r_v <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l''</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="bound">l''</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l''</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="bound">l''</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="bound">v</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l''</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">l''</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l'_in_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">l''</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="skolem">l''</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l'_in_v <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Occurrences-in_restricted_store_in_unrestricted_store"><span class="command">lemma</span></span> in_restricted_store_in_unrestricted_store <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> contra_subsetD ID_restricted_store_subset_store<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Occurrences-in_restricted_store_in_updated_store"><span class="command">lemma</span></span> in_restricted_store_in_updated_store <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">l</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_complement_singleton_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">l</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> Some <span class="free">v</span><span class="main">,</span> <span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_complement_singleton_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">l</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_complement_singleton_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">l</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> Some <span class="free">v</span><span class="main">,</span> <span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_complement_singleton_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Occurrences-ID_distr_store"><span class="command">lemma</span></span> ID_distr_store <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">l</span> <span class="main">(</span>LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">=</span> Some <span class="skolem">v'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">=</span> <span class="free">l</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">l</span> <span class="main">(</span>LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l''</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="bound">l''</span> <span class="main">=</span> Some <span class="bound">v'</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="bound">v'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> insert <span class="free">l</span> <span class="main">(</span>LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> insert <span class="free">l</span> <span class="main">(</span>LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">=</span> <span class="free">l</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l''</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="bound">l''</span> <span class="main">=</span> Some <span class="bound">v'</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="bound">v'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l''</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l''</span> <span class="main">=</span> Some <span class="skolem">v'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> insert <span class="free">l</span> <span class="main">(</span>LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="skolem">l''</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Occurrences-ID_distr_local"><span class="command">lemma</span></span> ID_distr_local <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">τ</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">τ</span><span class="main">,</span><span class="free">e</span><span class="main">)</span> <span class="main">=</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LID<span class="hidden">⇩</span><sub>L</sub>_def RID<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Occurrences-ID_restricted_global_subset_unrestricted"><span class="command">lemma</span></span> ID_restricted_global_subset_unrestricted<span class="main">:</span>
  <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r''</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">r''</span> <span class="main">=</span> Some <span class="skolem">ls</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l_in_ls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">≠</span> <span class="free">r</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">r''</span> <span class="main">=</span> Some <span class="skolem">ls</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">r''</span> <span class="main">=</span> Some <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">r''</span> <span class="main">=</span> Some <span class="skolem">ls</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l_in_ls <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r''</span> <span class="bound">ls</span><span class="main">.</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="bound">r''</span> <span class="main">=</span> Some <span class="bound">ls</span> <span class="main">∧</span> <span class="skolem">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="bound">ls</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r''</span> <span class="bound">ls</span><span class="main">.</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="bound">r''</span> <span class="main">=</span> Some <span class="bound">ls</span> <span class="main">∧</span> <span class="skolem">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="bound">ls</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r''</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">r''</span> <span class="main">=</span> Some <span class="skolem">ls</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r'_in_ls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">≠</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">r''</span> <span class="main">=</span> Some <span class="skolem">ls</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">r''</span> <span class="main">=</span> Some <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">r''</span> <span class="main">=</span> Some <span class="skolem">ls</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r'_in_ls <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Occurrences-in_restricted_global_in_unrestricted_global"><span class="command">lemma</span></span> in_restricted_global_in_unrestricted_global <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ID_restricted_global_subset_unrestricted rev_subsetD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Occurrences-in_restricted_global_in_updated_global"><span class="command">lemma</span></span> in_restricted_global_in_updated_global <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">r</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_complement_singleton_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">r</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> Some <span class="free">ls</span><span class="main">,</span> <span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_complement_singleton_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">r</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_complement_singleton_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span> <span class="main">|`</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">r</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> Some <span class="free">ls</span><span class="main">,</span> <span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_complement_singleton_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Occurrences-ID_distr_global"><span class="command">lemma</span></span> ID_distr_global <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">r</span> <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">ls'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r'</span> <span class="main">=</span> Some <span class="skolem">ls'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="skolem">ls'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">r</span> <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r'</span> <span class="main">∈</span> insert <span class="free">r</span> <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> r'_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">≠</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r'_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> RID<span class="hidden">⇩</span><sub>G</sub>E<span class="main"><span class="main">[</span></span><span class="operator">OF</span> r'_g<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RID<span class="hidden">⇩</span><sub>G</sub>_def neq<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ls'</span> <span class="skolem">r''</span>
        <span class="keyword3"><span class="command">assume</span></span> r'_in_range<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r''</span> <span class="main">=</span> Some <span class="skolem">ls'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="skolem">ls'</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">=</span> <span class="free">r</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> neq r'_l <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Occurrences-restrictions_inwards"><span class="command">lemma</span></span> restrictions_inwards <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> Some <span class="free">y</span><span class="main">,</span> <span class="free">x'</span> <span class="main">:=</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x'</span><span class="main">:=</span> None<span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> Some <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fun_upd_twist<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous laws›</span></span>

<span class="keyword1" id="Occurrences-ID_combination_subset_union"><span class="command">lemma</span></span> ID_combination_subset_union <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="main">⊆</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span>"</span></span>
  <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="main">⊆</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="free">τ</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l'</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="bound">l'</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="free">τ</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l'</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="bound">l'</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="bound">v</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> dom <span class="free">τ</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Occurrences-in_combination_in_component"><span class="command">lemma</span></span> in_combination_in_component <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Un_iff ID_combination_subset_union subsetCE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Occurrences-in_mapped_in_component_of_combination"><span class="command">lemma</span></span> in_mapped_in_component_of_combination <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    maps_to_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    l'_in_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LID<span class="hidden">⇩</span><sub>S</sub>I<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> combine.simps l'_in_v maps_to_v<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Occurrences-elim_trivial_restriction"><span class="command">lemma</span></span> elim_trivial_restriction <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">τ</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LID<span class="hidden">⇩</span><sub>S</sub>_def domIff fun_upd_idem<span class="main">)</span>

<span class="keyword1" id="Occurrences-ID_distr_global_conditional"><span class="command">lemma</span></span> ID_distr_global_conditional<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">ls</span> <span class="main">⟹</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span> <span class="main">=</span> insert <span class="free">r</span> <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">ls</span> <span class="main">⟹</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">ls</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> s_as_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_idem<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span> <span class="main">=</span> insert <span class="free">r</span> <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> s_as_upd<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> s_as_upd<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Renaming">
<div class="head">
<h1>Theory Renaming</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="plain_text">Renaming</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Similar to the bound variables of lambda calculus, location and revision identifiers are meaningless
  names. This theory contains all of the definitions and results required for renaming data structures
  and proving renaming-equivalence.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Renaming
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Occurrences.html">Occurrences</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="plain_text">Definitions</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rename_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'r</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'l</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> val <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> val"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℛ<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> map_val <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> id <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rename_expr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'r</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'l</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℛ<span class="hidden">⇩</span><sub>E</sub></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> map_expr <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> id <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rename_cntxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'r</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'l</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> cntxt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> cntxt"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℛ<span class="hidden">⇩</span><sub>C</sub></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span> <span class="main">≡</span> map_cntxt <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> id <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_store_renaming</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'r</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'l</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> store <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> store <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">is_store_renaming</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">l</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">l</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> None <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="bound">v</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> Option.bind <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⤜</span>"</span> 80<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ℛ<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'r</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'l</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> store <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> store"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℛ<span class="hidden">⇩</span><sub>S</sub></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>inv <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Some <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>S</sub>_implements_renaming<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">β</span> <span class="main">⟹</span> is_store_renaming <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">β</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bij_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_store_renaming_def option.case_eq_if<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ℛ<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'r</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'l</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> local_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> local_state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℛ<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_global_renaming</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'r</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'l</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">is_global_renaming</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">r</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> None <span class="main">|</span> Some <span class="bound">ls</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="bound">ls</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ℛ<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'r</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'l</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℛ<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>inv <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ls</span><span class="main">.</span> Some <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="bound">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>G</sub>_implements_renaming<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">α</span> <span class="main">⟹</span> is_global_renaming <span class="free">α</span> <span class="free">β</span> <span class="free">s</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">α</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bij_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_global_renaming_def option.case_eq_if<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Introduction rules›</span></span>

<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>S</sub>I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    bij_β<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">β</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    none_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">l</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">σ'</span> <span class="main">(</span><span class="free">β</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    some_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">v</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">l</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> <span class="free">σ'</span> <span class="main">(</span><span class="free">β</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> ℛ<span class="hidden">⇩</span><sub>S</sub>.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span>inv <span class="free">β</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Some <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ'</span> <span class="skolem">l</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="free">σ'</span> <span class="skolem">l</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span>inv <span class="free">β</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> lhs_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">(</span><span class="free">β</span> <span class="main">(</span>inv <span class="free">β</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> none_case True<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> rhs_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="skolem">l</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_β bijection.intro bijection.inv_right<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lhs_none rhs_none<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> is_some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span>inv <span class="free">β</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> lhs_some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">(</span><span class="free">β</span> <span class="main">(</span>inv <span class="free">β</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_some some_case<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> rhs_some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="skolem">l</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_β bijection.intro bijection.inv_right<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lhs_some<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>G</sub>I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span>
    bij_α<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    none_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">s</span> <span class="bound">r</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">s'</span> <span class="main">(</span><span class="free">α</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    some_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">σ</span> <span class="bound">τ</span> <span class="bound">e</span><span class="main">.</span> <span class="free">s</span> <span class="bound">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">τ</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">s'</span> <span class="main">(</span><span class="free">α</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free">α</span> <span class="free">β</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">τ</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> ℛ<span class="hidden">⇩</span><sub>G</sub>.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>inv <span class="free">α</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ls</span><span class="main">.</span> Some <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free">α</span> <span class="free">β</span> <span class="bound">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">s'</span> <span class="skolem">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="free">s'</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>inv <span class="free">α</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> lhs_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">(</span><span class="free">α</span> <span class="main">(</span>inv <span class="free">α</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> none_case True<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> rhs_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="skolem">r</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_α bijection.intro bijection.inv_right<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lhs_none rhs_none<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>inv <span class="free">α</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> is_some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>inv <span class="free">α</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ls</span></span><span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> lhs_some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> Some <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free">α</span> <span class="free">β</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">(</span><span class="free">α</span> <span class="main">(</span>inv <span class="free">α</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free">α</span> <span class="free">β</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_some some_case<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> rhs_some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="skolem">r</span> <span class="main">=</span> Some <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free">α</span> <span class="free">β</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_α bijection.intro bijection.inv_right<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lhs_some<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Renaming-equivalence›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="plain_text">Identity</span>

<span class="keyword1"><span class="command">declare</span></span> val.map_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> expr.map_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> cntxt.map_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>S</sub>_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> id id <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>L</sub>_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>L</sub> id id <span class="free">ls</span> <span class="main">=</span> <span class="free">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>G</sub>_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> id id <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="plain_text">Composition</span>

<span class="keyword1"><span class="command">declare</span></span> val.map_comp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> expr.map_comp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> cntxt.map_comp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>S</sub>_comp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bij <span class="free">β</span><span class="main">;</span> bij <span class="free">β'</span> <span class="main">⟧</span> <span class="main">⟹</span> ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α'</span> <span class="free">β'</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">α'</span> <span class="main">∘</span> <span class="free">α</span><span class="main">)</span> <span class="main">(</span><span class="free">β'</span> <span class="main">∘</span> <span class="free">β</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_inv_distrib<span class="main">)</span>
<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>L</sub>_comp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bij <span class="free">β</span><span class="main">;</span> bij <span class="free">β'</span> <span class="main">⟧</span> <span class="main">⟹</span> ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free">α'</span> <span class="free">β'</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span><span class="free">α'</span> <span class="main">∘</span> <span class="free">α</span><span class="main">)</span> <span class="main">(</span><span class="free">β'</span> <span class="main">∘</span> <span class="free">β</span><span class="main">)</span> <span class="free">ls</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>G</sub>_comp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bij <span class="free">α</span><span class="main">;</span> bij <span class="free">α'</span><span class="main">;</span> bij <span class="free">β</span><span class="main">;</span> bij <span class="free">β'</span> <span class="main">⟧</span> <span class="main">⟹</span> ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α'</span> <span class="free">β'</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">α'</span> <span class="main">∘</span> <span class="free">α</span><span class="main">)</span> <span class="main">(</span><span class="free">β'</span> <span class="main">∘</span> <span class="free">β</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_inv_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="plain_text">Inverse</span>

<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>V</sub>_inv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bij <span class="free">α</span><span class="main">;</span> bij <span class="free">β</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="free">v'</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bijection.intro bijection.inv_comp_right bijection.inv_comp_left<span class="main">)</span>
<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>E</sub>_inv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bij <span class="free">α</span><span class="main">;</span> bij <span class="free">β</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="free">e'</span> <span class="main">=</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bijection.intro bijection.inv_comp_right bijection.inv_comp_left<span class="main">)</span>
<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>C</sub>_inv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bij <span class="free">α</span><span class="main">;</span> bij <span class="free">β</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="free">ℰ'</span> <span class="main">=</span> <span class="free">ℰ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">ℰ</span> <span class="main">=</span> <span class="free">ℰ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bijection.intro bijection.inv_comp_right bijection.inv_comp_left<span class="main">)</span>
<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>S</sub>_inv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bij <span class="free">α</span><span class="main">;</span> bij <span class="free">β</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="free">σ'</span> <span class="main">=</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_imp_bij_inv bijection.intro bijection.inv_comp_right bijection.inv_comp_left<span class="main">)</span>
<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>L</sub>_inv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bij <span class="free">α</span><span class="main">;</span> bij <span class="free">β</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="free">ls'</span> <span class="main">=</span> <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">ls</span> <span class="main">=</span> <span class="free">ls'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_imp_bij_inv bijection.intro bijection.inv_comp_right bijection.inv_comp_left<span class="main">)</span>
<span class="keyword1" id="Renaming-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>G</sub>_inv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bij <span class="free">α</span><span class="main">;</span> bij <span class="free">β</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_imp_bij_inv bijection.intro bijection.inv_comp_right bijection.inv_comp_left<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="plain_text">Equivalence</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_states</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≈</span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">α</span> <span class="bound">β</span><span class="main">.</span> bij <span class="bound">α</span> <span class="main">∧</span> bij <span class="bound">β</span> <span class="main">∧</span> ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="bound">α</span> <span class="bound">β</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span>"</span></span>

<span class="keyword1" id="Renaming-eq_statesI"><span class="command">lemma</span></span> eq_statesI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">⟹</span> bij <span class="free">α</span> <span class="main">⟹</span> bij <span class="free">β</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">≈</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eq_states_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Renaming-eq_statesE"><span class="command">lemma</span></span> eq_statesE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">α</span> <span class="bound">β</span><span class="main">.</span> ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="bound">α</span> <span class="bound">β</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">⟹</span> bij <span class="bound">α</span> <span class="main">⟹</span> bij <span class="bound">β</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eq_states_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Renaming-αβ_refl"><span class="command">lemma</span></span> αβ_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_statesI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
 
<span class="keyword1" id="Renaming-αβ_trans"><span class="command">lemma</span></span> αβ_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">s'</span> <span class="main">≈</span> <span class="free">s''</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">≈</span> <span class="free">s''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> s_s'<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="skolem">α</span>"</span></span> <span class="quoted"><span class="quoted">"bij <span class="skolem">β</span>"</span></span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">α</span> <span class="skolem">β</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">≈</span> <span class="free">s''</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="skolem"><span class="skolem">β'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'_s''<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="skolem">α'</span>"</span></span> <span class="quoted"><span class="quoted">"bij <span class="skolem">β'</span>"</span></span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">α'</span> <span class="skolem">β'</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">s''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">s''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_statesI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">α'</span></span></span> <span class="main"><span class="main"><span class="main">∘</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">α</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">β'</span></span></span> <span class="main"><span class="main"><span class="main">∘</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">β</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> s_s' s'_s'' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> bij_comp›</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renaming-αβ_sym"><span class="command">lemma</span></span> αβ_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">s'</span> <span class="main">≈</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> s_s'<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="skolem">α</span>"</span></span> <span class="quoted"><span class="quoted">"bij <span class="skolem">β</span>"</span></span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">α</span> <span class="skolem">β</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">≈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_statesI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"inv <span class="skolem"><span class="skolem"><span class="skolem">α</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"inv <span class="skolem"><span class="skolem"><span class="skolem">β</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> s_s' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> bij_imp_bij_inv›</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Distributive laws›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="plain_text">Expression</span>

<span class="keyword1" id="Renaming-renaming_distr_completion"><span class="command">lemma</span></span> renaming_distr_completion <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="main">(</span><span class="free">ℰ</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">ℰ</span><span class="main">)</span><span class="main">[</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">e</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ℰ</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="plain_text">Store</span>

<span class="keyword1" id="Renaming-renaming_distr_combination"><span class="command">lemma</span></span> renaming_distr_combination <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">;;</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Renaming-renaming_distr_store"><span class="command">lemma</span></span> renaming_distr_store <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij <span class="free">β</span> <span class="main">⟹</span> ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="main">(</span><span class="free">σ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">(</span><span class="free">β</span> <span class="free">l</span> <span class="main">↦</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bijection.intro bijection.inv_left_eq_iff<span class="main">)</span>

<span class="comment1">(* distribution law for local follows from the definition *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="plain_text">Global</span> 

<span class="keyword1" id="Renaming-renaming_distr_global"><span class="command">lemma</span></span> renaming_distr_global <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij <span class="free">α</span> <span class="main">⟹</span> ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">(</span><span class="free">α</span> <span class="free">r</span> <span class="main">↦</span> ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"bij <span class="free">α</span> <span class="main">⟹</span> ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span><span class="main">(</span><span class="free">α</span> <span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bijection.intro bijection.inv_left_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous laws›</span></span>

<span class="keyword1" id="Renaming-rename_empty"><span class="command">lemma</span></span> rename_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> ε <span class="main">=</span> ε"</span></span>
  <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> ε <span class="main">=</span> ε"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="plain_text">Swaps</span>

<span class="keyword1" id="Renaming-swap_bij"><span class="command">lemma</span></span> swap_bij<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"bij <span class="main">(</span>id<span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">x'</span><span class="main">,</span> <span class="free">x'</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"bij <span class="var">?f</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bijI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"surj <span class="var">?f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">⊆</span> range <span class="main">(</span>id<span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">x'</span><span class="main">,</span> <span class="free">x'</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> range <span class="main">(</span>id<span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">x'</span><span class="main">,</span> <span class="free">x'</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">x'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renaming-id_trivial_update"><span class="command">lemma</span></span> id_trivial_update <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"id<span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* for solving trivial peaks *)</span>

<span class="keyword1" id="Renaming-eliminate_renaming_val_expr"><span class="command">lemma</span></span> eliminate_renaming_val_expr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> val"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="main">(</span><span class="free">β</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> <span class="free">l'</span><span class="main">)</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">v</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="main">(</span><span class="free">β</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> <span class="free">l'</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">e</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span><span class="free">α</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">r'</span><span class="main">)</span><span class="main">)</span> <span class="free">β</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">v</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="main">(</span><span class="free">α</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">r'</span><span class="main">)</span><span class="main">)</span> <span class="free">β</span> <span class="free">e</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">β</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span> <span class="main">⟶</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span><span class="bound">α</span><span class="main">(</span><span class="bound">r</span> <span class="main">:=</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="bound">β</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">α</span> <span class="bound">β</span> <span class="free">v</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">β</span> <span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟶</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="main">(</span><span class="bound">α</span><span class="main">(</span><span class="bound">r</span> <span class="main">:=</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="bound">β</span> <span class="free">e</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">α</span> <span class="bound">β</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val_expr.induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span><span class="free">α</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">r'</span><span class="main">)</span><span class="main">)</span> <span class="free">β</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">v</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="main">(</span><span class="free">α</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">r'</span><span class="main">)</span><span class="main">)</span> <span class="free">β</span> <span class="free">e</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">β</span> <span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span> <span class="main">⟶</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">α</span> <span class="main">(</span><span class="bound">β</span><span class="main">(</span><span class="bound">l</span> <span class="main">:=</span> <span class="bound">l'</span><span class="main">)</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">α</span> <span class="bound">β</span> <span class="free">v</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">β</span> <span class="bound">l</span> <span class="bound">l'</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟶</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">α</span> <span class="main">(</span><span class="bound">β</span><span class="main">(</span><span class="bound">l</span> <span class="main">:=</span> <span class="bound">l'</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">α</span> <span class="bound">β</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val_expr.induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="main">(</span><span class="free">β</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> <span class="free">l'</span><span class="main">)</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="main">(</span><span class="free">β</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> <span class="free">l'</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Renaming-eliminate_renaming_cntxt"><span class="command">lemma</span></span> eliminate_renaming_cntxt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>C</sub> <span class="free">ℰ</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span><span class="free">α</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">r'</span><span class="main">)</span><span class="main">)</span> <span class="free">β</span> <span class="free">ℰ</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">ℰ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>C</sub> <span class="free">ℰ</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">α</span> <span class="main">(</span><span class="free">β</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> <span class="free">l'</span><span class="main">)</span><span class="main">)</span> <span class="free">ℰ</span> <span class="main">=</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">ℰ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ℰ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cntxt.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Renaming-eliminate_swap_val"><span class="command">lemma</span></span> eliminate_swap_val <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span> <span class="main">⟹</span> <span class="free">r'</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span>id<span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">r'</span><span class="main">,</span> <span class="free">r'</span> <span class="main">:=</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> id <span class="main">(</span>id<span class="main">(</span><span class="free">l</span> <span class="main">:=</span> <span class="free">l'</span><span class="main">,</span> <span class="free">l'</span> <span class="main">:=</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Renaming-eliminate_swap_expr"><span class="command">lemma</span></span> eliminate_swap_expr <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟹</span> <span class="free">r'</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="main">(</span>id<span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">r'</span><span class="main">,</span> <span class="free">r'</span> <span class="main">:=</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">e</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> id <span class="main">(</span>id<span class="main">(</span><span class="free">l</span> <span class="main">:=</span> <span class="free">l'</span><span class="main">,</span> <span class="free">l'</span> <span class="main">:=</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Renaming-eliminate_swap_cntxt"><span class="command">lemma</span></span> eliminate_swap_cntxt <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>C</sub> <span class="free">ℰ</span> <span class="main">⟹</span> <span class="free">r'</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>C</sub> <span class="free">ℰ</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span>id<span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">r'</span><span class="main">,</span> <span class="free">r'</span> <span class="main">:=</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">ℰ</span> <span class="main">=</span> <span class="free">ℰ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>C</sub> <span class="free">ℰ</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>C</sub> <span class="free">ℰ</span> <span class="main">⟹</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> id <span class="main">(</span>id<span class="main">(</span><span class="free">l</span> <span class="main">:=</span> <span class="free">l'</span><span class="main">,</span> <span class="free">l'</span> <span class="main">:=</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">ℰ</span> <span class="main">=</span> <span class="free">ℰ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Renaming-eliminate_swap_store_rid"><span class="command">lemma</span></span> eliminate_swap_store_rid <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">r'</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">⟹</span> ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>id<span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">r'</span><span class="main">,</span> <span class="free">r'</span> <span class="main">:=</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>S</sub>I<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap_bij RID<span class="hidden">⇩</span><sub>S</sub>_def domIff ranI<span class="main">)</span>

<span class="keyword1" id="Renaming-eliminate_swap_store_lid"><span class="command">lemma</span></span> eliminate_swap_store_lid <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span> <span class="main">⟹</span> ℛ<span class="hidden">⇩</span><sub>S</sub> id <span class="main">(</span>id<span class="main">(</span><span class="free">l</span> <span class="main">:=</span> <span class="free">l'</span><span class="main">,</span> <span class="free">l'</span> <span class="main">:=</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>S</sub>I<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap_bij LID<span class="hidden">⇩</span><sub>S</sub>_def domIff ranI<span class="main">)</span>

<span class="keyword1" id="Renaming-eliminate_swap_global_rid"><span class="command">lemma</span></span> eliminate_swap_global_rid <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span> <span class="main">⟹</span> <span class="free">r'</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span> <span class="main">⟹</span> ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>id<span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">r'</span><span class="main">,</span> <span class="free">r'</span> <span class="main">:=</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> id <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>G</sub>I<span class="main"><span class="main">[</span></span><span class="operator">OF</span> swap_bij<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Renaming-eliminate_swap_global_lid"><span class="command">lemma</span></span> eliminate_swap_global_lid <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span> <span class="main">⟹</span> ℛ<span class="hidden">⇩</span><sub>G</sub> id <span class="main">(</span>id<span class="main">(</span><span class="free">l</span> <span class="main">:=</span> <span class="free">l'</span><span class="main">,</span> <span class="free">l'</span> <span class="main">:=</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>G</sub>I<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ID_distr_global_conditional<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Substitution">
<div class="head">
<h1>Theory Substitution</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="plain_text">Substitution</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory introduces the substitution operation using a locale, and provides two models.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Substitution
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Renaming.html">Renaming</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="plain_text">Definition</span>

<span class="keyword1"><span class="command">locale</span></span> substitution <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    renaming_distr_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="main">(</span><span class="free">subst</span> <span class="free">e</span> <span class="free">x</span> <span class="free">e'</span><span class="main">)</span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">e</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">e'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="comment1">(* needed in mimicking *)</span>
    subst_introduces_no_rids<span class="main">:</span> <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="free">subst</span> <span class="free">e</span> <span class="free">x</span> <span class="free">e'</span><span class="main">)</span> <span class="main">⊆</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    subst_introduces_no_lids<span class="main">:</span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="free">subst</span> <span class="free">e</span> <span class="free">x</span> <span class="free">e'</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Substitution-rid_substE"><span class="command">lemma</span></span> rid_substE <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="free">subst</span> <span class="main">(</span>VE <span class="free">v</span><span class="main">)</span> <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subst_introduces_no_rids <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Substitution-lid_substE"><span class="command">lemma</span></span> lid_substE <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="free">subst</span> <span class="main">(</span>VE <span class="free">v</span><span class="main">)</span> <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subst_introduces_no_lids <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* substitution locale *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Trivial model›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">constant_function</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">constant_function</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">=</span> VE <span class="main">(</span>CV Unit<span class="main">)</span>"</span></span>

<span class="keyword1" id="Substitution-constant_function_models_substitution"><span class="command">lemma</span></span> constant_function_models_substitution<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"substitution constant_function"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substitution_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Example model›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="plain_text">Preliminaries</span>

<span class="keyword1"><span class="command">notation</span></span> set3_val <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒱<span class="hidden">⇩</span><sub>V</sub></span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> set3_expr <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒱<span class="hidden">⇩</span><sub>E</sub></span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rename_vars_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> val <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> val"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>V</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℛ𝒱<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="main">≡</span> map_val id id <span class="free"><span class="bound"><span class="entity">ζ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rename_vars_expr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span></span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="main">≡</span> map_expr id id <span class="free"><span class="bound"><span class="entity">ζ</span></span></span>"</span></span>

<span class="keyword1" id="Substitution-var_renaming_preserves_size"><span class="command">lemma</span></span> var_renaming_preserves_size<span class="main">:</span> <span class="comment1">(* for termination proof *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> val"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'r'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">β</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'l'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ζ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"size <span class="main">(</span>map_val <span class="free">α</span> <span class="free">β</span> <span class="free">ζ</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> size <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"size <span class="main">(</span>map_expr <span class="free">α</span> <span class="free">β</span> <span class="free">ζ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> size <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">α</span> <span class="main">::</span> <span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'r'</span><span class="main">)</span> <span class="main">(</span><span class="bound">β</span> <span class="main">::</span> <span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'l'</span><span class="main">)</span> <span class="main">(</span><span class="bound">ζ</span> <span class="main">::</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v'</span><span class="main">)</span><span class="main">.</span> size <span class="main">(</span>map_val <span class="bound">α</span> <span class="bound">β</span> <span class="bound">ζ</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> size <span class="free">v</span><span class="main">)</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">α</span> <span class="main">::</span> <span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'r'</span><span class="main">)</span> <span class="main">(</span><span class="bound">β</span> <span class="main">::</span> <span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'l'</span><span class="main">)</span> <span class="main">(</span><span class="bound">ζ</span> <span class="main">::</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v'</span><span class="main">)</span><span class="main">.</span> size <span class="main">(</span>map_expr <span class="bound">α</span> <span class="bound">β</span> <span class="bound">ζ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> size <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val_expr.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> 
    <span class="quoted"><span class="quoted">"size <span class="main">(</span>map_val <span class="free">α</span> <span class="free">β</span> <span class="free">ζ</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> size <span class="free">v</span>"</span></span> 
    <span class="quoted"><span class="quoted">"size <span class="main">(</span>map_expr <span class="free">α</span> <span class="free">β</span> <span class="free">ζ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> size <span class="free">e</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="plain_text">Definition</span>

<span class="keyword1"><span class="command">function</span></span>
  <span class="entity">nat_subst<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span>nat<span class="main">)</span> expr <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span>nat<span class="main">)</span> val <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span>nat<span class="main">)</span> expr"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span>nat<span class="main">)</span> expr <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span>nat<span class="main">)</span> expr <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span>nat<span class="main">)</span> expr"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nat_subst<span class="hidden">⇩</span><sub>V</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>CV <span class="free"><span class="bound"><span class="entity">const</span></span></span><span class="main">)</span> <span class="main">=</span> VE <span class="main">(</span>CV <span class="free"><span class="bound"><span class="entity">const</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nat_subst<span class="hidden">⇩</span><sub>V</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">else</span> VE <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nat_subst<span class="hidden">⇩</span><sub>V</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> VE <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nat_subst<span class="hidden">⇩</span><sub>V</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Rid <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> VE <span class="main">(</span>Rid <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nat_subst<span class="hidden">⇩</span><sub>V</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Lambda <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span> <span class="main">=</span> VE <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> 
    Lambda <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> 
  <span class="keyword1">else</span> 
    <span class="keyword1">let</span> <span class="bound">z</span> <span class="main">=</span> Suc <span class="main">(</span>Max <span class="main">(</span><span class="keyword1">𝒱<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">∪</span> <span class="keyword1">𝒱<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
    Lambda <span class="bound">z</span> <span class="main">(</span><span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span> <span class="main">(</span>id<span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">:=</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nat_subst<span class="hidden">⇩</span><sub>V</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Apply <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Apply <span class="main">(</span><span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Ite <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="main">=</span> Ite <span class="main">(</span><span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Ref <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span> <span class="main">=</span> Ref <span class="main">(</span><span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Read <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span> <span class="main">=</span> Read <span class="main">(</span><span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Assign <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Assign <span class="main">(</span><span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Rfork <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span> <span class="main">=</span> Rfork <span class="main">(</span><span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Rjoin <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span>  <span class="main">=</span> Rjoin <span class="main">(</span><span class="free">nat_subst<span class="hidden">⇩</span><sub>E</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="main">(</span><span class="bound">e</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> size <span class="bound">v</span> <span class="main">|</span> Inr <span class="main">(</span><span class="bound">e</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">e'</span><span class="main">)</span> <span class="main">⇒</span> size <span class="bound">e'</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> var_renaming_preserves_size<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proof obligations›</span></span>

<span class="keyword1" id="Substitution-nat_subst"><span class="command">lemma</span></span> nat_subst<span class="hidden">⇩</span><sub>E</sub>_distr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span>nat<span class="main">)</span> expr"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="main">(</span>nat_subst<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="free">x</span> <span class="free">e'</span><span class="main">)</span> <span class="main">=</span> nat_subst<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">e</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">e'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span>nat<span class="main">)</span> val"</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">β</span> <span class="bound">x</span> <span class="bound">e</span> <span class="bound">ζ</span><span class="main">.</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">α</span> <span class="bound">β</span> <span class="main">(</span>nat_subst<span class="hidden">⇩</span><sub>V</sub> <span class="bound">e</span> <span class="bound">x</span> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">ζ</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> nat_subst<span class="hidden">⇩</span><sub>V</sub> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">α</span> <span class="bound">β</span> <span class="bound">e</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">α</span> <span class="bound">β</span> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">ζ</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">α</span> <span class="bound">β</span> <span class="bound">x</span> <span class="bound">e</span> <span class="bound">ζ</span><span class="main">.</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">α</span> <span class="bound">β</span> <span class="main">(</span>nat_subst<span class="hidden">⇩</span><sub>E</sub> <span class="bound">e</span> <span class="bound">x</span> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">ζ</span> <span class="free">e'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> nat_subst<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">α</span> <span class="bound">β</span> <span class="bound">e</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">α</span> <span class="bound">β</span> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">ζ</span> <span class="free">e'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val_expr.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expr.set_map<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> fun.map_ident<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="main">(</span>nat_subst<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="free">x</span> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span> id <span class="free">e'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> nat_subst<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">e</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span> id <span class="free">e'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Substitution-nat_subst"><span class="command">lemma</span></span> nat_subst<span class="hidden">⇩</span><sub>E</sub>_introduces_no_rids<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span>nat<span class="main">)</span> expr"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span>nat_subst<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="free">x</span> <span class="free">e'</span><span class="main">)</span> <span class="main">⊆</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span>nat<span class="main">)</span> val"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">e</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ζ</span><span class="main">.</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span>nat_subst<span class="hidden">⇩</span><sub>V</sub> <span class="bound">e</span> <span class="bound">x</span> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">ζ</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="bound">e</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">ζ</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">e</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ζ</span><span class="main">.</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span>nat_subst<span class="hidden">⇩</span><sub>E</sub> <span class="bound">e</span> <span class="bound">x</span> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">ζ</span> <span class="free">e'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="bound">e</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">ζ</span> <span class="free">e'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val_expr.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expr.set_map<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span>nat_subst<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="free">x</span> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span> id <span class="free">e'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span> id <span class="free">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Substitution-nat_subst"><span class="command">lemma</span></span> nat_subst<span class="hidden">⇩</span><sub>E</sub>_introduces_no_lids<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span>nat<span class="main">)</span> expr"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span>nat_subst<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="free">x</span> <span class="free">e'</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span>nat<span class="main">)</span> val"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">e</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ζ</span><span class="main">.</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span>nat_subst<span class="hidden">⇩</span><sub>V</sub> <span class="bound">e</span> <span class="bound">x</span> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">ζ</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="bound">e</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">ζ</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">e</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ζ</span><span class="main">.</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span>nat_subst<span class="hidden">⇩</span><sub>E</sub> <span class="bound">e</span> <span class="bound">x</span> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">ζ</span> <span class="free">e'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="bound">e</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">ζ</span> <span class="free">e'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val_expr.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expr.set_map<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span>nat_subst<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="free">x</span> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span> id <span class="free">e'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="keyword1">ℛ𝒱<span class="hidden">⇩</span><sub>E</sub></span> id <span class="free">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Substitution-nat_subst"><span class="command">lemma</span></span> nat_subst<span class="hidden">⇩</span><sub>E</sub>_models_substitution<span class="main">:</span> <span class="quoted"><span class="quoted">"substitution nat_subst<span class="hidden">⇩</span><sub>E</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_subst<span class="hidden">⇩</span><sub>E</sub>_distr nat_subst<span class="hidden">⇩</span><sub>E</sub>_introduces_no_lids nat_subst<span class="hidden">⇩</span><sub>E</sub>_introduces_no_rids substitution_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="OperationalSemantics">
<div class="head">
<h1>Theory OperationalSemantics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Operational Semantics›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory defines the operational semantics of the concurrent revisions model. It also
  introduces a relaxed formulation of the operational semantics, and proves the main result required
  for establishing their equivalence.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> OperationalSemantics
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Substitution.html">Substitution</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> substitution
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="plain_text">Definition</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">revision_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'r</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Apply <span class="main">(</span>VE <span class="main">(</span>Lambda <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">revision_step</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span><span class="free">subst</span> <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> ifTrue<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Ite <span class="main">(</span>VE <span class="main">(</span>CV T<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">revision_step</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> ifFalse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Ite <span class="main">(</span>VE <span class="main">(</span>CV F<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">revision_step</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* store operations *)</span>
<span class="main">|</span> new<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Ref <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">revision_step</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>VE <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> get<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Read <span class="main">(</span>VE <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∈</span> dom <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">revision_step</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>VE <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Assign <span class="main">(</span>VE <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∈</span> dom <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">revision_step</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>VE <span class="main">(</span>CV Unit<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* synchronization operations *)</span>
<span class="main">|</span> fork<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Rfork <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">revision_step</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>VE <span class="main">(</span>Rid <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> ε<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> join<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Rjoin <span class="main">(</span>VE <span class="main">(</span>Rid <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ'</span></span></span><span class="main">,</span> VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">revision_step</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">τ'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>VE <span class="main">(</span>CV Unit<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> join<span class="hidden">⇩</span><sub>ε</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Rjoin <span class="main">(</span>VE <span class="main">(</span>Rid <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">revision_step</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> ε"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> revision_stepE <span class="main">[</span><span class="operator">elim</span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> app ifTrue ifFalse new get set fork join join<span class="hidden">⇩</span><sub>ε</sub><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Introduction lemmas for identifiers›</span></span>

<span class="keyword1" id="OperationalSemantics-only_new_introduces_lids"><span class="command">lemma</span></span> only_new_introduces_lids <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    not_new<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span> <span class="bound">ℰ</span> <span class="bound">v</span><span class="main">.</span> <span class="free">s</span> <span class="free">r</span> <span class="main">≠</span> Some <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">τ</span><span class="main">,</span><span class="bound">ℰ</span><span class="main">[</span>Ref <span class="main">(</span>VE <span class="bound">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s'</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> step <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> fork
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_twist ID_distr_global_conditional<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>join _ _ _ <span class="skolem">r'</span> _ _ _<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> join <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_twist <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_combination_in_component<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_new fun_upd_twist ID_distr_global_conditional <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> LID<span class="hidden">⇩</span><sub>S</sub>I<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="OperationalSemantics-only_fork_introduces_rids"><span class="command">lemma</span></span> only_fork_introduces_rids <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    not_fork<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span> <span class="bound">ℰ</span> <span class="bound">e</span><span class="main">.</span> <span class="free">s</span> <span class="free">r</span> <span class="main">≠</span> Some <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">τ</span><span class="main">,</span><span class="bound">ℰ</span><span class="main">[</span>Rfork <span class="bound">e</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s'</span> <span class="main">⊆</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> step <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> get
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ID_distr_global_conditional<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> fork
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_fork<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>join _ _ _<span class="skolem">r'</span> _ _ _<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> join <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_twist <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_combination_in_component<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ID_distr_global_conditional<span class="main">)</span>

<span class="keyword1" id="OperationalSemantics-only_fork_introduces_rids'"><span class="command">lemma</span></span> only_fork_introduces_rids' <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    not_fork<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span> <span class="bound">ℰ</span> <span class="bound">e</span><span class="main">.</span> <span class="free">s</span> <span class="free">r</span> <span class="main">≠</span> Some <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">τ</span><span class="main">,</span><span class="bound">ℰ</span><span class="main">[</span>Rfork <span class="bound">e</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span> <span class="main">⟹</span> <span class="free">r'</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="OperationalSemantics-only_new_introduces_lids'"><span class="command">lemma</span></span> only_new_introduces_lids' <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    not_new<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span> <span class="bound">ℰ</span> <span class="bound">v</span><span class="main">.</span> <span class="free">s</span> <span class="free">r</span> <span class="main">≠</span> Some <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">τ</span><span class="main">,</span><span class="bound">ℰ</span><span class="main">[</span>Ref <span class="main">(</span>VE <span class="bound">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Domain subsumption›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="plain_text">Definitions</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">domains_subsume</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> local_state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒮</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒮</span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> <span class="main">(</span>LID<span class="hidden">⇩</span><sub>L</sub> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">⊆</span> doms <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">domains_subsume_globally</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒮<span class="hidden">⇩</span><sub>G</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="bound">ls</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">r</span> <span class="main">=</span> Some <span class="bound">ls</span> <span class="main">⟶</span> <span class="keyword1">𝒮</span> <span class="bound">ls</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="OperationalSemantics-domains_subsume_globallyI"><span class="command">lemma</span></span> domains_subsume_globallyI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">r</span> <span class="bound">σ</span> <span class="bound">τ</span> <span class="bound">e</span><span class="main">.</span> <span class="free">s</span> <span class="bound">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">τ</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">𝒮</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">τ</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> domains_subsume_globally <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> domains_subsume_globally_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subsumes_accessible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'r</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒜</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒜</span></span> <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="OperationalSemantics-subsumes_accessibleI"><span class="command">lemma</span></span> subsumes_accessibleI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">𝒜</span> <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subsumes_accessible_globally</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒜<span class="hidden">⇩</span><sub>G</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒜<span class="hidden">⇩</span><sub>G</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟶</span> <span class="bound">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟶</span> <span class="keyword1">𝒜</span> <span class="bound">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="OperationalSemantics-subsumes_accessible_globallyI"><span class="command">lemma</span></span> subsumes_accessible_globallyI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">σ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">σ<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">s</span> <span class="bound">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">σ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="bound">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="bound">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">s</span> <span class="bound">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">σ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="bound">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="bound">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">𝒜</span> <span class="bound">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">𝒜<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subsumes_accessible_globally_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The theorem›</span></span>

<span class="keyword1" id="OperationalSemantics-𝒮"><span class="command">lemma</span></span> 𝒮<span class="hidden">⇩</span><sub>G</sub>_imp_𝒜_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    𝒮<span class="hidden">⇩</span><sub>G</sub>_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    r_in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> dom <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="free">r</span> <span class="free">r</span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domains_subsume_def domains_subsume_globally_def subsumes_accessibleI<span class="main">)</span>

<span class="keyword1" id="OperationalSemantics-step_preserves_𝒮"><span class="command">lemma</span></span> step_preserves_𝒮<span class="hidden">⇩</span><sub>G</sub>_and_𝒜<span class="hidden">⇩</span><sub>G</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    𝒮<span class="hidden">⇩</span><sub>G</sub>_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    𝒜<span class="hidden">⇩</span><sub>G</sub>_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> domains_subsume_globallyI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span> <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">e</span>
    <span class="keyword3"><span class="command">assume</span></span> s'_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="skolem">r'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span><span class="skolem">τ</span><span class="main">,</span><span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span><span class="skolem">τ</span><span class="main">,</span><span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="skolem">r'</span> <span class="main">=</span> <span class="free">s</span> <span class="skolem">r'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 𝒮<span class="hidden">⇩</span><sub>G</sub>_s domains_subsume_globally_def s'_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> r'_was_updated<span class="main">:</span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> step <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">σ'</span> <span class="skolem">τ'</span> <span class="skolem">ℰ'</span> _ <span class="skolem">e'</span> <span class="skolem">v'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_apply app<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r'_was_updated<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">σ'</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">τ'</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>C</sub> <span class="skolem">ℰ'</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="skolem">e'</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> app<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> app<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒮<span class="hidden">⇩</span><sub>G</sub>_s domains_subsume_def domains_subsume_globally_def local.app<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domains_subsume_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>›</span></span> s'_r<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> ifTrue
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_apply ifTrue<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r'_was_updated<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ifTrue <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒮<span class="hidden">⇩</span><sub>G</sub>_s domains_subsume_def domains_subsume_globally_def ifTrue<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifTrue<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domains_subsume_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>›</span></span> s'_r<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> ifFalse
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_apply ifFalse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r'_was_updated<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ifFalse <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒮<span class="hidden">⇩</span><sub>G</sub>_s domains_subsume_def domains_subsume_globally_def ifFalse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifFalse<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domains_subsume_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>›</span></span> s'_r<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>new <span class="skolem">σ'</span> <span class="skolem">τ'</span> <span class="skolem">ℰ'</span> <span class="skolem">v'</span> <span class="skolem">l'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_apply new<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r'_was_updated<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">l'</span> <span class="main">(</span>LID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">σ'</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">τ'</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="skolem">v'</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>C</sub> <span class="skolem">ℰ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> new<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> insert <span class="skolem">l'</span> <span class="main">(</span>LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> insert <span class="skolem">l'</span> <span class="main">(</span>doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒮<span class="hidden">⇩</span><sub>G</sub>_s domains_subsume_def domains_subsume_globally_def insert_mono new<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domains_subsume_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>›</span></span> s'_r<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> get
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_apply get<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r'_was_updated<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> get <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒮<span class="hidden">⇩</span><sub>G</sub>_s domains_subsume_def domains_subsume_globally_def get<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domains_subsume_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>›</span></span> s'_r<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> set
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_apply set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r'_was_updated<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒮<span class="hidden">⇩</span><sub>G</sub>_s domains_subsume_def domains_subsume_globally_def set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domains_subsume_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>›</span></span> s'_r<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fork <span class="skolem">σ'</span> <span class="skolem">τ'</span> _ _ <span class="skolem">r''</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span> <span class="main">∨</span> <span class="skolem">r''</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork r'_was_updated <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒮<span class="hidden">⇩</span><sub>G</sub>_s domains_subsume_def domains_subsume_globally_def fork<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domains_subsume_def<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">=</span> <span class="skolem">r'</span>›</span></span> s'_r<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r''</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒮<span class="hidden">⇩</span><sub>G</sub>_s domains_subsume_def domains_subsume_globally_def fork<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dom <span class="skolem">σ'</span> <span class="main">∪</span> dom <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">σ'</span><span class="main">;;</span><span class="skolem">τ'</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_combination_dom_union<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r''</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r''</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domains_subsume_def<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r''</span> <span class="main">=</span> <span class="skolem">r'</span>›</span></span> s'_r<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>join <span class="skolem">σ'</span> <span class="skolem">τ'</span> _ <span class="skolem">r''</span> <span class="skolem">σ''</span> <span class="skolem">τ''</span> _<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_def join<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> r'_was_updated s'_r<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">τ''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> join <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">τ''</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_mono 𝒮<span class="hidden">⇩</span><sub>G</sub>_s domains_subsume_def domains_subsume_globally_def join<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.sel subset_refl<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r''</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> join<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r''</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Un_absorb 𝒮<span class="hidden">⇩</span><sub>G</sub>_s domains_subsume_def domains_subsume_globally_def join<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> option.sel sup.orderI sup_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dom <span class="skolem">σ'</span> <span class="main">∪</span> dom <span class="skolem">τ'</span> <span class="main">∪</span> dom <span class="skolem">σ''</span> <span class="main">∪</span> dom <span class="skolem">τ''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> join <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> dom <span class="skolem">σ'</span> <span class="main">∪</span> dom <span class="skolem">τ'</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">σ''</span> <span class="main">∪</span> dom <span class="skolem">τ''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> dom <span class="skolem">σ'</span> <span class="main">∪</span> dom <span class="skolem">τ'</span> <span class="main">∪</span> dom <span class="skolem">σ'</span> <span class="main">∪</span> dom <span class="skolem">τ'</span> <span class="main">∪</span> dom <span class="skolem">τ''</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> r_r''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="free">r</span> <span class="skolem">r''</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s join<span class="main">(</span>2-3<span class="main">)</span> subsumes_accessible_globally_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> r_accesses_r''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> join <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">σ''</span> <span class="main">⊆</span> dom <span class="skolem">σ'</span> <span class="main">∪</span> dom <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> join subsumes_accessible_def r_r'' r_accesses_r'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dom <span class="skolem">σ'</span> <span class="main">∪</span> dom <span class="skolem">τ'</span> <span class="main">∪</span> dom <span class="skolem">τ''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dom <span class="skolem">σ'</span> <span class="main">∪</span> dom <span class="main">(</span><span class="skolem">τ'</span><span class="main">;;</span><span class="skolem">τ''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_combination_dom_union<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> join <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domains_subsume_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="free">r</span>›</span></span> s'_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> join<span class="hidden">⇩</span><sub>ε</sub>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s'_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessible_globallyI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">σ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">σ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword3"><span class="command">assume</span></span> 
      s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      s'_r<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 𝒮<span class="hidden">⇩</span><sub>G</sub>_imp_𝒜_refl <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s'</span>›</span></span> s'_r<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> r<span class="hidden">⇩</span><sub>1</sub>_neq_r<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> False
      <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>1</sub>_nor_r<span class="hidden">⇩</span><sub>2</sub>_updated_implies_thesis<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
        <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>1</sub>_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="hidden">⇩</span><sub>2</sub>_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s domIff option.discI r<span class="hidden">⇩</span><sub>1</sub>_unchanged r<span class="hidden">⇩</span><sub>2</sub>_unchanged s'_r<span class="hidden">⇩</span><sub>1</sub> s'_r<span class="hidden">⇩</span><sub>2</sub> subsumes_accessible_globally_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>1</sub>_unchanged r<span class="hidden">⇩</span><sub>2</sub>_unchanged subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>1</sub>_or_r<span class="hidden">⇩</span><sub>2</sub>_updated_implies_thesis<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∨</span> <span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>1</sub>_or_r<span class="hidden">⇩</span><sub>2</sub>_updated<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∨</span> <span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> step <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> app
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span> <span class="main">∨</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_other app<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_or_r<span class="hidden">⇩</span><sub>2</sub>_updated<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>1</sub>_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> app r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> r<span class="hidden">⇩</span><sub>1</sub>_eq_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s domI fun_upd_other app r<span class="hidden">⇩</span><sub>1</sub>_eq_r s'_r<span class="hidden">⇩</span><sub>2</sub> subsumes_accessible_globally_def<span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> app<span class="main">(</span>1<span class="main">)</span> r<span class="hidden">⇩</span><sub>1</sub>_neq_r<span class="hidden">⇩</span><sub>2</sub> r<span class="hidden">⇩</span><sub>2</sub>_eq_r r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s domIff fun_upd_other app option.discI r<span class="hidden">⇩</span><sub>2</sub>_eq_r s'_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_globally_def<span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app<span class="main">)</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> ifTrue
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span> <span class="main">∨</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_other ifTrue<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_or_r<span class="hidden">⇩</span><sub>2</sub>_updated<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>1</sub>_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ifTrue <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ifTrue r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> r<span class="hidden">⇩</span><sub>1</sub>_eq_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s domI fun_upd_other ifTrue r<span class="hidden">⇩</span><sub>1</sub>_eq_r s'_r<span class="hidden">⇩</span><sub>2</sub> subsumes_accessible_globally_def<span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ifTrue <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ifTrue <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ifTrue<span class="main">(</span>1<span class="main">)</span> r<span class="hidden">⇩</span><sub>1</sub>_neq_r<span class="hidden">⇩</span><sub>2</sub> r<span class="hidden">⇩</span><sub>2</sub>_eq_r r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s domIff fun_upd_other ifTrue option.discI r<span class="hidden">⇩</span><sub>2</sub>_eq_r s'_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_globally_def<span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifTrue<span class="main">)</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> ifFalse
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span> <span class="main">∨</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_other ifFalse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_or_r<span class="hidden">⇩</span><sub>2</sub>_updated<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>1</sub>_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ifFalse <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ifFalse r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> r<span class="hidden">⇩</span><sub>1</sub>_eq_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s domI fun_upd_other ifFalse r<span class="hidden">⇩</span><sub>1</sub>_eq_r s'_r<span class="hidden">⇩</span><sub>2</sub> subsumes_accessible_globally_def<span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ifFalse <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ifFalse <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ifFalse<span class="main">(</span>1<span class="main">)</span> r<span class="hidden">⇩</span><sub>1</sub>_neq_r<span class="hidden">⇩</span><sub>2</sub> r<span class="hidden">⇩</span><sub>2</sub>_eq_r r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s domIff fun_upd_other ifFalse option.discI r<span class="hidden">⇩</span><sub>2</sub>_eq_r s'_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_globally_def<span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ifFalse<span class="main">)</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> new
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span> <span class="main">∨</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_other new<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_or_r<span class="hidden">⇩</span><sub>2</sub>_updated<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>1</sub>_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> r<span class="hidden">⇩</span><sub>1</sub>_eq_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s domI fun_upd_other new<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_eq_r s'_r<span class="hidden">⇩</span><sub>2</sub> subsumes_accessible_globally_def<span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new<span class="main">(</span>1<span class="main">)</span> r<span class="hidden">⇩</span><sub>1</sub>_neq_r<span class="hidden">⇩</span><sub>2</sub> r<span class="hidden">⇩</span><sub>2</sub>_eq_r r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s domIff fun_upd_other new<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> option.discI r<span class="hidden">⇩</span><sub>2</sub>_eq_r s'_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_globally_def<span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new<span class="main">)</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> get
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span> <span class="main">∨</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_other get<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_or_r<span class="hidden">⇩</span><sub>2</sub>_updated<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>1</sub>_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> get <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> get r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> r<span class="hidden">⇩</span><sub>1</sub>_eq_r <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> RID<span class="hidden">⇩</span><sub>S</sub>I<span class="main">)</span> <span class="comment1">(* by (auto 1 3) *)</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s domI fun_upd_other get<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_eq_r s'_r<span class="hidden">⇩</span><sub>2</sub> subsumes_accessible_globally_def<span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> get <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> get <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> get<span class="main">(</span>1<span class="main">)</span> r<span class="hidden">⇩</span><sub>1</sub>_neq_r<span class="hidden">⇩</span><sub>2</sub> r<span class="hidden">⇩</span><sub>2</sub>_eq_r r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s domIff fun_upd_other get<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> option.discI r<span class="hidden">⇩</span><sub>2</sub>_eq_r s'_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_globally_def<span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get<span class="main">)</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> set
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span> <span class="main">∨</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_other set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_or_r<span class="hidden">⇩</span><sub>2</sub>_updated<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>1</sub>_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> r<span class="hidden">⇩</span><sub>1</sub>_eq_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s domI fun_upd_other set<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_eq_r s'_r<span class="hidden">⇩</span><sub>2</sub> subsumes_accessible_globally_def<span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set<span class="main">(</span>1<span class="main">)</span> r<span class="hidden">⇩</span><sub>1</sub>_neq_r<span class="hidden">⇩</span><sub>2</sub> r<span class="hidden">⇩</span><sub>2</sub>_eq_r r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s domIff fun_upd_other set<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> option.discI r<span class="hidden">⇩</span><sub>2</sub>_eq_r s'_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_globally_def<span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set<span class="main">)</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fork <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">ℰ</span> <span class="skolem">e</span> <span class="skolem">r'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> s'_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Rid <span class="skolem">r'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> s'_r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="skolem">r'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">σ</span><span class="main">;;</span><span class="skolem">τ</span><span class="main">,</span> ε<span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.fork<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> case1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span> <span class="main">⟹</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="free">r</span> <span class="main">⟹</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="skolem">r'</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> s'_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>›</span></span> domIff fun_upd_other fork<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> option.discI s'_r<span class="hidden">⇩</span><sub>2</sub> subsumes_accessible_globally_def<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> fork<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> s'_r<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> case2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">r</span> <span class="main">⟹</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="skolem">r'</span> <span class="main">⟹</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">r</span>›</span></span> fork r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> s'_r<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">r</span>›</span></span> fork<span class="main">(</span>1<span class="main">)</span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> domIff fun_upd_other fork<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> option.discI s'_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_globally_def<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">r</span>›</span></span> fork<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> case3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">r'</span> <span class="main">⟹</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="free">r</span> <span class="main">⟹</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="skolem">r'</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RID<span class="hidden">⇩</span><sub>L</sub>I<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">r'</span>›</span></span> fork<span class="main">(</span>2<span class="main">)</span> s'_r' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="free">r</span>›</span></span> fork<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="free">r</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s fork<span class="main">(</span>2<span class="main">)</span> s'_r<span class="hidden">⇩</span><sub>2</sub> subsumes_accessible_globally_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> subsumes_accessible_def<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dom <span class="skolem">σ</span> <span class="main">∪</span> dom <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fork<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">σ</span><span class="main">;;</span><span class="skolem">τ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_combination_dom_union<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s'_r'<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">r'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> case4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">r</span> <span class="main">⟹</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="skolem">r'</span> <span class="main">⟹</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">r'</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">r'</span>›</span></span> fork<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> s'_r<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="skolem">r'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">r</span>›</span></span> fork<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> case5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span> <span class="main">⟹</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">r'</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="skolem">σ</span><span class="main">;;</span><span class="skolem">τ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">r'</span>›</span></span> s'_r'<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">σ</span> <span class="main">∪</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> s'_r<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> domains_subsume_def domains_subsume_globally_def option.sel s'_r<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> case6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">r'</span> <span class="main">⟹</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s'_r<span class="hidden">⇩</span><sub>2</sub> subsetI<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s'</span>›</span></span> domains_subsume_def domains_subsume_globally_def s'_r<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dom <span class="skolem">σ</span> <span class="main">∪</span> dom <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> s'_r<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">σ</span><span class="main">;;</span><span class="skolem">τ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_combination_dom_union<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">r'</span>›</span></span> s'_r' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> case1 case2 case3 case4 case5 case6 fork<span class="main">(</span>1<span class="main">)</span> r<span class="hidden">⇩</span><sub>1</sub>_neq_r<span class="hidden">⇩</span><sub>2</sub> r<span class="hidden">⇩</span><sub>1</sub>_nor_r<span class="hidden">⇩</span><sub>2</sub>_updated_implies_thesis <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>join <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">ℰ</span> <span class="skolem">r'</span> <span class="skolem">σ'</span> <span class="skolem">τ'</span> <span class="skolem">v</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span> <span class="main">∨</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_def join<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_or_r<span class="hidden">⇩</span><sub>2</sub>_updated s'_r<span class="hidden">⇩</span><sub>1</sub> s'_r<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">τ'</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_τ'<span class="main">:</span> True
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> fun_upd_def join<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_neq_r<span class="hidden">⇩</span><sub>2</sub> s'_r<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                  <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_τ'<span class="main">)</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> domI fun_upd_def join<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> join<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_neq_r<span class="hidden">⇩</span><sub>2</sub> s'_r<span class="hidden">⇩</span><sub>2</sub> subsumes_accessible_globally_def<span class="main">)</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r' subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dom <span class="skolem">σ'</span> <span class="main">∪</span> dom <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">σ'</span> <span class="main">∪</span> dom <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> dom <span class="skolem">σ</span> <span class="main">∪</span> dom <span class="skolem">τ</span> <span class="main">∪</span> dom <span class="skolem">τ'</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="free">r</span> <span class="skolem">r'</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s join<span class="main">(</span>2-3<span class="main">)</span> subsumes_accessible_globally_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="free">r</span> <span class="skolem">r'</span> <span class="free">s</span>›</span></span> join<span class="main">(</span>2-3<span class="main">)</span> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dom <span class="skolem">σ</span> <span class="main">∪</span> dom <span class="main">(</span><span class="skolem">τ</span><span class="main">;;</span><span class="skolem">τ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_combination_dom_union<span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> join <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> r<span class="hidden">⇩</span><sub>2</sub>_nin_τ'<span class="main">:</span> False
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> fun_upd_def join<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_neq_r<span class="hidden">⇩</span><sub>2</sub> s'_r<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                  <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">σ</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="skolem">τ</span><span class="main">;;</span><span class="skolem">τ'</span><span class="main">)</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>C</sub> <span class="skolem">ℰ</span>"</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ID_distr_completion<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ID_distr_local<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> expr.simps<span class="main"><span class="main">(</span></span>153<span class="main"><span class="main">)</span></span> fun_upd_apply local.join<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.discI option.sel s'_r<span class="hidden">⇩</span><sub>1</sub> sup_bot.right_neutral val.simps<span class="main"><span class="main">(</span></span>66<span class="main"><span class="main">)</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">σ</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">τ</span> <span class="main">∪</span> RID<span class="hidden">⇩</span><sub>C</sub> <span class="skolem">ℰ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> r<span class="hidden">⇩</span><sub>2</sub>_nin_τ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">qed</span></span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> join<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> domIff fun_upd_def option.discI s'_r<span class="hidden">⇩</span><sub>2</sub> subsumes_accessible_globally_def<span class="main">)</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dom <span class="skolem">σ</span> <span class="main">∪</span> dom <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> join<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> dom <span class="skolem">σ</span> <span class="main">∪</span> dom <span class="main">(</span><span class="skolem">τ</span><span class="main">;;</span><span class="skolem">τ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_combination_dom_union<span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> join <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessibleI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> LID_snapshot.simps fun_upd_apply join<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> option.discI option.sel s'_r<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> fun_upd_apply local.join<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.discI r<span class="hidden">⇩</span><sub>1</sub>_neq_r<span class="hidden">⇩</span><sub>2</sub> r<span class="hidden">⇩</span><sub>2</sub>_in_s'_r<span class="hidden">⇩</span><sub>1</sub> s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> 𝒜<span class="hidden">⇩</span><sub>G</sub>_s <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> domIff fun_upd_apply join<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> option.discI s'_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_globally_def<span class="main">)</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s</span>›</span></span> r<span class="hidden">⇩</span><sub>2</sub>_in_s_r<span class="hidden">⇩</span><sub>1</sub> subsumes_accessible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">r</span>›</span></span> eq_refl fun_upd_def local.join<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r<span class="hidden">⇩</span><sub>1</sub>_neq_r<span class="hidden">⇩</span><sub>2</sub> s'_r<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇩</span><sub>σ</sub></span><span class="main">)</span> <span class="main">⊆</span> doms <span class="main">(</span>the <span class="main">(</span><span class="free">s'</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> join<span class="hidden">⇩</span><sub>ε</sub>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s'_r<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r<span class="hidden">⇩</span><sub>1</sub>_nor_r<span class="hidden">⇩</span><sub>2</sub>_updated_implies_thesis r<span class="hidden">⇩</span><sub>1</sub>_or_r<span class="hidden">⇩</span><sub>2</sub>_updated_implies_thesis <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relaxed definition of the operational semantics›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">revision_step_relaxed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'r</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Apply <span class="main">(</span>VE <span class="main">(</span>Lambda <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">revision_step_relaxed</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span><span class="free">subst</span> <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> ifTrue<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Ite <span class="main">(</span>VE <span class="main">(</span>CV T<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">revision_step_relaxed</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> ifFalse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Ite <span class="main">(</span>VE <span class="main">(</span>CV F<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">revision_step_relaxed</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* store operations *)</span>
<span class="main">|</span> new<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Ref <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∉</span> <span class="main">⋃</span> <span class="main">{</span> doms <span class="bound">ls</span> <span class="main">|</span> <span class="bound">ls</span><span class="main">.</span> <span class="bound">ls</span> <span class="main">∈</span> ran <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">}</span> <span class="main">⟹</span> <span class="free">revision_step_relaxed</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>VE <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> get<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Read <span class="main">(</span>VE <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">revision_step_relaxed</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>VE <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Assign <span class="main">(</span>VE <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">revision_step_relaxed</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>VE <span class="main">(</span>CV Unit<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* synchronization operations *)</span>
<span class="main">|</span> fork<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Rfork <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">revision_step_relaxed</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>VE <span class="main">(</span>Rid <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">↦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> ε<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> join<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Rjoin <span class="main">(</span>VE <span class="main">(</span>Rid <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ'</span></span></span><span class="main">,</span> VE <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">revision_step_relaxed</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">τ'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>VE <span class="main">(</span>CV Unit<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> join<span class="hidden">⇩</span><sub>ε</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ℰ</span></span></span><span class="main">[</span>Rjoin <span class="main">(</span>VE <span class="main">(</span>Rid <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">revision_step_relaxed</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> ε"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> revision_step_relaxedE <span class="main">[</span><span class="operator">elim</span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> app ifTrue ifFalse new get set fork join join<span class="hidden">⇩</span><sub>ε</sub><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"revision_step_relaxed <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* substitution locale *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory *)</span>
</pre>
</div><div id="Executions">
<div class="head">
<h1>Theory Executions</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="plain_text">Executions</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section contains all definitions required for reasoning about executions in the concurrent
  revisions model. It also contains a number of proofs for inductive variants. One of these
  proves the equivalence of the two definitions of the operational semantics. The others are
  required for proving determinacy.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Executions
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="OperationalSemantics.html">OperationalSemantics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> substitution
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generalizing the original transition›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="plain_text">Definition</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">steps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state rel"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">[↝]</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">steps</span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> revision_step <span class="bound">r</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">valid_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↝</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">↝</span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span>"</span></span>

<span class="keyword1" id="Executions-valid_stepI"><span class="command">lemma</span></span> valid_stepI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">↝</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> steps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Executions-valid_stepE"><span class="command">lemma</span></span> valid_stepE <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">↝</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> revision_step <span class="bound">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> steps_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="plain_text">Closures</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">refl_trans_step_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span><span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↝<span class="hidden">⇧</span><sup>*</sup></span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">↝<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">refl_step_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↝<span class="hidden">⇧</span><sup>=</sup></span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">↝<span class="hidden">⇧</span><sup>=</sup></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main"><span class="hidden">⇧</span><sup>=</sup></span>"</span></span>

<span class="keyword1" id="Executions-refl_rewritesI"><span class="command">lemma</span></span> refl_rewritesI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">↝</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">↝<span class="hidden">⇧</span><sup>=</sup></span> <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="plain_text">Properties</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">program_expr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">program_expr</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">initializes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initializes</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>ε<span class="main">(</span><span class="bound">r</span> <span class="main">↦</span><span class="main">(</span>ε<span class="main">,</span>ε<span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> program_expr <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">initial_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initial_state</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">e</span><span class="main">.</span> initializes <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">e</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">execution</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">execution</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> initializes <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">maximal_execution</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">maximal_execution</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> execution <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∄</span><span class="bound">s''</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">↝</span> <span class="bound">s''</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reachable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">e</span> <span class="bound">s'</span><span class="main">.</span> execution <span class="bound">e</span> <span class="bound">s'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">terminates_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↓</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> maximal_execution <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="plain_text">Invariants</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Inductive invariance›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inductive_invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inductive_invariant</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> initial_state <span class="bound">s</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s</span> <span class="main">↝</span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s'</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Executions-inductive_invariantI"><span class="command">lemma</span></span> inductive_invariantI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> initial_state <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s</span> <span class="main">↝</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⟹</span> inductive_invariant <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inductive_invariant_def<span class="main">)</span>

<span class="keyword1" id="Executions-inductive_invariant_is_execution_invariant"><span class="command">lemma</span></span> inductive_invariant_is_execution_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">s</span> <span class="main">⟹</span> inductive_invariant <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ind_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"inductive_invariant <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">initial</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> initializes<span class="main">:</span> <span class="quoted"><span class="quoted">"initializes <span class="skolem">initial</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trace<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">initial</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main">^^</span><span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> execution_def reachable_def rtrancl_power<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">initial</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>   <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"initial_state <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> initializes <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ind_inv inductive_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> nfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">initial</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">↝</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span> nfold initializes <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ind_inv step inductive_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Subsumption is invariant›</span></span>

<span class="keyword1" id="Executions-nice_ind_inv_is_inductive_invariant"><span class="command">lemma</span></span> nice_ind_inv_is_inductive_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"inductive_invariant <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span> <span class="bound">s</span> <span class="main">∧</span> <span class="keyword1">𝒜<span class="hidden">⇩</span><sub>G</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inductive_invariantI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"initial_state <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> ε<span class="main">(</span><span class="skolem">r</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span> ε<span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prog_expr_e<span class="main">:</span> <span class="quoted"><span class="quoted">"program_expr <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span> <span class="skolem">s</span> <span class="main">∧</span> <span class="keyword1">𝒜<span class="hidden">⇩</span><sub>G</sub></span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> domains_subsume_globallyI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span> <span class="skolem">σ'</span> <span class="skolem">τ'</span> <span class="skolem">e'</span>
      <span class="keyword3"><span class="command">assume</span></span> s_r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="skolem">r'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">τ'</span><span class="main">,</span><span class="skolem">e'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s s_r' prog_expr_e <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> domI domIff fun_upd_other<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">τ'</span><span class="main">,</span><span class="skolem">e'</span><span class="main">)</span> <span class="main">=</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>ε<span class="main">,</span> ε<span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s s_r' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prog_expr_e <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dom <span class="skolem">σ'</span> <span class="main">∪</span> dom <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r'</span> <span class="main">=</span> <span class="skolem">r</span>›</span></span> s s_r' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">τ'</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domains_subsume_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜<span class="hidden">⇩</span><sub>G</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_accessible_globallyI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">σ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">σ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span>
      <span class="keyword3"><span class="command">assume</span></span> s_r1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s_r2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s s_r2 prog_expr_e  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> domI domIff fun_upd_other<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> ε"</span></span> <span class="keyword1"><span class="command">using</span></span> s s_r2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>S</sub> <span class="skolem">σ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒜</span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s_r2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> step_preserves_𝒮<span class="hidden">⇩</span><sub>G</sub>_and_𝒜<span class="hidden">⇩</span><sub>G</sub> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> reachable_imp_𝒮<span class="hidden">⇩</span><sub>G</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">s</span> <span class="main">⟹</span> <span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s</span> <span class="main">∧</span> <span class="keyword1">𝒜<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inductive_invariant_is_execution_invariant<span class="main"><span class="main">[</span></span><span class="operator">OF</span> reach nice_ind_inv_is_inductive_invariant<span class="main"><span class="main">]</span></span><span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executions-transition_relations_equivalent"><span class="command">lemma</span></span> transition_relations_equivalent<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">s</span> <span class="main">⟹</span> revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">=</span> revision_step_relaxed <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> doms_sub_local<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝒮<span class="hidden">⇩</span><sub>G</sub></span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reachable_imp_𝒮<span class="hidden">⇩</span><sub>G</sub><span class="main"><span class="main">[</span></span><span class="operator">OF</span> reach<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">=</span> revision_step_relaxed <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"revision_step_relaxed <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> step <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>new <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">ℰ</span> <span class="skolem">v</span> <span class="skolem">l</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"revision_step_relaxed <span class="free">r</span> <span class="free">s</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Loc <span class="skolem">l</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> revision_step_relaxed.new<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∉</span> <span class="main">⋃</span> <span class="main">{</span> doms <span class="bound">ls</span> <span class="main">|</span> <span class="bound">ls</span><span class="main">.</span> <span class="bound">ls</span> <span class="main">∈</span> ran <span class="free">s</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> 
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">{</span> doms <span class="bound">ls</span> <span class="main">|</span> <span class="bound">ls</span><span class="main">.</span> <span class="bound">ls</span> <span class="main">∈</span> ran <span class="free">s</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> in_ran<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span> <span class="main">∈</span> ran <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> in_doms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> doms <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">from</span></span> in_doms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ls</span></span><span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">ls</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">s</span> <span class="bound">r</span> <span class="main">=</span> Some <span class="bound">ls</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> in_ran ran_def<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="skolem">ls</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> new <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> new.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> revision_step_relaxed.intros <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step_relaxed <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> step <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_step_relaxedE›</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>new <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">ℰ</span> <span class="skolem">v</span> <span class="skolem">l</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Loc <span class="skolem">l</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> revision_step.new<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">ℰ</span> <span class="main">[</span>Ref <span class="main">(</span>VE <span class="skolem">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="skolem"><span class="skolem">τ'</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s_r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">r'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">τ'</span><span class="main">,</span><span class="skolem">e'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l_in_local<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">τ'</span><span class="main">,</span><span class="skolem">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">σ'</span> <span class="main">∪</span> dom <span class="skolem">τ'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> domains_subsume_def domains_subsume_globally_def doms.simps doms_sub_local rev_subsetD<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> s_r' new.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ranI<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> new.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>get <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">ℰ</span> <span class="skolem">l</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="skolem">σ</span><span class="main">;;</span><span class="skolem">τ</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> 
       <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">ℰ</span> <span class="main">[</span>Read <span class="main">(</span>VE <span class="main">(</span>Loc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">σ</span><span class="main">;;</span><span class="skolem">τ</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">ℰ</span> <span class="main">[</span>Read <span class="main">(</span>VE <span class="main">(</span>Loc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">σ</span> <span class="main">∪</span> dom <span class="skolem">τ</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> domains_subsume_def domains_subsume_globally_def doms_sub_local get.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
         <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">σ</span><span class="main">;;</span><span class="skolem">τ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_combination_dom_union<span class="main">)</span>
       <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> get.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>set <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">ℰ</span> <span class="skolem">l</span> <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">(</span><span class="skolem">l</span> <span class="main">↦</span> <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>CV Unit<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> 
       <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">ℰ</span> <span class="main">[</span>Assign <span class="main">(</span>VE <span class="main">(</span>Loc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>VE <span class="skolem">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">σ</span><span class="main">;;</span><span class="skolem">τ</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">ℰ</span> <span class="main">[</span>Assign <span class="main">(</span>VE <span class="main">(</span>Loc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>VE <span class="skolem">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="skolem">σ</span> <span class="main">∪</span> dom <span class="skolem">τ</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> domains_subsume_def domains_subsume_globally_def doms_sub_local set.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
         <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">σ</span><span class="main">;;</span><span class="skolem">τ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_combination_dom_union<span class="main">)</span>
       <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> set.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> revision_step.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Finitude is invariant›</span></span>

<span class="keyword1" id="Executions-finite_occurrences_val_expr"><span class="command">lemma</span></span> finite_occurrences_val_expr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> val"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> expr"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val_expr.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span>  
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executions-store_finite_upd"><span class="command">lemma</span></span> store_finite_upd <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> ID_restricted_store_subset_store<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ID_restricted_store_subset_store<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rev_finite_subset<span class="main">)</span>

<span class="keyword1" id="Executions-finite_state_imp_restriction_finite"><span class="command">lemma</span></span> finite_state_imp_restriction_finite <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> infinite_super ID_restricted_global_subset_unrestricted<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fin finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executions-local_state_of_finite_restricted_global_state_is_finite"><span class="command">lemma</span></span> local_state_of_finite_restricted_global_state_is_finite <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r'</span> <span class="main">=</span> Some <span class="free">ls</span> <span class="main">⟹</span> finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span> <span class="main">⟹</span> finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r'</span> <span class="main">=</span> Some <span class="free">ls</span> <span class="main">⟹</span> finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span> <span class="main">⟹</span> finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ID_distr_global<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finite_Un finite_insert fun_upd_triv fun_upd_twist<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ID_distr_global<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finite_Un fun_upd_triv fun_upd_twist<span class="main">)</span>

<span class="keyword1" id="Executions-empty_map_finite"><span class="command">lemma</span></span> empty_map_finite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>S</sub> ε<span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>S</sub> ε<span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> ε<span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>G</sub> ε<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RID<span class="hidden">⇩</span><sub>S</sub>_def LID<span class="hidden">⇩</span><sub>S</sub>_def RID<span class="hidden">⇩</span><sub>G</sub>_def LID<span class="hidden">⇩</span><sub>G</sub>_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Executions-finite_combination"><span class="command">lemma</span></span> finite_combination <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">τ</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> finite_UnI rev_finite_subset ID_combination_subset_union<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Executions-RID"><span class="command">lemma</span></span> RID<span class="hidden">⇩</span><sub>G</sub>_finite_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> step <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>join <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">ℰ</span> <span class="skolem">r'</span> <span class="skolem">σ'</span> <span class="skolem">τ'</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ID_distr_global<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ID_distr_local<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fin finite_Un finite_combination<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> finite_insert finite_occurrences_val_expr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finite_state_imp_restriction_finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> join local_state_of_finite_restricted_global_state_is_finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> fin <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> ID_distr_global_conditional›</span><span class="main">)</span>

<span class="keyword1" id="Executions-RID"><span class="command">lemma</span></span> RID<span class="hidden">⇩</span><sub>L</sub>_finite_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> step <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>join <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">ℰ</span> <span class="skolem">r'</span> <span class="skolem">σ'</span> <span class="skolem">τ'</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> join assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ID_distr_global<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ID_distr_local<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fin finite_Un finite_combination<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finite_occurrences_val_expr<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> finite_state_imp_restriction_finite<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> join local_state_of_finite_restricted_global_state_is_finite<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> fin <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> ID_distr_global_conditional›</span><span class="main">)</span>
 
<span class="keyword1" id="Executions-reachable_imp_identifiers_finite"><span class="command">lemma</span></span> reachable_imp_identifiers_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> reach <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> exec<span class="main">:</span> <span class="quoted"><span class="quoted">"execution <span class="skolem">e</span> <span class="main">(</span>ε<span class="main">(</span><span class="skolem">r</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span>ε<span class="main">,</span><span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reachable_def execution_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> prog_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"program_expr <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> execution_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_reachable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ε<span class="main">(</span><span class="skolem">r</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span>ε<span class="main">,</span><span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> execution_def rtrancl_imp_relpow<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">hence</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> ε<span class="main">(</span><span class="skolem">r</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span> ε<span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> rid_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">s</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">r</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> rid_ran<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">`</span> ran <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prog_exp<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> rids<span class="main">:</span> <span class="quoted"><span class="quoted">"RID<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">s</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">r</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> RID<span class="hidden">⇩</span><sub>G</sub>_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> rid_dom rid_ran <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> lid_ran<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">`</span> ran <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prog_exp<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> lids<span class="main">:</span> <span class="quoted"><span class="quoted">"LID<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">s</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> LID<span class="hidden">⇩</span><sub>G</sub>_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> rids lids <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      n_steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ε<span class="main">(</span><span class="skolem">r</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span> ε<span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">↝</span> <span class="skolem">s</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> relpow_Suc_E<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> fin_rid<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.hyps n_steps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> fin_lid<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.hyps n_steps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> RID<span class="hidden">⇩</span><sub>G</sub>_finite_invariant RID<span class="hidden">⇩</span><sub>L</sub>_finite_invariant fin_rid local.step valid_stepE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executions-reachable_imp_identifiers_available"><span class="command">lemma</span></span> reachable_imp_identifiers_available<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="free">s</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'r</span> set<span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'l</span> set<span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms ex_new_if_finite reachable_imp_identifiers_finite<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Reachability is invariant›</span></span>

<span class="keyword1" id="Executions-initial_state_reachable"><span class="command">lemma</span></span> initial_state_reachable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"program_expr <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>ε<span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span>ε<span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"initializes <span class="main">(</span>ε<span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span>ε<span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"execution <span class="free">e</span> <span class="main">(</span>ε<span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span>ε<span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ε<span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span>ε<span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> execution_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executions-reachability_closed_under_execution_step"><span class="command">lemma</span></span> reachability_closed_under_execution_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">init</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> exec<span class="main">:</span> <span class="quoted"><span class="quoted">"execution <span class="skolem">e</span> <span class="skolem">init</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reach reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> init_s<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">init</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> execution_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> s_s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">↝</span> <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">init</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> init_s s_s' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"execution <span class="skolem">e</span> <span class="skolem">init</span> <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> execution_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Executions-reachability_closed_under_execution"><span class="command">lemma</span></span> reachability_closed_under_execution<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s'</span> <span class="main">⟹</span> reachable <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rtrancl_imp_relpow <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> reach <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="skolem">s''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s''</span> <span class="main">↝</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="skolem">s''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.hyps <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="skolem">s''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main">^^</span><span class="skolem">n</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s''</span> <span class="main">↝</span> <span class="skolem">s'</span>›</span></span> reachability_closed_under_execution_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* substitution locale *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory *)</span>
</pre>
</div><div id="Determinacy">
<div class="head">
<h1>Theory Determinacy</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="plain_text">Determinacy</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section proves that the concurrent revisions model is determinate modulo renaming-equivalence.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Determinacy
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Executions.html">Executions</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> substitution
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rule determinism›</span></span>

<span class="keyword1" id="Determinacy-app_deterministic"><span class="command">lemma</span></span> app_deterministic <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>Apply <span class="main">(</span>VE <span class="main">(</span>Lambda <span class="free">x</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>VE <span class="free">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span><span class="free">subst</span> <span class="main">(</span>VE <span class="free">v</span><span class="main">)</span> <span class="free">x</span> <span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> revision_stepE<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> s_r <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_r revision_step.app<span class="main">)</span>

<span class="keyword1" id="Determinacy-ifTrue_deterministic"><span class="command">lemma</span></span> ifTrue_deterministic <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>Ite <span class="main">(</span>VE <span class="main">(</span>CV T<span class="main">)</span><span class="main">)</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span><span class="free">e1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> revision_stepE<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> s_r <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_r revision_step.ifTrue<span class="main">)</span>

<span class="keyword1" id="Determinacy-ifFalse_deterministic"><span class="command">lemma</span></span> ifFalse_deterministic <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>Ite <span class="main">(</span>VE <span class="main">(</span>CV F<span class="main">)</span><span class="main">)</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span><span class="free">e2</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> revision_stepE<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> s_r <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_r revision_step.ifFalse<span class="main">)</span>

<span class="keyword1" id="Determinacy-new_pseudodeterministic"><span class="command">lemma</span></span> new_pseudodeterministic <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>Ref <span class="main">(</span>VE <span class="free">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span> <span class="main">∧</span> <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">(</span><span class="bound">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Loc <span class="bound">l</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> revision_stepE<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> s_r <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_r revision_step.new<span class="main">)</span>

<span class="keyword1" id="Determinacy-get_deterministic"><span class="command">lemma</span></span> get_deterministic <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>Read <span class="main">(</span>VE <span class="main">(</span>Loc <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="main">∧</span> <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> revision_stepE<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> s_r <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> revision_step.get <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> s_r›</span><span class="main">)</span>

<span class="keyword1" id="Determinacy-set_deterministic"><span class="command">lemma</span></span> set_deterministic <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>Assign <span class="main">(</span>VE <span class="main">(</span>Loc <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>VE <span class="free">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="main">∧</span> <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>CV Unit<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> revision_stepE<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> s_r <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_r revision_step.set<span class="main">)</span>

<span class="keyword1" id="Determinacy-fork_pseudodeterministic"><span class="command">lemma</span></span> fork_pseudodeterministic <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>Rfork <span class="free">e</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r'</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>Rfork <span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Rid <span class="bound">r'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">r'</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">,</span> ε<span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> step<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> step <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fork <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">ℰ</span> <span class="skolem">e</span> <span class="skolem">r'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">r'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> fork s_r <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_r<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_r revision_step.fork map_upd_triv<span class="main">)</span>

<span class="keyword1" id="Determinacy-rjoin_deterministic"><span class="command">lemma</span></span> rjoin_deterministic <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>Rjoin <span class="main">(</span>VE <span class="main">(</span>Rid <span class="free">r'</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s_r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">τ'</span><span class="main">,</span> VE <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">;;</span><span class="free">τ'</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>CV Unit<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">r'</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> step<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> revision_stepE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> s_r s_r' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">meson</span> s_r s_r' revision_step.join<span class="main">)</span>

<span class="keyword1" id="Determinacy-rjoin"><span class="command">lemma</span></span> rjoin<span class="hidden">⇩</span><sub>ε</sub>_deterministic <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>Rjoin <span class="main">(</span>VE <span class="main">(</span>Rid <span class="free">r'</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s_r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">r'</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span> <span class="main">=</span> ε<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> step<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> revision_stepE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> s_r s_r' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> revision_step.join<span class="hidden">⇩</span><sub>ε</sub> s_r s_r'<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strong local confluence›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Local determinism›</span></span>

<span class="keyword1" id="Determinacy-local_determinism"><span class="command">lemma</span></span> local_determinism<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    left<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    right<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≈</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> left <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main">:</span>revision_stepE›</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>new <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">ℰ</span> <span class="skolem">v</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> new<span class="main">(</span>2<span class="main">)</span> right <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    side<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">(</span><span class="skolem">l'</span> <span class="main">↦</span> <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ℰ</span><span class="main">[</span>VE <span class="main">(</span>Loc <span class="skolem">l'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?β</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"id<span class="main">(</span><span class="skolem">l</span> <span class="main">:=</span> <span class="skolem">l'</span><span class="main">,</span> <span class="skolem">l'</span> <span class="main">:=</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> bij_β<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="var">?β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> swap_bij<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> renaming<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> id <span class="var">?β</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">use</span> new side s<span class="hidden">⇩</span><sub>2</sub>' bij_β <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> ID_distr_global_conditional›</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_statesI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> renaming bij_id bij_β<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fork <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">ℰ</span> <span class="skolem">e</span> <span class="skolem">r'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fork<span class="main">(</span>2<span class="main">)</span> right <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    side<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Rid <span class="skolem">r''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">r''</span> <span class="main">↦</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">;;</span><span class="skolem">τ</span><span class="main">,</span> ε<span class="main">,</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ID_distr_global_conditional<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?α</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"id<span class="main">(</span><span class="skolem">r'</span> <span class="main">:=</span> <span class="skolem">r''</span><span class="main">,</span> <span class="skolem">r''</span> <span class="main">:=</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> bij_α<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="var">?α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> swap_bij<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> renaming<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="var">?α</span> id <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">use</span> fork side s<span class="hidden">⇩</span><sub>2</sub>' bij_α <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> ID_distr_global_conditional›</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_statesI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> renaming bij_α bij_id<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> eq_statesI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">id</span></span> <span class="quoted"><span class="quoted">id</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹General principles›</span></span>

<span class="keyword1" id="Determinacy-SLC_sym"><span class="command">lemma</span></span> SLC_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> αβ_sym<span class="main">)</span>

<span class="keyword1" id="Determinacy-SLC_commute"><span class="command">lemma</span></span> SLC_commute<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">;</span> revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">;</span> revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">⟧</span> <span class="main">⟹</span> 
  <span class="free">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> αβ_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Case join-epsilon›</span></span>

<span class="keyword1" id="Determinacy-SLC_join"><span class="command">lemma</span></span> SLC_join<span class="hidden">⇩</span><sub>ε</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>Rjoin <span class="main">(</span>VE <span class="main">(</span>Rid <span class="free">r''</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> ε"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    side<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r''</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    right<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> right_collapsed_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> ε <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">ε</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">ε</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> left_step_still_available_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≠</span> ε <span class="main">⟹</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r''</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">ε</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">ε</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> right <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>join _ _ _ <span class="skolem">right_joinee</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> r_unchanged_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> join assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> r'_unchanged_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r''</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> join assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">right_joinee</span> <span class="main">≠</span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> join<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> s<span class="hidden">⇩</span><sub>2</sub>'_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≠</span> ε"</span></span> <span class="keyword1"><span class="command">using</span></span> assms join <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_upd_twist<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> left_step_still_available_case<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="hidden">⇩</span><sub>2</sub>'_nonempty r_unchanged_left r'_unchanged_right<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join<span class="hidden">⇩</span><sub>ε</sub>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> right_collapsed_case<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join<span class="hidden">⇩</span><sub>ε</sub><span class="main"><span class="main">(</span></span>2-3<span class="main"><span class="main">)</span></span> right <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> left_step_still_available_case<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> side neq s<span class="hidden">⇩</span><sub>1</sub>_r right <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Case join›</span></span>

<span class="keyword1" id="Determinacy-join_and_local_commute"><span class="command">lemma</span></span> join_and_local_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">;;</span><span class="free">τ'</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>VE <span class="main">(</span>CV Unit<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">r''</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">↦</span> <span class="free">ls</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">≠</span> <span class="free">r''</span>"</span></span>
    <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">;;</span><span class="free">τ'</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>VE <span class="main">(</span>CV Unit<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">r''</span> <span class="main">:=</span> None<span class="main">,</span> <span class="free">r'</span> <span class="main">:=</span> Some <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>Rjoin <span class="main">(</span>VE <span class="main">(</span>Rid <span class="free">r''</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r''</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">τ'</span><span class="main">,</span> VE <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">r</span></span> <span class="main"><span class="main">:=</span></span> Some <span class="main"><span class="main">(</span></span><span class="free"><span class="free">σ</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">τ</span></span><span class="main"><span class="main">;;</span></span><span class="free"><span class="free">τ'</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">ℰ</span></span><span class="main"><span class="main">[</span></span>VE <span class="main"><span class="main">(</span></span>CV Unit<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">r''</span></span> <span class="main"><span class="main">:=</span></span> None<span class="main"><span class="main">,</span></span> <span class="free"><span class="free">r'</span></span> <span class="main"><span class="main">:=</span></span> Some <span class="free"><span class="free">ls</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">r'</span></span> <span class="main"><span class="main">:=</span></span> Some <span class="free"><span class="free">ls</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">:=</span></span> Some <span class="main"><span class="main">(</span></span><span class="free"><span class="free">σ</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">τ</span></span><span class="main"><span class="main">;;</span></span><span class="free"><span class="free">τ'</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">ℰ</span></span><span class="main"><span class="main">[</span></span>VE <span class="main"><span class="main">(</span></span>CV Unit<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">r''</span></span> <span class="main"><span class="main">:=</span></span> None<span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Determinacy-SLC_join"><span class="command">lemma</span></span> SLC_join<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>Rjoin <span class="main">(</span>VE <span class="main">(</span>Rid <span class="free">r''</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="main">(</span><span class="free">τ</span><span class="main">;;</span><span class="free">τ'</span><span class="main">)</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>VE <span class="main">(</span>CV Unit<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">r''</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    side<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r''</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ'</span><span class="main">,</span> <span class="free">τ'</span><span class="main">,</span> VE <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    right<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> left_step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r s<span class="hidden">⇩</span><sub>2</sub> side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> r'_not_joined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">≠</span> <span class="free">r''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> right side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> right <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>new _ _ _ _ <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> l_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_new_introduces_lids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> new right s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> join_and_local_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> assms r'_not_joined new l_fresh_left <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fork _ _ _ _ <span class="skolem">r'''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> r'_unchanged_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r'</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> r'''_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> left_step fork<span class="main">(</span>3<span class="main">)</span> only_fork_introduces_rids' s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> r_unchanged_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> r''_unchanged_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r''</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">:=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r'</span><span class="main">,</span> <span class="skolem">r'''</span> <span class="main">:=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">r'''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r</span><span class="main">,</span> <span class="free">r''</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_commute<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>1<span class="main">)</span> fork<span class="main">(</span>3<span class="main">)</span> neq r'_not_joined s<span class="hidden">⇩</span><sub>1</sub>_r s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ID_distr_global_conditional<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>1-2<span class="main">)</span> r'_unchanged_left r'''_fresh_left <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ID_distr_global_conditional<span class="main">)</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r''_unchanged_right r_unchanged_right s<span class="hidden">⇩</span><sub>1</sub>_r s<span class="hidden">⇩</span><sub>2</sub> side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>join _ _ _ <span class="skolem">r'''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> r'_unchanged_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r'</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> join<span class="main">(</span>2<span class="main">)</span> neq r'_not_joined s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> r_unchanged_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> join<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> neq s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r''</span> <span class="main">=</span> <span class="skolem">r'''</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> r'''_none_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">r'''</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True s<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> r''_none_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r''</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True join<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">ε</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">ε</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_commute<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ε <span class="main">=</span> ε"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> ε"</span></span> <span class="keyword1"><span class="command">using</span></span> r'_unchanged_left r'''_none_left join<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> ε"</span></span> <span class="keyword1"><span class="command">using</span></span> r_unchanged_right r''_none_right s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> r'''_unchanged_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">r'''</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r'''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False join<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> s<span class="hidden">⇩</span><sub>2</sub> r_unchanged_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> r''_unchanged_right'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r''</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False join<span class="main">(</span>1<span class="main">)</span> r'_not_joined side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">:=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r'</span><span class="main">,</span> <span class="skolem">r'''</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r</span><span class="main">,</span> <span class="free">r''</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_commute<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> join<span class="main">(</span>1<span class="main">)</span> neq r'_not_joined r_unchanged_right s<span class="hidden">⇩</span><sub>1</sub>_r s<span class="hidden">⇩</span><sub>2</sub> s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join r'''_unchanged_left r'_unchanged_left<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r''_unchanged_right' r_unchanged_right s<span class="hidden">⇩</span><sub>1</sub>_r side s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join<span class="hidden">⇩</span><sub>ε</sub>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="hidden">⇩</span><sub>ε</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> left_step neq right join<span class="hidden">⇩</span><sub>ε</sub> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> join_and_local_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> assms r'_not_joined <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Case local›</span></span>

<span class="keyword1" id="Determinacy-local_steps_commute"><span class="command">lemma</span></span> local_steps_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">↦</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">x</span><span class="main">,</span> <span class="free">r'</span> <span class="main">↦</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">↦</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">↦</span> <span class="free">y</span><span class="main">,</span> <span class="free">r</span> <span class="main">↦</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms fun_upd_twist fun_upd_upd local_determinism<span class="main">)</span>

<span class="keyword1" id="Determinacy-local_and_fork_commute"><span class="command">lemma</span></span> local_and_fork_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Rid <span class="free">r''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">r''</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">,</span> ε<span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>Rfork <span class="free">e</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Rid <span class="free">r''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">r''</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">,</span> ε<span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span> <span class="main">↦</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">r</span></span> <span class="main"><span class="main">↦</span></span> <span class="free"><span class="free">x</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">r'</span></span> <span class="main"><span class="main">↦</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">σ</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">τ</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">ℰ</span></span> <span class="main"><span class="main">[</span></span>VE <span class="main"><span class="main">(</span></span>Rid <span class="free"><span class="free">r''</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">r''</span></span> <span class="main"><span class="main">↦</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">σ</span></span><span class="main"><span class="main">;;</span></span><span class="free"><span class="free">τ</span></span><span class="main"><span class="main">,</span></span> ε<span class="main"><span class="main">,</span></span> <span class="free"><span class="free">e</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">r'</span></span> <span class="main"><span class="main">↦</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">σ</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">τ</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">ℰ</span></span> <span class="main"><span class="main">[</span></span>VE <span class="main"><span class="main">(</span></span>Rid <span class="free"><span class="free">r''</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">r''</span></span> <span class="main"><span class="main">↦</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">σ</span></span><span class="main"><span class="main">;;</span></span><span class="free"><span class="free">τ</span></span><span class="main"><span class="main">,</span></span> ε<span class="main"><span class="main">,</span></span> <span class="free"><span class="free">e</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">↦</span></span> <span class="free"><span class="free">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> SLC_commute<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">x</span><span class="main">,</span> <span class="free">r'</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Rid <span class="free">r''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">r''</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">,</span> ε<span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Rid <span class="free">r''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">r''</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">,</span> ε<span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span> <span class="main">↦</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms revision_step.fork <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="free">x</span><span class="main">,</span> <span class="free">r'</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Rid <span class="free">r''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">r''</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">,</span> ε<span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> revision_step.fork <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Rid <span class="free">r''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">r''</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">,</span> ε<span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span> <span class="main">↦</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1" id="Determinacy-SLC_app"><span class="command">lemma</span></span> SLC_app<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>Apply <span class="main">(</span>VE <span class="main">(</span>Lambda <span class="free">x</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>VE <span class="free">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span><span class="free">subst</span> <span class="main">(</span>VE <span class="free">v</span><span class="main">)</span> <span class="free">x</span> <span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    right<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> left_step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> right <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> new<span class="main">:</span> <span class="main">(</span>new _ _ _ _ <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> l_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_new_introduces_lids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r new<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_steps_commute<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> new l_fresh_left assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fork _ _ _ _ <span class="skolem">r''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> r''_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_fork_introduces_rids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r fork<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_and_fork_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="hidden">⇩</span><sub>2</sub> fork<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> fork neq s<span class="hidden">⇩</span><sub>2</sub> r''_fresh_left s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join left_step right neq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join<span class="hidden">⇩</span><sub>ε</sub>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="hidden">⇩</span><sub>ε</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join<span class="hidden">⇩</span><sub>ε</sub> left_step right neq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> local_steps_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Determinacy-SLC_ifTrue"><span class="command">lemma</span></span> SLC_ifTrue<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>Ite <span class="main">(</span>VE <span class="main">(</span>CV T<span class="main">)</span><span class="main">)</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span><span class="free">e1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    right<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> left_step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> right <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>new _ _ _ _ <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> l_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_new_introduces_lids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r new<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_steps_commute<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> new l_fresh_left assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fork _ _ _ _ <span class="skolem">r''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> r''_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_fork_introduces_rids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r fork<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_and_fork_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="hidden">⇩</span><sub>2</sub> fork<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> fork neq s<span class="hidden">⇩</span><sub>2</sub> r''_fresh_left s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join left_step right neq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join<span class="hidden">⇩</span><sub>ε</sub>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="hidden">⇩</span><sub>ε</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join<span class="hidden">⇩</span><sub>ε</sub> left_step right neq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> local_steps_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Determinacy-SLC_ifFalse"><span class="command">lemma</span></span> SLC_ifFalse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>Ite <span class="main">(</span>VE <span class="main">(</span>CV F<span class="main">)</span><span class="main">)</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span><span class="free">e2</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    right<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> left_step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> right <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>new _ _ _ _ <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> l_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_new_introduces_lids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r new<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_steps_commute<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> new l_fresh_left assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fork _ _ _ _ <span class="skolem">r''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> r''_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_fork_introduces_rids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r fork<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_and_fork_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="hidden">⇩</span><sub>2</sub> fork<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> fork neq s<span class="hidden">⇩</span><sub>2</sub> r''_fresh_left s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join left_step right neq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join<span class="hidden">⇩</span><sub>ε</sub>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="hidden">⇩</span><sub>ε</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join<span class="hidden">⇩</span><sub>ε</sub> left_step right neq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> local_steps_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Determinacy-SLC_set"><span class="command">lemma</span></span> SLC_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>Assign <span class="main">(</span>VE <span class="main">(</span>Loc <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>VE <span class="free">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>VE <span class="main">(</span>CV Unit<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    side<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    right<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> left_step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r s<span class="hidden">⇩</span><sub>2</sub> side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> right <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>new _ _ _ _ <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> l_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_new_introduces_lids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r new<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_steps_commute<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> new l_fresh_left assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fork _ _ _ _ <span class="skolem">r''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> r''_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_fork_introduces_rids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r fork<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_and_fork_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="hidden">⇩</span><sub>2</sub> fork<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> fork neq s<span class="hidden">⇩</span><sub>2</sub> r''_fresh_left s<span class="hidden">⇩</span><sub>1</sub>_r side <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join left_step neq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join<span class="hidden">⇩</span><sub>ε</sub>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="hidden">⇩</span><sub>ε</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join<span class="hidden">⇩</span><sub>ε</sub> left_step neq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> local_steps_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Determinacy-SLC_get"><span class="command">lemma</span></span> SLC_get<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>Read <span class="main">(</span>VE <span class="main">(</span>Loc <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>VE <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    side<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    right<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> left_step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r s<span class="hidden">⇩</span><sub>2</sub> side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> right <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>new _ _ _ _ <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> l_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_new_introduces_lids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r new<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_steps_commute<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> new l_fresh_left assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fork _ _ _ _ <span class="skolem">r''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> r''_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_fork_introduces_rids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r fork<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_and_fork_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="hidden">⇩</span><sub>2</sub> fork<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> fork neq s<span class="hidden">⇩</span><sub>2</sub> r''_fresh_left s<span class="hidden">⇩</span><sub>1</sub>_r side <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join left_step neq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join<span class="hidden">⇩</span><sub>ε</sub>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="hidden">⇩</span><sub>ε</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join<span class="hidden">⇩</span><sub>ε</sub> left_step neq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> local_steps_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Case new›</span></span>

<span class="keyword1" id="Determinacy-SLC_new"><span class="command">lemma</span></span> SLC_new<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>Ref <span class="main">(</span>VE <span class="free">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Loc <span class="free">l</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    side<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    right<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    lid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'l</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> left_step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r s<span class="hidden">⇩</span><sub>2</sub> side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> right <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> app
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_app<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> app assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ifTrue
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_ifTrue<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> ifTrue assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ifFalse
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_ifFalse<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> ifFalse assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>new <span class="skolem">σ'</span> <span class="skolem">τ'</span> <span class="skolem">ℰ'</span> <span class="skolem">v'</span> <span class="skolem">l'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> r'_unchanged_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r'</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new<span class="main">(</span>2<span class="main">)</span> neq s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> r_unchanged_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> neq s<span class="hidden">⇩</span><sub>1</sub>_r<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="skolem">l'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l''</span></span> <span class="keyword2"><span class="keyword">where</span></span> l''_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l''</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ex_new_if_finite left_step lid_inf reach RID<span class="hidden">⇩</span><sub>L</sub>_finite_invariant reachable_imp_identifiers_finite<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> l_l''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="skolem">l''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> l''_fresh_s<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l''</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms True new l''_fresh_left <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ID_distr_global_conditional<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> l''_fresh_right'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l''</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True l_l'' new<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?β</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"id<span class="main">(</span><span class="free">l</span> <span class="main">:=</span> <span class="skolem">l''</span><span class="main">,</span> <span class="skolem">l''</span> <span class="main">:=</span> <span class="free">l</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> bij_β<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="var">?β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap_bij<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">↦</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">τ'</span><span class="main">(</span><span class="skolem">l''</span> <span class="main">↦</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ℰ'</span> <span class="main">[</span>VE <span class="main">(</span>Loc <span class="skolem">l''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> left_convergence<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> l''_fresh_left new<span class="main">(</span>2<span class="main">)</span> r'_unchanged_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">(</span><span class="skolem">l''</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>VE <span class="main">(</span>Loc <span class="skolem">l''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> right_convergence<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> l''_fresh_right' new<span class="main">(</span>1<span class="main">)</span> neq s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">have</span></span> equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_statesI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">id</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?β</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> id <span class="var">?β</span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> s<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> id <span class="var">?β</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l''_fresh_s<span class="hidden">⇩</span><sub>1</sub> side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> id <span class="var">?β</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l''_fresh_s<span class="hidden">⇩</span><sub>1</sub> s<span class="hidden">⇩</span><sub>1</sub>_r side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> ℰ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> id <span class="var">?β</span> <span class="free">ℰ</span> <span class="main">=</span> <span class="free">ℰ</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>C</sub> <span class="free">ℰ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l''</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>C</sub> <span class="free">ℰ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l''_fresh_left s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> τlv<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> id <span class="main">(</span>id<span class="main">(</span><span class="free">l</span> <span class="main">:=</span> <span class="skolem">l''</span><span class="main">,</span> <span class="skolem">l''</span> <span class="main">:=</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span><span class="main">(</span><span class="skolem">l''</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> τ<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> id <span class="var">?β</span> <span class="free">τ</span> <span class="main">=</span> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l''_fresh_s<span class="hidden">⇩</span><sub>1</sub> s<span class="hidden">⇩</span><sub>1</sub>_r side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> id <span class="var">?β</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l''</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l''_fresh_s<span class="hidden">⇩</span><sub>1</sub> s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> τ v bij_β<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> id <span class="var">?β</span> <span class="skolem">σ'</span> <span class="main">=</span> <span class="skolem">σ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l''_fresh_s<span class="hidden">⇩</span><sub>1</sub> new<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True ID_distr_global_conditional<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> ℰ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> id <span class="var">?β</span> <span class="skolem">ℰ'</span> <span class="main">=</span> <span class="skolem">ℰ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l''_fresh_s<span class="hidden">⇩</span><sub>1</sub> new<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True ID_distr_global_conditional<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> τl''v<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> id <span class="main">(</span>id<span class="main">(</span><span class="free">l</span> <span class="main">:=</span> <span class="skolem">l''</span><span class="main">,</span> <span class="skolem">l''</span> <span class="main">:=</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">τ'</span><span class="main">(</span><span class="skolem">l''</span> <span class="main">↦</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">τ'</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> τ'<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> id <span class="var">?β</span> <span class="skolem">τ'</span> <span class="main">=</span> <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new<span class="main">(</span>2-3<span class="main">)</span> l''_fresh_s<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True ID_distr_global_conditional<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> v'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> id <span class="var">?β</span> <span class="skolem">v'</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new<span class="main">(</span>2-3<span class="main">)</span> l''_fresh_s<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True ID_distr_global_conditional<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> τ' v' bij_β<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True neq s<span class="hidden">⇩</span><sub>1</sub> σ ℰ τlv σ' ℰ' τl''v s<span class="hidden">⇩</span><sub>2</sub> l_l'' new<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_β<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> left_convergence right_convergence equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> l_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> revision_stepE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> False side new<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> s<span class="hidden">⇩</span><sub>1</sub>_r›</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> l'_fresh_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> revision_stepE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> right<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> False new<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> new<span class="main">(</span>2<span class="main">)</span>›</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_steps_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="hidden">⇩</span><sub>2</sub> new<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> new assms l_fresh_left l'_fresh_right s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> get
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_get<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> get assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> set
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_set<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> set assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fork _ _ _ _ <span class="skolem">r''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> r''_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_fork_introduces_rids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r fork<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> l_fresh_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_new_introduces_lids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> right<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> side fork<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_and_fork_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="hidden">⇩</span><sub>2</sub> fork<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> fork<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> neq s<span class="hidden">⇩</span><sub>2</sub> l_fresh_right r''_fresh_left s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join left_step neq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join<span class="hidden">⇩</span><sub>ε</sub>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="hidden">⇩</span><sub>ε</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join<span class="hidden">⇩</span><sub>ε</sub> left_step neq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Case fork›</span></span>

<span class="keyword1" id="Determinacy-SLC_fork"><span class="command">lemma</span></span> SLC_fork<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span> <span class="main">[</span>Rfork <span class="free">e</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>VE <span class="main">(</span>Rid <span class="free">left_forkee</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">left_forkee</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">,</span> ε<span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    side<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">left_forkee</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    right<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    rid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'r</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> left_step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r s<span class="hidden">⇩</span><sub>2</sub> side <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ID_distr_global_conditional<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> right <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> app
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_app<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> app <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> ID_distr_global_conditional›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ifTrue
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_ifTrue<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> ifTrue <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> ID_distr_global_conditional›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ifFalse
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_ifFalse<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> ifFalse <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> ID_distr_global_conditional›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>new _ _ _ _ <span class="skolem">l</span><span class="main">)</span> <span class="comment1">(* symmetry is intentionally not exploited: this would require the lid_inf assumption *)</span>
    <span class="keyword1"><span class="command">have</span></span> l_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_new_introduces_lids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> left_step<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r new<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> r''_fresh_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">left_forkee</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> only_fork_introduces_rids'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> right<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> side new<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> local_and_fork_commute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> new<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> new<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> neq s<span class="hidden">⇩</span><sub>1</sub>_r r''_fresh_right l_fresh_left s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> get
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_get<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> get <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> ID_distr_global_conditional›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> set
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_set<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span> set <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> ID_distr_global_conditional›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fork <span class="skolem">σ'</span> <span class="skolem">τ'</span> <span class="skolem">ℰ'</span> <span class="skolem">e'</span> <span class="skolem">right_forkee</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> r'_unchanged_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r'</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> side fork<span class="main">(</span>2<span class="main">)</span> neq s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> r_unchanged_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> neq s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">left_forkee</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="skolem">right_forkee</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>3<span class="main">)</span> s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">≠</span> <span class="free">left_forkee</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>2<span class="main">)</span> side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">≠</span> <span class="skolem">right_forkee</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>2<span class="main">)</span> fork<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">left_forkee</span> <span class="main">=</span> <span class="skolem">right_forkee</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r''</span></span> <span class="keyword2"><span class="keyword">where</span></span> r''_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> RID<span class="hidden">⇩</span><sub>G</sub>_finite_invariant ex_new_if_finite left_step reach reachable_imp_identifiers_finite<span class="main">(</span>1<span class="main">)</span> rid_inf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">≠</span> <span class="free">left_forkee</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">≠</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r''_fresh_left s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">≠</span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>2<span class="main">)</span> r''_fresh_left r'_unchanged_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>VE <span class="main">(</span>Rid <span class="free">left_forkee</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> RID<span class="hidden">⇩</span><sub>G</sub>_def True UnI1 <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="skolem">right_forkee</span>›</span></span> domIff fun_upd_other fun_upd_triv in_restricted_global_in_updated_global<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fork<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> r''_fresh_left s<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> r''_fresh_s<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="free">left_forkee</span>›</span></span> s<span class="hidden">⇩</span><sub>2</sub> r''_fresh_left s<span class="hidden">⇩</span><sub>1</sub>_r <span class="quoted"><span class="quoted">‹<span class="skolem">r''</span> <span class="main">≠</span> <span class="free">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ID_distr_global_conditional<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> r''_fresh_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">r''</span> <span class="main">≠</span> <span class="free">left_forkee</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r'</span> <span class="main">≠</span> <span class="skolem">right_forkee</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r''</span> <span class="main">≠</span> <span class="free">r'</span>›</span></span> r''_fresh_s<span class="hidden">⇩</span><sub>1</sub> fork<span class="main">(</span>2<span class="main">)</span> r''_fresh_s<span class="hidden">⇩</span><sub>1</sub> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fork<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ID_distr_global_conditional fun_upd_twist<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?α</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"id<span class="main">(</span><span class="free">left_forkee</span> <span class="main">:=</span> <span class="skolem">r''</span><span class="main">,</span> <span class="skolem">r''</span> <span class="main">:=</span> <span class="free">left_forkee</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> bij_α<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="var">?α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap_bij<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">↦</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">τ'</span><span class="main">,</span> <span class="skolem">ℰ'</span> <span class="main">[</span>VE <span class="main">(</span>Rid <span class="skolem">r''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">r''</span> <span class="main">↦</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">;;</span><span class="skolem">τ'</span><span class="main">,</span> ε<span class="main">,</span> <span class="skolem">e'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> left_convergence<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>2<span class="main">)</span> r''_fresh_left r'_unchanged_left revision_step.fork <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span> <span class="free">τ</span><span class="main">,</span> <span class="free">ℰ</span><span class="main">[</span>VE <span class="main">(</span>Rid <span class="skolem">r''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">r''</span> <span class="main">↦</span> <span class="main">(</span><span class="free">σ</span><span class="main">;;</span><span class="free">τ</span><span class="main">,</span> ε<span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> right_convergence<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r''_fresh_right r_unchanged_right revision_step.fork s<span class="hidden">⇩</span><sub>1</sub>_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_statesI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?α</span></span></span></span></span> <span class="quoted"><span class="quoted">id</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="var">?α</span> id <span class="var">?s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="var">?s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> s<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="var">?α</span> id <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r''_fresh_s<span class="hidden">⇩</span><sub>1</sub> side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="var">?α</span> id <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r''_fresh_s<span class="hidden">⇩</span><sub>1</sub> s<span class="hidden">⇩</span><sub>1</sub>_r True fork<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> τ<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="var">?α</span> id <span class="free">τ</span> <span class="main">=</span> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r''_fresh_s<span class="hidden">⇩</span><sub>1</sub> s<span class="hidden">⇩</span><sub>1</sub>_r True fork<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> ℰ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?α</span> id <span class="free">ℰ</span> <span class="main">=</span> <span class="free">ℰ</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">left_forkee</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>C</sub> <span class="free">ℰ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>C</sub> <span class="free">ℰ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="skolem">right_forkee</span>›</span></span> r''_fresh_left s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="var">?α</span> id <span class="free">e</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">left_forkee</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_r side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="skolem">right_forkee</span>›</span></span> r''_fresh_left s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="var">?α</span> id <span class="skolem">σ'</span> <span class="main">=</span> <span class="skolem">σ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>2<span class="main">)</span> r''_fresh_s<span class="hidden">⇩</span><sub>1</sub> side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> τ'<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="var">?α</span> id <span class="skolem">τ'</span> <span class="main">=</span> <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>2<span class="main">)</span> r''_fresh_s<span class="hidden">⇩</span><sub>1</sub> side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> ℰ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?α</span> id <span class="skolem">ℰ'</span> <span class="main">=</span> <span class="skolem">ℰ'</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> 
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">left_forkee</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>C</sub> <span class="skolem">ℰ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>2<span class="main">)</span> side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>C</sub> <span class="skolem">ℰ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>2<span class="main">)</span> r''_fresh_s<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> e'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="var">?α</span> id <span class="skolem">e'</span> <span class="main">=</span> <span class="skolem">e'</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> 
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">left_forkee</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>2<span class="main">)</span> side <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>2<span class="main">)</span> r''_fresh_s<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True fork<span class="main">(</span>1<span class="main">)</span> neq σ τ ℰ e  σ' τ' ℰ' e' s<span class="hidden">⇩</span><sub>1</sub> s<span class="hidden">⇩</span><sub>2</sub>
            bij_α <span class="quoted"><span class="quoted">‹<span class="skolem">r''</span> <span class="main">≠</span> <span class="free">left_forkee</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r'</span> <span class="main">≠</span> <span class="free">left_forkee</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="free">left_forkee</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r''</span> <span class="main">≠</span> <span class="free">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r''</span> <span class="main">≠</span> <span class="free">r'</span>›</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_α<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> equiv left_convergence right_convergence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> right_forkee_fresh_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">right_forkee</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="free">left_forkee</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="skolem">right_forkee</span>›</span></span> fork<span class="main">(</span>3<span class="main">)</span> s<span class="hidden">⇩</span><sub>1</sub>_r 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="hidden">⇩</span><sub>2</sub> ID_distr_global_conditional<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> left_forkee_fresh_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">left_forkee</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹<span class="free">r'</span> <span class="main">≠</span> <span class="skolem">right_forkee</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r'</span> <span class="main">≠</span> <span class="free">left_forkee</span>›</span></span> side fork<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fork<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ID_distr_global_conditional fun_upd_twist<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">r'</span></span> <span class="main"><span class="main">:=</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="free"><span class="free">r'</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">right_forkee</span></span> <span class="main"><span class="main">:=</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">right_forkee</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
            <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">r</span></span> <span class="main"><span class="main">:=</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="free"><span class="free">r</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">left_forkee</span></span> <span class="main"><span class="main">:=</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="free"><span class="free">left_forkee</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
            <span class="operator">rule</span> SLC_commute<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">:=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r'</span><span class="main">,</span> <span class="skolem">right_forkee</span> <span class="main">:=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">right_forkee</span><span class="main">)</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r</span><span class="main">,</span> <span class="free">left_forkee</span> <span class="main">:=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">left_forkee</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="skolem">right_forkee</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r'</span> <span class="main">≠</span> <span class="free">left_forkee</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r'</span> <span class="main">≠</span> <span class="skolem">right_forkee</span>›</span></span> fork<span class="main">(</span>1<span class="main">)</span> neq s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="free">r'</span> <span class="main">:=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">r'</span><span class="main">,</span> <span class="skolem">right_forkee</span> <span class="main">:=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">right_forkee</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>1-2<span class="main">)</span> r'_unchanged_left revision_step.fork right_forkee_fresh_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r</span><span class="main">,</span> <span class="free">left_forkee</span> <span class="main">:=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">left_forkee</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> left_forkee_fresh_right r_unchanged_right revision_step.fork s<span class="hidden">⇩</span><sub>1</sub>_r s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join left_step assms<span class="main"><span class="main">(</span></span>3-5<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> join<span class="hidden">⇩</span><sub>ε</sub>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SLC_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SLC_join<span class="hidden">⇩</span><sub>ε</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> join<span class="hidden">⇩</span><sub>ε</sub> left_step assms<span class="main"><span class="main">(</span></span>3-5<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The theorem›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> strong_local_confluence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    l<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    r<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    lid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'l</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    rid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'r</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>revision_step <span class="free">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="free">r'</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l local_determinism r<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> neq<span class="main">:</span> False
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> revision_stepE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> l<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms SLC_app SLC_ifTrue
    SLC_ifFalse SLC_new SLC_get SLC_set SLC_fork SLC_join SLC_join<span class="hidden">⇩</span><sub>ε</sub><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Diagram Tiling›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Strong local confluence diagrams›</span></span>

<span class="keyword1" id="Determinacy-SLC"><span class="command">lemma</span></span> SLC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    lid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'l</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    rid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'r</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>=</sup></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">↝<span class="hidden">⇧</span><sup>=</sup></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="skolem">r</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub>' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="skolem">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">s<span class="hidden">⇩</span><sub>3</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    s<span class="hidden">⇩</span><sub>3</sub>_eq_s<span class="hidden">⇩</span><sub>3</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    l_join<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="skolem">r'</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    r_join<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="skolem">r</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∨</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> l r reach lid_inf rid_inf strong_local_confluence <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> s<span class="hidden">⇩</span><sub>2</sub>s<span class="hidden">⇩</span><sub>3</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>=</sup></span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l_join steps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> s<span class="hidden">⇩</span><sub>2</sub>'s<span class="hidden">⇩</span><sub>3</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">↝<span class="hidden">⇧</span><sup>=</sup></span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r_join steps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>2</sub>'s<span class="hidden">⇩</span><sub>3</sub> s<span class="hidden">⇩</span><sub>2</sub>s<span class="hidden">⇩</span><sub>3</sub> s<span class="hidden">⇩</span><sub>3</sub>_eq_s<span class="hidden">⇩</span><sub>3</sub>' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Determinacy-SLC_top_relaxed"><span class="command">lemma</span></span> SLC_top_relaxed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>=</sup></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    lid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'l</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    rid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'r</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>=</sup></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">↝<span class="hidden">⇧</span><sup>=</sup></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> SLC lid_inf reach rid_inf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟹</span> <span class="var">?thesis</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> αβ_refl<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Mimicking diagrams›</span></span>

<span class="keyword1"><span class="command">declare</span></span> bind_eq_None_conv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> bind_eq_Some_conv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Determinacy-in_renamed_in_unlabelled_val"><span class="command">lemma</span></span> in_renamed_in_unlabelled_val<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"bij <span class="free">α</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"bij <span class="free">β</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_is_inj inj_image_mem_iff val.set_map<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Determinacy-in_renamed_in_unlabelled_expr"><span class="command">lemma</span></span> in_renamed_in_unlabelled_expr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij <span class="free">α</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>E</sub> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"bij <span class="free">β</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>E</sub> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_is_inj inj_image_mem_iff expr.set_map<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Determinacy-in_renamed_in_unlabelled_store"><span class="command">lemma</span></span> in_renamed_in_unlabelled_store<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    bij_α<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    bij_β<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> RID<span class="hidden">⇩</span><sub>S</sub>E<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> map<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span> <span class="skolem">l</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> αr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="skolem">v</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span>inv <span class="free">β</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bij_α bij_β <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_is_inj<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bij_α bij_β αr map <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_is_inj in_renamed_in_unlabelled_val<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ</span> <span class="main">(</span>inv <span class="free">β</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>V</sub> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> RID<span class="hidden">⇩</span><sub>S</sub>E RID<span class="hidden">⇩</span><sub>S</sub>I bij_α bij_β fun_upd_same fun_upd_triv 
      in_renamed_in_unlabelled_val<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> renaming_distr_store<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LID<span class="hidden">⇩</span><sub>S</sub>E<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> dom <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LID<span class="hidden">⇩</span><sub>S</sub>I<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bij_β bijection.intro bijection.inv_left<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">l'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span> <span class="skolem">l'</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="skolem">v</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bij_β <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LID<span class="hidden">⇩</span><sub>S</sub>I<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> in_renamed_in_unlabelled_val<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="free">σ</span>"</span></span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LID<span class="hidden">⇩</span><sub>S</sub>E<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> dom <span class="free">σ</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ'</span> <span class="bound">v</span><span class="main">.</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">(</span><span class="free">l</span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> dom <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bij_β <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">l'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">l'</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l_in_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>V</sub> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ'</span><span class="main">.</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="bound">σ'</span><span class="main">(</span><span class="skolem">l'</span> <span class="main">↦</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>S</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">σ</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> l_in_v bij_β <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LID<span class="hidden">⇩</span><sub>S</sub>I<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> in_renamed_in_unlabelled_val<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Determinacy-in_renamed_in_unlabelled_local"><span class="command">lemma</span></span> in_renamed_in_unlabelled_local<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    bij_α<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    bij_β<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ls</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms in_renamed_in_unlabelled_expr in_renamed_in_unlabelled_store<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Determinacy-in_renamed_in_unlabelled_global"><span class="command">lemma</span></span> in_renamed_in_unlabelled_global<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    bij_α<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    bij_β<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> RID<span class="hidden">⇩</span><sub>G</sub>E<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> dom <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> dom <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_α domIff fun_upd_same fun_upd_triv renaming_distr_global<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span> <span class="skolem">ls</span>
      <span class="keyword3"><span class="command">assume</span></span> ℛsr'<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span> <span class="skolem">r'</span> <span class="main">=</span> Some <span class="skolem">ls</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> αr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="skolem">ls</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> s_inv_αr'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>inv <span class="free">α</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="skolem">ls</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">α</span> <span class="skolem">r'</span> <span class="main">∈</span> dom <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ℛsr' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s_inv_αr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>inv <span class="free">α</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">ls'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span> <span class="skolem">r'</span> <span class="main">=</span> Some <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free">α</span> <span class="free">β</span> <span class="skolem">ls'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span> <span class="main">=</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="free">α</span> <span class="free">β</span> <span class="skolem">ls'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ℛsr' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ<span class="hidden">⇩</span><sub>L</sub>_inv s_inv_αr bij_α bij_β<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> r_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="skolem">ls</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_α bij_β bij_imp_bij_inv bijection.intro bijection.inv_left in_renamed_in_unlabelled_local<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> αr<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_in s_inv_αr' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> RID<span class="hidden">⇩</span><sub>G</sub>E<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> dom <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> dom <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bij_α domD domI fun_upd_same fun_upd_triv renaming_distr_global<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span> <span class="skolem">ls</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">r'</span> <span class="main">=</span> Some <span class="skolem">ls</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>L</sub> <span class="skolem">ls</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="free">r</span> <span class="main">∈</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ID_distr_global<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> UnI2 bij_α bij_β fun_upd_triv in_renamed_in_unlabelled_local<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insertI2 renaming_distr_global<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> Rs_ls<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span> <span class="skolem">r</span> <span class="main">=</span> Some <span class="skolem">ls</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> βl_in_ls<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>L</sub> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="skolem">ls</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_α bij_β bij_imp_bij_inv bijection.intro bijection.inv_left in_renamed_in_unlabelled_local<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>inv <span class="free">α</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">β</span><span class="main">)</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> LID<span class="hidden">⇩</span><sub>G</sub>I Rs_ls bij_α bij_imp_bij_inv fun_upd_idem_iff renaming_distr_global<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bij_α bij_β <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ<span class="hidden">⇩</span><sub>G</sub>_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">(</span><span class="skolem">r</span> <span class="main">↦</span> <span class="skolem">ls</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>L</sub> <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LID<span class="hidden">⇩</span><sub>G</sub>E fun_upd_triv<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="free">l</span> <span class="main">∈</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_α bij_β in_renamed_in_unlabelled_local<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Determinacy-mimicking"><span class="command">lemma</span></span> mimicking<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    bij_α<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    bij_β<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"revision_step <span class="main">(</span><span class="free">α</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">use</span> step <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main">:</span> revision_stepE›</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> app
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_α bij_β bijection.intro bijection.inv_left renaming_distr_subst<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>new _ _ _ _ <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> βl_fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">β</span> <span class="skolem">l</span> <span class="main">∉</span> LID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_α bij_β in_renamed_in_unlabelled_global<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> new<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> βl_fresh new <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_α bij_β bijection.intro bijection.inv_left<span class="main">)</span>   
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fork <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">ℰ</span> <span class="skolem">e</span> <span class="skolem">r'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> αr'_fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="skolem">r'</span> <span class="main">∉</span> RID<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_α bij_β in_renamed_in_unlabelled_global<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fork<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> s_r_as_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">r</span> <span class="main">↦</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">ℰ</span> <span class="main">[</span>Rfork <span class="skolem">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fork<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> src<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="free">α</span> <span class="free">β</span> <span class="free">s</span> <span class="main">(</span><span class="free">α</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="skolem">σ</span><span class="main">,</span> ℛ<span class="hidden">⇩</span><sub>S</sub> <span class="free">α</span> <span class="free">β</span> <span class="skolem">τ</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="skolem">ℰ</span><span class="main">)</span> <span class="main">[</span>Rfork <span class="main">(</span><span class="keyword1">ℛ<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">α</span> <span class="free">β</span> <span class="skolem">e</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> s_r_as_upd<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_α<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> αr'_fresh src revision_step.fork fork<span class="main">(</span>1<span class="main">)</span> bij_α <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_α bij_β bijection.intro bijection.inv_left<span class="main">)</span>

<span class="keyword1" id="Determinacy-mimic_single_step"><span class="command">lemma</span></span> mimic_single_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>1</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">↝</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>1</sub>' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    bij_α<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="skolem">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    bij_β<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="skolem">β</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    R<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">α</span> <span class="skolem">β</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="skolem">r</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> mirrored_step<span class="main">:</span> <span class="quoted"><span class="quoted">"revision_step <span class="main">(</span><span class="skolem">α</span> <span class="skolem">r</span><span class="main">)</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">α</span> <span class="skolem">β</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> R bij_α bij_β step mimicking <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≈</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">α</span> <span class="skolem">β</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bij_α bij_β <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> s<span class="hidden">⇩</span><sub>1</sub>'s<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">↝</span> <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">α</span> <span class="skolem">β</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mirrored_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> eq s<span class="hidden">⇩</span><sub>1</sub>'s<span class="hidden">⇩</span><sub>2</sub>' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Determinacy-mimic_trans"><span class="command">lemma</span></span> mimic_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>_eq_s<span class="hidden">⇩</span><sub>1</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> s<span class="hidden">⇩</span><sub>1</sub>_eq_s<span class="hidden">⇩</span><sub>1</sub>' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    bij_α<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="skolem">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    bij_β<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="skolem">β</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    R<span class="main">:</span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">α</span> <span class="skolem">β</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rtrancl_power <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>_eq_s<span class="hidden">⇩</span><sub>1</sub>' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">↝</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_eq_x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≈</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="hidden">⇩</span><sub>1</sub>'x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.hyps n_steps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="hidden">⇩</span><sub>2</sub>_eq_s<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≈</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x's<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">↝</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> step mimic_single_step x_eq_x'<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>'x s<span class="hidden">⇩</span><sub>2</sub>_eq_s<span class="hidden">⇩</span><sub>2</sub>' trancl_into_rtrancl x's<span class="hidden">⇩</span><sub>2</sub>' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Strip diagram›</span></span>

<span class="keyword1" id="Determinacy-strip_lemma"><span class="command">lemma</span></span> strip_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>=</sup></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    lid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'l</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    rid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'r</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rtrancl_power <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> reach s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub>' <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> s<span class="hidden">⇩</span><sub>2</sub>s<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> s<span class="hidden">⇩</span><sub>2</sub>s<span class="hidden">⇩</span><sub>2</sub>' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> αβ_refl›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="hidden">⇩</span><sub>1</sub>a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> as<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> relpow_Suc_D2<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≈</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">↝<span class="hidden">⇧</span><sup>=</sup></span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">↝<span class="hidden">⇧</span><sup>=</sup></span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> SLC_top_relaxed Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> αβ_sym lid_inf rid_inf s<span class="hidden">⇩</span><sub>1</sub>a<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≈</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Suc.hyps Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">↝<span class="hidden">⇧</span><sup>=</sup></span> <span class="skolem">b</span>›</span></span> as<span class="hidden">⇩</span><sub>2</sub> reachability_closed_under_execution_step s<span class="hidden">⇩</span><sub>1</sub>a valid_stepE<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≈</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span>  <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≈</span> <span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">e</span>›</span></span> mimic_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≈</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> αβ_trans <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">≈</span> <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">≈</span> <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">↝<span class="hidden">⇧</span><sup>=</sup></span> <span class="skolem">c</span>›</span></span> r_into_rtrancl rtrancl_reflcl rtrancl_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Confluence diagram›</span></span>

<span class="keyword1" id="Determinacy-confluence_modulo_equivalence"><span class="command">lemma</span></span> confluence_modulo_equivalence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'r</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> global_state<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    lid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'l</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    rid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'r</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span><span class="main">.</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span> <span class="main">∧</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub> rtrancl_power <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> reach equiv s<span class="hidden">⇩</span><sub>1</sub>s<span class="hidden">⇩</span><sub>2</sub>' <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>2</sub>'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base<span class="main">:</span> 0
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≈</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> αβ_sym base.prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> mimic_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>''</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> αβ_sym <span class="quoted"><span class="quoted">‹<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≈</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>''</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> step<span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="hidden">⇩</span><sub>1</sub>a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">[↝]</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> as<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">↝</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reachability_closed_under_execution relpow_imp_rtrancl s<span class="hidden">⇩</span><sub>1</sub>a step.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≈</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s<span class="hidden">⇩</span><sub>1</sub>a step.hyps step.prems<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> as<span class="hidden">⇩</span><sub>2</sub> r_into_rtrancl<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">d</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> αβ_sym <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">b</span>›</span></span> <span class="quoted"><span class="quoted">‹reachable <span class="skolem">a</span>›</span></span> as<span class="hidden">⇩</span><sub>2</sub> lid_inf refl_rewritesI rid_inf strip_lemma<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s<span class="hidden">⇩</span><sub>3</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> αβ_trans <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≈</span> <span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="skolem">d</span>›</span></span> mimic_trans<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub>'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≈</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub>'</span>›</span></span> transD trans_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Determinacy›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> determinacy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    prog_expr<span class="main">:</span> <span class="quoted"><span class="quoted">"program_expr <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    e_terminates_in_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">↓</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    e_terminates_in_s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">↓</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    lid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'l</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    rid_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'r</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≈</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ε<span class="main">(</span><span class="skolem">r</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span>ε<span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> e_terminates_in_s execution_def maximal_execution_def terminates_in_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ε<span class="main">(</span><span class="skolem">r'</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span>ε<span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> e_terminates_in_s' execution_def maximal_execution_def terminates_in_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?α</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"id<span class="main">(</span><span class="skolem">r</span> <span class="main">:=</span> <span class="skolem">r'</span><span class="main">,</span> <span class="skolem">r'</span> <span class="main">:=</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> bij_α<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="var">?α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap_bij<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ε<span class="main">(</span><span class="skolem">r</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span>ε<span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span>ε<span class="main">(</span><span class="skolem">r'</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span>ε<span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_statesI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?α</span></span></span></span></span> <span class="quoted"><span class="quoted">id</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ℛ<span class="hidden">⇩</span><sub>G</sub> <span class="var">?α</span> id <span class="main">(</span>ε<span class="main">(</span><span class="skolem">r</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span> ε<span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ε<span class="main">(</span><span class="skolem">r'</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span> ε<span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bij_α prog_expr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_α<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>ε<span class="main">(</span><span class="skolem">r</span> <span class="main">↦</span> <span class="main">(</span>ε<span class="main">,</span>ε<span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> initial_state_reachable prog_expr<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span> <span class="main">≈</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">s'</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> confluence_modulo_equivalence<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x y equiv reach lid_inf rid_inf<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≈</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">a</span>›</span></span> e_terminates_in_s maximal_execution_def rtranclD terminates_in_def tranclD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="free">s'</span> <span class="main">↝<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">b</span>›</span></span> converse_rtranclE e_terminates_in_s' maximal_execution_def terminates_in_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≈</span> <span class="skolem">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="skolem">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s'</span> <span class="main">=</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* substitution locale *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>