<div id="Subsumption">
<div class="head">
<h1>Theory Subsumption</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Contexts and Subsumption›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory uses contexts to extend the idea of transition subsumption from \cite{lorenzoli2008} to
EFSM transitions with register update functions. The \emph{subsumption in context} relation is the
main contribution of \cite{foster2018}.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Subsumption
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../extended_finite_state_machines/theories/#EFSM">Extended_Finite_State_Machines.EFSM</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">posterior_separate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> vname gexp list <span class="main">⇒</span> update_function list <span class="main">⇒</span> inputs <span class="main">⇒</span> registers <span class="main">⇒</span> registers option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">posterior_separate</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> can_take <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>apply_updates <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span>join_ir <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">posterior</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> inputs <span class="main">⇒</span> registers <span class="main">⇒</span> registers option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">posterior</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> posterior_separate <span class="main">(</span>Arity <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subsumes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> registers <span class="main">⇒</span> transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subsumes</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span>Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span> Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
                       <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟶</span> can_take_transition <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">∧</span>
                       <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟶</span>
                            evaluate_outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> evaluate_outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">∧</span>
                       <span class="main">(</span><span class="main">∀</span><span class="bound">p1</span> <span class="bound">p2</span> <span class="bound">i</span><span class="main">.</span> posterior_separate <span class="main">(</span>Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="bound">p2</span> <span class="main">⟶</span>
                                  posterior_separate <span class="main">(</span>Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="bound">p1</span> <span class="main">⟶</span>
                                  <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p1</span> <span class="main">$</span> <span class="bound">r'</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">P</span> <span class="main">(</span><span class="bound">p2</span> <span class="main">$</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main">(</span><span class="bound">p1</span> <span class="main">$</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">)</span>"</span></span>

<span class="keyword1" id="Subsumption-no_functionality_subsumed"><span class="command">lemma</span></span> no_functionality_subsumed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Label <span class="free">t1</span> <span class="main">=</span> Label <span class="free">t2</span> <span class="main">⟹</span>
   Arity <span class="free">t1</span> <span class="main">=</span> Arity <span class="free">t2</span> <span class="main">⟹</span>
   <span class="main">∄</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t1</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">⟹</span>
   subsumes <span class="free">t2</span> <span class="free">c</span> <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def posterior_separate_def can_take_transition_def<span class="main">)</span>

<span class="keyword1" id="Subsumption-subsumes_updates"><span class="command">lemma</span></span> subsumes_updates<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subsumes <span class="free">t2</span> <span class="free">r</span> <span class="free">t1</span> <span class="main">⟹</span>
   can_take_transition <span class="free">t1</span> <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span>
   evaluate_updates <span class="free">t1</span> <span class="free">i</span> <span class="free">r</span> <span class="main">$</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span>
   evaluate_updates <span class="free">t2</span> <span class="free">i</span> <span class="free">r</span> <span class="main">$</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def posterior_separate_def can_take_transition_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"evaluate_updates <span class="free">t1</span> <span class="free">i</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"evaluate_updates <span class="free">t2</span> <span class="free">i</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_comm<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">P</span> <span class="bound">r'</span><span class="main">.</span>
            <span class="bound">P</span> <span class="main">(</span>evaluate_updates <span class="free">t2</span> <span class="free">i</span> <span class="free">r</span> <span class="main">$</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⟶</span> evaluate_updates <span class="free">t1</span> <span class="free">i</span> <span class="free">r</span> <span class="main">$</span> <span class="bound">r'</span> <span class="main">=</span> None <span class="main">∨</span> <span class="bound">P</span> <span class="main">(</span>evaluate_updates <span class="free">t1</span> <span class="free">i</span> <span class="free">r</span> <span class="main">$</span> <span class="bound">r'</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Subsumption-subsumption"><span class="command">lemma</span></span> subsumption<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Label <span class="free">t1</span> <span class="main">=</span> Label <span class="free">t2</span> <span class="main">∧</span> Arity <span class="free">t1</span> <span class="main">=</span> Arity <span class="free">t2</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t1</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">⟶</span> can_take_transition <span class="free">t2</span> <span class="bound">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t1</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">⟶</span>
        evaluate_outputs <span class="free">t1</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">=</span> evaluate_outputs <span class="free">t2</span> <span class="bound">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>

   <span class="main">(</span><span class="main">∀</span><span class="bound">p1</span> <span class="bound">p2</span> <span class="bound">i</span><span class="main">.</span> posterior_separate <span class="main">(</span>Arity <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free">t2</span><span class="main">)</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">=</span> Some <span class="bound">p2</span> <span class="main">⟶</span>
              posterior_separate <span class="main">(</span>Arity <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free">t1</span><span class="main">)</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">=</span> Some <span class="bound">p1</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p1</span> <span class="main">$</span> <span class="bound">r'</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">P</span> <span class="main">(</span><span class="bound">p2</span> <span class="main">$</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main">(</span><span class="bound">p1</span> <span class="main">$</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   subsumes <span class="free">t2</span> <span class="free">r</span> <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def<span class="main">)</span>

<span class="keyword1" id="Subsumption-bad_guards"><span class="command">lemma</span></span> bad_guards<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t1</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">∧</span> <span class="main">¬</span> can_take_transition <span class="free">t2</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">⟹</span>
   <span class="main">¬</span> subsumes <span class="free">t2</span> <span class="free">r</span> <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def<span class="main">)</span>

<span class="keyword1" id="Subsumption-inconsistent_updates"><span class="command">lemma</span></span> inconsistent_updates<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p2</span> <span class="bound">p1</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> posterior_separate <span class="main">(</span>Arity <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free">t2</span><span class="main">)</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">=</span> Some <span class="bound">p2</span> <span class="main">∧</span>
                posterior_separate <span class="main">(</span>Arity <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free">t1</span><span class="main">)</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">=</span> Some <span class="bound">p1</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∃</span><span class="bound">r'</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span><span class="bound">p2</span> <span class="main">$</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">p1</span> <span class="main">$</span> <span class="bound">r'</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">P</span> <span class="main">(</span><span class="bound">p1</span> <span class="main">$</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>

    <span class="main">¬</span> subsumes <span class="free">t2</span> <span class="free">r</span> <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> subsumes_def<span class="main">)</span>

<span class="keyword1" id="Subsumption-bad_outputs"><span class="command">lemma</span></span> bad_outputs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t1</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">∧</span> evaluate_outputs <span class="free">t1</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">≠</span> evaluate_outputs <span class="free">t2</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">⟹</span>
   <span class="main">¬</span> subsumes <span class="free">t2</span> <span class="free">r</span> <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def<span class="main">)</span>

<span class="keyword1" id="Subsumption-no_choice_no_subsumption"><span class="command">lemma</span></span> no_choice_no_subsumption<span class="main">:</span> <span class="quoted"><span class="quoted">"Label <span class="free">t</span> <span class="main">=</span> Label <span class="free">t'</span> <span class="main">⟹</span>
   Arity <span class="free">t</span> <span class="main">=</span> Arity <span class="free">t'</span> <span class="main">⟹</span>
   <span class="main">¬</span> choice <span class="free">t</span> <span class="free">t'</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t'</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">⟹</span>
  <span class="main">¬</span> subsumes <span class="free">t</span> <span class="free">c</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bad_guards can_take_def can_take_transition_def choice_def<span class="main">)</span>

<span class="keyword1" id="Subsumption-subsumption_def_alt"><span class="command">lemma</span></span> subsumption_def_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="free">t1</span> <span class="free">c</span> <span class="free">t2</span> <span class="main">=</span> <span class="main">(</span>Label <span class="free">t2</span> <span class="main">=</span> Label <span class="free">t1</span> <span class="main">∧</span>
    Arity <span class="free">t2</span> <span class="main">=</span> Arity <span class="free">t1</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t2</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">⟶</span> can_take_transition <span class="free">t1</span> <span class="bound">i</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t2</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">⟶</span> evaluate_outputs <span class="free">t2</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">=</span> evaluate_outputs <span class="free">t1</span> <span class="bound">i</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t2</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">⟶</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="bound">P</span><span class="main">.</span>
             <span class="bound">P</span> <span class="main">(</span>evaluate_updates <span class="free">t1</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">$</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⟶</span>
             evaluate_updates <span class="free">t2</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">$</span> <span class="bound">r'</span> <span class="main">=</span> None <span class="main">∨</span> <span class="bound">P</span> <span class="main">(</span>evaluate_updates <span class="free">t2</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">$</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def posterior_separate_def can_take_transition_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Subsumption-subsumes_update_equality"><span class="command">lemma</span></span> subsumes_update_equality<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subsumes <span class="free">t1</span> <span class="free">c</span> <span class="free">t2</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t2</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">⟶</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span><span class="main">.</span>
             <span class="main">(</span><span class="main">(</span>evaluate_updates <span class="free">t1</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">$</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>evaluate_updates <span class="free">t2</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">$</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
             evaluate_updates <span class="free">t2</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">$</span> <span class="bound">r'</span> <span class="main">=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumption_def_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i r' y
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{subsumptionReflexive}{1}{2}{%›</span></span>
<span class="keyword1" id="Subsumption-subsumes_reflexive"><span class="command">lemma</span></span> subsumes_reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="free">t</span> <span class="free">c</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹$\langle\isa{proof}\rangle$}%endsnip›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def<span class="main">)</span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{subsumptionTransitive}{1}{2}{%›</span></span>
<span class="keyword1" id="Subsumption-subsumes_transitive"><span class="command">lemma</span></span> subsumes_transitive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="free">t1</span> <span class="free">c</span> <span class="free">t2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"subsumes <span class="free">t2</span> <span class="free">c</span> <span class="free">t3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subsumes <span class="free">t1</span> <span class="free">c</span> <span class="free">t3</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
  <span class="keyword1"><span class="command">using</span></span> p1 p2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subsumes_update_equality p1 p2 can_take_transition_def option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.sel posterior_separate_def<span class="main">)</span>

<span class="keyword1" id="Subsumption-subsumes_possible_steps_replace"><span class="command">lemma</span></span> subsumes_possible_steps_replace<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s2'</span><span class="main">,</span> <span class="free">t2'</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e2</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">l</span> <span class="free">i</span> <span class="main">⟹</span>
   subsumes <span class="free">t2</span> <span class="free">r2</span> <span class="free">t1</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">(</span><span class="free">s2</span><span class="main">,</span> <span class="free">s2'</span><span class="main">)</span><span class="main">,</span> <span class="free">t2'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">ss2</span><span class="main">,</span> <span class="free">ss2'</span><span class="main">)</span><span class="main">,</span> <span class="free">t1</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">s2'</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="main">(</span>replace <span class="free">e2</span> <span class="main">(</span><span class="main">(</span><span class="free">ss2</span><span class="main">,</span> <span class="free">ss2'</span><span class="main">)</span><span class="main">,</span> <span class="free">t1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">ss2</span><span class="main">,</span> <span class="free">ss2'</span><span class="main">)</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="free">s2</span> <span class="free">r2</span> <span class="free">l</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_outgoing_transitions<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">e2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember_possible_steps subsumes_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> replace_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Direct Subsumption›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹When merging EFSM transitions, one must \emph{account for} the behaviour of the other. The
\emph{subsumption in context} relation formalises the intuition that, in certain contexts, a
transition $t_2$ reproduces the behaviour of, and updates the data state in a manner consistent
with, another transition $t_1$, meaning that $t_2$ can be used in place of $t_1$ with no observable
difference in behaviour.

The subsumption in context relation requires us to supply a context in which to test subsumption,
but there is a problem when we try to apply this to inference: Which context should we use? The
\emph{direct subsumption} relation works at EFSM level to determine when and whether one transition
is able to account for the behaviour of another such that we can use one in place of another without
adversely effecting observable behaviour.›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{directlySubsumes}{1}{2}{%›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">directly_subsumes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> cfstate <span class="main">⇒</span> transition <span class="main">⇒</span> transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">directly_subsumes</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c1</span> <span class="bound">c2</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span>obtains <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">c1</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">∧</span> obtains <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">c2</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> subsumes <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="bound">c2</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{subsumesAllContexts}{1}{2}{%›</span></span>
<span class="keyword1" id="Subsumption-subsumes_in_all_contexts_directly_subsumes"><span class="command">lemma</span></span> subsumes_in_all_contexts_directly_subsumes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> subsumes <span class="free">t2</span> <span class="bound">c</span> <span class="free">t1</span><span class="main">)</span> <span class="main">⟹</span> directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">t2</span> <span class="free">t1</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directly_subsumes_def<span class="main">)</span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{directSubsumption}{1}{2}{%›</span></span>
<span class="keyword1" id="Subsumption-direct_subsumption"><span class="command">lemma</span></span> direct_subsumption<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span> <span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> obtains <span class="free">s1</span> <span class="bound">c1</span> <span class="free">e1</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">⟹</span> obtains <span class="free">s2</span> <span class="bound">c2</span> <span class="free">e2</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">c2</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">f</span> <span class="bound">c</span> <span class="main">⟹</span> subsumes <span class="free">t1</span> <span class="bound">c</span> <span class="free">t2</span><span class="main">)</span> <span class="main">⟹</span>
   directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
   <span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directly_subsumes_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{obtainableNoSubsumption}{1}{2}{%›</span></span>
<span class="keyword1" id="Subsumption-visits_and_not_subsumes"><span class="command">lemma</span></span> visits_and_not_subsumes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span> <span class="bound">t</span><span class="main">.</span> obtains <span class="free">s1</span> <span class="bound">c1</span> <span class="free">e1</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">∧</span> obtains <span class="free">s2</span> <span class="bound">c2</span> <span class="free">e2</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">¬</span> subsumes <span class="free">t1</span> <span class="bound">c2</span> <span class="free">t2</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">¬</span> directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directly_subsumes_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{directSubsumptionReflexive}{1}{2}{%›</span></span>
<span class="keyword1" id="Subsumption-directly_subsumes_reflexive"><span class="command">lemma</span></span> directly_subsumes_reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directly_subsumes_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_reflexive<span class="main">)</span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\snip{directSubsumptionTransitive}{1}{2}{%›</span></span>
<span class="keyword1" id="Subsumption-directly_subsumes_transitive"><span class="command">lemma</span></span> directly_subsumes_transitive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t2</span> <span class="free">t3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t1</span> <span class="free">t3</span>"</span></span>
  <span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹}%endsnip›</span></span>
  <span class="keyword1"><span class="command">using</span></span> p1 p2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directly_subsumes_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> subsumes_transitive <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Drinks_Subsumption">
<div class="head">
<h1>Theory Drinks_Subsumption</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Example›</span></span> 
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory shows how contexts can be used to prove transition subsumption.›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Drinks_Subsumption
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Subsumption">Extended_Finite_State_Machine_Inference.Subsumption</a>"</span> <span class="quoted">"<a href="../../extended_finite_state_machines/theories/#Drinks_Machine_2">Extended_Finite_State_Machines.Drinks_Machine_2</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Drinks_Subsumption-stop_at_3"><span class="command">lemma</span></span> stop_at_3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>obtains <span class="main">1</span> <span class="free">c</span> drinks2 <span class="numeral">3</span> <span class="free">r</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_possible_steps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Drinks_Subsumption-no_1_2"><span class="command">lemma</span></span> no_1_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>obtains <span class="main">1</span> <span class="free">c</span> drinks2 <span class="numeral">2</span> <span class="free">r</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_possible_steps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stop_at_3<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Drinks_Subsumption-no_change_1_1"><span class="command">lemma</span></span> no_change_1_1<span class="main">:</span> <span class="quoted"><span class="quoted">"obtains <span class="main">1</span> <span class="free">c</span> drinks2 <span class="main">1</span> <span class="free">r</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_possible_steps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vend_nothing_def apply_updates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_1_2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Drinks_Subsumption-obtains_1"><span class="command">lemma</span></span> obtains_1<span class="main">:</span> <span class="quoted"><span class="quoted">"obtains <span class="main">1</span> <span class="free">c</span> drinks2 <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_possible_steps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> select_def can_take apply_updates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> no_change_1_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Drinks_Subsumption-obtains_1_1_2"><span class="command">lemma</span></span> obtains_1_1_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"obtains <span class="main">1</span> <span class="free">c1</span> drinks2 <span class="main">1</span> <span class="free">r</span> <span class="free">t</span> <span class="main">⟹</span>
   obtains <span class="main">1</span> <span class="free">c2</span> drinks <span class="main">1</span> <span class="free">r</span> <span class="free">t</span> <span class="main">⟹</span>
   <span class="free">c1</span> <span class="main">=</span> <span class="free">r</span> <span class="main">∧</span> <span class="free">c2</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_possible_steps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_def drinks_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> drinks_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> no_change_1_1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coin_def vend_nothing_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> no_change_1_1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vend_fail_def vend_nothing_def apply_updates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> no_change_1_1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> drinks_rejects_future numeral_eq_one_iff obtains.cases obtains_recognises semiring_norm<span class="main"><span class="main">(</span></span>85<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> no_1_2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> no_1_2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> no_change_1_1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> no_1_2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> no_1_2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> no_1_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Drinks_Subsumption-obtains_1_c2"><span class="command">lemma</span></span> obtains_1_c2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"obtains <span class="main">1</span> <span class="free">c1</span> drinks2 <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free">t</span> <span class="main">⟹</span> obtains <span class="main">1</span> <span class="free">c2</span> drinks <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">c2</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> Some <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_possible_steps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_def drinks_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drinks2_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> drinks_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> select_def can_take apply_updates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> obtains_1_1_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Drinks_Subsumption-directly_subsumes"><span class="command">lemma</span></span> directly_subsumes<span class="main">:</span> <span class="quoted"><span class="quoted">"directly_subsumes drinks2 drinks <span class="main">1</span> <span class="main">1</span> vend_fail vend_nothing"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> direct_subsumption<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">c2</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">c2</span></span> <span class="main"><span class="main">$</span></span> <span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">=</span></span> Some <span class="main"><span class="main">(</span></span>Num <span class="main"><span class="main">0</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_1_c2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsumption<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vend_fail_def vend_nothing_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vend_fail_def vend_nothing_def can_take value_gt_true<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vend_fail_def vend_nothing_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> posterior_separate_def vend_fail_def vend_nothing_def<span class="main">)</span>

<span class="keyword1" id="Drinks_Subsumption-directly_subsumes_flip"><span class="command">lemma</span></span> directly_subsumes_flip<span class="main">:</span> <span class="quoted"><span class="quoted">"directly_subsumes drinks2 drinks <span class="main">1</span> <span class="main">1</span> vend_nothing vend_fail"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> direct_subsumption<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">c2</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">c2</span></span> <span class="main"><span class="main">$</span></span> <span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">=</span></span> Some <span class="main"><span class="main">(</span></span>Num <span class="main"><span class="main">0</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_1_c2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsumption<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vend_fail_def vend_nothing_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vend_fail_def vend_nothing_def can_take value_gt_true<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vend_fail_def vend_nothing_def can_take value_gt_true<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> posterior_separate_def vend_fail_def vend_nothing_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Inference">
<div class="head">
<h1>Theory Inference</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span><span class="quoted"><span class="plain_text">‹EFSM Inference›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This chapter presents the definitions necessary for EFSM inference by state-merging.›</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Inference by State-Merging›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory sets out the key definitions for the inference of EFSMs from system traces.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Inference
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#Subsumption">Subsumption</a>
    <span class="quoted">"<a href="../../extended_finite_state_machines/theories/#Transition_Lexorder">Extended_Finite_State_Machines.Transition_Lexorder</a>"</span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Product_Lexorder.html">HOL-Library.Product_Lexorder</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> One_nat_def <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Transition Identifiers›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We first need to define the \texttt{iEFSM} data type which assigns each transition a unique identity.
This is necessary because transitions may not occur uniquely in an EFSM. Assigning transitions a unique
identifier enables us to look up the origin and destination states of transitions without having to
pass them around in the inference functions.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> tid <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> tids <span class="main">=</span> <span class="quoted"><span class="quoted">"tid list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> iEFSM <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tids <span class="main">×</span> <span class="main">(</span>cfstate <span class="main">×</span> cfstate<span class="main">)</span> <span class="main">×</span> transition<span class="main">)</span> fset"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">origin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tids <span class="main">⇒</span> iEFSM <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">origin</span> <span class="free"><span class="bound"><span class="entity">uid</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> fst <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>fthe_elem <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> set <span class="free"><span class="bound"><span class="entity">uid</span></span></span> <span class="main">⊆</span> set <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tids <span class="main">⇒</span> iEFSM <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dest</span> <span class="free"><span class="bound"><span class="entity">uid</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> snd <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>fthe_elem <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> set <span class="free"><span class="bound"><span class="entity">uid</span></span></span> <span class="main">⊆</span> set <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_by_id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> tid <span class="main">⇒</span> transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_by_id</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">uid</span></span></span> <span class="main">=</span> <span class="main">(</span>snd <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>fthe_elem <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tids</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">uid</span></span></span> <span class="main">∈</span> set <span class="bound">tids</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_by_ids</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> tids <span class="main">⇒</span> transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_by_ids</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">uid</span></span></span> <span class="main">=</span> <span class="main">(</span>snd <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>fthe_elem <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tids</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> set <span class="free"><span class="bound"><span class="entity">uid</span></span></span> <span class="main">⊆</span> set <span class="bound">tids</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">uids</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nat fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uids</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> ffUnion <span class="main">(</span>fimage <span class="main">(</span>fset_of_list <span class="main">∘</span> fst<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_uid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_uid</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">uids</span> <span class="main">=</span> uids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">uids</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>fMax <span class="bound">uids</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> transition_matrix"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tm</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> fimage snd <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_regs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">all_regs</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> EFSM.all_regs <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_reg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_reg</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> EFSM.max_reg <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">max_reg_total</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> max_reg <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">r</span> <span class="main">⇒</span> <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_output</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_output</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> EFSM.max_output <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_int</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> EFSM.max_int <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nat fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">|∪|</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">s'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1" id="Inference-S_alt"><span class="command">lemma</span></span> S_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="free">t</span> <span class="main">=</span> EFSM.S <span class="main">(</span>tm <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def EFSM.S_def tm_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Inference-to_in_S"><span class="command">lemma</span></span> to_in_S<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">to</span> <span class="bound">from</span> <span class="bound">uid</span><span class="main">.</span> <span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">xb</span> <span class="main">⟶</span> <span class="bound">to</span> <span class="main">|∈|</span> S <span class="free">xb</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Inference-from_in_S"><span class="command">lemma</span></span> from_in_S<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">to</span> <span class="bound">from</span> <span class="bound">uid</span><span class="main">.</span> <span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">xb</span> <span class="main">⟶</span> <span class="bound">from</span> <span class="main">|∈|</span> S <span class="free">xb</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Building the PTA›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The first step in EFSM inference is to construct a PTA from the observed traces in the same way
as for classical FSM inference. Beginning with the empty EFSM, we iteratively attempt to walk each
observed trace in the model. When we reach a point where there is no available transition, one is
added. For classical FSMs, this is simply an atomic label. EFSMs deal with data, so we need to add
guards which test for the observed input values and outputs which produce the observed values.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">make_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value list <span class="main">⇒</span> nat <span class="main">⇒</span> vname gexp list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">make_guard</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">make_guard</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span>gexp.Eq <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">make_guard</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">make_outputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value list <span class="main">⇒</span> output_function list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">make_outputs</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">make_outputs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">make_outputs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_uid_total</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_uid_total</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> max_uid <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">u</span> <span class="main">⇒</span> <span class="bound">u</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> label <span class="main">⇒</span> value list <span class="main">⇒</span> value list <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_transition</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">label</span></span></span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="free"><span class="bound"><span class="entity">outputs</span></span></span> <span class="main">=</span> finsert <span class="main">(</span><span class="main">[</span>max_uid_total <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="main">(</span>maxS <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">⦇</span>Label<span class="main">=</span><span class="free"><span class="bound"><span class="entity">label</span></span></span><span class="main">,</span> Arity<span class="main">=</span>length <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">,</span> Guards<span class="main">=</span><span class="main">(</span>make_guard <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> Outputs<span class="main">=</span><span class="main">(</span>make_outputs <span class="free"><span class="bound"><span class="entity">outputs</span></span></span><span class="main">)</span><span class="main">,</span> Updates<span class="main">=</span><span class="main">[]</span><span class="main">⦈</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">make_branch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> trace <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">make_branch</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">make_branch</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">label</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">outputs</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>step <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">label</span></span></span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      Some <span class="main">(</span><span class="bound">transition</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">outputs'</span><span class="main">,</span> <span class="bound">updated</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">if</span> <span class="bound">outputs'</span> <span class="main">=</span> <span class="main">(</span>map Some <span class="free"><span class="bound"><span class="entity">outputs</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
          <span class="free">make_branch</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="bound">updated</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
        <span class="keyword1">else</span>
          <span class="free">make_branch</span> <span class="main">(</span>add_transition <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">label</span></span></span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="free"><span class="bound"><span class="entity">outputs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>maxS <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>  <span class="main">|</span>
      None <span class="main">⇒</span>
          <span class="free">make_branch</span> <span class="main">(</span>add_transition <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">label</span></span></span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="free"><span class="bound"><span class="entity">outputs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>maxS <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">make_pta_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"log <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">make_pta_aux</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">make_pta_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">make_pta_aux</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>make_branch <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">make_pta</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="main">=</span> make_pta_aux <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="main">{||}</span>"</span></span>

<span class="keyword1" id="Inference-make_pta_aux_fold"><span class="command">lemma</span></span> make_pta_aux_fold <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"make_pta_aux <span class="free">l</span> <span class="free">e</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">h</span> <span class="bound">e</span><span class="main">.</span> make_branch <span class="bound">e</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">h</span><span class="main">)</span> <span class="free">l</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Integrating Heuristics›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A key contribution of the inference technique presented in \cite{foster2019} is the ability to
introduce \emph{internal variables} to the model to generalise behaviours and allow transitions to
be merged. This is done by providing the inference technique with a set of \emph{heuristics}. The
aim here is not to create a ``one size fits all'' magic oracle, rather to recognise particular
\emph{data usage patterns} which can be abstracted.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> update_modifier <span class="main">=</span> <span class="quoted"><span class="quoted">"tids <span class="main">⇒</span> tids <span class="main">⇒</span> cfstate <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM <span class="main">⇒</span> <span class="main">(</span>transition_matrix <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> iEFSM option"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">null_modifier</span> <span class="main">::</span> <span class="quoted">update_modifier</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">null_modifier</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">replace_transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> tids <span class="main">⇒</span> transition <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replace_transition</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">uid</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">=</span> <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uids</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> set <span class="free"><span class="bound"><span class="entity">uid</span></span></span> <span class="main">⊆</span> set <span class="bound">uids</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">uids</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">new</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">uids</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">replace_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> tids list <span class="main">⇒</span> transition <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replace_all</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ids</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">id</span> <span class="bound">acc</span><span class="main">.</span> replace_transition <span class="bound">acc</span> <span class="bound">id</span> <span class="free"><span class="bound"><span class="entity">new</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ids</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">replace_transitions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> <span class="main">(</span>tids <span class="main">×</span> transition<span class="main">)</span> list <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replace_transitions</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="bound">new</span><span class="main">)</span> <span class="bound">acc</span><span class="main">.</span> replace_transition <span class="bound">acc</span> <span class="bound">uid</span> <span class="bound">new</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">try_heuristics_check</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transition_matrix <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> update_modifier list <span class="main">⇒</span> update_modifier"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">try_heuristics_check</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> null_modifier"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">try_heuristics_check</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">f</span> <span class="bound">ch</span><span class="main">.</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">f</span> <span class="bound">ch</span> <span class="keyword1">of</span>
      Some <span class="bound">e'</span> <span class="main">⇒</span> Some <span class="bound">e'</span> <span class="main">|</span>
      None <span class="main">⇒</span> <span class="main">(</span><span class="free">try_heuristics_check</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">f</span> <span class="bound">ch</span>
    <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Scoring State Merges›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹To tackle the state merging challenge, we need some means of determining which states are
compatible for merging. Because states are merged pairwise, we additionally require a way of
ordering the state merges. The potential merges are then sorted highest to lowest according to this
score such that we can merge states in order of their merge score.

We want to sort first by score (highest to lowest) and then by state pairs (lowest to highest) so we
endup merging the states with the highest scores first and then break ties by those state pairs
which are closest to the origin.›</span></span>

<span class="keyword1"><span class="command">record</span></span> score <span class="main">=</span>
  Score <span class="main">::</span> <span class="quoted">nat</span>
  S1 <span class="main">::</span> <span class="quoted">cfstate</span>
  S2 <span class="main">::</span> <span class="quoted">cfstate</span>

<span class="keyword1"><span class="command">instantiation</span></span> score_ext <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_score_ext</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder score_ext <span class="main">⇒</span> <span class="tfree">'a</span> score_ext <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">less_score_ext</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Score <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">,</span> S1 <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> S2 <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> more <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>Score <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> S1 <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">,</span> S2 <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">,</span> more <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_score_ext</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder score_ext <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder score_ext <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">less_eq_score_ext</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 5
  <span class="keyword1"><span class="command">unfolding</span></span> less_score_ext_def less_eq_score_ext_def
  <span class="keyword1"><span class="command">using</span></span> score.equality <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> scoreboard <span class="main">=</span> <span class="quoted"><span class="quoted">"score fset"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> strategy <span class="main">=</span> <span class="quoted"><span class="quoted">"tids <span class="main">⇒</span> tids <span class="main">⇒</span> iEFSM <span class="main">⇒</span> nat"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">outgoing_transitions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cfstate <span class="main">⇒</span> iEFSM <span class="main">⇒</span> <span class="main">(</span>cfstate <span class="main">×</span> transition <span class="main">×</span> tids<span class="main">)</span> fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">outgoing_transitions</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">to</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">uid</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">paths_of_length</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> tids list fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">paths_of_length</span> <span class="main">0</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{|</span><span class="main">[]</span><span class="main">|}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">paths_of_length</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">outgoing</span> <span class="main">=</span> outgoing_transitions <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
      <span class="bound">paths</span> <span class="main">=</span> ffUnion <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">id</span><span class="main">)</span><span class="main">.</span> fimage <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">id</span><span class="main">#</span><span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">paths_of_length</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="bound">outgoing</span><span class="main">)</span>
    <span class="keyword1">in</span>
      ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="bound">paths</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="Inference-paths_of_length_1"><span class="command">lemma</span></span> paths_of_length_1<span class="main">:</span> <span class="quoted"><span class="quoted">"paths_of_length <span class="main">1</span> <span class="free">e</span> <span class="free">s</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">id</span><span class="main">)</span><span class="main">.</span> <span class="main">[</span><span class="bound">id</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>outgoing_transitions <span class="free">s</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> One_nat_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> outgoing_transitions_def comp_def One_nat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBall_ffilter2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffilter_def ffUnion_def fBall_def Abs_fset_inverse<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffilter_def ffUnion_def fBall_def Abs_fset_inverse fset_both_sides<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">step_score</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tids <span class="main">×</span> tids<span class="main">)</span> list <span class="main">⇒</span> iEFSM <span class="main">⇒</span> strategy <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">step_score</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">step_score</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">id1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">id2</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">score</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">id1</span></span></span> <span class="free"><span class="bound"><span class="entity">id2</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">score</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span>
      <span class="main">0</span>
    <span class="keyword1">else</span>
      <span class="bound">score</span> <span class="main">+</span> <span class="main">(</span><span class="free">step_score</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="Inference-step_score_foldr"><span class="command">lemma</span></span> step_score_foldr <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"step_score <span class="free">xs</span> <span class="free">e</span> <span class="free">s</span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">id1</span><span class="main">,</span> <span class="bound">id2</span><span class="main">)</span> <span class="bound">acc</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">score</span> <span class="main">=</span> <span class="free">s</span> <span class="bound">id1</span> <span class="bound">id2</span> <span class="free">e</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">score</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span>
      <span class="main">0</span>
    <span class="keyword1">else</span>
      <span class="bound">score</span> <span class="main">+</span> <span class="bound">acc</span><span class="main">)</span> <span class="free">xs</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">score_from_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tids list fset <span class="main">⇒</span> tids list fset <span class="main">⇒</span> iEFSM <span class="main">⇒</span> strategy <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">score_from_list</span> <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">pairs</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">l2</span><span class="main">)</span><span class="main">.</span> zip <span class="bound">l1</span> <span class="bound">l2</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="main">|×|</span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">scored_pairs</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> step_score <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">pairs</span>
    <span class="keyword1">in</span>
    fSum <span class="bound">scored_pairs</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">k_score</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> iEFSM <span class="main">⇒</span> strategy <span class="main">⇒</span> scoreboard"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k_score</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">strat</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">states</span> <span class="main">=</span> S <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
      <span class="bound">pairs_to_score</span> <span class="main">=</span> <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="bound">states</span> <span class="main">|×|</span> <span class="bound">states</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">paths</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">,</span> paths_of_length <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s1</span><span class="main">,</span> paths_of_length <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="bound">pairs_to_score</span><span class="main">;</span>
      <span class="bound">scores</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">,</span> <span class="bound">p1</span><span class="main">,</span> <span class="bound">p2</span><span class="main">)</span><span class="main">.</span> <span class="main">⦇</span>Score <span class="main">=</span> score_from_list <span class="bound">p1</span> <span class="bound">p2</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">strat</span></span></span><span class="main">,</span> S1 <span class="main">=</span> <span class="bound">s1</span><span class="main">,</span> S2 <span class="main">=</span> <span class="bound">s2</span><span class="main">⦈</span><span class="main">)</span> <span class="bound">paths</span>
    <span class="keyword1">in</span>
    ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Score <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="bound">scores</span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">score_state_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"strategy <span class="main">⇒</span> iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> cfstate <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">score_state_pair</span> <span class="free"><span class="bound"><span class="entity">strat</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">T1</span> <span class="main">=</span> outgoing_transitions <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
      <span class="bound">T2</span> <span class="main">=</span> outgoing_transitions <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
    <span class="keyword1">in</span>
      fSum <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">strat</span></span></span> <span class="bound">t1</span> <span class="bound">t2</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">T1</span> <span class="main">|×|</span> <span class="bound">T2</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">score_1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> strategy <span class="main">⇒</span> scoreboard"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">score_1</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">strat</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">states</span> <span class="main">=</span> S <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
      <span class="bound">pairs_to_score</span> <span class="main">=</span> <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="bound">states</span> <span class="main">|×|</span> <span class="bound">states</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">scores</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="main">⦇</span>Score <span class="main">=</span> score_state_pair <span class="free"><span class="bound"><span class="entity">strat</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">,</span> S1 <span class="main">=</span> <span class="bound">s1</span><span class="main">,</span> S2 <span class="main">=</span> <span class="bound">s2</span><span class="main">⦈</span><span class="main">)</span> <span class="bound">pairs_to_score</span>
    <span class="keyword1">in</span>
      ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Score <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="bound">scores</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="Inference-score_1"><span class="command">lemma</span></span> score_1<span class="main">:</span> <span class="quoted"><span class="quoted">"score_1 <span class="free">e</span> <span class="free">s</span> <span class="main">=</span> k_score <span class="main">1</span> <span class="free">e</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fprod_fimage<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">id</span><span class="main">)</span><span class="main">.</span> <span class="main">[</span><span class="bound">id</span><span class="main">]</span><span class="main">)</span> <span class="main">|`|</span> <span class="bound">a</span> <span class="main">|×|</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">id</span><span class="main">)</span><span class="main">.</span> <span class="main">[</span><span class="bound">id</span><span class="main">]</span><span class="main">)</span> <span class="main">|`|</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span>
       fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">id1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">id2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">[</span><span class="bound">id1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="bound">id2</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">|×|</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fimage_def fprod_def Abs_fset_inverse fset_both_sides<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> score_1_def k_score_def Let_def comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"ffilter <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">0</span></span> <span class="main"><span class="main">&lt;</span></span> Score <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>Inference.S <span class="free"><span class="free">e</span></span> <span class="main"><span class="main">|×|</span></span> Inference.S <span class="free"><span class="free">e</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"ffilter <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">a</span></span><span class="main"><span class="main">.</span></span> <span class="keyword1"><span class="keyword1">case</span></span> <span class="bound"><span class="bound">a</span></span> <span class="keyword1"><span class="keyword1">of</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">a</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">b</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⇒</span></span> <span class="bound"><span class="bound">a</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="bound"><span class="bound">b</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">fimage</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paths_of_length_1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> score_state_pair_def Let_def score_from_list_def comp_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">fSum</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fprod_fimage<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>outgoing_transitions <span class="skolem"><span class="skolem">a</span></span> <span class="free"><span class="free">e</span></span> <span class="main"><span class="main">|×|</span></span> outgoing_transitions <span class="skolem"><span class="skolem">b</span></span> <span class="free"><span class="free">e</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">fimage</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bool2nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bool2nat</span> True <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bool2nat</span> False <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">score_transitions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">score_transitions</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span> Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span> length <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
      <span class="main">1</span> <span class="main">+</span> bool2nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="main">(</span>set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="main">(</span>set <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>set <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="main">(</span>set <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>set <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">0</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Merging States›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_states_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_states_aux</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">origin</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="keyword1">else</span> <span class="bound">origin</span> <span class="main">,</span> <span class="keyword1">if</span> <span class="bound">dest</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="keyword1">else</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_states</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_states</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> merge_states_aux <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> merge_states_aux <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Inference-merge_states_symmetry"><span class="command">lemma</span></span> merge_states_symmetry<span class="main">:</span> <span class="quoted"><span class="quoted">"merge_states <span class="free">x</span> <span class="free">y</span> <span class="free">t</span> <span class="main">=</span> merge_states <span class="free">y</span> <span class="free">x</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_states_def<span class="main">)</span>

<span class="keyword1" id="Inference-merge_state_self"><span class="command">lemma</span></span> merge_state_self<span class="main">:</span> <span class="quoted"><span class="quoted">"merge_states <span class="free">s</span> <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_states_def merge_states_aux_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Inference-merge_states_self_simp"><span class="command">lemma</span></span> merge_states_self_simp <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"merge_states <span class="free">x</span> <span class="free">y</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="free">t</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">y</span> <span class="keyword1">then</span> merge_states_aux <span class="free">x</span> <span class="free">y</span> <span class="free">t</span> <span class="keyword1">else</span> merge_states_aux <span class="free">y</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_states_def merge_states_aux_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Resolving Nondeterminism›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Because EFSM transitions are not simply atomic actions, duplicated behaviours cannot be
resolved into a single transition by simply merging destination states, as it can in classical FSM
inference. It is now possible for attempts to resolve the nondeterminism introduced by merging
states to fail, meaning that two states which initially seemed compatible cannot actually be merged.
This is not the case in classical FSM inference.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> nondeterministic_pair <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cfstate <span class="main">×</span> <span class="main">(</span>cfstate <span class="main">×</span> cfstate<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span>transition <span class="main">×</span> tids<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>transition <span class="main">×</span> tids<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">state_nondeterminism</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>cfstate <span class="main">×</span> transition <span class="main">×</span> tids<span class="main">)</span> fset <span class="main">⇒</span> nondeterministic_pair fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">state_nondeterminism</span> <span class="free"><span class="bound"><span class="entity">og</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> size <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">{||}</span> <span class="keyword1">else</span> ffUnion <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">dest</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span> <span class="keyword1">in</span> fimage <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">dest'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">og</span></span></span><span class="main">,</span> <span class="main">(</span><span class="bound">dest</span><span class="main">,</span> <span class="bound">dest'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="main">{|</span><span class="bound">x</span><span class="main">|}</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Inference-state_nondeterminism_empty"><span class="command">lemma</span></span> state_nondeterminism_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"state_nondeterminism <span class="free">a</span> <span class="main">{||}</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_nondeterminism_def ffilter_def Set.filter_def<span class="main">)</span>

<span class="keyword1" id="Inference-state_nondeterminism_singledestn"><span class="command">lemma</span></span> state_nondeterminism_singledestn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"state_nondeterminism <span class="free">a</span> <span class="main">{|</span><span class="free">x</span><span class="main">|}</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_nondeterminism_def ffilter_def Set.filter_def<span class="main">)</span>

<span class="comment1">(* For each state, get its outgoing transitions and see if there's any nondeterminism there *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nondeterministic_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nondeterministic_pair fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nondeterministic_pairs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> Label <span class="bound">t</span> <span class="main">=</span> Label <span class="bound">t'</span> <span class="main">∧</span> Arity <span class="bound">t</span> <span class="main">=</span> Arity <span class="bound">t'</span> <span class="main">∧</span> choice <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">(</span>ffUnion <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> state_nondeterminism <span class="bound">s</span> <span class="main">(</span>outgoing_transitions <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nondeterministic_pairs_labar_dest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nondeterministic_pair fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nondeterministic_pairs_labar_dest</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> ffilter
     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">d'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
      Label <span class="bound">t</span> <span class="main">=</span> Label <span class="bound">t'</span> <span class="main">∧</span> Arity <span class="bound">t</span> <span class="main">=</span> Arity <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span>choice <span class="bound">t</span> <span class="bound">t'</span> <span class="main">∨</span> <span class="main">(</span>Outputs <span class="bound">t</span> <span class="main">=</span> Outputs <span class="bound">t'</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">=</span> <span class="bound">d'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>ffUnion <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> state_nondeterminism <span class="bound">s</span> <span class="main">(</span>outgoing_transitions <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nondeterministic_pairs_labar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nondeterministic_pair fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nondeterministic_pairs_labar</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> ffilter
     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">d'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
      Label <span class="bound">t</span> <span class="main">=</span> Label <span class="bound">t'</span> <span class="main">∧</span> Arity <span class="bound">t</span> <span class="main">=</span> Arity <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span>choice <span class="bound">t</span> <span class="bound">t'</span> <span class="main">∨</span> Outputs <span class="bound">t</span> <span class="main">=</span> Outputs <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>ffUnion <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> state_nondeterminism <span class="bound">s</span> <span class="main">(</span>outgoing_transitions <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">deterministic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> <span class="main">(</span>iEFSM <span class="main">⇒</span> nondeterministic_pair fset<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deterministic</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nondeterministic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> <span class="main">(</span>iEFSM <span class="main">⇒</span> nondeterministic_pair fset<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nondeterministic</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> deterministic <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert_transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tids <span class="main">⇒</span> cfstate <span class="main">⇒</span> cfstate <span class="main">⇒</span> transition <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_transition</span> <span class="free"><span class="bound"><span class="entity">uid</span></span></span> <span class="free"><span class="bound"><span class="entity">from</span></span></span> <span class="free"><span class="bound"><span class="entity">to</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="main">∄</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from'</span><span class="main">,</span> <span class="bound">to'</span><span class="main">)</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">from</span></span></span> <span class="main">=</span> <span class="bound">from'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">to</span></span></span> <span class="main">=</span> <span class="bound">to'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="bound">t'</span> <span class="keyword1">then</span>
      finsert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">uid</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">from</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">to</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
    <span class="keyword1">else</span>
      fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid'</span><span class="main">,</span> <span class="main">(</span><span class="bound">from'</span><span class="main">,</span> <span class="bound">to'</span><span class="main">)</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">from</span></span></span> <span class="main">=</span> <span class="bound">from'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">to</span></span></span> <span class="main">=</span> <span class="bound">to'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="bound">t'</span> <span class="keyword1">then</span>
          <span class="main">(</span>List.union <span class="bound">uid'</span> <span class="free"><span class="bound"><span class="entity">uid</span></span></span><span class="main">,</span> <span class="main">(</span><span class="bound">from'</span><span class="main">,</span> <span class="bound">to'</span><span class="main">)</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="main">(</span><span class="bound">uid'</span><span class="main">,</span> <span class="main">(</span><span class="bound">from'</span><span class="main">,</span> <span class="bound">to'</span><span class="main">)</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span>
      <span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">make_distinct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">make_distinct</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> ffold_ord <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">acc</span><span class="main">.</span> insert_transition <span class="bound">uid</span> <span class="bound">from</span> <span class="bound">to</span> <span class="bound">t</span> <span class="bound">acc</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{||}</span>"</span></span>

<span class="comment1">― ‹When we replace one transition with another, we need to merge their uids to keep track of which›</span>
<span class="comment1">― ‹transition accounts for which action in the original traces                                     ›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_transitions_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> tids <span class="main">⇒</span> tids <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_transitions_aux</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">oldID</span></span></span> <span class="free"><span class="bound"><span class="entity">newID</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
    <span class="main">(</span><span class="bound">uids1</span><span class="main">,</span> <span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">old</span><span class="main">)</span> <span class="main">=</span> fthe_elem <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uids</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">oldID</span></span></span> <span class="main">=</span> <span class="bound">uids</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">uids2</span><span class="main">,</span> <span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">new</span><span class="main">)</span> <span class="main">=</span> fthe_elem <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uids</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">newID</span></span></span> <span class="main">=</span> <span class="bound">uids</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    make_distinct <span class="main">(</span>finsert <span class="main">(</span>List.union <span class="bound">uids1</span> <span class="bound">uids2</span><span class="main">,</span> <span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">new</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">-</span> <span class="main">{|</span><span class="main">(</span><span class="bound">uids1</span><span class="main">,</span> <span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">old</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">uids2</span><span class="main">,</span> <span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">new</span><span class="main">)</span><span class="main">|}</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="comment1">(* merge_transitions - Try dest merge transitions t1 and t2 dest help resolve nondeterminism in
                       newEFSM. If either subsumes the other directly then the subsumed transition
                       can simply be replaced with the subsuming one, else we try dest apply the
                       modifier function dest resolve nondeterminism that way.                    *)</span>
<span class="comment1">(* @param oldEFSM   - the EFSM before merging the states which caused the nondeterminism          *)</span>
<span class="comment1">(* @param preDestMerge   - the EFSM after merging the states which caused the nondeterminism      *)</span>
<span class="comment1">(* @param newEFSM   - the current EFSM with nondeterminism                                        *)</span>
<span class="comment1">(* @param t1        - a transition dest be merged with t2                                         *)</span>
<span class="comment1">(* @param u1        - the unique identifier of t1                                                 *)</span>
<span class="comment1">(* @param t2        - a transition dest be merged with t1                                         *)</span>
<span class="comment1">(* @param u2        - the unique identifier of t2                                                 *)</span>
<span class="comment1">(* @param modifier  - an update modifier function which tries dest generalise transitions         *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_transitions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cfstate <span class="main">×</span> cfstate<span class="main">)</span> set <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM <span class="main">⇒</span> transition <span class="main">⇒</span> tids <span class="main">⇒</span> transition <span class="main">⇒</span> tids <span class="main">⇒</span> update_modifier <span class="main">⇒</span> <span class="main">(</span>transition_matrix <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> iEFSM option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_transitions</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="free"><span class="bound"><span class="entity">oldEFSM</span></span></span> <span class="free"><span class="bound"><span class="entity">preDestMerge</span></span></span> <span class="free"><span class="bound"><span class="entity">destMerge</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span> <span class="free"><span class="bound"><span class="entity">modifier</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">if</span> <span class="main">∀</span><span class="bound">id</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">u1</span></span></span><span class="main">.</span> directly_subsumes <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">oldEFSM</span></span></span><span class="main">)</span> <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">destMerge</span></span></span><span class="main">)</span> <span class="main">(</span>origin <span class="main">[</span><span class="bound">id</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">oldEFSM</span></span></span><span class="main">)</span> <span class="main">(</span>origin <span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="free"><span class="bound"><span class="entity">destMerge</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1">then</span>
       <span class="comment1">― ‹Replace t1 with t2›</span>
       Some <span class="main">(</span>merge_transitions_aux <span class="free"><span class="bound"><span class="entity">destMerge</span></span></span> <span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">∀</span><span class="bound">id</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">u2</span></span></span><span class="main">.</span> directly_subsumes <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">oldEFSM</span></span></span><span class="main">)</span> <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">destMerge</span></span></span><span class="main">)</span> <span class="main">(</span>origin <span class="main">[</span><span class="bound">id</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">oldEFSM</span></span></span><span class="main">)</span> <span class="main">(</span>origin <span class="free"><span class="bound"><span class="entity">u2</span></span></span> <span class="free"><span class="bound"><span class="entity">destMerge</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">then</span>
       <span class="comment1">― ‹Replace t2 with t1›</span>
       Some <span class="main">(</span>merge_transitions_aux <span class="free"><span class="bound"><span class="entity">destMerge</span></span></span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span> <span class="free"><span class="bound"><span class="entity">u1</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span>
        <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">modifier</span></span></span> <span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span> <span class="main">(</span>origin <span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="free"><span class="bound"><span class="entity">destMerge</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">destMerge</span></span></span> <span class="free"><span class="bound"><span class="entity">preDestMerge</span></span></span> <span class="free"><span class="bound"><span class="entity">oldEFSM</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="keyword1">of</span>
          None <span class="main">⇒</span> None <span class="main">|</span>
          Some <span class="bound">e</span> <span class="main">⇒</span> Some <span class="main">(</span>make_distinct <span class="bound">e</span><span class="main">)</span>
   <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">outgoing_transitions_from</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> transition fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">outgoing_transitions_from</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="bound">orig</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">orig</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">order_nondeterministic_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nondeterministic_pair fset <span class="main">⇒</span> nondeterministic_pair list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">order_nondeterministic_pairs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> map snd <span class="main">(</span>sorted_list_of_fset <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">t2</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">s</span> <span class="keyword1">in</span> <span class="main">(</span>score_transitions <span class="bound">t1</span> <span class="bound">t2</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* resolve_nondeterminism - tries dest resolve nondeterminism in a given iEFSM                      *)</span>
<span class="comment1">(* @param ((from, (dest1, dest2), ((t1, u1), (t2, u2)))#ss) - a list of nondeterministic pairs where
          from - nat - the state from which t1 and t2 eminate
          dest1  - nat - the destination state of t1
          dest2  - nat - the destination state of t2
          t1   - transition - a transition dest be merged with t2
          t2   - transition - a transition dest be merged with t1
          u1   - nat - the unique identifier of t1
          u2   - nat - the unique identifier of t2
          ss   - list - the rest of the list                                                      *)</span>
<span class="comment1">(* @param oldEFSM - the EFSM before merging the states which caused the nondeterminism            *)</span>
<span class="comment1">(* @param newEFSM - the current EFSM with nondeterminism                                          *)</span>
<span class="comment1">(* @param m       - an update modifier function which tries dest generalise transitions             *)</span>
<span class="comment1">(* @param check - a function which takes an EFSM and returns a bool dest ensure that certain
                  properties hold in the new iEFSM                                                *)</span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">resolve_nondeterminism</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cfstate <span class="main">×</span> cfstate<span class="main">)</span> set <span class="main">⇒</span> nondeterministic_pair list <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM <span class="main">⇒</span> update_modifier <span class="main">⇒</span> <span class="main">(</span>transition_matrix <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>iEFSM <span class="main">⇒</span> nondeterministic_pair fset<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>iEFSM option <span class="main">×</span> <span class="main">(</span>cfstate <span class="main">×</span> cfstate<span class="main">)</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">resolve_nondeterminism</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">newEFSM</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">if</span> deterministic <span class="free"><span class="bound"><span class="entity">newEFSM</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">newEFSM</span></span></span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">newEFSM</span></span></span> <span class="keyword1">else</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span>
  <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">resolve_nondeterminism</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">from</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dest1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">dest2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">oldEFSM</span></span></span> <span class="free"><span class="bound"><span class="entity">newEFSM</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dest1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">dest2</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dest2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">dest1</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="keyword1">then</span>
      <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
    <span class="keyword1">let</span> <span class="bound">destMerge</span> <span class="main">=</span> merge_states <span class="free"><span class="bound"><span class="entity">dest1</span></span></span> <span class="free"><span class="bound"><span class="entity">dest2</span></span></span> <span class="free"><span class="bound"><span class="entity">newEFSM</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">case</span> merge_transitions <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="free"><span class="bound"><span class="entity">oldEFSM</span></span></span> <span class="free"><span class="bound"><span class="entity">newEFSM</span></span></span> <span class="bound">destMerge</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="free">resolve_nondeterminism</span> <span class="main">(</span>insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dest1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">dest2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">oldEFSM</span></span></span> <span class="free"><span class="bound"><span class="entity">newEFSM</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">|</span>
      Some <span class="bound">new</span> <span class="main">⇒</span> <span class="main">(</span>
        <span class="keyword1">let</span> <span class="bound">newScores</span> <span class="main">=</span> order_nondeterministic_pairs <span class="main">(</span><span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="bound">new</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="keyword1">if</span> <span class="main">(</span>size <span class="bound">new</span><span class="main">,</span> size <span class="main">(</span>S <span class="bound">new</span><span class="main">)</span><span class="main">,</span> size <span class="main">(</span><span class="bound">newScores</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">newEFSM</span></span></span><span class="main">,</span> size <span class="main">(</span>S <span class="free"><span class="bound"><span class="entity">newEFSM</span></span></span><span class="main">)</span><span class="main">,</span> size <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
          <span class="keyword1">case</span> <span class="free">resolve_nondeterminism</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="bound">newScores</span> <span class="free"><span class="bound"><span class="entity">oldEFSM</span></span></span> <span class="bound">new</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="keyword1">of</span>
            <span class="main">(</span>Some <span class="bound">new'</span><span class="main">,</span> <span class="bound">failedMerges</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>Some <span class="bound">new'</span><span class="main">,</span> <span class="bound">failedMerges</span><span class="main">)</span> <span class="main">|</span>
            <span class="main">(</span>None<span class="main">,</span> <span class="bound">failedMerges</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">resolve_nondeterminism</span> <span class="main">(</span>insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dest1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">dest2</span></span></span><span class="main">)</span> <span class="bound">failedMerges</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">oldEFSM</span></span></span> <span class="free"><span class="bound"><span class="entity">newEFSM</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span>
        <span class="keyword1">else</span>
          <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span><span class="main">)</span>
      <span class="main">)</span>
  <span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> neq_Nil_conv prod_cases3 surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measures <span class="main">[</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">newEFSM</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> size <span class="bound">newEFSM</span><span class="main">,</span>
                          <span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">newEFSM</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> size <span class="main">(</span>S <span class="bound">newEFSM</span><span class="main">)</span><span class="main">,</span>
                          <span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">ss</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> size <span class="bound">ss</span><span class="main">]</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹EFSM Inference›</span></span>

<span class="comment1">(* Merge - tries dest merge two states in a given iEFSM and resolve the resulting nondeterminism  *)</span>
<span class="comment1">(* @param e     - an iEFSM                                                                        *)</span>
<span class="comment1">(* @param s1    - a state dest be merged with s2                                                  *)</span>
<span class="comment1">(* @param s2    - a state dest be merged with s1                                                  *)</span>
<span class="comment1">(* @param m     - an update modifier function which tries dest generalise transitions             *)</span>
<span class="comment1">(* @param check - a function which takes an EFSM and returns a bool dest ensure that certain
                  properties hold in the new iEFSM                                                *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cfstate <span class="main">×</span> cfstate<span class="main">)</span> set <span class="main">⇒</span> iEFSM <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> update_modifier <span class="main">⇒</span> <span class="main">(</span>transition_matrix <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>iEFSM <span class="main">⇒</span> nondeterministic_pair fset<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>iEFSM option <span class="main">×</span> <span class="main">(</span>cfstate <span class="main">×</span> cfstate<span class="main">)</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="keyword1">then</span>
      <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="bound">e'</span> <span class="main">=</span> make_distinct <span class="main">(</span>merge_states <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      resolve_nondeterminism <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="main">(</span>order_nondeterministic_pairs <span class="main">(</span><span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="bound">e'</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">e'</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="comment1">(* inference_step - attempt dest carry out a single step of the inference process by merging the  *)</span>
<span class="comment1">(* @param e - an iEFSM dest be generalised                                                        *)</span>
<span class="comment1">(* @param ((s, s1, s2)#t) - a list of triples of the form (score, state, state) dest be merged    *)</span>
<span class="comment1">(* @param m     - an update modifier function which tries dest generalise transitions             *)</span>
<span class="comment1">(* @param check - a function which takes an EFSM and returns a bool dest ensure that certain
                  properties hold in the new iEFSM                                                *)</span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">inference_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cfstate <span class="main">×</span> cfstate<span class="main">)</span> set <span class="main">⇒</span> iEFSM <span class="main">⇒</span> score fset <span class="main">⇒</span> update_modifier <span class="main">⇒</span> <span class="main">(</span>transition_matrix <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>iEFSM <span class="main">⇒</span> nondeterministic_pair fset<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>iEFSM option <span class="main">×</span> <span class="main">(</span>cfstate <span class="main">×</span> cfstate<span class="main">)</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inference_step</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
     <span class="keyword1">let</span>
      <span class="bound">h</span> <span class="main">=</span> fMin <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
      <span class="bound">t</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="main">{|</span><span class="bound">h</span><span class="main">|}</span>
    <span class="keyword1">in</span>
    <span class="keyword1">case</span> merge <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>S1 <span class="bound">h</span><span class="main">)</span> <span class="main">(</span>S2 <span class="bound">h</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="keyword1">of</span>
      <span class="main">(</span>Some <span class="bound">new</span><span class="main">,</span> <span class="bound">failedMerges</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>Some <span class="bound">new</span><span class="main">,</span> <span class="bound">failedMerges</span><span class="main">)</span> <span class="main">|</span>
      <span class="main">(</span>None<span class="main">,</span> <span class="bound">failedMerges</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">inference_step</span> <span class="main">(</span>insert <span class="main">(</span><span class="main">(</span>S1 <span class="bound">h</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>S2 <span class="bound">h</span><span class="main">)</span><span class="main">)</span> <span class="bound">failedMerges</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measures <span class="main">[</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> size <span class="bound">s</span><span class="main">]</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_minus_fMin<span class="main">)</span>

<span class="comment1">(* Takes an iEFSM and iterates inference_step until no further states can be successfully merged  *)</span>
<span class="comment1">(* @param e - an iEFSM dest be generalised                                                        *)</span>
<span class="comment1">(* @param r - a strategy dest identify and prioritise pairs of states dest merge                  *)</span>
<span class="comment1">(* @param m     - an update modifier function which tries dest generalise transitions             *)</span>
<span class="comment1">(* @param check - a function which takes an EFSM and returns a bool dest ensure that certain
                  properties hold in the new iEFSM                                                *)</span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">infer</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cfstate <span class="main">×</span> cfstate<span class="main">)</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> iEFSM <span class="main">⇒</span> strategy <span class="main">⇒</span> update_modifier <span class="main">⇒</span> <span class="main">(</span>transition_matrix <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>iEFSM <span class="main">⇒</span> nondeterministic_pair fset<span class="main">)</span> <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">infer</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">scores</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> score_1 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>k_score <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">case</span> inference_step <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>S1 <span class="bound">s</span><span class="main">,</span> S2 <span class="bound">s</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="main">∧</span> <span class="main">(</span>S2 <span class="bound">s</span><span class="main">,</span> S1 <span class="bound">s</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span><span class="main">)</span> <span class="bound">scores</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="keyword1">of</span>
      <span class="main">(</span>None<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">|</span>
      <span class="main">(</span>Some <span class="bound">new</span><span class="main">,</span> <span class="bound">failedMerges</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="main">(</span>S <span class="bound">new</span><span class="main">)</span> <span class="main">|⊂|</span> <span class="main">(</span>S <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">infer</span> <span class="bound">failedMerges</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">new</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measures <span class="main">[</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">e</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> size <span class="main">(</span>S <span class="bound">e</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_conv measures_less size_fsubset<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">get_ints</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trace <span class="main">⇒</span> int list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_ints</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">get_ints</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">outputs</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Num <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>filter is_Num <span class="main">(</span><span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">outputs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">learn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> iEFSM <span class="main">⇒</span> log <span class="main">⇒</span> strategy <span class="main">⇒</span> update_modifier <span class="main">⇒</span> <span class="main">(</span>iEFSM <span class="main">⇒</span> nondeterministic_pair fset<span class="main">)</span> <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">learn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">pta</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="bound">check</span> <span class="main">=</span> accepts_log <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
         <span class="main">(</span>infer <span class="main">{}</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">pta</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">check</span> <span class="free"><span class="bound"><span class="entity">np</span></span></span><span class="main">)</span>
   <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Evaluating Inferred Models›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We need a function to test the EFSMs we infer. The \texttt{test\_trace} function executes a
trace in the model and outputs a more comprehensive trace such that the expected outputs and actual
outputs can be compared. If a point is reached where the model does not recognise an action, the
remainder of the trace forms the second element of the output pair such that we know the exact point
at which the model stopped processing.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">i_possible_steps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> label <span class="main">⇒</span> inputs <span class="main">⇒</span> <span class="main">(</span>tids <span class="main">×</span> cfstate <span class="main">×</span> transition<span class="main">)</span> fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i_possible_steps</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="bound">dest</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">origin</span><span class="main">,</span> <span class="bound">dest</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">::</span>transition<span class="main">)</span><span class="main">.</span>
      <span class="bound">origin</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
      <span class="main">∧</span> <span class="main">(</span>Label <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
      <span class="main">∧</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Arity <span class="bound">t</span><span class="main">)</span>
      <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
     <span class="main">)</span>
    <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">test_trace</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trace <span class="main">⇒</span> iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>label <span class="main">×</span> inputs <span class="main">×</span> cfstate <span class="main">×</span> cfstate <span class="main">×</span> registers <span class="main">×</span> tids <span class="main">×</span> value list <span class="main">×</span> outputs<span class="main">)</span> list <span class="main">×</span> trace<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">test_trace</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">test_trace</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">expected</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">ps</span> <span class="main">=</span> i_possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>
    <span class="keyword1">in</span>
      <span class="keyword1">if</span> fis_singleton <span class="bound">ps</span> <span class="keyword1">then</span>
        <span class="keyword1">let</span>
          <span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> fthe_elem <span class="bound">ps</span><span class="main">;</span>
          <span class="bound">r'</span> <span class="main">=</span> evaluate_updates <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
          <span class="bound">actual</span> <span class="main">=</span> evaluate_outputs <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
          <span class="main">(</span><span class="bound">est</span><span class="main">,</span> <span class="bound">fail</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">test_trace</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="bound">r'</span><span class="main">)</span>
        <span class="keyword1">in</span>
        <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="bound">id</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">expected</span></span></span><span class="main">,</span> <span class="bound">actual</span><span class="main">)</span><span class="main">#</span><span class="bound">est</span><span class="main">,</span> <span class="bound">fail</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">expected</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \texttt{test\_log} function executes the \texttt{test\_trace} function on a collection of
traces known as the \emph{test set.}›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">test_log</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"log <span class="main">⇒</span> iEFSM <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>label <span class="main">×</span> inputs <span class="main">×</span> cfstate <span class="main">×</span> cfstate <span class="main">×</span> registers <span class="main">×</span> tids <span class="main">×</span> value list <span class="main">×</span> outputs<span class="main">)</span> list <span class="main">×</span> trace<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">test_log</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> test_trace <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SelectionStrategies">
<div class="head">
<h1>Theory SelectionStrategies</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Selection Strategies›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The strategy used to idenfity and prioritise states to be merged plays a big part in how the
final model turns out. This theory file presents a number of different selection strategies.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> SelectionStrategies
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Inference">Inference</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* One point if they're equal *)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The simplest strategy is to assign one point for each shared pair of transitions.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">exactly_equal</span> <span class="main">::</span> <span class="quoted">strategy</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exactly_equal</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> bool2nat <span class="main">(</span><span class="main">(</span>get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Another simple strategy is to look at the labels and arities of outgoing transitions of each
state. Pairs of states are ranked by how many transitions with the same label and arity they have in
common.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">naive_score</span> <span class="main">::</span> <span class="quoted">strategy</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">naive_score</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span>
    <span class="bound">t1</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">;</span>
    <span class="bound">t2</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span>
  <span class="keyword1">in</span>
  bool2nat <span class="main">(</span>Label <span class="bound">t1</span> <span class="main">=</span> Label <span class="bound">t2</span> <span class="main">∧</span> Arity <span class="bound">t1</span> <span class="main">=</span> Arity <span class="bound">t2</span> <span class="main">∧</span> length <span class="main">(</span>Outputs <span class="bound">t1</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>Outputs <span class="bound">t2</span><span class="main">)</span><span class="main">)</span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Building off the above strategy, it makes sense to give transitions an extra ``bonus point'' if
they are exactly equal.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">naive_score_eq_bonus</span> <span class="main">::</span> <span class="quoted">strategy</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">naive_score_eq_bonus</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span>
    <span class="bound">t1</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">;</span>
    <span class="bound">t2</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span>
  <span class="keyword1">in</span>
  score_transitions <span class="bound">t1</span> <span class="bound">t2</span>
<span class="main">)</span>"</span></span>

<span class="comment1">(* One point each for equal label, arity, and outputs *)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Another strategy is to assign bonus points for each shared output.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">naive_score_outputs</span> <span class="main">::</span> <span class="quoted">strategy</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">naive_score_outputs</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span>
    <span class="bound">t1</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">;</span>
    <span class="bound">t2</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span>
  <span class="keyword1">in</span>
    bool2nat <span class="main">(</span>Label <span class="bound">t1</span> <span class="main">=</span> Label <span class="bound">t2</span><span class="main">)</span> <span class="main">+</span> bool2nat <span class="main">(</span>Arity <span class="bound">t1</span> <span class="main">=</span> Arity <span class="bound">t2</span><span class="main">)</span> <span class="main">+</span> bool2nat <span class="main">(</span>Outputs <span class="bound">t1</span> <span class="main">=</span> Outputs <span class="bound">t2</span><span class="main">)</span>
<span class="main">)</span>"</span></span>

<span class="comment1">(* Functions with same label, and input and output arities contribute one point for each guard    *)</span>
<span class="comment1">(* and output they share. *)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Along similar lines, we can assign additional bonus points for shared guards.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">naive_score_comprehensive</span> <span class="main">::</span> <span class="quoted">strategy</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">naive_score_comprehensive</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span>
    <span class="bound">t1</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">;</span>
    <span class="bound">t2</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span>
  <span class="keyword1">in</span>
  <span class="keyword1">if</span> Label <span class="bound">t1</span> <span class="main">=</span> Label <span class="bound">t2</span> <span class="main">∧</span> Arity <span class="bound">t1</span> <span class="main">=</span> Arity <span class="bound">t2</span> <span class="keyword1">then</span>
    <span class="keyword1">if</span> length <span class="main">(</span>Outputs <span class="bound">t1</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>Outputs <span class="bound">t2</span><span class="main">)</span> <span class="keyword1">then</span>
      card <span class="main">(</span>set <span class="main">(</span>Guards <span class="bound">t1</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>Guards <span class="bound">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p1</span><span class="main">,</span> <span class="bound">p2</span><span class="main">)</span><span class="main">.</span> <span class="bound">p1</span> <span class="main">=</span> <span class="bound">p2</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>Outputs <span class="bound">t1</span><span class="main">)</span> <span class="main">(</span>Outputs <span class="bound">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">0</span>
  <span class="keyword1">else</span> <span class="main">0</span>
<span class="main">)</span>"</span></span>

<span class="comment1">(* Functions with same label, and input and output arities contribute one point for each guard    *)</span>
<span class="comment1">(* and output they share. Transitions which are exactly equal get a very high score. *)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This strategy is similar to the one above except that transitions which are exactly equal get
100 bonus points. ›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">naive_score_comprehensive_eq_high</span> <span class="main">::</span> <span class="quoted">strategy</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">naive_score_comprehensive_eq_high</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span>
    <span class="bound">t1</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">;</span>
    <span class="bound">t2</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span>
  <span class="keyword1">in</span>
  <span class="keyword1">if</span> <span class="bound">t1</span> <span class="main">=</span> <span class="bound">t2</span> <span class="keyword1">then</span>
    <span class="numeral">100</span>
  <span class="keyword1">else</span>
    <span class="keyword1">if</span> Label <span class="bound">t1</span> <span class="main">=</span> Label <span class="bound">t2</span> <span class="main">∧</span> Arity <span class="bound">t1</span> <span class="main">=</span> Arity <span class="bound">t2</span> <span class="keyword1">then</span>
      <span class="keyword1">if</span> length <span class="main">(</span>Outputs <span class="bound">t1</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>Outputs <span class="bound">t2</span><span class="main">)</span> <span class="keyword1">then</span>
        card <span class="main">(</span>set <span class="main">(</span>Guards <span class="bound">t1</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>Guards <span class="bound">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p1</span><span class="main">,</span> <span class="bound">p2</span><span class="main">)</span><span class="main">.</span> <span class="bound">p1</span> <span class="main">=</span> <span class="bound">p2</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>Outputs <span class="bound">t1</span><span class="main">)</span> <span class="main">(</span>Outputs <span class="bound">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">0</span>
    <span class="keyword1">else</span> <span class="main">0</span>
<span class="main">)</span>"</span></span>

<span class="comment1">(* One point if one subsumes the other *)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We can incorporate the subsumption relation into the scoring of merges such that a pair of
states receives one point for each pair of transitions where one directly subsumes the other.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">naive_score_subsumption</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"strategy"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">naive_score_subsumption</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span>
    <span class="bound">t1</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">;</span>
    <span class="bound">t2</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span><span class="main">;</span>
    <span class="bound">s</span> <span class="main">=</span> origin <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="keyword1">in</span>
  bool2nat <span class="main">(</span>directly_subsumes <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="bound">s</span> <span class="bound">s</span> <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">+</span> bool2nat <span class="main">(</span>directly_subsumes <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="bound">s</span> <span class="bound">s</span> <span class="bound">t2</span> <span class="bound">t1</span><span class="main">)</span>
<span class="main">)</span>"</span></span>

<span class="comment1">(* Orders by the origin state so we merge leaves first *)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹An alternative strategy is to simply score merges based on the states' proximity to the origin.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">leaves</span> <span class="main">::</span> <span class="quoted">strategy</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">leaves</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">t1</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">;</span>
      <span class="bound">t2</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span>
    <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="main">(</span>Label <span class="bound">t1</span> <span class="main">=</span> Label <span class="bound">t2</span> <span class="main">∧</span> Arity <span class="bound">t1</span> <span class="main">=</span> Arity <span class="bound">t2</span> <span class="main">∧</span> length <span class="main">(</span>Outputs <span class="bound">t1</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>Outputs <span class="bound">t2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
      origin <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">+</span> origin <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
    <span class="keyword1">else</span>
      <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Store_Reuse">
<div class="head">
<h1>Theory Store_Reuse</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span><span class="quoted"><span class="plain_text">‹Heuristics›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹As part of this inference technique, we make use of certain \emph{heuristics} to abstract away
concrete values into registers. This allows us to generalise from examples of behaviour. These
heuristics are as follows.

\begin{description}
  \item [Store and Reuse] - This heuristic aims to recognise when input values are subsequently used
as an output. Such behaviour is generalised by storing the relevant input in a register, and
replacing the literal output with the content of the register. This enables the EFSM to
\emph{predict} how the underlying system might behave when faced with unseen inputs.
  \item [Increment and Reset] - This heuristic is a naive attempt to introduce additive behaviour.
The idea here is that if we want to merge two transitions with identical input values and different
numeric outputs, for example $\textit{coin}:1[i_0=50]/o_0:=50$ and $\textit{coin}:1[i_0=50]/o_0:=100$,
then the behaviour must depend on the value of an internal variable. This heuristic works by
dropping the input guard and adding an update to a fresh register, in this case summing the current
register value with the input. A similar principle can be applied to other numeric functions such as
subtraction.
  \item [Same Register] - Because of the way heuristics are applied, it is possible for different
registers to be introduced to serve the same purpose. This heuristic attempts to identify when this
has happened and merge the two registers.
  \item [Least Upper Bound] - In certain situations, transitions may produce the same output for
different inputs. This technique forms the least upper bound of the transition guards
--- their disjunction --- such that they can be merged into a single behaviour.
  \item [Distinguishing Guards] - Under certain circumstances, we explicitly do not want to merge
two transitions into one. This heuristic resolves nondeterminism between transitions by attempting
to find apply mutually exclusive guards to each transition such that their behaviour is distinguished.
\end{description}›</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Store and Reuse›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹An obvious candidate for generalisation is the ``store and reuse'' pattern. This manifests
itself  when the input of one transition is subsequently used as the output of another. Recognising
this usage pattern allows us to introduce a \emph{storage register} to abstract away concrete data
values and replace two transitions whose outputs differ with a single transition that outputs the
content of the register.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Store_Reuse
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Inference">../Inference</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ioTag <span class="main">=</span> In <span class="main">|</span> Out

<span class="keyword1"><span class="command">instantiation</span></span> ioTag <span class="main">::</span> <span class="quoted">linorder</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">less_ioTag</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ioTag <span class="main">⇒</span> ioTag <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"In <span class="main">&lt;</span> Out <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"Out <span class="main">&lt;</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"In <span class="main">&lt;</span> In <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_ioTag</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ioTag <span class="main">⇒</span> ioTag <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_eq_ioTag</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> less_eq_ioTag_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> less_ioTag.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ioTag.exhaust less_eq_ioTag_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> less_eq_ioTag_def less_ioTag.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> ioTag.exhaust less_eq_ioTag_def less_ioTag.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> index <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> ioTag <span class="main">×</span> nat"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"index <span class="main">⇒</span> trace <span class="main">⇒</span> value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">actionNo</span></span></span><span class="main">,</span> In<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">inx</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">inputs</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=</span> nth <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">actionNo</span></span></span> <span class="keyword1">in</span> nth <span class="bound">inputs</span> <span class="free"><span class="bound"><span class="entity">inx</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">actionNo</span></span></span><span class="main">,</span> Out<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">inx</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">outputs</span><span class="main">)</span> <span class="main">=</span> nth <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">actionNo</span></span></span> <span class="keyword1">in</span> nth <span class="bound">outputs</span> <span class="free"><span class="bound"><span class="entity">inx</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">actionNum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"index <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">actionNum</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> fst <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ioTag</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"index <span class="main">⇒</span> ioTag"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ioTag</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">inx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"index <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inx</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value list <span class="main">⇒</span> nat <span class="main">⇒</span> ioTag <span class="main">⇒</span> nat <span class="main">⇒</span> index fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{||}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">actionNo</span></span></span> <span class="free"><span class="bound"><span class="entity">io</span></span></span> <span class="free"><span class="bound"><span class="entity">ind</span></span></span> <span class="main">=</span> finsert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">actionNo</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">io</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ind</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">index</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">actionNo</span></span></span> <span class="free"><span class="bound"><span class="entity">io</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ind</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">io_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> value list <span class="main">⇒</span> value list <span class="main">⇒</span> index fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">io_index</span> <span class="free"><span class="bound"><span class="entity">actionNo</span></span></span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="free"><span class="bound"><span class="entity">outputs</span></span></span> <span class="main">=</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="free"><span class="bound"><span class="entity">actionNo</span></span></span> In <span class="main">0</span><span class="main">)</span> <span class="main">|∪|</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">outputs</span></span></span> <span class="free"><span class="bound"><span class="entity">actionNo</span></span></span> Out <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">indices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trace <span class="main">⇒</span> index fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">indices</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> foldl <span class="main">(|∪|)</span> <span class="main">{||}</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">actionNo</span><span class="main">,</span> <span class="main">(</span><span class="bound">label</span><span class="main">,</span> <span class="bound">inputs</span><span class="main">,</span> <span class="bound">outputs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> io_index <span class="bound">actionNo</span> <span class="bound">inputs</span> <span class="bound">outputs</span><span class="main">)</span> <span class="main">(</span>enumerate <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_by_id_intratrace_matches</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trace <span class="main">⇒</span> <span class="main">(</span>index <span class="main">×</span> index<span class="main">)</span> fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_by_id_intratrace_matches</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> lookup <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> lookup <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∧</span> actionNum <span class="bound">a</span> <span class="main">≤</span> actionNum <span class="bound">b</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span>indices <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">|×|</span> indices <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(*
  If the EFSM is nondeterministic, we need to make sure it chooses the right path so that it recognises
  the input trace.
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">i_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"execution <span class="main">⇒</span> iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> label <span class="main">⇒</span> inputs <span class="main">⇒</span> <span class="main">(</span>transition <span class="main">×</span> cfstate <span class="main">×</span> tids <span class="main">×</span> registers<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i_step</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
    <span class="bound">poss_steps</span> <span class="main">=</span> <span class="main">(</span>i_possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="bound">possibilities</span> <span class="main">=</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> recognises_execution <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span><span class="main">)</span> <span class="bound">poss_steps</span> <span class="keyword1">in</span>
    <span class="keyword1">case</span> random_member <span class="bound">possibilities</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> None <span class="main">|</span>
      Some <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span>
      Some <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">u</span><span class="main">,</span> <span class="main">(</span>evaluate_updates <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> match <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>transition <span class="main">×</span> tids<span class="main">)</span> <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span>transition <span class="main">×</span> tids<span class="main">)</span> <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">exec2trace</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">label</span><span class="main">,</span> <span class="bound">inputs</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">label</span><span class="main">,</span> <span class="bound">inputs</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span>nonexhaustive<span class="main">)</span> <span class="entity">walk_up_to</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> iEFSM <span class="main">⇒</span> nat <span class="main">⇒</span> registers <span class="main">⇒</span> trace <span class="main">⇒</span> <span class="main">(</span>transition <span class="main">×</span> tids<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">walk_up_to</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>i_step <span class="main">(</span>exec2trace <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>Some <span class="main">(</span><span class="bound">transition</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">uid</span><span class="main">,</span> <span class="bound">updated</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">transition</span><span class="main">,</span> <span class="bound">uid</span><span class="main">)</span> <span class="main">|</span> Suc <span class="bound">m</span> <span class="main">⇒</span> <span class="free">walk_up_to</span> <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="bound">updated</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
    <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_intertrace_matches_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>index <span class="main">×</span> index<span class="main">)</span> fset <span class="main">⇒</span> iEFSM <span class="main">⇒</span> trace <span class="main">⇒</span> match fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_intertrace_matches_aux</span> <span class="free"><span class="bound"><span class="entity">intras</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">e1</span><span class="main">,</span> <span class="bound">io1</span><span class="main">,</span> <span class="bound">inx1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">e2</span><span class="main">,</span> <span class="bound">io2</span><span class="main">,</span> <span class="bound">inx2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>walk_up_to <span class="bound">e1</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span> <span class="bound">io1</span><span class="main">,</span> <span class="bound">inx1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>walk_up_to <span class="bound">e2</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span> <span class="bound">io2</span><span class="main">,</span> <span class="bound">inx2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">intras</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_intertrace_matches</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"log <span class="main">⇒</span> iEFSM <span class="main">⇒</span> match list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_intertrace_matches</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">e1</span><span class="main">,</span> <span class="bound">io1</span><span class="main">,</span> <span class="bound">inx1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">e2</span><span class="main">,</span> <span class="bound">io2</span><span class="main">,</span> <span class="bound">inx2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">e1</span> <span class="main">≠</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> sorted_list_of_fset <span class="main">(</span>find_intertrace_matches_aux <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>map get_by_id_intratrace_matches <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">total_max_input</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">total_max_input</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> EFSM.max_input <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">i</span> <span class="main">⇒</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">total_max_reg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">total_max_reg</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> EFSM.max_reg <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">i</span> <span class="main">⇒</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remove_guard_add_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_guard_add_update</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">inputX</span></span></span> <span class="free"><span class="bound"><span class="entity">outputX</span></span></span> <span class="main">=</span> <span class="main">⦇</span>
    Label <span class="main">=</span> <span class="main">(</span>Label <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span> Arity <span class="main">=</span> <span class="main">(</span>Arity <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
    Guards <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="main">¬</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free"><span class="bound"><span class="entity">inputX</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    Outputs <span class="main">=</span> <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
    Updates <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">outputX</span></span></span><span class="main">,</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free"><span class="bound"><span class="entity">inputX</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">generalise_output</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">generalise_output</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">regX</span></span></span> <span class="free"><span class="bound"><span class="entity">outputX</span></span></span> <span class="main">=</span> <span class="main">⦇</span>
      Label <span class="main">=</span> <span class="main">(</span>Label <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
      Arity <span class="main">=</span> <span class="main">(</span>Arity <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
      Guards <span class="main">=</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
      Outputs <span class="main">=</span> list_update <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">outputX</span></span></span> <span class="main">(</span>V <span class="main">(</span>R <span class="free"><span class="bound"><span class="entity">regX</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      Updates <span class="main">=</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_generalised_output_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_generalised_output_of</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span> generalise_output <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">count</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">count</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">count</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">then</span> <span class="main">1</span><span class="main">+</span><span class="main">(</span><span class="free">count</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">count</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">replaceAll</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> transition <span class="main">⇒</span> transition <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replaceAll</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">t</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">new</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">generalise_transitions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>transition <span class="main">×</span> tids<span class="main">)</span> <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>transition <span class="main">×</span> tids<span class="main">)</span> <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span>
     <span class="main">(</span><span class="main">(</span>transition <span class="main">×</span> tids<span class="main">)</span> <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>transition <span class="main">×</span> tids<span class="main">)</span> <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">generalise_transitions</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">generalise_transitions</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">orig1</span><span class="main">,</span> <span class="bound">u1</span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">orig2</span><span class="main">,</span> <span class="bound">u2</span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">gen1</span><span class="main">,</span> <span class="bound">u1'</span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">gen2</span><span class="main">,</span> <span class="bound">u2</span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">in</span>
   <span class="free">generalise_transitions</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>replaceAll <span class="main">(</span>replaceAll <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">orig1</span> <span class="bound">gen1</span><span class="main">)</span> <span class="bound">orig2</span> <span class="bound">gen2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strip_uids</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>transition <span class="main">×</span> tids<span class="main">)</span> <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>transition <span class="main">×</span> tids<span class="main">)</span> <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>transition <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>transition <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strip_uids</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">u1</span><span class="main">)</span><span class="main">,</span> <span class="bound">io1</span><span class="main">,</span> <span class="bound">in1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">t2</span><span class="main">,</span> <span class="bound">u2</span><span class="main">)</span><span class="main">,</span> <span class="bound">io2</span><span class="main">,</span> <span class="bound">in2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">io1</span><span class="main">,</span> <span class="bound">in1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">t2</span><span class="main">,</span> <span class="bound">io2</span><span class="main">,</span> <span class="bound">in2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">modify</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"match list <span class="main">⇒</span> tids <span class="main">⇒</span> tids <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">modify</span> <span class="free"><span class="bound"><span class="entity">matches</span></span></span> <span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">relevant</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">u1'</span><span class="main">)</span><span class="main">,</span> <span class="bound">io</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">u2'</span><span class="main">)</span><span class="main">,</span> <span class="bound">io'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">io</span> <span class="main">=</span> In <span class="main">∧</span> <span class="bound">io'</span> <span class="main">=</span> Out <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="main">=</span> <span class="bound">u1'</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span> <span class="main">=</span> <span class="bound">u1'</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="main">=</span> <span class="bound">u2'</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span> <span class="main">=</span> <span class="bound">u2'</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">matches</span></span></span><span class="main">;</span>
                                   <span class="bound">newReg</span> <span class="main">=</span> <span class="keyword1">case</span> max_reg <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="bound">r</span> <span class="main">⇒</span> <span class="bound">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">;</span>
                                   <span class="bound">replacements</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">u1</span><span class="main">)</span><span class="main">,</span> <span class="bound">io1</span><span class="main">,</span> <span class="bound">inx1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">t2</span><span class="main">,</span> <span class="bound">u2</span><span class="main">)</span><span class="main">,</span> <span class="bound">io2</span><span class="main">,</span> <span class="bound">inx2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>remove_guard_add_update <span class="bound">t1</span> <span class="bound">inx1</span> <span class="bound">newReg</span><span class="main">,</span> <span class="bound">u1</span><span class="main">)</span><span class="main">,</span> <span class="bound">io1</span><span class="main">,</span> <span class="bound">inx1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>generalise_output <span class="bound">t2</span> <span class="bound">newReg</span> <span class="bound">inx2</span><span class="main">,</span> <span class="bound">u2</span><span class="main">)</span><span class="main">,</span> <span class="bound">io2</span><span class="main">,</span> <span class="bound">inx2</span><span class="main">)</span><span class="main">)</span> <span class="bound">relevant</span><span class="main">;</span>
                                   <span class="bound">comparisons</span> <span class="main">=</span> zip <span class="bound">relevant</span> <span class="bound">replacements</span><span class="main">;</span>
                                   <span class="bound">stripped_replacements</span> <span class="main">=</span> map strip_uids <span class="bound">replacements</span><span class="main">;</span>
                                   <span class="bound">to_replace</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> count <span class="main">(</span>strip_uids <span class="bound">s</span><span class="main">)</span> <span class="bound">stripped_replacements</span> <span class="main">&gt;</span> <span class="main">1</span><span class="main">)</span> <span class="bound">comparisons</span> <span class="keyword1">in</span>
                                <span class="keyword1">if</span> <span class="bound">to_replace</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span><span class="main">(</span>generalise_transitions <span class="bound">to_replace</span> <span class="free"><span class="bound"><span class="entity">old</span></span></span><span class="main">)</span><span class="main">)</span>
                              <span class="main">)</span>"</span></span>

<span class="comment1">(* type_synonym update_modifier = "transition ⇒ transition ⇒ nat ⇒ iEFSM ⇒ iEFSM ⇒ (iEFSM × (nat ⇒ nat) × (nat ⇒ nat)) option" *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">heuristic_1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"log <span class="main">⇒</span> update_modifier"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">heuristic_1</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> modify <span class="main">(</span>find_intertrace_matches <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> None <span class="main">|</span>
    Some <span class="bound">e</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">(</span>tm <span class="bound">e</span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="bound">e</span> <span class="keyword1">else</span> None
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="Store_Reuse-remove_guard_add_update_preserves_outputs"><span class="command">lemma</span></span> remove_guard_add_update_preserves_outputs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Outputs <span class="main">(</span>remove_guard_add_update <span class="free">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Outputs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_guard_add_update_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse-remove_guard_add_update_preserves_label"><span class="command">lemma</span></span> remove_guard_add_update_preserves_label<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Label <span class="main">(</span>remove_guard_add_update <span class="free">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Label <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_guard_add_update_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse-remove_guard_add_update_preserves_arity"><span class="command">lemma</span></span> remove_guard_add_update_preserves_arity<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Arity <span class="main">(</span>remove_guard_add_update <span class="free">t</span> <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Arity <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_guard_add_update_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> remove_guard_add_update_preserves <span class="main">=</span> remove_guard_add_update_preserves_label
                                           remove_guard_add_update_preserves_arity
                                           remove_guard_add_update_preserves_outputs

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_generalisation_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_generalisation_of</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span> remove_guard_add_update <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span>
                                    <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> Arity <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span>
                                    <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> Eq <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
                                    <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Store_Reuse-generalise_output_preserves_label"><span class="command">lemma</span></span> generalise_output_preserves_label<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Label <span class="main">(</span>generalise_output <span class="free">t</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Label <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalise_output_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse-generalise_output_preserves_arity"><span class="command">lemma</span></span> generalise_output_preserves_arity<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Arity <span class="main">(</span>generalise_output <span class="free">t</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Arity <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalise_output_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse-generalise_output_preserves_guard"><span class="command">lemma</span></span> generalise_output_preserves_guard<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Guards <span class="main">(</span>generalise_output <span class="free">t</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Guards <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalise_output_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse-generalise_output_preserves_output_length"><span class="command">lemma</span></span> generalise_output_preserves_output_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>Outputs <span class="main">(</span>generalise_output <span class="free">t</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>Outputs <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalise_output_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse-generalise_output_preserves_updates"><span class="command">lemma</span></span> generalise_output_preserves_updates<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Updates <span class="main">(</span>generalise_output <span class="free">t</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Updates <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalise_output_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> generalise_output_preserves <span class="main">=</span> generalise_output_preserves_label
                                     generalise_output_preserves_arity
                                     generalise_output_preserves_output_length
                                     generalise_output_preserves_guard
                                     generalise_output_preserves_updates

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_proper_generalisation_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> iEFSM <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">is_proper_generalisation_of</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> total_max_input <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">r</span></span> <span class="main">≤</span> total_max_reg <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">.</span>
                                        is_generalisation_of <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">i</span> <span class="bound">r</span> <span class="main">∧</span>
                                        <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> set <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> fst <span class="bound">u</span> <span class="main">≠</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∧</span>
                                        <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> max_input <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> set <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> fst <span class="bound">u</span> <span class="main">≠</span> <span class="bound">r</span><span class="main">)</span>
                                       <span class="main">)</span>"</span></span>

<span class="comment1">(* Recognising the same input used in multiple guards *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">generalise_input</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">generalise_input</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">⦇</span>
      Label <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
      Arity <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
      Guards <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">g</span> <span class="keyword1">of</span> Eq <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="bound">i'</span> <span class="keyword1">then</span> Eq <span class="main">(</span>V <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>R <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">g</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
      Outputs <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
      Updates <span class="main">=</span> Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">structural_count</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>transition <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>transition <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>transition <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>transition <span class="main">×</span> ioTag <span class="main">×</span> nat<span class="main">)</span><span class="main">)</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">structural_count</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">structural_count</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">io1'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i1'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">io2'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i2'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">io1</span><span class="main">,</span> <span class="bound">i1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">t2</span><span class="main">,</span> <span class="bound">io2</span><span class="main">,</span> <span class="bound">i2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> same_structure <span class="bound">t1</span> <span class="free"><span class="bound"><span class="entity">t1'</span></span></span> <span class="main">∧</span> same_structure <span class="bound">t2</span> <span class="free"><span class="bound"><span class="entity">t2'</span></span></span> <span class="main">∧</span>
       <span class="bound">io1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">io1'</span></span></span> <span class="main">∧</span> <span class="bound">io2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">io2'</span></span></span> <span class="main">∧</span>
       <span class="bound">i1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i1'</span></span></span> <span class="main">∧</span> <span class="bound">i2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i2'</span></span></span>
    <span class="keyword1">then</span>
      <span class="main">1</span><span class="main">+</span><span class="main">(</span><span class="free">structural_count</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="free">structural_count</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remove_guards_add_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_guards_add_update</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">inputX</span></span></span> <span class="free"><span class="bound"><span class="entity">outputX</span></span></span> <span class="main">=</span> <span class="main">⦇</span>
    Label <span class="main">=</span> <span class="main">(</span>Label <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span> Arity <span class="main">=</span> <span class="main">(</span>Arity <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
    Guards <span class="main">=</span> <span class="main">[]</span><span class="main">,</span>
    Outputs <span class="main">=</span> <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
    Updates <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">outputX</span></span></span><span class="main">,</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free"><span class="bound"><span class="entity">inputX</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">modify_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"match list <span class="main">⇒</span> tids <span class="main">⇒</span> tids <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">modify_2</span> <span class="free"><span class="bound"><span class="entity">matches</span></span></span> <span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">relevant</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">u1'</span><span class="main">)</span><span class="main">,</span> <span class="bound">io</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">u2'</span><span class="main">)</span><span class="main">,</span> <span class="bound">io'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">io</span> <span class="main">=</span> In <span class="main">∧</span> <span class="bound">io'</span> <span class="main">=</span> In <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="main">=</span> <span class="bound">u1'</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span> <span class="main">=</span> <span class="bound">u1'</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="main">=</span> <span class="bound">u2'</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span> <span class="main">=</span> <span class="bound">u2'</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">matches</span></span></span><span class="main">;</span>
                                   <span class="bound">newReg</span> <span class="main">=</span> <span class="keyword1">case</span> max_reg <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="bound">r</span> <span class="main">⇒</span> <span class="bound">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">;</span>
                                   <span class="bound">replacements</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">u1</span><span class="main">)</span><span class="main">,</span> <span class="bound">io1</span><span class="main">,</span> <span class="bound">inx1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">t2</span><span class="main">,</span> <span class="bound">u2</span><span class="main">)</span><span class="main">,</span> <span class="bound">io2</span><span class="main">,</span> <span class="bound">inx2</span><span class="main">)</span><span class="main">.</span>
                                                  <span class="main">(</span><span class="main">(</span><span class="main">(</span>remove_guards_add_update <span class="bound">t1</span> <span class="bound">inx1</span> <span class="bound">newReg</span><span class="main">,</span> <span class="bound">u1</span><span class="main">)</span><span class="main">,</span> <span class="bound">io1</span><span class="main">,</span> <span class="bound">inx1</span><span class="main">)</span><span class="main">,</span>
                                                    <span class="main">(</span>generalise_input <span class="bound">t2</span> <span class="bound">newReg</span> <span class="bound">inx2</span><span class="main">,</span> <span class="bound">u2</span><span class="main">)</span><span class="main">,</span> <span class="bound">io2</span><span class="main">,</span> <span class="bound">inx2</span><span class="main">)</span><span class="main">)</span> <span class="bound">relevant</span><span class="main">;</span>
                                   <span class="bound">comparisons</span> <span class="main">=</span> zip <span class="bound">relevant</span> <span class="bound">replacements</span><span class="main">;</span>
                                   <span class="bound">stripped_replacements</span> <span class="main">=</span> map strip_uids <span class="bound">replacements</span><span class="main">;</span>
                                   <span class="bound">to_replace</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> structural_count <span class="main">(</span>strip_uids <span class="bound">s</span><span class="main">)</span> <span class="bound">stripped_replacements</span> <span class="main">&gt;</span> <span class="main">1</span><span class="main">)</span> <span class="bound">comparisons</span> <span class="keyword1">in</span>
                                <span class="keyword1">if</span> <span class="bound">to_replace</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span><span class="main">(</span>generalise_transitions <span class="bound">to_replace</span> <span class="free"><span class="bound"><span class="entity">old</span></span></span><span class="main">)</span><span class="main">)</span>
                              <span class="main">)</span>"</span></span>

<span class="comment1">(* type_synonym update_modifier = "transition ⇒ transition ⇒ nat ⇒ iEFSM ⇒ iEFSM ⇒ (iEFSM × (nat ⇒ nat) × (nat ⇒ nat)) option" *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">heuristic_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"log <span class="main">⇒</span> update_modifier"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">heuristic_2</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> modify_2 <span class="main">(</span>find_intertrace_matches <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> None <span class="main">|</span>
    Some <span class="bound">e</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">(</span>tm <span class="bound">e</span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="bound">e</span> <span class="keyword1">else</span> None
  <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> ioTag.In

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Store_Reuse_Subsumption">
<div class="head">
<h1>Theory Store_Reuse_Subsumption</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Store and Reuse Subsumption›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory provides proofs of various properties of the \emph{store and reuse} heuristic,
including the preconditions necessary for the transitions it introduces to directly subsume their
ungeneralised counterparts.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Store_Reuse_Subsumption
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Store_Reuse">Store_Reuse</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-generalisation_of_preserves"><span class="command">lemma</span></span> generalisation_of_preserves<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span>
    Label <span class="free">t</span> <span class="main">=</span> Label <span class="free">t'</span> <span class="main">∧</span>
    Arity <span class="free">t</span> <span class="main">=</span> Arity <span class="free">t'</span> <span class="main">∧</span>
    <span class="main">(</span>Outputs <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Outputs <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_generalisation_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> remove_guard_add_update_preserves <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Store_Reuse_Subsumption-is_generalisation_of_guard_subset"><span class="command">lemma</span></span> is_generalisation_of_guard_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span> set <span class="main">(</span>Guards <span class="free">t'</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_generalisation_of_def remove_guard_add_update_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-is_generalisation_of_medial"><span class="command">lemma</span></span> is_generalisation_of_medial<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span>
   can_take_transition <span class="free">t</span> <span class="free">ip</span> <span class="free">rg</span> <span class="main">⟶</span> can_take_transition <span class="free">t'</span> <span class="free">ip</span> <span class="free">rg</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_generalisation_of_guard_subset can_take_subset generalisation_of_preserves
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> can_take_def can_take_transition_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-is_generalisation_of_preserves_reg"><span class="command">lemma</span></span> is_generalisation_of_preserves_reg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span>
   evaluate_updates <span class="free">t</span> <span class="free">ia</span> <span class="free">c</span> <span class="main">$</span> <span class="free">r</span> <span class="main">=</span> <span class="free">c</span> <span class="main">$</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_generalisation_of_def r_not_updated_stays_the_same<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-apply_updates_foldr"><span class="command">lemma</span></span> apply_updates_foldr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"apply_updates <span class="free">u</span> <span class="free">old</span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">h</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">(</span>fst <span class="bound">h</span> <span class="main">$:=</span> aval <span class="main">(</span>snd <span class="bound">h</span><span class="main">)</span> <span class="free">old</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_updates_def foldr_conv_fold<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-is_generalisation_of_preserves_reg_2"><span class="command">lemma</span></span> is_generalisation_of_preserves_reg_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gen<span class="main">:</span> <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="free">i</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dif<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ra</span> <span class="main">≠</span> <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_updates <span class="free">t</span> <span class="free">ia</span> <span class="free">c</span> <span class="main">$</span> <span class="free">ra</span> <span class="main">=</span> apply_updates <span class="main">(</span>Updates <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">ia</span> <span class="free">c</span><span class="main">)</span> <span class="free">c</span> <span class="main">$</span> <span class="free">ra</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_updates_def is_generalisation_of_def remove_guard_add_update_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fold.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_updates_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> apply_updates_cons<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-is_generalisation_of_apply_guards"><span class="command">lemma</span></span> is_generalisation_of_apply_guards<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span>
   apply_guards <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span> <span class="free">j</span> <span class="main">⟹</span>
   apply_guards <span class="main">(</span>Guards <span class="free">t'</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_generalisation_of_guard_subset apply_guards_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If we drop the guard and add an update, and the updated register is undefined in the context,
c, then the generalised transition subsumes the specific one.›</span></span>
<span class="keyword1" id="Store_Reuse_Subsumption-is_generalisation_of_subsumes_original"><span class="command">lemma</span></span> is_generalisation_of_subsumes_original<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span>
   <span class="free">c</span> <span class="main">$</span> <span class="free">r</span> <span class="main">=</span> None <span class="main">⟹</span>
   subsumes <span class="free">t'</span> <span class="free">c</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def generalisation_of_preserves can_take_transition_def can_take_def posterior_separate_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_generalisation_of_apply_guards is_generalisation_of_preserves_reg is_generalisation_of_preserves_reg_2<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-generalise_output_posterior"><span class="command">lemma</span></span> generalise_output_posterior<span class="main">:</span>
  <span class="quoted"><span class="quoted">"posterior <span class="main">(</span>generalise_output <span class="free">t</span> <span class="free">p</span> <span class="free">r</span><span class="main">)</span> <span class="free">i</span> <span class="free">ra</span> <span class="main">=</span> posterior <span class="free">t</span> <span class="free">i</span> <span class="free">ra</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_def generalise_output_preserves posterior_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-generalise_output_eq"><span class="command">lemma</span></span> generalise_output_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Outputs <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="free">r</span> <span class="main">=</span> L <span class="free">v</span> <span class="main">⟹</span>
   <span class="free">c</span> <span class="main">$</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span>
   evaluate_outputs <span class="free">t</span> <span class="free">i</span> <span class="free">c</span> <span class="main">=</span> apply_outputs <span class="main">(</span>list_update <span class="main">(</span>Outputs <span class="free">t</span><span class="main">)</span> <span class="free">r</span> <span class="main">(</span>V <span class="main">(</span>R <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_outputs_preserves_length<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> j <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">r</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_outputs_literal apply_outputs_preserves_length apply_outputs_register<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_outputs_preserves_length apply_outputs_unupdated<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This shows that if we can guarantee that the value of a particular register is the literal
output then the generalised output subsumes the specific output.›</span></span>
<span class="keyword1" id="Store_Reuse_Subsumption-generalise_output_subsumes_original"><span class="command">lemma</span></span> generalise_output_subsumes_original<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Outputs <span class="free">t</span> <span class="main">!</span> <span class="free">r</span> <span class="main">=</span> L <span class="free">v</span> <span class="main">⟹</span>
   <span class="free">c</span> <span class="main">$</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span>
   subsumes <span class="main">(</span>generalise_output <span class="free">t</span> <span class="free">p</span> <span class="free">r</span><span class="main">)</span> <span class="free">c</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_transition_def generalise_output_def generalise_output_eq subsumes_def<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">stored_reused_aux_per_reg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stored_reused_aux_per_reg</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> is_generalised_output_of <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span>
      Some <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
       None
  <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">stored_reused_aux_per_reg</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> is_generalised_output_of <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span>
      Some <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="free">stored_reused_aux_per_reg</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">stored_reused_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stored_reused_aux</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">0</span> <span class="main">=</span> stored_reused_aux_per_reg <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">stored_reused_aux</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> stored_reused_aux_per_reg <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
                                          Some <span class="bound">x</span> <span class="main">⇒</span> Some <span class="bound">x</span> <span class="main">|</span>
                                          None <span class="main">⇒</span> <span class="free">stored_reused_aux</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
                                        <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">stored_reused</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stored_reused</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> stored_reused_aux <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>max <span class="main">(</span>Transition.total_max_reg <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>Transition.total_max_reg <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>length <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-stored_reused_aux_is_generalised_output_of"><span class="command">lemma</span></span> stored_reused_aux_is_generalised_output_of<span class="main">:</span>
<span class="quoted"><span class="quoted">"stored_reused_aux <span class="free">t'</span> <span class="free">t</span> <span class="free">mr</span> <span class="free">mp</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
   is_generalised_output_of <span class="free">t'</span> <span class="free">t</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mp</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.inject prod.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">mp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"is_generalised_output_of <span class="free">t'</span> <span class="free">t</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="skolem">mp</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">mr</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mp</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.inject prod.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">mp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"stored_reused_aux_per_reg <span class="free">t'</span> <span class="free">t</span> <span class="skolem">mr</span> <span class="main">(</span>Suc <span class="skolem">mp</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"is_generalised_output_of <span class="free">t'</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">mr</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">mp</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"is_generalised_output_of <span class="free">t'</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">mr</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">mp</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-stored_reused_is_generalised_output_of"><span class="command">lemma</span></span> stored_reused_is_generalised_output_of<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stored_reused <span class="free">t'</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
   is_generalised_output_of <span class="free">t'</span> <span class="free">t</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stored_reused_def stored_reused_aux_is_generalised_output_of<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-is_generalised_output_of_subsumes"><span class="command">lemma</span></span> is_generalised_output_of_subsumes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_generalised_output_of <span class="free">t'</span> <span class="free">t</span> <span class="free">r</span> <span class="free">p</span> <span class="main">⟹</span>
   nth <span class="main">(</span>Outputs <span class="free">t</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> L <span class="free">v</span> <span class="main">⟹</span>
   <span class="free">c</span> <span class="main">$</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span>
   subsumes <span class="free">t'</span> <span class="free">c</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def generalise_output_preserves can_take_transition_def can_take_def posterior_separate_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalise_output_def generalise_output_eq is_generalised_output_of_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-lists_neq_if"><span class="command">lemma</span></span> lists_neq_if<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">l'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">≠</span> <span class="free">l'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Store_Reuse_Subsumption-is_generalised_output_of_does_not_subsume"><span class="command">lemma</span></span> is_generalised_output_of_does_not_subsume<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_generalised_output_of <span class="free">t'</span> <span class="free">t</span> <span class="free">r</span> <span class="free">p</span> <span class="main">⟹</span>
   <span class="free">p</span> <span class="main">&lt;</span> length <span class="main">(</span>Outputs <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   nth <span class="main">(</span>Outputs <span class="free">t</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> L <span class="free">v</span> <span class="main">⟹</span>
   <span class="free">c</span> <span class="main">$</span> <span class="free">r</span> <span class="main">≠</span> Some <span class="free">v</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">⟹</span>
   <span class="main">¬</span>subsumes <span class="free">t'</span> <span class="free">c</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bad_outputs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lists_neq_if<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_generalised_output_of_def generalise_output_def apply_outputs_nth join_ir_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This shows that we can use the model checker to test whether the relevant register is the
correct value for direct subsumption.›</span></span>
<span class="keyword1" id="Store_Reuse_Subsumption-generalise_output_directly_subsumes_original"><span class="command">lemma</span></span> generalise_output_directly_subsumes_original<span class="main">:</span>
      <span class="quoted"><span class="quoted">"stored_reused <span class="free">t'</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span>
       nth <span class="main">(</span>Outputs <span class="free">t</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> L <span class="free">v</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">c1</span> <span class="bound">c2</span> <span class="bound">t</span><span class="main">.</span> obtains <span class="free">s</span> <span class="bound">c1</span> <span class="free">e1</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">∧</span> obtains <span class="free">s'</span> <span class="bound">c2</span> <span class="free">e2</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="bound">c2</span> <span class="main">$</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">⟹</span>
       directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">t'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directly_subsumes_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_generalised_output_of_subsumes stored_reused_aux_is_generalised_output_of stored_reused_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">generalise_output_context_check</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span>
<span class="main">(</span><span class="main">∀</span><span class="bound">c1</span> <span class="bound">c2</span> <span class="bound">t</span><span class="main">.</span> obtains <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">c1</span> <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">∧</span> obtains <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">c2</span> <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="bound">c2</span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-generalise_output_context_check_directly_subsumes_original"><span class="command">lemma</span></span> generalise_output_context_check_directly_subsumes_original<span class="main">:</span>
      <span class="quoted"><span class="quoted">"stored_reused <span class="free">t'</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span>
       nth <span class="main">(</span>Outputs <span class="free">t</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> L <span class="free">v</span> <span class="main">⟹</span>
       generalise_output_context_check <span class="free">v</span> <span class="free">r</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">e1</span> <span class="free">e2</span> <span class="main">⟹</span>
       directly_subsumes <span class="main">(</span>tm <span class="free">e1</span><span class="main">)</span> <span class="main">(</span>tm <span class="free">e2</span><span class="main">)</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">t'</span> <span class="free">t</span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalise_output_context_check_def generalise_output_directly_subsumes_original<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">generalise_output_direct_subsumption</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">generalise_output_direct_subsumption</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> stored_reused <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> False <span class="main">|</span>
    Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> nth <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="bound">p</span> <span class="keyword1">of</span>
        L <span class="bound">v</span> <span class="main">⇒</span> generalise_output_context_check <span class="bound">v</span> <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">|</span>
        <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This allows us to just run the two functions for quick subsumption.›</span></span>
<span class="keyword1" id="Store_Reuse_Subsumption-generalise_output_directly_subsumes_original_executable"><span class="command">lemma</span></span> generalise_output_directly_subsumes_original_executable<span class="main">:</span>
      <span class="quoted"><span class="quoted">"generalise_output_direct_subsumption <span class="free">t'</span> <span class="free">t</span> <span class="free">e</span> <span class="free">e'</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">⟹</span>
   directly_subsumes <span class="main">(</span>tm <span class="free">e</span><span class="main">)</span> <span class="main">(</span>tm <span class="free">e'</span><span class="main">)</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">t'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalise_output_direct_subsumption_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"stored_reused <span class="free">t'</span> <span class="free">t</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"Outputs <span class="free">t</span> <span class="main">!</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalise_output_context_check_directly_subsumes_original<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-original_does_not_subsume_generalised_output"><span class="command">lemma</span></span> original_does_not_subsume_generalised_output<span class="main">:</span>
      <span class="quoted"><span class="quoted">"stored_reused <span class="free">t'</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="free">r</span> <span class="main">&lt;</span> length <span class="main">(</span>Outputs <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
       nth <span class="main">(</span>Outputs <span class="free">t</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> L <span class="free">v</span> <span class="main">⟹</span>
       <span class="main">∃</span><span class="bound">a</span> <span class="bound">c1</span> <span class="bound">tt</span><span class="main">.</span> obtains <span class="free">s</span> <span class="bound">c1</span> <span class="free">e1</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">tt</span> <span class="main">∧</span> obtains <span class="free">s'</span> <span class="bound">a</span> <span class="free">e</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">tt</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">$</span> <span class="free">p</span> <span class="main">≠</span> Some <span class="free">v</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t</span> <span class="bound">i</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="main">¬</span>directly_subsumes <span class="free">e1</span> <span class="free">e</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">t'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directly_subsumes_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a c1 tt i
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> stored_reused_is_generalised_output_of<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span>
      is_generalised_output_of_does_not_subsume<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* t' is the generalised transition *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">input_i_stored_in_reg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">input_i_stored_in_reg</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_generalisation_of <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">input_i_stored_in_reg</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_generalisation_of <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">input_i_stored_in_reg</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* t' is the generalised transition *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">input_stored_in_reg_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">input_stored_in_reg_aux</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> input_i_stored_in_reg <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">input_stored_in_reg_aux</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> input_i_stored_in_reg <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span>
                                              None <span class="main">⇒</span> input_i_stored_in_reg <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">|</span>
                                              Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>
                                            <span class="main">)</span> "</span></span>

<span class="comment1">(* t' is the generalised transition *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">input_stored_in_reg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> iEFSM <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">input_stored_in_reg</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">case</span> input_stored_in_reg_aux <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>total_max_reg <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>Arity <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>Arity <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> None <span class="main">|</span>
      Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">if</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">=</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span>
          Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>
        <span class="keyword1">else</span> None
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">initially_undefined_context_check</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initially_undefined_context_check</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">a</span><span class="main">.</span> obtains <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-no_incoming_to_zero"><span class="command">lemma</span></span> no_incoming_to_zero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">|∈|</span><span class="free">e</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">to</span> <span class="main">⟹</span>
       <span class="main">(</span><span class="free">aaa</span><span class="main">,</span> <span class="free">ba</span><span class="main">)</span> <span class="main">|∈|</span> possible_steps <span class="free">e</span> <span class="free">s</span> <span class="free">d</span> <span class="free">l</span> <span class="free">i</span> <span class="main">⟹</span>
       <span class="free">aaa</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible_steps_def ffilter_finsert<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa bb
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> Label <span class="skolem">b</span> <span class="main">=</span> <span class="free">l</span> <span class="main">∧</span> length <span class="free">i</span> <span class="main">=</span> Arity <span class="skolem">b</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">d</span><span class="main">)</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-no_return_to_zero"><span class="command">lemma</span></span> no_return_to_zero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">|∈|</span><span class="free">e</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">to</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">r</span> <span class="bound">n</span><span class="main">.</span> <span class="main">¬</span> visits <span class="main">0</span> <span class="free">e</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="bound">r</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_further_steps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> visits.cases<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> no_incoming_to_zero not0_implies_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-no_accepting_return_to_zero"><span class="command">lemma</span></span> no_accepting_return_to_zero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">|∈|</span><span class="free">e</span><span class="main">.</span> <span class="bound">to</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
   recognises <span class="main">(</span><span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">¬</span>visits <span class="main">0</span> <span class="main">(</span><span class="free">e</span><span class="main">)</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> visits.cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> no_incoming_to_zero no_return_to_zero old.nat.exhaust<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-no_return_to_zero_must_be_empty"><span class="command">lemma</span></span> no_return_to_zero_must_be_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">|∈|</span><span class="free">e</span><span class="main">.</span> <span class="bound">to</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
   obtains <span class="main">0</span> <span class="free">a</span> <span class="free">e</span> <span class="free">s</span> <span class="free">r</span> <span class="free">t</span> <span class="main">⟹</span>
   <span class="free">t</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obtains.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prodE fBexE list.inject no_further_steps no_incoming_to_zero unobtainable_if<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">no_illegal_updates</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> set <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> fst <span class="bound">u</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-input_stored_in_reg_aux_is_generalisation_aux"><span class="command">lemma</span></span> input_stored_in_reg_aux_is_generalisation_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"input_stored_in_reg_aux <span class="free">t'</span> <span class="free">t</span> <span class="free">mr</span> <span class="free">mi</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
   is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="free">i</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mi</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="main">0</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">mr</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">mr</span><span class="main">)</span> <span class="main">0</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="skolem">mr</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">mi</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="skolem">mi</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">mr</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">mr</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">mi</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"input_i_stored_in_reg <span class="free">t'</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">mr</span><span class="main">)</span> <span class="skolem">mi</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="skolem">mr</span> <span class="main">(</span>Suc <span class="skolem">mi</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-input_stored_in_reg_is_generalisation"><span class="command">lemma</span></span> input_stored_in_reg_is_generalisation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"input_stored_in_reg <span class="free">t'</span> <span class="free">t</span> <span class="free">e</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="free">i</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input_stored_in_reg_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"input_stored_in_reg_aux <span class="free">t'</span> <span class="free">t</span> <span class="main">(</span>total_max_reg <span class="free">e</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>Arity <span class="free">t</span><span class="main">)</span> <span class="main">(</span>Arity <span class="free">t'</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input_stored_in_reg_aux_is_generalisation_aux<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*
  This allows us to call these three functions for direct subsumption of generalised
*)</span>
<span class="keyword1" id="Store_Reuse_Subsumption-generalised_directly_subsumes_original"><span class="command">lemma</span></span> generalised_directly_subsumes_original<span class="main">:</span>
  <span class="quoted"><span class="quoted">"input_stored_in_reg <span class="free">t'</span> <span class="free">t</span> <span class="free">e</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
   initially_undefined_context_check <span class="main">(</span>tm <span class="free">e</span><span class="main">)</span> <span class="free">r</span> <span class="free">s'</span> <span class="main">⟹</span>
   no_illegal_updates <span class="free">t</span> <span class="free">r</span> <span class="main">⟹</span>
   directly_subsumes <span class="main">(</span>tm <span class="free">e1</span><span class="main">)</span> <span class="main">(</span>tm <span class="free">e</span><span class="main">)</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">t'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directly_subsumes_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> finfun_const.rep_eq input_stored_in_reg_is_generalisation is_generalisation_of_subsumes_original<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_generalisation_of_subsumes_original<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> input_stored_in_reg_is_generalisation <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> initially_undefined_context_check_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">drop_guard_add_update_direct_subsumption</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> iEFSM <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">drop_guard_add_update_direct_subsumption</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">case</span> input_stored_in_reg <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> False <span class="main">|</span>
      Some <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">if</span> no_illegal_updates <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">r</span> <span class="keyword1">then</span>
          initially_undefined_context_check <span class="main">(</span>tm <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span>
        <span class="keyword1">else</span> False
    <span class="main">)</span>"</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-drop_guard_add_update_direct_subsumption_implies_direct_subsumption"><span class="command">lemma</span></span> drop_guard_add_update_direct_subsumption_implies_direct_subsumption<span class="main">:</span>
  <span class="quoted"><span class="quoted">"drop_guard_add_update_direct_subsumption <span class="free">t'</span> <span class="free">t</span> <span class="free">e</span> <span class="free">s'</span> <span class="main">⟹</span>
   directly_subsumes <span class="main">(</span>tm <span class="free">e1</span><span class="main">)</span> <span class="main">(</span>tm <span class="free">e</span><span class="main">)</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">t'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_guard_add_update_direct_subsumption_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"input_stored_in_reg <span class="free">t'</span> <span class="free">t</span> <span class="free">e</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"no_illegal_updates <span class="free">t</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generalised_directly_subsumes_original<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-is_generalisation_of_constrains_input"><span class="command">lemma</span></span> is_generalisation_of_constrains_input<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> gexp.Eq <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_generalisation_of_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-is_generalisation_of_derestricts_input"><span class="command">lemma</span></span> is_generalisation_of_derestricts_input<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t'</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_generalisation_of_def remove_guard_add_update_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-is_generalisation_of_same_arity"><span class="command">lemma</span></span> is_generalisation_of_same_arity<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span> Arity <span class="free">t</span> <span class="main">=</span> Arity <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_generalisation_of_def remove_guard_add_update_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-is_generalisation_of_i_lt_arity"><span class="command">lemma</span></span> is_generalisation_of_i_lt_arity<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_generalisation_of <span class="free">t'</span> <span class="free">t</span> <span class="free">i</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> Arity <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_generalisation_of_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> can_take_transition <span class="free">t</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">∧</span> <span class="main">¬</span> can_take_transition <span class="free">t'</span> <span class="bound">i</span> <span class="free">r</span> <span class="main">⟹</span>
       Label <span class="free">t</span> <span class="main">=</span> Label <span class="free">t'</span> <span class="main">⟹</span>
       Arity <span class="free">t</span> <span class="main">=</span> Arity <span class="free">t'</span> <span class="main">⟹</span>
       subsumes <span class="free">t'</span> <span class="free">r</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def posterior_separate_def can_take_transition_def<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-input_not_constrained_aval_swap_inputs"><span class="command">lemma</span></span> input_not_constrained_aval_swap_inputs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> aexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="main">(</span>list_update <span class="free">i</span> <span class="free">v</span> <span class="free">x</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> aexp_induct_separate_V_cases<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> aexp_constrains.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> aval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> input2state_nth input2state_out_of_bounds join_ir_def length_list_update not_le nth_list_update_neq vname.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> join_ir_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Store_Reuse_Subsumption-aval_unconstrained"><span class="command">lemma</span></span> aval_unconstrained<span class="main">:</span>
  <span class="quoted"><span class="quoted">" <span class="main">¬</span> aexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ia</span> <span class="main">⟹</span>
  <span class="free">v</span> <span class="main">=</span> <span class="free">ia</span> <span class="main">!</span> <span class="free">i</span> <span class="main">⟹</span>
  <span class="free">v'</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">⟹</span>
  aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">ia</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="main">(</span>list_update <span class="free">ia</span> <span class="free">i</span> <span class="free">v'</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> aexp_induct_separate_V_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> input_not_constrained_aval_swap_inputs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-input_not_constrained_gval_swap_inputs"><span class="command">lemma</span></span> input_not_constrained_gval_swap_inputs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> gexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   gval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> gval <span class="free">a</span> <span class="main">(</span>join_ir <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">v</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bc <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> gval.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> input_not_constrained_aval_swap_inputs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Gt <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> input_not_constrained_aval_swap_inputs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>In <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="free">i</span> <span class="free">c</span> <span class="skolem">x1a</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">v</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">x1a</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> aexp.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> aexp_constrains.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> aval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> input_not_constrained_aval_swap_inputs option.discI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="free">i</span> <span class="free">c</span> <span class="skolem">x1a</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">v</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">x1a</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> aexp.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> aexp_constrains.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> aval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> input_not_constrained_aval_swap_inputs option.discI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> datastate<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> input2state_within_bounds join_ir_R join_ir_nth le_less_linear list_update_beyond nth_list_update option.inject vname.case<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> vname.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If input $i$ is stored in register $r$ by transition $t$ then if we can take transition,
$t^\prime$ then for some input $ia$ then transition $t$ does not subsume $t^\prime$.›</span></span>
<span class="keyword1" id="Store_Reuse_Subsumption-input_stored_in_reg_not_subsumed"><span class="command">lemma</span></span> input_stored_in_reg_not_subsumed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"input_stored_in_reg <span class="free">t'</span> <span class="free">t</span> <span class="free">e</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">ia</span><span class="main">.</span> can_take_transition <span class="free">t'</span> <span class="bound">ia</span> <span class="free">c</span> <span class="main">⟹</span>
   <span class="main">¬</span> subsumes <span class="free">t</span> <span class="free">c</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> input_stored_in_reg_is_generalisation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> is_generalisation_of_constrains_input<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> is_generalisation_of_derestricts_input<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bad_guards<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ia v
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_transition_def can_take_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x1
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"list_update <span class="skolem">ia</span> <span class="free">i</span> <span class="main">(</span>Str <span class="main">_</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> input_not_constrained_gval_swap_inputs<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_def Bex_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Eq <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="skolem">x1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def input2state_nth is_generalisation_of_i_lt_arity str_not_num<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"list_update <span class="skolem">ia</span> <span class="free">i</span> <span class="main">(</span>Num <span class="main">_</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> input_not_constrained_gval_swap_inputs<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_def Bex_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Eq <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>value.Str <span class="skolem">x2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def input2state_nth is_generalisation_of_i_lt_arity str_not_num<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-aval_updated"><span class="command">lemma</span></span> aval_updated<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">U</span> <span class="main">⟹</span>
   <span class="free">r</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span>removeAll <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   apply_updates <span class="free">U</span> <span class="free">s</span> <span class="free">c</span> <span class="main">$</span> <span class="free">r</span> <span class="main">=</span> aval <span class="free">u</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">U</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">U</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> apply_updates_foldr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Store_Reuse_Subsumption-can_take_append_subset"><span class="command">lemma</span></span> can_take_append_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>Guards <span class="free">t'</span><span class="main">)</span> <span class="main">⊂</span> set <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
can_take <span class="free">a</span> <span class="main">(</span>Guards <span class="free">t</span> <span class="main">@</span> Guards <span class="free">t'</span><span class="main">)</span> <span class="free">ia</span> <span class="free">c</span> <span class="main">=</span> can_take <span class="free">a</span> <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span> <span class="free">ia</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apply_guards_append apply_guards_subset_append can_take_def dual_order.strict_implies_order<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Transitions of the form $t = \textit{select}:1[i_0=x]$ do not subsume transitions
of the form $t^\prime = select:1/r_1:=i_1$.›</span></span>
<span class="keyword1" id="Store_Reuse_Subsumption-general_not_subsume_orig"><span class="command">lemma</span></span> general_not_subsume_orig<span class="main">:</span> <span class="quoted"><span class="quoted">"Arity <span class="free">t'</span> <span class="main">=</span> Arity <span class="free">t</span> <span class="main">⟹</span>
   set <span class="main">(</span>Guards <span class="free">t'</span><span class="main">)</span> <span class="main">⊂</span> set <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Updates <span class="free">t'</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">r</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span>removeAll <span class="main">(</span><span class="free">r</span><span class="main">,</span> V <span class="main">(</span>I <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">r</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span>Updates <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">⟹</span>
   <span class="free">c</span> <span class="main">$</span> <span class="free">r</span> <span class="main">=</span> None <span class="main">⟹</span>
   <span class="free">i</span> <span class="main">&lt;</span> Arity <span class="free">t</span> <span class="main">⟹</span>
   <span class="main">¬</span> subsumes <span class="free">t</span> <span class="free">c</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inconsistent_updates<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ia
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"evaluate_updates <span class="free">t</span> <span class="skolem">ia</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"apply_updates <span class="main">(</span>Updates <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="skolem">ia</span> <span class="free">c</span><span class="main">)</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ia</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> can_take_def can_take_transition_def can_take_subset posterior_separate_def psubsetE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_not_updated_stays_the_same<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aval_updated can_take_transition_def can_take_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-input_stored_in_reg_updates_reg"><span class="command">lemma</span></span> input_stored_in_reg_updates_reg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"input_stored_in_reg <span class="free">t2</span> <span class="free">t1</span> <span class="free">a</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">r</span><span class="main">,</span> V <span class="main">(</span>I <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Updates <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> input_stored_in_reg_is_generalisation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t2</span></span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_generalisation_of_def remove_guard_add_update_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">diff_outputs_ctx</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">then</span> False <span class="keyword1">else</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">c1</span> <span class="bound">r</span><span class="main">.</span> obtains <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="bound">c1</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">p</span> <span class="main">∧</span>
       obtains <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">p</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="bound">i</span> <span class="bound">r</span> <span class="main">∧</span> can_take_transition <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="bound">i</span> <span class="bound">r</span> <span class="main">∧</span>
       evaluate_outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="bound">i</span> <span class="bound">r</span> <span class="main">≠</span> evaluate_outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-diff_outputs_direct_subsumption"><span class="command">lemma</span></span> diff_outputs_direct_subsumption<span class="main">:</span>
  <span class="quoted"><span class="quoted">"diff_outputs_ctx <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟹</span>
   <span class="main">¬</span> directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directly_subsumes_def diff_outputs_ctx_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"Outputs <span class="free">t1</span> <span class="main">=</span> Outputs <span class="free">t2</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ c1 r
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">c1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> bad_outputs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">not_updated</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">not_updated</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-not_updated"><span class="command">lemma</span></span> not_updated<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"not_updated <span class="free">r</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_updates <span class="main">(</span>Updates <span class="free">t2</span><span class="main">)</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">$</span> <span class="free">r</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">$</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> not_updated_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t2</span><span class="main">.</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">r</span><span class="main">)</span> <span class="bound">t2</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span>
   apply_updates <span class="bound">t2</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">$</span> <span class="free">r</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">$</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> r_not_updated_stays_the_same<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> filter_empty_conv imageE prod.case_eq_if<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_updated_def not_updated_aux<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-one_extra_update_subsumes"><span class="command">lemma</span></span> one_extra_update_subsumes<span class="main">:</span> <span class="quoted"><span class="quoted">"Label <span class="free">t1</span> <span class="main">=</span> Label <span class="free">t2</span> <span class="main">⟹</span>
   Arity <span class="free">t1</span> <span class="main">=</span> Arity <span class="free">t2</span> <span class="main">⟹</span>
   set <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span> <span class="main">⟹</span>
   Outputs <span class="free">t1</span> <span class="main">=</span> Outputs <span class="free">t2</span> <span class="main">⟹</span>
   Updates <span class="free">t1</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">#</span> Updates <span class="free">t2</span> <span class="main">⟹</span>
   not_updated <span class="free">r</span> <span class="free">t2</span> <span class="main">⟹</span>
   <span class="free">c</span> <span class="main">$</span> <span class="free">r</span> <span class="main">=</span> None <span class="main">⟹</span>
   subsumes <span class="free">t1</span> <span class="free">c</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def posterior_separate_def can_take_transition_def can_take_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apply_guards_subset apply_updates_cons not_updated<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-one_extra_update_directly_subsumes"><span class="command">lemma</span></span> one_extra_update_directly_subsumes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Label <span class="free">t1</span> <span class="main">=</span> Label <span class="free">t2</span> <span class="main">⟹</span>
   Arity <span class="free">t1</span> <span class="main">=</span> Arity <span class="free">t2</span> <span class="main">⟹</span>
   set <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span> <span class="main">⟹</span>
   Outputs <span class="free">t1</span> <span class="main">=</span> Outputs <span class="free">t2</span> <span class="main">⟹</span>
   Updates <span class="free">t1</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>Updates <span class="free">t2</span><span class="main">)</span> <span class="main">⟹</span>
   not_updated <span class="free">r</span> <span class="free">t2</span> <span class="main">⟹</span>
   initially_undefined_context_check <span class="free">e2</span> <span class="free">r</span> <span class="free">s2</span> <span class="main">⟹</span>
   directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directly_subsumes_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> one_extra_update_subsumes finfun_const_apply<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> initially_undefined_context_check_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> obtainable_def one_extra_update_subsumes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">one_extra_update</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
  Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
  set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">∧</span>
  Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
  Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
  tl <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span>hd <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">r</span> <span class="main">∧</span>
  not_updated <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
  initially_undefined_context_check <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>
<span class="main">)</span>"</span></span>

<span class="keyword1" id="Store_Reuse_Subsumption-must_be_an_update"><span class="command">lemma</span></span> must_be_an_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">U1</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
   fst <span class="main">(</span>hd <span class="free">U1</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">∧</span> tl <span class="free">U1</span> <span class="main">=</span> <span class="free">U2</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">U1</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">U2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_fst_iff hd_Cons_tl<span class="main">)</span>

<span class="keyword1" id="Store_Reuse_Subsumption-one_extra_update_direct_subsumption"><span class="command">lemma</span></span> one_extra_update_direct_subsumption<span class="main">:</span>
  <span class="quoted"><span class="quoted">"one_extra_update <span class="free">t1</span> <span class="free">t2</span> <span class="free">s2</span> <span class="free">e2</span> <span class="main">⟹</span> directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> must_be_an_update<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Updates <span class="free"><span class="free">t1</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Updates <span class="free"><span class="free">t2</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_extra_update_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_fst_iff hd_Cons_tl one_extra_update_directly_subsumes<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Increment_Reset">
<div class="head">
<h1>Theory Increment_Reset</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Increment and Reset›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The ``increment and reset'' heuristic proposed in \cite{foster2019} is a naive way of
introducing an incrementing register into a model. This this theory implements that heuristic.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Increment_Reset
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Inference">../Inference</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">initialiseReg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> nat <span class="main">⇒</span> transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initialiseReg</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">newReg</span></span></span> <span class="main">=</span> <span class="main">⦇</span>Label <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> Arity <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> Guards <span class="main">=</span> Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> Outputs <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> Updates <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">newReg</span></span></span><span class="main">,</span> L <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">#</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">guardMatch</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">n'</span><span class="main">.</span> Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">[</span>gexp.Eq <span class="main">(</span>V <span class="main">(</span>vname.I <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">∧</span> Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">[</span>gexp.Eq <span class="main">(</span>V <span class="main">(</span>vname.I <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="bound">n'</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">outputMatch</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span> <span class="bound">m'</span><span class="main">.</span> Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">[</span>L <span class="main">(</span>Num <span class="bound">m</span><span class="main">)</span><span class="main">]</span> <span class="main">∧</span> Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">[</span>L <span class="main">(</span>Num <span class="bound">m'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Increment_Reset-guard_match_commute"><span class="command">lemma</span></span> guard_match_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"guardMatch <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span> guardMatch <span class="free">t2</span> <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> guardMatch_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Increment_Reset-guard_match_length"><span class="command">lemma</span></span> guard_match_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">∨</span> length <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">¬</span> guardMatch <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> guardMatch_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert_increment</span> <span class="main">::</span> <span class="quoted">update_modifier</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_increment</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
     <span class="bound">t1</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">;</span>
     <span class="bound">t2</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="keyword1">in</span>
     <span class="keyword1">if</span> guardMatch <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">∧</span> outputMatch <span class="bound">t1</span> <span class="bound">t2</span> <span class="keyword1">then</span> <span class="keyword1">let</span>
          <span class="bound">r</span> <span class="main">=</span> <span class="keyword1">case</span> max_reg <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="bound">r</span> <span class="main">⇒</span> <span class="bound">r</span><span class="main">+</span> <span class="main">1</span><span class="main">;</span>
          <span class="bound">newReg</span> <span class="main">=</span> R <span class="bound">r</span><span class="main">;</span>
          <span class="bound">newT1</span> <span class="main">=</span> <span class="main">⦇</span>Label <span class="main">=</span> Label <span class="bound">t1</span><span class="main">,</span> Arity <span class="main">=</span> Arity <span class="bound">t1</span><span class="main">,</span> Guards <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> Outputs <span class="main">=</span> <span class="main">[</span>Plus <span class="main">(</span>V <span class="bound">newReg</span><span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> Updates<span class="main">=</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> Plus <span class="main">(</span>V <span class="bound">newReg</span><span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">#</span>Updates <span class="bound">t1</span><span class="main">)</span><span class="main">⦈</span><span class="main">;</span>
          <span class="bound">newT2</span> <span class="main">=</span> <span class="main">⦇</span>Label <span class="main">=</span> Label <span class="bound">t2</span><span class="main">,</span> Arity <span class="main">=</span> Arity <span class="bound">t2</span><span class="main">,</span> Guards <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> Outputs <span class="main">=</span> <span class="main">[</span>Plus <span class="main">(</span>V <span class="bound">newReg</span><span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> Updates<span class="main">=</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> Plus <span class="main">(</span>V <span class="bound">newReg</span><span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">#</span>Updates <span class="bound">t2</span><span class="main">)</span><span class="main">⦈</span><span class="main">;</span>
          <span class="bound">to_initialise</span> <span class="main">=</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">to</span> <span class="main">=</span> dest <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">∨</span> <span class="bound">to</span> <span class="main">=</span> dest <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≠</span> <span class="bound">t1</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≠</span> <span class="bound">t2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">new</span></span></span><span class="main">;</span>
          <span class="bound">initialisedTrans</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">uid</span><span class="main">,</span> initialiseReg <span class="bound">t</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">to_initialise</span><span class="main">;</span>
          <span class="bound">initialised</span> <span class="main">=</span> replace_transitions <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">(</span>sorted_list_of_fset <span class="bound">initialisedTrans</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">rep</span> <span class="main">=</span> replace_transitions <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">,</span> <span class="bound">newT1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2ID</span></span></span><span class="main">,</span> <span class="bound">newT2</span><span class="main">)</span><span class="main">]</span>
     <span class="keyword1">in</span>
          <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">(</span>tm <span class="bound">rep</span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="bound">rep</span> <span class="keyword1">else</span> None
     <span class="keyword1">else</span>
       None
     <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">struct_replace_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> transition <span class="main">⇒</span> transition <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">struct_replace_all</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
    <span class="bound">to_replace</span> <span class="main">=</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> same_structure <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">old</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
    <span class="bound">replacements</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">new</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">to_replace</span>
    <span class="keyword1">in</span>
    replace_transitions <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>sorted_list_of_fset <span class="bound">replacements</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Increment_Reset-output_match_symmetry"><span class="command">lemma</span></span> output_match_symmetry<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>outputMatch <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>outputMatch <span class="free">t2</span> <span class="free">t1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> outputMatch_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Increment_Reset-guard_match_symmetry"><span class="command">lemma</span></span> guard_match_symmetry<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>guardMatch <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>guardMatch <span class="free">t2</span> <span class="free">t1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> guardMatch_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert_increment_2</span> <span class="main">::</span> <span class="quoted">update_modifier</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_increment_2</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
     <span class="bound">t1</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">;</span>
     <span class="bound">t2</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="keyword1">in</span>
     <span class="keyword1">if</span> guardMatch <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">∧</span> outputMatch <span class="bound">t1</span> <span class="bound">t2</span> <span class="keyword1">then</span> <span class="keyword1">let</span>
          <span class="bound">r</span> <span class="main">=</span> <span class="keyword1">case</span> max_reg <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="bound">r</span> <span class="main">⇒</span> <span class="bound">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">;</span>
          <span class="bound">newReg</span> <span class="main">=</span> R <span class="bound">r</span><span class="main">;</span>
          <span class="bound">newT1</span> <span class="main">=</span> <span class="main">⦇</span>Label <span class="main">=</span> Label <span class="bound">t1</span><span class="main">,</span> Arity <span class="main">=</span> Arity <span class="bound">t1</span><span class="main">,</span> Guards <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> Outputs <span class="main">=</span> <span class="main">[</span>Plus <span class="main">(</span>V <span class="bound">newReg</span><span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> Updates<span class="main">=</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> Plus <span class="main">(</span>V <span class="bound">newReg</span><span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">#</span>Updates <span class="bound">t1</span><span class="main">)</span><span class="main">⦈</span><span class="main">;</span>
          <span class="bound">newT2</span> <span class="main">=</span> <span class="main">⦇</span>Label <span class="main">=</span> Label <span class="bound">t2</span><span class="main">,</span> Arity <span class="main">=</span> Arity <span class="bound">t2</span><span class="main">,</span> Guards <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> Outputs <span class="main">=</span> <span class="main">[</span>Plus <span class="main">(</span>V <span class="bound">newReg</span><span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> Updates<span class="main">=</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> Plus <span class="main">(</span>V <span class="bound">newReg</span><span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">#</span>Updates <span class="bound">t2</span><span class="main">)</span><span class="main">⦈</span><span class="main">;</span>
          <span class="bound">to_initialise</span> <span class="main">=</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">to</span> <span class="main">=</span> dest <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">∨</span> <span class="bound">to</span> <span class="main">=</span> dest <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≠</span> <span class="bound">t1</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≠</span> <span class="bound">t2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">new</span></span></span><span class="main">;</span>
          <span class="bound">initialisedTrans</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">uid</span><span class="main">,</span> initialiseReg <span class="bound">t</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">to_initialise</span><span class="main">;</span>
          <span class="bound">initialised</span> <span class="main">=</span> replace_transitions <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">(</span>sorted_list_of_fset <span class="bound">initialisedTrans</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">rep</span> <span class="main">=</span> struct_replace_all <span class="main">(</span>struct_replace_all <span class="bound">initialised</span> <span class="bound">t2</span> <span class="bound">newT2</span><span class="main">)</span> <span class="bound">t1</span> <span class="bound">newT1</span>
      <span class="keyword1">in</span>
          <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">(</span>tm <span class="bound">rep</span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="bound">rep</span> <span class="keyword1">else</span> None
     <span class="keyword1">else</span>
       None
     <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">guardMatch_alt_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">guardMatch_alt_2</span> <span class="main">[</span><span class="main">(</span>gexp.Eq <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">guardMatch_alt_2</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">outputMatch_alt_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname aexp list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">outputMatch_alt_2</span> <span class="main">[</span><span class="main">(</span>L <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">outputMatch_alt_2</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Same_Register">
<div class="head">
<h1>Theory Same_Register</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Same Register›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The \texttt{same\_register} heuristic aims to replace registers which are used in the same way.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Same_Register
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Inference">../Inference</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">replace_with</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replace_with</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">=</span> <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">tf</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">tf</span><span class="main">,</span>Transition.rename_regs <span class="main">(</span>id<span class="main">(</span><span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_if_same</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> <span class="main">(</span>transition_matrix <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_if_same</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_if_same</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">transitions</span> <span class="main">=</span> fimage <span class="main">(</span>snd <span class="main">∘</span> snd<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="main">∃</span><span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">|∈|</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">.</span> <span class="bound">t1</span> <span class="main">&lt;</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">(</span><span class="bound">transitions</span> <span class="main">|×|</span> <span class="bound">transitions</span><span class="main">)</span><span class="main">.</span>
      same_structure <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">∈</span> enumerate_regs <span class="bound">t1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">∈</span> enumerate_regs <span class="bound">t2</span>
    <span class="keyword1">then</span>
      <span class="keyword1">let</span> <span class="bound">newE</span> <span class="main">=</span> replace_with <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">(</span>tm <span class="bound">newE</span><span class="main">)</span> <span class="keyword1">then</span>
        <span class="free">merge_if_same</span> <span class="bound">newE</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span>
      <span class="keyword1">else</span>
        <span class="free">merge_if_same</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span>
    <span class="keyword1">else</span>
      <span class="free">merge_if_same</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_regs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> <span class="main">(</span>transition_matrix <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_regs</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">regs</span> <span class="main">=</span> all_regs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
      <span class="bound">reg_pairs</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span><span class="main">.</span> <span class="bound">r1</span> <span class="main">&lt;</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">(</span><span class="bound">regs</span> <span class="main">×</span> <span class="bound">regs</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">in</span>
    merge_if_same <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="bound">reg_pairs</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">same_register</span> <span class="main">::</span> <span class="quoted">update_modifier</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">same_register</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">new'</span> <span class="main">=</span> merge_regs <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">new'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="bound">new'</span>
   <span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Least_Upper_Bound">
<div class="head">
<h1>Theory Least_Upper_Bound</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Least Upper Bound›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The simplest way to merge a pair of transitions with identical outputs and updates is to
simply take the least upper bound of their \emph{guards}. This theory presents several variants on
this theme.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Least_Upper_Bound
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Inference">../Inference</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">literal_args</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">literal_args</span> <span class="main">(</span>Bc <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">literal_args</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">literal_args</span> <span class="main">(</span>In <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">literal_args</span> <span class="main">(</span>Eq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">literal_args</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">va</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">literal_args</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">literal_args</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∧</span> <span class="free">literal_args</span> <span class="free"><span class="bound"><span class="entity">va</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Least_Upper_Bound-literal_args_eq"><span class="command">lemma</span></span> literal_args_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"literal_args <span class="main">(</span>Eq <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">v</span> <span class="bound">l</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span>V <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span>L <span class="bound">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">all_literal_args</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> literal_args <span class="bound">g</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_in_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> value <span class="main">⇒</span> vname gexp list <span class="main">⇒</span> vname gexp list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_in_eq</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_in_eq</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">merge_in_eq</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_in_eq</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>remdups <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">merge_in_eq</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_in_eq</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">merge_in_eq</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_in_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> value list <span class="main">⇒</span> vname gexp list <span class="main">⇒</span> vname gexp list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_in_in</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_in_in</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>List.insert <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">merge_in_in</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_in_in</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>List.union <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">merge_in_in</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_in_in</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">merge_in_in</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_guards</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp list <span class="main">⇒</span> vname gexp list <span class="main">⇒</span> vname gexp list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_guards</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_guards</span> <span class="main">(</span><span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="main">=</span>  <span class="free">merge_guards</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>merge_in_eq <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_guards</span> <span class="main">(</span><span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="main">=</span> <span class="free">merge_guards</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>merge_in_in <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_guards</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">merge_guards</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The ``least upper bound'' (lob) heuristic simply disjoins the guards of two transitions with
identical outputs and updates.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lob_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> transition option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lob_aux</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span> Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span> all_literal_args <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∧</span> all_literal_args <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">then</span>
      Some <span class="main">⦇</span>Label <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> Arity <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> Guards <span class="main">=</span> remdups <span class="main">(</span>merge_guards <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Outputs <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> Updates <span class="main">=</span> Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">⦈</span>
     <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lob</span> <span class="main">::</span> <span class="quoted">update_modifier</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lob</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
     <span class="bound">t1</span> <span class="main">=</span> <span class="main">(</span>get_by_ids <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">)</span><span class="main">;</span>
     <span class="bound">t2</span> <span class="main">=</span> <span class="main">(</span>get_by_ids <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
     <span class="keyword1">case</span> lob_aux <span class="bound">t1</span> <span class="bound">t2</span> <span class="keyword1">of</span>
       None <span class="main">⇒</span> None <span class="main">|</span>
       Some <span class="bound">lob_t</span> <span class="main">⇒</span>
           Some <span class="main">(</span>replace_transitions <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">,</span> <span class="bound">lob_t</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2ID</span></span></span><span class="main">,</span> <span class="bound">lob_t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
   <span class="main">)</span>"</span></span>

<span class="keyword1" id="Least_Upper_Bound-lob_aux_some"><span class="command">lemma</span></span> lob_aux_some<span class="main">:</span> <span class="quoted"><span class="quoted">"Outputs <span class="free">t1</span> <span class="main">=</span> Outputs <span class="free">t2</span> <span class="main">⟹</span>
       Updates <span class="free">t1</span> <span class="main">=</span> Updates <span class="free">t2</span> <span class="main">⟹</span>
       all_literal_args <span class="free">t1</span> <span class="main">⟹</span>
       all_literal_args <span class="free">t2</span> <span class="main">⟹</span>
       Label <span class="free">t</span> <span class="main">=</span> Label <span class="free">t1</span> <span class="main">⟹</span>
       Arity <span class="free">t</span> <span class="main">=</span> Arity <span class="free">t1</span> <span class="main">⟹</span>
       Guards <span class="free">t</span> <span class="main">=</span> remdups <span class="main">(</span>merge_guards <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
       Outputs <span class="free">t</span> <span class="main">=</span> Outputs <span class="free">t1</span> <span class="main">⟹</span>
       Updates <span class="free">t</span> <span class="main">=</span> Updates <span class="free">t1</span> <span class="main">⟹</span>
       lob_aux <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lob_aux_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">has_corresponding</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> vname gexp list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">has_corresponding</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">[]</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_corresponding</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="keyword1">then</span> True <span class="keyword1">else</span> <span class="free">has_corresponding</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_corresponding</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="keyword1">then</span> True <span class="keyword1">else</span> <span class="free">has_corresponding</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_corresponding</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">∧</span> set <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">⊆</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> True <span class="keyword1">else</span> <span class="free">has_corresponding</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_corresponding</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">has_corresponding</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Least_Upper_Bound-no_corresponding_bc"><span class="command">lemma</span></span> no_corresponding_bc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>has_corresponding <span class="main">(</span>Bc <span class="free">x1</span><span class="main">)</span> <span class="free">G1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G1</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-no_corresponding_gt"><span class="command">lemma</span></span> no_corresponding_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>has_corresponding <span class="main">(</span>Gt <span class="free">x1</span> <span class="free">y1</span><span class="main">)</span> <span class="free">G1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G1</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-no_corresponding_nor"><span class="command">lemma</span></span> no_corresponding_nor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>has_corresponding <span class="main">(</span>Nor <span class="free">x1</span> <span class="free">y1</span><span class="main">)</span> <span class="free">G1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G1</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-has_corresponding_eq"><span class="command">lemma</span></span> has_corresponding_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"has_corresponding <span class="main">(</span>Eq <span class="free">x21</span> <span class="free">x22</span><span class="main">)</span> <span class="free">G1</span> <span class="main">⟹</span> <span class="main">(</span>Eq <span class="free">x21</span> <span class="free">x22</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">G1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x21a x22a
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">x21a</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">x22a</span>"</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">x21</span>"</span></span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">x22</span>"</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> has_corresponding.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-has_corresponding_In"><span class="command">lemma</span></span> has_corresponding_In<span class="main">:</span> <span class="quoted"><span class="quoted">"has_corresponding <span class="main">(</span>In <span class="free">v</span> <span class="free">l</span><span class="main">)</span> <span class="free">G1</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> <span class="main">(</span>In <span class="free">v</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">G1</span> <span class="main">∧</span> set <span class="bound">l'</span> <span class="main">⊆</span> set <span class="free">l</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l'</span> <span class="main">∈</span> set <span class="free">l</span><span class="main">.</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">l'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">G1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x21 x22 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x21</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x22</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-gval_each_one"><span class="command">lemma</span></span> gval_each_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> set <span class="free">G</span> <span class="main">⟹</span> apply_guards <span class="free">G</span> <span class="free">s</span> <span class="main">⟹</span> gval <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> true"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apply_guards_cons apply_guards_rearrange <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Least_Upper_Bound-has_corresponding_apply_guards"><span class="command">lemma</span></span> has_corresponding_apply_guards<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">G2</span><span class="main">.</span> has_corresponding <span class="bound">g</span> <span class="free">G1</span> <span class="main">⟹</span>
   apply_guards <span class="free">G1</span> <span class="free">s</span> <span class="main">⟹</span>
   apply_guards <span class="free">G2</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_corresponding_bc<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> has_corresponding_eq append_Cons append_self_conv2 apply_guards_append apply_guards_rearrange<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_corresponding_gt<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> v l
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> has_corresponding_In<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">l</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G1</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> apply_guards_rearrange<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"In <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">l'</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G1</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> apply_guards_cons<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"In <span class="skolem">v</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="skolem">G2</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> apply_guards_cons<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"In <span class="skolem">v</span> <span class="skolem">l'</span>"</span></span> <span class="quoted"><span class="free">G1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> apply_guards_rearrange<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Eq <span class="main"><span class="main">(</span></span>V <span class="skolem"><span class="skolem">v</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>L <span class="skolem"><span class="skolem">l'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G1</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> apply_guards_cons<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"In <span class="skolem">v</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="skolem">G2</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> apply_guards_cons<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Eq <span class="main">(</span>V <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>L <span class="skolem">l'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">G1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> trilean.distinct<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_corresponding_nor<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-correspondence_subsumption"><span class="command">lemma</span></span> correspondence_subsumption<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Label <span class="free">t1</span> <span class="main">=</span> Label <span class="free">t2</span> <span class="main">⟹</span>
   Arity <span class="free">t1</span> <span class="main">=</span> Arity <span class="free">t2</span> <span class="main">⟹</span>
   Outputs <span class="free">t1</span> <span class="main">=</span> Outputs <span class="free">t2</span> <span class="main">⟹</span>
   Updates <span class="free">t1</span> <span class="main">=</span> Updates <span class="free">t2</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span><span class="main">.</span> has_corresponding <span class="bound">g</span> <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">⟹</span>
   subsumes <span class="free">t2</span> <span class="free">c</span> <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_def can_take_transition_def has_corresponding_apply_guards subsumption<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_lob</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
  Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
  Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
  Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">.</span> has_corresponding <span class="bound">g</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Least_Upper_Bound-is_lob_direct_subsumption"><span class="command">lemma</span></span> is_lob_direct_subsumption<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_lob <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟹</span> directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">t2</span> <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_in_all_contexts_directly_subsumes<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_lob_def correspondence_subsumption<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">has_distinguishing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> vname gexp list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">has_distinguishing</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">[]</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_distinguishing</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="keyword1">then</span> True <span class="keyword1">else</span> <span class="free">has_distinguishing</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_distinguishing</span> <span class="main">(</span>In <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>Eq <span class="main">(</span>V <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="keyword1">then</span> True <span class="keyword1">else</span> <span class="free">has_distinguishing</span> <span class="main">(</span>In <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_distinguishing</span> <span class="main">(</span>In <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>In <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">∧</span> set <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">⊃</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> True <span class="keyword1">else</span> <span class="free">has_distinguishing</span> <span class="main">(</span>In <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_distinguishing</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">has_distinguishing</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Least_Upper_Bound-has_distinguishing"><span class="command">lemma</span></span> has_distinguishing<span class="main">:</span> <span class="quoted"><span class="quoted">"has_distinguishing <span class="free">g</span> <span class="free">G</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="bound">l</span><span class="main">.</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="bound">l</span><span class="main">.</span> <span class="free">g</span> <span class="main">=</span> In <span class="bound">v</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x21</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x22</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-has_distinguishing_Eq"><span class="command">lemma</span></span> has_distinguishing_Eq<span class="main">:</span> <span class="quoted"><span class="quoted">"has_distinguishing <span class="main">(</span>Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">G</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">l'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">G</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">≠</span> <span class="bound">l'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x21</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x22</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> has_distinguishing.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-ex_mutex"><span class="command">lemma</span></span> ex_mutex<span class="main">:</span> <span class="quoted"><span class="quoted">"Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="free">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">G1</span> <span class="main">⟹</span>
       Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">G2</span> <span class="main">⟹</span>
       <span class="free">l</span> <span class="main">≠</span> <span class="free">l'</span> <span class="main">⟹</span>
       apply_guards <span class="free">G1</span> <span class="free">s</span> <span class="main">⟹</span>
       <span class="main">¬</span> apply_guards <span class="free">G2</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_def Bex_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="free">l'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">v</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-has_distinguishing_In"><span class="command">lemma</span></span> has_distinguishing_In<span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_distinguishing <span class="main">(</span>In <span class="free">v</span> <span class="free">l</span><span class="main">)</span> <span class="free">G</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">l'</span> <span class="bound">i</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> I <span class="bound">i</span> <span class="main">∧</span> Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">l'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">G</span> <span class="main">∧</span> <span class="bound">l'</span> <span class="main">∉</span> set <span class="free">l</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l'</span> <span class="bound">i</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> I <span class="bound">i</span> <span class="main">∧</span> In <span class="free">v</span> <span class="bound">l'</span> <span class="main">∈</span> set <span class="free">G</span> <span class="main">∧</span> set <span class="bound">l'</span> <span class="main">⊃</span> set <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x21 x22
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x21</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x22</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x2</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x41
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x41</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-Eq_apply_guards"><span class="command">lemma</span></span> Eq_apply_guards<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="free">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">G1</span> <span class="main">⟹</span>
   apply_guards <span class="free">G1</span> <span class="free">s</span> <span class="main">⟹</span>
   <span class="free">s</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_rearrange<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">v</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> trilean.distinct<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1" id="Least_Upper_Bound-In_neq_apply_guards"><span class="command">lemma</span></span> In_neq_apply_guards<span class="main">:</span>
  <span class="quoted"><span class="quoted">"In <span class="free">v</span> <span class="free">l</span> <span class="main">∈</span> set <span class="free">G2</span> <span class="main">⟹</span>
   Eq <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">(</span>L <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">G1</span> <span class="main">⟹</span>
   <span class="free">l'</span> <span class="main">∉</span> set <span class="free">l</span> <span class="main">⟹</span>
   apply_guards <span class="free">G1</span> <span class="free">s</span> <span class="main">⟹</span>
   <span class="main">¬</span>apply_guards <span class="free">G2</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_def Bex_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"In <span class="free">v</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Eq_apply_guards<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">l'</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">#</span><span class="skolem">G1</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> image_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-In_apply_guards"><span class="command">lemma</span></span> In_apply_guards<span class="main">:</span> <span class="quoted"><span class="quoted">"In <span class="free">v</span> <span class="free">l</span> <span class="main">∈</span> set <span class="free">G1</span> <span class="main">⟹</span> apply_guards <span class="free">G1</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">v'</span> <span class="main">∈</span> set <span class="free">l</span><span class="main">.</span> <span class="free">s</span> <span class="free">v</span> <span class="main">=</span> Some <span class="bound">v'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_rearrange<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">v</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> image_iff trilean.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Least_Upper_Bound-input_not_constrained_aval_swap_inputs"><span class="command">lemma</span></span> input_not_constrained_aval_swap_inputs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> aexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> aval <span class="free">a</span> <span class="main">(</span>join_ir <span class="main">(</span>list_update <span class="free">i</span> <span class="free">v</span> <span class="free">x</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> aexp_induct_separate_V_cases<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> aexp_constrains.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> aval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> input2state_nth input2state_out_of_bounds join_ir_def length_list_update not_le nth_list_update_neq vname.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> join_ir_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-input_not_constrained_gval_swap_inputs"><span class="command">lemma</span></span> input_not_constrained_gval_swap_inputs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> gexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   gval <span class="free">a</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> gval <span class="free">a</span> <span class="main">(</span>join_ir <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">v</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bc <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> gval.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> input_not_constrained_aval_swap_inputs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Gt <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> input_not_constrained_aval_swap_inputs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>In <span class="skolem">x1a</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="free">i</span> <span class="free">c</span> <span class="skolem">x1a</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">v</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">x1a</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> In.prems aval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gexp_constrains.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> input_not_constrained_aval_swap_inputs option.discI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">v</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span> <span class="skolem">x1a</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> In.prems aval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gexp_constrains.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> input_not_constrained_aval_swap_inputs option.discI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> In.prems aval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gexp_constrains.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> input_not_constrained_aval_swap_inputs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-test_aux"><span class="command">lemma</span></span> test_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="main">(</span>removeAll <span class="main">(</span>In <span class="main">(</span>I <span class="free">v</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="free">G1</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
      apply_guards <span class="free">G1</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="free">x</span> <span class="main">∈</span> set <span class="free">l</span> <span class="main">⟹</span>
      apply_guards <span class="free">G1</span> <span class="main">(</span>join_ir <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">v</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> apply_guards_cons<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> In <span class="main">(</span>I <span class="free">v</span><span class="main">)</span> <span class="free">l</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="free">i</span> <span class="free">c</span> <span class="main">(</span>I <span class="free">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">v</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span>I <span class="free">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> join_ir_nth le_less_linear length_list_update list_update_beyond option.discI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> join_ir_nth le_less_linear length_list_update list_update_beyond nth_list_update_eq option.inject trilean.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">v</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span>I <span class="free">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> join_ir_nth le_less_linear length_list_update list_update_beyond option.discI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> input_not_constrained_gval_swap_inputs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-test"><span class="command">lemma</span></span> test<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    p1<span class="main">:</span> <span class="quoted"><span class="quoted">"In <span class="main">(</span>I <span class="free">v</span><span class="main">)</span> <span class="free">l</span> <span class="main">∈</span> set <span class="free">G2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p2<span class="main">:</span> <span class="quoted"><span class="quoted">"In <span class="main">(</span>I <span class="free">v</span><span class="main">)</span> <span class="free">l'</span> <span class="main">∈</span> set <span class="free">G1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">l'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p5<span class="main">:</span> <span class="quoted"><span class="quoted">"apply_guards <span class="free">G1</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p6<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">i</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>removeAll <span class="main">(</span>In <span class="main">(</span>I <span class="free">v</span><span class="main">)</span> <span class="free">l'</span><span class="main">)</span> <span class="free">G1</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> length <span class="bound">i</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> apply_guards <span class="free">G1</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>length <span class="bound">i</span> <span class="main">=</span> <span class="free">a</span> <span class="main">⟶</span> <span class="main">¬</span> apply_guards <span class="free">G2</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"list_update <span class="free">i</span> <span class="free">v</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p6<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> p3 p5 p7 test_aux <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> p1 p4
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_rearrange<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_cons join_ir_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"input2state <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">v</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="free">v</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> input2state_nth input2state_within_bounds length_list_update nth_list_update_eq option.inject<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_Ins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> value list<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_Ins</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">g</span> <span class="keyword1">of</span> <span class="main">(</span>In <span class="main">(</span>I <span class="bound">v</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">g</span> <span class="keyword1">of</span> <span class="main">(</span>In <span class="main">(</span>I <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Least_Upper_Bound-get_Ins_Cons_equiv"><span class="command">lemma</span></span> get_Ins_Cons_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">v</span> <span class="bound">l</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> In <span class="main">(</span>I <span class="bound">v</span><span class="main">)</span> <span class="bound">l</span> <span class="main">⟹</span> get_Ins <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> get_Ins <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_Ins_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> vname.exhaust vname.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Least_Upper_Bound-Ball_Cons"><span class="command">lemma</span></span> Ball_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">l</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="free">a</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">l</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Least_Upper_Bound-In_in_get_Ins"><span class="command">lemma</span></span> In_in_get_Ins<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>In <span class="main">(</span>I <span class="free">v</span><span class="main">)</span> <span class="free">l</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>get_Ins <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_Ins_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_Ins_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">check_get_Ins</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>get_Ins <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>removeAll <span class="main">(</span>In <span class="main">(</span>I <span class="bound">v</span><span class="main">)</span> <span class="bound">l'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Least_Upper_Bound-no_Ins"><span class="command">lemma</span></span> no_Ins<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">=</span> get_Ins <span class="free">G</span> <span class="main">⟹</span> set <span class="free">G</span> <span class="main">-</span> <span class="main">{</span>In <span class="main">(</span>I <span class="free">i</span><span class="main">)</span> <span class="free">l</span><span class="main">}</span> <span class="main">=</span> set <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_Ins_Cons_equiv insert_Diff_if<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x41 x42
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x41</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> In_in_get_Ins equals0D list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_Ins_Cons_equiv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_Ins_Cons_equiv insert_Diff_if<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-test2"><span class="command">lemma</span></span> test2<span class="main">:</span> <span class="quoted"><span class="quoted">"In <span class="main">(</span>I <span class="free">i</span><span class="main">)</span> <span class="free">l</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span> <span class="main">⟹</span>
       In <span class="main">(</span>I <span class="free">i</span><span class="main">)</span> <span class="free">l'</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">⟹</span>
       length <span class="free">ia</span> <span class="main">=</span> Arity <span class="free">t1</span> <span class="main">⟹</span>
       apply_guards <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">ia</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="free">x</span> <span class="main">∈</span> set <span class="free">l'</span> <span class="main">⟹</span>
       <span class="free">x</span> <span class="main">∉</span> set <span class="free">l</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span><span class="main">∈</span>insert <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>get_Ins <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="main">(</span>removeAll <span class="main">(</span>In <span class="main">(</span>I <span class="bound">v</span><span class="main">)</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
       Arity <span class="free">t1</span> <span class="main">=</span> Arity <span class="free">t2</span> <span class="main">⟹</span>
       <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> length <span class="bound">i</span> <span class="main">=</span> Arity <span class="free">t2</span> <span class="main">∧</span> apply_guards <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>length <span class="bound">i</span> <span class="main">=</span> Arity <span class="free">t2</span> <span class="main">⟶</span> <span class="main">¬</span> apply_guards <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> test<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="quoted">"Guards <span class="free">t2</span>"</span></span> <span class="quoted"><span class="free">l'</span></span> <span class="quoted"><span class="quoted">"Guards <span class="free">t1</span>"</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">ia</span></span>  <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="quoted">"Arity <span class="free">t2</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>In <span class="main">(</span>I <span class="free">i</span><span class="main">)</span> <span class="free">l'</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> In_in_get_Ins <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Least_Upper_Bound-distinguishing_subsumption"><span class="command">lemma</span></span> distinguishing_subsumption<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span><span class="main">.</span> has_distinguishing <span class="bound">g</span> <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p2<span class="main">:</span> <span class="quoted"><span class="quoted">"Arity <span class="free">t1</span> <span class="main">=</span> Arity <span class="free">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t1</span> <span class="bound">i</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">∈</span> insert <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>get_Ins <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>removeAll <span class="main">(</span>In <span class="main">(</span>I <span class="bound">v</span><span class="main">)</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">¬</span> subsumes <span class="free">t2</span> <span class="free">c</span> <span class="free">t1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bad_guards<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_transition_def can_take_def p2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> p1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Bex_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="bound">l</span><span class="main">.</span> <span class="improper">x</span> <span class="main">=</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> can_take_def can_take_transition_def ex_mutex p2 p3 has_distinguishing_Eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="bound">l</span><span class="main">.</span> <span class="improper">x</span> <span class="main">=</span> In <span class="bound">v</span> <span class="bound">l</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> has_distinguishing <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l'</span> <span class="bound">i</span><span class="main">.</span> <span class="improper">v</span> <span class="main">=</span> I <span class="bound">i</span> <span class="main">∧</span> Eq <span class="main">(</span>V <span class="improper">v</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">l'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">l'</span> <span class="main">∉</span> set <span class="improper">l</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> In_neq_apply_guards can_take_def can_take_transition_def p2 p3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">l'</span> <span class="bound">i</span><span class="main">.</span> <span class="improper">v</span> <span class="main">=</span> I <span class="bound">i</span> <span class="main">∧</span> In <span class="improper">v</span> <span class="bound">l'</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">∧</span> set <span class="bound">l'</span> <span class="main">⊃</span> set <span class="improper">l</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> has_distinguishing_In <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> p3<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> can_take_transition_def can_take_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="improper">l'</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> set <span class="improper">l</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> p4 p2<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> test2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lob_distinguished</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>
<span class="main">(</span><span class="main">∃</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">.</span> has_distinguishing <span class="bound">g</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">∈</span> insert <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>get_Ins <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>removeAll <span class="main">(</span>In <span class="main">(</span>I <span class="bound">v</span><span class="main">)</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Least_Upper_Bound-must_be_another"><span class="command">lemma</span></span> must_be_another<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> size <span class="main">(</span>fset_of_list <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">∈</span> set <span class="free">b</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">x'</span> <span class="main">∈</span> set <span class="free">b</span><span class="main">.</span> <span class="free">x</span> <span class="main">≠</span> <span class="bound">x'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Bex_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set One_nat_def card.insert card_gt_0_iff card_mono fset_of_list.rep_eq insert_absorb le_0_eq less_nat_zero_code less_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> not_less_iff_gr_or_eq set_empty2 subsetI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-another_swap_inputs"><span class="command">lemma</span></span> another_swap_inputs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"apply_guards <span class="free">G</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span>
  filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">G</span> <span class="main">=</span> <span class="main">[</span>In <span class="main">(</span>I <span class="free">a</span><span class="main">)</span> <span class="free">b</span><span class="main">]</span> <span class="main">⟹</span>
  <span class="free">xa</span> <span class="main">∈</span> set <span class="free">b</span> <span class="main">⟹</span>
  apply_guards <span class="free">G</span> <span class="main">(</span>join_ir <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">a</span> <span class="main">:=</span> <span class="free">xa</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">g</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_cons<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"gexp_constrains <span class="skolem">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> input_not_constrained_gval_swap_inputs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="free">i</span> <span class="free">c</span> <span class="main">(</span>I <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> Some <span class="main">`</span> set <span class="free">b</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command">using</span></span> apply_guards_def input_not_constrained_gval_swap_inputs
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="free">i</span> <span class="free">c</span> <span class="main">(</span>I <span class="free">a</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">a</span> <span class="main">:=</span> <span class="free">xa</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span>I <span class="free">a</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI trilean.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI trilean.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="free">i</span> <span class="free">c</span> <span class="main">(</span>I <span class="free">a</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI trilean.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="free">i</span> <span class="free">c</span> <span class="main">(</span>I <span class="free">a</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"join_ir <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">a</span> <span class="main">:=</span> <span class="free">xa</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span>I <span class="free">a</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> join_ir_nth le_less_linear length_list_update list_update_beyond option.discI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.hyps Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> filter_empty_conv removeAll_id set_ConsD test_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_these_eq join_ir_nth le_less_linear length_list_update list_update_beyond nth_list_update_eq these_image_Some_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-lob_distinguished_2_not_subsumes"><span class="command">lemma</span></span> lob_distinguished_2_not_subsumes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>get_Ins <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span>In <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">]</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">l'</span> <span class="main">∈</span> set <span class="bound">l</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Arity <span class="free">t1</span> <span class="main">∧</span> Eq <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">l'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">∧</span> size <span class="main">(</span>fset_of_list <span class="bound">l</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span>
   Arity <span class="free">t1</span> <span class="main">=</span> Arity <span class="free">t2</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t2</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">⟹</span>
   <span class="main">¬</span> subsumes <span class="free">t1</span> <span class="free">c</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bad_guards<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_def can_take_transition_def Bex_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span> <span class="main">∈</span> set <span class="improper">b</span><span class="main">.</span> <span class="improper">x</span> <span class="main">≠</span> <span class="bound">x'</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> must_be_another<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Bex_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"list_update <span class="improper">i</span> <span class="improper">a</span> <span class="improper">xa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> another_swap_inputs<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Eq_apply_guards input2state_nth join_ir_def length_list_update nth_list_update_eq option.inject vname.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lob_distinguished_2</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>get_Ins <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span>In <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">]</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">l'</span> <span class="main">∈</span> set <span class="bound">l</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∧</span> Eq <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">l'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">∧</span> size <span class="main">(</span>fset_of_list <span class="bound">l</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>
  Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Least_Upper_Bound-lob_distinguished_3_not_subsumes"><span class="command">lemma</span></span> lob_distinguished_3_not_subsumes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>get_Ins <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span>In <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">]</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">i'</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>get_Ins <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">i'</span> <span class="main">∧</span> set <span class="bound">l'</span> <span class="main">⊂</span> set <span class="bound">l</span><span class="main">)</span> <span class="main">⟹</span>
   Arity <span class="free">t1</span> <span class="main">=</span> Arity <span class="free">t2</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free">t2</span> <span class="bound">i</span> <span class="free">c</span> <span class="main">⟹</span>
   <span class="main">¬</span> subsumes <span class="free">t1</span> <span class="free">c</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bad_guards<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_take_def can_take_transition_def Bex_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="improper">b</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> set <span class="improper">ba</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"list_update <span class="improper">i</span> <span class="improper">a</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> another_swap_inputs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> In_apply_guards In_in_get_Ins input2state_not_None input2state_nth join_ir_def nth_list_update_eq option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.inject vname.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lob_distinguished_3</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>get_Ins <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span>In <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">]</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">i'</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>get_Ins <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">i'</span> <span class="main">∧</span> set <span class="bound">l'</span> <span class="main">⊂</span> set <span class="bound">l</span><span class="main">)</span> <span class="main">∧</span>
   Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_In</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_In</span> <span class="main">(</span>In <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_In</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The ``greatest upper bound'' (gob) heuristic is similar to \texttt{lob} but applies a more
intellegent approach to guard merging.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gob_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> transition option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gob_aux</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span> Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span> all_literal_args <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∧</span> all_literal_args <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">then</span>
      Some <span class="main">⦇</span>Label <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> Arity <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> Guards <span class="main">=</span> remdups <span class="main">(</span>filter <span class="main">(</span>Not <span class="main">∘</span> is_In<span class="main">)</span> <span class="main">(</span>merge_guards <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Outputs <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> Updates <span class="main">=</span> Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">⦈</span>
     <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gob</span> <span class="main">::</span> <span class="quoted">update_modifier</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gob</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
     <span class="bound">t1</span> <span class="main">=</span> <span class="main">(</span>get_by_ids <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">)</span><span class="main">;</span>
     <span class="bound">t2</span> <span class="main">=</span> <span class="main">(</span>get_by_ids <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
     <span class="keyword1">case</span> gob_aux <span class="bound">t1</span> <span class="bound">t2</span> <span class="keyword1">of</span>
       None <span class="main">⇒</span> None <span class="main">|</span>
       Some <span class="bound">gob_t</span> <span class="main">⇒</span>
           Some <span class="main">(</span>replace_transitions <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">,</span> <span class="bound">gob_t</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2ID</span></span></span><span class="main">,</span> <span class="bound">gob_t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
   <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The ``Gung Ho'' heuristic simply drops the guards of both transitions, making them identical.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gung_ho_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> transition option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gung_ho_aux</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span> Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span> all_literal_args <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∧</span> all_literal_args <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">then</span>
      Some <span class="main">⦇</span>Label <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> Arity <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> Guards <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> Outputs <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> Updates <span class="main">=</span> Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">⦈</span>
     <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gung_ho</span> <span class="main">::</span> <span class="quoted">update_modifier</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gung_ho</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
     <span class="bound">t1</span> <span class="main">=</span> <span class="main">(</span>get_by_ids <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">)</span><span class="main">;</span>
     <span class="bound">t2</span> <span class="main">=</span> <span class="main">(</span>get_by_ids <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
     <span class="keyword1">case</span> gung_ho_aux <span class="bound">t1</span> <span class="bound">t2</span> <span class="keyword1">of</span>
       None <span class="main">⇒</span> None <span class="main">|</span>
       Some <span class="bound">gob_t</span> <span class="main">⇒</span>
           Some <span class="main">(</span>replace_transitions <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">,</span> <span class="bound">gob_t</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2ID</span></span></span><span class="main">,</span> <span class="bound">gob_t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
   <span class="main">)</span>"</span></span>

<span class="keyword1" id="Least_Upper_Bound-guard_subset_eq_outputs_updates_subsumption"><span class="command">lemma</span></span> guard_subset_eq_outputs_updates_subsumption<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Label <span class="free">t1</span> <span class="main">=</span> Label <span class="free">t2</span> <span class="main">⟹</span>
   Arity <span class="free">t1</span> <span class="main">=</span> Arity <span class="free">t2</span> <span class="main">⟹</span>
   Outputs <span class="free">t1</span> <span class="main">=</span> Outputs <span class="free">t2</span> <span class="main">⟹</span>
   Updates <span class="free">t1</span> <span class="main">=</span> Updates <span class="free">t2</span> <span class="main">⟹</span>
   set <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">⟹</span>
   subsumes <span class="free">t2</span> <span class="free">c</span> <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> can_take_def can_take_subset can_take_transition_def<span class="main">)</span>

<span class="keyword1" id="Least_Upper_Bound-guard_subset_eq_outputs_updates_direct_subsumption"><span class="command">lemma</span></span> guard_subset_eq_outputs_updates_direct_subsumption<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Label <span class="free">t1</span> <span class="main">=</span> Label <span class="free">t2</span> <span class="main">⟹</span>
   Arity <span class="free">t1</span> <span class="main">=</span> Arity <span class="free">t2</span> <span class="main">⟹</span>
   Outputs <span class="free">t1</span> <span class="main">=</span> Outputs <span class="free">t2</span> <span class="main">⟹</span>
   Updates <span class="free">t1</span> <span class="main">=</span> Updates <span class="free">t2</span> <span class="main">⟹</span>
   set <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">⟹</span>
   directly_subsumes <span class="free">m1</span> <span class="free">m2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t2</span> <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_in_all_contexts_directly_subsumes<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> guard_subset_eq_outputs_updates_subsumption<span class="main">)</span>

<span class="keyword1" id="Least_Upper_Bound-unconstrained_input"><span class="command">lemma</span></span> unconstrained_input<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">G</span><span class="main">.</span> <span class="main">¬</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   apply_guards <span class="free">G</span> <span class="main">(</span>join_ir <span class="free">ia</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span>
   apply_guards <span class="free">G</span> <span class="main">(</span>join_ir <span class="main">(</span><span class="free">ia</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">x'</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> input_not_constrained_gval_swap_inputs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ia</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">x'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-each_input_guarded_once_cons"><span class="command">lemma</span></span> each_input_guarded_once_cons<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">⋃</span> <span class="main">(</span>enumerate_gexp_inputs <span class="main">`</span> set <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">⋃</span> <span class="main">(</span>enumerate_gexp_inputs <span class="main">`</span> set <span class="free">G</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ball_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> enumerate_gexp_inputs <span class="free">a</span> <span class="main">⟶</span> length <span class="main">(</span><span class="keyword1">if</span> gexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="main">#</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">G</span> <span class="keyword1">else</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">xa</span><span class="main">∈</span>set <span class="free">G</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> enumerate_gexp_inputs <span class="bound">xa</span><span class="main">)</span> <span class="main">⟶</span> length <span class="main">(</span><span class="keyword1">if</span> gexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="main">#</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">G</span> <span class="keyword1">else</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> set <span class="free">G</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> enumerate_gexp_inputs <span class="skolem">xa</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> gexp_constrains <span class="free">a</span> <span class="main">(</span>V <span class="main">(</span>I <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> length <span class="main">(</span><span class="free">a</span> <span class="main">#</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">else</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> impossible_Cons le_cases order.trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Least_Upper_Bound-literal_args_can_take"><span class="command">lemma</span></span> literal_args_can_take<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">G</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span> <span class="bound">v</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">g</span> <span class="main">=</span> Eq <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">v</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">g</span> <span class="main">=</span> In <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">⋃</span> <span class="main">(</span>enumerate_gexp_inputs <span class="main">`</span> set <span class="free">G</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">⋃</span> <span class="main">(</span>enumerate_gexp_inputs <span class="main">`</span> set <span class="free">G</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> length <span class="bound">i</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> apply_guards <span class="free">G</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Ex_list_of_length
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="skolem">G</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>enumerate_gexp_inputs <span class="bound">y</span><span class="main">.</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">G</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> each_input_guarded_once_cons <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ball_Un<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x2 i ia
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x2</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"list_update <span class="skolem">i</span> <span class="skolem">ia</span> <span class="improper">x1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_cons unconstrained_input filter_empty_conv<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ x2 i ia
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">x2</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> aa
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"list_update <span class="skolem">i</span> <span class="skolem">ia</span> <span class="skolem">aa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_cons unconstrained_input filter_empty_conv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">≠</span> <span class="main">(</span><span class="free">v</span><span class="main">::</span>value<span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Num <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> someI_ex value.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Str <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> someI_ex value.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Least_Upper_Bound-opposite_gob_subsumption"><span class="command">lemma</span></span> opposite_gob_subsumption<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span> <span class="bound">v</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">g</span> <span class="main">=</span> Eq <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">v</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">g</span> <span class="main">=</span> In <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span> <span class="bound">v</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">g</span> <span class="main">=</span> Eq <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">v</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">g</span> <span class="main">=</span> In <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> Eq <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
       Arity <span class="free">t1</span> <span class="main">=</span> Arity <span class="free">t2</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> enumerate_inputs <span class="free">t2</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Arity <span class="free">t2</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> enumerate_inputs <span class="free">t2</span><span class="main">.</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span>
       <span class="main">¬</span> subsumes <span class="free">t1</span> <span class="free">c</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bad_guards<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enumerate_inputs_def can_take_transition_def can_take_def Bex_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> literal_args_can_take<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Guards <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"Arity <span class="free">t2</span>"</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i ia v
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"list_update <span class="skolem">ia</span> <span class="skolem">i</span> <span class="main">(</span>Eps <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">≠</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> input_not_constrained_gval_swap_inputs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_def Bex_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Eq <span class="main">(</span>V <span class="main">(</span>I <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_ir_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"input2state <span class="main">(</span><span class="skolem">ia</span><span class="main">[</span><span class="skolem">i</span> <span class="main">:=</span> <span class="keyword1">SOME</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">≠</span> <span class="skolem">v</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ia</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input2state_nth<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> someI_ex value.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> someI_ex value.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> input2state_within_bounds length_list_update<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_lit_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_lit_eq</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_lit_eq</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> Eq <span class="main">(</span>V <span class="main">(</span>I <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">.</span> is_lit_eq <span class="bound">g</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_lit_eq.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_lit_eq.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_lit_eq_general</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_lit_eq_general</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="main">(</span>I <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_lit_eq_general</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_input_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_input_in</span> <span class="main">(</span>In <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_input_in</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">opposite_gob</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">.</span> is_lit_eq_general <span class="bound">g</span> <span class="main">∨</span> is_input_in <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">.</span> is_lit_eq_general <span class="bound">g</span> <span class="main">∨</span> is_input_in <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">(</span>enumerate_inputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∪</span> enumerate_inputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">.</span> is_lit_eq <span class="bound">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
       Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> enumerate_inputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> enumerate_inputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">.</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"is_lit_eq_general <span class="free">g</span> <span class="main">∨</span> is_input_in <span class="free">g</span> <span class="main">⟹</span>
       <span class="main">∃</span><span class="bound">i</span> <span class="bound">v</span> <span class="bound">s</span><span class="main">.</span> <span class="free">g</span> <span class="main">=</span> Eq <span class="main">(</span>V <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">v</span><span class="main">)</span> <span class="main">∨</span> <span class="free">g</span> <span class="main">=</span> In <span class="main">(</span>I <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> is_input_in.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_lit_eq_general.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Least_Upper_Bound-opposite_gob_directly_subsumption"><span class="command">lemma</span></span> opposite_gob_directly_subsumption<span class="main">:</span>
  <span class="quoted"><span class="quoted">"opposite_gob <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟹</span> <span class="main">¬</span> subsumes <span class="free">t1</span> <span class="free">c</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> opposite_gob_subsumption<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> opposite_gob_def
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> is_input_in.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_lit_eq_general.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> is_lit_eq.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">get_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> value list<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_in</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">get_in</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1" id="Least_Upper_Bound-not_subset_not_in"><span class="command">lemma</span></span> not_subset_not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="free">s1</span> <span class="main">⊆</span> <span class="free">s2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">s1</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">∉</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-get_in_is"><span class="command">lemma</span></span> get_in_is<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>get_in <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">s1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> In <span class="free">v</span> <span class="free">s1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Least_Upper_Bound-gval_rearrange"><span class="command">lemma</span></span> gval_rearrange<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> set <span class="free">G</span> <span class="main">⟹</span>
   gval <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> true <span class="main">⟹</span>
   apply_guards <span class="main">(</span>removeAll <span class="free">g</span> <span class="free">G</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span>
   apply_guards <span class="free">G</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> apply_guards_cons<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> apply_guards_cons removeAll.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apply_guards_cons removeAll.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> removeAll_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-singleton_list"><span class="command">lemma</span></span> singleton_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">l</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[</span><span class="bound">e</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Least_Upper_Bound-remove_restricted"><span class="command">lemma</span></span> remove_restricted<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> set <span class="free">G</span> <span class="main">⟹</span>
   gexp_constrains <span class="free">g</span> <span class="main">(</span>V <span class="free">v</span><span class="main">)</span> <span class="main">⟹</span>
   restricted_once <span class="free">v</span> <span class="free">G</span> <span class="main">⟹</span>
   not_restricted <span class="free">v</span> <span class="main">(</span>removeAll <span class="free">g</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restricted_once_def not_restricted_def singleton_list<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="free">g</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> DiffE Diff_insert_absorb Set.set_insert empty_set filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> filter_append in_set_conv_decomp insert_iff list.set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">G</span> <span class="main">=</span> <span class="main">[</span><span class="free">g</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">g</span></span> <span class="main">∈</span> set <span class="free">G</span><span class="main">.</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="free">v</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">g</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> empty_set list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> set_filter<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">G</span> <span class="main">-</span> <span class="main">{</span><span class="free">g</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> gexp_constrains <span class="bound">g</span> <span class="main">(</span>V <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Least_Upper_Bound-unrestricted_input_swap"><span class="command">lemma</span></span> unrestricted_input_swap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"not_restricted <span class="main">(</span>I <span class="free">i</span><span class="main">)</span> <span class="free">G</span> <span class="main">⟹</span>
   apply_guards <span class="free">G</span> <span class="main">(</span>join_ir <span class="free">iaa</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span>
   apply_guards <span class="main">(</span>removeAll <span class="free">g</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="main">(</span><span class="free">iaa</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">ia</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_cons not_restricted_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> neq_Nil_conv<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> input_not_constrained_gval_swap_inputs list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-apply_guards_remove_restricted"><span class="command">lemma</span></span> apply_guards_remove_restricted<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> set <span class="free">G</span> <span class="main">⟹</span>
   gexp_constrains <span class="free">g</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   restricted_once <span class="main">(</span>I <span class="free">i</span><span class="main">)</span> <span class="free">G</span> <span class="main">⟹</span>
   apply_guards <span class="free">G</span> <span class="main">(</span>join_ir <span class="free">iaa</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span>
   apply_guards <span class="main">(</span>removeAll <span class="free">g</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="main">(</span><span class="free">iaa</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">ia</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> unrestricted_input_swap<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_restricted_def restricted_once_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> apply_guards_subset set_subset_Cons<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_rearrange not_restricted_def restricted_once_def unrestricted_input_swap<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> apply_guards_cons filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> filter_empty_conv input_not_constrained_gval_swap_inputs list.inject restricted_once_def singleton_list<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Least_Upper_Bound-In_swap_inputs"><span class="command">lemma</span></span> In_swap_inputs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"In <span class="main">(</span>I <span class="free">i</span><span class="main">)</span> <span class="free">s2</span> <span class="main">∈</span> set <span class="free">G</span> <span class="main">⟹</span>
   restricted_once <span class="main">(</span>I <span class="free">i</span><span class="main">)</span> <span class="free">G</span> <span class="main">⟹</span>
   <span class="free">ia</span> <span class="main">∈</span> set <span class="free">s2</span> <span class="main">⟹</span>
   apply_guards <span class="free">G</span> <span class="main">(</span>join_ir <span class="free">iaa</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span>
   apply_guards <span class="free">G</span> <span class="main">(</span>join_ir <span class="main">(</span><span class="free">iaa</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">ia</span><span class="main">]</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apply_guards_remove_restricted<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"In <span class="main">(</span>I <span class="free">i</span><span class="main">)</span> <span class="free">s2</span>"</span></span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">iaa</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">ia</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gval_rearrange<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"In <span class="main"><span class="main">(</span></span>I <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">s2</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> filter_empty_conv gval_each_one input_not_constrained_gval_swap_inputs length_0_conv not_restricted_def remove_restricted test_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">these</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">these</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Some <span class="bound">y</span> <span class="main">⇒</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Least_Upper_Bound-these_cons"><span class="command">lemma</span></span> these_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"these <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">a</span> <span class="keyword1">of</span> None <span class="main">⇒</span> these <span class="free">as</span> <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">#</span><span class="main">(</span>these <span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> these_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> these_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_ins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> value list<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_ins</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> I <span class="bound">i</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> I <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> R <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">(</span>these <span class="main">(</span>map get_in <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Least_Upper_Bound-in_get_ins"><span class="command">lemma</span></span> in_get_ins<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>I <span class="free">x1a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>these <span class="main">(</span>map get_in <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   In <span class="main">(</span>I <span class="free">x1a</span><span class="main">)</span> <span class="free">b</span> <span class="main">∈</span> set <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> these_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> these_cons<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Least_Upper_Bound-restricted_head"><span class="command">lemma</span></span> restricted_head<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> restricted_once <span class="bound">v</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free">x2</span><span class="main">)</span> <span class="main">(</span>L <span class="free">x1</span><span class="main">)</span> <span class="main">#</span> <span class="free">G</span><span class="main">)</span> <span class="main">∨</span> not_restricted <span class="bound">v</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free">x2</span><span class="main">)</span> <span class="main">(</span>L <span class="free">x1</span><span class="main">)</span> <span class="main">#</span> <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span>
      not_restricted <span class="free">x2</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restricted_once_def not_restricted_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">atomic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atomic</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">atomic</span> <span class="main">(</span>In <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">atomic</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Least_Upper_Bound-restricted_max_once_cons"><span class="command">lemma</span></span> restricted_max_once_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> restricted_once <span class="bound">v</span> <span class="main">(</span><span class="free">g</span><span class="main">#</span><span class="free">gs</span><span class="main">)</span> <span class="main">∨</span> not_restricted <span class="bound">v</span> <span class="main">(</span><span class="free">g</span><span class="main">#</span><span class="free">gs</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="main">∀</span><span class="bound">v</span><span class="main">.</span> restricted_once <span class="bound">v</span> <span class="free">gs</span> <span class="main">∨</span> not_restricted <span class="bound">v</span> <span class="free">gs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restricted_once_def not_restricted_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> v 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
      <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.inject singleton_list<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Least_Upper_Bound-not_restricted_swap_inputs"><span class="command">lemma</span></span> not_restricted_swap_inputs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"not_restricted <span class="main">(</span>I <span class="free">x1a</span><span class="main">)</span> <span class="free">G</span> <span class="main">⟹</span>
   apply_guards <span class="free">G</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
   apply_guards <span class="free">G</span> <span class="main">(</span>join_ir <span class="main">(</span><span class="free">i</span><span class="main">[</span><span class="free">x1a</span> <span class="main">:=</span> <span class="free">x1</span><span class="main">]</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_cons not_restricted_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> input_not_constrained_gval_swap_inputs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Distinguishing_Guards">
<div class="head">
<h1>Theory Distinguishing_Guards</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Distinguishing Guards›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If we cannot resolve the nondeterminism which arises from merging states by merging
transitions, we might then conclude that those states should not be merged. Alternatively, we could
consider the possibility of \emph{value-dependent} behaviour. This theory presents a heuristic which
tries to find a guard which distinguishes between a pair of transitions.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Distinguishing_Guards
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Inference">../Inference</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> uids

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">put_updates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tids <span class="main">⇒</span> update_function list <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">put_updates</span> <span class="free"><span class="bound"><span class="entity">uids</span></span></span> <span class="free"><span class="bound"><span class="entity">updates</span></span></span> <span class="free"><span class="bound"><span class="entity">iefsm</span></span></span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="bound">fromTo</span><span class="main">,</span> <span class="bound">tran</span><span class="main">)</span><span class="main">.</span>
      <span class="keyword1">case</span> <span class="bound">uid</span> <span class="keyword1">of</span> <span class="main">[</span><span class="bound">u</span><span class="main">]</span> <span class="main">⇒</span>
      <span class="keyword1">if</span> <span class="bound">u</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">uids</span></span></span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="bound">fromTo</span><span class="main">,</span> <span class="main">⦇</span>Label <span class="main">=</span> Label <span class="bound">tran</span><span class="main">,</span> Arity <span class="main">=</span> Arity <span class="bound">tran</span><span class="main">,</span> Guards <span class="main">=</span> Guards <span class="bound">tran</span><span class="main">,</span> Outputs <span class="main">=</span> Outputs <span class="bound">tran</span><span class="main">,</span> Updates <span class="main">=</span> <span class="main">(</span>Updates <span class="bound">tran</span><span class="main">)</span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">updates</span></span></span><span class="main">⦈</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="bound">fromTo</span><span class="main">,</span> <span class="bound">tran</span><span class="main">)</span>
      <span class="main">)</span> <span class="free"><span class="bound"><span class="entity">iefsm</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">transfer_updates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">transfer_updates</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pta</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tids</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">tran</span><span class="main">)</span> <span class="bound">acc</span><span class="main">.</span> put_updates <span class="bound">tids</span> <span class="main">(</span>Updates <span class="bound">tran</span><span class="main">)</span> <span class="bound">acc</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fset <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">pta</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">trace_collect_training_sets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trace <span class="main">⇒</span> iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> tids <span class="main">⇒</span> tids <span class="main">⇒</span> <span class="main">(</span>inputs <span class="main">×</span> registers<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>inputs <span class="main">×</span> registers<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>inputs <span class="main">×</span> registers<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span>inputs <span class="main">×</span> registers<span class="main">)</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_collect_training_sets</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">uPTA</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">registers</span></span></span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="free"><span class="bound"><span class="entity">G1</span></span></span> <span class="free"><span class="bound"><span class="entity">G2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">G1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">G2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_collect_training_sets</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">label</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">outputs</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">uPTA</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">registers</span></span></span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="free"><span class="bound"><span class="entity">G1</span></span></span> <span class="free"><span class="bound"><span class="entity">G2</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="main">(</span><span class="bound">uids</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">tran</span><span class="main">)</span> <span class="main">=</span> fthe_elem <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uids</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">tran</span><span class="main">)</span><span class="main">.</span> evaluate_outputs <span class="bound">tran</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="free"><span class="bound"><span class="entity">registers</span></span></span> <span class="main">=</span> map Some <span class="free"><span class="bound"><span class="entity">outputs</span></span></span><span class="main">)</span> <span class="main">(</span>i_possible_steps <span class="free"><span class="bound"><span class="entity">uPTA</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">registers</span></span></span> <span class="free"><span class="bound"><span class="entity">label</span></span></span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">updated</span> <span class="main">=</span> <span class="main">(</span>evaluate_updates <span class="bound">tran</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="free"><span class="bound"><span class="entity">registers</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span>
    <span class="keyword1">if</span> hd <span class="bound">uids</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="keyword1">then</span>
      <span class="free">trace_collect_training_sets</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">uPTA</span></span></span> <span class="bound">s'</span> <span class="bound">updated</span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">registers</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">G1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G2</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> hd <span class="bound">uids</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="keyword1">then</span>
      <span class="free">trace_collect_training_sets</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">uPTA</span></span></span> <span class="bound">s'</span> <span class="bound">updated</span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="free"><span class="bound"><span class="entity">G1</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">registers</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">G2</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="free">trace_collect_training_sets</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">uPTA</span></span></span> <span class="bound">s'</span> <span class="bound">updated</span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="free"><span class="bound"><span class="entity">G1</span></span></span> <span class="free"><span class="bound"><span class="entity">G2</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">collect_training_sets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"log <span class="main">⇒</span> iEFSM <span class="main">⇒</span> tids <span class="main">⇒</span> tids <span class="main">⇒</span> <span class="main">(</span>inputs <span class="main">×</span> registers<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>inputs <span class="main">×</span> registers<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>inputs <span class="main">×</span> registers<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span>inputs <span class="main">×</span> registers<span class="main">)</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">collect_training_sets</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">uPTA</span></span></span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="free"><span class="bound"><span class="entity">G1</span></span></span> <span class="free"><span class="bound"><span class="entity">G2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">G1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">G2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">collect_training_sets</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">uPTA</span></span></span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="free"><span class="bound"><span class="entity">G1</span></span></span> <span class="free"><span class="bound"><span class="entity">G2</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">G1a</span><span class="main">,</span> <span class="bound">G2a</span><span class="main">)</span> <span class="main">=</span> trace_collect_training_sets <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">uPTA</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="keyword1">in</span>
    <span class="free">collect_training_sets</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">uPTA</span></span></span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main">(</span>List.union <span class="free"><span class="bound"><span class="entity">G1</span></span></span> <span class="bound">G1a</span><span class="main">)</span> <span class="main">(</span>List.union <span class="free"><span class="bound"><span class="entity">G2</span></span></span> <span class="bound">G2a</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_distinguishing_guards</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inputs <span class="main">×</span> registers<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>inputs <span class="main">×</span> registers<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>vname gexp <span class="main">×</span> vname gexp<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_distinguishing_guards</span> <span class="free"><span class="bound"><span class="entity">G1</span></span></span> <span class="free"><span class="bound"><span class="entity">G2</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">gs</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">g1</span><span class="main">,</span> <span class="bound">g2</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">G1</span></span></span><span class="main">.</span> gval <span class="bound">g1</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">G2</span></span></span><span class="main">.</span> gval <span class="bound">g2</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span>gval <span class="bound">g1</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> true <span class="main">∧</span> gval <span class="bound">g2</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> true<span class="main">)</span><span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">gs</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>Eps <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="bound">gs</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> find_distinguishing_guards_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">find_distinguishing_guards</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.findDistinguishingGuards"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> vname gexp <span class="main">⇒</span> transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_guard</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⦇</span>Guards <span class="main">:=</span> List.insert <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">distinguish</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"log <span class="main">⇒</span> update_modifier"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">distinguish</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">destMerge</span></span></span> <span class="free"><span class="bound"><span class="entity">preDestMerge</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">t1</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">destMerge</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">;</span>
      <span class="bound">t2</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">destMerge</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span><span class="main">;</span>
      <span class="bound">uPTA</span> <span class="main">=</span> transfer_updates <span class="free"><span class="bound"><span class="entity">destMerge</span></span></span> <span class="main">(</span>make_pta <span class="free"><span class="bound"><span class="entity">log</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">G1</span><span class="main">,</span> <span class="bound">G2</span><span class="main">)</span> <span class="main">=</span> collect_training_sets <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="bound">uPTA</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="main">[]</span> <span class="main">[]</span>
    <span class="keyword1">in</span>
      <span class="keyword1">case</span> find_distinguishing_guards <span class="bound">G1</span> <span class="bound">G2</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> None <span class="main">|</span>
        Some <span class="main">(</span><span class="bound">g1</span><span class="main">,</span> <span class="bound">g2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>
          <span class="keyword1">let</span> <span class="bound">rep</span> <span class="main">=</span> replace_transitions <span class="free"><span class="bound"><span class="entity">preDestMerge</span></span></span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">,</span> add_guard <span class="bound">t1</span> <span class="bound">g1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2ID</span></span></span><span class="main">,</span> add_guard <span class="bound">t2</span> <span class="bound">g2</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">in</span>
          <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">(</span>tm <span class="bound">rep</span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="bound">rep</span> <span class="keyword1">else</span> None
        <span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">can_still_take_ctx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> transition_matrix <span class="main">⇒</span> cfstate <span class="main">⇒</span> cfstate <span class="main">⇒</span> transition <span class="main">⇒</span> transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">can_still_take_ctx</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> recognises <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="bound">t</span> <span class="main">∧</span> visits <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">∧</span> recognises <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="bound">t</span> <span class="main">∧</span> visits <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> obtains <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">t</span>  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="bound">i</span> <span class="bound">a</span> <span class="main">⟶</span> can_take_transition <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="bound">i</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="Distinguishing_Guards-distinguishing_guard_subsumption"><span class="command">lemma</span></span> distinguishing_guard_subsumption<span class="main">:</span>
<span class="quoted"><span class="quoted">"Label <span class="free">t1</span> <span class="main">=</span> Label <span class="free">t2</span> <span class="main">⟹</span>
 Arity <span class="free">t1</span> <span class="main">=</span> Arity <span class="free">t2</span> <span class="main">⟹</span>
 Outputs <span class="free">t1</span> <span class="main">=</span> Outputs <span class="free">t2</span> <span class="main">⟹</span>
 Updates <span class="free">t1</span> <span class="main">=</span> Updates <span class="free">t2</span> <span class="main">⟹</span>
 can_still_take_ctx <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟹</span>
 recognises <span class="free">e1</span> <span class="free">p</span> <span class="main">⟹</span>
 visits <span class="free">s1</span> <span class="free">e1</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free">p</span> <span class="main">⟹</span>
 obtains <span class="free">s2</span> <span class="free">c</span> <span class="free">e2</span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free">p</span> <span class="main">⟹</span>
 subsumes <span class="free">t1</span> <span class="free">c</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def can_still_take_ctx_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obtains_recognises obtains_visits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">recognises_and_visits_both</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">∃</span><span class="bound">p</span> <span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> obtains <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">c1</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">p</span> <span class="main">∧</span> obtains <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">c2</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">can_still_take</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
  Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
  Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
  Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
  can_still_take_ctx <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
  recognises_and_visits_both <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Distinguishing_Guards-can_still_take_direct_subsumption"><span class="command">lemma</span></span> can_still_take_direct_subsumption<span class="main">:</span>
  <span class="quoted"><span class="quoted">"can_still_take <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟹</span>
  directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directly_subsumes_def can_still_take_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> distinguishing_guard_subsumption obtains_visits obtains_recognises recognises_and_visits_both_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Weak_Subsumption">
<div class="head">
<h1>Theory Weak_Subsumption</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Weak Subsumption›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Unfortunately, the \emph{direct subsumption} relation cannot be transformed into executable
code. To solve this problem, \cite{foster2019} advocates for the use of a model checker, but this
turns out to be prohibitively slow for all but the smallest of examples. To solve this problem, we
must make a practical compromise and use another heuristic: the \emph{weak subsumption} heuristic.
This heuristic simply tries to delete each transition in turn and runs the original traces used to
build the PTA are still accepted. If so, this is taken as an acceptable substitute for direct
subsumption.

The acceptability of this, with respect to model behaviour, is justified by the fact that the
original traces are checked for acceptance. In situations where one transition genuinely does
directly subsume the other, the merge will go ahead as normal. In situations where one transition
does not directly subsume the other, the merge may still go ahead if replacing one transition with
the other still allows the model to accept the original traces. In this case, the heuristic makes an
overgeneralisation, but this is deemed to be acceptable since this is what heuristics are for. This
approach is clearly not as formal as we would like, but the compromise is necessary to allow models
to be inferred in reasonable time.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Weak_Subsumption
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Inference">../Inference</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">maxBy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">maxBy</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">weak_subsumption</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"update_modifier"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">weak_subsumption</span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
     <span class="bound">t1</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">;</span>
     <span class="bound">t2</span> <span class="main">=</span> get_by_ids <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span>
     <span class="keyword1">in</span>
     <span class="keyword1">if</span>
      same_structure <span class="bound">t1</span> <span class="bound">t2</span>
     <span class="keyword1">then</span>
      <span class="keyword1">let</span>
        <span class="bound">maxT</span> <span class="main">=</span> maxBy <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>length <span class="main">∘</span> Updates<span class="main">)</span> <span class="bound">x</span><span class="main">,</span> map snd <span class="main">(</span>Updates <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">t1</span> <span class="bound">t2</span><span class="main">;</span>
        <span class="bound">minT</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">maxT</span> <span class="main">=</span> <span class="bound">t1</span> <span class="keyword1">then</span> <span class="bound">t2</span> <span class="keyword1">else</span> <span class="bound">t1</span><span class="main">;</span>
        <span class="bound">newEFSMmax</span> <span class="main">=</span> replace_all <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span><span class="main">]</span> <span class="bound">maxT</span> <span class="keyword1">in</span>
      <span class="comment1">― ‹Most of the time, we'll want the transition with the most updates so start with that one›</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">(</span>tm <span class="bound">newEFSMmax</span><span class="main">)</span> <span class="keyword1">then</span>
        Some <span class="bound">newEFSMmax</span>
      <span class="keyword1">else</span>
        <span class="comment1">― ‹There may be other occasions where we want to try the other transition›</span>
        <span class="comment1">― ‹e.g. if their updates are equal but one has a different guard›</span>
        <span class="keyword1">let</span> <span class="bound">newEFSMmin</span> <span class="main">=</span> replace_all <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t1ID</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2ID</span></span></span><span class="main">]</span> <span class="bound">minT</span> <span class="keyword1">in</span>
        <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="main">(</span>tm <span class="bound">newEFSMmin</span><span class="main">)</span> <span class="keyword1">then</span>
          Some <span class="bound">newEFSMmin</span>
        <span class="keyword1">else</span>
          None
     <span class="keyword1">else</span>
      None
   <span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Group_By">
<div class="head">
<h1>Theory Group_By</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Group_By
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">group_by</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">group_by</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">group_by</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">group</span> <span class="main">=</span> <span class="main">(</span>takeWhile <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">dropped</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="bound">group</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="keyword1">in</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="bound">group</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">group_by</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">dropped</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>group_by <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Group_By-not_empty_group_by_drop"><span class="command">lemma</span></span> not_empty_group_by_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>group_by <span class="free">f</span> <span class="main">(</span>drop <span class="free">l</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_Cons' Let_def<span class="main">)</span>

<span class="keyword1" id="Group_By-no_empty_groups"><span class="command">lemma</span></span> no_empty_groups<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>group_by <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_empty_group_by_drop empty_iff empty_set group_by.elims list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_ConsD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop <span class="main">(</span>length <span class="main">(</span>takeWhile <span class="free">f</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> dropWhile <span class="free">f</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dropWhile_eq_drop<span class="main">)</span>

<span class="keyword1" id="Group_By-takeWhile_dropWhile"><span class="command">lemma</span></span> takeWhile_dropWhile<span class="main">:</span> <span class="quoted"><span class="quoted">"takeWhile <span class="free">f</span> <span class="free">l</span> <span class="main">@</span> dropWhile <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> <span class="free">l'</span> <span class="main">⟹</span> <span class="free">l'</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Group_By-append_pref"><span class="command">lemma</span></span> append_pref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">=</span> <span class="free">l''</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">l'</span> <span class="main">=</span> <span class="free">l</span><span class="main">@</span><span class="free">l''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Group_By-dropWhile_drop"><span class="command">lemma</span></span> dropWhile_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> dropWhile <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> drop <span class="bound">x</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dropWhile_eq_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Group_By-group_by_drop_foldr"><span class="command">lemma</span></span> group_by_drop_foldr<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="free">x</span> <span class="free">l</span> <span class="main">=</span> foldr <span class="main">(@)</span> <span class="main">(</span>group_by <span class="free">f</span> <span class="main">(</span>drop <span class="free">x</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_Cons' Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id takeWhile_eq_take<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Group_By-group_by_inverse"><span class="command">lemma</span></span> group_by_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"foldr <span class="main">(@)</span> <span class="main">(</span>group_by <span class="free">f</span> <span class="free">l</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def dropWhile_eq_drop<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> takeWhile_dropWhile<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="skolem"><span class="skolem">a</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> append_pref<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> dropWhile_drop<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="skolem"><span class="skolem">a</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">l</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> group_by_drop_foldr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="PTA_Generalisation">
<div class="head">
<h1>Theory PTA_Generalisation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹PTA Generalisation›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The problem with the simplistic heuristics of \cite{foster2019} is that the performance of the
Inference technique is almost entirely dependent on the quality and applicability of the heuristics
provided to it. Producing high quality heuristics often requires some inside knowledge of the system
under inference. If the user has this knowledge already, they are unlikely to require automated
inference. Ideally, we would like something more generally applicable. This theory presents a more
abstract \emph{metaheuristic} which can be implemented with genetic programming.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PTA_Generalisation
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#Inference">../Inference</a>"</span> <a href="#Same_Register">Same_Register</a> <a href="#Group_By">Group_By</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> I

<span class="keyword1"><span class="command">datatype</span></span> value_type <span class="main">=</span> N <span class="main">|</span> S

<span class="keyword1"><span class="command">instantiation</span></span> value_type <span class="main">::</span> <span class="quoted">linorder</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">less_value_type</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value_type <span class="main">⇒</span> value_type <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_value_type</span> N S <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">less_value_type</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_value_type</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value_type <span class="main">⇒</span> value_type <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">less_eq_value_type</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> less_eq_value_type_def less_value_type.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_value_type_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_value_type_def value_type.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> less_eq_value_type_def less_value_type.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_value_type_def less_value_type.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> value_type.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">― ‹This is a very hacky way of making sure that things with differently typed outputs don't get
    lumped together.›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">typeSig</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"output_function <span class="main">⇒</span> value_type"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">typeSig</span> <span class="main">(</span>L <span class="main">(</span>value.Str <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> S"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">typeSig</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> N"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">same_structure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">same_structure</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>
    Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
    Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
    map typeSig <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">=</span> map typeSig <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="PTA_Generalisation-same_structure_equiv"><span class="command">lemma</span></span> same_structure_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Outputs <span class="free">t1</span> <span class="main">=</span> <span class="main">[</span>L <span class="main">(</span>Num <span class="free">m</span><span class="main">)</span><span class="main">]</span> <span class="main">⟹</span> Outputs <span class="free">t2</span> <span class="main">=</span> <span class="main">[</span>L <span class="main">(</span>Num <span class="free">n</span><span class="main">)</span><span class="main">]</span> <span class="main">⟹</span>
   same_structure <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span> Transition.same_structure <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> same_structure_def Transition.same_structure_def<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> transition_group <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tids <span class="main">×</span> transition<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">observe_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span>  cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> trace <span class="main">⇒</span> transition_group"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">observe_all</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">observe_all</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span>  <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> random_member <span class="main">(</span>i_possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>  <span class="keyword1">of</span>
      <span class="main">(</span>Some <span class="main">(</span><span class="bound">ids</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">ids</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">observe_all</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
      <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">[]</span>
    <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">transition_groups_exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> trace <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> tids <span class="main">×</span> transition<span class="main">)</span> list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">transition_groups_exec</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> group_by <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">.</span> same_structure <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">(</span>enumerate <span class="main">0</span> <span class="main">(</span>observe_all <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> struct <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>label <span class="main">×</span> arity <span class="main">×</span> value_type list<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We need to take the list of transition groups and tag them with the last transition that was
taken which had a different structure.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tag</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"struct option <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> tids <span class="main">×</span> transition<span class="main">)</span> list list <span class="main">⇒</span> <span class="main">(</span>struct option <span class="main">×</span> struct <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> tids <span class="main">×</span> transition<span class="main">)</span> list<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tag</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">tag</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">head</span><span class="main">)</span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
      <span class="bound">struct</span> <span class="main">=</span> <span class="main">(</span>Label <span class="bound">head</span><span class="main">,</span> Arity <span class="bound">head</span><span class="main">,</span> map typeSig <span class="main">(</span>Outputs <span class="bound">head</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">in</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="bound">struct</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">tag</span> <span class="main">(</span>Some <span class="bound">struct</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We need to group transitions not just by their structure but also by their history - i.e. the
last transition which was taken which had a different structure. We need to order these groups by
their relative positions within the traces such that output and update functions can be inferred in
the correct order.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">transition_groups</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> log <span class="main">⇒</span> transition_group list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">transition_groups</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">trace_groups</span> <span class="main">=</span> map <span class="main">(</span>transition_groups_exec <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span>
      <span class="bound">tagged</span> <span class="main">=</span> map <span class="main">(</span>tag None<span class="main">)</span> <span class="bound">trace_groups</span><span class="main">;</span>
      <span class="bound">flat</span> <span class="main">=</span>  sort <span class="main">(</span>fold <span class="main">(@)</span> <span class="bound">tagged</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">group_fun</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tag</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">gp</span><span class="main">)</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="main">(</span><span class="bound">tag</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">$:=</span> <span class="bound">gp</span><span class="main">@</span><span class="main">(</span><span class="bound">f</span><span class="main">$</span><span class="main">(</span><span class="bound">tag</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">flat</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">grouped</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">group_fun</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>finfun_to_list <span class="bound">group_fun</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">inx_groups</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">gp</span><span class="main">.</span> <span class="main">(</span>Min <span class="main">(</span>set <span class="main">(</span>map fst <span class="bound">gp</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> map snd <span class="bound">gp</span><span class="main">)</span><span class="main">)</span> <span class="bound">grouped</span>
    <span class="keyword1">in</span>
      map snd <span class="main">(</span>sort <span class="bound">inx_groups</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For a given trace group, log, and EFSM, we want to build the training set for that group. That
is, the set of inputs, registers, and expected outputs from those transitions. To do this, we must
walk the traces in the EFSM to obtain the register values.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">trace_group_training_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_group <span class="main">⇒</span> iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> trace <span class="main">⇒</span> <span class="main">(</span>inputs <span class="main">×</span> registers <span class="main">×</span> value list<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>inputs <span class="main">×</span> registers <span class="main">×</span> value list<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_group_training_set</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">train</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">train</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_group_training_set</span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">train</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">transition</span><span class="main">)</span> <span class="main">=</span> fthe_elem <span class="main">(</span>i_possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="main">∃</span><span class="main">(</span><span class="bound">id'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">.</span> <span class="bound">id'</span> <span class="main">=</span> <span class="bound">id</span> <span class="keyword1">then</span>
      <span class="free">trace_group_training_set</span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">transition</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">train</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="free">trace_group_training_set</span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">transition</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">train</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">make_training_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> log <span class="main">⇒</span> transition_group <span class="main">⇒</span> <span class="main">(</span>inputs <span class="main">×</span> registers <span class="main">×</span> value list<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">make_training_set</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">h</span> <span class="bound">a</span><span class="main">.</span> trace_group_training_set <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">h</span> <span class="bound">a</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">replace_groups</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_group list <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replace_groups</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">replace_groups</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">replace_groups</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">acc</span><span class="main">.</span> replace_transition <span class="bound">acc</span> <span class="bound">id</span> <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PTA_Generalisation-replace_groups_fold"><span class="command">lemma</span></span> replace_groups_fold <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"replace_groups <span class="free">xs</span> <span class="free">e</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">h</span> <span class="bound">acc'</span><span class="main">.</span> <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">acc</span><span class="main">.</span> replace_transition <span class="bound">acc</span> <span class="bound">id</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">h</span> <span class="bound">acc'</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span>  <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert_updates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> update_function list <span class="main">⇒</span> transition"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert_updates</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="comment1">― ‹Want to filter out null updates of the form rn := rn. It doesn't affect anything but it  ›</span>
      <span class="comment1">― ‹does make things look cleaner                                                            ›</span>
      <span class="bound">necessary_updates</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≠</span> V <span class="main">(</span>R <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>
    <span class="keyword1">in</span>
    <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⦇</span>Updates <span class="main">:=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="bound">necessary_updates</span><span class="main">⦈</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_groupwise_updates_trace</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trace  <span class="main">⇒</span> <span class="main">(</span>tids <span class="main">×</span> update_function list<span class="main">)</span> list <span class="main">⇒</span> iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_groupwise_updates_trace</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_groupwise_updates_trace</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">trace</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> fthe_elem <span class="main">(</span>i_possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">updated</span> <span class="main">=</span> evaluate_updates <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
      <span class="bound">newUpdates</span> <span class="main">=</span> List.maps snd <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tids</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> set <span class="bound">id</span> <span class="main">⊆</span> set <span class="bound">tids</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">t'</span> <span class="main">=</span> insert_updates <span class="bound">t</span> <span class="bound">newUpdates</span><span class="main">;</span>
      <span class="bound">updated'</span> <span class="main">=</span> apply_updates <span class="main">(</span>Updates <span class="bound">t'</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
      <span class="bound">necessaryUpdates</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">updated</span> <span class="main">$</span> <span class="bound">r</span> <span class="main">≠</span> <span class="bound">updated'</span> <span class="main">$</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">newUpdates</span><span class="main">;</span>
      <span class="bound">t''</span> <span class="main">=</span> insert_updates <span class="bound">t</span> <span class="bound">necessaryUpdates</span><span class="main">;</span>
      <span class="bound">e'</span> <span class="main">=</span> replace_transition <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">id</span> <span class="bound">t''</span>
    <span class="keyword1">in</span>
    <span class="free">add_groupwise_updates_trace</span> <span class="free"><span class="bound"><span class="entity">trace</span></span></span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="bound">e'</span> <span class="bound">s'</span> <span class="bound">updated'</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">add_groupwise_updates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"log  <span class="main">⇒</span> <span class="main">(</span>tids <span class="main">×</span> update_function list<span class="main">)</span> list <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_groupwise_updates</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_groupwise_updates</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">add_groupwise_updates</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="main">(</span>add_groupwise_updates_trace <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PTA_Generalisation-fold_add_groupwise_updates"><span class="command">lemma</span></span> fold_add_groupwise_updates <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"add_groupwise_updates <span class="free">log</span> <span class="free">funs</span> <span class="free">e</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">trace</span> <span class="bound">acc</span><span class="main">.</span> add_groupwise_updates_trace <span class="bound">trace</span> <span class="free">funs</span> <span class="bound">acc</span> <span class="main">0</span> <span class="main">&lt;&gt;</span><span class="main">)</span> <span class="free">log</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">log</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">― ‹This will be replaced to calls to Z3 in the executable›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_regs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vname <span class="keyword1">⇒f</span> String.literal<span class="main">)</span> <span class="main">⇒</span> inputs <span class="main">⇒</span> vname aexp <span class="main">⇒</span> value <span class="main">⇒</span> registers"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_regs</span> <span class="free"><span class="bound"><span class="entity">types</span></span></span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="free"><span class="bound"><span class="entity">expression</span></span></span> <span class="free"><span class="bound"><span class="entity">output</span></span></span> <span class="main">=</span> Eps <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> aval <span class="free"><span class="bound"><span class="entity">expression</span></span></span> <span class="main">(</span>join_ir <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">output</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> get_regs_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">get_regs</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.getRegs"</span>

<span class="keyword1"><span class="command">type_synonym</span></span> action_info <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cfstate <span class="main">×</span> registers <span class="main">×</span> registers <span class="main">×</span> inputs <span class="main">×</span> tids <span class="main">×</span> transition<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> run_info <span class="main">=</span> <span class="quoted"><span class="quoted">"action_info list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> targeted_run_info <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>registers <span class="main">×</span> action_info<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">everything_walk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"output_function <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>vname <span class="keyword1">⇒f</span> String.literal<span class="main">)</span> <span class="main">⇒</span> trace <span class="main">⇒</span> iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> transition_group <span class="main">⇒</span> run_info"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">everything_walk</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">everything_walk</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="free"><span class="bound"><span class="entity">types</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">label</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">outputs</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">oPTA</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">regs</span></span></span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span>  <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">tid</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">ta</span><span class="main">)</span> <span class="main">=</span> fthe_elem <span class="main">(</span>i_possible_steps <span class="free"><span class="bound"><span class="entity">oPTA</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">regs</span></span></span> <span class="free"><span class="bound"><span class="entity">label</span></span></span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
     <span class="comment1">― ‹Possible steps with a transition we need to modify›</span>
    <span class="keyword1">if</span> <span class="main">∃</span><span class="main">(</span><span class="bound">tid'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">.</span> <span class="bound">tid</span> <span class="main">=</span> <span class="bound">tid'</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">regs</span></span></span><span class="main">,</span> get_regs <span class="free"><span class="bound"><span class="entity">types</span></span></span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">outputs</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">fi</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">,</span> <span class="bound">tid</span><span class="main">,</span> <span class="bound">ta</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">everything_walk</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="free"><span class="bound"><span class="entity">types</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">oPTA</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">ta</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="free"><span class="bound"><span class="entity">regs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="bound">empty</span> <span class="main">=</span> <span class="main">&lt;&gt;</span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">regs</span></span></span><span class="main">,</span> <span class="bound">empty</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">,</span> <span class="bound">tid</span><span class="main">,</span> <span class="bound">ta</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">everything_walk</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="free"><span class="bound"><span class="entity">types</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">oPTA</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">ta</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="free"><span class="bound"><span class="entity">regs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">everything_walk_log</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"output_function <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>vname <span class="keyword1">⇒f</span> String.literal<span class="main">)</span> <span class="main">⇒</span> log <span class="main">⇒</span> iEFSM <span class="main">⇒</span> transition_group <span class="main">⇒</span> run_info list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">everything_walk_log</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="free"><span class="bound"><span class="entity">types</span></span></span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> everything_walk <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="free"><span class="bound"><span class="entity">types</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">target</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"registers <span class="main">⇒</span> run_info <span class="main">⇒</span> targeted_run_info"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="free"><span class="bound"><span class="entity">tRegs</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">oldregs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">regs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">newTarget</span> <span class="main">=</span> <span class="keyword1">if</span> finfun_to_list <span class="free"><span class="bound"><span class="entity">regs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">tRegs</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">regs</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tRegs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">oldregs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">regs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span><span class="main">)</span><span class="main">#</span><span class="free">target</span> <span class="bound">newTarget</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">target_tail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"registers <span class="main">⇒</span> run_info <span class="main">⇒</span> targeted_run_info <span class="main">⇒</span> targeted_run_info"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">target_tail</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="main">=</span> rev <span class="free"><span class="bound"><span class="entity">tt</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">target_tail</span> <span class="free"><span class="bound"><span class="entity">tRegs</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">oldregs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">regs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">newTarget</span> <span class="main">=</span> <span class="keyword1">if</span> finfun_to_list <span class="free"><span class="bound"><span class="entity">regs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">tRegs</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">regs</span></span></span> <span class="keyword1">in</span>
    <span class="free">target_tail</span> <span class="bound">newTarget</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">tRegs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">oldregs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">regs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ta</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">tt</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="PTA_Generalisation-target_tail"><span class="command">lemma</span></span> target_tail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rev <span class="free">bs</span><span class="main">)</span><span class="main">@</span><span class="main">(</span>target <span class="free">tRegs</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> target_tail <span class="free">tRegs</span> <span class="free">ts</span> <span class="free">bs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">tRegs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> append_eq_append_conv2 rev.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rev_append rev_swap self_append_conv2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">target_fold</span> <span class="free"><span class="bound"><span class="entity">tRegs</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> fst <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">oldregs</span><span class="main">,</span> <span class="bound">regs</span><span class="main">,</span> <span class="bound">inputs</span><span class="main">,</span> <span class="bound">tid</span><span class="main">,</span> <span class="bound">ta</span><span class="main">)</span> <span class="main">(</span><span class="bound">acc</span><span class="main">,</span> <span class="bound">tRegs</span><span class="main">)</span><span class="main">.</span>
<span class="keyword1">let</span> <span class="bound">newTarget</span> <span class="main">=</span> <span class="keyword1">if</span> finfun_to_list <span class="bound">regs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="bound">tRegs</span> <span class="keyword1">else</span> <span class="bound">regs</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">acc</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="bound">tRegs</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">oldregs</span><span class="main">,</span> <span class="bound">regs</span><span class="main">,</span> <span class="bound">inputs</span><span class="main">,</span> <span class="bound">tid</span><span class="main">,</span> <span class="bound">ta</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">newTarget</span><span class="main">)</span>
<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tRegs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PTA_Generalisation-target_tail_fold"><span class="command">lemma</span></span> target_tail_fold<span class="main">:</span> <span class="quoted"><span class="quoted">"target_tail <span class="free">tRegs</span> <span class="free">ts</span> <span class="free">b</span> <span class="main">=</span> target_fold <span class="free">tRegs</span> <span class="free">ts</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">tRegs</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> target_fold_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> target_fold_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PTA_Generalisation-target_fold"><span class="command">lemma</span></span> target_fold <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"target <span class="free">tRegs</span> <span class="free">ts</span> <span class="main">=</span> target_fold <span class="free">tRegs</span> <span class="free">ts</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_self_conv2 rev.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> target_tail_fold target_tail<span class="main">)</span>

<span class="comment1">― ‹This will be replaced by symbolic regression in the executable›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"label <span class="main">⇒</span> nat <span class="main">⇒</span> value list <span class="main">⇒</span> <span class="main">(</span>inputs <span class="main">×</span> registers <span class="main">×</span> registers<span class="main">)</span> list <span class="main">⇒</span> vname aexp option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_update</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">reg</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">train</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
    <span class="bound">possible_funs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">train</span></span></span><span class="main">.</span> aval <span class="bound">a</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="bound">r'</span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">reg</span></span></span><span class="main">}</span>
    <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">possible_funs</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>Eps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">possible_funs</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> get_update_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">get_update</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.getUpdate"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_updates_opt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"label <span class="main">⇒</span> value list <span class="main">⇒</span> <span class="main">(</span>inputs <span class="main">×</span> registers <span class="main">×</span> registers<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> vname aexp option<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_updates_opt</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">train</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
    <span class="bound">updated_regs</span> <span class="main">=</span> fold List.union <span class="main">(</span>map <span class="main">(</span>finfun_to_list <span class="main">∘</span> snd <span class="main">∘</span> snd<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">train</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="keyword1">in</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="bound">targetValues</span> <span class="main">=</span> remdups <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">regs</span><span class="main">)</span><span class="main">.</span> <span class="bound">regs</span> <span class="main">$</span> <span class="bound">r</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">train</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span>  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">anteriorRegs</span><span class="main">,</span> <span class="bound">posteriorRegs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">train</span></span></span><span class="main">.</span> <span class="bound">anteriorRegs</span> <span class="main">$</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">posteriorRegs</span> <span class="main">$</span> <span class="bound">r</span><span class="main">)</span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="bound">r</span><span class="main">,</span> Some <span class="main">(</span>V <span class="main">(</span>R <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> length <span class="bound">targetValues</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">inputs</span><span class="main">,</span> <span class="bound">anteriorRegs</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">train</span></span></span><span class="main">.</span> finfun_to_list <span class="bound">anteriorRegs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">then</span>
        <span class="keyword1">case</span> hd <span class="bound">targetValues</span> <span class="keyword1">of</span> Some <span class="bound">v</span> <span class="main">⇒</span>
        <span class="main">(</span><span class="bound">r</span><span class="main">,</span> Some <span class="main">(</span>L <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="main">(</span><span class="bound">r</span><span class="main">,</span> get_update <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">train</span></span></span><span class="main">)</span>
    <span class="main">)</span> <span class="bound">updated_regs</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finfun_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="keyword1">⇒f</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">finfun_add</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">k</span> <span class="main">$:=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">$</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>finfun_to_list <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">group_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value list <span class="main">⇒</span> targeted_run_info <span class="main">⇒</span> <span class="main">(</span>tids <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> vname aexp<span class="main">)</span> list<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">group_update</span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span>
      <span class="bound">targeted</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">regs</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> finfun_to_list <span class="bound">regs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span>
      <span class="bound">maybe_updates</span> <span class="main">=</span> get_updates_opt <span class="main">(</span>Label <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tRegs</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">oldRegs</span><span class="main">,</span> <span class="bound">regs</span><span class="main">,</span> <span class="bound">inputs</span><span class="main">,</span> <span class="bound">tid</span><span class="main">,</span> <span class="bound">ta</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">inputs</span><span class="main">,</span> finfun_add <span class="bound">oldRegs</span> <span class="bound">regs</span><span class="main">,</span> <span class="bound">tRegs</span><span class="main">)</span><span class="main">)</span> <span class="bound">targeted</span><span class="main">)</span>
    <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="main">∃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">f_opt</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">maybe_updates</span><span class="main">.</span> <span class="bound">f_opt</span> <span class="main">=</span> None <span class="keyword1">then</span>
      None
    <span class="keyword1">else</span>
      Some <span class="main">(</span>fold List.union <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tRegs</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">oldRegs</span><span class="main">,</span> <span class="bound">regs</span><span class="main">,</span> <span class="bound">inputs</span><span class="main">,</span> <span class="bound">tid</span><span class="main">,</span> <span class="bound">ta</span><span class="main">)</span><span class="main">.</span> <span class="bound">tid</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">[]</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">f_o</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> the <span class="bound">f_o</span><span class="main">)</span><span class="main">)</span> <span class="bound">maybe_updates</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">groupwise_put_updates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_group list <span class="main">⇒</span> log <span class="main">⇒</span> value list <span class="main">⇒</span> run_info list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span>vname aexp <span class="main">×</span> vname <span class="keyword1">⇒f</span> String.literal<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">groupwise_put_updates</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span>  <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">groupwise_put_updates</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">gps</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">walked</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">o_inx</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">types</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">targeted</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">id</span><span class="main">,</span> <span class="bound">tran</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">tran</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> rev <span class="main">(</span>target <span class="main">&lt;&gt;</span> <span class="main">(</span>rev <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">walked</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">group</span> <span class="main">=</span> fold List.union <span class="bound">targeted</span> <span class="main">[]</span>
    <span class="keyword1">in</span>
    <span class="keyword1">case</span> group_update <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="bound">group</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="free">groupwise_put_updates</span> <span class="free"><span class="bound"><span class="entity">gps</span></span></span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">walked</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">o_inx</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">types</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">|</span>
      Some <span class="bound">u</span> <span class="main">⇒</span> <span class="free">groupwise_put_updates</span> <span class="free"><span class="bound"><span class="entity">gps</span></span></span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">walked</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">o_inx</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">types</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>make_distinct <span class="main">(</span>add_groupwise_updates <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="main">[</span><span class="bound">u</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">updates_for_output</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"log <span class="main">⇒</span> value list <span class="main">⇒</span> transition_group <span class="main">⇒</span> nat <span class="main">⇒</span> vname aexp <span class="main">⇒</span> vname <span class="keyword1">⇒f</span> String.literal <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">updates_for_output</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">current</span></span></span> <span class="free"><span class="bound"><span class="entity">o_inx</span></span></span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">types</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> AExp.enumerate_regs <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="keyword1">else</span>
    <span class="keyword1">let</span>
      <span class="bound">walked</span> <span class="main">=</span> everything_walk_log <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">o_inx</span></span></span> <span class="free"><span class="bound"><span class="entity">types</span></span></span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">current</span></span></span><span class="main">;</span>
      <span class="bound">groups</span> <span class="main">=</span> transition_groups <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">log</span></span></span>
    <span class="keyword1">in</span>
    groupwise_put_updates <span class="bound">groups</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="bound">walked</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">o_inx</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">types</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> output_types <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vname aexp <span class="main">×</span> vname <span class="keyword1">⇒f</span> String.literal<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">put_updates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"log <span class="main">⇒</span> value list <span class="main">⇒</span> transition_group <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> output_types option<span class="main">)</span> list <span class="main">⇒</span> iEFSM <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">put_updates</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">put_updates</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> None<span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ops</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">put_updates</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">put_updates</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">o_inx</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">types</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ops</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">gp'</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">t</span><span class="main">⦇</span>Outputs <span class="main">:=</span> list_update <span class="main">(</span>Outputs <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">o_inx</span></span></span> <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">;</span>
      <span class="bound">generalised_model</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">acc</span><span class="main">.</span> replace_transition <span class="bound">acc</span> <span class="bound">id</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">gp'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
      <span class="bound">e'</span> <span class="main">=</span> updates_for_output <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="free"><span class="bound"><span class="entity">o_inx</span></span></span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">types</span></span></span> <span class="bound">generalised_model</span>
    <span class="keyword1">in</span>
    <span class="keyword1">if</span> accepts_log <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">log</span></span></span><span class="main">)</span> <span class="main">(</span>tm <span class="bound">e'</span><span class="main">)</span> <span class="keyword1">then</span>
     <span class="free">put_updates</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="bound">gp'</span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="bound">e'</span>
    <span class="keyword1">else</span>
     <span class="free">put_updates</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="free"><span class="bound"><span class="entity">ops</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">unzip_3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'c</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unzip_3</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">unzip_3</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">,</span> <span class="bound">cs</span><span class="main">)</span> <span class="main">=</span> <span class="free">unzip_3</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="bound">as</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">#</span><span class="bound">bs</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">#</span><span class="bound">cs</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="PTA_Generalisation-unzip_3"><span class="command">lemma</span></span> unzip_3<span class="main">:</span> <span class="quoted"><span class="quoted">"unzip_3 <span class="free">l</span> <span class="main">=</span> <span class="main">(</span>map fst <span class="free">l</span><span class="main">,</span> map <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="free">l</span><span class="main">,</span> map <span class="main">(</span>snd <span class="main">∘</span> snd<span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">unzip_3_tailrec_rev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'c</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'c</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unzip_3_tailrec_rev</span> <span class="main">[]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">unzip_3_tailrec_rev</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">unzip_3_tailrec_rev</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PTA_Generalisation-unzip_3_tailrec_rev"><span class="command">lemma</span></span> unzip_3_tailrec_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"unzip_3_tailrec_rev <span class="free">l</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">bs</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>map_tailrec_rev fst <span class="free">l</span> <span class="free">as</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>map_tailrec_rev <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="free">l</span> <span class="free">bs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>map_tailrec_rev <span class="main">(</span>snd <span class="main">∘</span> snd<span class="main">)</span> <span class="free">l</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">unzip_3_tailrec</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">,</span> <span class="bound">cs</span><span class="main">)</span> <span class="main">=</span> unzip_3_tailrec_rev <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>rev <span class="bound">as</span><span class="main">,</span> rev <span class="bound">bs</span><span class="main">,</span> rev <span class="bound">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="PTA_Generalisation-unzip_3_tailrec"><span class="command">lemma</span></span> unzip_3_tailrec <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unzip_3 <span class="free">l</span> <span class="main">=</span> unzip_3_tailrec <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> unzip_3_tailrec_def unzip_3_tailrec_rev<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def map_tailrec_rev unzip_3 map_eq_map_tailrec<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We want to return an aexp which, when evaluated in the correct context accounts for the literal
input-output pairs within the training set. This will be replaced by symbolic regression in the
executable›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_output</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"label <span class="main">⇒</span> nat <span class="main">⇒</span> value list <span class="main">⇒</span> <span class="main">(</span>inputs <span class="main">×</span> registers <span class="main">×</span> value<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>vname aexp <span class="main">×</span> <span class="main">(</span>vname <span class="keyword1">⇒f</span> String.literal<span class="main">)</span><span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_output</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">maxReg</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">train</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
    <span class="bound">possible_funs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">train</span></span></span><span class="main">.</span> aval <span class="bound">a</span> <span class="main">(</span>join_ir <span class="bound">i</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">p</span><span class="main">}</span>
    <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">possible_funs</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>Eps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">possible_funs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">K$</span> <span class="keyword1">STR</span> <span class="inner_quoted">''int''</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> get_output_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">get_output</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.getOutput"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_outputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"label <span class="main">⇒</span> nat <span class="main">⇒</span> value list <span class="main">⇒</span> inputs list <span class="main">⇒</span> registers list <span class="main">⇒</span> value list list <span class="main">⇒</span> <span class="main">(</span>vname aexp <span class="main">×</span> <span class="main">(</span>vname <span class="keyword1">⇒f</span> String.literal<span class="main">)</span><span class="main">)</span> option list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_outputs</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">maxReg</span></span></span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">outputs</span></span></span> <span class="main">=</span> map_tailrec <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">maxReg</span><span class="main">,</span> <span class="bound">ps</span><span class="main">)</span><span class="main">.</span> get_output <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">maxReg</span> <span class="free"><span class="bound"><span class="entity">values</span></span></span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">ps</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>enumerate <span class="free"><span class="bound"><span class="entity">maxReg</span></span></span> <span class="main">(</span>transpose <span class="free"><span class="bound"><span class="entity">outputs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enumerate_exec_values</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trace <span class="main">⇒</span> value list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_exec_values</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">I</span><span class="main">.</span> List.union <span class="main">(</span>List.union <span class="bound">i</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">I</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enumerate_log_values</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"log <span class="main">⇒</span> value list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumerate_log_values</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">e</span> <span class="bound">I</span><span class="main">.</span> List.union <span class="main">(</span>enumerate_exec_values <span class="bound">e</span><span class="main">)</span> <span class="bound">I</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">[]</span>"</span></span>

<span class="comment1">(*This is where the types stuff originates*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">generalise_and_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"log <span class="main">⇒</span> iEFSM <span class="main">⇒</span> transition_group <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">generalise_and_update</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">label</span> <span class="main">=</span> Label <span class="main">(</span>snd <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">values</span> <span class="main">=</span> enumerate_log_values <span class="free"><span class="bound"><span class="entity">log</span></span></span><span class="main">;</span>
      <span class="bound">new_gp_ts</span> <span class="main">=</span> make_training_set <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">R</span><span class="main">,</span> <span class="bound">P</span><span class="main">)</span> <span class="main">=</span> unzip_3 <span class="bound">new_gp_ts</span><span class="main">;</span>
      <span class="bound">max_reg</span> <span class="main">=</span> max_reg_total <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
      <span class="bound">outputs</span> <span class="main">=</span> get_outputs <span class="bound">label</span> <span class="bound">max_reg</span> <span class="bound">values</span> <span class="bound">I</span> <span class="bound">R</span> <span class="bound">P</span>
    <span class="keyword1">in</span>
      put_updates <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="bound">values</span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="main">(</span>enumerate <span class="main">0</span> <span class="bound">outputs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Splitting structural groups up into subgroups by previous transition can cause different
subgroups to get different updates. We ideally want structural groups to have the same output and
update functions, as structural groups are likely to be instances of the same underlying behaviour.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">standardise_group</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> log <span class="main">⇒</span> transition_group <span class="main">⇒</span> <span class="main">(</span>iEFSM <span class="main">⇒</span> log <span class="main">⇒</span> transition_group <span class="main">⇒</span> transition_group<span class="main">)</span> <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">standardise_group</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">standardised</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">;</span>
      <span class="bound">e'</span> <span class="main">=</span> replace_transitions <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">standardised</span>
    <span class="keyword1">in</span>
      <span class="keyword1">if</span> <span class="bound">e'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">else</span>
      <span class="keyword1">if</span> accepts_log <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>tm <span class="bound">e'</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">e'</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">find_outputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"output_function list list <span class="main">⇒</span> iEFSM <span class="main">⇒</span> log <span class="main">⇒</span> transition_group <span class="main">⇒</span> output_function list option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_outputs</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">find_outputs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">outputs</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tids</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">acc</span><span class="main">.</span> replace_transition <span class="bound">acc</span> <span class="bound">tids</span> <span class="main">(</span><span class="bound">t</span><span class="main">⦇</span>Outputs <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
    <span class="keyword1">in</span>
      <span class="keyword1">if</span> accepts_log <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>tm <span class="bound">outputs</span><span class="main">)</span> <span class="keyword1">then</span>
        Some <span class="free"><span class="bound"><span class="entity">h</span></span></span>
      <span class="keyword1">else</span>
        <span class="free">find_outputs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">find_updates_outputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"update_function list list <span class="main">⇒</span> output_function list list <span class="main">⇒</span> iEFSM <span class="main">⇒</span> log <span class="main">⇒</span> transition_group <span class="main">⇒</span> <span class="main">(</span>output_function list <span class="main">×</span> update_function list<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_updates_outputs</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">find_updates_outputs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">updates</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tids</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">acc</span><span class="main">.</span> replace_transition <span class="bound">acc</span> <span class="bound">tids</span> <span class="main">(</span><span class="bound">t</span><span class="main">⦇</span>Updates <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
    <span class="keyword1">in</span>
      <span class="keyword1">case</span> find_outputs <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">updates</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">id</span><span class="main">,</span><span class="bound">t</span><span class="main">⦇</span>Updates <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>  <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
        Some <span class="bound">pp</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">pp</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">|</span>
        None <span class="main">⇒</span> <span class="free">find_updates_outputs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">updates_for</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"update_function list <span class="main">⇒</span> update_function list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">updates_for</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">uf</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">r</span> <span class="main">$:=</span> <span class="bound">u</span><span class="main">#</span><span class="main">(</span><span class="bound">f</span> <span class="main">$</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">(</span><span class="keyword1">K$</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">in</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">uf</span> <span class="main">$</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>finfun_to_list <span class="bound">uf</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">standardise_group_outputs_updates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> log <span class="main">⇒</span> transition_group <span class="main">⇒</span> transition_group"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">standardise_group_outputs_updates</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">update_groups</span> <span class="main">=</span> product_lists <span class="main">(</span>updates_for <span class="main">(</span>remdups <span class="main">(</span>List.maps <span class="main">(</span>Updates <span class="main">∘</span> snd<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">update_groups_subs</span> <span class="main">=</span> fold <span class="main">(</span>List.union <span class="main">∘</span> subseqs<span class="main">)</span> <span class="bound">update_groups</span> <span class="main">[]</span><span class="main">;</span>
      <span class="bound">output_groups</span> <span class="main">=</span> product_lists <span class="main">(</span>transpose <span class="main">(</span>remdups <span class="main">(</span>map <span class="main">(</span>Outputs <span class="main">∘</span> snd<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">in</span>
    <span class="keyword1">case</span> find_updates_outputs <span class="bound">update_groups_subs</span> <span class="bound">output_groups</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">|</span>
      Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⇒</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">t</span><span class="main">⦇</span>Outputs <span class="main">:=</span> <span class="bound">p</span><span class="main">,</span> Updates <span class="main">:=</span> <span class="bound">u</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_first_use_of_trace</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> trace <span class="main">⇒</span> iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> tids option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_first_use_of_trace</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">find_first_use_of_trace</span> <span class="free"><span class="bound"><span class="entity">rr</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> fthe_elem <span class="main">(</span>i_possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span>
      <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>Outputs <span class="bound">t</span><span class="main">)</span><span class="main">.</span> aexp_constrains <span class="bound">p</span> <span class="main">(</span>V <span class="main">(</span>R <span class="free"><span class="bound"><span class="entity">rr</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
        Some <span class="bound">id</span>
      <span class="keyword1">else</span>
        <span class="free">find_first_use_of_trace</span> <span class="free"><span class="bound"><span class="entity">rr</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_first_uses_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> log <span class="main">⇒</span> iEFSM <span class="main">⇒</span> tids list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_first_uses_of</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> List.maps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> find_first_use_of_trace <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_initialisation_of_trace</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> trace <span class="main">⇒</span> iEFSM <span class="main">⇒</span> cfstate <span class="main">⇒</span> registers <span class="main">⇒</span> <span class="main">(</span>tids <span class="main">×</span> transition<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_initialisation_of_trace</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">find_initialisation_of_trace</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="main">(</span><span class="bound">tids</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> fthe_elem <span class="main">(</span>i_possible_steps <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">rr</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Updates <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">rr</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">∧</span> is_lit <span class="bound">u</span><span class="main">)</span> <span class="keyword1">then</span>
      Some <span class="main">(</span><span class="bound">tids</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="free">find_initialisation_of_trace</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s'</span> <span class="main">(</span>evaluate_updates <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">find_initialisation_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> iEFSM <span class="main">⇒</span> log <span class="main">⇒</span> <span class="main">(</span>tids <span class="main">×</span> transition<span class="main">)</span> option list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_initialisation_of</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">find_initialisation_of</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">case</span> find_initialisation_of_trace <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="free">find_initialisation_of</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|</span>
      Some <span class="bound">thing</span> <span class="main">⇒</span> Some <span class="bound">thing</span><span class="main">#</span><span class="main">(</span><span class="free">find_initialisation_of</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">delay_initialisation_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> log <span class="main">⇒</span> iEFSM <span class="main">⇒</span> tids list <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delay_initialisation_of</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">tids</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">e</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="bound">e</span> <span class="main">|</span>
    Some <span class="main">(</span><span class="bound">i_tids</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="keyword1">let</span>
        <span class="bound">origins</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">id</span><span class="main">.</span> origin <span class="bound">id</span> <span class="bound">e</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tids</span></span></span><span class="main">;</span>
        <span class="bound">init_val</span> <span class="main">=</span> snd <span class="main">(</span>hd <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">(</span>Updates <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">e'</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="main">(</span><span class="bound">origin'</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">tr</span><span class="main">)</span><span class="main">.</span>
        <span class="comment1">― ‹Add the initialisation update to incoming transitions›</span>
        <span class="keyword1">if</span> <span class="bound">dest</span> <span class="main">∈</span> set <span class="bound">origins</span> <span class="keyword1">then</span>
          <span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="main">(</span><span class="bound">origin'</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">tr</span><span class="main">⦇</span>Updates <span class="main">:=</span> List.insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="bound">init_val</span><span class="main">)</span> <span class="main">(</span>Updates <span class="bound">tr</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>
        <span class="comment1">― ‹Strip the initialisation update from the original initialising transition›</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">id</span> <span class="main">=</span> <span class="bound">i_tids</span> <span class="keyword1">then</span>
          <span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="main">(</span><span class="bound">origin'</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">tr</span><span class="main">⦇</span>Updates <span class="main">:=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≠</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">(</span>Updates <span class="bound">tr</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="main">(</span><span class="bound">origin'</span><span class="main">,</span> <span class="bound">dest</span><span class="main">)</span><span class="main">,</span> <span class="bound">tr</span><span class="main">)</span>
      <span class="main">)</span> <span class="bound">e</span>
      <span class="keyword1">in</span>
      <span class="comment1">― ‹We don't want to update a register twice so just leave it›</span>
      <span class="keyword1">if</span> accepts_log <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>tm <span class="bound">e'</span><span class="main">)</span> <span class="keyword1">then</span>
        <span class="bound">e'</span>
      <span class="keyword1">else</span>
        <span class="bound">e</span>
  <span class="main">)</span> <span class="main">(</span>find_initialisation_of <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">groupwise_generalise_and_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"log <span class="main">⇒</span> iEFSM <span class="main">⇒</span> transition_group list <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">groupwise_generalise_and_update</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">groupwise_generalise_and_update</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword1">let</span>
          <span class="bound">e'</span> <span class="main">=</span> generalise_and_update <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">;</span>
          <span class="bound">rep</span> <span class="main">=</span> snd <span class="main">(</span>hd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">gp</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">structural_group</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> same_structure <span class="bound">rep</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">e'</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">delayed</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">acc</span><span class="main">.</span> delay_initialisation_of <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="bound">acc</span> <span class="main">(</span>find_first_uses_of <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="bound">acc</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>all_regs <span class="bound">e'</span><span class="main">)</span><span class="main">)</span> <span class="bound">e'</span><span class="main">;</span>
          <span class="bound">standardised</span> <span class="main">=</span> standardise_group <span class="bound">delayed</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="main">(</span>sorted_list_of_fset <span class="bound">structural_group</span><span class="main">)</span> standardise_group_outputs_updates<span class="main">;</span>
          <span class="bound">structural_group2</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Outputs <span class="bound">t</span><span class="main">,</span> Updates <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span>  Label <span class="bound">rep</span> <span class="main">=</span> Label <span class="bound">t</span> <span class="main">∧</span> Arity <span class="bound">rep</span> <span class="main">=</span> Arity <span class="bound">t</span> <span class="main">∧</span> length <span class="main">(</span>Outputs <span class="bound">rep</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>Outputs <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">standardised</span><span class="main">)</span>
        <span class="keyword1">in</span>
        <span class="comment1">― ‹If we manage to standardise a structural group, we do not need to evolve outputs and
            updates for the other historical subgroups so can filter them out.›</span>
        <span class="keyword1">if</span> fis_singleton <span class="bound">structural_group2</span> <span class="keyword1">then</span>
          <span class="free">groupwise_generalise_and_update</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="main">(</span>merge_regs <span class="bound">standardised</span> <span class="main">(</span>accepts_log <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">log</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> set <span class="bound">g</span> <span class="main">∩</span> fset <span class="bound">structural_group</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="free">groupwise_generalise_and_update</span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="main">(</span>merge_regs <span class="bound">standardised</span> <span class="main">(</span>accepts_log <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">log</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">drop_all_guards</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> iEFSM <span class="main">⇒</span> log <span class="main">⇒</span> update_modifier <span class="main">⇒</span> <span class="main">(</span>iEFSM <span class="main">⇒</span> nondeterministic_pair fset<span class="main">)</span> <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">drop_all_guards</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pta</span></span></span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
      <span class="bound">derestricted</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">tf</span><span class="main">,</span> <span class="bound">tran</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">id</span><span class="main">,</span> <span class="bound">tf</span><span class="main">,</span> <span class="bound">tran</span><span class="main">⦇</span>Guards <span class="main">:=</span> <span class="main">[]</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
      <span class="bound">nondeterministic_pairs</span> <span class="main">=</span> sorted_list_of_fset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="bound">derestricted</span><span class="main">)</span>
    <span class="keyword1">in</span>
    <span class="keyword1">case</span> resolve_nondeterminism <span class="main">{}</span> <span class="bound">nondeterministic_pairs</span> <span class="free"><span class="bound"><span class="entity">pta</span></span></span> <span class="bound">derestricted</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>accepts_log <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">log</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="keyword1">of</span>
      <span class="main">(</span>None<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">pta</span></span></span> <span class="main">|</span>
      <span class="main">(</span>Some <span class="bound">resolved</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">resolved</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">updated_regs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">updated_regs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fewer_updates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition fset <span class="main">⇒</span> transition option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fewer_updates</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">p</span> <span class="main">=</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">t'</span><span class="main">.</span> same_structure <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">t'</span> <span class="main">∧</span> Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Outputs <span class="bound">t'</span> <span class="main">∧</span> updated_regs <span class="bound">t'</span> <span class="main">⊂</span> updated_regs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>snd <span class="main">(</span>fMin <span class="main">(</span>fimage <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>length <span class="main">(</span>Updates <span class="bound">t</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove_spurious_updates_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> transition_group <span class="main">⇒</span> transition fset <span class="main">⇒</span> log <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_spurious_updates_aux</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_spurious_updates_aux</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">tid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">case</span> fewer_updates <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="free">remove_spurious_updates_aux</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">|</span>
      Some <span class="bound">t'</span> <span class="main">⇒</span> <span class="main">(</span>
        <span class="keyword1">let</span> <span class="bound">e'</span> <span class="main">=</span> replace_transition <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="bound">t'</span> <span class="keyword1">in</span>
        <span class="keyword1">if</span> accepts_log <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>tm <span class="bound">e'</span><span class="main">)</span> <span class="keyword1">then</span>
          <span class="free">remove_spurious_updates_aux</span> <span class="bound">e'</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
        <span class="keyword1">else</span>
          <span class="free">remove_spurious_updates_aux</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">tt</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
      <span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="comment1">(* This goes through and tries to remove spurious updates that get introduced during preprocessing *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remove_spurious_updates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> log <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_spurious_updates</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">transitions</span> <span class="main">=</span> fimage <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tid</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">tid</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">in</span>
      remove_spurious_updates_aux <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>sorted_list_of_fset <span class="bound">transitions</span><span class="main">)</span> <span class="main">(</span>fimage snd <span class="bound">transitions</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">derestrict</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> log <span class="main">⇒</span> update_modifier <span class="main">⇒</span> <span class="main">(</span>iEFSM <span class="main">⇒</span> nondeterministic_pair fset<span class="main">)</span> <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">derestrict</span> <span class="free"><span class="bound"><span class="entity">pta</span></span></span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">normalised</span> <span class="main">=</span> groupwise_generalise_and_update <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">pta</span></span></span> <span class="main">(</span>transition_groups <span class="free"><span class="bound"><span class="entity">pta</span></span></span> <span class="free"><span class="bound"><span class="entity">log</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span>
      drop_all_guards <span class="bound">normalised</span> <span class="free"><span class="bound"><span class="entity">pta</span></span></span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">drop_pta_guards</span> <span class="free"><span class="bound"><span class="entity">pta</span></span></span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">=</span> drop_all_guards <span class="free"><span class="bound"><span class="entity">pta</span></span></span> <span class="free"><span class="bound"><span class="entity">pta</span></span></span> <span class="free"><span class="bound"><span class="entity">log</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="EFSM_Dot">
<div class="head">
<h1>Theory EFSM_Dot</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span><span class="quoted"><span class="plain_text">‹Output›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This chapter provides two different output formats for EFSMs.›</span></span> 

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Graphical Output›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹It is often more intuitive and aesthetically pleasing to view EFSMs graphically. DOT is a graph
layout engine which converts textual representations of graphs to more useful formats, such as SVG
or PNG representations. This theory defines functions to convert arbitrary EFSMs to DOT for easier
viewing. Here, transitions use the syntactic sugar presented in \cite{foster2018} such that they
take the form $\textit{label}:\textit{arity}[g_1, \ldots, g_g]/f_1, \ldots, f_f[u_1, \ldots, u_u]$.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> EFSM_Dot
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Inference">Inference</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">string_of_digit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">string_of_digit</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span>
         <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''0''</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''1''</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''2''</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">3</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''3''</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">4</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''4''</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">5</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''5''</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">6</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''6''</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">7</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''7''</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">8</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''8''</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''9''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">newline</span> <span class="main">::</span> <span class="quoted">String.literal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">newline</span> <span class="main">≡</span> <span class="keyword1">STR</span> <span class="inner_quoted">''\010''</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">quote</span> <span class="main">::</span> <span class="quoted">String.literal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">quote</span> <span class="main">≡</span> <span class="keyword1">STR</span> <span class="inner_quoted">''\"''</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">shows_string</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal <span class="main">⇒</span> String.literal <span class="main">⇒</span> String.literal"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shows_string</span> <span class="main">=</span> <span class="main">(+)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">showsp_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal <span class="main">⇒</span> nat <span class="main">⇒</span> String.literal <span class="main">⇒</span> String.literal"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">showsp_nat</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="numeral">10</span> <span class="keyword1">then</span> shows_string <span class="main">(</span>string_of_digit <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free">showsp_nat</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">10</span><span class="main">)</span> <span class="keyword1">o</span> shows_string <span class="main">(</span>string_of_digit <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="numeral">10</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> showsp_nat.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">showsp_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal <span class="main">⇒</span> int <span class="main">⇒</span> String.literal <span class="main">⇒</span> String.literal"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">showsp_int</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> shows_string <span class="keyword1">STR</span> <span class="inner_quoted">''-''</span> <span class="keyword1">o</span> showsp_nat <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> showsp_nat <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>nat <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">show_int</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>  <span class="main">≡</span> showsp_int <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''''</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''''</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">show_nat</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>  <span class="main">≡</span> showsp_nat <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''''</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">replace_backslash</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replace_backslash</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> String.implode <span class="main">(</span>fold <span class="main">(@)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="numeral">0x5c</span> <span class="keyword1">then</span> <span class="main">[</span><span class="keyword1">CHR</span> <span class="numeral">0x5c</span><span class="main">,</span><span class="keyword1">CHR</span> <span class="numeral">0x5c</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>String.explode <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">''''</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">replace_backslash</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.replace(\"\\\\\", \"\\\\\\\\\")"</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">value2dot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">value2dot</span> <span class="main">(</span>value.Str <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> quote <span class="main">+</span> replace_backslash <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">+</span> quote"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">value2dot</span> <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> show_int <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">vname2dot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vname2dot</span> <span class="main">(</span>vname.I <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''i&lt;sub&gt;''</span><span class="main">+</span><span class="main">(</span>show_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''&lt;/sub&gt;''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">vname2dot</span> <span class="main">(</span>R <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''r&lt;sub&gt;''</span><span class="main">+</span><span class="main">(</span>show_nat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''&lt;/sub&gt;''</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">aexp2dot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname aexp <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2dot</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> value2dot <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2dot</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> vname2dot <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2dot</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">aexp2dot</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'' + ''</span><span class="main">+</span><span class="main">(</span><span class="free">aexp2dot</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2dot</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">aexp2dot</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'' - ''</span><span class="main">+</span><span class="main">(</span><span class="free">aexp2dot</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2dot</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">aexp2dot</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'' &amp;times; ''</span><span class="main">+</span><span class="main">(</span><span class="free">aexp2dot</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal list <span class="main">⇒</span> String.literal <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">join</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''''</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">join</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">join</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">+</span><span class="main">(</span><span class="free">join</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">show_nats</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">show_nats</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> join <span class="main">(</span>map show_nat <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gexp2dot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2dot</span> <span class="main">(</span>GExp.Bc True<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''True''</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2dot</span> <span class="main">(</span>GExp.Bc False<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''False''</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2dot</span> <span class="main">(</span>GExp.Eq <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>aexp2dot <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'' = ''</span><span class="main">+</span><span class="main">(</span>aexp2dot <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2dot</span> <span class="main">(</span>GExp.Gt <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>aexp2dot <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'' &amp;gt; ''</span><span class="main">+</span><span class="main">(</span>aexp2dot <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2dot</span> <span class="main">(</span>GExp.In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>vname2dot <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''&amp;isin;{''</span><span class="main">+</span><span class="main">(</span>join <span class="main">(</span>map value2dot <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''}''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2dot</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''!(''</span><span class="main">+</span><span class="main">(</span><span class="free">gexp2dot</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''&amp;or;''</span><span class="main">+</span><span class="main">(</span><span class="free">gexp2dot</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'')''</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">guards2dot_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp list <span class="main">⇒</span> String.literal list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">guards2dot_aux</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">guards2dot_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>gexp2dot <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">guards2dot_aux</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM_Dot-gexp2dot_aux_code"><span class="command">lemma</span></span> gexp2dot_aux_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"guards2dot_aux <span class="free">l</span> <span class="main">=</span> map gexp2dot <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">updates2dot_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"update_function list <span class="main">⇒</span> String.literal list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">updates2dot_aux</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">updates2dot_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>vname2dot <span class="main">(</span>R <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'' := ''</span><span class="main">+</span><span class="main">(</span>aexp2dot <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">updates2dot_aux</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="EFSM_Dot-updates2dot_aux_code"><span class="command">lemma</span></span> updates2dot_aux_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"updates2dot_aux <span class="free">l</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>vname2dot <span class="main">(</span>R <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'' := ''</span><span class="main">+</span><span class="main">(</span>aexp2dot <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">outputs2dot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"output_function list <span class="main">⇒</span> nat <span class="main">⇒</span> String.literal list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">outputs2dot</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">outputs2dot</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''o&lt;sub&gt;''</span><span class="main">+</span><span class="main">(</span>show_nat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''&lt;/sub&gt; := ''</span><span class="main">+</span><span class="main">(</span>aexp2dot <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">outputs2dot</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">updates2dot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"update_function list <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">updates2dot</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''''</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">updates2dot</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''&amp;#91;''</span><span class="main">+</span><span class="main">(</span>join <span class="main">(</span>updates2dot_aux <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''&amp;#93;''</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">guards2dot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp list <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">guards2dot</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''''</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">guards2dot</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''&amp;#91;''</span><span class="main">+</span><span class="main">(</span>join <span class="main">(</span>guards2dot_aux <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''&amp;#93;''</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">latter2dot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">latter2dot</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">(</span>join <span class="main">(</span>outputs2dot <span class="main">(</span>Outputs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span><span class="main">)</span><span class="main">+</span><span class="main">(</span>updates2dot <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''''</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''''</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">STR</span> <span class="inner_quoted">''/''</span><span class="main">+</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">transition2dot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">transition2dot</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>Label <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'':''</span><span class="main">+</span><span class="main">(</span>show_nat <span class="main">(</span>Arity <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">+</span><span class="main">(</span>guards2dot <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">+</span><span class="main">(</span>latter2dot <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">efsm2dot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">efsm2dot</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''digraph EFSM{''</span><span class="main">+</span>newline<span class="main">+</span>
                <span class="keyword1">STR</span> <span class="inner_quoted">''  graph [rankdir=''</span><span class="main">+</span>quote<span class="main">+</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''LR''</span><span class="main">)</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'', fontname=''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''Latin Modern Math''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''];''</span><span class="main">+</span>newline<span class="main">+</span>
                <span class="keyword1">STR</span> <span class="inner_quoted">''  node [color=''</span><span class="main">+</span>quote<span class="main">+</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''black''</span><span class="main">)</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'', fillcolor=''</span><span class="main">+</span>quote<span class="main">+</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''white''</span><span class="main">)</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'', shape=''</span><span class="main">+</span>quote<span class="main">+</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''circle''</span><span class="main">)</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'', style=''</span><span class="main">+</span>quote<span class="main">+</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''filled''</span><span class="main">)</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'', fontname=''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''Latin Modern Math''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''];''</span><span class="main">+</span>newline<span class="main">+</span>
                <span class="keyword1">STR</span> <span class="inner_quoted">''  edge [fontname=''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''Latin Modern Math''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''];''</span><span class="main">+</span>newline<span class="main">+</span>newline<span class="main">+</span>
                  <span class="keyword1">STR</span> <span class="inner_quoted">''  s0[fillcolor=''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''gray''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'', label=&lt;s&lt;sub&gt;0&lt;/sub&gt;&gt;];''</span><span class="main">+</span>newline<span class="main">+</span>
                  <span class="main">(</span>join <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">STR</span> <span class="inner_quoted">''  s''</span><span class="main">+</span>show_nat <span class="bound">s</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''[label=&lt;s&lt;sub&gt;''</span> <span class="main">+</span>show_nat <span class="bound">s</span><span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''&lt;/sub&gt;&gt;];''</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fset <span class="main">(</span>EFSM.S <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">-</span> <span class="main">{|</span><span class="main">0</span><span class="main">|}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newline<span class="main">)</span><span class="main">)</span><span class="main">+</span>newline<span class="main">+</span>newline<span class="main">+</span>
                  <span class="main">(</span>join <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">STR</span> <span class="inner_quoted">''  s''</span><span class="main">+</span><span class="main">(</span>show_nat <span class="bound">from</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''-&gt;s''</span><span class="main">+</span><span class="main">(</span>show_nat <span class="bound">to</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''[label=&lt;&lt;i&gt;''</span><span class="main">+</span><span class="main">(</span>transition2dot <span class="bound">t</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''&lt;/i&gt;&gt;];''</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fset <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> newline<span class="main">)</span><span class="main">+</span>newline<span class="main">+</span>
                <span class="keyword1">STR</span> <span class="inner_quoted">''}''</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iefsm2dot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">iefsm2dot</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''digraph EFSM{''</span><span class="main">+</span>newline<span class="main">+</span>
                 <span class="keyword1">STR</span> <span class="inner_quoted">''  graph [rankdir=''</span><span class="main">+</span>quote<span class="main">+</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''LR''</span><span class="main">)</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'', fontname=''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''Latin Modern Math''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''];''</span><span class="main">+</span>newline<span class="main">+</span>
                 <span class="keyword1">STR</span> <span class="inner_quoted">''  node [color=''</span><span class="main">+</span>quote<span class="main">+</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''black''</span><span class="main">)</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'', fillcolor=''</span><span class="main">+</span>quote<span class="main">+</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''white''</span><span class="main">)</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'', shape=''</span><span class="main">+</span>quote<span class="main">+</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''circle''</span><span class="main">)</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'', style=''</span><span class="main">+</span>quote<span class="main">+</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''filled''</span><span class="main">)</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'', fontname=''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''Latin Modern Math''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''];''</span><span class="main">+</span>newline<span class="main">+</span>
                 <span class="keyword1">STR</span> <span class="inner_quoted">''  edge [fontname=''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''Latin Modern Math''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''];''</span><span class="main">+</span>newline<span class="main">+</span>newline<span class="main">+</span>
                  <span class="keyword1">STR</span> <span class="inner_quoted">''  s0[fillcolor=''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''gray''</span><span class="main">+</span>quote<span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'', label=&lt;s&lt;sub&gt;0&lt;/sub&gt;&gt;];''</span><span class="main">+</span>newline<span class="main">+</span>
                  <span class="main">(</span>join <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">STR</span> <span class="inner_quoted">''  s''</span><span class="main">+</span>show_nat <span class="bound">s</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''[label=&lt;s&lt;sub&gt;''</span> <span class="main">+</span>show_nat <span class="bound">s</span><span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''&lt;/sub&gt;&gt;];''</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fset <span class="main">(</span>S <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">-</span> <span class="main">{|</span><span class="main">0</span><span class="main">|}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newline<span class="main">)</span><span class="main">)</span><span class="main">+</span>newline<span class="main">+</span>newline<span class="main">+</span>
                  <span class="main">(</span>join <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">uid</span><span class="main">,</span> <span class="main">(</span><span class="bound">from</span><span class="main">,</span> <span class="bound">to</span><span class="main">)</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">STR</span> <span class="inner_quoted">''  s''</span><span class="main">+</span><span class="main">(</span>show_nat <span class="bound">from</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''-&gt;s''</span><span class="main">+</span><span class="main">(</span>show_nat <span class="bound">to</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''[label=&lt;&lt;i&gt; [''</span><span class="main">+</span>show_nats <span class="main">(</span>sort <span class="bound">uid</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'']''</span><span class="main">+</span><span class="main">(</span>transition2dot <span class="bound">t</span><span class="main">)</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''&lt;/i&gt;&gt;];''</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fset <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> newline<span class="main">)</span><span class="main">+</span>newline<span class="main">+</span>
                <span class="keyword1">STR</span> <span class="inner_quoted">''}''</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">newline_str</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">newline_str</span> <span class="main">≡</span> <span class="inner_quoted">''\010''</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">quote_str</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">quote_str</span> <span class="main">≡</span> <span class="inner_quoted">''0x22''</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="efsm2sal">
<div class="head">
<h1>Theory efsm2sal</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Output to SAL›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹SAL is a framework for combining different tools for abstraction, program analysis, theorem
proving, and model checking. It is able to verify and refute properties of EFSMs phrased in LTL. In
\cite{foster2019}, it is proposed that a model checker be used to assist in checking the conditions
necessary for one transition to subsume another. In order to effect this, it is necessary to convert
the EFSM into a format that SAL can recognise. This theory file sets out the various definitions
needed to do this such that SAL can be used to check subsumption conditions when running the EFSM
inference tool generated by the code generator.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> efsm2sal
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#EFSM_Dot">EFSM_Dot</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">replace</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal <span class="main">⇒</span> String.literal <span class="main">⇒</span> String.literal <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replace</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">old</span></span></span> <span class="free"><span class="bound"><span class="entity">new</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">replace</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.replaceAll(_, _)"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">escape</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal <span class="main">⇒</span> <span class="main">(</span>String.literal <span class="main">×</span> String.literal<span class="main">)</span> list <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">escape</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">replacements</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">old</span><span class="main">,</span> <span class="bound">new</span><span class="main">)</span> <span class="bound">s'</span><span class="main">.</span> replace <span class="bound">s'</span> <span class="bound">old</span> <span class="bound">new</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">replacements</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">replacements</span> <span class="main">=</span> <span class="main">[</span>
  <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''/''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''_SOL__''</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="keyword1">STR</span> <span class="numeral">0x5C</span><span class="main">+</span><span class="keyword1">STR</span> <span class="numeral">0x5C</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''_BSOL__''</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'' ''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''_SPACE__''</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="keyword1">STR</span> <span class="numeral">0x5C</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''(''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''_LPAR__''</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="keyword1">STR</span> <span class="numeral">0x5C</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">'')''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''_RPAR__''</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="keyword1">STR</span> <span class="numeral">0x5C</span><span class="main">+</span><span class="keyword1">STR</span> <span class="inner_quoted">''.''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''_PERIOD__''</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''@''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''_COMMAT__''</span><span class="main">)</span>
<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">aexp2sal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname aexp <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Some(Num(''</span><span class="main">+</span> show_int <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''))''</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal</span> <span class="main">(</span>L <span class="main">(</span>value.Str <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Some(Str(String__''</span><span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''''</span> <span class="keyword1">then</span> <span class="keyword1">STR</span> <span class="inner_quoted">''_EMPTY__''</span> <span class="keyword1">else</span> escape <span class="free"><span class="bound"><span class="entity">n</span></span></span> replacements<span class="main">)</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''))''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal</span> <span class="main">(</span>V <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Some(i(''</span> <span class="main">+</span> show_nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''))''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal</span> <span class="main">(</span>V <span class="main">(</span>R <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''r__''</span> <span class="main">+</span> show_nat <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''value_plus(''</span><span class="main">+</span><span class="free">aexp2sal</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span> <span class="main">+</span> <span class="free">aexp2sal</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'')''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''value_minus(''</span><span class="main">+</span><span class="free">aexp2sal</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span> <span class="main">+</span> <span class="free">aexp2sal</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'')''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''value_times(''</span><span class="main">+</span><span class="free">aexp2sal</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span> <span class="main">+</span> <span class="free">aexp2sal</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'')''</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gexp2sal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2sal</span> <span class="main">(</span>Bc True<span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''True''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2sal</span> <span class="main">(</span>Bc False<span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''False''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2sal</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''value_eq(''</span> <span class="main">+</span> aexp2sal <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span> <span class="main">+</span> aexp2sal <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'')''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2sal</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''value_gt(''</span> <span class="main">+</span> aexp2sal <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span> <span class="main">+</span> aexp2sal <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'')''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2sal</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> join <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span>  <span class="keyword1">STR</span> <span class="inner_quoted">''gval(value_eq(''</span> <span class="main">+</span> aexp2sal <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span> <span class="main">+</span> aexp2sal <span class="main">(</span>L <span class="bound">l'</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''))''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' OR ''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2sal</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''NOT (gval(''</span> <span class="main">+</span> <span class="free">gexp2sal</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'') OR gval( ''</span> <span class="main">+</span> <span class="free">gexp2sal</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''))''</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">guards2sal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp list <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">guards2sal</span> <span class="main">[]</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''TRUE''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">guards2sal</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> join <span class="main">(</span>map gexp2sal <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' AND ''</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">aexp2sal_num</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname aexp <span class="main">⇒</span> nat <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal_num</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Some(Num(''</span><span class="main">+</span> show_int <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''))''</span>"</span></span><span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal_num</span> <span class="main">(</span>L <span class="main">(</span>value.Str <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Some(Str(String__''</span><span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''''</span> <span class="keyword1">then</span> <span class="keyword1">STR</span> <span class="inner_quoted">''_EMPTY__''</span> <span class="keyword1">else</span> escape <span class="free"><span class="bound"><span class="entity">n</span></span></span> replacements<span class="main">)</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''))''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal_num</span> <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''Some(i(''</span> <span class="main">+</span> show_nat <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''))''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal_num</span> <span class="main">(</span>V <span class="main">(</span>vname.R <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''r__''</span> <span class="main">+</span> show_nat <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''.''</span> <span class="main">+</span> show_nat <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal_num</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''value_plus(''</span><span class="main">+</span>aexp2sal <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span> <span class="main">+</span> aexp2sal <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'')''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal_num</span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''value_minus(''</span><span class="main">+</span>aexp2sal <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span> <span class="main">+</span> aexp2sal <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'')''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">aexp2sal_num</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''value_times(''</span><span class="main">+</span>aexp2sal <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span> <span class="main">+</span> aexp2sal <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'')''</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gexp2sal_num</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp <span class="main">⇒</span> nat <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2sal_num</span> <span class="main">(</span>Bc True<span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''True''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2sal_num</span> <span class="main">(</span>Bc False<span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''False''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2sal_num</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''gval(value_eq(''</span> <span class="main">+</span> aexp2sal_num <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span> <span class="main">+</span> aexp2sal_num <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''))''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2sal_num</span> <span class="main">(</span>Gt <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''gval(value_gt(''</span> <span class="main">+</span> aexp2sal_num <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span> <span class="main">+</span> aexp2sal_num <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''))''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2sal_num</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> join <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span>  <span class="keyword1">STR</span> <span class="inner_quoted">''gval(value_eq(''</span> <span class="main">+</span> aexp2sal_num <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span> <span class="main">+</span> aexp2sal_num <span class="main">(</span>L <span class="bound">l'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''))''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' OR ''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">gexp2sal_num</span> <span class="main">(</span>Nor <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''NOT (''</span> <span class="main">+</span> <span class="free">gexp2sal_num</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' OR ''</span> <span class="main">+</span> <span class="free">gexp2sal_num</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'')''</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">guards2sal_num</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp list <span class="main">⇒</span> nat <span class="main">⇒</span> String.literal"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">guards2sal_num</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''TRUE''</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">guards2sal_num</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> join <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> gexp2sal_num <span class="bound">g</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' AND ''</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Code_Target_List">
<div class="head">
<h1>Theory Code_Target_List</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span><span class="quoted"><span class="plain_text">‹Code Generation›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This chapter details the code generator setup to produce executable Scala code for our
inference technique.›</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Lists›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Here we define some equivalent definitions which make for a faster implementation. We also
make use of the \texttt{code\_printing} statement such that native Scala implementations of common
list operations are used instead of redefining them. This allows us to use the \texttt{par}
construct such that the parallel implementations are used, which makes for an even faster
implementation.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Code_Target_List
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> List.insert_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> member_rec <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"List.insert <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> List.member <span class="free">xs</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="keyword1">else</span> <span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_member<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> enumerate_eq_zip <span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> foldr_conv_foldl <span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> map_filter_map_filter <span class="main">[</span><span class="operator">code_unfold</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="comment1">(* Use the native implementations of list functions *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatmap</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> List.maps <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"List.maps <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> flatmap <span class="free">l</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flatmap_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_code</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> List.map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"List.map <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> map_code <span class="free">l</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_code_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"removeAll <span class="free">a</span> <span class="free">l</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">filter_code</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> List.filter <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"List.filter <span class="free">l</span> <span class="free">f</span> <span class="main">=</span> filter_code <span class="free">f</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_code_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">all</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> list_all <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> all <span class="free">l</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ex</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> list_ex <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_ex <span class="free">f</span> <span class="free">l</span> <span class="main">=</span> ex <span class="free">l</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ex_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> foldl_conv_fold<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1" id="Code_Target_List-fold_conv_foldl"><span class="command">lemma</span></span> fold_conv_foldl <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="free">f</span> <span class="free">xs</span> <span class="free">s</span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span> <span class="free">s</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_conv_fold<span class="main">)</span>

<span class="keyword1" id="Code_Target_List-code_list_eq"><span class="command">lemma</span></span> code_list_eq <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"HOL.equal <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HOL.equal_class.equal_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ball_set list_eq_iff_zip_eq<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">take_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">take_map</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Code_Target_List-nth_take_map"><span class="command">lemma</span></span> nth_take_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> take_map <span class="free">n</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">l</span> <span class="main">=</span> take_map <span class="free">n</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq min_def take_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">upt_tailrec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">upt_tailrec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">upt_tailrec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="free">upt_tailrec</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Code_Target_List-upt_arbitrary_l"><span class="command">lemma</span></span> upt_arbitrary_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>upt <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">@</span><span class="free">l</span> <span class="main">=</span> upt_tailrec <span class="free">i</span> <span class="free">j</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> upt_tailrec.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upt <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> upt_tailrec <span class="free">i</span> <span class="free">j</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> upt_arbitrary_l append_Nil2<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">max_sort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_sort</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">max_sort</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">u</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">;</span> <span class="bound">m</span> <span class="main">=</span> Max <span class="main">(</span>set <span class="bound">u</span><span class="main">)</span> <span class="keyword1">in</span> <span class="free">max_sort</span> <span class="main">(</span>removeAll <span class="bound">m</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span><span class="bound">m</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> splice.cases <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measures <span class="main">[</span><span class="main">λ</span><span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">l2</span><span class="main">)</span><span class="main">.</span> length <span class="bound">l1</span><span class="main">]</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_eq_iff List.finite_set case_prod_conv length_removeAll_less list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> measures_less set_empty<span class="main">)</span>

<span class="keyword1" id="Code_Target_List-remdups_fold"><span class="command">lemma</span></span> remdups_fold <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"remdups <span class="free">l</span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">l</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="bound">l</span> <span class="keyword1">then</span> <span class="bound">l</span> <span class="keyword1">else</span> <span class="bound">i</span><span class="main">#</span><span class="bound">l</span><span class="main">)</span> <span class="free">l</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> set_remdups<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> set_remdups <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">Cons</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_::_"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">rev</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.par.reverse.toList"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">List.member</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.contains((_))"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"List.remdups"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.par.distinct.toList"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"List.length"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Nat.Nata(_.par.length)"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"zip"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.par.zip((_)).toList"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"flatmap"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.par.flatMap((_)).toList"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"List.null"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.isEmpty"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"map_code"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.par.map((_)).toList"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"filter_code"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.par.filter((_)).toList"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"all"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.par.forall((_))"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"ex"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.par.exists((_))"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"nth"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_(Code'_Numeral.integer'_of'_nat((_)).toInt)"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"foldl"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.foldl"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"hd"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.head"</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Code_Target_Set">
<div class="head">
<h1>Theory Code_Target_Set</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Sets›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹While the default code generator setup for sets works fine, it does not make for particularly
readable code. The reason for this is that the default setup needs to work with potentially infinite
sets. All of the sets we need to use here are finite so we present an alternative setup for the
basic set operations which generates much cleaner code.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Code_Target_Set
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Cardinality.html">HOL-Library.Cardinality</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">code_datatype</span></span> <span class="quoted">set</span>
<span class="keyword1"><span class="command">declare</span></span> List.union_coset_filter <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> insert_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> remove_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> card_coset_error <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> coset_subseteq_set_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> eq_set_code<span class="main">(</span>1<span class="main">)</span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> eq_set_code<span class="main">(</span>2<span class="main">)</span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> eq_set_code<span class="main">(</span>4<span class="main">)</span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> List.subset_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> inter_coset_fold <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> Cardinality.subset'_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> subset_eq <span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="comment1">(* Get rid of that one unnamed lemma *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> List.coset <span class="free">xs</span> <span class="main">⟷</span> <span class="main">¬</span> List.member <span class="free">xs</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_def<span class="main">)</span>

<span class="keyword1" id="Code_Target_Set-sup_set_append"><span class="command">lemma</span></span> sup_set_append<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="free">x</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>set <span class="free">y</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> product_concat_map <span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span>set <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">s</span> <span class="keyword1">then</span> set <span class="free">s</span> <span class="keyword1">else</span> set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Cardinality.subset' <span class="main">(</span>set <span class="free">l1</span><span class="main">)</span> <span class="main">(</span>set <span class="free">l2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> List.member <span class="free">l2</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">l1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_set_member list.pred_set subset'_code<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Code_Target_FSet">
<div class="head">
<h1>Theory Code_Target_FSet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Finite Sets›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Here we define the operations on the \texttt{fset} datatype in terms of lists rather than sets.
This allows the Scala implementation to skip a case match each time, which makes for cleaner and
slightly faster code.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Code_Target_FSet
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../extended_finite_state_machines/theories/#FSet_Utils">Extended_Finite_State_Machines.FSet_Utils</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">code_datatype</span></span> <span class="quoted">fset_of_list</span>

<span class="keyword1"><span class="command">declare</span></span> FSet.fset_of_list.rep_eq <span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1" id="Code_Target_FSet-fprod_code"><span class="command">lemma</span></span> fprod_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fprod <span class="main">(</span>fset_of_list <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>fset_of_list <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> fset_of_list <span class="main">(</span>remdups <span class="main">[</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> x <span class="main">←</span> <span class="free">xs</span><span class="main">,</span> y <span class="main">←</span> <span class="free">ys</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fprod_def fset_of_list_def fset_both_sides Abs_fset_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Code_Target_FSet-fminus_fset_filter"><span class="command">lemma</span></span> fminus_fset_filter <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fset_of_list <span class="free">A</span> <span class="main">-</span>  <span class="free">xs</span> <span class="main">=</span> fset_of_list <span class="main">(</span>remdups <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∉|</span> <span class="free">xs</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Code_Target_FSet-sup_fset_fold"><span class="command">lemma</span></span> sup_fset_fold <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fset_of_list <span class="free">f1</span><span class="main">)</span> <span class="main">|∪|</span> <span class="main">(</span>fset_of_list <span class="free">f2</span><span class="main">)</span> <span class="main">=</span> fset_of_list <span class="main">(</span>remdups <span class="main">(</span><span class="free">f1</span><span class="main">@</span><span class="free">f2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Code_Target_FSet-bot_fset"><span class="command">lemma</span></span> bot_fset <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{||}</span> <span class="main">=</span> fset_of_list <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Code_Target_FSet-finsert"><span class="command">lemma</span></span> finsert <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finsert <span class="free">a</span> <span class="main">(</span>fset_of_list <span class="free">as</span><span class="main">)</span> <span class="main">=</span> fset_of_list <span class="main">(</span>List.insert <span class="free">a</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> List.insert_def finsert_absorb fset_of_list_elem<span class="main">)</span>

<span class="keyword1" id="Code_Target_FSet-ffilter_filter"><span class="command">lemma</span></span> ffilter_filter <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffilter <span class="free">f</span> <span class="main">(</span>fset_of_list <span class="free">as</span><span class="main">)</span> <span class="main">=</span> fset_of_list <span class="main">(</span>List.filter <span class="free">f</span> <span class="main">(</span>remdups <span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Code_Target_FSet-fimage_map"><span class="command">lemma</span></span> fimage_map <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fimage <span class="free">f</span> <span class="main">(</span>fset_of_list <span class="free">as</span><span class="main">)</span> <span class="main">=</span> fset_of_list <span class="main">(</span>List.map <span class="free">f</span> <span class="main">(</span>remdups <span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Code_Target_FSet-ffUnion_fold"><span class="command">lemma</span></span> ffUnion_fold <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffUnion <span class="main">(</span>fset_of_list <span class="free">as</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(|∪|)</span> <span class="free">as</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_union_ffUnion<span class="main">)</span>

<span class="keyword1" id="Code_Target_FSet-fmember"><span class="command">lemma</span></span> fmember <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">|∈|</span> <span class="main">(</span>fset_of_list <span class="free">as</span><span class="main">)</span> <span class="main">=</span> List.member <span class="free">as</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_of_list_elem member_def<span class="main">)</span>

<span class="keyword1" id="Code_Target_FSet-fthe_elem"><span class="command">lemma</span></span> fthe_elem <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fthe_elem <span class="main">(</span>fset_of_list <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Code_Target_FSet-size"><span class="command">lemma</span></span> size <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>fset_of_list <span class="free">as</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>remdups <span class="free">as</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_of_list.rep_eq insert_absorb<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Code_Target_FSet-fMax_fold"><span class="command">lemma</span></span> fMax_fold <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fMax <span class="main">(</span>fset_of_list <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fold max <span class="free">as</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max.set_eq_fold fMax.F.rep_eq fset_of_list.rep_eq<span class="main">)</span>

<span class="keyword1" id="Code_Target_FSet-fMin_fold"><span class="command">lemma</span></span> fMin_fold <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fMin <span class="main">(</span>fset_of_list <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fold min <span class="free">t</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_of_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Min.set_eq_fold fMin_Min fset_of_list.abs_eq list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Code_Target_FSet-fremove_code"><span class="command">lemma</span></span> fremove_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fremove <span class="free">a</span> <span class="main">(</span>fset_of_list <span class="free">A</span><span class="main">)</span> <span class="main">=</span> fset_of_list <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">a</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fremove_def minus_fset_def ffilter_def fset_both_sides Abs_fset_inverse fset_of_list.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Code_Target_FSet-fsubseteq"><span class="command">lemma</span></span> fsubseteq <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fset_of_list <span class="free">l</span><span class="main">)</span> <span class="main">|⊆|</span> <span class="free">A</span> <span class="main">=</span> List.list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="free">A</span><span class="main">)</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Code_Target_FSet-fsum_fold"><span class="command">lemma</span></span> fsum_fold <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fSum <span class="main">(</span>fset_of_list <span class="free">l</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(+)</span> <span class="main">(</span>remdups <span class="free">l</span><span class="main">)</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Nil
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fsum.F.rep_eq fSum_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finsert_absorb fset_of_list_elem<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute fold_plus_sum_list_rev fset_of_list.rep_eq fsum.F.rep_eq fSum_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Code_Target_FSet-code_fset_eq"><span class="command">lemma</span></span> code_fset_eq <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"HOL.equal <span class="free">X</span> <span class="main">(</span>fset_of_list <span class="free">Y</span><span class="main">)</span> <span class="main">⟷</span> size <span class="free">X</span> <span class="main">=</span> length <span class="main">(</span>remdups <span class="free">Y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">|∈|</span> <span class="free">X</span><span class="main">.</span> List.member <span class="free">Y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> HOL.equal_class.equal_eq fset_eq_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> size<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> fmember <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Code_Target_FSet-code_fsubset"><span class="command">lemma</span></span> code_fsubset <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">|⊂|</span> <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">|⊆|</span> <span class="free">s'</span> <span class="main">∧</span> size <span class="free">s</span> <span class="main">&lt;</span> size <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> size_fsubset<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Code_Target_FSet-code_fset"><span class="command">lemma</span></span> code_fset <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fset <span class="main">(</span>fset_of_list <span class="free">l</span><span class="main">)</span> <span class="main">=</span> fold insert <span class="free">l</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fset_of_list.rep_eq union_set_fold <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Code_Target_FSet-code_fBall"><span class="command">lemma</span></span> code_fBall <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fBall <span class="main">(</span>fset_of_list <span class="free">l</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> list_all <span class="free">f</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ball_set fBall.rep_eq fset_of_list.rep_eq<span class="main">)</span>

<span class="keyword1" id="Code_Target_FSet-code_fBex"><span class="command">lemma</span></span> code_fBex <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fBex <span class="main">(</span>fset_of_list <span class="free">l</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> list_ex <span class="free">f</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Bex_set fBexE fset_of_list_elem rev_fBexI<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nativeSort</span> <span class="main">=</span> sort"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">nativeSort</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.sortWith((Orderings.less))"</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_list_of_fset <span class="main">(</span>fset_of_list <span class="free">l</span><span class="main">)</span> <span class="main">=</span> nativeSort <span class="main">(</span>remdups <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nativeSort_def sorted_list_of_fset_sort<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">(</span>set <span class="free">l</span><span class="main">)</span> <span class="main">=</span> nativeSort <span class="main">(</span>remdups <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nativeSort_def sorted_list_of_set_sort_remdups<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fMin <span class="main">(</span>fset_of_list <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>nativeSort <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fMin_Min hd_sort_Min list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nativeSort_def<span class="main">)</span>

<span class="keyword1" id="Code_Target_FSet-sorted_Max_Cons"><span class="command">lemma</span></span> sorted_Max_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
   sorted <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">l</span><span class="main">)</span> <span class="main">⟹</span>
   Max <span class="main">(</span>set <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Code_Target_FSet-sorted_Max"><span class="command">lemma</span></span> sorted_Max<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
   sorted <span class="free">l</span> <span class="main">⟹</span>
   Max <span class="main">(</span>set <span class="free">l</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>rev <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sorted_Max_Cons Max_singleton hd_rev last.simps list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> sorted.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fMax <span class="main">(</span>fset_of_list <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span>nativeSort <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max.set_eq_fold fMax_fold hd_rev list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nativeSort_def set_empty2 set_sort sorted_Max sorted_sort<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">list_max</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> fold max <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">list_max</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.par.fold((_))(Orderings.max)"</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fMax <span class="main">(</span>fset_of_list <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> list_max <span class="free">t</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fMax_fold list_max_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">list_min</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> fold min <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="keyword1"><span class="command">code_printing</span></span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">list_min</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.par.fold((_))(Orderings.min)"</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fMin <span class="main">(</span>fset_of_list <span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> list_min <span class="free">t</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fMin_fold list_min_def<span class="main">)</span>

<span class="keyword1" id="Code_Target_FSet-fis_singleton_code"><span class="command">lemma</span></span> fis_singleton_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fis_singleton <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>size <span class="free">s</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fis_singleton_def is_singleton_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Suc_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Code_Generation">
<div class="head">
<h1>Theory Code_Generation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Code Generation›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory is used to generate an executable Scala implementation of the inference tool which
can be used to infer real EFSMs from real traces. Certain functions are replaced with native
implementations. These can be found at \url{https://github.com/jmafoster1/efsm-inference/blob/master/inference-tool/src/main/scala/inference/Dirties.scala}.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Code_Generation
  <span class="keyword2"><span class="keyword">imports</span></span>
   <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Code_Target_Numeral.html">HOL-Library.Code_Target_Numeral</a>"</span>
   <a href="#Inference">Inference</a>
   <a href="#SelectionStrategies">SelectionStrategies</a>
   <span class="quoted">"<a href="#Store_Reuse_Subsumption">heuristics/Store_Reuse_Subsumption</a>"</span>
   <span class="quoted">"<a href="#Increment_Reset">heuristics/Increment_Reset</a>"</span>
   <span class="quoted">"<a href="#Same_Register">heuristics/Same_Register</a>"</span>
   <span class="quoted">"<a href="#Distinguishing_Guards">heuristics/Distinguishing_Guards</a>"</span>
   <span class="quoted">"<a href="#PTA_Generalisation">heuristics/PTA_Generalisation</a>"</span>
   <span class="quoted">"<a href="#Weak_Subsumption">heuristics/Weak_Subsumption</a>"</span>
   <span class="quoted">"<a href="#Least_Upper_Bound">heuristics/Least_Upper_Bound</a>"</span>
   <a href="#EFSM_Dot">EFSM_Dot</a>
   <span class="quoted">"<a href="#Code_Target_FSet">code-targets/Code_Target_FSet</a>"</span>
   <span class="quoted">"<a href="#Code_Target_Set">code-targets/Code_Target_Set</a>"</span>
   <span class="quoted">"<a href="#Code_Target_List">code-targets/Code_Target_List</a>"</span>
<a href="#efsm2sal">efsm2sal</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> One_nat_def <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="comment1">(*
  Let's use the native operators for booleans and pairs
*)</span>
<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">HOL.conj</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_ &amp;&amp; _"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">HOL.disj</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_ || _"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"HOL.equal <span class="main">::</span> bool <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="keyword2"><span class="keyword">infix</span></span> 4 <span class="quoted">"=="</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"fst"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.'_1"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"snd"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.'_2"</span><span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Nat.Nata((1))"</span>

<span class="comment1">(*
  This gives us a speedup as we don't need to check that a register is undefined in the initial
  state if there is no way to get back there. This is true by definition.
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">initially_undefined_context_check_full</span> <span class="main">=</span> initially_undefined_context_check"</span></span>

<span class="comment1">(* This gives us a speedup because we can check this before we have to call out to z3 *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mutex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp <span class="main">⇒</span> <span class="tfree">'a</span> gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mutex</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="keyword1">else</span> False<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mutex</span> <span class="main">(</span>gexp.In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mutex</span> <span class="main">(</span>Eq <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gexp.In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mutex</span> <span class="main">(</span>gexp.In <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>gexp.In <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">∧</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∩</span> set <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mutex</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Code_Generation-mutex_not_gval"><span class="command">lemma</span></span> mutex_not_gval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mutex <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> gval <span class="main">(</span>gAnd <span class="free">y</span> <span class="free">x</span><span class="main">)</span> <span class="free">s</span> <span class="main">≠</span> true"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gAnd_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mutex.induct<span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="improper">v</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="improper">v'</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="improper">v</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="improper">v'</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> maybe_negate_true maybe_or_false trilean.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> value_eq.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="improper">v</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">v'</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="improper">v'</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="improper">v</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">v'</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* (∃(i, s1) ∈ set (get_ins (Guard t1)).
   ∃(i', s2) ∈ set (get_ins (Guard t2)).
   i = i' ∧
   ¬ (set s2) ⊆ (set s1) ∧
   restricted_once (I i) (Guard t2)) *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">choice_cases</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">choice_cases</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">if</span> <span class="main">∃</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>List.product <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> mutex <span class="bound">x</span> <span class="bound">y</span> <span class="keyword1">then</span>
       False
     <span class="keyword1">else</span> <span class="keyword1">if</span> Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">then</span>
       satisfiable <span class="main">(</span>fold gAnd <span class="main">(</span>rev <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gexp.Bc True<span class="main">)</span><span class="main">)</span>
     <span class="keyword1">else</span>
       satisfiable <span class="main">(</span><span class="main">(</span>fold gAnd <span class="main">(</span>rev <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">@</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gexp.Bc True<span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">)</span>"</span></span>

<span class="keyword1" id="Code_Generation-existing_mutex_not_true"><span class="command">lemma</span></span> existing_mutex_not_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">G</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>set <span class="free">G</span><span class="main">.</span> mutex <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">¬</span> apply_guards <span class="free">G</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_guards_rearrange<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="improper">x</span><span class="main">#</span><span class="free">G</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> apply_guards_rearrange<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> apply_guards_double_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> mutex_not_gval
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"choice <span class="free">t</span> <span class="free">t'</span> <span class="main">=</span> choice_cases <span class="free">t</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> choice_alt choice_cases_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> mutex <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>List.product <span class="main">(</span>Guards <span class="free">t</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> choice_alt_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> existing_mutex_not_true Un_iff set_append<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"Guards <span class="free">t</span> <span class="main">=</span> Guards <span class="free">t'</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> choice_alt_def apply_guards_append<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_apply_guards rev_apply_guards satisfiable_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> choice_alt_def satisfiable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> foldr_append foldr_apply_guards foldr_conv_fold<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">guardMatch_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname gexp list <span class="main">⇒</span> vname gexp list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">guardMatch_code</span> <span class="main">[</span><span class="main">(</span>gexp.Eq <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span>gexp.Eq <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">guardMatch_code</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"guardMatch <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span> guardMatch_code <span class="main">(</span>Guards <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>Guards <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> guardMatch_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> guardMatch_code.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">outputMatch_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"output_function list <span class="main">⇒</span> output_function list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">outputMatch_code</span> <span class="main">[</span>L <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">[</span>L <span class="main">(</span>Num <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">outputMatch_code</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"outputMatch <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span> outputMatch_code <span class="main">(</span>Outputs <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>Outputs <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> outputMatch_code.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> outputMatch_code.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> outputMatch_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">always_different_outputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname aexp list <span class="main">⇒</span> vname aexp list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">always_different_outputs</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">always_different_outputs</span> <span class="main">[]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">always_different_outputs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">always_different_outputs</span> <span class="main">(</span><span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>L <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="keyword1">then</span> <span class="free">always_different_outputs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">else</span> True<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">always_different_outputs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">always_different_outputs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>

<span class="keyword1" id="Code_Generation-always_different_outputs_outputs_never_equal"><span class="command">lemma</span></span> always_different_outputs_outputs_never_equal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"always_different_outputs <span class="free">O1</span> <span class="free">O2</span> <span class="main">⟹</span>
   apply_outputs <span class="free">O1</span> <span class="free">s</span> <span class="main">≠</span> apply_outputs <span class="free">O2</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">O1</span></span> <span class="quoted"><span class="free">O2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> always_different_outputs.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_outputs_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tests_input_equality</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> vname gexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tests_input_equality</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>gexp.Eq <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">tests_input_equality</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">no_illegal_updates_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"update_function list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">no_illegal_updates_code</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">no_illegal_updates_code</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">∧</span> <span class="free">no_illegal_updates_code</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Code_Generation-no_illegal_updates_code_aux"><span class="command">lemma</span></span> no_illegal_updates_code_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span>set <span class="free">u</span><span class="main">.</span> fst <span class="bound">u</span> <span class="main">≠</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> no_illegal_updates_code <span class="free">u</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">aa</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Code_Generation-no_illegal_updates_code"><span class="command">lemma</span></span> no_illegal_updates_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"no_illegal_updates <span class="free">t</span> <span class="free">r</span> <span class="main">=</span> no_illegal_updates_code <span class="main">(</span>Updates <span class="free">t</span><span class="main">)</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_illegal_updates_def no_illegal_updates_code_aux<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">input_updates_register_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"update_function list <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">input_updates_register_aux</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> V <span class="main">(</span>vname.I <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">n'</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">input_updates_register_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">input_updates_register_aux</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">input_updates_register_aux</span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">input_updates_register</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition_matrix <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> String.literal<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">input_updates_register</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">case</span> fthe_elem <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> input_updates_register_aux <span class="main">(</span>Updates <span class="bound">t</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span>
        input_updates_register_aux <span class="main">(</span>Updates <span class="bound">t</span><span class="main">)</span> <span class="keyword1">of</span>
          Some <span class="bound">n</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> Label <span class="bound">t</span><span class="main">)</span>
      <span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dirty_directly_subsumes</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">then</span> True <span class="keyword1">else</span> directly_subsumes <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">always_different_outputs_direct_subsumption</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">c1</span> <span class="bound">c</span><span class="main">.</span> obtains <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">c1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">p</span> <span class="main">∧</span> obtains <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">c</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">0</span> <span class="main">&lt;&gt;</span> <span class="bound">p</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> can_take_transition <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="bound">i</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Code_Generation-always_different_outputs_direct_subsumption"><span class="command">lemma</span></span> always_different_outputs_direct_subsumption<span class="main">:</span>
  <span class="quoted"><span class="quoted">"always_different_outputs <span class="main">(</span>Outputs <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>Outputs <span class="free">t2</span><span class="main">)</span> <span class="main">⟹</span>
   always_different_outputs_direct_subsumption <span class="free">m1</span> <span class="free">m2</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">t2</span> <span class="main">⟹</span>
   <span class="main">¬</span> directly_subsumes <span class="free">m1</span> <span class="free">m2</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directly_subsumes_def always_different_outputs_direct_subsumption_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">c1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> always_different_outputs_outputs_never_equal bad_outputs<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">negate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> gexp list <span class="main">⇒</span> <span class="tfree">'a</span> gexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">negate</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> gNot <span class="main">(</span>fold gAnd <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Code_Generation-gval_negate_cons"><span class="command">lemma</span></span> gval_negate_cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gval <span class="main">(</span>negate <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> gval <span class="main">(</span>gNot <span class="free">a</span><span class="main">)</span> <span class="free">s</span> <span class="main">∨?</span> gval <span class="main">(</span>negate <span class="free">G</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> negate_def gval_gNot gval_fold_equiv_gval_foldr<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> foldr.simps comp_def gval_gAnd de_morgans_2<span class="main">)</span>

<span class="keyword1" id="Code_Generation-negate_true_guard"><span class="command">lemma</span></span> negate_true_guard<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gval <span class="main">(</span>negate <span class="free">G</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> true<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>gval <span class="main">(</span>fold gAnd <span class="free">G</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> false<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> gval_gNot maybe_double_negation maybe_not.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> negate_def<span class="main">)</span>

<span class="keyword1" id="Code_Generation-gval_negate_not_invalid"><span class="command">lemma</span></span> gval_negate_not_invalid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gval <span class="main">(</span>negate <span class="free">gs</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">ra</span><span class="main">)</span> <span class="main">≠</span> invalid<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>gval <span class="main">(</span>fold gAnd <span class="free">gs</span> <span class="main">(</span>Bc True<span class="main">)</span><span class="main">)</span> <span class="main">(</span>join_ir <span class="free">i</span> <span class="free">ra</span><span class="main">)</span> <span class="main">≠</span> invalid<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gval_gNot maybe_not_invalid negate_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dirty_always_different_outputs_direct_subsumption</span> <span class="main">=</span> always_different_outputs_direct_subsumption"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"always_different_outputs_direct_subsumption <span class="free">m1</span> <span class="free">m2</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> Guards <span class="free">t</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span>
    recognises_and_visits_both <span class="free">m1</span> <span class="free">m2</span> <span class="free">s</span> <span class="free">s'</span>
  <span class="keyword1">else</span>
    dirty_always_different_outputs_direct_subsumption <span class="free">m1</span> <span class="free">m2</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> always_different_outputs_direct_subsumption_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> recognises_and_visits_both_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> can_take_transition_empty_guard <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> always_different_outputs_direct_subsumption_def dirty_always_different_outputs_direct_subsumption_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> always_different_outputs_direct_subsumption_def dirty_always_different_outputs_direct_subsumption_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">guard_subset_subsumption</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">guard_subset_subsumption</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span> Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">∧</span> Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span> Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Code_Generation-guard_subset_subsumption"><span class="command">lemma</span></span> guard_subset_subsumption<span class="main">:</span>
  <span class="quoted"><span class="quoted">"guard_subset_subsumption <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟹</span> directly_subsumes <span class="free">a</span> <span class="free">b</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsumes_in_all_contexts_directly_subsumes<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsumes_def guard_subset_subsumption_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> can_take_def can_take_transition_def can_take_subset<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">guard_subset_eq_outputs_updates</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
   Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
   Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
   Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
   set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">guard_superset_eq_outputs_updates</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>Label <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Label <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
   Arity <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Arity <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
   Outputs <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Outputs <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
   Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span>
   set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">⊃</span> set <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_generalisation_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_generalisation_of</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span> remove_guard_add_update <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> Arity <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span>tests_input_equality <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>Guards <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="Code_Generation-tests_input_equality"><span class="command">lemma</span></span> tests_input_equality<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> gexp.Eq <span class="main">(</span>V <span class="main">(</span>vname.I <span class="free">xb</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="main">(</span>tests_input_equality <span class="free">xb</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">G</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">G</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x21</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x2</span> <span class="main">=</span> vname.I <span class="free">xb</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x22</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x22</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> tests_input_equality.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Store_Reuse.is_generalisation_of <span class="free">x</span> <span class="free">xa</span> <span class="free">xb</span> <span class="free">xc</span> <span class="main">=</span> is_generalisation_of <span class="free">x</span> <span class="free">xa</span> <span class="free">xb</span> <span class="free">xc</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Store_Reuse.is_generalisation_of_def is_generalisation_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> tests_input_equality <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iEFSM2dot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nat <span class="main">⇒</span> unit"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">iEFSM2dot</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">logStates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"iEFSM <span class="main">⇒</span> nat <span class="main">⇒</span> unit"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">logStates</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">()</span>"</span></span>

<span class="comment1">(* This is the infer function but with logging *)</span>
<span class="comment1">(*
function infer_with_log :: "nat ⇒ nat ⇒ iEFSM ⇒ strategy ⇒ update_modifier ⇒ (transition_matrix ⇒ bool) ⇒ (iEFSM ⇒ nondeterministic_pair fset) ⇒ iEFSM" where
  "infer_with_log stepNo k e r m check np = (
    let scores = if k = 1 then score_1 e r else (k_score k e r) in
    case inference_step e scores m check np of
      None ⇒ e |
      Some new ⇒ let
        temp = iEFSM2dot new stepNo;
        temp2 = logStates (size (S new)) (size (S e)) in
        if (S new) |⊂| (S e) then
          infer_with_log (stepNo + 1) k new r m check np
        else e
  )"
*)</span>

<span class="comment1">(*
function infer_with_log :: "(cfstate × cfstate) set ⇒ nat ⇒ iEFSM ⇒ strategy ⇒ update_modifier ⇒ (transition_matrix ⇒ bool) ⇒ (iEFSM ⇒ nondeterministic_pair fset) ⇒ iEFSM" where *)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">infer_with_log</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cfstate <span class="main">×</span> cfstate<span class="main">)</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> iEFSM <span class="main">⇒</span> strategy <span class="main">⇒</span> update_modifier <span class="main">⇒</span> <span class="main">(</span>transition_matrix <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>iEFSM <span class="main">⇒</span> nondeterministic_pair fset<span class="main">)</span> <span class="main">⇒</span> iEFSM"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">infer_with_log</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">scores</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> score_1 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>k_score <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">case</span> inference_step <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>S1 <span class="bound">s</span><span class="main">,</span> S2 <span class="bound">s</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span> <span class="main">∧</span> <span class="main">(</span>S2 <span class="bound">s</span><span class="main">,</span> S1 <span class="bound">s</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">failedMerges</span></span></span><span class="main">)</span> <span class="bound">scores</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="keyword1">of</span>
      <span class="main">(</span>None<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">|</span>
      <span class="main">(</span>Some <span class="bound">new</span><span class="main">,</span> <span class="bound">failedMerges</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="main">(</span>Inference.S <span class="bound">new</span><span class="main">)</span> <span class="main">|⊂|</span> <span class="main">(</span>Inference.S <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
      <span class="keyword1">let</span> <span class="bound">temp2</span> <span class="main">=</span> logStates <span class="bound">new</span> <span class="main">(</span>size <span class="main">(</span>Inference.S <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="free">infer_with_log</span> <span class="bound">failedMerges</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">new</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">check</span></span></span> <span class="free"><span class="bound"><span class="entity">np</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measures <span class="main">[</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">e</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> size <span class="main">(</span>Inference.S <span class="bound">e</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_conv measures_less size_fsubset<span class="main">)</span>

<span class="keyword1" id="Code_Generation-infer_empty"><span class="command">lemma</span></span> infer_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"infer <span class="free">f</span> <span class="free">k</span> <span class="main">{||}</span> <span class="free">r</span> <span class="free">m</span> <span class="free">check</span> <span class="free">np</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> score_1_def S_def fprod_empty k_score_def<span class="main">)</span>

<span class="comment1">(*
lemma [code]: "infer f k e r m check np = infer_with_log f k e r m check np"
  sorry
*)</span>

<span class="comment1">(* declare make_pta_fold [code] *)</span>
<span class="keyword1"><span class="command">declare</span></span> GExp.satisfiable_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> initially_undefined_context_check_full_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> generalise_output_context_check_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> dirty_always_different_outputs_direct_subsumption_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> diff_outputs_ctx_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> random_member_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> dirty_directly_subsumes_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> recognises_and_visits_both_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> initially_undefined_context_check_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> can_still_take_ctx_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">infer</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Code'_Generation.infer'_with'_log"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">recognises_and_visits_both</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.recognisesAndGetsUsToBoth"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">iEFSM2dot</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"PrettyPrinter.iEFSM2dot(_, _)"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">logStates</span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Log.logStates(_, _)"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"dirty_directly_subsumes"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.scalaDirectlySubsumes"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"GExp.satisfiable"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.satisfiable"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"initially_undefined_context_check_full"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.initiallyUndefinedContextCheck"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"generalise_output_context_check"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.generaliseOutputContextCheck"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"dirty_always_different_outputs_direct_subsumption"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.alwaysDifferentOutputsDirectSubsumption"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"diff_outputs_ctx"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.diffOutputsCtx"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"can_still_take"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.canStillTake"</span> <span class="main">|</span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"random_member"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Dirties.randomMember"</span>

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"show_nat"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Code'_Numeral.integer'_of'_nat((_)).toString()"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"show_int"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Code'_Numeral.integer'_of'_int((_)).toString()"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"join"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.mkString((_))"</span>

<span class="comment1">(*
  Mapping finfuns to Scala native Maps
*)</span>
<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">type_constructor</span></span> finfun <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"Map[_, _]"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"finfun_const"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"scala.collection.immutable.Map().withDefaultValue((_))"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"finfun_update"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_ + (_ -&gt; _)"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"finfun_apply"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_((_))"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"finfun_to_list"</span></span> <span class="main">⇀</span> <span class="main">(</span>Scala<span class="main">)</span> <span class="quoted">"_.keySet.toList"</span>
<span class="keyword1"><span class="command">declare</span></span> finfun_to_list_const_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> finfun_to_list_update_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mismatched_updates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"transition <span class="main">⇒</span> transition <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mismatched_updates</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∉</span> set <span class="main">(</span>map fst <span class="main">(</span>Updates <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t1</span> <span class="free">t2</span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">t1</span> <span class="main">=</span> <span class="free">t2</span> <span class="keyword1">then</span> True <span class="keyword1">else</span> dirty_directly_subsumes <span class="free">e1</span> <span class="free">e2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> directly_subsumes_reflexive dirty_directly_subsumes_def<span class="main">)</span>

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="comment1">(* Essentials *)</span>
  <span class="quoted"><span class="quoted">try_heuristics_check</span></span>
  <span class="quoted"><span class="quoted">learn</span></span>
  <span class="quoted"><span class="quoted">infer_with_log</span></span>
  <span class="quoted"><span class="quoted">nondeterministic</span></span>
  <span class="quoted"><span class="quoted">make_pta</span></span>
  <span class="quoted"><span class="quoted">AExp.enumerate_vars</span></span>
  <span class="comment1">(* Logical connectives *)</span>
  <span class="quoted"><span class="quoted">gAnd</span></span>
  <span class="quoted"><span class="quoted">gOr</span></span>
  <span class="quoted"><span class="quoted">gNot</span></span>
  <span class="quoted"><span class="quoted">Lt</span></span>
  <span class="quoted"><span class="quoted">Le</span></span>
  <span class="quoted"><span class="quoted">Ge</span></span>
  <span class="quoted"><span class="quoted">Ne</span></span>
  <span class="comment1">(* Scoring functions *)</span>
  <span class="quoted"><span class="quoted">naive_score</span></span>
  <span class="quoted"><span class="quoted">naive_score_eq_bonus</span></span>
  <span class="quoted"><span class="quoted">exactly_equal</span></span>
  <span class="quoted"><span class="quoted">naive_score_outputs</span></span>
  <span class="quoted"><span class="quoted">naive_score_comprehensive</span></span>
  <span class="quoted"><span class="quoted">naive_score_comprehensive_eq_high</span></span>
  <span class="quoted"><span class="quoted">leaves</span></span>
  <span class="comment1">(* Heuristics *)</span>
  <span class="quoted"><span class="quoted">same_register</span></span>
  <span class="quoted"><span class="quoted">insert_increment_2</span></span>
  <span class="quoted"><span class="quoted">heuristic_1</span></span>
  <span class="quoted"><span class="quoted">heuristic_2</span></span>
  <span class="quoted"><span class="quoted">distinguish</span></span>
  <span class="quoted"><span class="quoted">weak_subsumption</span></span>
  <span class="quoted"><span class="quoted">lob</span></span>
  <span class="comment1">(* Nondeterminism metrics *)</span>
  <span class="quoted"><span class="quoted">nondeterministic_pairs</span></span>
  <span class="quoted"><span class="quoted">nondeterministic_pairs_labar</span></span>
  <span class="quoted"><span class="quoted">nondeterministic_pairs_labar_dest</span></span>
  <span class="comment1">(* Utilities *)</span>
  <span class="quoted"><span class="quoted">min</span></span>
  <span class="quoted"><span class="quoted">max</span></span>
  <span class="quoted"><span class="quoted">drop_pta_guards</span></span>
  <span class="quoted"><span class="quoted">test_log</span></span>
  <span class="quoted"><span class="quoted">iefsm2dot</span></span>
  <span class="quoted"><span class="quoted">efsm2dot</span></span>
  <span class="quoted"><span class="quoted">guards2sal</span></span>
  <span class="quoted"><span class="quoted">guards2sal_num</span></span>
  <span class="quoted"><span class="quoted">fold_In</span></span>
  <span class="quoted"><span class="quoted">max_int</span></span>
  <span class="quoted"><span class="quoted">enumerate_vars</span></span>
  <span class="quoted"><span class="quoted">derestrict</span></span>
<span class="keyword2"><span class="keyword">in</span></span> Scala
<span class="comment1">(* file "../../inference-tool/src/main/scala/inference/Inference.scala" *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>