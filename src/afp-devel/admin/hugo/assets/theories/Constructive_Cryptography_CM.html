<div id="More_CC">
<div class="head">
<h1>Theory More_CC</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> More_CC <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../constructive_cryptography/theories/#Constructive_Cryptography">Constructive_Cryptography.Constructive_Cryptography</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Material for Isabelle library›</span></span>

<span class="keyword1" id="More_CC-eq_alt_conversep"><span class="command">lemma</span></span> eq_alt_conversep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">=</span> <span class="main">(</span>BNF_Def.Grp UNIV id<span class="main">)</span><span class="main">¯¯</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">parametric_constant</span></span> 
  swap_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> prod.swap_def 

<span class="keyword1" id="More_CC-Sigma_parametric"><span class="command">lemma</span></span> Sigma_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> rel_set <span class="free">B</span><span class="main">)</span> <span class="main">===&gt;</span> rel_set <span class="main">(</span>rel_prod <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> Sigma Sigma"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sigma_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1" id="More_CC-empty_eq_Plus"><span class="command">lemma</span></span> empty_eq_Plus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> <span class="free">A</span> <span class="main">&lt;+&gt;</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-insert_Inl_Plus"><span class="command">lemma</span></span> insert_Inl_Plus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span>Inl <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">&lt;+&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="free">A</span> <span class="main">&lt;+&gt;</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-insert_Inr_Plus"><span class="command">lemma</span></span> insert_Inr_Plus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span>Inr <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">&lt;+&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">&lt;+&gt;</span> insert <span class="free">x</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-map_sum_image_Plus"><span class="command">lemma</span></span> map_sum_image_Plus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_sum <span class="free">f</span> <span class="free">g</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">&lt;+&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">&lt;+&gt;</span> <span class="free">g</span> <span class="main">`</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>

<span class="keyword1" id="More_CC-Plus_subset_Plus_iff"><span class="command">lemma</span></span> Plus_subset_Plus_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&lt;+&gt;</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">C</span> <span class="main">&lt;+&gt;</span> <span class="free">D</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-map_sum_eq_Inl_iff"><span class="command">lemma</span></span> map_sum_eq_Inl_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"map_sum <span class="free">f</span> <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> Inl <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Inl <span class="bound">x'</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-map_sum_eq_Inr_iff"><span class="command">lemma</span></span> map_sum_eq_Inr_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"map_sum <span class="free">f</span> <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> Inr <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Inr <span class="bound">x'</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-surj_map_sum"><span class="command">lemma</span></span> surj_map_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="main">(</span>map_sum <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"surj <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"surj <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x <span class="keyword1"><span class="command">using</span></span> that 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Inl <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Inr <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-bij_map_sumI"><span class="command">lemma</span></span> bij_map_sumI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span>map_sum <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_def sum.inj_map surj_map_sum<span class="main">)</span>

<span class="keyword1" id="More_CC-inv_map_sum"><span class="command">lemma</span></span> inv_map_sum <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bij <span class="free">f</span><span class="main">;</span> bij <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> inv_into UNIV <span class="main">(</span>map_sum <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> map_sum <span class="main">(</span>inv_into UNIV <span class="free">f</span><span class="main">)</span> <span class="main">(</span>inv_into UNIV <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> inj_imp_inv_eq<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.map_comp sum.inj_map bij_def surj_iff sum.map_id<span class="main">)</span>


<span class="keyword1"><span class="command">context</span></span> conditionally_complete_lattice <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="More_CC-admissible_le1I"><span class="command">lemma</span></span> admissible_le1I<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccpo.admissible <span class="free">lub</span> <span class="free">ord</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"cont <span class="free">lub</span> <span class="free">ord</span> Sup <span class="main">(≤)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ccpo.admissibleI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> contD<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cSUP_least<span class="main">)</span>

<span class="keyword1" id="More_CC-admissible_le1_mcont"><span class="command">lemma</span></span> admissible_le1_mcont <span class="main">[</span><span class="operator">cont_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ccpo.admissible <span class="free">lub</span> <span class="free">ord</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"mcont <span class="free">lub</span> <span class="free">ord</span> Sup <span class="main">(≤)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> admissible_le1I mcont_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="More_CC-eq_alt_conversep2"><span class="command">lemma</span></span> eq_alt_conversep2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>BNF_Def.Grp UNIV id<span class="main">)</span><span class="main">¯¯</span><span class="main">)</span><span class="main">¯¯</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_def fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="More_CC-nn_integral_indicator_singleton1"><span class="command">lemma</span></span> nn_integral_indicator_singleton1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> indicator <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">*</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>

<span class="keyword1" id="More_CC-nn_integral_indicator_singleton1'"><span class="command">lemma</span></span> nn_integral_indicator_singleton1' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> indicator <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="free">y</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">*</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> nn_integral_indicator_singleton1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> nn_integral_cong<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Probabilities›</span></span>

<span class="keyword1" id="More_CC-pmf_eq_1_iff"><span class="command">lemma</span></span> pmf_eq_1_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">=</span> return_pmf <span class="free">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> pmf <span class="free">p</span> <span class="skolem">i</span> <span class="main">+</span> pmf <span class="free">p</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> measure <span class="main">(</span>measure_pmf <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="skolem">i</span><span class="main">,</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> measure_pmf.finite_measure_eq_sum_singleton<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> measure_pmf.subprob_measure_le_1<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">rule</span> pmf_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> pmf_eqI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="More_CC-measure_spmf_cong"><span class="command">lemma</span></span> measure_spmf_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span>measure_spmf <span class="free">p</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> measure <span class="main">(</span>measure_spmf <span class="free">p</span><span class="main">)</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> set_spmf <span class="free">p</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∩</span> set_spmf <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span>measure_spmf <span class="free">p</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> measure <span class="main">(</span>measure_spmf <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> set_spmf <span class="free">p</span><span class="main">)</span> <span class="main">+</span> measure <span class="main">(</span>measure_spmf <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> set_spmf <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> measure_spmf.finite_measure_Union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">measure</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span>measure_spmf <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> set_spmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_spmf_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> measure <span class="main">(</span>measure_spmf <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> set_spmf <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_spmf_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span>measure_spmf <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> set_spmf <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">…</span> <span class="main">=</span> measure <span class="main">(</span>measure_spmf <span class="free">p</span><span class="main">)</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> measure_spmf.finite_measure_Union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">measure</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weight_spmf'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">weight_spmf'</span> <span class="main">=</span> weight_spmf"</span></span>
<span class="keyword1" id="More_CC-weight_spmf'_parametric"><span class="command">lemma</span></span> weight_spmf'_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fun <span class="main">(</span>rel_spmf <span class="free">A</span><span class="main">)</span> <span class="main">(=)</span> weight_spmf' weight_spmf'"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> weight_spmf'_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> weight_spmf_parametric<span class="main">)</span>

<span class="keyword1" id="More_CC-bind_spmf_to_nat_on"><span class="command">lemma</span></span> bind_spmf_to_nat_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bind_spmf <span class="main">(</span>map_spmf <span class="main">(</span>to_nat_on <span class="main">(</span>set_spmf <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>from_nat_into <span class="main">(</span>set_spmf <span class="free">p</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="free">p</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main">)</span>

<span class="keyword1" id="More_CC-try_cond_spmf_fst"><span class="command">lemma</span></span> try_cond_spmf_fst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"try_spmf <span class="main">(</span>cond_spmf_fst <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> fst <span class="main">`</span> set_spmf <span class="free">p</span> <span class="keyword1">then</span> cond_spmf_fst <span class="free">p</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cond_spmf_fst_eq_return_None lossless_cond_spmf_fst try_spmf_lossless try_spmf_return_None<span class="main">)</span>

<span class="keyword1" id="More_CC-measure_try_spmf"><span class="command">lemma</span></span> measure_try_spmf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"measure <span class="main">(</span>measure_spmf <span class="main">(</span>try_spmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> measure <span class="main">(</span>measure_spmf <span class="free">p</span><span class="main">)</span> <span class="free">A</span> <span class="main">+</span> pmf <span class="free">p</span> None <span class="main">*</span> measure <span class="main">(</span>measure_spmf <span class="free">q</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>measure_spmf <span class="main">(</span>try_spmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> emeasure <span class="main">(</span>measure_spmf <span class="free">p</span><span class="main">)</span> <span class="free">A</span> <span class="main">+</span> pmf <span class="free">p</span> None <span class="main">*</span> emeasure <span class="main">(</span>measure_spmf <span class="free">q</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fold</span> nn_integral_spmf<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_try_spmf nn_integral_add ennreal_mult' nn_integral_cmult<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_spmf.emeasure_eq_measure ennreal_mult'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ennreal_plus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ennreal_plus<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-rel_spmf_OO_trans_strong"><span class="command">lemma</span></span> rel_spmf_OO_trans_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> rel_spmf <span class="free">R</span> <span class="free">p</span> <span class="free">q</span><span class="main">;</span> rel_spmf <span class="free">S</span> <span class="free">q</span> <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> rel_spmf <span class="main">(</span><span class="free">R</span> <span class="keyword1">OO</span> eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_spmf <span class="free">q</span><span class="main">)</span> <span class="keyword1">OO</span> <span class="free">S</span><span class="main">)</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_spmf_OO_trans rel_spmf_reflI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>

<span class="keyword1" id="More_CC-mcont2mcont_spmf"><span class="command">lemma</span></span> mcont2mcont_spmf <span class="main">[</span><span class="operator">cont_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mcont <span class="free">lub</span> <span class="free">ord</span> Sup <span class="main">(≤)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> spmf <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"mcont <span class="free">lub</span> <span class="free">ord</span> lub_spmf <span class="main">(</span>ord_spmf <span class="main">(=)</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> mcont_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> monotone2monotone<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> monotone_spmf<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> contI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> contD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> luba<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">lub</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> cont_spmf<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> contD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> chain_imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ monotoneD<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-ord_spmf_try_spmf2"><span class="command">lemma</span></span> ord_spmf_try_spmf2<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_spmf <span class="free">R</span> <span class="free">p</span> <span class="main">(</span>try_spmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="free">R</span> <span class="free">p</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ord_spmf <span class="free">R</span> <span class="main">(</span>bind_pmf <span class="free">p</span> return_pmf<span class="main">)</span> <span class="main">(</span>try_spmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> try_spmf_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_pmf_bindI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"rel_option <span class="free">R</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">use</span> that <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> rel_pmf_return_pmf1 <span class="quasi_keyword">elim</span><span class="main">!</span><span class="main">:</span> option.rel_cases›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_return_pmf'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-ord_spmf_lossless_spmfD1"><span class="command">lemma</span></span> ord_spmf_lossless_spmfD1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ord_spmf <span class="free">R</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="free">R</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms lossless_iff_set_pmf_None option.simps<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> ord_option.cases pmf.rel_mono_strong<span class="main">)</span>

<span class="keyword1" id="More_CC-restrict_spmf_mono"><span class="command">lemma</span></span> restrict_spmf_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ord_spmf <span class="main">(=)</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span> ord_spmf <span class="main">(=)</span> <span class="main">(</span><span class="free">p</span> <span class="main">↿</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">q</span> <span class="main">↿</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_spmf_def pmf.rel_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pmf.rel_mono_strong <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ord_option.cases<span class="main">)</span>

<span class="keyword1" id="More_CC-restrict_lub_spmf"><span class="command">lemma</span></span> restrict_lub_spmf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain <span class="main">(</span>ord_spmf <span class="main">(=)</span><span class="main">)</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"restrict_spmf <span class="main">(</span>lub_spmf <span class="free">Y</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> lub_spmf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> restrict_spmf <span class="bound">p</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Y<span class="main">:</span> False
  <span class="keyword1"><span class="command">have</span></span> chain'<span class="main">:</span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain <span class="main">(</span>ord_spmf <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">↿</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chain <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> chain_imageI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> restrict_spmf_mono<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> spmf_eqI<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_lub_spmf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> chain'<span class="main"><span class="main">]</span></span> Y image_image spmf_restrict_spmf spmf_lub_spmf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> chain<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="More_CC-mono2mono_restrict_spmf"><span class="command">lemma</span></span> mono2mono_restrict_spmf <span class="main">[</span><span class="operator">THEN</span> spmf.mono2mono<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> monotone_restrict_spmf<span class="main">:</span> <span class="quoted"><span class="quoted">"monotone <span class="main">(</span>ord_spmf <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>ord_spmf <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">↿</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> monotoneI<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> restrict_spmf_mono<span class="main">)</span>

<span class="keyword1" id="More_CC-mcont2mcont_restrict_spmf"><span class="command">lemma</span></span> mcont2mcont_restrict_spmf <span class="main">[</span><span class="operator">THEN</span> spmf.mcont2mcont<span class="main">,</span> <span class="operator">cont_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>  mcont_restrict_spmf<span class="main">:</span> <span class="quoted"><span class="quoted">"mcont lub_spmf <span class="main">(</span>ord_spmf <span class="main">(=)</span><span class="main">)</span> lub_spmf <span class="main">(</span>ord_spmf <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> restrict_spmf <span class="bound">p</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> monotone_restrict_spmf <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mcontI<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> contI restrict_lub_spmf<span class="main">)</span>

<span class="keyword1" id="More_CC-ord_spmf_case_option"><span class="command">lemma</span></span> ord_spmf_case_option<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_spmf <span class="free">R</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">a</span> <span class="main">|</span> Some <span class="bound">y</span> <span class="main">⇒</span> <span class="free">b</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">a'</span> <span class="main">|</span> Some <span class="bound">y</span> <span class="main">⇒</span> <span class="free">b'</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"ord_spmf <span class="free">R</span> <span class="free">a</span> <span class="free">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> ord_spmf <span class="free">R</span> <span class="main">(</span><span class="free">b</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">b'</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-ord_spmf_map_spmfI"><span class="command">lemma</span></span> ord_spmf_map_spmfI<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_spmf <span class="main">(=)</span> <span class="main">(</span>map_spmf <span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>map_spmf <span class="free">f</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"ord_spmf <span class="main">(=)</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf.rel_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pmf.rel_mono_strong ord_option.cases<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Conditional probabilities›</span></span>

<span class="keyword1" id="More_CC-mk_lossless_cond_spmf"><span class="command">lemma</span></span> mk_lossless_cond_spmf <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mk_lossless <span class="main">(</span>cond_spmf <span class="free">p</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> cond_spmf <span class="free">p</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_alt<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> pmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">*</span> measure <span class="main">(</span>measure_pmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">/</span> measure <span class="main">(</span>measure_pmf <span class="main">(</span>bind_pmf <span class="free">p</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cond_bind_pmf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cond_bind_pmf</span> <span class="main">=</span> embed_pmf <span class="free">F</span>"</span></span>

<span class="keyword1" id="More_CC-cond_bind_pmf_nonneg"><span class="command">lemma</span></span> cond_bind_pmf_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> defined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set_pmf <span class="free">p</span><span class="main">.</span> set_pmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="More_CC-nonzero"><span class="command">lemma</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span>measure_pmf <span class="main">(</span>bind_pmf <span class="free">p</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> defined <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> measure_pmf_posI<span class="main">)</span>

<span class="keyword1" id="More_CC-cond_bind_pmf_prob"><span class="command">lemma</span></span> cond_bind_pmf_prob<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> nonzero'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>measure_pmf.prob <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defined <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_0_iff_AE AE_count_space pmf_eq_0_set_pmf measure_pmf_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>measure_pmf.prob <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">&lt;</span> <span class="main">⊤</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">&lt;</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> order.strict_trans1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> nn_integral_mono<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_le<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">⊤</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_pmf_eq_1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">F</span> <span class="bound">x</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span> <span class="main">*</span> measure_pmf.prob <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> emeasure <span class="main">(</span>measure_pmf <span class="main">(</span>bind_pmf <span class="free">p</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonzero <span class="keyword1"><span class="command">unfolding</span></span> F_def measure_pmf.emeasure_eq_measure 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_ennreal<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> divide_ennreal_def nn_integral_multc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> emeasure_bind_pmf 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pmf.emeasure_eq_measure nn_integral_measure_pmf ennreal_mult' nonzero' finite<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>           
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-pmf_cond_bind_pmf"><span class="command">lemma</span></span> pmf_cond_bind_pmf<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf cond_bind_pmf <span class="free">x</span> <span class="main">=</span> <span class="free">F</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cond_bind_pmf_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> pmf_embed_pmf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cond_bind_pmf_nonneg cond_bind_pmf_prob<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="More_CC-set_cond_bind_pmf"><span class="command">lemma</span></span> set_cond_bind_pmf<span class="main">:</span> <span class="quoted"><span class="quoted">"set_pmf cond_bind_pmf <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>set_pmf <span class="free">p</span><span class="main">.</span> set_pmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cond_bind_pmf_def 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> set_embed_pmf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cond_bind_pmf_nonneg cond_bind_pmf_prob<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def pmf_eq_0_set_pmf measure_pmf_zero_iff<span class="main">)</span>

<span class="keyword1" id="More_CC-cond_bind_pmf"><span class="command">lemma</span></span> cond_bind_pmf<span class="main">:</span> <span class="quoted"><span class="quoted">"cond_pmf <span class="main">(</span>bind_pmf <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> bind_pmf cond_bind_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cond_pmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> pmf_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>pmf <span class="var">?lhs</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span>pmf <span class="var">?rhs</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>pmf <span class="var">?lhs</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">/</span> ennreal <span class="main">(</span>measure_pmf.prob <span class="main">(</span><span class="free">p</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True defined
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_cond bind_UNION Int_commute divide_ennreal<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nonzero ennreal_pmf_bind<span class="main">)</span>
        <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_ennreal_def nn_integral_multc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nn_integral_measure_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">F</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>pmf <span class="main">(</span>cond_pmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True nonzero
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def ennreal_mult'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> divide_ennreal<span class="main">)</span>
          <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"measure_pmf.prob <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_cond pmf_eq_0_set_pmf measure_pmf_zero_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ennreal <span class="main">(</span>pmf <span class="var">?rhs</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_pmf_bind nn_integral_measure_pmf pmf_cond_bind_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> defined
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_cond bind_UNION Int_commute pmf_eq_0_set_pmf set_cond_bind_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?lhs</span> <span class="skolem">i</span> <span class="main">=</span> pmf <span class="var">?rhs</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1" id="More_CC-cond_spmf_try1"><span class="command">lemma</span></span> cond_spmf_try1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cond_spmf <span class="main">(</span>try_spmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> cond_spmf <span class="free">p</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"set_spmf <span class="free">q</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> spmf_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_try_spmf measure_try_spmf measure_spmf_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> spmf_eq_0_set_spmf<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_try_spmf measure_spmf_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-cond_spmf_cong"><span class="command">lemma</span></span> cond_spmf_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"cond_spmf <span class="free">p</span> <span class="free">A</span> <span class="main">=</span> cond_spmf <span class="free">p</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> set_spmf <span class="free">p</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∩</span> set_spmf <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> spmf_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_spmf_zero_iff spmf_eq_0_set_spmf measure_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="More_CC-cond_spmf_pair_spmf"><span class="command">lemma</span></span> cond_spmf_pair_spmf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cond_spmf <span class="main">(</span>pair_spmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> pair_spmf <span class="main">(</span>cond_spmf <span class="free">p</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>cond_spmf <span class="free">q</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> spmf_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"spmf <span class="var">?lhs</span> <span class="skolem">i</span> <span class="main">=</span> spmf <span class="var">?rhs</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> i <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Pair <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_pair_spmf_times<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-cond_spmf_pair_spmf1"><span class="command">lemma</span></span> cond_spmf_pair_spmf1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pair_spmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
   pair_spmf <span class="main">(</span>cond_spmf_fst <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cond_spmf <span class="main">(</span>pair_spmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_def spmf.map_comp o_def split_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">×</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cond_spmf <span class="main">(</span>pair_spmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">…</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_def cond_spmf_pair_spmf that spmf.map_comp pair_map_spmf1 apfst_def map_prod_def split_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-try_cond_spmf"><span class="command">lemma</span></span> try_cond_spmf<span class="main">:</span> <span class="quoted"><span class="quoted">"try_spmf <span class="main">(</span>cond_spmf <span class="free">p</span> <span class="free">A</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> set_spmf <span class="free">p</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">then</span> cond_spmf <span class="free">p</span> <span class="free">A</span> <span class="keyword1">else</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_def lossless_iff_set_pmf_None <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> try_spmf_lossless<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> set_cond_pmf<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_spmf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-cond_spmf_try2"><span class="command">lemma</span></span> cond_spmf_try2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cond_spmf <span class="main">(</span>try_spmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> lossless_spmf <span class="free">p</span> <span class="keyword1">then</span> return_pmf None <span class="keyword1">else</span> cond_spmf <span class="free">q</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"set_spmf <span class="free">p</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> spmf_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_try_spmf measure_try_spmf measure_spmf_zero_iff lossless_iff_pmf_None<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> spmf_eq_0_set_spmf<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_spmf_zero_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cond_bind_spmf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> spmf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> spmf<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'a</span> spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">cond_bind_spmf</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> 
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> set_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">then</span> 
     cond_bind_pmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> return_pmf None <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> return_pmf None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="More_CC-defined"><span class="command">lemma</span></span> defined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">y</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> set_spmf <span class="free">p</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> Some <span class="main">`</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set_pmf <span class="free">p</span><span class="main">.</span> set_pmf <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> return_pmf None <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_spmf bind_spmf_def<span class="main">)</span>

<span class="keyword1" id="More_CC-spmf_cond_bind_spmf"><span class="command">lemma</span></span> spmf_cond_bind_spmf <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>cond_bind_spmf <span class="free">p</span> <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> spmf <span class="free">p</span> <span class="free">x</span> <span class="main">*</span> measure <span class="main">(</span>measure_spmf <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">/</span> measure <span class="main">(</span>measure_spmf <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_bind_spmf_def measure_spmf_zero_iff bind_UNION pmf_cond_bind_pmf defined <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
     <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_spmf bind_spmf_def measure_measure_spmf_conv_measure_pmf<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="More_CC-set_cond_bind_spmf"><span class="command">lemma</span></span> set_cond_bind_spmf <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set_spmf <span class="main">(</span>cond_bind_spmf <span class="free">p</span> <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>set_spmf <span class="free">p</span><span class="main">.</span> set_spmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_bind_spmf_def set_spmf_def bind_UNION<span class="main">)</span>
    <span class="main">(</span><span class="operator">subst</span> set_cond_bind_pmf<span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_measure_spmf_conv_measure_pmf<span class="main">)</span>

<span class="keyword1" id="More_CC-cond_bind_spmf"><span class="command">lemma</span></span> cond_bind_spmf<span class="main">:</span> <span class="quoted"><span class="quoted">"cond_spmf <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> bind_spmf <span class="main">(</span>cond_bind_spmf <span class="free">p</span> <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cond_spmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_def bind_UNION cond_bind_spmf_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_bind_pmf set_cond_bind_pmf defined in_set_spmf bind_spmf_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="More_CC-cond_spmf_fst_parametric"><span class="command">lemma</span></span> cond_spmf_fst_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="free">B</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span> <span class="main">===&gt;</span> rel_spmf <span class="free">B</span><span class="main">)</span> cond_spmf_fst cond_spmf_fst"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_def spmf_rel_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmfE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x pq
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"fst <span class="main">-`</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">∩</span> snd <span class="main">-`</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-cond_spmf_fst_map_prod"><span class="command">lemma</span></span> cond_spmf_fst_map_prod<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> map_spmf <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="free">p</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>fst <span class="main">`</span> set_spmf <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cond_spmf <span class="free">p</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="main">(</span><span class="main">{</span><span class="free">f</span> <span class="free">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">=</span> cond_spmf <span class="free">p</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="main">(</span><span class="main">{</span><span class="free">f</span> <span class="free">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set_spmf <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> cond_spmf_cong<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="main">(</span><span class="main">{</span><span class="free">f</span> <span class="free">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set_spmf <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">∩</span> set_spmf <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cond_spmf <span class="free">p</span> <span class="main">…</span> <span class="main">=</span> cond_spmf <span class="free">p</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> cond_spmf_cong<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_def spmf.map_comp o_def split_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> map_spmf_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-cond_spmf_fst_map_prod_inj"><span class="command">lemma</span></span> cond_spmf_fst_map_prod_inj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>  map_spmf <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="free">p</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> cond_spmf_fst_map_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cond_bind_spmf_fst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> spmf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> spmf<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cond_bind_spmf_fst</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> cond_bind_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>

<span class="keyword1" id="More_CC-cond_bind_spmf_fst_map_spmf_fst"><span class="command">lemma</span></span> cond_bind_spmf_fst_map_spmf_fst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cond_bind_spmf_fst <span class="free">p</span> <span class="main">(</span>map_spmf fst <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> cond_bind_spmf <span class="free">p</span> <span class="free">f</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> cond_bind_spmf <span class="free">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_bind_spmf_fst_def spmf.map_comp o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> spmf_eqI<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_map_spmf map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-cond_spmf_fst_bind"><span class="command">lemma</span></span> cond_spmf_fst_bind<span class="main">:</span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> 
  bind_spmf <span class="main">(</span>cond_bind_spmf_fst <span class="free">p</span> <span class="main">(</span>map_spmf fst <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> cond_spmf_fst <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_def cond_bind_spmf map_bind_spmf cond_bind_spmf_fst_map_spmf_fst<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

<span class="keyword1" id="More_CC-spmf_cond_bind_spmf_fst"><span class="command">lemma</span></span> spmf_cond_bind_spmf_fst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>cond_bind_spmf_fst <span class="free">p</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> spmf <span class="free">p</span> <span class="free">i</span> <span class="main">*</span> spmf <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">/</span> spmf <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_bind_spmf_fst_def<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_conv_measure_spmf measure_map_spmf map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(/)</span>"</span></span><span class="main"><span class="main">]</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(*)</span>"</span></span><span class="main"><span class="main">]</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"measure"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="More_CC-set_cond_bind_spmf_fst"><span class="command">lemma</span></span> set_cond_bind_spmf_fst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set_spmf <span class="main">(</span>cond_bind_spmf_fst <span class="free">p</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> set_spmf <span class="free">p</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_bind_spmf_fst_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>

<span class="keyword1" id="More_CC-map_cond_spmf_fst"><span class="command">lemma</span></span> map_cond_spmf_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"map_spmf <span class="free">f</span> <span class="main">(</span>cond_spmf_fst <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> cond_spmf_fst <span class="main">(</span>map_spmf <span class="main">(</span>apsnd <span class="free">f</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_def spmf.map_comp <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_spmf_cong arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"cond_spmf"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="More_CC-cond_spmf_fst_try1"><span class="command">lemma</span></span> cond_spmf_fst_try1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>try_spmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> cond_spmf_fst <span class="free">p</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fst <span class="main">`</span> set_spmf <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> cond_spmf_try1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-cond_spmf_fst_try2"><span class="command">lemma</span></span> cond_spmf_fst_try2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>try_spmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> lossless_spmf <span class="free">p</span> <span class="keyword1">then</span> return_pmf None <span class="keyword1">else</span> cond_spmf_fst <span class="free">q</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fst <span class="main">`</span> set_spmf <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cond_spmf_fst_def cond_spmf_fst_eq_return_None<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cond_spmf_fst_def cond_spmf_try2 lossless_cond_spmf lossless_cond_spmf_fst lossless_map_spmf<span class="main">)</span>

<span class="keyword1" id="More_CC-cond_spmf_fst_map_inj"><span class="command">lemma</span></span> cond_spmf_fst_map_inj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>map_spmf <span class="main">(</span>apfst <span class="free">f</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> cond_spmf_fst <span class="free">p</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_def spmf.map_comp <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_spmf_cong arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">cond_spmf</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> injD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="More_CC-cond_spmf_fst_pair_spmf1"><span class="command">lemma</span></span> cond_spmf_fst_pair_spmf1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pair_spmf <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span>
   bind_spmf <span class="main">(</span>cond_spmf_fst <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>mk_lossless <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="main">(</span><span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="main">(</span><span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_def spmf.map_comp o_def split_beta cond_spmf_pair_spmf<span class="main">)</span>
      <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def map_bind_spmf o_def map_spmf_conv_bind_spmf<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-cond_spmf_fst_return_spmf'"><span class="command">lemma</span></span> cond_spmf_fst_return_spmf'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="free">z</span> <span class="keyword1">then</span> return_spmf <span class="free">y</span> <span class="keyword1">else</span> return_pmf None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_def<span class="main">)</span>






<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Material for CryptHOL›</span></span>

<span class="keyword1" id="More_CC-left_gpv_lift_spmf"><span class="command">lemma</span></span> left_gpv_lift_spmf <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"left_gpv <span class="main">(</span>lift_spmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span> lift_spmf <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> gpv.expand<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp o_def<span class="main">)</span>

<span class="keyword1" id="More_CC-right_gpv_lift_spmf"><span class="command">lemma</span></span> right_gpv_lift_spmf <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"right_gpv <span class="main">(</span>lift_spmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span> lift_spmf <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> gpv.expand<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp o_def<span class="main">)</span>

<span class="keyword1" id="More_CC-map'_lift_spmf"><span class="command">lemma</span></span> map'_lift_spmf<span class="main">:</span> <span class="quoted"><span class="quoted">"map_gpv' <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="main">(</span>lift_spmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span> lift_spmf <span class="main">(</span>map_spmf <span class="free">f</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> gpv.expand<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel spmf.map_comp o_def<span class="main">)</span>

<span class="keyword1" id="More_CC-in_set_sample_uniform"><span class="command">lemma</span></span> in_set_sample_uniform <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set_spmf <span class="main">(</span>sample_uniform <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_uniform_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cyclic_group<span class="main">)</span> inj_on_generator_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">&lt;</span> order <span class="free">G</span><span class="main">;</span> <span class="free">y</span> <span class="main">&lt;</span> order <span class="free">G</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free">x</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_on_generator <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>

<span class="keyword1" id="More_CC-map_ℐ_bot"><span class="command">lemma</span></span> map_ℐ_bot <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_ℐ <span class="free">f</span> <span class="free">g</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bot_ℐ_def map_ℐ_ℐ_uniform <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="More_CC-map_ℐ_Inr_plus"><span class="command">lemma</span></span> map_ℐ_Inr_plus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_ℐ Inr <span class="free">f</span> <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="main">=</span> map_ℐ id <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> Inr<span class="main">)</span> <span class="free">ℐ2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ℐ_eqI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-interaction_bound_map_gpv'_le"><span class="command">lemma</span></span> interaction_bound_map_gpv'_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ib</span> <span class="main">≡</span> interaction_bound"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_bound <span class="free">consider</span> <span class="main">(</span>map_gpv' <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">gpv</span><span class="main">)</span> <span class="main">≤</span> <span class="free">ib</span> <span class="main">(</span><span class="free">consider</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">gpv</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interaction_bound_fixp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">interaction_bound'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ib_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> interaction_bound.simps<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp ib_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> generat.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> SUP_mono rev_bexI step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ib_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-interaction_bounded_by_map_gpv'"><span class="command">lemma</span></span> interaction_bounded_by_map_gpv' <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="main">(</span><span class="free">consider</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">gpv</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="free">consider</span> <span class="main">(</span>map_gpv' <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">gpv</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms interaction_bound_map_gpv'_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">consider</span>"</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">gpv</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interaction_bounded_by.simps<span class="main">)</span>

<span class="keyword1" id="More_CC-map_gpv'_bind_gpv"><span class="command">lemma</span></span> map_gpv'_bind_gpv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_gpv' <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="main">(</span>bind_gpv <span class="free">gpv</span> <span class="free">F</span><span class="main">)</span> <span class="main">=</span> bind_gpv <span class="main">(</span>map_gpv' id <span class="free">g</span> <span class="free">h</span> <span class="free">gpv</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_gpv' <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="main">(</span><span class="free">F</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gpv.coinduct_strong<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_gpv_sel' <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_gpv.sel spmf_rel_map bind_map_spmf generat.rel_map rel_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_bind_reflI rel_spmf_reflI generat.rel_refl_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>

<span class="keyword1" id="More_CC-exec_gpv_map_gpv'"><span class="command">lemma</span></span> exec_gpv_map_gpv'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"exec_gpv <span class="free">callee</span> <span class="main">(</span>map_gpv' <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">gpv</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span>
   map_spmf <span class="main">(</span>map_prod <span class="free">f</span> id<span class="main">)</span> <span class="main">(</span>exec_gpv <span class="main">(</span>map_fun id <span class="main">(</span>map_fun <span class="free">g</span> <span class="main">(</span>map_spmf <span class="main">(</span>map_prod <span class="free">h</span> id<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">callee</span><span class="main">)</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exec_gpv_parametric'<span class="main">[</span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> CALL<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">h</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">f</span>"</span></span><span class="main">,</span>
     <span class="operator">unfolded</span> rel_gpv''_Grp<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> conversep_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> prod.rel_conversep<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2 4<span class="main"><span class="main">)</span></span> eq_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> prod.rel_Grp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> spmf_rel_conversep<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> option.rel_Grp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> pmf.rel_Grp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> prod.rel_Grp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 3<span class="main"><span class="main">)</span></span> conversep_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> rel_fun_conversep<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> rel_fun_Grp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> rel_fun_conversep<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option.rel_Grp pmf.rel_Grp fun.rel_Grp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def BNF_Def.Grp_def o_def map_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> allE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> fun_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>                   
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-colossless_gpv_sub_gpvs"><span class="command">lemma</span></span> colossless_gpv_sub_gpvs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"colossless_gpv <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">gpv'</span> <span class="main">∈</span> sub_gpvs <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"colossless_gpv <span class="free">ℐ</span> <span class="free">gpv'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> colossless_gpvD<span class="main">)</span>

<span class="keyword1" id="More_CC-pfinite_gpv_sub_gpvs"><span class="command">lemma</span></span> pfinite_gpv_sub_gpvs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pfinite_gpv <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">gpv'</span> <span class="main">∈</span> sub_gpvs <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pfinite_gpv <span class="free">ℐ</span> <span class="free">gpv'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pfinite_gpv_ContD WT_gpvD<span class="main">)</span>

<span class="keyword1" id="More_CC-pfinite_gpv_id_oracle"><span class="command">lemma</span></span> pfinite_gpv_id_oracle <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_gpv <span class="free">ℐ</span> <span class="main">(</span>id_oracle <span class="free">s</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_oracle_def pgen_lossless_gpv_PauseI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">try_gpv</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="More_CC-plossless_gpv_try_gpvI"><span class="command">lemma</span></span> plossless_gpv_try_gpvI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pfinite_gpv <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> colossless_gpv <span class="free">ℐ</span> <span class="free">gpv</span> <span class="main">⟹</span> plossless_gpv <span class="free">ℐ</span> <span class="free">gpv'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="free">ℐ</span> <span class="main">(</span><span class="keyword1">TRY</span> <span class="free">gpv</span> <span class="keyword1">ELSE</span> <span class="free">gpv'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> pgen_lossless_gpv_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"colossless_gpv <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> expectation_gpv_cong_fail<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="More_CC-WT_gpv_try_gpvI"><span class="command">lemma</span></span> WT_gpv_try_gpvI <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> colossless_gpv <span class="free">ℐ</span> <span class="free">gpv</span> <span class="main">⟹</span> <span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv'</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> try_gpv <span class="free">gpv</span> <span class="free">gpv'</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD colossless_gpvD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> callee_invariant_on<span class="main">)</span> exec_gpv_try_gpv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">exec_gpv1</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">exec_gpv1</span> <span class="main">≡</span> exec_gpv"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite<span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_gpv <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">⟧</span> <span class="main">⟹</span> lossless_spmf <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_spmf <span class="free">f</span> <span class="main">(</span>exec_gpv <span class="free">callee</span> <span class="main">(</span>try_gpv <span class="free">gpv</span> <span class="main">(</span>Done <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
    try_spmf <span class="main">(</span>map_spmf <span class="free">f</span> <span class="main">(</span><span class="free">exec_gpv1</span> <span class="free">callee</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">show_variants</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_spmf <span class="main">(=)</span> <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> WT I
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec_gpv_fixp_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">exec_gpv'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.prems <span class="keyword1"><span class="command">unfolding</span></span> exec_gpv1_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> exec_gpv.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_bind_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> try_spmf_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_pmf bind_spmf_pmf_assoc o_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def bind_map_pmf bind_assoc_pmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_pmf_bindI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pmf.rel_refl_strong<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split generat.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_return_pmf f map_spmf_bind_spmf o_def eq_onp_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def bind_assoc_pmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> out c
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_pmf_bindI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pmf.rel_refl_strong<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> spmf.leq_trans<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> step.IH<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> WT_gpvD<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> WT_gpvD<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> WT_callee<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> WT_calleeD<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> WT_gpvD<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> callee_invariant<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> try_spmf_def exec_gpv1_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="var">?lhs</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> plossless_exec_gpv<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> plossless_gpv_try_gpvI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pfinite<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_gpv_try_gpvI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WT<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> ord_spmf_lossless_spmfD1<span class="main">[</span><span class="operator">OF</span> le this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-try_gpv_bind_gen_lossless'"><span class="command">lemma</span></span> try_gpv_bind_gen_lossless'<span class="main">:</span> <span class="comment1">― ‹generalises <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> try_gpv_bind_gen_lossless<span class="antiquote">}</span></span>›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lossless<span class="main">:</span> <span class="quoted"><span class="quoted">"gen_lossless_gpv <span class="free">b</span> <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv'</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WTf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> results_gpv <span class="free">ℐ</span> <span class="free">gpv</span> <span class="main">⟹</span> <span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">(=)</span> <span class="free">ℐ</span> <span class="main">(</span><span class="keyword1">TRY</span> bind_gpv <span class="free">gpv</span> <span class="free">f</span> <span class="keyword1">ELSE</span> <span class="free">gpv'</span><span class="main">)</span> <span class="main">(</span>bind_gpv <span class="free">gpv</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">TRY</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">ELSE</span> <span class="free">gpv'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lossless WT1 WTf
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eq_ℐ_gpv <span class="skolem">gpv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> spmf_rel_map generat.rel_map map_spmf_bind_spmf
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span> <span class="main">=</span> rel_spmf_reflI rel_generat_reflI rel_funI
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> gen_lossless_gpvD<span class="main">[</span><span class="operator">OF</span> eq_ℐ_gpv<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> WT_gpvD<span class="main">[</span><span class="operator">OF</span> eq_ℐ_gpv<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> WT_gpvD<span class="main">[</span><span class="operator">OF</span> WT2<span class="main">]</span> WT_gpvD<span class="main">[</span><span class="operator">OF</span> eq_ℐ_gpv<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">rule_format</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator"><span class="operator">OF</span></span> results_gpv.Pure<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span> WT2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_gpv_sel' <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_gpv.sel try_spmf_bind_spmf_lossless generat.map_comp o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_bind_reflI rel_spmf_try_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> eq_ℐ_gpv_reflI eq_ℐ_generat_reflI <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> results_gpv.IO <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹We instantiate the parameter <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">b</span></span><span class="antiquote">}</span></span> such that it can be used as a conditional simp rule.›</span>
<span class="keyword1"><span class="command">lemmas</span></span> try_gpv_bind_lossless' <span class="main">=</span> try_gpv_bind_gen_lossless'<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted">False</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> try_gpv_bind_colossless' <span class="main">=</span> try_gpv_bind_gen_lossless'<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted">True</span><span class="main">]</span>

<span class="keyword1" id="More_CC-try_gpv_bind_gpv"><span class="command">lemma</span></span> try_gpv_bind_gpv<span class="main">:</span>
   <span class="quoted"><span class="quoted">"try_gpv <span class="main">(</span>bind_gpv <span class="free">gpv</span> <span class="free">f</span><span class="main">)</span> <span class="free">gpv'</span> <span class="main">=</span>
    bind_gpv <span class="main">(</span>try_gpv <span class="main">(</span>map_gpv Some id <span class="free">gpv</span><span class="main">)</span> <span class="main">(</span>Done None<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">gpv'</span> <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> try_gpv <span class="main">(</span><span class="free">f</span> <span class="bound">x'</span><span class="main">)</span> <span class="free">gpv'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gpv.coinduct_strong<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def generat.rel_map bind_return_pmf spmf_rel_map map_bind_spmf o_def bind_gpv.sel bind_map_spmf try_spmf_def bind_spmf_def spmf.map_comp bind_map_pmf bind_assoc_pmf gpv.map_sel <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_gpv_sel' <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_pmf_bind_reflI generat.rel_refl_strong rel_spmf_reflI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split generat.split<span class="main">)</span>

<span class="keyword1" id="More_CC-bind_gpv_try_gpv_map_Some"><span class="command">lemma</span></span> bind_gpv_try_gpv_map_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bind_gpv <span class="main">(</span>try_gpv <span class="main">(</span>map_gpv Some id <span class="free">gpv</span><span class="main">)</span> <span class="main">(</span>Done None<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">y</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span>
   bind_gpv <span class="free">gpv</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gpv.coinduct_strong<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_gpv.sel map_bind_spmf bind_map_spmf try_spmf_def bind_spmf_def spmf_rel_map bind_map_pmf gpv.map_sel bind_assoc_pmf bind_return_pmf generat.rel_map rel_fun_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_gpv_sel' <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_pmf_bind_reflI rel_spmf_reflI generat.rel_refl_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split generat.split<span class="main">)</span>

<span class="keyword1" id="More_CC-try_gpv_left_gpv"><span class="command">lemma</span></span> try_gpv_left_gpv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> WT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv'</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">(=)</span> <span class="main">(</span><span class="free">ℐ</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ'</span><span class="main">)</span> <span class="main">(</span>try_gpv <span class="main">(</span>left_gpv <span class="free">gpv</span><span class="main">)</span> <span class="main">(</span>left_gpv <span class="free">gpv'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>left_gpv <span class="main">(</span>try_gpv <span class="free">gpv</span> <span class="free">gpv'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_try_spmf spmf.map_comp o_def generat.map_comp spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_try_spmf rel_spmf_reflI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> gpv generat <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">generat</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> gpv generat <span class="keyword1"><span class="command">using</span></span> WT2
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">generat</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_reflI WT_gpv_left_gpv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-try_gpv_right_gpv"><span class="command">lemma</span></span> try_gpv_right_gpv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> WT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span> <span class="keyword1">⊢g</span> <span class="free">gpv'</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">(=)</span> <span class="main">(</span><span class="free">ℐ</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ'</span><span class="main">)</span> <span class="main">(</span>try_gpv <span class="main">(</span>right_gpv <span class="free">gpv</span><span class="main">)</span> <span class="main">(</span>right_gpv <span class="free">gpv'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>right_gpv <span class="main">(</span>try_gpv <span class="free">gpv</span> <span class="free">gpv'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_try_spmf spmf.map_comp o_def generat.map_comp spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_try_spmf rel_spmf_reflI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> gpv generat <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">generat</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> gpv generat <span class="keyword1"><span class="command">using</span></span> WT2
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">generat</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_reflI WT_gpv_right_gpv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-bind_try_Done_Fail"><span class="command">lemma</span></span> bind_try_Done_Fail<span class="main">:</span> <span class="quoted"><span class="quoted">"bind_gpv <span class="main">(</span><span class="keyword1">TRY</span> <span class="free">gpv</span> <span class="keyword1">ELSE</span> Done <span class="free">x</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> bind_gpv <span class="free">gpv</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Fail"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gpv.coinduct_strong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_gpv_sel' <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_gpv.sel map_bind_spmf bind_map_spmf try_spmf_def bind_spmf_def map_bind_pmf bind_assoc_pmf bind_map_pmf bind_return_pmf spmf.map_comp o_def that rel_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_pmf_bind_reflI rel_spmf_reflI generat.rel_refl_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split generat.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="More_CC-inline_map_gpv'"><span class="command">lemma</span></span> inline_map_gpv'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inline <span class="free">callee</span> <span class="main">(</span>map_gpv' <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">gpv</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> 
   map_gpv <span class="main">(</span>apfst <span class="free">f</span><span class="main">)</span> id <span class="main">(</span>inline <span class="main">(</span>map_fun id <span class="main">(</span>map_fun <span class="free">g</span> <span class="main">(</span>map_gpv <span class="main">(</span>apfst <span class="free">h</span><span class="main">)</span> id<span class="main">)</span><span class="main">)</span> <span class="free">callee</span><span class="main">)</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inline_parametric'<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">h</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2 3 8<span class="main"><span class="main">)</span></span> eq_alt_conversep<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 3 4 5<span class="main"><span class="main">)</span></span> eq_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eq_alt_conversep2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> prod.rel_conversep rel_gpv''_conversep prod.rel_Grp rel_gpv''_Grp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def Grp_def map_gpv_conv_map_gpv' map_fun_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> o_def apfst_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-interaction_bound_try_gpv"><span class="command">lemma</span></span> interaction_bound_try_gpv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">consider</span>"</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ib</span> <span class="main">≡</span> interaction_bound <span class="free">consider</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_bound <span class="free">consider</span> <span class="main">(</span>try_gpv <span class="free">gpv</span> <span class="free">gpv'</span><span class="main">)</span> <span class="main">≤</span> <span class="free">ib</span> <span class="free">gpv</span> <span class="main">+</span> <span class="free">ib</span> <span class="free">gpv'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">gpv'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interaction_bound_fixp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">interaction_bound'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ib_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generat.map_comp image_image o_def case_map_generat <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> generat.case_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_split generat.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> SUP_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> interaction_bound.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Sup_image_eadd1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rev_image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iadd_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Sup_image_eadd1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ib_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> interaction_bound.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Sup_image_eadd1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rev_image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Sup_image_eadd1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rev_image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ib_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> interaction_bound.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Sup_image_eadd1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rev_image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iadd_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Sup_image_eadd1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ib_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> interaction_bound.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Sup_image_eadd1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rev_image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Sup_image_eadd1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rev_image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ib_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> interaction_bound.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Sup_image_eadd2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rev_image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iadd_Suc_right<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Sup_image_eadd2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> step.hyps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> enat_le_plus_same<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> interaction_bound.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Sup_image_eadd2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rev_image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> Sup_image_eadd2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> imageI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> step.hyps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> enat_le_plus_same<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-interaction_bounded_by_try_gpv"><span class="command">lemma</span></span> interaction_bounded_by_try_gpv <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="free">consider</span> <span class="main">(</span>try_gpv <span class="free">gpv1</span> <span class="free">gpv2</span><span class="main">)</span> <span class="main">(</span><span class="free">bound1</span> <span class="main">+</span> <span class="free">bound2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="free">consider</span> <span class="free">gpv1</span> <span class="free">bound1</span>"</span></span> <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="free">consider</span> <span class="free">gpv2</span> <span class="free">bound2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that interaction_bound_try_gpv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">consider</span>"</span></span> <span class="quoted"><span class="free">gpv1</span></span> <span class="quoted"><span class="free">gpv2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interaction_bounded_by.simps<span class="main">)</span><span class="main">(</span><span class="operator">meson</span> add_left_mono_trans add_right_mono le_left_mono<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹term <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>gpv_stop›</span></span></span></span>›</span></span>

<span class="keyword1" id="More_CC-interaction_bounded_by_gpv_stop"><span class="command">lemma</span></span> interaction_bounded_by_gpv_stop <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="free">consider</span> <span class="free">gpv</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="free">consider</span> <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interaction_bounded_by.simps<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> ℐ.lifting <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> stop_ℐ <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> option<span class="main">)</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">resp</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="bound">resp</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> insert None <span class="main">(</span>Some <span class="main">`</span> <span class="bound">resp</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="More_CC-outs_stop_ℐ"><span class="command">lemma</span></span> outs_stop_ℐ <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="main">(</span>stop_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">=</span> outs_ℐ <span class="free">ℐ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-responses_stop_ℐ"><span class="command">lemma</span></span> responses_stop_ℐ <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"responses_ℐ <span class="main">(</span>stop_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="keyword1">then</span> insert None <span class="main">(</span>Some <span class="main">`</span> responses_ℐ <span class="free">ℐ</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-stop_ℐ_full"><span class="command">lemma</span></span> stop_ℐ_full <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stop_ℐ ℐ_full <span class="main">=</span> ℐ_full"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff notin_range_Some<span class="main">)</span>

<span class="keyword1" id="More_CC-stop_ℐ_uniform"><span class="command">lemma</span></span> stop_ℐ_uniform <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"stop_ℐ <span class="main">(</span>ℐ_uniform <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> ℐ_uniform <span class="free">A</span> <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bot_ℐ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lifting_update</span></span> ℐ.lifting
<span class="keyword1"><span class="command">lifting_forget</span></span> ℐ.lifting

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="More_CC-stop_ℐ_bot"><span class="command">lemma</span></span> stop_ℐ_bot <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stop_ℐ <span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> bot_ℐ_def stop_ℐ_uniform<span class="main">)</span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="More_CC-WT_gpv_stop"><span class="command">lemma</span></span> WT_gpv_stop <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stop_ℐ <span class="free">ℐ</span> <span class="keyword1">⊢g</span> gpv_stop <span class="free">gpv</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD<span class="main">)</span>

<span class="keyword1" id="More_CC-expectation_gpv_stop"><span class="command">lemma</span></span> expectation_gpv_stop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fail</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">gpv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fail</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expectation_gpv <span class="free">fail</span> <span class="main">(</span>stop_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span> <span class="main">=</span> expectation_gpv <span class="free">fail</span> <span class="free">ℐ</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="free">gpv</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"expectation_gpv <span class="free">fail</span> <span class="main">(</span>stop_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span> <span class="main">≤</span> expectation_gpv <span class="free">fail</span> <span class="free">ℐ</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="free">gpv</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> WT
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_fixp_induct_1_1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> complete_lattice_partial_function_definitions complete_lattice_partial_function_definitions expectation_gpv.mono expectation_gpv.mono expectation_gpv_def expectation_gpv_def<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> adm bottom step<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_map_spmf_None measure_spmf_return_spmf nn_integral_return<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> disjI2 nn_integral_mono_AE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_infI2 INF_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">stop</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> option<span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span> option<span class="main">)</span> gpv <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">stop</span> <span class="main">=</span> expectation_gpv <span class="free">fail</span> <span class="main">(</span>stop_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">≤</span> <span class="skolem">stop</span> <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> WT
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> expectation_gpv_fixp_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">expectation_gpv'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">expectation_gpv'</span> <span class="skolem">gpv'</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="skolem">gpv'</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">gpv'</span>
      <span class="keyword1"><span class="command">using</span></span> expectation_gpv_const_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ℐ</span></span> <span class="quoted"><span class="skolem">gpv'</span></span> <span class="quoted"><span class="free">fail</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> fail step.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">gpv'</span></span><span class="main">]</span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">unfolding</span></span> stop_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> expectation_gpv.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_map_spmf_None<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> disjI2 nn_integral_mono_AE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_outs_ℐ_iff_responses_ℐ <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpv_ContD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> INF_lower2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> INF_mono rev_bexI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-pgen_lossless_gpv_stop"><span class="command">lemma</span></span> pgen_lossless_gpv_stop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fail</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">gpv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fail</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pgen_lossless_gpv <span class="free">fail</span> <span class="main">(</span>stop_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span> <span class="main">=</span> pgen_lossless_gpv <span class="free">fail</span> <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pgen_lossless_gpv_def expectation_gpv_stop assms<span class="main">)</span>

<span class="keyword1" id="More_CC-pfinite_gpv_stop"><span class="command">lemma</span></span> pfinite_gpv_stop <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pfinite_gpv <span class="main">(</span>stop_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span> <span class="main">⟷</span> pfinite_gpv <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pgen_lossless_gpv_stop<span class="main">)</span>

<span class="keyword1" id="More_CC-plossless_gpv_stop"><span class="command">lemma</span></span> plossless_gpv_stop <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"plossless_gpv <span class="main">(</span>stop_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span> <span class="main">⟷</span> plossless_gpv <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pgen_lossless_gpv_stop<span class="main">)</span>

<span class="keyword1" id="More_CC-results_gpv_stop_SomeD"><span class="command">lemma</span></span> results_gpv_stop_SomeD<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="free">x</span> <span class="main">∈</span> results_gpv <span class="main">(</span>stop_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> results_gpv <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="skolem">gpv'</span><span class="main"><span class="main">≡</span></span><span class="quoted"><span class="quoted">"gpv_stop <span class="free">gpv</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> results_gpv.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> results_gpv.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="More_CC-Some_in_results'_gpv_gpv_stopD"><span class="command">lemma</span></span> Some_in_results'_gpv_gpv_stopD<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="free">xy</span> <span class="main">∈</span> results'_gpv <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">xy</span> <span class="main">∈</span> results'_gpv <span class="free">gpv</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> results_gpv_ℐ_full<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> results_gpv_stop_SomeD<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹term <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>exception_ℐ›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'s</span> exception <span class="main">=</span> Fault <span class="main">|</span> OK <span class="main">(</span><span class="free"><span class="entity">ok</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span><span class="main">)</span>

<span class="keyword1" id="More_CC-inj_on_OK"><span class="command">lemma</span></span> inj_on_OK <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on OK <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">join_exception</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> exception <span class="main">⇒</span> <span class="tfree">'b</span> exception <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> exception"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">join_exception</span> Fault <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Fault"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join_exception</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Fault <span class="main">=</span> Fault"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join_exception</span> <span class="main">(</span>OK <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>OK <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> OK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">merge_exception</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> exception <span class="main">+</span> <span class="tfree">'b</span> exception <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> exception"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_exception</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> map_exception Inl <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_exception</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> map_exception Inr <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">option_of_exception</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> exception <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">option_of_exception</span> Fault <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">option_of_exception</span> <span class="main">(</span>OK <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exception_of_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> exception"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exception_of_option</span> None <span class="main">=</span> Fault"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exception_of_option</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> OK <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>


<span class="keyword1" id="More_CC-option_of_exception_exception_of_option"><span class="command">lemma</span></span> option_of_exception_exception_of_option <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"option_of_exception <span class="main">(</span>exception_of_option <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="More_CC-exception_of_option_option_of_exception"><span class="command">lemma</span></span> exception_of_option_option_of_exception <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_of_option <span class="main">(</span>option_of_exception <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="More_CC-case_exception_of_option"><span class="command">lemma</span></span> case_exception_of_option <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_exception <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>exception_of_option <span class="free">x</span><span class="main">)</span> <span class="main">=</span> case_option <span class="free">f</span> <span class="free">g</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> exception.split option.split<span class="main">)</span>

<span class="keyword1" id="More_CC-case_option_of_exception"><span class="command">lemma</span></span> case_option_of_exception <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_option <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>option_of_exception <span class="free">x</span><span class="main">)</span> <span class="main">=</span> case_exception <span class="free">f</span> <span class="free">g</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> exception.split option.split<span class="main">)</span>

<span class="keyword1" id="More_CC-surj_exception_of_option"><span class="command">lemma</span></span> surj_exception_of_option <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"surj exception_of_option"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> surjI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"option_of_exception"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="More_CC-surj_option_of_exception"><span class="command">lemma</span></span> surj_option_of_exception <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"surj option_of_exception"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> surjI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"exception_of_option"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="More_CC-case_map_exception"><span class="command">lemma</span></span> case_map_exception <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_exception <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>map_exception <span class="free">h</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> case_exception <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">h</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> exception.split<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">exception_ℐ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> exception<span class="main">)</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">exception_ℐ</span> <span class="free"><span class="bound"><span class="entity">ℐ</span></span></span> <span class="main">=</span> map_ℐ id exception_of_option <span class="main">(</span>stop_ℐ <span class="free"><span class="bound"><span class="entity">ℐ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="More_CC-outs_exception_ℐ"><span class="command">lemma</span></span> outs_exception_ℐ <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="main">(</span>exception_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">=</span> outs_ℐ <span class="free">ℐ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exception_ℐ_def<span class="main">)</span>

<span class="keyword1" id="More_CC-responses_exception_ℐ"><span class="command">lemma</span></span> responses_exception_ℐ <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"responses_ℐ <span class="main">(</span>exception_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="keyword1">then</span> insert Fault <span class="main">(</span>OK <span class="main">`</span> responses_ℐ <span class="free">ℐ</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exception_ℐ_def image_image<span class="main">)</span>

<span class="keyword1" id="More_CC-map_ℐ_full"><span class="command">lemma</span></span> map_ℐ_full <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_ℐ <span class="free">f</span> <span class="free">g</span> ℐ_full <span class="main">=</span> ℐ_uniform UNIV <span class="main">(</span>range <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ℐ_uniform_UNIV<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> map_ℐ_ℐ_uniform <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="More_CC-exception_ℐ_full"><span class="command">lemma</span></span> exception_ℐ_full <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ ℐ_full <span class="main">=</span> ℐ_full"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exception_ℐ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="More_CC-exception_ℐ_uniform"><span class="command">lemma</span></span> exception_ℐ_uniform <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span>ℐ_uniform <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">⊥</span> <span class="keyword1">else</span> ℐ_uniform <span class="free">A</span> <span class="main">(</span>insert Fault <span class="main">(</span>OK <span class="main">`</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exception_ℐ_def image_image<span class="main">)</span>

<span class="keyword1" id="More_CC-option_of_exception_ℐ"><span class="command">lemma</span></span> option_of_exception_ℐ <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_ℐ id option_of_exception <span class="main">(</span>exception_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">=</span> stop_ℐ <span class="free">ℐ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exception_ℐ_def o_def id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="More_CC-exception_of_option_ℐ"><span class="command">lemma</span></span> exception_of_option_ℐ <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_ℐ id exception_of_option <span class="main">(</span>stop_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">=</span> exception_ℐ <span class="free">ℐ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exception_ℐ_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹inline›</span></span>

<span class="keyword1"><span class="command">context</span></span> raw_converter_invariant <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gpv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'call</span><span class="main">,</span> <span class="tfree">'ret</span><span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gpv<span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="More_CC-lossless_spmf_inline1"><span class="command">lemma</span></span> lossless_spmf_inline1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lossless<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> lossless_spmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>inline1 <span class="free">callee</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> expectation_gpv <span class="main">0</span> <span class="free">ℐ</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="free">gpv</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gpv <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pgen_lossless_gpv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> weight_spmf <span class="main">(</span>inline1 <span class="free">callee</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gpv<span class="main">(</span>2<span class="main">)</span> I
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> expectation_gpv_fixp_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">expectation_gpv'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">out</span> <span class="skolem">c</span>
      <span class="keyword3"><span class="command">assume</span></span> IO<span class="main">:</span> <span class="quoted"><span class="quoted">"IO <span class="skolem">out</span> <span class="skolem">c</span> <span class="main">∈</span> set_spmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> step.prems <span class="keyword1"><span class="command">have</span></span> out<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">out</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> out<span class="main">[</span><span class="operator">unfolded</span> in_outs_ℐ_iff_responses_ℐ<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">input</span></span> <span class="keyword2"><span class="keyword">where</span></span> input<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">input</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="skolem">out</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> out <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨅</span><span class="bound">r</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ</span> <span class="skolem">out</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">r</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ</span> <span class="skolem">out</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>measure_spmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lossless <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless_spmf_def measure_spmf.emeasure_eq_measure<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">generat</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">generat</span> <span class="keyword1">of</span> Pure <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> weight_spmf <span class="main">(</span>inline1 <span class="free">callee</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span> <span class="main">∂</span>measure_spmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> nn_integral_mono_AE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> Pure
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> INF_lower2<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> results_callee<span class="main"><span class="main">[</span></span><span class="operator">OF</span> out <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">s</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> results_gpv.Pure<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> step.IH<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_gpvD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.prems<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> IO<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> results_callee<span class="main"><span class="main">[</span></span><span class="operator">OF</span> out <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">s</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> results_gpv.Pure<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> results_callee<span class="main"><span class="main">[</span></span><span class="operator">OF</span> out <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">s</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> results_gpv.Pure<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> IO
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> INF_lower2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> input<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> step.hyps<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> expectation_gpv_const_le<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_gpvD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> IO<span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨅</span><span class="bound">r</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ</span> <span class="skolem">out</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.prems
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> inline1.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_spmf.emeasure_eq_measure<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_spmf_bind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> emeasure_bind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> N<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"count_space UNIV"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_measure_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> nn_integral_mono_AE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_spmf_return_spmf space_measure_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_spmf_bind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> emeasure_bind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> N<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"count_space UNIV"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_measure_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_spmf.emeasure_eq_measure<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> generat.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> measure <span class="main">(</span>measure_spmf <span class="bound">x</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def measure_spmf_return_spmf space_measure_spmf measure_return <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> generat.case_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> weight_spmf_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inline1 <span class="free">callee</span> <span class="free">gpv</span> <span class="free">s</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless_spmf_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> raw_converter_invariant<span class="main">)</span> inline1_try_gpv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">inline1'</span> <span class="main">≡</span> inline1"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite<span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_gpv <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> colossless_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_spmf <span class="main">(</span>map_sum <span class="free">f</span> id<span class="main">)</span> <span class="main">(</span>inline1 <span class="free">callee</span> <span class="main">(</span>try_gpv <span class="free">gpv</span> <span class="main">(</span>Done <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
   try_spmf <span class="main">(</span>map_spmf <span class="main">(</span>map_sum <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">input</span><span class="main">.</span> try_gpv <span class="main">(</span><span class="bound">rpv</span> <span class="bound">input</span><span class="main">)</span> <span class="main">(</span>Done <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">inline1'</span> <span class="free">callee</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inl <span class="free">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"ord_spmf <span class="main">(=)</span> <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> WT I
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inline1_fixp_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">inline1''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.prems <span class="keyword1"><span class="command">unfolding</span></span> inline1'_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> inline1.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf map_bind_spmf o_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> try_spmf_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_spmf_pmf_assoc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_pmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> bind_spmf_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_assoc_pmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_pmf_bindI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pmf.rel_refl_strong<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def bind_return_pmf f <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split generat.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> out c
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> bind_map_pmf map_bind_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">return_pmf</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> map_pmf_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def map_bind_pmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_pmf_bindI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pmf.rel_refl_strong<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> bind_map_pmf map_bind_spmf eq_onp_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split generat.split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> spmf.leq_trans<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> inline1'_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> results_callee<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ results_gpv.Pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span> WT_gpvD<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> results_callee<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ results_gpv.Pure<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span> WT_gpvD<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> try_spmf_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">return_pmf</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> map_pmf_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="var">?lhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> lossless_spmf_inline1<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> plossless_gpv_try_gpvI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pfinite<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_gpv_try_gpvI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> colossless_gpv_lossless_spmfD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lossless<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> ord_spmf_lossless_spmfD1<span class="main">[</span><span class="operator">OF</span> le this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
                        
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> raw_converter_invariant<span class="main">)</span> inline_try_gpv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite<span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_gpv <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> colossless_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">(=)</span> <span class="free">ℐ'</span> <span class="main">(</span>map_gpv <span class="free">f</span> id <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span>try_gpv <span class="free">gpv</span> <span class="main">(</span>Done <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>try_gpv <span class="main">(</span>map_gpv <span class="free">f</span> id <span class="main">(</span>inline <span class="free">callee</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Done <span class="free">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">_</span> <span class="main">_</span> <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> WT pfinite I
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_coinduct_bind<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eq_ℐ_gpv <span class="skolem">gpv</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?case</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">(</span><span class="tfree">'ret</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> option<span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">(</span><span class="tfree">'ret</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> option<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>eq_ℐ_generat <span class="main">_</span> <span class="main">_</span> <span class="var">?X</span><span class="main">)</span> <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> map_spmf
           <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">rs</span> <span class="main">⇒</span> Pure <span class="bound">rs</span> <span class="main">|</span> Inr <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">oracle</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">)</span> <span class="main">⇒</span> IO <span class="bound">out</span> <span class="main">(</span><span class="main">λ</span><span class="bound">input</span><span class="main">.</span> 
               map_gpv <span class="free">f</span> id <span class="main">(</span>bind_gpv <span class="main">(</span>try_gpv <span class="main">(</span>map_gpv Some id <span class="main">(</span><span class="bound">oracle</span> <span class="bound">input</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Done None<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xy</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xy</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> inline <span class="free">callee</span> <span class="main">(</span><span class="bound">rpv</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>map_spmf <span class="main">(</span>map_sum <span class="free">f</span> id<span class="main">)</span> <span class="main">(</span>inline1 <span class="free">callee</span> <span class="main">(</span><span class="keyword1">TRY</span> <span class="skolem">gpv</span> <span class="keyword1">ELSE</span> Done <span class="free">x</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> map_spmf <span class="var">?f</span> <span class="var">?lhs2</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel inline_sel spmf.map_comp o_def bind_gpv_try_gpv_map_Some <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> eq_ℐ_gpv
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs2</span> <span class="main">=</span> <span class="keyword1">TRY</span> map_spmf <span class="main">(</span>map_sum <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">input</span><span class="main">.</span> <span class="keyword1">TRY</span> <span class="bound">rpv</span> <span class="bound">input</span> <span class="keyword1">ELSE</span> Done <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inline1 <span class="free">callee</span> <span class="skolem">gpv</span> <span class="skolem">s</span><span class="main">)</span> <span class="keyword1">ELSE</span> return_spmf <span class="main">(</span>Inl <span class="free">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> inline1_try_gpv<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> f lossless<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">y</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Inl <span class="free">z</span> <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> map_sum <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">input</span><span class="main">.</span> try_gpv <span class="main">(</span><span class="bound">rpv</span> <span class="bound">input</span><span class="main">)</span> <span class="main">(</span>Done <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x'</span><span class="main">)</span> 
        <span class="main">(</span>try_spmf <span class="main">(</span>map_spmf Some <span class="main">(</span>inline1 <span class="free">callee</span> <span class="skolem">gpv</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf None<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?lhs3</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_try_spmf spmf.map_comp o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">y</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Pure <span class="free">z</span> <span class="main">|</span> Some <span class="main">(</span>Inl <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> Pure <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>
           <span class="main">|</span> Some <span class="main">(</span>Inr <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">oracle</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> IO <span class="bound">out</span> <span class="main">(</span><span class="main">λ</span><span class="bound">input</span><span class="main">.</span> try_gpv <span class="main">(</span>map_gpv <span class="free">f</span> id <span class="main">(</span>bind_gpv <span class="main">(</span><span class="bound">oracle</span> <span class="bound">input</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> inline <span class="free">callee</span> <span class="main">(</span><span class="bound">rpv</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Done <span class="free">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>try_spmf <span class="main">(</span>map_spmf Some <span class="main">(</span>inline1 <span class="free">callee</span> <span class="skolem">gpv</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf None<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel inline_sel spmf.map_comp o_def generat.map_comp spmf_rel_map map_try_spmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> try_spmf_cong map_spmf_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>eq_ℐ_generat <span class="main">(=)</span> <span class="free">ℐ'</span> <span class="var">?X</span><span class="main">)</span> <span class="main">(</span>map_spmf <span class="var">?f</span> <span class="var">?lhs3</span><span class="main">)</span> <span class="main">…</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel inline_sel spmf.map_comp o_def generat.map_comp spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split sum.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_gpv_id_bind_gpv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> try_gpv_bind_gpv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> WT_gpv_inline1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eq_ℐ_gpv<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> strip<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> out rpv rpv' input
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="keyword1">TRY</span> map_gpv Some id <span class="main">(</span><span class="skolem">rpv</span> <span class="skolem">input</span><span class="main">)</span> <span class="keyword1">ELSE</span> Done None<span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI conjI refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_gpv_reflI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> WT_gpv_inline1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eq_ℐ_gpv<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI conjI refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> WT_gpv_inline1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eq_ℐ_gpv<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> WT_gpv_inline1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eq_ℐ_gpv<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> inline1_in_sub_gpvs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ eq_ℐ_gpv<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> pfinite_gpv_sub_gpvs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq_ℐ_gpv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ eq_ℐ_gpv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI conjI refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> WT_gpv_inline1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eq_ℐ_gpv<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> WT_gpv_inline1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eq_ℐ_gpv<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> inline1_in_sub_gpvs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ eq_ℐ_gpv<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> pfinite_gpv_sub_gpvs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq_ℐ_gpv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ eq_ℐ_gpv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> notE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> inline1_in_sub_gpvs_callee<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eq_ℐ_gpv<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bspec<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> colossless_gpv_sub_gpvs<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> lossless<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cr_prod2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'c</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cr_prod2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">b</span> <span class="bound">c</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="More_CC-cr_prod2_simps"><span class="command">lemma</span></span> cr_prod2_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cr_prod2 <span class="free">x</span> <span class="free">A</span> <span class="free">a</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">A</span> <span class="free">a</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cr_prod2_def<span class="main">)</span>

<span class="keyword1" id="More_CC-cr_prod2I"><span class="command">lemma</span></span> cr_prod2I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> cr_prod2 <span class="free">x</span> <span class="free">A</span> <span class="free">a</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="More_CC-cr_prod2_Grp"><span class="command">lemma</span></span> cr_prod2_Grp<span class="main">:</span> <span class="quoted"><span class="quoted">"cr_prod2 <span class="free">x</span> <span class="main">(</span>BNF_Def.Grp <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> BNF_Def.Grp <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">f</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_def fun_eq_iff<span class="main">)</span>

<span class="comment1">(* A stronger version of the existing extend_state_oracle_transfer *)</span>
<span class="keyword1" id="More_CC-extend_state_oracle_transfer'"><span class="command">lemma</span></span> extend_state_oracle_transfer'<span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">C</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">R</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> cr_prod2 <span class="free">s</span> <span class="free">S</span> <span class="main">===&gt;</span> <span class="free">C</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">R</span> <span class="main">(</span>cr_prod2 <span class="free">s</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">oracle</span><span class="main">.</span> <span class="bound">oracle</span><span class="main">)</span> extend_state_oracle"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> extend_state_oracle_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rel_funD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map split_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_funD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_spmf_mono<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* @Reza: This is a proof based on parametricity,
 using the relation cr_prod2 s (=) to fix the first component of the extended callee state to s *)</span>

<span class="keyword1" id="More_CC-exec_gpv_extend_state_oracle"><span class="command">lemma</span></span> exec_gpv_extend_state_oracle<span class="main">:</span>
  <span class="quoted"><span class="quoted">"exec_gpv <span class="main">(</span>extend_state_oracle <span class="free">callee</span><span class="main">)</span> <span class="free">gpv</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span>
  map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s''</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="bound">s''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>exec_gpv <span class="free">callee</span> <span class="free">gpv</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exec_gpv_parametric'<span class="main">[</span><span class="operator">THEN</span> rel_funD<span class="main">,</span> <span class="operator">OF</span> extend_state_oracle_transfer'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="quoted"><span class="free">callee</span></span> <span class="quoted"><span class="free">callee</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">relator_eq</span></span> rel_gpv''_eq
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> eq_alt cr_prod2_Grp prod.rel_Grp option.rel_Grp pmf.rel_Grp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_def map_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>





<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Material for Constructive Crypto›</span></span>

<span class="keyword1" id="More_CC-WT_resource_ℐ_uniform_UNIV"><span class="command">lemma</span></span> WT_resource_ℐ_uniform_UNIV <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="free">A</span> UNIV <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-WT_converter_of_callee_invar"><span class="command">lemma</span></span> WT_converter_of_callee_invar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ℐ'</span> <span class="keyword1">⊢g</span> <span class="free">callee</span> <span class="bound">s</span> <span class="bound">q</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">q</span> <span class="bound">r</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span><span class="main">;</span> <span class="bound">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span>  <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">q</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> converter_of_callee <span class="free">callee</span> <span class="free">s</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WT res<span class="main">)</span>

<span class="keyword1" id="More_CC-eq_ℐ_gpv_eq_OO"><span class="command">lemma</span></span> eq_ℐ_gpv_eq_OO<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">(=)</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv'</span> <span class="free">gpv''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv''</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eq_ℐ_gpv_relcompp<span class="main">[</span><span class="operator">THEN</span> fun_cong<span class="main">,</span> <span class="operator">THEN</span> fun_cong<span class="main">,</span> <span class="operator">THEN</span> iffD2<span class="main">,</span> <span class="operator">OF</span> relcomppI<span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_OO<span class="main">)</span>

<span class="keyword1" id="More_CC-eq_ℐ_gpv_eq_OO2"><span class="command">lemma</span></span> eq_ℐ_gpv_eq_OO2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">(=)</span> <span class="free">ℐ</span> <span class="free">gpv''</span> <span class="free">gpv'</span>"</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv''</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eq_ℐ_gpv_relcompp<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"conversep <span class="main">(=)</span>"</span></span><span class="main">,</span> <span class="operator">THEN</span> fun_cong<span class="main">,</span> <span class="operator">THEN</span> fun_cong<span class="main">,</span> <span class="operator">THEN</span> iffD2<span class="main">,</span> <span class="operator">OF</span> relcomppI<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> eq_ℐ_gpv_conversep <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> OO_eq<span class="main">)</span>

<span class="keyword1" id="More_CC-eq_ℐ_gpv_try_gpv_cong"><span class="command">lemma</span></span> eq_ℐ_gpv_try_gpv_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv1</span> <span class="free">gpv1'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv2</span> <span class="free">gpv2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span>try_gpv <span class="free">gpv1</span> <span class="free">gpv2</span><span class="main">)</span> <span class="main">(</span>try_gpv <span class="free">gpv1'</span> <span class="free">gpv2'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv1</span></span> <span class="quoted"><span class="free">gpv1'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_try_spmf <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpvD <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_mono_strong eq_ℐ_generat.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-eq_ℐ_gpv_map_gpv'"><span class="command">lemma</span></span> eq_ℐ_gpv_map_gpv'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">(</span>BNF_Def.vimage2p <span class="free">f</span> <span class="free">f'</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>map_ℐ <span class="free">g</span> <span class="free">h</span> <span class="free">ℐ</span><span class="main">)</span> <span class="free">gpv1</span> <span class="free">gpv2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span>map_gpv' <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">gpv1</span><span class="main">)</span> <span class="main">(</span>map_gpv' <span class="free">f'</span> <span class="free">g</span> <span class="free">h</span> <span class="free">gpv2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv1</span></span> <span class="quoted"><span class="free">gpv2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> eq_ℐ_gpv
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">THEN</span> eq_ℐ_gpvD<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_spmf_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> BNF_Def.vimage2p_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_generat.cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-eq_ℐ_converter_map_converter"><span class="command">lemma</span></span> eq_ℐ_converter_map_converter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map_ℐ <span class="main">(</span>inv_into UNIV <span class="free">f</span><span class="main">)</span> <span class="main">(</span>inv_into UNIV <span class="free">g</span><span class="main">)</span> <span class="free">ℐ</span><span class="main">,</span> map_ℐ <span class="free">f'</span> <span class="free">g'</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">∼</span> <span class="free">conv2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"surj <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">conv1</span> <span class="main">∼</span> map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">conv2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> eq_ℐ_converter
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">q</span> <span class="main">∈</span> outs_ℐ <span class="main">(</span>map_ℐ <span class="main">(</span>inv_into UNIV <span class="free">f</span><span class="main">)</span> <span class="main">(</span>inv_into UNIV <span class="free">g</span><span class="main">)</span> <span class="free">ℐ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> eq_ℐ_converter<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> eq_ℐ_converterD<span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_gpv_map_gpv'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> BNF_Def.vimage2p_def prod.rel_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> eq_ℐ_gpv_mono'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def surj_f_inv_f<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-resource_of_oracle_run_resource"><span class="command">lemma</span></span> resource_of_oracle_run_resource<span class="main">:</span> <span class="quoted"><span class="quoted">"resource_of_oracle run_resource <span class="free">res</span> <span class="main">=</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>

<span class="keyword1" id="More_CC-connect_map_gpv'"><span class="command">lemma</span></span> connect_map_gpv'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"connect <span class="main">(</span>map_gpv' <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">adv</span><span class="main">)</span> <span class="free">res</span> <span class="main">=</span> map_spmf <span class="free">f</span> <span class="main">(</span>connect <span class="free">adv</span> <span class="main">(</span>map_resource <span class="free">g</span> <span class="free">h</span> <span class="free">res</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> connect_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> resource_of_oracle_run_resource<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exec_gpv_map_gpv' map_resource_resource_of_oracle spmf.map_comp exec_gpv_resource_of_oracle<span class="main">)</span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">fail_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_resource <span class="free">fail_resource</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return_pmf None<span class="main">)</span>"</span></span>

<span class="keyword1" id="More_CC-WT_fail_resource"><span class="command">lemma</span></span> WT_fail_resource <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> fail_resource <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_resourceI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">const_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_resource <span class="free">const_resource</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> map_spmf <span class="main">(</span>map_prod id <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">const_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="More_CC-const_resource_sel"><span class="command">lemma</span></span> const_resource_sel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"run_resource <span class="main">(</span>const_resource <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return_spmf <span class="main">(</span><span class="free">y</span><span class="main">,</span> const_resource <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> const_resource.sel <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="More_CC-lossless_const_resource"><span class="command">lemma</span></span> lossless_const_resource <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_resource <span class="free">ℐ</span> <span class="main">(</span>const_resource <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="More_CC-WT_const_resource"><span class="command">lemma</span></span> WT_const_resource <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> const_resource <span class="free">y</span> <span class="main">√</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>outs_ℐ <span class="free">ℐ</span><span class="main">.</span> <span class="free">y</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> iffI ballI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> WT_resourceD<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">const_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_converter <span class="free">const_converter</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> map_gpv <span class="main">(</span>map_prod id <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">const_converter</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>Done <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="More_CC-const_converter_sel"><span class="command">lemma</span></span> const_converter_sel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span>const_converter <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Done <span class="main">(</span><span class="free">y</span><span class="main">,</span> const_converter <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="More_CC-attach_const_converter"><span class="command">lemma</span></span> attach_const_converter <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"attach <span class="main">(</span>const_converter <span class="free">y</span><span class="main">)</span> <span class="free">res</span> <span class="main">=</span> const_resource <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> const_converter.sel <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="More_CC-comp_const_converter"><span class="command">lemma</span></span> comp_const_converter <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"comp_converter <span class="main">(</span>const_converter <span class="free">x</span><span class="main">)</span> <span class="free">conv</span> <span class="main">=</span> const_converter <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def<span class="main">)</span>

<span class="keyword1" id="More_CC-interaction_bounded_const_converter"><span class="command">lemma</span></span> interaction_bounded_const_converter <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">(</span>const_converter Fault<span class="main">)</span> <span class="free">bound</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">merge_exception_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> exception<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> exception <span class="main">+</span> <span class="tfree">'c</span> exception<span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_converter <span class="free">merge_exception_converter</span> <span class="main">=</span> 
   <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_gpv <span class="main">(</span>map_prod id <span class="main">(</span><span class="main">λ</span><span class="bound">conv</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">conv</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">merge_exception_converter</span> <span class="main">|</span> Some <span class="bound">conv'</span> <span class="main">⇒</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>
     Pause <span class="bound">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> Done <span class="main">(</span><span class="keyword1">case</span> merge_exception <span class="bound">y</span> <span class="keyword1">of</span> Fault <span class="main">⇒</span> <span class="main">(</span>Fault<span class="main">,</span> Some <span class="main">(</span>const_converter Fault<span class="main">)</span><span class="main">)</span>
                              <span class="main">|</span> OK <span class="bound">y'</span> <span class="main">⇒</span> <span class="main">(</span>OK <span class="bound">y'</span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="More_CC-merge_exception_converter_sel"><span class="command">lemma</span></span> merge_exception_converter_sel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_converter merge_exception_converter <span class="free">x</span> <span class="main">=</span>
   Pause <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> Done <span class="main">(</span><span class="keyword1">case</span> merge_exception <span class="bound">y</span> <span class="keyword1">of</span> Fault <span class="main">⇒</span> <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span> <span class="main">|</span> OK <span class="bound">y'</span> <span class="main">⇒</span> <span class="main">(</span>OK <span class="bound">y'</span><span class="main">,</span> merge_exception_converter<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def fun_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> exception.split<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> merge_exception_converter.sel<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="More_CC-plossless_const_converter"><span class="command">lemma</span></span> plossless_const_converter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="main">(</span>const_converter <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-plossless_merge_exception_converter"><span class="command">lemma</span></span> plossless_merge_exception_converter <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"plossless_converter <span class="main">(</span>exception_ℐ <span class="main">(</span><span class="free">ℐ</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>exception_ℐ <span class="free">ℐ</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> exception_ℐ <span class="free">ℐ'</span><span class="main">)</span> merge_exception_converter"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-WT_const_converter"><span class="command">lemma</span></span> WT_const_converter <span class="main">[</span><span class="operator">WT_intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> const_converter <span class="free">x</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>

<span class="keyword1" id="More_CC-WT_merge_exception_converter"><span class="command">lemma</span></span> WT_merge_exception_converter <span class="main">[</span><span class="operator">WT_intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="free">ℐ1'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2'</span><span class="main">)</span><span class="main">,</span> exception_ℐ <span class="free">ℐ1'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> exception_ℐ <span class="free">ℐ2'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> merge_exception_converter <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-inline_left_gpv_merge_exception_converter"><span class="command">lemma</span></span> inline_left_gpv_merge_exception_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bind_gpv <span class="main">(</span>inline run_converter <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span>left_gpv <span class="free">gpv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> merge_exception_converter<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> Done <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   bind_gpv <span class="main">(</span>left_gpv <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> Done <span class="main">(</span><span class="bound">x</span><span class="main">,</span> merge_exception_converter<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gpv.coinduct_strong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_gpv.sel inline_sel map_bind_spmf bind_map_spmf <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_gpv_sel'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> inline1_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_bind_reflI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generat.map_comp case_map_generat o_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> gpv out c input <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">input</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exception.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-inline_right_gpv_merge_exception_converter"><span class="command">lemma</span></span> inline_right_gpv_merge_exception_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bind_gpv <span class="main">(</span>inline run_converter <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span>right_gpv <span class="free">gpv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> merge_exception_converter<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> Done <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   bind_gpv <span class="main">(</span>right_gpv <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> Done <span class="main">(</span><span class="bound">x</span><span class="main">,</span> merge_exception_converter<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gpv.coinduct_strong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_gpv.sel inline_sel map_bind_spmf bind_map_spmf <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_gpv_sel'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> inline1_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_bind_reflI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generat.map_comp case_map_generat o_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> gpv out c input <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">input</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exception.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="../Constructive_Cryptography/Wiring.html"></a><a href="../Constructive_Cryptography/Wiring.html">Constructive_Cryptography.Wiring</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> 
  <span class="entity">id_wiring</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> wiring"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>w</sub></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">id_wiring</span> <span class="main">≡</span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">swap_lassocr<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> wiring"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">swap_lassocr<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">≡</span> rassocl<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span><span class="main">(</span>swap<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>w</sub></span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> lassocr<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  wiring_swap_lassocr<span class="main">[</span><span class="operator">wiring_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wiring <span class="var">?ℐ1</span> <span class="var">?ℐ2</span> swap_lassocr swap_lassocr<span class="hidden">⇩</span><sub>w</sub>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> swap_lassocr_def swap_lassocr<span class="hidden">⇩</span><sub>w</sub>_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wiring_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">parallel_wiring<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'g</span> <span class="main">+</span> <span class="tfree">'h</span><span class="main">)</span><span class="main">,</span>
   <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'g</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'f</span> <span class="main">+</span> <span class="tfree">'h</span><span class="main">)</span><span class="main">)</span> wiring"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">parallel_wiring<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">≡</span> lassocr<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> swap_lassocr<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> rassocl<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  wiring_parallel_wiring<span class="main">[</span><span class="operator">wiring_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wiring <span class="var">?ℐ1</span> <span class="var">?ℐ2</span> parallel_wiring parallel_wiring<span class="hidden">⇩</span><sub>w</sub>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> parallel_wiring_def parallel_wiring<span class="hidden">⇩</span><sub>w</sub>_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wiring_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1" id="More_CC-lassocr_inverse"><span class="command">lemma</span></span> lassocr_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rassocl<span class="hidden">⇩</span><sub>C</sub>_def lassocr<span class="hidden">⇩</span><sub>C</sub>_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_map1_out comp_converter_map_converter2 comp_converter_id_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> map_converter_id_move_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-rassocl_inverse"><span class="command">lemma</span></span> rassocl_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rassocl<span class="hidden">⇩</span><sub>C</sub>_def lassocr<span class="hidden">⇩</span><sub>C</sub>_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_map1_out comp_converter_map_converter2 comp_converter_id_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> map_converter_id_move_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-swap_sum_swap_sum"><span class="command">lemma</span></span> swap_sum_swap_sum <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"swap_sum <span class="main">(</span>swap_sum <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="More_CC-inj_on_lsumr"><span class="command">lemma</span></span> inj_on_lsumr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on lsumr <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lsumr.elims<span class="main">)</span>

<span class="keyword1" id="More_CC-inj_on_rsuml"><span class="command">lemma</span></span> inj_on_rsuml <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on rsuml <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rsuml.elims<span class="main">)</span>

<span class="keyword1" id="More_CC-bij_lsumr"><span class="command">lemma</span></span> bij_lsumr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bij lsumr"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> o_bij<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">rsuml</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-bij_swap_sum"><span class="command">lemma</span></span> bij_swap_sum <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bij swap_sum"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> o_bij<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">swap_sum</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-bij_rsuml"><span class="command">lemma</span></span> bij_rsuml <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bij rsuml"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> o_bij<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">lsumr</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-bij_lassocr_swap_sum"><span class="command">lemma</span></span> bij_lassocr_swap_sum <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bij lassocr_swap_sum"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lassocr_swap_sum_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_comp<span class="main">)</span>

<span class="keyword1" id="More_CC-inj_lassocr_swap_sum"><span class="command">lemma</span></span> inj_lassocr_swap_sum <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj lassocr_swap_sum"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_is_inj<span class="main">)</span>

<span class="keyword1" id="More_CC-inv_rsuml"><span class="command">lemma</span></span> inv_rsuml <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_into UNIV rsuml <span class="main">=</span> lsumr"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> inj_imp_inv_eq<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-inv_lsumr"><span class="command">lemma</span></span> inv_lsumr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_into UNIV lsumr <span class="main">=</span> rsuml"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> inj_imp_inv_eq<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-lassocr_swap_sum_inverse"><span class="command">lemma</span></span> lassocr_swap_sum_inverse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lassocr_swap_sum <span class="main">(</span>lassocr_swap_sum <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lassocr_swap_sum_def sum.map_comp o_def id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sum.map_id<span class="main">)</span>

<span class="keyword1" id="More_CC-inv_lassocr_swap_sum"><span class="command">lemma</span></span> inv_lassocr_swap_sum <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_into UNIV lassocr_swap_sum <span class="main">=</span> lassocr_swap_sum"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> inj_imp_inv_eq<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.map_comp sum.inj_map bij_def surj_iff sum.map_id<span class="main">)</span>

<span class="keyword1" id="More_CC-swap_inverse"><span class="command">lemma</span></span> swap_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> swap<span class="hidden">⇩</span><sub>C</sub>_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_map1_out comp_converter_map_converter2 comp_converter_id_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> map_converter_id_move_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="More_CC-swap_lassocr_inverse"><span class="command">lemma</span></span> swap_lassocr_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">,</span> <span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> swap_lassocr <span class="main">⊙</span> swap_lassocr <span class="main">∼</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ</span><span class="main">,</span><span class="main">_</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?lhs</span> <span class="main">∼</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span>rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span>swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊙</span> <span class="main">(</span>lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span> <span class="main">⊙</span> <span class="main">(</span><span class="main">(</span>swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap_lassocr_def comp_converter_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span><span class="main">(</span>swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> swap<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rassocl_inverse comp_converter_id_left
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_converter2_comp1_out comp_converter_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ</span><span class="main">,</span><span class="var">?ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">…</span> <span class="main">∼</span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> swap_inverse
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI eq_ℐ_comp_cong <span class="dynamic"><span class="dynamic">WT_intro</span></span> parallel_converter2_id_id<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_id_left lassocr_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-parallel_wiring_inverse"><span class="command">lemma</span></span> parallel_wiring_inverse<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ3</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ4</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ3</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ4</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> parallel_wiring <span class="main">⊙</span> parallel_wiring <span class="main">∼</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ</span><span class="main">,</span> <span class="main">_</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?lhs</span> <span class="main">∼</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span>lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> swap_lassocr<span class="main">)</span><span class="main">)</span> <span class="main">⊙</span> <span class="main">(</span>rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span> <span class="main">⊙</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> swap_lassocr<span class="main">)</span> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_wiring_def comp_converter_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> swap_lassocr<span class="main">)</span><span class="main">)</span> <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> swap_lassocr<span class="main">)</span> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lassocr_inverse comp_converter_id_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span>swap_lassocr <span class="main">⊙</span> swap_lassocr<span class="main">)</span><span class="main">)</span> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_converter2_comp2_out comp_converter_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ</span><span class="main">,</span><span class="var">?ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">…</span> <span class="main">∼</span> lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI eq_ℐ_comp_cong parallel_converter2_eq_ℐ_cong <span class="dynamic"><span class="dynamic">WT_intro</span></span> swap_lassocr_inverse<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ</span><span class="main">,</span><span class="var">?ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">∼</span> lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI eq_ℐ_comp_cong parallel_converter2_id_id <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_id_left rassocl_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹ Analogous to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">‹attach_wiring›</span><span class="antiquote">}</span></span> in Wiring.thy›</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">attach_wiring_right</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> wiring <span class="main">⇒</span> 
      <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> gpv<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> gpv<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">attach_wiring_right</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">.</span> map_fun id <span class="main">(</span>map_fun id <span class="main">(</span>map_gpv' id <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="More_CC-attach_wiring_right_simps"><span class="command">lemma</span></span> 
  attach_wiring_right_simps<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"attach_wiring_right <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> map_fun id <span class="main">(</span>map_fun id <span class="main">(</span>map_gpv' id <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_wiring_right_def<span class="main">)</span>

<span class="keyword1" id="More_CC-comp_converter_of_callee_wiring"><span class="command">lemma</span></span> 
  comp_converter_of_callee_wiring<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wiring<span class="main">:</span> <span class="quoted"><span class="quoted">"wiring <span class="free">ℐ2</span> <span class="free">ℐ3</span> <span class="free">conv</span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span><span class="main">,</span> <span class="free">ℐ2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CNV <span class="free">callee</span> <span class="free">s</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span><span class="main">,</span> <span class="free">ℐ3</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CNV <span class="free">callee</span> <span class="free">s</span> <span class="main">⊙</span> <span class="free">conv</span> <span class="main">∼</span> CNV <span class="main">(</span>attach_wiring_right <span class="free">w</span> <span class="free">callee</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wiring
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wiring <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> _ wiring<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span><span class="main">,</span><span class="free">ℐ3</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CNV <span class="free">callee</span> <span class="free">s</span> <span class="main">⊙</span> <span class="free">conv</span> <span class="main">∼</span> CNV <span class="free">callee</span> <span class="free">s</span> <span class="main">⊙</span> map_converter id id <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"CNV <span class="free">callee</span> <span class="free">s</span> <span class="main">⊙</span> map_converter id id <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">=</span> map_converter id id <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">(</span>CNV <span class="free">callee</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> comp_converter_map_converter2<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_id_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> CNV <span class="main">(</span>attach_wiring_right <span class="free">w</span> <span class="free">callee</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_converter_of_callee attach_wiring_right_simps wiring<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.map_id0<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-attach_wiring_right_comp_wiring"><span class="command">lemma</span></span> attach_wiring_right_comp_wiring<span class="main">:</span>
  <span class="quoted"><span class="quoted">"attach_wiring_right <span class="main">(</span><span class="free">w1</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">w2</span><span class="main">)</span> <span class="free">callee</span> <span class="main">=</span> attach_wiring_right <span class="free">w2</span> <span class="main">(</span>attach_wiring_right <span class="free">w1</span> <span class="free">callee</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_wiring_right_def comp_wiring_def split_def map_fun_def o_def map_gpv'_comp id_def fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="More_CC-attach_wiring_comp_wiring"><span class="command">lemma</span></span> attach_wiring_comp_wiring<span class="main">:</span>
  <span class="quoted"><span class="quoted">"attach_wiring <span class="main">(</span><span class="free">w1</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">w2</span><span class="main">)</span> <span class="free">callee</span> <span class="main">=</span> attach_wiring <span class="free">w1</span> <span class="main">(</span>attach_wiring <span class="free">w2</span> <span class="free">callee</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> attach_wiring_def comp_wiring_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def map_fun_def o_def map_gpv_conv_map_gpv' map_gpv'_comp id_def map_prod_def<span class="main">)</span>




<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Probabilistic finite converter›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">pfinite_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ℐ</span> <span class="entity">ℐ'</span> <span class="keyword2"><span class="keyword">where</span></span>
  pfinite_converterI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pfinite_converter</span> <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟹</span> pfinite_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">conv'</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">pfinite_converter</span> <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv'</span>"</span></span>

<span class="keyword1" id="More_CC-pfinite_converter_coinduct"><span class="command">lemma</span></span> pfinite_converter_coinduct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> pfinite_converter<span class="main">,</span> <span class="operator">case_conclusion</span> pfinite_converter pfinite step<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> pfinite_converter<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">conv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">conv</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">X</span> <span class="bound">conv</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟧</span> <span class="main">⟹</span> pfinite_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="bound">conv</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="bound">conv</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="free">X</span> <span class="bound">conv'</span> <span class="main">∨</span> pfinite_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> pfinite_converter.coinduct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> step<span class="main">)</span>

<span class="keyword1" id="More_CC-pfinite_converterD"><span class="command">lemma</span></span> pfinite_converterD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> pfinite_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">conv</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> pfinite_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free">conv</span> <span class="free">a</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free">conv</span> <span class="free">a</span><span class="main">)</span><span class="main">.</span> pfinite_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> pfinite_converter.cases<span class="main">)</span>

<span class="keyword1" id="More_CC-pfinite_converter_bot1"><span class="command">lemma</span></span> pfinite_converter_bot1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter bot <span class="free">ℐ</span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> pfinite_converterI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-pfinite_converter_mono"><span class="command">lemma</span></span> pfinite_converter_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ1</span> <span class="free">ℐ2</span> <span class="free">conv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="free">ℐ1'</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐ1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ2</span> <span class="main">≤</span> <span class="free">ℐ2'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span><span class="main">,</span> <span class="free">ℐ2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ1'</span> <span class="free">ℐ2'</span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> * WT
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> pfinite_converterD<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> WT_converterD'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> le<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> responses_ℐ_mono<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pfinite_gpv_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ le<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> results_gpv_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bspec<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> raw_converter_invariant <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="More_CC-pfinite_converter_of_callee"><span class="command">lemma</span></span> pfinite_converter_of_callee<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> pfinite_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="main">(</span>converter_of_callee <span class="free">callee</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> I
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> results_callee<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="More_CC-raw_converter_invariant_run_pfinite_converter"><span class="command">lemma</span></span> raw_converter_invariant_run_pfinite_converter<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"raw_converter_invariant <span class="free">ℐ</span> <span class="free">ℐ'</span> run_converter <span class="main">(</span><span class="main">λ</span><span class="bound">conv</span><span class="main">.</span> pfinite_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv</span> <span class="main">∧</span> <span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="bound">conv</span> <span class="main">√</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD pfinite_converterD<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> run_pfinite_converter<span class="main">:</span> raw_converter_invariant
  <span class="quoted"><span class="free">ℐ</span></span> <span class="quoted"><span class="free">ℐ'</span></span> <span class="quoted">run_converter</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">conv</span><span class="main">.</span> pfinite_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv</span> <span class="main">∧</span> <span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="bound">conv</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ℐ</span> <span class="free">ℐ'</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> raw_converter_invariant_run_pfinite_converter<span class="main">)</span>

<span class="keyword1"><span class="command">named_theorems</span></span> pfinite_intro <span class="quoted">"Introduction rules for probabilistic finiteness"</span>

<span class="keyword1" id="More_CC-pfinite_id_converter"><span class="command">lemma</span></span> pfinite_id_converter <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ</span> <span class="free">ℐ</span> id_converter"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="More_CC-pfinite_fail_converter"><span class="command">lemma</span></span> pfinite_fail_converter <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> fail_converter"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">simp</span>

<span class="keyword1" id="More_CC-pfinite_parallel_converter2"><span class="command">lemma</span></span> pfinite_parallel_converter2 <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pfinite_converter <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ1'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2'</span><span class="main">)</span> <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ1</span> <span class="free">ℐ1'</span> <span class="free">conv1</span>"</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ2</span> <span class="free">ℐ2'</span> <span class="free">conv2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pfinite_converterD<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> raw_converter_invariant <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="More_CC-expectation_gpv_1_le_inline"><span class="command">lemma</span></span> expectation_gpv_1_le_inline<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">expectation_gpv2</span> <span class="main">≡</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> callee<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> pfinite_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_gpv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f_le_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expectation_gpv <span class="main">1</span> <span class="free">ℐ</span> <span class="free">f</span> <span class="free">gpv</span> <span class="main">≤</span> <span class="free">expectation_gpv2</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> WT_gpv I
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> expectation_gpv_fixp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">expectation_gpv'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Pure <span class="bound">a</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">|</span> IO <span class="bound">out</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="main">⨅</span><span class="bound">r</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ</span> <span class="bound">out</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="bound">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>measure_spmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">*</span> ennreal <span class="main">(</span>pmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span> None<span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> pmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Some <span class="main">(</span>Pure <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">|</span> Some <span class="main">(</span>IO <span class="bound">out</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">⨅</span><span class="bound">r</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ</span> <span class="bound">out</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="bound">c</span> <span class="bound">r</span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_measure_spmf_conv_measure_pmf nn_integral_restrict_space nn_integral_measure_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nn_integral_disjoint_pair_countspace<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"range Some"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span>None<span class="main">}</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> UNIV_option_conv<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> pmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="main">(</span>Pure <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">|</span> Some <span class="main">(</span>IO <span class="bound">out</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⇒</span> 
          <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="bound">out</span><span class="main">)</span> <span class="main">⤜</span> case_generat <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> inline1 <span class="free">callee</span> <span class="main">(</span><span class="bound">c</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">out</span> <span class="bound">rpv'</span><span class="main">.</span> return_spmf <span class="main">(</span>Inr <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">rpv'</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span>
            <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="main">(</span>Inl <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span>
             <span class="main">|</span> Some <span class="main">(</span>Inr <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">,</span> <span class="bound">rpv'</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">⨅</span><span class="bound">x</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ'</span> <span class="bound">r</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="bound">rpv'</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">rpv</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"nn_integral <span class="main">_</span> <span class="var">?lhs</span> <span class="main">≤</span> nn_integral <span class="main">_</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> nn_integral_mono<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'call</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'call</span><span class="main">,</span> <span class="tfree">'ret</span><span class="main">)</span> rpv<span class="main">)</span> generat option"</span></span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>None<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="main">|</span> <span class="main">(</span>Pure<span class="main">)</span> <span class="skolem">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>Pure <span class="skolem">a</span><span class="main">)</span>"</span></span> 
      <span class="main">|</span> <span class="main">(</span>IO<span class="main">)</span> <span class="skolem">out</span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>IO <span class="skolem">out</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"IO <span class="skolem">out</span> <span class="skolem">c</span> <span class="main">∈</span> set_spmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>outside<span class="main">)</span> <span class="skolem">out</span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>IO <span class="skolem">out</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"IO <span class="skolem">out</span> <span class="skolem">c</span> <span class="main">∉</span> set_spmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dest_IO.elims not_None_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="var">?rhs</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Pure <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IO <span class="skolem">out</span> <span class="skolem">c</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> step.prems <span class="keyword1"><span class="command">have</span></span> out<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">out</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">response</span></span> <span class="keyword2"><span class="keyword">where</span></span> resp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">response</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="skolem">out</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> in_outs_ℐ_iff_responses_ℐ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> out step.prems IO <span class="keyword1"><span class="command">have</span></span> WT_resp <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="skolem">c</span> <span class="skolem">response</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> exp_resp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="skolem">response</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="skolem">response</span>"</span></span><span class="main">]</span> expectation_gpv_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="free">ℐ</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="skolem">response</span>"</span></span><span class="main">]</span> expectation_gpv_const_le<span class="main">[</span><span class="operator">OF</span> WT_resp<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def f_le_1<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨅</span><span class="bound">r</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ</span> <span class="skolem">out</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">generat</span><span class="main">.</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">r</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ</span> <span class="skolem">out</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>measure_spmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
        <span class="main">(</span><span class="main">⨅</span><span class="bound">r</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ</span> <span class="skolem">out</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> ennreal <span class="main">(</span>weight_spmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_spmf.emeasure_eq_measure add_mult_distrib2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> semiring_class.distrib_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> add_diff_inverse_ennreal weight_spmf_le_1<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">generat</span><span class="main">.</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">r</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ</span> <span class="skolem">out</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>measure_spmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
        <span class="main">1</span> <span class="main">*</span> ennreal <span class="main">(</span>pmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pmf_None_eq_weight_spmf
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> add_mono mult_mono order_refl INF_lower2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> resp<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ennreal_minus<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> weight_spmf_le_1 exp_resp<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">z</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">z</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="bound">generat</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">⨅</span><span class="bound">r</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ</span> <span class="skolem">out</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_measure_spmf_conv_measure_pmf nn_integral_restrict_space nn_integral_measure_pmf <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> nn_integral_const<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nn_integral_disjoint_pair_countspace<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"range Some"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span>None<span class="main">}</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> UNIV_option_conv<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">z</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span>
         <span class="main">(</span><span class="keyword1">case</span> <span class="bound">z</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="main">(</span>IO <span class="bound">out'</span> <span class="bound">rpv'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">⨅</span><span class="bound">x</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ'</span> <span class="bound">out'</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">rpv'</span> <span class="bound">x</span><span class="main">)</span>
          <span class="main">|</span> Some <span class="main">(</span>Pure <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="main">(</span>inline1 <span class="free">callee</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="main">(</span>Inl <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">|</span> Some <span class="main">(</span>Inr <span class="main">(</span><span class="bound">out'</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">,</span> <span class="bound">rpv'</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
                  <span class="main">⨅</span><span class="bound">x</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ'</span> <span class="bound">out'</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="bound">rpv'</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">rpv</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"nn_integral <span class="main">_</span> <span class="var">?lhs2</span> <span class="main">≤</span> nn_integral <span class="main">_</span> <span class="var">?rhs2</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> nn_integral_mono<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ret</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'call'</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'ret</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'call'</span><span class="main">,</span> <span class="tfree">'ret'</span><span class="main">)</span> rpv<span class="main">)</span> generat option"</span></span>
        <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>None<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> None"</span></span> <span class="main">|</span> <span class="main">(</span>Pure<span class="main">)</span> <span class="skolem">x'</span> <span class="skolem">s'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> Some <span class="main">(</span>Pure <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Pure <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="main">|</span> <span class="main">(</span>IO'<span class="main">)</span> <span class="skolem">out'</span> <span class="skolem">c'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> Some <span class="main">(</span>IO <span class="skolem">out'</span> <span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"IO <span class="skolem">out'</span> <span class="skolem">c'</span> <span class="main">∈</span> set_spmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="main">|</span> <span class="main">(</span>outside<span class="main">)</span> <span class="skolem">generat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> Some <span class="skolem">generat</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">generat</span> <span class="main">∉</span> set_spmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dest_IO.elims not_Some_eq old.prod.exhaust<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs2</span> <span class="skolem">z</span> <span class="main">≤</span> <span class="var">?rhs2</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> Pure
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> results_gpv.Pure<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> results_callee step.prems out <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="skolem">out</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> IO out step.prems <span class="keyword1"><span class="command">have</span></span> WT_c <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="skolem">c</span> <span class="skolem">x'</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">INF</span> <span class="bound">r</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ</span> <span class="skolem">out</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> INF_lower<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">expectation_gpv2</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="skolem">c</span> <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> WT_c s' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> step.IH<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">xx</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">xx</span> <span class="keyword1">of</span> Inl <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">x</span> 
               <span class="main">|</span> Inr <span class="main">(</span><span class="bound">out'</span><span class="main">,</span> <span class="bound">callee'</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">INF</span> <span class="bound">r'</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ'</span> <span class="bound">out'</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="bound">rpv</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">callee'</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∂</span>measure_spmf <span class="main">(</span>inline1 <span class="free">callee</span> <span class="main">(</span><span class="skolem">c</span> <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">+</span> ennreal <span class="main">(</span>pmf <span class="main">(</span>the_gpv <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="skolem">c</span> <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> expectation_gpv2_def
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> expectation_gpv.simps<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inline_sel split_def o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> generat.split sum.split<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">xx</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="main">(</span>inline1 <span class="free">callee</span> <span class="main">(</span><span class="skolem">c</span> <span class="skolem">x'</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">)</span> <span class="bound">xx</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">xx</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="main">(</span>Inl <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">x</span> 
            <span class="main">|</span> Some <span class="main">(</span>Inr <span class="main">(</span><span class="bound">out'</span><span class="main">,</span> <span class="bound">callee'</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">INF</span> <span class="bound">r'</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ'</span> <span class="bound">out'</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="bound">rpv</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">callee'</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> inline_sel<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_measure_spmf_conv_measure_pmf nn_integral_restrict_space nn_integral_measure_pmf pmf_map_spmf_None <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> nn_integral_const<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nn_integral_disjoint_pair_countspace<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"range Some"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span>None<span class="main">}</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> UNIV_option_conv<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Pure <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> IO'
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> out'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">out'</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> WT_callee out step.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">INF</span> <span class="bound">r</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ</span> <span class="skolem">out</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> min <span class="main">(</span><span class="keyword1">INF</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="main">⋃</span><span class="bound">r'</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ'</span> <span class="skolem">out'</span><span class="main">.</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="skolem">c'</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> IO' results_callee<span class="main">[</span><span class="operator">OF</span> out<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> step.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> INF_mono min.boundedI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> results_gpv.IO <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> INF_lower2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> resp<span class="main"><span class="main">]</span></span> exp_resp<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">r'</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ'</span> <span class="skolem">out'</span><span class="main">.</span> min <span class="main">(</span><span class="keyword1">INF</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">∈</span>results_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="skolem">c'</span> <span class="bound">r'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> resp out' <span class="keyword1"><span class="command">unfolding</span></span> inf_min<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> in_outs_ℐ_iff_responses_ℐ
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> INF_inf_const2<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> INF_UNION<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">r'</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ'</span> <span class="skolem">out'</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r'</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c'</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">r'</span><span class="main">∈</span><span class="main">_</span><span class="main">.</span> <span class="var">?r</span> <span class="bound">r'</span><span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> INF_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> bexI<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span>
            <span class="keyword3"><span class="command">assume</span></span> r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ'</span> <span class="skolem">out'</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="skolem">c'</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> callee<span class="main">[</span><span class="operator">OF</span> out<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> IO' r' WT_callee<span class="main">[</span><span class="operator">OF</span> out<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> step.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pfinite_gpv_ContD<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="keyword1">INF</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">∈</span>results_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="skolem">c'</span> <span class="skolem">r'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span> <span class="main">≤</span> min <span class="main">(</span><span class="keyword1">INF</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">∈</span>results_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="skolem">c'</span> <span class="skolem">r'</span><span class="main">)</span><span class="main">.</span> <span class="free">expectation_gpv2</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> IO IO' step.prems out results_callee<span class="main">[</span><span class="operator">OF</span> out<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> r'
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> min.mono<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> INF_mono rev_bexI step.IH <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpv_ContD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> results_gpv.IO<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?r</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> expectation_gpv2_def <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> pfinite_INF_le_expectation_gpv<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="keyword1">INF</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">∈</span>results_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="skolem">c'</span> <span class="skolem">r'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">expectation_gpv'</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IO' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> outside <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_spmf_iff_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">z</span><span class="main">.</span> <span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span>
             ennreal <span class="main">(</span>pmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span>
             ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="keyword1">case</span> <span class="bound">z</span> <span class="keyword1">of</span> None <span class="main">⇒</span> return_pmf None <span class="main">|</span> Some <span class="main">(</span>Pure <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xb</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> inline1 <span class="free">callee</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">xb</span> <span class="main">|</span> Some <span class="main">(</span>IO <span class="bound">out</span> <span class="bound">rpv'</span><span class="main">)</span> <span class="main">⇒</span> return_spmf <span class="main">(</span>Inr <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">rpv'</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span>
             <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="main">(</span>Inl <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">|</span> Some <span class="main">(</span>Inr <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">,</span> <span class="bound">rpv'</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">⨅</span><span class="bound">x</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ'</span> <span class="bound">out</span><span class="main">.</span>
                expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="bound">rpv'</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">rpv</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">z</span><span class="main">.</span> <span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split generat.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc nn_integral_cmult ennreal_indicator<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">z</span><span class="main">.</span> <span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">z</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> nn_integral_fst_count_space<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"case_prod <span class="main">_</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_snd_count_space<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span>
              ennreal <span class="main">(</span>pmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="skolem">out</span><span class="main">)</span> <span class="main">⤜</span> case_generat <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> inline1 <span class="free">callee</span> <span class="main">(</span><span class="skolem">c</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">out</span> <span class="bound">rpv'</span><span class="main">.</span> return_spmf <span class="main">(</span>Inr <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">rpv'</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span>
              <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="main">(</span>Inl <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">|</span> Some <span class="main">(</span>Inr <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">,</span> <span class="bound">rpv'</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
                   <span class="main">⨅</span><span class="bound">x</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ'</span> <span class="bound">r</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="bound">rpv'</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">rpv</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def ennreal_pmf_bind nn_integral_multc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nn_integral_measure_pmf<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IO <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> outside <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_spmf_iff_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> <span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span>
         ennreal <span class="main">(</span>pmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span> <span class="main">*</span>
         ennreal <span class="main">(</span><span class="keyword1">case</span> <span class="bound">y</span> <span class="keyword1">of</span> None <span class="main">⇒</span> pmf <span class="main">(</span>return_pmf None<span class="main">)</span> <span class="bound">x</span> <span class="main">|</span> Some <span class="main">(</span>Pure <span class="bound">xa</span><span class="main">)</span> <span class="main">⇒</span> pmf <span class="main">(</span>return_spmf <span class="main">(</span>Inl <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>
                <span class="main">|</span> Some <span class="main">(</span>IO <span class="bound">out</span> <span class="bound">rpv</span><span class="main">)</span> <span class="main">⇒</span>
                    pmf <span class="main">(</span>bind_spmf <span class="main">(</span>the_gpv <span class="main">(</span><span class="free">callee</span> <span class="skolem">s</span> <span class="bound">out</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">generat'</span> <span class="main">⇒</span> <span class="keyword1">case</span> <span class="bound">generat'</span> <span class="keyword1">of</span> Pure <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> inline1 <span class="free">callee</span> <span class="main">(</span><span class="bound">rpv</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span> <span class="main">|</span> IO <span class="bound">out</span> <span class="bound">rpv'</span> <span class="main">⇒</span> return_spmf <span class="main">(</span>Inr <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">rpv'</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span>
         <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="main">(</span>Inl <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span> 
         <span class="main">|</span> Some <span class="main">(</span>Inr <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">,</span> <span class="bound">rpv'</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">⨅</span><span class="bound">x</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ'</span> <span class="bound">out</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="bound">rpv'</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">rpv</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> <span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split generat.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_cmult mult.assoc ennreal_indicator<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> <span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> nn_integral_fst_count_space<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"case_prod <span class="main">_</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_snd_count_space<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span>pmf <span class="main">(</span>inline1 <span class="free">callee</span> <span class="skolem">gpv</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Some <span class="main">(</span>Inl <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">|</span>
        Some <span class="main">(</span>Inr <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">,</span> <span class="bound">rpv'</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">⨅</span><span class="bound">x</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ'</span> <span class="bound">out</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="bound">rpv'</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">rpv</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="main"><span class="main"><span class="main">⌑</span></span></span>"</span></span></span></span> inline1.simps<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def ennreal_pmf_bind nn_integral_multc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nn_integral_measure_pmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split generat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">res</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">res</span> <span class="keyword1">of</span> Inl <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span>
            <span class="main">|</span> Inr <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">,</span> <span class="bound">rpv'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">⨅</span><span class="bound">x</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ'</span> <span class="bound">out</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="main">(</span><span class="bound">rpv'</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">rpv</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
       <span class="main">∂</span>measure_spmf <span class="main">(</span>inline1 <span class="free">callee</span> <span class="skolem">gpv</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
    ennreal <span class="main">(</span>pmf <span class="main">(</span>inline1 <span class="free">callee</span> <span class="skolem">gpv</span> <span class="skolem">s</span><span class="main">)</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nn_integral_measure_spmf_conv_measure_pmf nn_integral_restrict_space nn_integral_measure_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> nn_integral_disjoint_pair_countspace<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"range Some"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span>None<span class="main">}</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> UNIV_option_conv<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">expectation_gpv2</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="skolem">gpv</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> expectation_gpv2_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="main"><span class="main"><span class="main">⌑</span></span></span>"</span></span></span></span> expectation_gpv.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> inline_sel<span class="main">)</span>
      <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def pmf_map_spmf_None sum.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"case_generat <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> split_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> sum.case_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-pfinite_inline"><span class="command">lemma</span></span> pfinite_inline<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_gpv <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> callee<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> pfinite_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pfinite_gpv <span class="free">ℐ'</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> pgen_lossless_gpv_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> WT'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span> <span class="keyword1">⊢g</span> inline <span class="free">callee</span> <span class="free">gpv</span> <span class="free">s</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> WT I <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_gpv_inline_invar<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> expectation_gpv_const_le<span class="main">[</span><span class="operator">OF</span> WT'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="free">gpv</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pgen_lossless_gpv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> expectation_gpv <span class="main">1</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> expectation_gpv_1_le_inline<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> split_def<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> callee I WT WT_callee order_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="More_CC-pfinite_comp_converter"><span class="command">lemma</span></span> pfinite_comp_converter <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ1</span> <span class="free">ℐ3</span> <span class="main">(</span><span class="free">conv1</span> <span class="main">⊙</span> <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ1</span> <span class="free">ℐ2</span> <span class="free">conv1</span>"</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ2</span> <span class="free">ℐ3</span> <span class="free">conv2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span><span class="main">,</span><span class="free">ℐ2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ2</span><span class="main">,</span><span class="free">ℐ3</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> pfinite_converter
  <span class="keyword1"><span class="command">have</span></span> conv1<span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_gpv <span class="free">ℐ2</span> <span class="main">(</span>run_converter <span class="skolem">conv1</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> pfinite_converter<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pfinite_converterD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> conv2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ2</span> <span class="keyword1">⊢g</span> run_converter <span class="skolem">conv1</span> <span class="skolem">a</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pfinite_converter<span class="main">(</span>3<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WT_converterD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?pfinite</span></span></span> <span class="keyword1"><span class="command">using</span></span> pfinite_converter<span class="main">(</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>run_pfinite_converter.pfinite_inline<span class="main"><span class="main">[</span></span><span class="operator">OF</span> conv1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pfinite_converterD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> conv2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?step</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">∈</span><span class="var">?res</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">b</span> <span class="bound">conv'</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="skolem">conv''</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">conv''</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?res</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">conv1'</span></span> <span class="skolem"><span class="skolem">conv2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">conv''</span> <span class="main">=</span> comp_converter <span class="skolem">conv1'</span> <span class="skolem">conv2'</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> inline<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">conv1'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">conv2'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ3</span> <span class="main">(</span>inline run_converter <span class="main">(</span>run_converter <span class="skolem">conv1</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">conv2</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> run_pfinite_converter.results_gpv_inline<span class="main">[</span><span class="operator">OF</span> inline conv2<span class="main">]</span> pfinite_converter<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">conv1'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ2</span> <span class="main">(</span>run_converter <span class="skolem">conv1</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ2</span> <span class="free">ℐ3</span> <span class="skolem">conv2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ3</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">conv2'</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> WT_converterD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> pfinite_converter<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span> run<span class="main">]</span> pfinite_converterD<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> pfinite_converter<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span> run<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">b</span> <span class="skolem">conv''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-pfinite_map_converter"><span class="command">lemma</span></span> pfinite_map_converter <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ</span>  <span class="free">ℐ'</span> <span class="main">(</span>map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">conv</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> 
  *<span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="main">(</span>map_ℐ <span class="main">(</span>inv_into UNIV <span class="free">f</span><span class="main">)</span> <span class="main">(</span>inv_into UNIV <span class="free">g</span><span class="main">)</span> <span class="free">ℐ</span><span class="main">)</span> <span class="main">(</span>map_ℐ <span class="free">f'</span> <span class="free">g'</span> <span class="free">ℐ'</span><span class="main">)</span> <span class="free">conv</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> *
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pfinite_converter <span class="skolem">a</span> <span class="skolem">conv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_into UNIV <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> pfinite_converterD<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹pfinite_converter <span class="main">_</span> <span class="main">_</span> <span class="skolem">conv</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pfinite</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?step</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">conv'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="main">(</span>map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> <span class="skolem">conv</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">conv''</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> results<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">conv''</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="main">(</span>map_ℐ <span class="free">f'</span> <span class="free">g'</span> <span class="free">ℐ'</span><span class="main">)</span> <span class="main">(</span>run_converter <span class="skolem">conv</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">r'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> conv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">conv'</span> <span class="main">=</span> map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> <span class="skolem">conv''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> pfinite_converterD<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹pfinite_converter <span class="main">_</span> <span class="main">_</span> <span class="skolem">conv</span>›</span></span><span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> _ results<span class="main">]</span> a r conv'
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">conv</span><span class="main">.</span> <span class="skolem">conv'</span> <span class="main">=</span> map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> <span class="bound">conv</span> <span class="main">∧</span>
              pfinite_converter <span class="main">(</span>map_ℐ <span class="main">(</span>inv_into UNIV <span class="free">f</span><span class="main">)</span> <span class="main">(</span>inv_into UNIV <span class="free">g</span><span class="main">)</span> <span class="free">ℐ</span><span class="main">)</span> <span class="main">(</span>map_ℐ <span class="free">f'</span> <span class="free">g'</span> <span class="free">ℐ'</span><span class="main">)</span> <span class="bound">conv</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-pfinite_lassocr"><span class="command">lemma</span></span> pfinite_lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">)</span> lassocr<span class="hidden">⇩</span><sub>C</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lassocr<span class="hidden">⇩</span><sub>C</sub>_def<span class="main">)</span>

<span class="keyword1" id="More_CC-pfinite_rassocl"><span class="command">lemma</span></span> pfinite_rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> rassocl<span class="hidden">⇩</span><sub>C</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rassocl<span class="hidden">⇩</span><sub>C</sub>_def<span class="main">)</span>

<span class="keyword1" id="More_CC-pfinite_swap"><span class="command">lemma</span></span> pfinite_swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ1</span><span class="main">)</span> swap<span class="hidden">⇩</span><sub>C</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap<span class="hidden">⇩</span><sub>C</sub>_def<span class="main">)</span>

<span class="keyword1" id="More_CC-pfinite_swap_lassocr"><span class="command">lemma</span></span> pfinite_swap_lassocr <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">)</span> swap_lassocr"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> swap_lassocr_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="More_CC-pfinite_swap_rassocl"><span class="command">lemma</span></span> pfinite_swap_rassocl <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> swap_rassocl"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> swap_rassocl_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="More_CC-pfinite_parallel_wiring"><span class="command">lemma</span></span> pfinite_parallel_wiring <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pfinite_converter <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ3</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ4</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ4</span><span class="main">)</span><span class="main">)</span> parallel_wiring"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> parallel_wiring_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="More_CC-pfinite_parallel_converter"><span class="command">lemma</span></span> pfinite_parallel_converter <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pfinite_converter <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="free">ℐ3</span> <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ1</span> <span class="free">ℐ3</span> <span class="free">conv1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ2</span> <span class="free">ℐ3</span> <span class="free">conv2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pfinite_converterD<span class="main">)</span>

<span class="keyword1" id="More_CC-pfinite_converter_of_resource"><span class="command">lemma</span></span> pfinite_converter_of_resource <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ1</span> <span class="free">ℐ2</span> <span class="main">(</span>converter_of_resource <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹colossless converter›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">colossless_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ℐ</span> <span class="entity">ℐ'</span> <span class="keyword2"><span class="keyword">where</span></span>
  colossless_converterI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">colossless_converter</span> <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟹</span> colossless_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">conv'</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">colossless_converter</span> <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv'</span>"</span></span>

<span class="keyword1" id="More_CC-colossless_converter_coinduct"><span class="command">lemma</span></span> colossless_converter_coinduct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> colossless_converter<span class="main">,</span> <span class="operator">case_conclusion</span> colossless_converter plossless step<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> colossless_converter<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">conv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">conv</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">X</span> <span class="bound">conv</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟧</span> <span class="main">⟹</span> colossless_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="bound">conv</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="bound">conv</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="free">X</span> <span class="bound">conv'</span> <span class="main">∨</span> colossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"colossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> colossless_converter.coinduct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> step<span class="main">)</span>

<span class="keyword1" id="More_CC-colossless_converterD"><span class="command">lemma</span></span> colossless_converterD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> colossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">conv</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> colossless_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free">conv</span> <span class="free">a</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free">conv</span> <span class="free">a</span><span class="main">)</span><span class="main">.</span> colossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> colossless_converter.cases<span class="main">)</span>

<span class="keyword1" id="More_CC-colossless_converter_bot1"><span class="command">lemma</span></span> colossless_converter_bot1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"colossless_converter bot <span class="free">ℐ</span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> colossless_converterI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="More_CC-raw_converter_invariant_run_colossless_converter"><span class="command">lemma</span></span> raw_converter_invariant_run_colossless_converter<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_converter_invariant <span class="free">ℐ</span> <span class="free">ℐ'</span> run_converter <span class="main">(</span><span class="main">λ</span><span class="bound">conv</span><span class="main">.</span> colossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv</span> <span class="main">∧</span> <span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="bound">conv</span> <span class="main">√</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD colossless_converterD<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> run_colossless_converter<span class="main">:</span> raw_converter_invariant
  <span class="quoted"><span class="free">ℐ</span></span> <span class="quoted"><span class="free">ℐ'</span></span> <span class="quoted">run_converter</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">conv</span><span class="main">.</span> colossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv</span> <span class="main">∧</span> <span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="bound">conv</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ℐ</span> <span class="free">ℐ'</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> raw_converter_invariant_run_colossless_converter<span class="main">)</span>

<span class="keyword1" id="More_CC-colossless_const_converter"><span class="command">lemma</span></span> colossless_const_converter <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"colossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="main">(</span>const_converter <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹trace equivalence›</span></span>

<span class="keyword1" id="More_CC-distinguish_trace_eq"><span class="command">lemma</span></span> distinguish_trace_eq<span class="main">:</span> <span class="comment1">(* generalized from Distinguisher.thy *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinguish<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">distinguisher</span><span class="main">.</span> <span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="bound">distinguisher</span> <span class="main">√</span> <span class="main">⟹</span> connect <span class="bound">distinguisher</span> <span class="free">res</span> <span class="main">=</span> connect <span class="bound">distinguisher</span> <span class="free">res'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">≈</span> <span class="free">res'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> distinguish_trace_eq<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_fail_resource<span class="main">)</span>

<span class="keyword1" id="More_CC-attach_trace_eq'"><span class="command">lemma</span></span> attach_trace_eq'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res1</span> <span class="main">≈</span> <span class="free">res2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT1 <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="free">res1</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT2 <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="free">res2</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_conv <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span><span class="main">,</span><span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">conv</span> <span class="main">⊳</span> <span class="free">res1</span> <span class="main">≈</span> <span class="free">conv</span> <span class="main">⊳</span> <span class="free">res2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> distinguish_trace_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒟</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> distinguisher"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒟</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span>absorb <span class="skolem">𝒟</span> <span class="free">conv</span><span class="main">)</span> <span class="free">res1</span> <span class="main">=</span> connect <span class="main">(</span>absorb <span class="skolem">𝒟</span> <span class="free">conv</span><span class="main">)</span> <span class="free">res2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_cong_trace<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">fold</span> WT_gpv_iff_outs_gpv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"connect <span class="skolem">𝒟</span> <span class="main">(</span><span class="free">conv</span> <span class="main">⊳</span> <span class="free">res1</span><span class="main">)</span> <span class="main">=</span> connect <span class="skolem">𝒟</span> <span class="main">(</span><span class="free">conv</span> <span class="main">⊳</span> <span class="free">res2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinguish_attach<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-trace_callee_eq_trans"><span class="command">lemma</span></span> trace_callee_eq_trans <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span><span class="main">;</span> trace_callee_eq <span class="free">callee2</span> <span class="free">callee3</span> <span class="free">A</span> <span class="free">q</span> <span class="free">r</span> <span class="main">⟧</span>
   <span class="main">⟹</span> trace_callee_eq <span class="free">callee1</span> <span class="free">callee3</span> <span class="free">A</span> <span class="free">p</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_callee_eq_def<span class="main">)</span>

<span class="keyword1" id="More_CC-trace_eq'_parallel_resource"><span class="command">lemma</span></span> trace_eq'_parallel_resource<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">res1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">res2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> resource"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq' <span class="free">A</span> <span class="free">res1</span> <span class="free">res1'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq' <span class="free">B</span> <span class="free">res2</span> <span class="free">res2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_eq' <span class="main">(</span><span class="free">A</span> <span class="main">&lt;+&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">res1</span> <span class="main">∥</span> <span class="free">res2</span><span class="main">)</span> <span class="main">(</span><span class="free">res1'</span> <span class="main">∥</span> <span class="free">res2'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="free">A</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="free">B</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'d</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace_eq' <span class="main">(</span>outs_ℐ <span class="var">?ℐ</span><span class="main">)</span> <span class="main">(</span><span class="free">res1</span> <span class="main">∥</span> <span class="free">res2</span><span class="main">)</span> <span class="main">(</span><span class="free">res1'</span> <span class="main">∥</span> <span class="free">res2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> attach_converter_of_resource_conv_parallel_resource2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> attach_trace_eq'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?ℐ</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="free">A</span> UNIV"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> WT_resource_ℐ_uniform_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace_eq' <span class="main">(</span>outs_ℐ <span class="var">?ℐ</span><span class="main">)</span> <span class="main">(</span><span class="free">res1'</span> <span class="main">∥</span> <span class="free">res2</span><span class="main">)</span> <span class="main">(</span><span class="free">res1'</span> <span class="main">∥</span> <span class="free">res2'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> attach_converter_of_resource_conv_parallel_resource<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> attach_trace_eq'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?ℐ</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="free">B</span> UNIV"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> WT_resource_ℐ_uniform_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> trace_callee_eq_coinduct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> step sim<span class="main">]</span><span class="main">:</span> <span class="comment1">(* stronger version of trace'_eq_simI *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">callee1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> callee"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">callee2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> callee"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span>
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span> <span class="bound">res</span> <span class="bound">res'</span> <span class="bound">b</span> <span class="bound">s''</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="bound">res</span> <span class="main">∈</span> set_spmf <span class="bound">p</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">s''</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee1</span> <span class="bound">res</span> <span class="bound">a</span><span class="main">)</span><span class="main">;</span> <span class="bound">res'</span> <span class="main">∈</span> set_spmf <span class="bound">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee2</span> <span class="bound">res'</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>
            <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> trace_callee_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">and</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> start <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trace_callee <span class="free">callee1</span> <span class="free">p</span> <span class="skolem">xs</span> <span class="skolem">z</span> <span class="main">=</span> trace_callee <span class="free">callee2</span> <span class="free">q</span> <span class="skolem">xs</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xs
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> z <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xy</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> xy <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xy</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xy</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace_callee <span class="free">callee1</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">xy</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> 
      trace_callee <span class="free">callee1</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">xs</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf split_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> trace_callee <span class="free">callee2</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">xs</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span> <span class="main">∈</span> set_spmf <span class="skolem">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> set_spmf <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee2</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> ss' step<span class="main">[</span><span class="operator">THEN</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"set_spmf"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="skolem">p</span> <span class="skolem">q</span>›</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="skolem"><span class="skolem">ss'</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">∈</span> set_spmf <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">ss'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee1</span> <span class="skolem">ss</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION<span class="main">)</span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> sim<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="skolem">p</span> <span class="skolem">q</span>›</span></span> _ this ss'<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Cons.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> return_pmf None"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_return_pmf_None<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> step<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="skolem">p</span> <span class="skolem">q</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">,</span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">set_spmf</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">THEN</span> eq_refl<span class="main">]</span> Cons.prems False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> return_pmf None"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_return_pmf_None<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_eq_return_None<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> trace_callee <span class="free">callee2</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">xy</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> trace_callee_eq_coinduct_strong <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> step sim<span class="main">,</span> <span class="operator">case_conclusion</span> step lhs rhs<span class="main">,</span> <span class="operator">case_conclusion</span> sim sim eq<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">callee1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> callee"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">callee2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> callee"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span>
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span> <span class="bound">res</span> <span class="bound">res'</span> <span class="bound">b</span> <span class="bound">s''</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="bound">res</span> <span class="main">∈</span> set_spmf <span class="bound">p</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">s''</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee1</span> <span class="bound">res</span> <span class="bound">a</span><span class="main">)</span><span class="main">;</span> <span class="bound">res'</span> <span class="main">∈</span> set_spmf <span class="bound">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee2</span> <span class="bound">res'</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>
            <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∨</span>
          trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> start <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∨</span> trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> trace_callee_eq_coinduct<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> step<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> trace_callee_eqD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> sim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> trace_callee_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> trace_callee_eqD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">#</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-trace_callee_return_pmf_None"><span class="command">lemma</span></span> trace_callee_return_pmf_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="main">(</span>return_pmf None<span class="main">)</span> <span class="main">(</span>return_pmf None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace_callee_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="More_CC-trace_callee_eq_sym"><span class="command">lemma</span></span> trace_callee_eq_sym <span class="main">[</span><span class="operator">sym</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span> trace_callee_eq <span class="free">callee2</span> <span class="free">callee1</span> <span class="free">A</span> <span class="free">q</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_callee_eq_def<span class="main">)</span>

<span class="keyword1" id="More_CC-eq_resource_on_imp_trace_eq"><span class="command">lemma</span></span> eq_resource_on_imp_trace_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res1</span> <span class="main">≈</span> <span class="free">res2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res1</span> <span class="main">∼</span> <span class="free">res2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="main">(</span>ℐ_uniform <span class="free">A</span> UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ<span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res1</span> <span class="main">≈</span> <span class="free">res2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> distinguish_trace_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> connect_eq_resource_cong<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-advantage_nonneg"><span class="command">lemma</span></span> advantage_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> advantage <span class="free">𝒜</span> <span class="free">res1</span> <span class="free">res2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def<span class="main">)</span>

<span class="keyword1" id="More_CC-comp_converter_of_resource_conv_parallel_converter"><span class="command">lemma</span></span> comp_converter_of_resource_conv_parallel_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>converter_of_resource <span class="free">res</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> <span class="free">conv</span> <span class="main">=</span> converter_of_resource <span class="free">res</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def gpv.map_comp map_lift_spmf spmf_rel_map split_def map_gpv_conv_bind<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> gpv.rel_map <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI gpv.rel_refl_strong<span class="main">)</span>

<span class="keyword1" id="More_CC-comp_converter_of_resource_conv_parallel_converter2"><span class="command">lemma</span></span> comp_converter_of_resource_conv_parallel_converter2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> converter_of_resource <span class="free">res</span><span class="main">)</span> <span class="main">⊙</span> <span class="free">conv</span> <span class="main">=</span> <span class="free">conv</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> converter_of_resource <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def gpv.map_comp map_lift_spmf spmf_rel_map split_def map_gpv_conv_bind<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> gpv.rel_map <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI gpv.rel_refl_strong<span class="main">)</span>

<span class="keyword1" id="More_CC-parallel_converter_map_converter"><span class="command">lemma</span></span> parallel_converter_map_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> map_converter <span class="free">f''</span> <span class="free">g''</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">conv2</span> <span class="main">=</span> 
   map_converter <span class="main">(</span>map_sum <span class="free">f</span> <span class="free">f''</span><span class="main">)</span> <span class="main">(</span>map_sum <span class="free">g</span> <span class="free">g''</span><span class="main">)</span> <span class="free">f'</span> <span class="free">g'</span> <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> parallel_callee_parametric<span class="main">[</span>
      <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> C<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">f'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">g'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">f''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">g''</span>"</span></span><span class="main">,</span>
      <span class="operator">unfolded</span> rel_converter_Grp sum.rel_conversep sum.rel_Grp<span class="main">,</span>
      <span class="operator">simplified</span><span class="main">,</span>
      <span class="operator">unfolded</span> rel_converter_Grp<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def Grp_def<span class="main">)</span>

<span class="keyword1" id="More_CC-map_converter_parallel_converter_out2"><span class="command">lemma</span></span> map_converter_parallel_converter_out2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> map_converter <span class="free">f</span> <span class="free">g</span> id id <span class="free">conv2</span> <span class="main">=</span> map_converter <span class="main">(</span>map_sum id <span class="free">f</span><span class="main">)</span> <span class="main">(</span>map_sum id <span class="free">g</span><span class="main">)</span> id id <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> parallel_converter_map_converter<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> g'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="More_CC-parallel_converter_assoc2"><span class="command">lemma</span></span> parallel_converter_assoc2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parallel_converter <span class="free">conv1</span> <span class="main">(</span>parallel_converter <span class="free">conv2</span> <span class="free">conv3</span><span class="main">)</span> <span class="main">=</span>                                   
   map_converter lsumr rsuml id id <span class="main">(</span>parallel_converter <span class="main">(</span>parallel_converter <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span> <span class="free">conv3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span> <span class="quoted"><span class="free">conv3</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 5 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI gpv.rel_refl_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map map_gpv'_id map_gpv_conv_map_gpv'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="More_CC-parallel_converter_of_resource"><span class="command">lemma</span></span> parallel_converter_of_resource<span class="main">:</span>
  <span class="quoted"><span class="quoted">"converter_of_resource <span class="free">res1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> converter_of_resource <span class="free">res2</span> <span class="main">=</span> converter_of_resource <span class="main">(</span><span class="free">res1</span> <span class="main">∥</span> <span class="free">res2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res1</span></span> <span class="quoted"><span class="free">res2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def map_lift_spmf spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>

<span class="keyword1" id="More_CC-map_Inr_parallel_converter"><span class="command">lemma</span></span> map_Inr_parallel_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_converter Inr <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="free">conv2</span><span class="main">)</span> <span class="main">=</span> map_converter id <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> Inr<span class="main">)</span> <span class="free">g</span> <span class="free">h</span> <span class="free">conv2</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> map_converter Inr <span class="free">f</span> id id <span class="main">(</span>map_converter id id <span class="free">g</span> <span class="free">h</span> <span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> map_converter id id <span class="free">g</span> <span class="free">h</span> <span class="free">conv2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_converter_map_converter sum.map_id0<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_converter Inr <span class="free">f</span> id id <span class="main">(</span><span class="skolem">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="skolem">conv2</span><span class="main">)</span> <span class="main">=</span> map_converter id <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> Inr<span class="main">)</span> id id <span class="skolem">conv2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">conv1</span> <span class="skolem">conv2</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">conv2</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def map_gpv_conv_map_gpv'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> gpv.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.rel_refl_strong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_converter id <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> Inr<span class="main">)</span> id id <span class="main">(</span>map_converter id id <span class="free">g</span> <span class="free">h</span> <span class="free">conv2</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-map_Inl_parallel_converter"><span class="command">lemma</span></span> map_Inl_parallel_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_converter Inl <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="free">conv2</span><span class="main">)</span> <span class="main">=</span> map_converter id <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> Inl<span class="main">)</span> <span class="free">g</span> <span class="free">h</span> <span class="free">conv1</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> map_converter Inl <span class="free">f</span> id id <span class="main">(</span>map_converter id id <span class="free">g</span> <span class="free">h</span> <span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> map_converter id id <span class="free">g</span> <span class="free">h</span> <span class="free">conv2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_converter_map_converter sum.map_id0<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_converter Inl <span class="free">f</span> id id <span class="main">(</span><span class="skolem">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="skolem">conv2</span><span class="main">)</span> <span class="main">=</span> map_converter id <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> Inl<span class="main">)</span> id id <span class="skolem">conv1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">conv1</span> <span class="skolem">conv2</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">conv1</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def map_gpv_conv_map_gpv'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> gpv.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.rel_refl_strong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_converter id <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> Inl<span class="main">)</span> id id <span class="main">(</span>map_converter id id <span class="free">g</span> <span class="free">h</span> <span class="free">conv1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-left_interface_parallel_converter"><span class="command">lemma</span></span> left_interface_parallel_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"left_interface <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="free">conv2</span><span class="main">)</span> <span class="main">=</span> left_interface <span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> left_interface <span class="free">conv2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def gpv.rel_map left_gpv_map<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span><span class="main"><span class="main">]</span></span> sum.map_id0 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.rel_refl_strong<span class="main">)</span>

<span class="keyword1" id="More_CC-right_interface_parallel_converter"><span class="command">lemma</span></span> right_interface_parallel_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"right_interface <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="free">conv2</span><span class="main">)</span> <span class="main">=</span> right_interface <span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> right_interface <span class="free">conv2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def gpv.rel_map right_gpv_map<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span><span class="main"><span class="main">]</span></span> sum.map_id0 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.rel_refl_strong<span class="main">)</span>

<span class="keyword1" id="More_CC-left_interface_converter_of_resource"><span class="command">lemma</span></span> left_interface_converter_of_resource <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"left_interface <span class="main">(</span>converter_of_resource <span class="free">res</span><span class="main">)</span> <span class="main">=</span> converter_of_resource <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def map_lift_spmf spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>

<span class="keyword1" id="More_CC-right_interface_converter_of_resource"><span class="command">lemma</span></span> right_interface_converter_of_resource <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"right_interface <span class="main">(</span>converter_of_resource <span class="free">res</span><span class="main">)</span> <span class="main">=</span> converter_of_resource <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def map_lift_spmf spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>

<span class="keyword1" id="More_CC-parallel_converter_swap"><span class="command">lemma</span></span> parallel_converter_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"map_converter swap_sum swap_sum id id <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="free">conv2</span><span class="main">)</span> <span class="main">=</span> <span class="free">conv2</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="free">conv1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def map_gpv_conv_map_gpv'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> gpv.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.rel_refl_strong<span class="main">)</span>

<span class="keyword1" id="More_CC-eq_ℐ_converter_map_converter'"><span class="command">lemma</span></span> eq_ℐ_converter_map_converter'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ''</span><span class="main">,</span> map_ℐ <span class="free">f'</span> <span class="free">g'</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">∼</span> <span class="free">conv2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">∈</span>outs_ℐ <span class="free">ℐ</span><span class="main">.</span> <span class="free">g</span> <span class="main">`</span> responses_ℐ <span class="free">ℐ''</span> <span class="main">(</span><span class="free">f</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⊆</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">conv1</span> <span class="main">∼</span> map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">conv2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> eq_ℐ_converter
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> eq_ℐ_converter<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> eq_ℐ_converterD<span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> eq_ℐ_converter<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_gpv_map_gpv'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> BNF_Def.vimage2p_def prod.rel_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> eq_ℐ_gpv_mono'<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="More_CC-parallel_converter_eq_ℐ_cong"><span class="command">lemma</span></span> parallel_converter_eq_ℐ_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ℐ1</span><span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">∼</span> <span class="free">conv1'</span><span class="main">;</span> <span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">∼</span> <span class="free">conv2'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> parallel_converter <span class="free">conv1</span> <span class="free">conv2</span> <span class="main">∼</span> parallel_converter <span class="free">conv1'</span> <span class="free">conv2'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span> <span class="quoted"><span class="free">conv1'</span></span> <span class="quoted"><span class="free">conv2'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_ℐ_converterD <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_mono' <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>

<span class="comment1">― ‹Helper lemmas for simplyfing <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">exec_gpv</span><span class="antiquote">}</span></span>›</span>
<span class="keyword1" id="More_CC-exec_gpv_parallel_oracle_right"><span class="command">lemma</span></span>
  exec_gpv_parallel_oracle_right<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"exec_gpv <span class="main">(</span><span class="free">oracle1</span> <span class="keyword1">‡<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">oracle2</span><span class="main">)</span> <span class="main">(</span>right_gpv <span class="free">gpv</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> exec_gpv <span class="main">(</span><span class="main">†</span><span class="free">oracle2</span><span class="main">)</span> <span class="free">gpv</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spmf_rel_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rel_spmf_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exec_gpv_parametric'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> CALL<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> Inr <span class="bound">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> Inr <span class="bound">r</span>"</span></span> <span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD <span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.rel_eq extend_state_oracle_def parallel_oracle_def split_def
      spmf_rel_map1 spmf_rel_map2 map_prod_def rel_spmf_reflI right_gpv_Inr_transfer <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>rel_funI<span class="main">)</span>

<span class="keyword1" id="More_CC-exec_gpv_parallel_oracle_left"><span class="command">lemma</span></span>
  exec_gpv_parallel_oracle_left<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"exec_gpv <span class="main">(</span><span class="free">oracle1</span> <span class="keyword1">‡<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">oracle2</span><span class="main">)</span> <span class="main">(</span>left_gpv <span class="free">gpv</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> exec_gpv <span class="main">(</span><span class="free">oracle1</span><span class="main">†</span><span class="main">)</span> <span class="free">gpv</span> <span class="free">s</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> spmf_rel_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rel_spmf_mono<span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exec_gpv_parametric'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> CALL<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> Inl <span class="bound">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> Inl <span class="bound">r</span>"</span></span> <span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD <span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.rel_eq extend_state_oracle2_def parallel_oracle_def split_def
       spmf_rel_map1 spmf_rel_map2 map_prod_def rel_spmf_reflI left_gpv_Inl_transfer <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>rel_funI<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Observe_Failure">
<div class="head">
<h1>Theory Observe_Failure</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Observe_Failure <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#More_CC">More_CC</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">show_variants</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oracle</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">obsf_oracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> exception<span class="main">,</span> <span class="tfree">'in</span><span class="main">,</span> <span class="tfree">'out</span> exception<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">obsf_oracle</span> Fault <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> return_spmf <span class="main">(</span>Fault<span class="main">,</span> Fault<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">obsf_oracle</span> <span class="main">(</span>OK <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">TRY</span> map_spmf <span class="main">(</span>map_prod OK OK<span class="main">)</span> <span class="main">(</span><span class="free">oracle</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">ELSE</span> return_spmf <span class="main">(</span>Fault<span class="main">,</span> Fault<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource_obsf <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> exception<span class="main">)</span> resource"</span></span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"<span class="main">(</span><span class="tfree"><span class="free">'a</span></span><span class="main">,</span> <span class="tfree"><span class="free">'b</span></span><span class="main">)</span> resource_obsf"</span> <span class="main">&lt;=</span> <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"<span class="main">(</span><span class="tfree"><span class="free">'a</span></span><span class="main">,</span> <span class="tfree"><span class="free">'b</span></span> exception<span class="main">)</span> resource"</span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">obsf_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'in</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">)</span> resource <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'in</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">)</span> resource_obsf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_resource <span class="main">(</span><span class="free">obsf_resource</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span>
   map_spmf <span class="main">(</span>map_prod id <span class="free">obsf_resource</span><span class="main">)</span> 
     <span class="main">(</span>map_spmf <span class="main">(</span>map_prod id <span class="main">(</span><span class="main">λ</span><span class="bound">resF</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">resF</span> <span class="keyword1">of</span> OK <span class="bound">res'</span> <span class="main">⇒</span> <span class="bound">res'</span> <span class="main">|</span> Fault <span class="main">⇒</span> fail_resource<span class="main">)</span><span class="main">)</span>
       <span class="main">(</span><span class="keyword1">TRY</span> map_spmf <span class="main">(</span>map_prod OK OK<span class="main">)</span> <span class="main">(</span>run_resource <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">ELSE</span> return_spmf <span class="main">(</span>Fault<span class="main">,</span> Fault<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Observe_Failure-obsf_resource_sel"><span class="command">lemma</span></span> obsf_resource_sel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_resource <span class="main">(</span>obsf_resource <span class="free">res</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> 
   map_spmf <span class="main">(</span>map_prod id <span class="main">(</span><span class="main">λ</span><span class="bound">resF</span><span class="main">.</span> obsf_resource <span class="main">(</span><span class="keyword1">case</span> <span class="bound">resF</span> <span class="keyword1">of</span> OK <span class="bound">res'</span> <span class="main">⇒</span> <span class="bound">res'</span> <span class="main">|</span> Fault <span class="main">⇒</span> fail_resource<span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span><span class="keyword1">TRY</span> map_spmf <span class="main">(</span>map_prod OK OK<span class="main">)</span> <span class="main">(</span>run_resource <span class="free">res</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">ELSE</span> return_spmf <span class="main">(</span>Fault<span class="main">,</span> Fault<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp prod.map_comp o_def id_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> obsf_resource.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Observe_Failure-obsf_resource_exception"><span class="command">lemma</span></span> obsf_resource_exception <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obsf_resource fail_resource <span class="main">=</span> const_resource Fault"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def obsf_resource_sel<span class="main">)</span>

<span class="keyword1" id="Observe_Failure-obsf_resource_sel2"><span class="command">lemma</span></span> obsf_resource_sel2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_resource <span class="main">(</span>obsf_resource <span class="free">res</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> 
   try_spmf <span class="main">(</span>map_spmf <span class="main">(</span>map_prod OK obsf_resource<span class="main">)</span> <span class="main">(</span>run_resource <span class="free">res</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span>Fault<span class="main">,</span> const_resource Fault<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_try_spmf spmf.map_comp o_def prod.map_comp obsf_resource_sel<span class="main">)</span>

<span class="keyword1" id="Observe_Failure-lossless_obsf_resource"><span class="command">lemma</span></span> lossless_obsf_resource <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_resource <span class="free">ℐ</span> <span class="main">(</span>obsf_resource <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Observe_Failure-WT_obsf_resource"><span class="command">lemma</span></span> WT_obsf_resource <span class="main">[</span><span class="operator">WT_intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="free">ℐ</span> <span class="keyword1">⊢res</span> obsf_resource <span class="free">res</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_resourceD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>


<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> distinguisher_obsf <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> exception<span class="main">)</span> gpv"</span></span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"<span class="main">(</span><span class="tfree"><span class="free">'a</span></span><span class="main">,</span> <span class="tfree"><span class="free">'b</span></span><span class="main">)</span> distinguisher_obsf"</span> <span class="main">&lt;=</span> <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"<span class="main">(</span>bool<span class="main">,</span> <span class="tfree"><span class="free">'a</span></span><span class="main">,</span> <span class="tfree"><span class="free">'b</span></span> exception<span class="main">)</span> gpv"</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">connect_obsf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> distinguisher_obsf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource_obsf <span class="main">⇒</span> bool spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">connect_obsf</span> <span class="main">==</span> connect"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">obsf_distinguisher</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> distinguisher <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> distinguisher_obsf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obsf_distinguisher</span> <span class="free"><span class="bound"><span class="entity">𝒟</span></span></span> <span class="main">=</span> map_gpv' <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Some True<span class="main">)</span> id option_of_exception <span class="main">(</span>gpv_stop <span class="free"><span class="bound"><span class="entity">𝒟</span></span></span><span class="main">)</span>"</span></span>
                                      
<span class="keyword1" id="Observe_Failure-WT_obsf_distinguisher"><span class="command">lemma</span></span> WT_obsf_distinguisher <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"exception_ℐ <span class="free">ℐ</span> <span class="keyword1">⊢g</span> obsf_distinguisher <span class="free">𝒜</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> obsf_distinguisher_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main"><span class="keyword3">|</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Observe_Failure-interaction_bounded_by_obsf_distinguisher"><span class="command">lemma</span></span> interaction_bounded_by_obsf_distinguisher <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="free">consider</span> <span class="main">(</span>obsf_distinguisher <span class="free">𝒜</span><span class="main">)</span> <span class="free">bound</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="free">consider</span> <span class="free">𝒜</span> <span class="free">bound</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> obsf_distinguisher_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">interaction_bound</span></span><span class="main"><span class="keyword3">|</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Observe_Failure-plossless_obsf_distinguisher"><span class="command">lemma</span></span> plossless_obsf_distinguisher <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"plossless_gpv <span class="main">(</span>exception_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">(</span>obsf_distinguisher <span class="free">𝒜</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="free">ℐ</span> <span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> obsf_distinguisher_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter_obsf <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> exception<span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span> exception<span class="main">)</span> converter"</span></span>

<span class="keyword1"><span class="command">translations</span></span>                                                                                       
  <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"<span class="main">(</span><span class="tfree"><span class="free">'a</span></span><span class="main">,</span> <span class="tfree"><span class="free">'b</span></span><span class="main">,</span> <span class="tfree"><span class="free">'c</span></span><span class="main">,</span> <span class="tfree"><span class="free">'d</span></span><span class="main">)</span> converter_obsf"</span> <span class="main">&lt;=</span> <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"<span class="main">(</span><span class="tfree"><span class="free">'a</span></span><span class="main">,</span> <span class="tfree"><span class="free">'b</span></span> exception<span class="main">,</span> <span class="tfree"><span class="free">'c</span></span><span class="main">,</span> <span class="tfree"><span class="free">'d</span></span> exception<span class="main">)</span> converter"</span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">obsf_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter_obsf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span><span class="free">obsf_converter</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> 
   map_gpv <span class="main">(</span>map_prod id <span class="free">obsf_converter</span><span class="main">)</span> id 
    <span class="main">(</span>map_gpv <span class="main">(</span><span class="main">λ</span><span class="bound">convF</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">convF</span> <span class="keyword1">of</span> Fault <span class="main">⇒</span> <span class="main">(</span>Fault<span class="main">,</span> fail_converter<span class="main">)</span> <span class="main">|</span> OK <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>OK <span class="bound">a</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span> id
      <span class="main">(</span>try_gpv <span class="main">(</span>map_gpv' exception_of_option id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Done Fault<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Observe_Failure-obsf_converter_exception"><span class="command">lemma</span></span> obsf_converter_exception <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obsf_converter fail_converter <span class="main">=</span> const_converter Fault"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def<span class="main">)</span>

<span class="keyword1" id="Observe_Failure-obsf_converter_sel"><span class="command">lemma</span></span> obsf_converter_sel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span>obsf_converter <span class="free">conv</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
   <span class="keyword1">TRY</span> map_gpv' <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">y</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span> <span class="main">|</span> Some<span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>OK <span class="bound">x</span><span class="main">,</span> obsf_converter <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span> id option_of_exception
         <span class="main">(</span>gpv_stop <span class="main">(</span>run_converter <span class="free">conv</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>
   <span class="keyword1">ELSE</span> Done <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_try_gpv<span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_gpv_conv_map_gpv' map_gpv'_comp o_def option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map_prod <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> split_def id_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> option.case_cong<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> obsf_converter.sel <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Observe_Failure-exec_gpv_obsf_resource"><span class="command">lemma</span></span> exec_gpv_obsf_resource<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">exec_gpv1</span> <span class="main">≡</span> exec_gpv"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">exec_gpv2</span> <span class="main">≡</span> exec_gpv"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exec_gpv1</span> run_resource <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">res</span><span class="main">)</span> <span class="main">↿</span> <span class="main">{</span><span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> True<span class="main">}</span> <span class="main">=</span>
   map_spmf <span class="main">(</span>map_prod Some obsf_resource<span class="main">)</span> <span class="main">(</span><span class="free">exec_gpv2</span> run_resource <span class="free">gpv</span> <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> spmf.leq_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ord_spmf <span class="main">(=)</span> <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> exec_gpv1_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec_gpv_fixp_induct_strong<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">exec_gpv'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> exec_gpv2_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> exec_gpv.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf bind_map_spmf restrict_bind_spmf o_def try_spmf_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ord_spmf_bind_reflI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_pmf bind_spmf_def bind_assoc_pmf bind_return_pmf spmf.leq_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> restrict_spmf_mono<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> step.hyps<span class="main"><span class="main">]</span></span> id_def step.IH<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> id_def exec_gpv2_def<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_pmf_bind_reflI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ord_spmf <span class="main">(=)</span> <span class="var">?rhs</span> <span class="var">?lhs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> exec_gpv2_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec_gpv_fixp_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">exec_gpv'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> exec_gpv1_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> exec_gpv.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf map_bind_spmf restrict_bind_spmf o_def try_spmf_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ord_spmf_bind_reflI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def bind_assoc_pmf bind_map_pmf map_bind_pmf bind_return_pmf id_def step.IH<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> id_def exec_gpv1_def<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_pmf_bind_reflI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Observe_Failure-obsf_attach"><span class="command">lemma</span></span> obsf_attach<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> pfinite<span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">conv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_resource<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> attach <span class="main">(</span>obsf_converter <span class="free">conv</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">res</span><span class="main">)</span> <span class="main">∼</span> obsf_resource <span class="main">(</span>attach <span class="free">conv</span> <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eq_resource_on <span class="skolem">out</span> <span class="skolem">conv</span> <span class="skolem">res</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="var">?X</span> <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">,</span> <span class="bound">res'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span> <span class="main">⊳</span> <span class="bound">res'</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>exec_gpv run_resource
       <span class="main">(</span><span class="keyword1">TRY</span> map_gpv' <span class="main">(</span>case_option <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>OK <span class="bound">x</span><span class="main">,</span> obsf_converter <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span>run_converter <span class="skolem">conv</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> Done <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>obsf_resource <span class="skolem">res</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> map_spmf <span class="var">?attach</span> <span class="main">(</span>exec_gpv <span class="main">_</span> <span class="main">(</span><span class="keyword1">TRY</span> <span class="var">?gpv</span> <span class="keyword1">ELSE</span> <span class="main">_</span><span class="main">)</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="keyword1">TRY</span> map_spmf <span class="var">?attach</span> <span class="main">(</span>exec_gpv run_resource <span class="var">?gpv</span> <span class="main">(</span>obsf_resource <span class="skolem">res</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> return_spmf <span class="main">(</span>Fault<span class="main">,</span> const_resource Fault<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> run_lossless_resource.exec_gpv_try_gpv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"exception_ℐ <span class="free">ℐ'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">use</span> eq_resource_on <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">!</span><span class="main">:</span> WT_gpv_map_gpv' WT_gpv_stop pfinite_gpv_stop<span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">]</span> <span class="quasi_keyword">dest</span><span class="main">:</span> WT_converterD pfinite_converterD lossless_resourceD›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">TRY</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">rc</span><span class="main">,</span> <span class="bound">res'</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">rc</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span>Fault<span class="main">,</span> const_resource Fault<span class="main">)</span> <span class="main">|</span> Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>OK <span class="bound">x</span><span class="main">,</span> obsf_converter <span class="bound">conv'</span> <span class="main">⊳</span> <span class="bound">res'</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span><span class="main">(</span>exec_gpv run_resource <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span>run_converter <span class="skolem">conv</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="skolem">res</span><span class="main">)</span><span class="main">)</span> <span class="main">↿</span> <span class="main">{</span><span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span> 
               <span class="keyword1">ELSE</span> return_spmf <span class="main">(</span>Fault<span class="main">,</span> const_resource Fault<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="keyword1">TRY</span> map_spmf <span class="var">?f</span> <span class="main">_</span> <span class="keyword1">ELSE</span> <span class="var">?z</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> map_gpv'_id12<span class="main">)</span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_gpv'_map_gpv_swap exec_gpv_map_gpv_id try_spmf_def restrict_spmf_def bind_map_pmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">TRY</span> map_spmf <span class="var">?f</span> <span class="main">(</span>map_spmf <span class="main">(</span>map_prod Some obsf_resource<span class="main">)</span> <span class="main">(</span>exec_gpv run_resource <span class="main">(</span>run_converter <span class="skolem">conv</span> <span class="skolem">out</span><span class="main">)</span> <span class="skolem">res</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="var">?z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> exec_gpv_obsf_resource<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="var">?X</span> <span class="main">…</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_resource_on
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp o_def spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_try_spmf rel_spmf_reflI<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> run_resource.in_set_spmf_exec_gpv_into_results_gpv WT_converterD pfinite_converterD run_resource.exec_gpv_invariant<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Observe_Failure-colossless_obsf_converter"><span class="command">lemma</span></span> colossless_obsf_converter <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"colossless_converter <span class="main">(</span>exception_ℐ <span class="free">ℐ</span><span class="main">)</span> <span class="free">ℐ'</span> <span class="main">(</span>obsf_converter <span class="free">conv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>


<span class="keyword1" id="Observe_Failure-WT_obsf_converter"><span class="command">lemma</span></span> WT_obsf_converter <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"exception_ℐ <span class="free">ℐ</span><span class="main">,</span> exception_ℐ <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> obsf_converter <span class="free">conv</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD results_gpv_stop_SomeD <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>

<span class="keyword1" id="Observe_Failure-inline1_gpv_stop_obsf_converter"><span class="command">lemma</span></span> inline1_gpv_stop_obsf_converter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">inline1a</span> <span class="main">≡</span> inline1"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">inline1b</span> <span class="main">≡</span> inline1"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind_spmf <span class="main">(</span><span class="free">inline1a</span> run_converter <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="free">conv</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="main">λ</span><span class="bound">xy</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xy</span> <span class="keyword1">of</span> Inl <span class="main">(</span>None<span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">⇒</span> return_pmf None <span class="main">|</span> Inl <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">⇒</span> return_spmf <span class="main">(</span>Inl <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">y</span> <span class="main">⇒</span> return_spmf <span class="main">(</span>Inr <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
   map_spmf <span class="main">(</span>map_sum <span class="main">(</span>apsnd obsf_converter<span class="main">)</span>
       <span class="main">(</span>apsnd <span class="main">(</span>map_prod <span class="main">(</span><span class="main">λ</span><span class="bound">rpv</span> <span class="bound">input</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">input</span> <span class="keyword1">of</span> Fault <span class="main">⇒</span> Done <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span> <span class="main">|</span> OK <span class="bound">input'</span> <span class="main">⇒</span> 
            map_gpv' <span class="main">(</span><span class="main">λ</span><span class="bound">res</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">res</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span> <span class="main">|</span> Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>OK <span class="bound">x</span><span class="main">,</span> obsf_converter <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span> id option_of_exception <span class="main">(</span>try_gpv <span class="main">(</span>gpv_stop <span class="main">(</span><span class="bound">rpv</span> <span class="bound">input'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Done None<span class="main">)</span><span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span><span class="main">λ</span><span class="bound">rpv</span> <span class="bound">input</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">input</span> <span class="keyword1">of</span> Fault <span class="main">⇒</span> Done None <span class="main">|</span> OK <span class="bound">input'</span> <span class="main">⇒</span> map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span><span class="bound">rpv</span> <span class="bound">input'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">inline1b</span> run_converter <span class="free">gpv</span> <span class="free">conv</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> spmf.leq_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ord_spmf <span class="main">(=)</span> <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inline1a_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">conv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inline1_fixp_induct_strong<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">inline1'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> inline1b_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> inline1_unfold<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_bind_spmf bind_map_spmf spmf.map_comp o_def generat.map_comp <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ord_spmf_bind_reflI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def try_spmf_def bind_assoc_pmf bind_map_pmf bind_return_pmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_pmf_bind_reflI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bind_spmf_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ord_spmf_bindI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.hyps<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> spmf.leq_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ord_spmf_bindI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.hyps<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> spmf.leq_trans<span class="main"><span class="main">]</span></span> ord_spmf_reflI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bind_spmf_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> inline1b_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spmf.leq_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff map'_try_gpv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> exception.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ord_spmf <span class="main">(=)</span> <span class="var">?rhs</span> <span class="var">?lhs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inline1b_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">conv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inline1_fixp_induct_strong<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">inline1'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> inline1a_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> inline1_unfold<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_bind_spmf bind_map_spmf spmf.map_comp o_def generat.map_comp <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ord_spmf_bind_reflI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def try_spmf_def bind_assoc_pmf bind_map_pmf bind_return_pmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_pmf_bind_reflI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> in_set_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> inline1a_def id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spmf.leq_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff map'_try_gpv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> exception.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Observe_Failure-inline_gpv_stop_obsf_converter"><span class="command">lemma</span></span> inline_gpv_stop_obsf_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bind_gpv <span class="main">(</span>inline run_converter <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="free">gpv</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="free">conv</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> Done <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   bind_gpv <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span>inline run_converter <span class="free">gpv</span> <span class="free">conv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">conv</span><span class="main">)</span> <span class="main">⇒</span> Done <span class="main">(</span>Some <span class="bound">x'</span><span class="main">,</span> obsf_converter <span class="bound">conv</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">conv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gpv_coinduct_bind<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq_gpv <span class="skolem">gpv</span> <span class="skolem">conv</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?case</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> converter<span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> converter<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="var">?X</span> <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">xyz</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xyz</span> <span class="keyword1">of</span> Inl <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv</span><span class="main">)</span> <span class="main">⇒</span> Pure <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> <span class="bound">conv</span><span class="main">)</span> <span class="main">|</span> Inr <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">,</span> <span class="bound">rpv'</span><span class="main">)</span> <span class="main">⇒</span> IO <span class="bound">out</span> <span class="main">(</span><span class="main">λ</span><span class="bound">input</span><span class="main">.</span> bind_gpv <span class="main">(</span>bind_gpv <span class="main">(</span><span class="bound">rpv</span> <span class="bound">input</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> inline run_converter <span class="main">(</span><span class="bound">rpv'</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> Done <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>bind_spmf <span class="main">(</span>inline1 run_converter <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="skolem">gpv</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="skolem">conv</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span><span class="main">λ</span><span class="bound">xy</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xy</span> <span class="keyword1">of</span> Inl <span class="main">(</span>None<span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">⇒</span> return_pmf None <span class="main">|</span> Inl <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">⇒</span> return_spmf <span class="main">(</span>Inl <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">y</span> <span class="main">⇒</span> return_spmf <span class="main">(</span>Inr <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> map_spmf <span class="var">?f</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_gpv_sel' <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_gpv.sel map_bind_spmf inline_sel bind_map_spmf o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split option.split<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_spmf <span class="var">?f</span> <span class="main">(</span>map_spmf <span class="main">(</span>map_sum <span class="main">(</span>apsnd obsf_converter<span class="main">)</span> <span class="main">(</span>apsnd <span class="main">(</span>map_prod <span class="main">(</span><span class="main">λ</span><span class="bound">rpv</span><span class="main">.</span> case_exception <span class="main">(</span>Done <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span><span class="main">)</span>
                     <span class="main">(</span><span class="main">λ</span><span class="bound">input'</span><span class="main">.</span> map_gpv' <span class="main">(</span>case_option <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>OK <span class="bound">x</span><span class="main">,</span> obsf_converter <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> id option_of_exception <span class="main">(</span><span class="keyword1">TRY</span> gpv_stop <span class="main">(</span><span class="bound">rpv</span> <span class="bound">input'</span><span class="main">)</span> <span class="keyword1">ELSE</span> Done None<span class="main">)</span><span class="main">)</span><span class="main">)</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">rpv</span><span class="main">.</span> case_exception <span class="main">(</span>Done None<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">input'</span><span class="main">.</span> map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span><span class="bound">rpv</span> <span class="bound">input'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>inline1 run_converter <span class="skolem">gpv</span> <span class="skolem">conv</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> inline1_gpv_stop_obsf_converter<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> bind_spmf <span class="main">(</span>inline1 run_converter <span class="skolem">gpv</span> <span class="skolem">conv</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> return_spmf <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>map_sum <span class="main">(</span>apsnd obsf_converter<span class="main">)</span>
                     <span class="main">(</span>apsnd <span class="main">(</span>map_prod <span class="main">(</span><span class="main">λ</span><span class="bound">rpv</span><span class="main">.</span> case_exception <span class="main">(</span>Done <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">input'</span><span class="main">.</span> map_gpv' <span class="main">(</span>case_option <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>OK <span class="bound">x</span><span class="main">,</span> obsf_converter <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> id option_of_exception <span class="main">(</span><span class="keyword1">TRY</span> gpv_stop <span class="main">(</span><span class="bound">rpv</span> <span class="bound">input'</span><span class="main">)</span> <span class="keyword1">ELSE</span> Done None<span class="main">)</span><span class="main">)</span><span class="main">)</span>
                         <span class="main">(</span><span class="main">λ</span><span class="bound">rpv</span><span class="main">.</span> case_exception <span class="main">(</span>Done None<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">input'</span><span class="main">.</span> map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span><span class="bound">rpv</span> <span class="bound">input'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                     <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="var">?X</span> <span class="main">…</span> <span class="main">(</span>bind_spmf <span class="main">(</span>inline1 run_converter <span class="skolem">gpv</span> <span class="skolem">conv</span><span class="main">)</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_spmf <span class="main">(</span>map_generat id id <span class="main">(</span><span class="main">(∘)</span> <span class="main">(</span>case_sum id <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> bind_gpv <span class="bound">r</span> <span class="main">(</span>case_option Fail <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">conv</span><span class="main">)</span><span class="main">.</span> Done <span class="main">(</span>Some <span class="bound">x'</span><span class="main">,</span> obsf_converter <span class="bound">conv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span><span class="keyword1">case</span> map_generat id id <span class="main">(</span>map_fun option_of_exception <span class="main">(</span>map_gpv' id id option_of_exception<span class="main">)</span><span class="main">)</span>
                     <span class="main">(</span>map_generat Some id <span class="main">(</span><span class="main">λ</span><span class="bound">rpv</span><span class="main">.</span> case_option <span class="main">(</span>Done None<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">input'</span><span class="main">.</span> gpv_stop <span class="main">(</span><span class="bound">rpv</span> <span class="bound">input'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">x</span> <span class="main">⇒</span> Pure <span class="bound">x</span>
                        <span class="main">|</span> Inr <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">oracle</span><span class="main">,</span> <span class="bound">rpv</span><span class="main">)</span> <span class="main">⇒</span> IO <span class="bound">out</span> <span class="main">(</span><span class="main">λ</span><span class="bound">input</span><span class="main">.</span> bind_gpv <span class="main">(</span><span class="bound">oracle</span> <span class="bound">input</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> inline run_converter <span class="main">(</span><span class="bound">rpv</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span>
               Pure <span class="bound">x</span> <span class="main">⇒</span>
                 map_spmf <span class="main">(</span>map_generat id id <span class="main">(</span><span class="main">(∘)</span> Inl<span class="main">)</span><span class="main">)</span> <span class="main">(</span>the_gpv <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">conv</span><span class="main">)</span> <span class="main">⇒</span> Done <span class="main">(</span>Some <span class="bound">x'</span><span class="main">,</span> obsf_converter <span class="bound">conv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
               <span class="main">|</span> IO <span class="bound">out</span> <span class="bound">c</span> <span class="main">⇒</span> return_spmf <span class="main">(</span>IO <span class="bound">out</span> <span class="main">(</span><span class="main">λ</span><span class="bound">input</span><span class="main">.</span> Inr <span class="main">(</span><span class="bound">c</span> <span class="bound">input</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">_</span> <span class="main">_</span> <span class="var">?rhs2</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">_</span> <span class="main">(</span>bind_spmf <span class="main">_</span> <span class="var">?L</span><span class="main">)</span> <span class="main">(</span>bind_spmf <span class="main">_</span> <span class="var">?R</span><span class="main">)</span>"</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> rel_spmf_bind_reflI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> converter <span class="main">+</span> <span class="tfree">'d</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> converter<span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> rpv <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> rpv"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_spmf <span class="main">(</span>inline1 run_converter <span class="skolem">gpv</span> <span class="skolem">conv</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>Inl<span class="main">)</span> <span class="skolem">a</span> <span class="skolem">conv'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Inl <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">conv'</span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="main">(</span>Inr<span class="main">)</span> <span class="skolem">out</span> <span class="skolem">rpv</span> <span class="skolem">rpv'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">out</span><span class="main">,</span> <span class="skolem">rpv</span><span class="main">,</span> <span class="skolem">rpv'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="var">?X</span> <span class="main">(</span><span class="var">?L</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?R</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> Inr
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">gpv2</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> converter<span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span> exception<span class="main">)</span> gpv<span class="main">)</span> <span class="main">(</span><span class="bound">gpv2'</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> converter<span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span> exception<span class="main">)</span> gpv<span class="main">)</span> <span class="bound">f</span> <span class="bound">f'</span><span class="main">.</span>
           bind_gpv <span class="main">(</span>map_gpv' <span class="main">(</span>case_option <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>OK <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">,</span> obsf_converter <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> id option_of_exception <span class="main">(</span><span class="keyword1">TRY</span> gpv_stop <span class="main">(</span><span class="skolem">rpv</span> <span class="skolem">input</span><span class="main">)</span> <span class="keyword1">ELSE</span> Done None<span class="main">)</span><span class="main">)</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> fst <span class="bound">x</span> <span class="keyword1">of</span> Fault <span class="main">⇒</span> Fail <span class="main">|</span> OK <span class="bound">xa</span> <span class="main">⇒</span> bind_gpv <span class="main">(</span>inline run_converter <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span><span class="skolem">rpv'</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">case</span> fst <span class="bound">p</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> Done <span class="main">(</span>Some <span class="bound">x'</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             bind_gpv <span class="bound">gpv2</span> <span class="bound">f</span> <span class="main">∧</span>
           bind_gpv <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span><span class="skolem">rpv</span> <span class="skolem">input</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_option Fail <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bind_gpv <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span>inline run_converter <span class="main">(</span><span class="skolem">rpv'</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_option Fail <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> Done <span class="main">(</span>Some <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">,</span> obsf_converter <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             bind_gpv <span class="bound">gpv2'</span> <span class="bound">f'</span> <span class="main">∧</span>
           rel_gpv <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">gpv</span> <span class="bound">conv</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> bind_gpv <span class="main">(</span>inline run_converter <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="bound">gpv</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="bound">conv</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">case</span> fst <span class="bound">p</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> Done <span class="main">(</span>Some <span class="bound">x'</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
                     <span class="bound">f'</span> <span class="bound">y</span> <span class="main">=</span> bind_gpv <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span>inline run_converter <span class="bound">gpv</span> <span class="bound">conv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_option Fail <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> Done <span class="main">(</span>Some <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">,</span> obsf_converter <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(=)</span> <span class="bound">gpv2</span> <span class="bound">gpv2'</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">gpv2</span> <span class="bound">gpv2'</span> <span class="bound">f</span> <span class="bound">f'</span><span class="main">.</span> <span class="var">?lhs1</span> <span class="skolem">input</span> <span class="main">=</span> <span class="main">_</span> <span class="main">∧</span> <span class="var">?rhs1</span> <span class="skolem">input</span> <span class="main">=</span> <span class="main">_</span> <span class="main">∧</span> rel_gpv <span class="main">(</span><span class="var">?X</span> <span class="bound">f</span> <span class="bound">f'</span><span class="main">)</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">input</span> 
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gpv2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bind_gpv <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span><span class="keyword1">TRY</span> gpv_stop <span class="main">(</span><span class="skolem">rpv</span> <span class="skolem">input</span><span class="main">)</span> <span class="keyword1">ELSE</span> Done None<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> Done <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gpv2'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bind_gpv <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span><span class="skolem">rpv</span> <span class="skolem">input</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> Done <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bind_gpv <span class="main">(</span>inline run_converter <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span><span class="skolem">rpv'</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">case</span> fst <span class="bound">p</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> Done <span class="main">(</span>Some <span class="bound">x'</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bind_gpv <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span>inline run_converter <span class="main">(</span><span class="skolem">rpv'</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>case_option Fail <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> Done <span class="main">(</span>Some <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">,</span> obsf_converter <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs1</span> <span class="skolem">input</span> <span class="main">=</span> bind_gpv <span class="var">?gpv2</span> <span class="var">?f</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> map_gpv'_id12<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> trans<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> map_gpv'_map_gpv_swap<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_gpv o_def bind_gpv_assoc <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_gpv_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs1</span> <span class="skolem">input</span> <span class="main">=</span> bind_gpv <span class="var">?gpv2'</span> <span class="var">?f'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_gpv_assoc id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_gpv_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_gpv <span class="main">(</span><span class="var">?X</span> <span class="var">?f</span> <span class="var">?f'</span><span class="main">)</span> <span class="main">(=)</span> <span class="var">?gpv2</span> <span class="var">?gpv2'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Inr x
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map'_try_gpv id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> bind_try_Done_Fail <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gpv.rel_refl_strong<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Inr
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split exception.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def bind_gpv_assoc split_def map_gpv'_bind_gpv exception.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bind_gpv <span class="main">(</span>inline <span class="main">_</span> <span class="bound">x</span> <span class="main">_</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bind_gpv <span class="main">(</span>map_gpv' <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="bound">x</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> exception.case_cong option.case_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs2</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_gpv_sel' <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_gpv.sel map_bind_spmf inline_sel bind_map_spmf o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Observe_Failure-obsf_comp_converter"><span class="command">lemma</span></span> obsf_comp_converter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span><span class="main">,</span> <span class="free">ℐ''</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite1<span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">conv1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="free">ℐ</span><span class="main">,</span> exception_ℐ <span class="free">ℐ''</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> obsf_converter <span class="main">(</span>comp_converter <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span> <span class="main">∼</span> comp_converter <span class="main">(</span>obsf_converter <span class="free">conv1</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> WT pfinite1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> eq_ℐ_gpv_map_gpv<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> eq_ℐ_converter
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="var">?X</span> <span class="main">_</span> <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">(=)</span> <span class="main">(</span>exception_ℐ <span class="free">ℐ''</span><span class="main">)</span> <span class="var">?rhs</span> <span class="main">(</span><span class="keyword1">TRY</span> map_gpv <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv1'</span><span class="main">)</span><span class="main">,</span> <span class="bound">conv2'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv1'</span> <span class="main">⊙</span> <span class="bound">conv2'</span><span class="main">)</span><span class="main">)</span> id
               <span class="main">(</span>inline run_converter
                 <span class="main">(</span>map_gpv'
                   <span class="main">(</span>case_option <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span>
                     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>OK <span class="bound">x</span><span class="main">,</span> obsf_converter <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                   id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span>run_converter <span class="skolem">conv1</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">(</span>obsf_converter <span class="skolem">conv2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> Done <span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?rhs2</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">(</span>try_gpv <span class="main">(</span>map_gpv <span class="var">?f</span> <span class="main">_</span> <span class="var">?inline</span><span class="main">)</span> <span class="var">?else</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> eq_ℐ_converter
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> run_colossless_converter.inline_try_gpv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"exception_ℐ <span class="free">ℐ'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> pfinite_gpv_stop<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD pfinite_converterD colossless_converterD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"bind_gpv <span class="main">(</span>inline run_converter <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span>run_converter <span class="skolem">conv1</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="skolem">conv2</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> Done <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs2</span> <span class="main">=</span> try_gpv <span class="main">(</span>map_gpv <span class="var">?f</span> id
       <span class="main">(</span>map_gpv <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">xo</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xo</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">|</span> Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>OK <span class="bound">x</span><span class="main">,</span> obsf_converter <span class="bound">conv</span><span class="main">)</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span> id
         <span class="main">(</span>bind_gpv <span class="main">(</span>inline run_converter <span class="main">(</span>map_gpv' id id option_of_exception <span class="main">(</span>gpv_stop <span class="main">(</span>run_converter <span class="skolem">conv1</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="skolem">conv2</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Fail <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> Done <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="var">?else</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_gpv_bind_gpv gpv.map_id<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> try_gpv_bind_gpv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map_gpv <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"fst"</span></span><span class="main"><span class="main">]</span></span> option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> try_gpv <span class="bound">x</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> option.case_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Done</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> map_gpv_conv_bind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_try_gpv gpv.map_comp o_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> try_gpv_cong<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> map_gpv'_id12<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> map_gpv'_map_gpv_swap<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inline_map_gpv gpv.map_comp id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> gpv.map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> try_gpv <span class="main">(</span>map_gpv <span class="var">?f</span> id
       <span class="main">(</span>map_gpv <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">xo</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xo</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>Fault<span class="main">,</span> const_converter Fault<span class="main">)</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">|</span> Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">conv</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>OK <span class="bound">x</span><span class="main">,</span> obsf_converter <span class="bound">conv</span><span class="main">)</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span> id 
<span class="main">(</span>bind_gpv
                <span class="main">(</span>map_gpv' id id option_of_exception
                  <span class="main">(</span>gpv_stop <span class="main">(</span>inline run_converter <span class="main">(</span>run_converter <span class="skolem">conv1</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">conv2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                <span class="main">(</span>case_option Fail
                  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">conv</span><span class="main">)</span><span class="main">.</span>
                      Done
                       <span class="main">(</span>Some <span class="bound">x'</span><span class="main">,</span>
                        obsf_converter
                         <span class="bound">conv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?else</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> inline_gpv_stop_obsf_converter<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="var">?X</span> <span class="main">(</span>exception_ℐ <span class="free">ℐ''</span><span class="main">)</span> <span class="var">?lhs</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_ℐ_converter
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_gpv_bind_gpv gpv.map_id<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> try_gpv_bind_gpv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map_gpv <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"fst"</span></span><span class="main"><span class="main">]</span></span> option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> try_gpv <span class="bound">x</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> option.case_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Done</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> map_gpv_conv_bind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_try_gpv gpv.map_comp o_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_gpv_try_gpv_cong<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> map_gpv'_id12<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> map_gpv'_map_gpv_swap<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_map_gpv id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> map_gpv_conv_map_gpv'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> gpv_stop_map'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> option.map_id0<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> map_gpv_conv_map_gpv'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> map_gpv'_map_gpv_swap<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_map_gpv id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_gpv_reflI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> notE<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> results_gpv_stop_SomeD<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> imageI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> run_converter.results_gpv_inline<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> WT_converterD<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> WT_converterD_results<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI conjI refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> run_converter.results_gpv_inline<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> WT_converterD<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> WT_converterD_results<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> run_converter.results_gpv_inline<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> WT_converterD<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pfinite_converterD<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> run_converter.WT_gpv_inline_invar<span class="main"><span class="keyword3">|</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> WT_converterD<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>eq_ℐ_gpv_eq_OO2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Observe_Failure-resource_of_obsf_oracle_Fault"><span class="command">lemma</span></span> resource_of_obsf_oracle_Fault <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"resource_of_oracle <span class="main">(</span>obsf_oracle <span class="free">oracle</span><span class="main">)</span> Fault <span class="main">=</span> const_resource Fault"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def<span class="main">)</span>

<span class="keyword1" id="Observe_Failure-obsf_resource_of_oracle"><span class="command">lemma</span></span> obsf_resource_of_oracle <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obsf_resource <span class="main">(</span>resource_of_oracle <span class="free">oracle</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> resource_of_oracle <span class="main">(</span>obsf_oracle <span class="free">oracle</span><span class="main">)</span> <span class="main">(</span>OK <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> resource.coinduct_strong<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def map_try_spmf spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_try_spmf rel_spmf_reflI<span class="main">)</span>

<span class="keyword1" id="Observe_Failure-trace_callee_eq_obsf_Fault"><span class="command">lemma</span></span> trace_callee_eq_obsf_Fault <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> obsf_oracle <span class="free">callee1</span><span class="main">(</span>Fault<span class="main">)</span> <span class="main">≈</span> obsf_oracle <span class="free">callee2</span><span class="main">(</span>Fault<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_callee_eq_coinduct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Observe_Failure-obsf_resource_eq_ℐ_cong"><span class="command">lemma</span></span> obsf_resource_eq_ℐ_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> obsf_resource <span class="free">res1</span> <span class="main">∼</span> obsf_resource <span class="free">res2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res1</span> <span class="main">∼</span> <span class="free">res2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res1</span></span> <span class="quoted"><span class="free">res2</span></span><span class="main">)</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_try_spmf <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_mono <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_resource_onD<span class="main">)</span>

<span class="keyword1" id="Observe_Failure-trace_callee_eq_obsf_oracleI"><span class="command">lemma</span></span> trace_callee_eq_obsf_oracleI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="main">(</span>obsf_oracle <span class="free">callee1</span><span class="main">)</span> <span class="main">(</span>obsf_oracle <span class="free">callee2</span><span class="main">)</span> <span class="free">A</span> <span class="main">(</span>try_spmf <span class="main">(</span>map_spmf OK <span class="free">p</span><span class="main">)</span> <span class="main">(</span>return_spmf Fault<span class="main">)</span><span class="main">)</span> <span class="main">(</span>try_spmf <span class="main">(</span>map_spmf OK <span class="free">q</span><span class="main">)</span> <span class="main">(</span>return_spmf Fault<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_callee_eq_coinduct_strong<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">z</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Some Fault <span class="main">|</span> Some <span class="bound">y</span> <span class="main">⇒</span> Some <span class="main">(</span>OK <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee1</span> <span class="bound">s'</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def try_spmf_def bind_assoc_pmf map_bind_pmf bind_map_pmf bind_return_pmf option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map_pmf <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">return_pmf</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> map_pmf_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> pmf.map_comp o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> pmf.map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee1</span> <span class="bound">s'</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee2</span> <span class="bound">s'</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> trace_callee_eqD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> step<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Some Fault <span class="main">|</span> Some <span class="bound">y</span> <span class="main">⇒</span> Some <span class="main">(</span>OK <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def try_spmf_def bind_assoc_pmf map_bind_pmf bind_map_pmf bind_return_pmf option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map_pmf <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">return_pmf</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> map_pmf_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> pmf.map_comp o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> pmf.map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sim <span class="skolem">x</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">ye</span> <span class="skolem">s1'</span> <span class="skolem">s2'</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"bind_spmf <span class="main">(</span>try_spmf <span class="main">(</span>map_spmf OK <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>return_spmf Fault<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> obsf_oracle <span class="free">callee1</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> 
     try_spmf <span class="main">(</span>bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf <span class="main">(</span>map_prod OK OK<span class="main">)</span> <span class="main">(</span><span class="free">callee1</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span>Fault<span class="main">,</span> Fault<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def try_spmf_def bind_assoc_pmf bind_map_pmf bind_return_pmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"bind_spmf <span class="main">(</span>try_spmf <span class="main">(</span>map_spmf OK <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>return_spmf Fault<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> obsf_oracle <span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> 
     try_spmf <span class="main">(</span>bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf <span class="main">(</span>map_prod OK OK<span class="main">)</span> <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span>Fault<span class="main">,</span> Fault<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def try_spmf_def bind_assoc_pmf bind_map_pmf bind_return_pmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_pmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ye</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Fault
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf <span class="main">(</span>map_prod OK OK<span class="main">)</span> <span class="main">(</span><span class="free">callee1</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> lossless_spmf <span class="main">(</span>bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf <span class="main">(</span>map_prod OK OK<span class="main">)</span> <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sim<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> trace_callee_eqD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"lossless_spmf"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> sim<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eq</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq1 eq2<span class="main">)</span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_try2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>OK <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> eq3<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set_spmf <span class="main">(</span>bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set_spmf <span class="main">(</span>bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> trace_callee_eqD<span class="main">[</span><span class="operator">OF</span> sim<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ sim<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"set_spmf"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION image_UN <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> equalityI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> fst <span class="main">`</span> set_spmf <span class="main">(</span>bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> eq4<span class="main">:</span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf <span class="main">(</span>apfst OK<span class="main">)</span> <span class="main">(</span><span class="free">callee1</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>OK <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
        <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf <span class="main">(</span>apfst OK<span class="main">)</span> <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>OK <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fold</span> map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_map_inj<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?sim</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> eq1 eq2
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_try1<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf <span class="main">(</span>apfst OK<span class="main">)</span> <span class="main">(</span><span class="free">callee1</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ye</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf <span class="main">(</span>apfst OK<span class="main">)</span> <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ye</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> try_spmf_lossless<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">unfolding</span></span> eq3 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION image_UN <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rev_bexI rev_image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION image_UN <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rev_bexI rev_image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_cond_spmf_fst map_bind_spmf o_def spmf.map_comp map_prod_def split_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq4<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> trace_callee_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> xs z
          <span class="keyword1"><span class="command">using</span></span> sim<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> trace_callee_eqD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> sim<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> eq3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> fst <span class="main">`</span> set_spmf <span class="main">(</span>bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_eq_return_None<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Observe_Failure-trace_callee_eq'_obsf_resourceI"><span class="command">lemma</span></span> trace_callee_eq'_obsf_resourceI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">" <span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">callee1</span><span class="main">(</span><span class="free">s</span><span class="main">)</span> <span class="main">≈</span> <span class="free">callee2</span><span class="main">(</span><span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> obsf_oracle <span class="free">callee1</span><span class="main">(</span>OK <span class="free">s</span><span class="main">)</span> <span class="main">≈</span> obsf_oracle <span class="free">callee2</span><span class="main">(</span>OK <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">THEN</span> trace_callee_eq_obsf_oracleI<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Observe_Failure-trace_eq_obsf_resourceI"><span class="command">lemma</span></span> trace_eq_obsf_resourceI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res1</span> <span class="main">≈</span> <span class="free">res2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> obsf_resource <span class="free">res1</span> <span class="main">≈</span> obsf_resource <span class="free">res2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2 4<span class="main"><span class="main">)</span></span> resource_of_oracle_run_resource<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> resource_of_oracle_run_resource<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> trace_callee_eq'_obsf_resourceI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resource_of_oracle_run_resource<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Observe_Failure-spmf_run_obsf_oracle_obsf_distinguisher"><span class="command">lemma</span></span> spmf_run_obsf_oracle_obsf_distinguisher <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">eg1</span> <span class="main">≡</span> exec_gpv"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">eg2</span> <span class="main">≡</span> exec_gpv"</span></span> <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>map_spmf fst <span class="main">(</span><span class="free">eg1</span> <span class="main">(</span>obsf_oracle <span class="free">oracle</span><span class="main">)</span> <span class="main">(</span>obsf_distinguisher <span class="free">gpv</span><span class="main">)</span> <span class="main">(</span>OK <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">=</span>
   spmf <span class="main">(</span>map_spmf fst <span class="main">(</span><span class="free">eg2</span> <span class="free">oracle</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> True"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eg1_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec_gpv_fixp_induct_strong<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">exec_gpv'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> eg2_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> exec_gpv.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsf_distinguisher_def bind_map_spmf map_bind_spmf o_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> spmf_bind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integral_mono<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> measure_spmf.integrable_const_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_le_1<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> measure_spmf.integrable_const_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_le_1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> generat.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> try_spmf_def bind_spmf_pmf_assoc bind_map_pmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> pmf_bind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integral_mono<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> measure_pmf.integrable_const_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_le_1<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> measure_pmf.integrable_const_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_le_1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_return_pmf<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> step.hyps<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> ord_spmf_map_spmfI<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> ord_spmf_eq_leD<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> eg2_def obsf_distinguisher_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">≤</span> <span class="var">?lhs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eg2_def 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec_gpv_fixp_induct_strong<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">exec_gpv'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> eg1_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> exec_gpv.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsf_distinguisher_def bind_map_spmf map_bind_spmf o_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> spmf_bind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integral_mono<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> measure_spmf.integrable_const_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_le_1<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> measure_spmf.integrable_const_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_le_1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> generat.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> try_spmf_def bind_spmf_pmf_assoc bind_map_pmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> pmf_bind<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integral_mono<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> measure_pmf.integrable_const_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_le_1<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> measure_pmf.integrable_const_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_le_1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_return_pmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> eg1_def obsf_distinguisher_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Observe_Failure-spmf_obsf_distinguisher_obsf_resource_True"><span class="command">lemma</span></span> spmf_obsf_distinguisher_obsf_resource_True<span class="main">:</span>
  <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>connect_obsf <span class="main">(</span>obsf_distinguisher <span class="free">𝒜</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">res</span><span class="main">)</span><span class="main">)</span> True <span class="main">=</span> spmf <span class="main">(</span>connect <span class="free">𝒜</span> <span class="free">res</span><span class="main">)</span> True"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> connect_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> resource_of_oracle_run_resource<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exec_gpv_resource_of_oracle spmf.map_comp spmf_run_obsf_oracle_obsf_distinguisher<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Observe_Failure-advantage_obsf_distinguisher"><span class="command">lemma</span></span> advantage_obsf_distinguisher<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"advantage <span class="main">(</span>obsf_distinguisher <span class="free">𝒜</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">ideal_resource</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">real_resource</span><span class="main">)</span> <span class="main">=</span>
   advantage <span class="free">𝒜</span> <span class="free">ideal_resource</span> <span class="free">real_resource</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> advantage_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_obsf_distinguisher_obsf_resource_True<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Fold_Spmf">
<div class="head">
<h1>Theory Fold_Spmf</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Fold_Spmf
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#More_CC">More_CC</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span>transfer<span class="main">)</span> 
  <span class="entity">foldl_spmf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> spmf<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> spmf <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> spmf"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    foldl_spmf_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">foldl_spmf</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
  <span class="main">|</span> foldl_spmf_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">foldl_spmf</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">foldl_spmf</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_return_pmf_None"><span class="command">lemma</span></span> foldl_spmf_return_pmf_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl_spmf <span class="free">f</span> <span class="main">(</span>return_pmf None<span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> return_pmf None"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_bind_spmf"><span class="command">lemma</span></span> foldl_spmf_bind_spmf<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl_spmf <span class="free">f</span> <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> bind_spmf <span class="free">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> foldl_spmf <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Fold_Spmf-bind_foldl_spmf_return"><span class="command">lemma</span></span> bind_foldl_spmf_return<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bind_spmf <span class="free">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> foldl_spmf <span class="free">f</span> <span class="main">(</span>return_spmf <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> foldl_spmf <span class="free">f</span> <span class="free">p</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_spmf_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_map"><span class="command">lemma</span></span> foldl_spmf_map <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"foldl_spmf <span class="free">f</span> <span class="free">p</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> foldl_spmf <span class="main">(</span>map_fun id <span class="main">(</span>map_fun <span class="free">g</span> id<span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="free">p</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1" id="Fold_Spmf-foldl_spmf_identity"><span class="command">lemma</span></span> foldl_spmf_identity <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> return_spmf <span class="bound">s</span><span class="main">)</span> <span class="free">p</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_conv_foldl"><span class="command">lemma</span></span> foldl_spmf_conv_foldl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> return_spmf <span class="main">(</span><span class="free">f</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="free">xs</span> <span class="main">=</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> foldl <span class="free">f</span> <span class="bound">s</span> <span class="free">xs</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> spmf.map_comp o_def<span class="main">)</span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_Cons'"><span class="command">lemma</span></span> foldl_spmf_Cons'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl_spmf <span class="free">f</span> <span class="main">(</span>return_spmf <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="main">(</span><span class="free">f</span> <span class="free">a</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> foldl_spmf <span class="free">f</span> <span class="main">(</span>return_spmf <span class="bound">a'</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_foldl_spmf_return<span class="main">)</span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_append"><span class="command">lemma</span></span> foldl_spmf_append<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl_spmf <span class="free">f</span> <span class="free">p</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> foldl_spmf <span class="free">f</span> <span class="main">(</span>foldl_spmf <span class="free">f</span> <span class="free">p</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_helper"><span class="command">lemma</span></span> 
  foldl_spmf_helper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">e</span><span class="main">.</span> map_spmf <span class="free">h</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="free">acc</span> <span class="free">es</span> <span class="main">=</span> 
    map_spmf <span class="free">h</span> <span class="main">(</span>foldl_spmf <span class="free">g</span> <span class="main">(</span>map_spmf <span class="free">f</span> <span class="free">acc</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">acc</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">es</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp map_bind_spmf bind_map_spmf o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main">)</span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_helper2"><span class="command">lemma</span></span> 
  foldl_spmf_helper2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">q</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">e</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">q</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="free">acc</span> <span class="free">es</span> <span class="main">=</span> 
    bind_spmf <span class="free">acc</span> <span class="main">(</span><span class="main">λ</span><span class="bound">acc'</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="bound">acc'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="free">g</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">q</span> <span class="bound">acc'</span><span class="main">)</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">acc</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> spmf.map_comp map_bind_spmf bind_map_spmf o_def
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">es</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf assms<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_spmf_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_foldl_spmf_return<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Fold_Spmf-foldl_pair_constl"><span class="command">lemma</span></span> foldl_pair_constl<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">e</span><span class="main">.</span> map_prod <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">f</span> <span class="bound">r</span> <span class="bound">e</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">sr</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> 
    Pair <span class="free">c</span> <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span> <span class="free">sr</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">sr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_prod_def split_def<span class="main">)</span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_pair_left"><span class="command">lemma</span></span> foldl_spmf_pair_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">e</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">(</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">es</span> <span class="main">=</span> 
    map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">(</span><span class="bound">l'</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="free">f</span> <span class="main">(</span>return_spmf <span class="free">l</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> map_spmf_conv_bind_spmf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldl_spmf_bind_spmf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_foldl_spmf_return<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main">)</span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_pair_left2"><span class="command">lemma</span></span> foldl_spmf_pair_left2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="bound">e</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">(</span><span class="bound">l'</span><span class="main">,</span> <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">l</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="free">es</span> <span class="main">=</span> 
    map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">(</span><span class="bound">l'</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free">es</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free">c</span> <span class="keyword1">else</span> <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="free">f</span> <span class="main">(</span>return_spmf <span class="free">l</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> map_spmf_conv_bind_spmf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldl_spmf_bind_spmf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_foldl_spmf_return<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main">)</span>

<span class="keyword1" id="Fold_Spmf-foldl_pair_constr"><span class="command">lemma</span></span> foldl_pair_constr<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">e</span><span class="main">.</span> map_prod <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">sl</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> 
   Pair <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span> <span class="free">sl</span> <span class="free">l</span><span class="main">)</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">sl</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_prod_def split_def<span class="main">)</span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_pair_right"><span class="command">lemma</span></span> foldl_spmf_pair_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">e</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">r</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">es</span> <span class="main">=</span> 
    map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="free">f</span> <span class="main">(</span>return_spmf <span class="free">r</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> map_spmf_conv_bind_spmf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldl_spmf_bind_spmf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_foldl_spmf_return<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main">)</span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_pair_right2"><span class="command">lemma</span></span> foldl_spmf_pair_right2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">e</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">r</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">es</span> <span class="main">=</span> 
    map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">es</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free">c</span> <span class="keyword1">else</span> <span class="free">c'</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="free">f</span> <span class="main">(</span>return_spmf <span class="free">r</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> map_spmf_conv_bind_spmf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldl_spmf_bind_spmf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_foldl_spmf_return<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf split_def<span class="main">)</span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_pair_right3"><span class="command">lemma</span></span> foldl_spmf_pair_right3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">e</span><span class="main">.</span> map_spmf <span class="main">(</span>Pair <span class="main">(</span><span class="free">g</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">r</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">es</span> <span class="main">=</span> 
    map_spmf <span class="main">(</span>Pair <span class="main">(</span><span class="keyword1">if</span> <span class="free">es</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free">l</span> <span class="keyword1">else</span> <span class="free">g</span> <span class="main">(</span>last <span class="free">es</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="free">f</span> <span class="main">(</span>return_spmf <span class="free">r</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> map_spmf_conv_bind_spmf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldl_spmf_bind_spmf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_foldl_spmf_return<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def map_bind_spmf o_def<span class="main">)</span>

<span class="keyword1" id="Fold_Spmf-foldl_pullout"><span class="command">lemma</span></span> foldl_pullout<span class="main">:</span> <span class="quoted"><span class="quoted">"bind_spmf <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bind_spmf <span class="main">(</span>foldl_spmf <span class="free">g</span> <span class="free">init</span> <span class="main">(</span><span class="free">events</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    bind_spmf <span class="main">(</span>bind_spmf <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">e</span><span class="main">.</span> map_spmf <span class="main">(</span>Pair <span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">r</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_spmf <span class="main">(</span>Pair <span class="bound">x</span><span class="main">)</span> <span class="free">init</span><span class="main">)</span> <span class="main">(</span><span class="free">events</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">init</span> <span class="free">events</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_spmf_helper2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Pair</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">fst</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">snd</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> split_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_spmf_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_foldl_spmf_return<span class="main">)</span>
  
<span class="keyword1" id="Fold_Spmf-bind_foldl_spmf_pair_append"><span class="command">lemma</span></span> bind_foldl_spmf_pair_append<span class="main">:</span> <span class="quoted"><span class="quoted">"
  bind_spmf
    <span class="main">(</span>foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">e</span><span class="main">.</span> map_spmf <span class="main">(</span>apfst <span class="main">(</span><span class="main">(@)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="free">c</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span>
  bind_spmf
    <span class="main">(</span>foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">e</span><span class="main">.</span> map_spmf <span class="main">(</span>apfst <span class="main">(</span><span class="main">(@)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def map_spmf_conv_bind_spmf apfst_def map_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> foldl_spmf_bind_spmf<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Fold_Spmf-foldl_spmf_chain"><span class="command">lemma</span></span> foldl_spmf_chain<span class="main">:</span> <span class="quoted"><span class="quoted">"
<span class="main">(</span>foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">oevents</span><span class="main">,</span> <span class="bound">s_event</span><span class="main">)</span> <span class="bound">event</span><span class="main">.</span> map_spmf <span class="main">(</span>map_prod <span class="main">(</span><span class="main">(@)</span> <span class="bound">oevents</span><span class="main">)</span> id<span class="main">)</span> <span class="main">(</span><span class="free">fff</span> <span class="bound">s_event</span> <span class="bound">event</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">s_event</span><span class="main">)</span><span class="main">)</span> <span class="free">ievents</span><span class="main">)</span> 
  <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">oevents</span><span class="main">,</span> <span class="bound">s_event'</span><span class="main">)</span><span class="main">.</span> foldl_spmf <span class="free">ggg</span> <span class="main">(</span>return_spmf <span class="free">s_core</span><span class="main">)</span> <span class="bound">oevents</span> 
        <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s_core'</span><span class="main">.</span> return_spmf <span class="main">(</span><span class="free">f</span> <span class="bound">s_core'</span> <span class="bound">s_event'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_event</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">event</span><span class="main">.</span> <span class="free">fff</span> <span class="bound">s_event</span> <span class="bound">event</span> <span class="main">⤜</span>  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">oevents</span><span class="main">,</span> <span class="bound">s_event'</span><span class="main">)</span><span class="main">.</span>
      map_spmf <span class="main">(</span>Pair <span class="bound">s_event'</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="free">ggg</span> <span class="main">(</span>return_spmf <span class="bound">s_core</span><span class="main">)</span> <span class="bound">oevents</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">s_event</span><span class="main">,</span> <span class="free">s_core</span><span class="main">)</span><span class="main">)</span> <span class="free">ievents</span>
  <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_event'</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> return_spmf <span class="main">(</span><span class="free">f</span> <span class="bound">s_core'</span> <span class="bound">s_event'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ievents</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s_event</span></span> <span class="quoted"><span class="free">s_core</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">es</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> foldl_spmf_Cons'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_spmf_conv_bind_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> map_spmf_conv_bind_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Cons.IH<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> o_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> foldl_spmf_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> map_spmf_conv_bind_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_spmf_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_prod_def split_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_foldl_spmf_pair_append<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> es<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">es</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> apfst_def map_prod_def append_Nil2 split_def id_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">― ‹pauses›</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">pauses</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span>unit<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> gpv"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pauses</span> <span class="main">[]</span> <span class="main">=</span> Done <span class="main">()</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pauses</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Pause <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">pauses</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Fold_Spmf-WT_gpv_pauses"><span class="command">lemma</span></span> WT_gpv_pauses <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> pauses <span class="free">xs</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Fold_Spmf-exec_gpv_pauses"><span class="command">lemma</span></span> exec_gpv_pauses<span class="main">:</span>
  <span class="quoted"><span class="quoted">"exec_gpv <span class="free">callee</span> <span class="main">(</span>pauses <span class="free">xs</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span>
   map_spmf <span class="main">(</span>Pair <span class="main">()</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="main">(</span>map_fun id <span class="main">(</span>map_fun id <span class="main">(</span>map_spmf snd<span class="main">)</span><span class="main">)</span> <span class="free">callee</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="free">s</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def foldl_spmf_Cons' map_bind_spmf bind_map_spmf o_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> foldl_spmf_Cons<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Fused_Resource">
<div class="head">
<h1>Theory Fused_Resource</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Fused_Resource <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Fold_Spmf">Fold_Spmf</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* TODO: move these somewhere *)</span>
<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> ℐ.lifting <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> eℐ <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ℐ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">ℐ</span> <span class="bound">x</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Fused_Resource-outs_ℐ_eℐ"><span class="command">lemma</span></span> outs_ℐ_eℐ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="main">(</span>eℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">=</span> outs_ℐ <span class="free">ℐ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Fused_Resource-responses_ℐ_eℐ"><span class="command">lemma</span></span> responses_ℐ_eℐ <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"responses_ℐ <span class="main">(</span>eℐ <span class="free">ℐ</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> responses_ℐ <span class="free">ℐ</span> <span class="free">x</span> <span class="main">×</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1" id="Fused_Resource-eℐ_map_ℐ"><span class="command">lemma</span></span> eℐ_map_ℐ<span class="main">:</span> <span class="quoted"><span class="quoted">"eℐ <span class="main">(</span>map_ℐ <span class="free">f</span> <span class="free">g</span> <span class="free">ℐ</span><span class="main">)</span> <span class="main">=</span> map_ℐ <span class="free">f</span> <span class="main">(</span>apfst <span class="free">g</span><span class="main">)</span> <span class="main">(</span>eℐ <span class="free">ℐ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-eℐ_inverse"><span class="command">lemma</span></span> eℐ_inverse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_ℐ id fst <span class="main">(</span>eℐ <span class="free">ℐ</span><span class="main">)</span> <span class="main">=</span> <span class="free">ℐ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">lifting_update</span></span> ℐ.lifting
<span class="keyword1"><span class="command">lifting_forget</span></span> ℐ.lifting


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Fused Resource›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Event Oracles -- they generate events›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'input</span><span class="main">,</span> <span class="tfree">'output</span><span class="main">)</span> eoracle <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'input</span><span class="main">,</span> <span class="tfree">'output</span> <span class="main">×</span> <span class="tfree">'event</span> list<span class="main">)</span> oracle'"</span></span> 

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">parallel_eoracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="tfree">'s1</span><span class="main">,</span> <span class="tfree">'e1</span><span class="main">,</span> <span class="tfree">'i1</span><span class="main">,</span> <span class="tfree">'o1</span><span class="main">)</span> eoracle <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s2</span><span class="main">,</span> <span class="tfree">'e2</span><span class="main">,</span> <span class="tfree">'i2</span><span class="main">,</span> <span class="tfree">'o2</span><span class="main">)</span> eoracle <span class="main">⇒</span>
      <span class="main">(</span><span class="tfree">'s1</span> <span class="main">×</span> <span class="tfree">'s2</span><span class="main">,</span> <span class="tfree">'e1</span> <span class="main">+</span> <span class="tfree">'e2</span><span class="main">,</span> <span class="tfree">'i1</span> <span class="main">+</span> <span class="tfree">'i2</span><span class="main">,</span> <span class="tfree">'o1</span> <span class="main">+</span> <span class="tfree">'o2</span><span class="main">)</span> eoracle"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">parallel_eoracle</span> <span class="free"><span class="bound"><span class="entity">eoracle1</span></span></span> <span class="free"><span class="bound"><span class="entity">eoracle2</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">≡</span>
       comp
        <span class="main">(</span>map_spmf 
          <span class="main">(</span>map_prod 
            <span class="main">(</span>case_sum 
              <span class="main">(</span>map_prod Inl <span class="main">(</span>map Inl<span class="main">)</span><span class="main">)</span> 
              <span class="main">(</span>map_prod Inr <span class="main">(</span>map Inr<span class="main">)</span><span class="main">)</span><span class="main">)</span> 
            id<span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>parallel_oracle <span class="free"><span class="bound"><span class="entity">eoracle1</span></span></span> <span class="free"><span class="bound"><span class="entity">eoracle2</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">plus_eoracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e1</span><span class="main">,</span> <span class="tfree">'i1</span><span class="main">,</span> <span class="tfree">'o1</span><span class="main">)</span> eoracle <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e2</span><span class="main">,</span> <span class="tfree">'i2</span><span class="main">,</span> <span class="tfree">'o2</span><span class="main">)</span> eoracle <span class="main">⇒</span>
      <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e1</span> <span class="main">+</span> <span class="tfree">'e2</span><span class="main">,</span> <span class="tfree">'i1</span> <span class="main">+</span> <span class="tfree">'i2</span><span class="main">,</span> <span class="tfree">'o1</span> <span class="main">+</span> <span class="tfree">'o2</span><span class="main">)</span> eoracle"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">plus_eoracle</span> <span class="free"><span class="bound"><span class="entity">eoracle1</span></span></span> <span class="free"><span class="bound"><span class="entity">eoracle2</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">≡</span>
       comp
        <span class="main">(</span>map_spmf 
          <span class="main">(</span>map_prod 
            <span class="main">(</span>case_sum 
              <span class="main">(</span>map_prod Inl <span class="main">(</span>map Inl<span class="main">)</span><span class="main">)</span> 
              <span class="main">(</span>map_prod Inr <span class="main">(</span>map Inr<span class="main">)</span><span class="main">)</span><span class="main">)</span> 
            id<span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>plus_oracle <span class="free"><span class="bound"><span class="entity">eoracle1</span></span></span> <span class="free"><span class="bound"><span class="entity">eoracle2</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">translate_eoracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="tfree">'s_event</span><span class="main">,</span> <span class="tfree">'e1</span><span class="main">,</span> <span class="tfree">'e2</span> list<span class="main">)</span> oracle' <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s_event</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e1</span><span class="main">,</span> <span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> eoracle <span class="main">⇒</span>
      <span class="main">(</span><span class="tfree">'s_event</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e2</span><span class="main">,</span> <span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> eoracle"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">translate_eoracle</span> <span class="free"><span class="bound"><span class="entity">translator</span></span></span> <span class="free"><span class="bound"><span class="entity">eoracle</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">inp</span></span></span> <span class="main">≡</span> 
      bind_spmf
        <span class="main">(</span><span class="free"><span class="bound"><span class="entity">eoracle</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">inp</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">e_in</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span>
          <span class="keyword1">let</span> <span class="bound">conc</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">es</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span> <span class="bound">e</span><span class="main">.</span> map_spmf <span class="main">(</span>map_prod <span class="main">(</span><span class="main">(@)</span> <span class="bound">es</span><span class="main">)</span> id<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">translator</span></span></span> <span class="bound">st</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="main">(</span><span class="bound">e_out</span><span class="main">,</span> <span class="bound">s_event</span><span class="main">)</span> <span class="main">←</span> foldl_spmf <span class="bound">conc</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">[]</span><span class="main">,</span> fst <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">e_in</span><span class="main">;</span>
          return_spmf <span class="main">(</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">e_out</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_event</span><span class="main">,</span> snd <span class="bound">s</span><span class="main">)</span>
        <span class="main">}</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Event Handlers -- they absorb (and silently handle) events›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">)</span> handler <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'event</span> <span class="main">⇒</span> <span class="tfree">'state</span> spmf"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">parallel_handler</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s1</span><span class="main">,</span> <span class="tfree">'e1</span><span class="main">)</span> handler <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s2</span><span class="main">,</span> <span class="tfree">'e2</span><span class="main">)</span> handler <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s1</span> <span class="main">×</span> <span class="tfree">'s2</span><span class="main">,</span> <span class="tfree">'e1</span> <span class="main">+</span> <span class="tfree">'e2</span><span class="main">)</span> handler"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">parallel_handler</span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">=</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s1'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">parallel_handler</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s2'</span><span class="main">.</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="bound">s2'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">plus_handler</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e1</span><span class="main">)</span> handler <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e2</span><span class="main">)</span> handler <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e1</span> <span class="main">+</span> <span class="tfree">'e2</span><span class="main">)</span> handler"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">plus_handler</span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> case_sum <span class="main">(</span><span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Fused_Resource-parallel_handler_left"><span class="command">lemma</span></span> parallel_handler_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_fun id <span class="main">(</span>map_fun Inl id<span class="main">)</span> <span class="main">(</span>parallel_handler <span class="free">left</span> <span class="free">right</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_l</span><span class="main">,</span> <span class="bound">s_r</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s_l'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s_l'</span><span class="main">,</span> <span class="bound">s_r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">left</span> <span class="bound">s_l</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Fused_Resource-parallel_handler_right"><span class="command">lemma</span></span> parallel_handler_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_fun id <span class="main">(</span>map_fun Inr id<span class="main">)</span> <span class="main">(</span>parallel_handler <span class="free">left</span> <span class="free">right</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_l</span><span class="main">,</span> <span class="bound">s_r</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s_r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s_l</span><span class="main">,</span> <span class="bound">s_r'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">right</span> <span class="bound">s_r</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Fused_Resource-in_set_spmf_parallel_handler"><span class="command">lemma</span></span> in_set_spmf_parallel_handler<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">∈</span> set_spmf <span class="main">(</span>parallel_handler <span class="free">left</span> <span class="free">right</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> Inl <span class="bound">e</span> <span class="main">⇒</span> fst <span class="free">s'</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">left</span> <span class="main">(</span>fst <span class="free">s</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∧</span> snd <span class="free">s'</span> <span class="main">=</span> snd <span class="free">s</span>
    <span class="main">|</span> Inr <span class="bound">e</span> <span class="main">⇒</span> snd <span class="free">s'</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">right</span> <span class="main">(</span>snd <span class="free">s</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∧</span> fst <span class="free">s'</span> <span class="main">=</span> fst <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">s'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Fused Resource Construction›</span></span>

<span class="keyword1"><span class="command">codatatype</span></span> 
  <span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core <span class="main">=</span>
    Core
      <span class="main">(</span><span class="free"><span class="entity">cpoke</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">)</span> handler"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="free"><span class="entity">cfunc_adv</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">)</span> oracle'"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="free"><span class="entity">cfunc_usr</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> oracle'"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> core.sel_transfer<span class="main">[</span><span class="operator">transfer_rule</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> core.ctr_transfer<span class="main">[</span><span class="operator">transfer_rule</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> core.case_transfer<span class="main">[</span><span class="operator">transfer_rule</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> 
  <span class="entity">rel_core'</span><span class="main">::</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="tfree">'s_core</span> <span class="main">⇒</span> <span class="tfree">'s_core'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'event</span> <span class="main">⇒</span> <span class="tfree">'event'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'iadv_core</span> <span class="main">⇒</span> <span class="tfree">'iadv_core'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="tfree">'iusr_core</span> <span class="main">⇒</span> <span class="tfree">'iusr_core'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'oadv_core</span> <span class="main">⇒</span> <span class="tfree">'oadv_core'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'ousr_core</span> <span class="main">⇒</span> <span class="tfree">'ousr_core'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'s_core'</span><span class="main">,</span> <span class="tfree">'event'</span><span class="main">,</span> <span class="tfree">'iadv_core'</span><span class="main">,</span> <span class="tfree">'iusr_core'</span><span class="main">,</span> <span class="tfree">'oadv_core'</span><span class="main">,</span> <span class="tfree">'ousr_core'</span><span class="main">)</span> core <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">S</span> <span class="entity">E</span> <span class="entity">IA</span> <span class="entity">IU</span> <span class="entity">OA</span> <span class="entity">OU</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rel_core'</span> <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="main">(</span>Core <span class="free"><span class="bound"><span class="entity">cpoke</span></span></span> <span class="free"><span class="bound"><span class="entity">cfunc_adv</span></span></span> <span class="free"><span class="bound"><span class="entity">cfunc_usr</span></span></span><span class="main">)</span> <span class="main">(</span>Core <span class="free"><span class="bound"><span class="entity">cpoke'</span></span></span> <span class="free"><span class="bound"><span class="entity">cfunc_adv'</span></span></span> <span class="free"><span class="bound"><span class="entity">cfunc_usr'</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">E</span> <span class="main">===&gt;</span> rel_spmf <span class="free">S</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cpoke</span></span></span> <span class="free"><span class="bound"><span class="entity">cpoke'</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IA</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">OA</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cfunc_adv</span></span></span> <span class="free"><span class="bound"><span class="entity">cfunc_adv'</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IU</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">OU</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cfunc_usr</span></span></span> <span class="free"><span class="bound"><span class="entity">cfunc_usr'</span></span></span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">cpoke</span> <span class="free">cfunc_adv</span> <span class="free">cfunc_usr</span>

<span class="keyword1"><span class="command">inductive_simps</span></span> 
  rel_core'_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"rel_core' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="main">(</span>Core <span class="free">cpoke'</span> <span class="free">cfunc_adv'</span> <span class="free">cfunc_usr'</span><span class="main">)</span> <span class="main">(</span>Core <span class="free">cpoke''</span> <span class="free">cfunc_adv''</span> <span class="free">cfunc_usr''</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Fused_Resource-rel_core'_eq"><span class="command">lemma</span></span> 
  rel_core'_eq <span class="main">[</span><span class="operator">relator_eq</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_core' <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">=</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff rel_fun_def <span class="dynamic"><span class="dynamic">relator_eq</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Fused_Resource-rel_core'_mono"><span class="command">lemma</span></span> 
  rel_core'_mono <span class="main">[</span><span class="operator">relator_mono</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_core' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="main">≤</span> rel_core' <span class="free">S</span> <span class="free">E'</span> <span class="free">IA'</span> <span class="free">IU'</span> <span class="free">OA'</span> <span class="free">OU'</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">E'</span> <span class="main">≤</span> <span class="free">E</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">IA'</span> <span class="main">≤</span> <span class="free">IA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">IU'</span> <span class="main">≤</span> <span class="free">IU</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">OA</span> <span class="main">≤</span> <span class="free">OA'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">OU</span> <span class="main">≤</span> <span class="free">OU'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> predicate2I<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_fun_mono rel_spmf_mono prod.rel_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span>
        <span class="operator">rule</span> impI that order_refl <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> that<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> rel_spmf_mono <span class="main"><span class="keyword3">|</span></span> <span class="operator">assumption</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Fused_Resource-cpoke_parametric"><span class="command">lemma</span></span> 
  cpoke_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_core' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> <span class="free">E</span> <span class="main">===&gt;</span> rel_spmf <span class="free">S</span><span class="main">)</span> cpoke cpoke"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> rel_core'.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Fused_Resource-cfunc_adv_parametric"><span class="command">lemma</span></span> 
  cfunc_adv_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_core' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IA</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">OA</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> cfunc_adv cfunc_adv"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> rel_core'.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Fused_Resource-cfunc_usr_parametric"><span class="command">lemma</span></span> 
  cfunc_usr_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_core' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IU</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">OU</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> cfunc_usr cfunc_usr"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> rel_core'.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Fused_Resource-Core_parametric"><span class="command">lemma</span></span> 
  Core_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">E</span> <span class="main">===&gt;</span> rel_spmf <span class="free">S</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IA</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">OA</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IU</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">OU</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>
   <span class="main">===&gt;</span> rel_core' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span><span class="main">)</span> Core Core"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Fused_Resource-case_core_parametric"><span class="command">lemma</span></span> 
  case_core_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">E</span> <span class="main">===&gt;</span> rel_spmf <span class="free">S</span><span class="main">)</span> <span class="main">===&gt;</span> 
        <span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IA</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">OA</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> 
        <span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IU</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">OU</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="free">X</span><span class="main">)</span> <span class="main">===&gt;</span> 
      rel_core' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="main">===&gt;</span> <span class="free">X</span><span class="main">)</span> case_core case_core"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> core.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_funD<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-corec_core_parametric"><span class="command">lemma</span></span> 
  corec_core_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">X</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> <span class="free">E</span> <span class="main">===&gt;</span> rel_spmf <span class="free">S</span><span class="main">)</span> <span class="main">===&gt;</span> 
      <span class="main">(</span><span class="free">X</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IA</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">OA</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> 
      <span class="main">(</span><span class="free">X</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IU</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">OU</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> 
      <span class="free">X</span> <span class="main">===&gt;</span> rel_core' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span><span class="main">)</span> corec_core corec_core"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> core.corec <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_funD<span class="main">)</span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">map_core'</span> <span class="main">::</span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'event'</span> <span class="main">⇒</span> <span class="tfree">'event</span><span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'iadv_core'</span> <span class="main">⇒</span> <span class="tfree">'iadv_core</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="tfree">'iusr_core'</span> <span class="main">⇒</span> <span class="tfree">'iusr_core</span><span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'oadv_core</span> <span class="main">⇒</span> <span class="tfree">'oadv_core'</span><span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'ousr_core</span> <span class="main">⇒</span> <span class="tfree">'ousr_core'</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event'</span><span class="main">,</span> <span class="tfree">'iadv_core'</span><span class="main">,</span> <span class="tfree">'iusr_core'</span><span class="main">,</span> <span class="tfree">'oadv_core'</span><span class="main">,</span> <span class="tfree">'ousr_core'</span><span class="main">)</span> core"</span></span>
   <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"cpoke <span class="main">(</span><span class="free">map_core'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ia</span></span></span> <span class="free"><span class="bound"><span class="entity">iu</span></span></span> <span class="free"><span class="bound"><span class="entity">oa</span></span></span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span> <span class="free"><span class="bound"><span class="entity">core</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>id <span class="main">---&gt;</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">---&gt;</span> id<span class="main">)</span> <span class="main">(</span>cpoke <span class="free"><span class="bound"><span class="entity">core</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="main">(</span><span class="free">map_core'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ia</span></span></span> <span class="free"><span class="bound"><span class="entity">iu</span></span></span> <span class="free"><span class="bound"><span class="entity">oa</span></span></span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span> <span class="free"><span class="bound"><span class="entity">core</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>id <span class="main">---&gt;</span> <span class="free"><span class="bound"><span class="entity">ia</span></span></span> <span class="main">---&gt;</span> map_spmf <span class="main">(</span>map_prod <span class="free"><span class="bound"><span class="entity">oa</span></span></span> id<span class="main">)</span><span class="main">)</span> <span class="main">(</span>cfunc_adv <span class="free"><span class="bound"><span class="entity">core</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="main">(</span><span class="free">map_core'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ia</span></span></span> <span class="free"><span class="bound"><span class="entity">iu</span></span></span> <span class="free"><span class="bound"><span class="entity">oa</span></span></span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span> <span class="free"><span class="bound"><span class="entity">core</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>id <span class="main">---&gt;</span> <span class="free"><span class="bound"><span class="entity">iu</span></span></span> <span class="main">---&gt;</span> map_spmf <span class="main">(</span>map_prod <span class="free"><span class="bound"><span class="entity">ou</span></span></span> id<span class="main">)</span><span class="main">)</span> <span class="main">(</span>cfunc_usr <span class="free"><span class="bound"><span class="entity">core</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> map_core'_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> map_core'.ctr<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> core<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Core <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">parametric_constant</span></span> map_core'_parametric<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> map_core'_def

<span class="keyword1" id="Fused_Resource-core'_rel_Grp"><span class="command">lemma</span></span> core'_rel_Grp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_core' <span class="main">(=)</span> <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">e</span><span class="main">)</span><span class="main">¯¯</span> <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">ia</span><span class="main">)</span><span class="main">¯¯</span> <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">iu</span><span class="main">)</span><span class="main">¯¯</span> <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">oa</span><span class="main">)</span> <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">ou</span><span class="main">)</span>
   <span class="main">=</span> BNF_Def.Grp UNIV <span class="main">(</span>map_core' <span class="free">e</span> <span class="free">ia</span> <span class="free">iu</span> <span class="free">oa</span> <span class="free">ou</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2 4 6<span class="main"><span class="main">)</span></span> eq_alt_conversep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2 3 4<span class="main"><span class="main">)</span></span> eq_alt<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf.rel_Grp option.rel_Grp prod.rel_Grp rel_fun_conversep_grp_grp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_def spmf.map_id<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">WT_core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'iadv</span><span class="main">,</span> <span class="tfree">'oadv</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'iusr</span><span class="main">,</span> <span class="tfree">'ousr</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv</span><span class="main">,</span> <span class="tfree">'iusr</span><span class="main">,</span> <span class="tfree">'oadv</span><span class="main">,</span> <span class="tfree">'ousr</span><span class="main">)</span> core <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ℐ_adv</span> <span class="entity">ℐ_usr</span> <span class="entity">I</span> <span class="entity">core</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">WT_core</span> <span class="free">ℐ_adv</span> <span class="free">ℐ_usr</span> <span class="free">I</span> <span class="free">core</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">e</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">s'</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cpoke <span class="free">core</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cfunc_adv <span class="free">core</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ_adv</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ_adv</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cfunc_usr <span class="free">core</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ_usr</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ_usr</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span>"</span></span>

<span class="keyword1" id="Fused_Resource-WT_coreD"><span class="command">lemma</span></span> WT_coreD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"WT_core <span class="free">ℐ_adv</span> <span class="free">ℐ_usr</span> <span class="free">I</span> <span class="free">core</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> WT_coreD_cpoke<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">e</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">s'</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cpoke <span class="free">core</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_coreD_cfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cfunc_adv <span class="free">core</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ_adv</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ_adv</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_coreD_cfund_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cfunc_usr <span class="free">core</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ_usr</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ_usr</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_core.cases<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-WT_coreD_foldl_spmf_cpoke"><span class="command">lemma</span></span> WT_coreD_foldl_spmf_cpoke<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"WT_core <span class="free">ℐ_adv</span> <span class="free">ℐ_usr</span> <span class="free">I</span> <span class="free">core</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">∈</span> set_spmf <span class="main">(</span>foldl_spmf <span class="main">(</span>cpoke <span class="free">core</span><span class="main">)</span> <span class="free">p</span> <span class="free">es</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set_spmf <span class="free">p</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_coreD_cpoke<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Fused_Resource-WT_core_trivial"><span class="command">lemma</span></span> WT_core_trivial<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">ℐ_adv</span> <span class="keyword1">⊢c</span> cfunc_adv <span class="free">core</span> <span class="bound">s</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">ℐ_usr</span> <span class="keyword1">⊢c</span> cfunc_usr <span class="free">core</span> <span class="bound">s</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WT_core <span class="free">ℐ_adv</span> <span class="free">ℐ_usr</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">core</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_core.intros<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> WT_calleeD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">codatatype</span></span> 
  <span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> rest_scheme <span class="main">=</span>
    Rest
      <span class="main">(</span><span class="free"><span class="entity">rinit</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'more</span>"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="free"><span class="entity">rfunc_adv</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">)</span> eoracle"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="free"><span class="entity">rfunc_usr</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">)</span> eoracle"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> rest_scheme.sel_transfer<span class="main">[</span><span class="operator">transfer_rule</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> rest_scheme.ctr_transfer<span class="main">[</span><span class="operator">transfer_rule</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> rest_scheme.case_transfer<span class="main">[</span><span class="operator">transfer_rule</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> 
  <span class="entity">rel_rest'</span><span class="main">::</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="tfree">'s_rest</span> <span class="main">⇒</span> <span class="tfree">'s_rest'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'event</span> <span class="main">⇒</span> <span class="tfree">'event'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'iadv_rest</span> <span class="main">⇒</span> <span class="tfree">'iadv_rest'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="tfree">'iusr_rest</span> <span class="main">⇒</span> <span class="tfree">'iusr_rest'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'oadv_rest</span> <span class="main">⇒</span> <span class="tfree">'oadv_rest'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'ousr_rest</span> <span class="main">⇒</span> <span class="tfree">'ousr_rest'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="tfree">'more</span> <span class="main">⇒</span> <span class="tfree">'more'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> rest_scheme <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'s_rest'</span><span class="main">,</span> <span class="tfree">'event'</span><span class="main">,</span> <span class="tfree">'iadv_rest'</span><span class="main">,</span> <span class="tfree">'iusr_rest'</span><span class="main">,</span> <span class="tfree">'oadv_rest'</span><span class="main">,</span> <span class="tfree">'ousr_rest'</span><span class="main">,</span> <span class="tfree">'more'</span><span class="main">)</span> rest_scheme <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">S</span> <span class="entity">E</span> <span class="entity">IA</span> <span class="entity">IU</span> <span class="entity">OA</span> <span class="entity">OU</span> <span class="entity">M</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rel_rest'</span> <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="free">M</span> <span class="main">(</span>Rest <span class="free"><span class="bound"><span class="entity">rinit</span></span></span> <span class="free"><span class="bound"><span class="entity">rfunc_adv</span></span></span> <span class="free"><span class="bound"><span class="entity">rfunc_usr</span></span></span><span class="main">)</span> <span class="main">(</span>Rest <span class="free"><span class="bound"><span class="entity">rinit'</span></span></span> <span class="free"><span class="bound"><span class="entity">rfunc_adv'</span></span></span> <span class="free"><span class="bound"><span class="entity">rfunc_usr'</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="free"><span class="bound"><span class="entity">rinit</span></span></span> <span class="free"><span class="bound"><span class="entity">rinit'</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IA</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(</span>rel_prod <span class="free">OA</span> <span class="main">(</span>list_all2 <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rfunc_adv</span></span></span> <span class="free"><span class="bound"><span class="entity">rfunc_adv'</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IU</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(</span>rel_prod <span class="free">OU</span> <span class="main">(</span>list_all2 <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rfunc_usr</span></span></span> <span class="free"><span class="bound"><span class="entity">rfunc_usr'</span></span></span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">rinit</span> <span class="free">rfunc_adv</span> <span class="free">rfunc_usr</span>

<span class="keyword1"><span class="command">inductive_simps</span></span> 
  rel_rest'_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"rel_rest' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="free">M</span> <span class="main">(</span>Rest <span class="free">rinit'</span> <span class="free">rfunc_adv'</span> <span class="free">rfunc_usr'</span><span class="main">)</span> <span class="main">(</span>Rest <span class="free">rinit''</span> <span class="free">rfunc_adv''</span> <span class="free">rfunc_usr''</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Fused_Resource-rel_rest'_eq"><span class="command">lemma</span></span> 
  rel_rest'_eq <span class="main">[</span><span class="operator">relator_eq</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_rest' <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">=</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff rel_fun_def <span class="dynamic"><span class="dynamic">relator_eq</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Fused_Resource-rel_rest'_mono"><span class="command">lemma</span></span> 
  rel_rest'_mono <span class="main">[</span><span class="operator">relator_mono</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_rest' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="free">M</span> <span class="main">≤</span> rel_rest' <span class="free">S</span> <span class="free">E'</span> <span class="free">IA'</span> <span class="free">IU'</span> <span class="free">OA'</span> <span class="free">OU'</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">≤</span> <span class="free">E'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">IA'</span> <span class="main">≤</span> <span class="free">IA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">IU'</span> <span class="main">≤</span> <span class="free">IU</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">OA</span> <span class="main">≤</span> <span class="free">OA'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">OU</span> <span class="main">≤</span> <span class="free">OU'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="free">M'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> predicate2I<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_fun_mono rel_spmf_mono prod.rel_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span>
        <span class="operator">rule</span> impI that order_refl prod.rel_mono list.rel_mono <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> that<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> rel_spmf_mono <span class="main"><span class="keyword3">|</span></span> <span class="operator">assumption</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Fused_Resource-rel_rest'_sel"><span class="command">lemma</span></span> rel_rest'_sel<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_rest' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="free">M</span> <span class="free">rest1</span> <span class="free">rest2</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">(</span>rinit <span class="free">rest1</span><span class="main">)</span> <span class="main">(</span>rinit <span class="free">rest2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IA</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(</span>rel_prod <span class="free">OA</span> <span class="main">(</span>list_all2 <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_adv <span class="free">rest1</span><span class="main">)</span> <span class="main">(</span>rfunc_adv <span class="free">rest2</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IU</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(</span>rel_prod <span class="free">OU</span> <span class="main">(</span>list_all2 <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_usr <span class="free">rest1</span><span class="main">)</span> <span class="main">(</span>rfunc_usr <span class="free">rest2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">rest1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">rest2</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Fused_Resource-rinit_parametric"><span class="command">lemma</span></span> rinit_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_rest' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="free">M</span> <span class="main">===&gt;</span> <span class="free">M</span><span class="main">)</span> rinit rinit"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> rel_rest'.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Fused_Resource-rfunc_adv_parametric"><span class="command">lemma</span></span> rfunc_adv_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_rest' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="free">M</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IA</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(</span>rel_prod <span class="free">OA</span> <span class="main">(</span>list_all2 <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> rfunc_adv rfunc_adv"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> rel_rest'.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Fused_Resource-rfunc_usr_parametric"><span class="command">lemma</span></span> rfunc_usr_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_rest' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="free">M</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IU</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(</span>rel_prod <span class="free">OU</span> <span class="main">(</span>list_all2 <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> rfunc_usr rfunc_usr"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> rel_rest'.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Fused_Resource-Rest_parametric"><span class="command">lemma</span></span> Rest_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IA</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(</span>rel_prod <span class="free">OA</span> <span class="main">(</span>list_all2 <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>
    <span class="main">===&gt;</span> <span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IU</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(</span>rel_prod <span class="free">OU</span> <span class="main">(</span>list_all2 <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>
   <span class="main">===&gt;</span> rel_rest' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="free">M</span><span class="main">)</span> Rest Rest"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Fused_Resource-case_rest_scheme_parametric"><span class="command">lemma</span></span> case_rest_scheme_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">===&gt;</span> 
    <span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IA</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(</span>rel_prod <span class="free">OA</span> <span class="main">(</span>list_all2 <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> 
    <span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IU</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(</span>rel_prod <span class="free">OU</span> <span class="main">(</span>list_all2 <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="free">X</span><span class="main">)</span> <span class="main">===&gt;</span> 
  rel_rest' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="free">M</span> <span class="main">===&gt;</span> <span class="free">X</span><span class="main">)</span> case_rest_scheme case_rest_scheme"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> rest_scheme.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_funD<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-corec_rest_scheme_parametric"><span class="command">lemma</span></span> corec_rest_scheme_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">X</span> <span class="main">===&gt;</span> <span class="free">M</span><span class="main">)</span> <span class="main">===&gt;</span> 
      <span class="main">(</span><span class="free">X</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IA</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(</span>rel_prod <span class="free">OA</span> <span class="main">(</span>list_all2 <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> 
      <span class="main">(</span><span class="free">X</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> <span class="free">IU</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(</span>rel_prod <span class="free">OU</span> <span class="main">(</span>list_all2 <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> 
      <span class="free">X</span> <span class="main">===&gt;</span> rel_rest' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">OA</span> <span class="free">OU</span> <span class="free">M</span><span class="main">)</span> corec_rest_scheme corec_rest_scheme"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rest_scheme.corec <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_funD<span class="main">)</span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">map_rest'</span> <span class="main">::</span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'event</span> <span class="main">⇒</span> <span class="tfree">'event'</span><span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'iadv_rest'</span> <span class="main">⇒</span> <span class="tfree">'iadv_rest</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="tfree">'iusr_rest'</span> <span class="main">⇒</span> <span class="tfree">'iusr_rest</span><span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'oadv_rest</span> <span class="main">⇒</span> <span class="tfree">'oadv_rest'</span><span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'ousr_rest</span> <span class="main">⇒</span> <span class="tfree">'ousr_rest'</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="tfree">'more</span> <span class="main">⇒</span> <span class="tfree">'more'</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> rest_scheme <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event'</span><span class="main">,</span> <span class="tfree">'iadv_rest'</span><span class="main">,</span> <span class="tfree">'iusr_rest'</span><span class="main">,</span> <span class="tfree">'oadv_rest'</span><span class="main">,</span> <span class="tfree">'ousr_rest'</span><span class="main">,</span> <span class="tfree">'more'</span><span class="main">)</span> rest_scheme"</span></span>
   <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"rinit <span class="main">(</span><span class="free">map_rest'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ia</span></span></span> <span class="free"><span class="bound"><span class="entity">iu</span></span></span> <span class="free"><span class="bound"><span class="entity">oa</span></span></span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>rinit <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="main">(</span><span class="free">map_rest'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ia</span></span></span> <span class="free"><span class="bound"><span class="entity">iu</span></span></span> <span class="free"><span class="bound"><span class="entity">oa</span></span></span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span>id <span class="main">---&gt;</span> <span class="free"><span class="bound"><span class="entity">ia</span></span></span> <span class="main">---&gt;</span> map_spmf <span class="main">(</span>map_prod <span class="main">(</span>map_prod <span class="free"><span class="bound"><span class="entity">oa</span></span></span> <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> id<span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_adv <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="main">(</span><span class="free">map_rest'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ia</span></span></span> <span class="free"><span class="bound"><span class="entity">iu</span></span></span> <span class="free"><span class="bound"><span class="entity">oa</span></span></span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span>id <span class="main">---&gt;</span> <span class="free"><span class="bound"><span class="entity">iu</span></span></span> <span class="main">---&gt;</span> map_spmf <span class="main">(</span>map_prod <span class="main">(</span>map_prod <span class="free"><span class="bound"><span class="entity">ou</span></span></span> <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> id<span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_usr <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> map_rest'_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> map_rest'.ctr<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> rest<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Rest <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">parametric_constant</span></span> map_rest'_parametric<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> map_rest'_def

<span class="keyword1" id="Fused_Resource-rest'_rel_Grp"><span class="command">lemma</span></span> rest'_rel_Grp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_rest' <span class="main">(=)</span> <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">e</span><span class="main">)</span> <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">ia</span><span class="main">)</span><span class="main">¯¯</span> <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">iu</span><span class="main">)</span><span class="main">¯¯</span> <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">oa</span><span class="main">)</span> <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">ou</span><span class="main">)</span> <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">m</span><span class="main">)</span>
   <span class="main">=</span> BNF_Def.Grp UNIV <span class="main">(</span>map_rest' <span class="free">e</span> <span class="free">ia</span> <span class="free">iu</span> <span class="free">oa</span> <span class="free">ou</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2 4<span class="main"><span class="main">)</span></span> eq_alt_conversep<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2 3<span class="main"><span class="main">)</span></span> eq_alt<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf.rel_Grp list.rel_Grp option.rel_Grp prod.rel_Grp rel_fun_conversep_grp_grp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_def spmf.map_id<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  <span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">)</span> rest_wstate <span class="main">=</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'s_rest</span><span class="main">)</span> rest_scheme"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">WT_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'iadv</span><span class="main">,</span> <span class="tfree">'oadv</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'iusr</span><span class="main">,</span> <span class="tfree">'ousr</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv</span><span class="main">,</span> <span class="tfree">'iusr</span><span class="main">,</span> <span class="tfree">'oadv</span><span class="main">,</span> <span class="tfree">'ousr</span><span class="main">)</span> rest_wstate <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ℐ_adv</span> <span class="entity">ℐ_usr</span> <span class="entity">I</span> <span class="entity">rest</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">WT_rest</span> <span class="free">ℐ_adv</span> <span class="free">ℐ_usr</span> <span class="free">I</span> <span class="free">rest</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">es</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>rfunc_adv <span class="free">rest</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ_adv</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ_adv</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">es</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>rfunc_usr <span class="free">rest</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ_usr</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ_usr</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>rinit <span class="free">rest</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Fused_Resource-WT_restD"><span class="command">lemma</span></span> WT_restD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv</span> <span class="free">ℐ_usr</span> <span class="free">I</span> <span class="free">rest</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> WT_restD_rfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">es</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>rfunc_adv <span class="free">rest</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ_adv</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ_adv</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_restD_rfunc_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">es</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>rfunc_usr <span class="free">rest</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ_usr</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ_usr</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_restD_rinit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>rinit <span class="free">rest</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_rest.cases<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">fuse_cfunc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="tfree">'o</span> <span class="main">⇒</span> <span class="tfree">'x</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> oracle' <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s_core</span> <span class="main">×</span> <span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'i</span> <span class="main">,</span> <span class="tfree">'x</span><span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fuse_cfunc</span> <span class="free"><span class="bound"><span class="entity">redirect</span></span></span> <span class="free"><span class="bound"><span class="entity">cfunc</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">inp</span></span></span>  <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="bound">handle</span> <span class="main">=</span> map_prod <span class="free"><span class="bound"><span class="entity">redirect</span></span></span> <span class="main">(</span>prod.swap <span class="keyword1">o</span> Pair <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">os_cfunc</span> <span class="main">::</span> <span class="tfree">'o</span> <span class="main">×</span> <span class="tfree">'s_core</span><span class="main">)</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">cfunc</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">inp</span></span></span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">handle</span> <span class="bound">os_cfunc</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">fuse_rfunc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="tfree">'o</span> <span class="main">⇒</span> <span class="tfree">'x</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> eoracle <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> handler <span class="main">⇒</span> 
      <span class="main">(</span><span class="tfree">'s_core</span> <span class="main">×</span> <span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'i</span> <span class="main">,</span> <span class="tfree">'x</span><span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fuse_rfunc</span> <span class="free"><span class="bound"><span class="entity">redirect</span></span></span> <span class="free"><span class="bound"><span class="entity">rfunc</span></span></span> <span class="free"><span class="bound"><span class="entity">notify</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">inp</span></span></span> <span class="main">≡</span> 
    bind_spmf 
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rfunc</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">inp</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">o_rfunc</span><span class="main">,</span> <span class="bound">e_lst</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_rfunc</span><span class="main">)</span><span class="main">.</span> 
        bind_spmf 
          <span class="main">(</span>foldl_spmf <span class="free"><span class="bound"><span class="entity">notify</span></span></span> <span class="main">(</span>return_spmf <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">e_lst</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">s_notify</span><span class="main">.</span> return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">redirect</span></span></span> <span class="bound">o_rfunc</span><span class="main">,</span> <span class="bound">s_notify</span><span class="main">,</span> <span class="bound">s_rfunc</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  "</span></span>


<span class="keyword1"><span class="command">locale</span></span> fused_resource <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="free">core_init</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s_core</span></span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">fuse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> rest_scheme <span class="main">⇒</span>
    <span class="main">(</span><span class="tfree">'s_core</span> <span class="main">×</span> <span class="tfree">'s_rest</span><span class="main">,</span> 
      <span class="main">(</span><span class="tfree">'iadv_core</span> <span class="main">+</span> <span class="tfree">'iadv_rest</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'iusr_core</span> <span class="main">+</span> <span class="tfree">'iusr_rest</span><span class="main">)</span><span class="main">,</span>  
      <span class="main">(</span><span class="tfree">'oadv_core</span> <span class="main">+</span> <span class="tfree">'oadv_rest</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'ousr_core</span> <span class="main">+</span> <span class="tfree">'ousr_rest</span><span class="main">)</span><span class="main">)</span> oracle'"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">fuse</span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>Inl <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">iadv_core</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      fuse_cfunc <span class="main">(</span>Inl <span class="keyword1">o</span> Inl<span class="main">)</span> <span class="main">(</span>cfunc_adv <span class="free">core</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">iadv_core</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fuse</span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>Inl <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">iadv_rest</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      fuse_rfunc <span class="main">(</span>Inl <span class="keyword1">o</span> Inr<span class="main">)</span> <span class="main">(</span>rfunc_adv <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">)</span> <span class="main">(</span>cpoke <span class="free">core</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">iadv_rest</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fuse</span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">iusr_core</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      fuse_cfunc <span class="main">(</span>Inr <span class="keyword1">o</span> Inl<span class="main">)</span> <span class="main">(</span>cfunc_usr <span class="free">core</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">iusr_core</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fuse</span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">iusr_rest</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      fuse_rfunc <span class="main">(</span>Inr <span class="keyword1">o</span> Inr<span class="main">)</span> <span class="main">(</span>rfunc_usr <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">)</span> <span class="main">(</span>cpoke <span class="free">core</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="free"><span class="bound"><span class="entity">iusr_rest</span></span></span>"</span></span>

<span class="keyword1"><span class="command">case_of_simps</span></span> fuse_case<span class="main">:</span> fused_resource.fuse.simps

<span class="keyword1" id="Fused_Resource-callee_invariant_on_fuse"><span class="command">lemma</span></span> callee_invariant_on_fuse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"WT_core <span class="free">ℐ_adv_core</span> <span class="free">ℐ_usr_core</span> <span class="free">I_core</span> <span class="free">core</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_rest</span> <span class="free">ℐ_usr_rest</span> <span class="free">I_rest</span> <span class="free">rest</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>fuse <span class="free">rest</span><span class="main">)</span> <span class="main">(</span>pred_prod <span class="free">I_core</span> <span class="free">I_rest</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">ℐ_adv_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_rest</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_usr_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_rest</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_restD WT_coreD WT_coreD_foldl_spmf_cpoke<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y s' <span class="keyword1"><span class="command">using</span></span> 2 assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">rest</span><span class="main">,</span> <span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fuse.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pred_prod_beta <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_restD WT_coreD <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">)</span> rest_wstate <span class="main">⇒</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'iadv_core</span> <span class="main">+</span> <span class="tfree">'iadv_rest</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'iusr_core</span> <span class="main">+</span> <span class="tfree">'iusr_rest</span><span class="main">)</span><span class="main">,</span>
      <span class="main">(</span><span class="tfree">'oadv_core</span> <span class="main">+</span> <span class="tfree">'oadv_rest</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'ousr_core</span> <span class="main">+</span> <span class="tfree">'ousr_rest</span><span class="main">)</span><span class="main">)</span> resource"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">resource</span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span> <span class="main">=</span> resource_of_oracle <span class="main">(</span>fuse <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">core_init</span><span class="main">,</span> rinit <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Fused_Resource-WT_resource"><span class="command">lemma</span></span> WT_resource <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"WT_core <span class="free">ℐ_adv_core</span> <span class="free">ℐ_usr_core</span> <span class="free">I_core</span> <span class="free">core</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_rest</span> <span class="free">ℐ_usr_rest</span> <span class="free">I_rest</span> <span class="free">rest</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I_core</span> <span class="free">core_init</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℐ_adv_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_rest</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_usr_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_rest</span><span class="main">)</span> <span class="keyword1">⊢res</span> resource <span class="free">rest</span> <span class="main">√</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> callee_invariant_on <span class="quoted"><span class="quoted">"fuse <span class="free">rest</span>"</span></span> <span class="quoted"><span class="quoted">"pred_prod <span class="free">I_core</span> <span class="free">I_rest</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℐ_adv_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_rest</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_usr_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_rest</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on_fuse<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> resource_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_resource_of_oracle<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> WT_restD_rinit<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">parametric_constant</span></span> 
  fuse_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> fused_resource.fuse_case

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹More helpful construction functions›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">core1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core1</span><span class="main">,</span> <span class="tfree">'event1</span><span class="main">,</span> <span class="tfree">'iadv_core1</span><span class="main">,</span> <span class="tfree">'iusr_core1</span><span class="main">,</span> <span class="tfree">'oadv_core1</span><span class="main">,</span> <span class="tfree">'ousr_core1</span><span class="main">)</span> core"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">core2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core2</span><span class="main">,</span> <span class="tfree">'event2</span><span class="main">,</span> <span class="tfree">'iadv_core2</span><span class="main">,</span> <span class="tfree">'iusr_core2</span><span class="main">,</span> <span class="tfree">'oadv_core2</span><span class="main">,</span> <span class="tfree">'ousr_core2</span><span class="main">)</span> core"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">parallel_core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="tfree">'s_core1</span> <span class="main">×</span> <span class="tfree">'s_core2</span><span class="main">,</span> <span class="tfree">'event1</span> <span class="main">+</span> <span class="tfree">'event2</span><span class="main">,</span> 
   <span class="tfree">'iadv_core1</span> <span class="main">+</span> <span class="tfree">'iadv_core2</span><span class="main">,</span> <span class="tfree">'iusr_core1</span> <span class="main">+</span> <span class="tfree">'iusr_core2</span><span class="main">,</span>
   <span class="tfree">'oadv_core1</span> <span class="main">+</span> <span class="tfree">'oadv_core2</span><span class="main">,</span> <span class="tfree">'ousr_core1</span> <span class="main">+</span> <span class="tfree">'ousr_core2</span><span class="main">)</span> core"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"cpoke <span class="free">parallel_core</span> <span class="main">=</span> parallel_handler <span class="main">(</span>cpoke <span class="free">core1</span><span class="main">)</span> <span class="main">(</span>cpoke <span class="free">core2</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">parallel_core</span> <span class="main">=</span> parallel_oracle <span class="main">(</span>cfunc_adv <span class="free">core1</span><span class="main">)</span> <span class="main">(</span>cfunc_adv <span class="free">core2</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">parallel_core</span> <span class="main">=</span> parallel_oracle <span class="main">(</span>cfunc_usr <span class="free">core1</span><span class="main">)</span> <span class="main">(</span>cfunc_usr <span class="free">core2</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">cnv_adv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s_adv</span> <span class="main">⇒</span> <span class="tfree">'iadv</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oadv</span> <span class="main">×</span> <span class="tfree">'s_adv</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">)</span> gpv"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">cnv_usr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s_usr</span> <span class="main">⇒</span> <span class="tfree">'iusr</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ousr</span> <span class="main">×</span> <span class="tfree">'s_usr</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> gpv"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> 
  <span class="entity">attach_core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s_adv</span> <span class="main">×</span> <span class="tfree">'s_usr</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv</span><span class="main">,</span> <span class="tfree">'iusr</span><span class="main">,</span> <span class="tfree">'oadv</span><span class="main">,</span> <span class="tfree">'ousr</span><span class="main">)</span> core"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"cpoke <span class="free">attach_core</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_advusr</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">event</span><span class="main">.</span> 
      map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s_core'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s_advusr</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cpoke <span class="free">core</span> <span class="bound">s_core</span> <span class="bound">event</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">attach_core</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s_adv</span><span class="main">,</span> <span class="bound">s_usr</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">iadv</span><span class="main">.</span> 
      map_spmf 
        <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">oadv</span><span class="main">,</span> <span class="bound">s_adv'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">oadv</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="bound">s_adv'</span><span class="main">,</span> <span class="bound">s_usr</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">(</span>exec_gpv <span class="main">(</span>cfunc_adv <span class="free">core</span><span class="main">)</span> <span class="main">(</span><span class="free">cnv_adv</span> <span class="bound">s_adv</span> <span class="bound">iadv</span><span class="main">)</span> <span class="bound">s_core</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">attach_core</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s_adv</span><span class="main">,</span> <span class="bound">s_usr</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">iusr</span><span class="main">.</span> 
      map_spmf 
        <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">ousr</span><span class="main">,</span> <span class="bound">s_usr'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">ousr</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="bound">s_adv</span><span class="main">,</span> <span class="bound">s_usr'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">(</span>exec_gpv <span class="main">(</span>cfunc_usr <span class="free">core</span><span class="main">)</span> <span class="main">(</span><span class="free">cnv_usr</span> <span class="bound">s_usr</span> <span class="bound">iusr</span><span class="main">)</span> <span class="bound">s_core</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1" id="Fused_Resource-attach_core_id_oracle_adv"><span class="command">lemma</span></span> 
  attach_core_id_oracle_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="main">(</span>attach_core <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">cnv</span> <span class="free">core</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_cnv</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s_cnv</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cfunc_adv <span class="free">core</span> <span class="bound">s_core</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_oracle_def split_def map_spmf_conv_bind_spmf<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-attach_core_id_oracle_usr"><span class="command">lemma</span></span> 
  attach_core_id_oracle_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="main">(</span>attach_core <span class="free">cnv</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">core</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_cnv</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s_cnv</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cfunc_usr <span class="free">core</span> <span class="bound">s_core</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_oracle_def split_def map_spmf_conv_bind_spmf<span class="main">)</span>


<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">rest1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest1</span><span class="main">,</span> <span class="tfree">'event1</span><span class="main">,</span> <span class="tfree">'iadv_rest1</span><span class="main">,</span> <span class="tfree">'iusr_rest1</span><span class="main">,</span> <span class="tfree">'oadv_rest1</span><span class="main">,</span> <span class="tfree">'ousr_rest1</span><span class="main">,</span> <span class="tfree">'more1</span><span class="main">)</span> rest_scheme"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">rest2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest2</span><span class="main">,</span> <span class="tfree">'event2</span><span class="main">,</span> <span class="tfree">'iadv_rest2</span><span class="main">,</span> <span class="tfree">'iusr_rest2</span><span class="main">,</span> <span class="tfree">'oadv_rest2</span><span class="main">,</span> <span class="tfree">'ousr_rest2</span><span class="main">,</span> <span class="tfree">'more2</span><span class="main">)</span> rest_scheme"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">parallel_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="tfree">'s_rest1</span> <span class="main">×</span> <span class="tfree">'s_rest2</span><span class="main">,</span> <span class="tfree">'event1</span> <span class="main">+</span> <span class="tfree">'event2</span><span class="main">,</span> <span class="tfree">'iadv_rest1</span> <span class="main">+</span> <span class="tfree">'iadv_rest2</span><span class="main">,</span> <span class="tfree">'iusr_rest1</span> <span class="main">+</span> <span class="tfree">'iusr_rest2</span><span class="main">,</span> 
     <span class="tfree">'oadv_rest1</span> <span class="main">+</span> <span class="tfree">'oadv_rest2</span><span class="main">,</span> <span class="tfree">'ousr_rest1</span> <span class="main">+</span> <span class="tfree">'ousr_rest2</span><span class="main">,</span> <span class="tfree">'more1</span> <span class="main">×</span> <span class="tfree">'more2</span><span class="main">)</span> rest_scheme"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"rinit <span class="free">parallel_rest</span> <span class="main">=</span> <span class="main">(</span>rinit <span class="free">rest1</span><span class="main">,</span> rinit <span class="free">rest2</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="free">parallel_rest</span> <span class="main">=</span> parallel_eoracle <span class="main">(</span>rfunc_adv <span class="free">rest1</span><span class="main">)</span> <span class="main">(</span>rfunc_adv <span class="free">rest2</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="free">parallel_rest</span> <span class="main">=</span> parallel_eoracle <span class="main">(</span>rfunc_usr <span class="free">rest1</span><span class="main">)</span> <span class="main">(</span>rfunc_usr <span class="free">rest2</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Fused_Resource-WT_parallel_rest"><span class="command">lemma</span></span> WT_parallel_rest <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"WT_rest <span class="main">(</span><span class="free">ℐ_adv1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_usr1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr2</span><span class="main">)</span> <span class="main">(</span>pred_prod <span class="free">I1</span> <span class="free">I2</span><span class="main">)</span> <span class="main">(</span>parallel_rest <span class="free">rest1</span> <span class="free">rest2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv1</span> <span class="free">ℐ_usr1</span> <span class="free">I1</span> <span class="free">rest1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv2</span> <span class="free">ℐ_usr2</span> <span class="free">I2</span> <span class="free">rest2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_rest.intros<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_eoracle_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> WT_restD_rinit<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> that<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> WT_restD_rfunc_adv<span class="main"><span class="main">]</span></span> that<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> WT_restD_rfunc_usr<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">cnv_adv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s_adv</span> <span class="main">⇒</span> <span class="tfree">'iadv</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oadv</span> <span class="main">×</span> <span class="tfree">'s_adv</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">)</span> gpv"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">cnv_usr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s_usr</span> <span class="main">⇒</span> <span class="tfree">'iusr</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ousr</span> <span class="main">×</span> <span class="tfree">'s_usr</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">)</span> gpv"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">f_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'more</span> <span class="main">⇒</span> <span class="tfree">'more'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> rest_scheme"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> 
  <span class="entity">attach_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="main">(</span><span class="tfree">'s_adv</span> <span class="main">×</span> <span class="tfree">'s_usr</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv</span><span class="main">,</span> <span class="tfree">'iusr</span><span class="main">,</span> <span class="tfree">'oadv</span><span class="main">,</span> <span class="tfree">'ousr</span><span class="main">,</span> <span class="tfree">'more'</span><span class="main">)</span> rest_scheme"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"rinit <span class="free">attach_rest</span> <span class="main">=</span> <span class="free">f_init</span> <span class="main">(</span>rinit <span class="free">rest</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="free">attach_rest</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s_adv</span><span class="main">,</span> <span class="bound">s_usr</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span> <span class="bound">iadv</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="bound">orc_of</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">orc</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">es</span> <span class="main">@</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">orc</span> <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">eorc_of</span> <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">oadv</span><span class="main">,</span> <span class="bound">s_adv'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_rest'</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">oadv</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="bound">s_adv'</span><span class="main">,</span> <span class="bound">s_usr</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_rest'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      map_spmf <span class="bound">eorc_of</span> <span class="main">(</span>exec_gpv <span class="main">(</span><span class="bound">orc_of</span> <span class="main">(</span>rfunc_adv <span class="free">rest</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnv_adv</span> <span class="bound">s_adv</span> <span class="bound">iadv</span><span class="main">)</span> <span class="main">(</span><span class="bound">s_rest</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="free">attach_rest</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s_adv</span><span class="main">,</span> <span class="bound">s_usr</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span> <span class="bound">iusr</span><span class="main">.</span> 
      <span class="keyword1">let</span> <span class="bound">orc_of</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">orc</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">es</span> <span class="main">@</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">orc</span> <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">eorc_of</span> <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">ousr</span><span class="main">,</span> <span class="bound">s_usr'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_rest'</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">ousr</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="bound">s_adv</span><span class="main">,</span> <span class="bound">s_usr'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_rest'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      map_spmf <span class="bound">eorc_of</span> <span class="main">(</span>exec_gpv <span class="main">(</span><span class="bound">orc_of</span> <span class="main">(</span>rfunc_usr <span class="free">rest</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnv_usr</span> <span class="bound">s_usr</span> <span class="bound">iusr</span><span class="main">)</span> <span class="main">(</span><span class="bound">s_rest</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1" id="Fused_Resource-attach_rest_id_oracle_adv"><span class="command">lemma</span></span> 
  attach_rest_id_oracle_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="main">(</span>attach_rest <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">cnv</span> <span class="free">f_init</span> <span class="free">rest</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_cnv</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s_cnv</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_adv <span class="free">rest</span> <span class="bound">s_core</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_oracle_def split_def map_spmf_conv_bind_spmf fun_eq_iff<span class="main">)</span>  

<span class="keyword1" id="Fused_Resource-attach_rest_id_oracle_usr"><span class="command">lemma</span></span>
  attach_rest_id_oracle_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="main">(</span>attach_rest <span class="free">cnv</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">f_init</span> <span class="free">rest</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_cnv</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s_cnv</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_usr <span class="free">rest</span> <span class="bound">s_core</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_oracle_def split_def map_spmf_conv_bind_spmf<span class="main">)</span>  



<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Traces›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> trace_core <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'event</span> <span class="main">+</span> <span class="tfree">'iadv_core</span> <span class="main">×</span> <span class="tfree">'oadv_core</span> <span class="main">+</span> <span class="tfree">'iusr_core</span> <span class="main">×</span> <span class="tfree">'ousr_core</span><span class="main">)</span> list 
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'event</span> <span class="main">⇒</span> real<span class="main">)</span>
  <span class="main">×</span> <span class="main">(</span><span class="tfree">'iadv_core</span> <span class="main">⇒</span> <span class="tfree">'oadv_core</span> spmf<span class="main">)</span> 
  <span class="main">×</span> <span class="main">(</span><span class="tfree">'iusr_core</span> <span class="main">⇒</span> <span class="tfree">'ousr_core</span> spmf<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">trace_core'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s_core</span> spmf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> trace_core"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_core'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">[]</span> <span class="main">=</span> 
   <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> weight_spmf' <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> bind_spmf <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_adv <span class="free">core</span> <span class="bound">s</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">λ</span><span class="bound">iu</span><span class="main">.</span> bind_spmf <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_usr <span class="free">core</span> <span class="bound">s</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">trace_core'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">obs</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">obs</span></span></span> <span class="keyword1">of</span>
     Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="free">trace_core'</span> <span class="main">(</span>mk_lossless <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span>
   <span class="main">|</span> Inr <span class="main">(</span>Inl <span class="main">(</span><span class="bound">ia</span><span class="main">,</span> <span class="bound">oa</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">trace_core'</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cfunc_adv <span class="free">core</span> <span class="bound">s</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span>
   <span class="main">|</span> Inr <span class="main">(</span>Inr <span class="main">(</span><span class="bound">iu</span><span class="main">,</span> <span class="bound">ou</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">trace_core'</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cfunc_usr <span class="free">core</span> <span class="bound">s</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span>
   <span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> trace_core'.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">case_of_simps</span></span> trace_core'_unfold<span class="main">:</span> trace_core'.simps<span class="main">[</span><span class="operator">unfolded</span> weight_spmf'_def<span class="main">]</span>
<span class="keyword1"><span class="command">simps_of_case</span></span> trace_core'_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> trace_core'_unfold

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Fused_Resource-trace_core'_parametric"><span class="command">lemma</span></span> trace_core'_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_core' <span class="free">S</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">===&gt;</span>
      rel_spmf <span class="free">S</span> <span class="main">===&gt;</span>
      list_all2 <span class="main">(</span>rel_sum <span class="free">E</span> <span class="main">(</span>rel_sum <span class="main">(</span>rel_prod <span class="free">IA</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>rel_prod <span class="free">IU</span> <span class="main">(=)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span>
      rel_prod <span class="main">(</span><span class="free">E</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>rel_prod <span class="main">(</span><span class="free">IA</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="free">IU</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      trace_core' trace_core'"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trace_core'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trace_core_eq</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s_core'</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core
  <span class="main">⇒</span> <span class="tfree">'event</span> set <span class="main">⇒</span> <span class="tfree">'iadv_core</span> set <span class="main">⇒</span> <span class="tfree">'iusr_core</span> set
  <span class="main">⇒</span> <span class="tfree">'s_core</span> spmf <span class="main">⇒</span> <span class="tfree">'s_core'</span> spmf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_core_eq</span> <span class="free"><span class="bound"><span class="entity">core1</span></span></span> <span class="free"><span class="bound"><span class="entity">core2</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">IA</span></span></span> <span class="free"><span class="bound"><span class="entity">IU</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">tr</span><span class="main">.</span> set <span class="bound">tr</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">IA</span></span></span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">IU</span></span></span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">⟶</span> 
   rel_prod <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>rel_prod <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">IA</span></span></span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">iu</span><span class="main">.</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">IU</span></span></span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>trace_core' <span class="free"><span class="bound"><span class="entity">core1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">tr</span><span class="main">)</span> <span class="main">(</span>trace_core' <span class="free"><span class="bound"><span class="entity">core2</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="bound">tr</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Fused_Resource-trace_core_eqD"><span class="command">lemma</span></span> trace_core_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace_core_eq <span class="free">core1</span> <span class="free">core2</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">tr</span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free">IA</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free">IU</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> trace_core_eqD_cpoke<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> fst <span class="main">(</span>trace_core' <span class="free">core1</span> <span class="free">p</span> <span class="free">tr</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> fst <span class="main">(</span>trace_core' <span class="free">core2</span> <span class="free">q</span> <span class="free">tr</span><span class="main">)</span> <span class="free">e</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trace_core_eqD_cfunc_adv<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="free">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟹</span> fst <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core1</span> <span class="free">p</span> <span class="free">tr</span><span class="main">)</span><span class="main">)</span> <span class="free">ia</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core2</span> <span class="free">q</span> <span class="free">tr</span><span class="main">)</span><span class="main">)</span> <span class="free">ia</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trace_core_eqD_cfunc_usr<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟹</span> snd <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core1</span> <span class="free">p</span> <span class="free">tr</span><span class="main">)</span><span class="main">)</span> <span class="free">iu</span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core2</span> <span class="free">q</span> <span class="free">tr</span><span class="main">)</span><span class="main">)</span> <span class="free">iu</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_core_eq_def rel_fun_def eq_onp_def rel_prod_sel<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-trace_core_eqI"><span class="command">lemma</span></span> trace_core_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tr</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> set <span class="bound">tr</span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free">IA</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free">IU</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">;</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟧</span> 
     <span class="main">⟹</span> fst <span class="main">(</span>trace_core' <span class="free">core1</span> <span class="free">p</span> <span class="bound">tr</span><span class="main">)</span> <span class="bound">e</span> <span class="main">=</span> fst <span class="main">(</span>trace_core' <span class="free">core2</span> <span class="free">q</span> <span class="bound">tr</span><span class="main">)</span> <span class="bound">e</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tr</span> <span class="bound">ia</span><span class="main">.</span> <span class="main">⟦</span> set <span class="bound">tr</span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free">IA</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free">IU</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟧</span>
     <span class="main">⟹</span> fst <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core1</span> <span class="free">p</span> <span class="bound">tr</span><span class="main">)</span><span class="main">)</span> <span class="bound">ia</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core2</span> <span class="free">q</span> <span class="bound">tr</span><span class="main">)</span><span class="main">)</span> <span class="bound">ia</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tr</span> <span class="bound">iu</span><span class="main">.</span> <span class="main">⟦</span> set <span class="bound">tr</span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free">IA</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free">IU</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟧</span>
     <span class="main">⟹</span> snd <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core1</span> <span class="free">p</span> <span class="bound">tr</span><span class="main">)</span><span class="main">)</span> <span class="bound">iu</span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core2</span> <span class="free">q</span> <span class="bound">tr</span><span class="main">)</span><span class="main">)</span> <span class="bound">iu</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_core_eq <span class="free">core1</span> <span class="free">core2</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_core_eq_def rel_fun_def eq_onp_def rel_prod_sel<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-trace_core_return_pmf_None"><span class="command">lemma</span></span> trace_core_return_pmf_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_core' <span class="free">core</span> <span class="main">(</span>return_pmf None<span class="main">)</span> <span class="free">tr</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return_pmf None<span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return_pmf None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">tr</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_core'.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-rel_core'_into_trace_core_eq"><span class="command">lemma</span></span> rel_core'_into_trace_core_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_core_eq <span class="free">core</span> <span class="free">core'</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"rel_core' <span class="free">S</span> <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">iu</span><span class="main">.</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span><span class="main">)</span><span class="main">)</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="free">core</span> <span class="free">core'</span>"</span></span>
     <span class="quoted"><span class="quoted">"rel_spmf <span class="free">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trace_core'_parametric<span class="main">[</span><span class="operator">THEN</span> rel_funD<span class="main">,</span> <span class="operator">THEN</span> rel_funD<span class="main">,</span> <span class="operator">OF</span> that<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> trace_core_eq_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> tr
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_True<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> prod.rel_eq_onp sum.rel_eq_onp list.rel_eq_onp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def list_all_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_funD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">tr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">tr</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Fused_Resource-trace_core_eq_simI"><span class="command">lemma</span></span> trace_core_eq_simI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">core1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">core2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core'</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s_core</span> spmf <span class="main">⇒</span> <span class="tfree">'s_core'</span> spmf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_cpoke<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      weight_spmf <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core1</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> weight_spmf <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core2</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim_cpoke<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      <span class="free">S</span> <span class="main">(</span>mk_lossless <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core1</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mk_lossless <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core2</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_cfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim_cfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s1'</span> <span class="bound">s2'</span> <span class="bound">oa</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span><span class="main">;</span> 
      <span class="bound">s1</span> <span class="main">∈</span> set_spmf <span class="bound">p</span><span class="main">;</span> <span class="bound">s2</span> <span class="main">∈</span> set_spmf <span class="bound">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">oa</span><span class="main">,</span> <span class="bound">s1'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">oa</span><span class="main">,</span> <span class="bound">s2'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_cfunc_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim_cfunc_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s1'</span> <span class="bound">s2'</span> <span class="bound">ou</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span><span class="main">;</span> 
      <span class="bound">s1</span> <span class="main">∈</span> set_spmf <span class="bound">p</span><span class="main">;</span> <span class="bound">s2</span> <span class="main">∈</span> set_spmf <span class="bound">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">ou</span><span class="main">,</span> <span class="bound">s1'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">ou</span><span class="main">,</span> <span class="bound">s2'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_core_eq <span class="free">core1</span> <span class="free">core2</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> trace_core_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="tfree">'event</span> <span class="main">+</span> <span class="tfree">'iadv_core</span> <span class="main">×</span> <span class="tfree">'oadv_core</span> <span class="main">+</span> <span class="tfree">'iusr_core</span> <span class="main">×</span> <span class="tfree">'ousr_core</span><span class="main">)</span> list"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">tr</span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">&lt;+&gt;</span> <span class="free">IA</span> <span class="main">×</span> UNIV <span class="main">&lt;+&gt;</span> <span class="free">IU</span> <span class="main">×</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free">E</span><span class="main">.</span> fst <span class="main">(</span>trace_core' <span class="free">core1</span> <span class="free">p</span> <span class="skolem">tr</span><span class="main">)</span> <span class="bound">e</span> <span class="main">=</span> fst <span class="main">(</span>trace_core' <span class="free">core2</span> <span class="free">q</span> <span class="skolem">tr</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">ia</span><span class="main">∈</span><span class="free">IA</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core1</span> <span class="free">p</span> <span class="skolem">tr</span><span class="main">)</span><span class="main">)</span> <span class="bound">ia</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core2</span> <span class="free">q</span> <span class="skolem">tr</span><span class="main">)</span><span class="main">)</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">iu</span><span class="main">∈</span><span class="free">IU</span><span class="main">.</span> snd <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core1</span> <span class="free">p</span> <span class="skolem">tr</span><span class="main">)</span><span class="main">)</span> <span class="bound">iu</span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core2</span> <span class="free">q</span> <span class="skolem">tr</span><span class="main">)</span><span class="main">)</span> <span class="bound">iu</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> start
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">tr</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_cpoke step_cfunc_adv step_cfunc_usr<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">tr</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> tr<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">tr</span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">&lt;+&gt;</span> <span class="free">IA</span> <span class="main">×</span> UNIV <span class="main">&lt;+&gt;</span> <span class="free">IU</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>cpoke<span class="main">)</span> <span class="skolem">e</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inl <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="free">E</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>cfunc_adv<span class="main">)</span> <span class="skolem">ia</span> <span class="skolem">oa</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inr <span class="main">(</span>Inl <span class="main">(</span><span class="skolem">ia</span><span class="main">,</span> <span class="skolem">oa</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">∈</span> <span class="free">IA</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>cfunc_usr<span class="main">)</span> <span class="skolem">iu</span> <span class="skolem">ou</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inr <span class="main">(</span>Inr <span class="main">(</span><span class="skolem">iu</span><span class="main">,</span> <span class="skolem">ou</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iu</span> <span class="main">∈</span> <span class="free">IU</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> cpoke
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tr Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_cpoke <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> cfunc_adv
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="skolem">ia</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="skolem">ia</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">oa</span> <span class="main">∈</span> fst <span class="main">`</span> set_spmf <span class="var">?p</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> step_cfunc_adv<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cfunc_adv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">set_spmf</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">oa</span> <span class="main">∈</span> fst <span class="main">`</span> set_spmf <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> set_map_spmf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True Cons.prems cfunc_adv
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sim_cfunc_adv<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="var">?p</span> <span class="skolem">oa</span> <span class="main">=</span> return_pmf None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> step_cfunc_adv<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cfunc_adv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">set_spmf</span><span class="main"><span class="main">]</span></span><span class="main">]</span> False
        <span class="keyword1"><span class="command">have</span></span> oa'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">oa</span> <span class="main">∉</span> fst <span class="main">`</span> set_spmf <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> set_map_spmf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def<span class="main">)</span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="var">?q</span> <span class="skolem">oa</span> <span class="main">=</span> return_pmf None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cfunc_adv <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_eq_return_None<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> cfunc_usr
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="skolem">iu</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="skolem">iu</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ou</span> <span class="main">∈</span> fst <span class="main">`</span> set_spmf <span class="var">?p</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> step_cfunc_usr<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cfunc_usr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">set_spmf</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ou</span> <span class="main">∈</span> fst <span class="main">`</span> set_spmf <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> set_map_spmf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True Cons.prems cfunc_usr
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sim_cfunc_usr<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="var">?p</span> <span class="skolem">ou</span> <span class="main">=</span> return_pmf None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> step_cfunc_usr<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cfunc_usr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">set_spmf</span><span class="main"><span class="main">]</span></span><span class="main">]</span> False
        <span class="keyword1"><span class="command">have</span></span> oa'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ou</span> <span class="main">∉</span> fst <span class="main">`</span> set_spmf <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> set_map_spmf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def<span class="main">)</span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="var">?q</span> <span class="skolem">ou</span> <span class="main">=</span> return_pmf None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cfunc_usr <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_eq_return_None<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> fst <span class="main">(</span>trace_core' <span class="free">core1</span> <span class="free">p</span> <span class="skolem">tr</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">=</span> fst <span class="main">(</span>trace_core' <span class="free">core2</span> <span class="free">q</span> <span class="skolem">tr</span><span class="main">)</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟹</span> fst <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core1</span> <span class="free">p</span> <span class="skolem">tr</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ia</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core2</span> <span class="free">q</span> <span class="skolem">tr</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ia</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟹</span> snd <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core1</span> <span class="free">p</span> <span class="skolem">tr</span><span class="main">)</span><span class="main">)</span> <span class="skolem">iu</span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="main">(</span>trace_core' <span class="free">core2</span> <span class="free">q</span> <span class="skolem">tr</span><span class="main">)</span><span class="main">)</span> <span class="skolem">iu</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span> <span class="skolem">ia</span> <span class="skolem">iu</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">trace_core_aux</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s_core</span> spmf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'event</span> <span class="main">+</span> <span class="tfree">'iadv_core</span> <span class="main">×</span> <span class="tfree">'oadv_core</span> <span class="main">+</span> <span class="tfree">'iusr_core</span> <span class="main">×</span> <span class="tfree">'ousr_core</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'s_core</span> spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_core_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">trace_core_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">trace_core_aux</span> <span class="main">(</span>mk_lossless <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core</span> <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">trace_core_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ia</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">oa</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">trace_core_aux</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cfunc_adv <span class="free">core</span> <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">ia</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">oa</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">trace_core_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="main">(</span><span class="free"><span class="bound"><span class="entity">iu</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">trace_core_aux</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cfunc_usr <span class="free">core</span> <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">iu</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ou</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Fused_Resource-trace_core_conv_trace_core_aux"><span class="command">lemma</span></span> trace_core_conv_trace_core_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_core' <span class="free">core</span> <span class="free">p</span> <span class="free">tr</span> <span class="main">=</span> 
   <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> weight_spmf <span class="main">(</span>bind_spmf <span class="main">(</span>trace_core_aux <span class="free">core</span> <span class="free">p</span> <span class="free">tr</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> bind_spmf <span class="main">(</span>trace_core_aux <span class="free">core</span> <span class="free">p</span> <span class="free">tr</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_adv <span class="free">core</span> <span class="bound">s</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">λ</span><span class="bound">iu</span><span class="main">.</span> bind_spmf <span class="main">(</span>trace_core_aux <span class="free">core</span> <span class="free">p</span> <span class="free">tr</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_usr <span class="free">core</span> <span class="bound">s</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">tr</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_core_aux.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Fused_Resource-trace_core_aux_append"><span class="command">lemma</span></span> trace_core_aux_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_core_aux <span class="free">core</span> <span class="free">p</span> <span class="main">(</span><span class="free">tr</span> <span class="main">@</span> <span class="free">tr'</span><span class="main">)</span> <span class="main">=</span> trace_core_aux <span class="free">core</span> <span class="main">(</span>trace_core_aux <span class="free">core</span> <span class="free">p</span> <span class="free">tr</span><span class="main">)</span> <span class="free">tr'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">tr</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_core_aux.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">trace_core_closure</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s_core'</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core
  <span class="main">⇒</span> <span class="tfree">'event</span> set <span class="main">⇒</span> <span class="tfree">'iadv_core</span> set <span class="main">⇒</span> <span class="tfree">'iusr_core</span> set
  <span class="main">⇒</span> <span class="tfree">'s_core</span> spmf <span class="main">⇒</span> <span class="tfree">'s_core'</span> spmf <span class="main">⇒</span> <span class="tfree">'s_core</span> spmf <span class="main">⇒</span> <span class="tfree">'s_core'</span> spmf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">core1</span> <span class="entity">core2</span> <span class="entity">E</span> <span class="entity">IA</span> <span class="entity">IU</span> <span class="entity">p</span> <span class="entity">q</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_core_closure</span> <span class="free">core1</span> <span class="free">core2</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span> <span class="main">(</span>trace_core_aux <span class="free">core1</span> <span class="free">p</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span><span class="main">)</span> <span class="main">(</span>trace_core_aux <span class="free">core2</span> <span class="free">q</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"set <span class="free"><span class="bound"><span class="entity">tr</span></span></span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">&lt;+&gt;</span> <span class="free">IA</span> <span class="main">×</span> UNIV <span class="main">&lt;+&gt;</span> <span class="free">IU</span> <span class="main">×</span> UNIV"</span></span>

<span class="keyword1" id="Fused_Resource-trace_core_closure_start"><span class="command">lemma</span></span> trace_core_closure_start<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_core_closure <span class="free">core1</span> <span class="free">core2</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_core_closure.simps exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Fused_Resource-trace_core_closure_step"><span class="command">lemma</span></span> trace_core_closure_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace_core_eq <span class="free">core1</span> <span class="free">core2</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace_core_closure <span class="free">core1</span> <span class="free">core2</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span> <span class="free">p'</span> <span class="free">q'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> trace_core_closure_step_cpoke<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> weight_spmf <span class="main">(</span>bind_spmf <span class="free">p'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core1</span> <span class="bound">s</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> weight_spmf <span class="main">(</span>bind_spmf <span class="free">q'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core2</span> <span class="bound">s</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis1</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> trace_core_closure_step_cfunc_adv<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟹</span> bind_spmf <span class="free">p'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="free">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="free">q'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="free">ia</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis2</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> trace_core_closure_step_cfunc_usr<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟹</span> bind_spmf <span class="free">p'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="free">iu</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="free">q'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="free">iu</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis3</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tr</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> trace_core_aux <span class="free">core1</span> <span class="free">p</span> <span class="skolem">tr</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">=</span> trace_core_aux <span class="free">core2</span> <span class="free">q</span> <span class="skolem">tr</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tr<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">tr</span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">&lt;+&gt;</span> <span class="free">IA</span> <span class="main">×</span> UNIV <span class="main">&lt;+&gt;</span> <span class="free">IU</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command">from</span></span> trace_core_eqD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> tr<span class="main">]</span> p q
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_core_conv_trace_core_aux<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fused_Resource-trace_core_closure_sim"><span class="command">lemma</span></span> trace_core_closure_sim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">core1</span> <span class="free">core2</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> trace_core_closure <span class="free">core1</span> <span class="free">core2</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">p'</span> <span class="free">q'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> trace_core_closure_sim_cpoke<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>mk_lossless <span class="main">(</span>bind_spmf <span class="free">p'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core1</span> <span class="bound">s</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mk_lossless <span class="main">(</span>bind_spmf <span class="free">q'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core2</span> <span class="bound">s</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis1</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> trace_core_closure_sim_cfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ia</span> <span class="main">∈</span> <span class="free">IA</span> 
    <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">p'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="free">ia</span><span class="main">)</span><span class="main">)</span> <span class="free">oa</span><span class="main">)</span> 
          <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">q'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="free">ia</span><span class="main">)</span><span class="main">)</span> <span class="free">oa</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis2</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> trace_core_closure_sim_cfunc_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">iu</span> <span class="main">∈</span> <span class="free">IU</span> 
    <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">p'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="free">iu</span><span class="main">)</span><span class="main">)</span> <span class="free">ou</span><span class="main">)</span>
          <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">q'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="free">iu</span><span class="main">)</span><span class="main">)</span> <span class="free">ou</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis3</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tr</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> trace_core_aux <span class="free">core1</span> <span class="free">p</span> <span class="skolem">tr</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">=</span> trace_core_aux <span class="free">core2</span> <span class="free">q</span> <span class="skolem">tr</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tr<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">tr</span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">&lt;+&gt;</span> <span class="free">IA</span> <span class="main">×</span> UNIV <span class="main">&lt;+&gt;</span> <span class="free">IU</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p q tr
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def trace_core_closure.simps trace_core_aux_append <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">tr</span> <span class="main">@</span> <span class="main">[</span>Inl <span class="main">_</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p q tr
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def trace_core_closure.simps trace_core_aux_append <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">tr</span> <span class="main">@</span> <span class="main">[</span>Inr <span class="main">(</span>Inl <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p q tr
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def trace_core_closure.simps trace_core_aux_append <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">tr</span> <span class="main">@</span> <span class="main">[</span>Inr <span class="main">(</span>Inr <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> trace_core_eq_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace_core_eq <span class="free">core1</span> <span class="free">core2</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">S</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      weight_spmf <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core1</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> weight_spmf <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core2</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      <span class="free">S</span> <span class="main">(</span>mk_lossless <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core1</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mk_lossless <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core2</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span> <span class="bound">oa</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span> <span class="bound">ou</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"trace_core_closure <span class="free">core1</span> <span class="free">core2</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_core_closure_start trace_core_closure_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> trace_core_closure_sim <span class="comment1">(* trace_core_closure_weight[OF assms] *)</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">)</span> trace_rest <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'iadv_rest</span> <span class="main">×</span> <span class="tfree">'oadv_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list <span class="main">+</span> <span class="tfree">'iusr_rest</span> <span class="main">×</span> <span class="tfree">'ousr_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list<span class="main">)</span> list
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'iadv_rest</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'oadv_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list<span class="main">)</span> spmf<span class="main">)</span> 
  <span class="main">×</span> <span class="main">(</span><span class="tfree">'iusr_rest</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ousr_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list<span class="main">)</span> spmf<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> rest_scheme"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">trace_rest'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s_rest</span> spmf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">)</span> trace_rest"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_rest'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">[]</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> bind_spmf <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_adv <span class="free">rest</span> <span class="bound">s</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
   <span class="main">λ</span><span class="bound">iu</span><span class="main">.</span> bind_spmf <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_usr <span class="free">rest</span> <span class="bound">s</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">trace_rest'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">obs</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">obs</span></span></span> <span class="keyword1">of</span>
     Inl <span class="main">(</span><span class="bound">ia</span><span class="main">,</span> <span class="bound">oa</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">trace_rest'</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rfunc_adv <span class="free">rest</span> <span class="bound">s</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span>
   <span class="main">|</span> Inr <span class="main">(</span><span class="bound">iu</span><span class="main">,</span> <span class="bound">ou</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">trace_rest'</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rfunc_usr <span class="free">rest</span> <span class="bound">s</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> trace_rest'.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">case_of_simps</span></span> trace_rest'_unfold<span class="main">:</span> trace_rest'.simps
<span class="keyword1"><span class="command">simps_of_case</span></span> trace_rest'_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> trace_rest'_unfold

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Fused_Resource-trace_rest'_parametric"><span class="command">lemma</span></span> trace_rest'_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_rest' <span class="free">S</span> <span class="main">(=)</span> <span class="free">IA</span> <span class="free">IU</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="free">M</span> <span class="main">===&gt;</span> rel_spmf <span class="free">S</span> <span class="main">===&gt;</span>
      list_all2 <span class="main">(</span>rel_sum <span class="main">(</span>rel_prod <span class="free">IA</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>rel_prod <span class="free">IU</span> <span class="main">(=)</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span>
      rel_prod <span class="main">(</span><span class="free">IA</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="free">IU</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span><span class="main">)</span>
      trace_rest' trace_rest'"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trace_rest'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trace_rest_eq</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more1</span><span class="main">)</span> rest_scheme
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s_rest'</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more2</span><span class="main">)</span> rest_scheme
  <span class="main">⇒</span> <span class="tfree">'iadv_rest</span> set <span class="main">⇒</span> <span class="tfree">'iusr_rest</span> set
  <span class="main">⇒</span> <span class="tfree">'s_rest</span> spmf <span class="main">⇒</span> <span class="tfree">'s_rest'</span> spmf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_rest_eq</span> <span class="free"><span class="bound"><span class="entity">rest1</span></span></span> <span class="free"><span class="bound"><span class="entity">rest2</span></span></span> <span class="free"><span class="bound"><span class="entity">IA</span></span></span> <span class="free"><span class="bound"><span class="entity">IU</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">tr</span><span class="main">.</span> set <span class="bound">tr</span> <span class="main">⊆</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">IA</span></span></span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">IU</span></span></span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">⟶</span>
   rel_prod <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">IA</span></span></span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">iu</span><span class="main">.</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">IU</span></span></span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span>
     <span class="main">(</span>trace_rest' <span class="free"><span class="bound"><span class="entity">rest1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">tr</span><span class="main">)</span> <span class="main">(</span>trace_rest' <span class="free"><span class="bound"><span class="entity">rest2</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="bound">tr</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Fused_Resource-trace_rest_eqD"><span class="command">lemma</span></span> trace_rest_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace_rest_eq <span class="free">rest1</span> <span class="free">rest2</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">tr</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">IA</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free">IU</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> trace_rest_eqD_rfunc_adv<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟹</span> fst <span class="main">(</span>trace_rest' <span class="free">rest1</span> <span class="free">p</span> <span class="free">tr</span><span class="main">)</span> <span class="free">ia</span> <span class="main">=</span> fst <span class="main">(</span>trace_rest' <span class="free">rest2</span> <span class="free">q</span> <span class="free">tr</span><span class="main">)</span> <span class="free">ia</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trace_rest_eqD_rfunc_usr<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟹</span> snd <span class="main">(</span>trace_rest' <span class="free">rest1</span> <span class="free">p</span> <span class="free">tr</span><span class="main">)</span> <span class="free">iu</span> <span class="main">=</span> snd <span class="main">(</span>trace_rest' <span class="free">rest2</span> <span class="free">q</span> <span class="free">tr</span><span class="main">)</span> <span class="free">iu</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_rest_eq_def rel_fun_def rel_prod_sel eq_onp_def<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-trace_rest_eqI"><span class="command">lemma</span></span> trace_rest_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tr</span> <span class="bound">ia</span><span class="main">.</span> <span class="main">⟦</span> set <span class="bound">tr</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">IA</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free">IU</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟧</span>
     <span class="main">⟹</span> fst <span class="main">(</span>trace_rest' <span class="free">rest1</span> <span class="free">p</span> <span class="bound">tr</span><span class="main">)</span> <span class="bound">ia</span> <span class="main">=</span> fst <span class="main">(</span>trace_rest' <span class="free">rest2</span> <span class="free">q</span> <span class="bound">tr</span><span class="main">)</span> <span class="bound">ia</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tr</span> <span class="bound">iu</span><span class="main">.</span> <span class="main">⟦</span> set <span class="bound">tr</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">IA</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span><span class="free">IU</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟧</span>
      <span class="main">⟹</span> snd <span class="main">(</span>trace_rest' <span class="free">rest1</span> <span class="free">p</span> <span class="bound">tr</span><span class="main">)</span> <span class="bound">iu</span> <span class="main">=</span> snd <span class="main">(</span>trace_rest' <span class="free">rest2</span> <span class="free">q</span> <span class="bound">tr</span><span class="main">)</span> <span class="bound">iu</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_rest_eq <span class="free">rest1</span> <span class="free">rest2</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_rest_eq_def rel_fun_def eq_onp_def rel_prod_sel<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-trace_rest_return_pmf_None"><span class="command">lemma</span></span> trace_rest_return_pmf_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_rest' <span class="free">rest</span> <span class="main">(</span>return_pmf None<span class="main">)</span> <span class="free">tr</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return_pmf None<span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return_pmf None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">tr</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_rest'.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-rel_rest'_into_trace_rest_eq"><span class="command">lemma</span></span> rel_rest'_into_trace_rest_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_rest_eq <span class="free">rest</span> <span class="free">rest'</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"rel_rest' <span class="free">S</span> <span class="main">(=)</span> <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">iu</span><span class="main">.</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span><span class="main">)</span><span class="main">)</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="free">M</span> <span class="free">rest</span> <span class="free">rest'</span>"</span></span>
     <span class="quoted"><span class="quoted">"rel_spmf <span class="free">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trace_rest'_parametric<span class="main">[</span><span class="operator">THEN</span> rel_funD<span class="main">,</span> <span class="operator">THEN</span> rel_funD<span class="main">,</span> <span class="operator">OF</span> that<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> trace_rest_eq_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> tr
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_True<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> prod.rel_eq_onp sum.rel_eq_onp list.rel_eq_onp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def list_all_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_funD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">tr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">tr</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Fused_Resource-trace_rest_eq_simI"><span class="command">lemma</span></span> trace_rest_eq_simI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rest1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> rest_scheme"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rest2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest'</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> rest_scheme"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s_rest</span> spmf <span class="main">⇒</span> <span class="tfree">'s_rest'</span> spmf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_rfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_adv <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_adv <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim_rfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s1'</span> <span class="bound">s2'</span> <span class="bound">oa</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span><span class="main">;</span> 
      <span class="bound">s1</span> <span class="main">∈</span> set_spmf <span class="bound">p</span><span class="main">;</span> <span class="bound">s2</span> <span class="main">∈</span> set_spmf <span class="bound">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">oa</span><span class="main">,</span> <span class="bound">s1'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>rfunc_adv <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">oa</span><span class="main">,</span> <span class="bound">s2'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>rfunc_adv <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> rfunc_adv <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> rfunc_adv <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_rfunc_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_usr <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_usr <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim_rfunc_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s1'</span> <span class="bound">s2'</span> <span class="bound">ou</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span><span class="main">;</span> 
      <span class="bound">s1</span> <span class="main">∈</span> set_spmf <span class="bound">p</span><span class="main">;</span> <span class="bound">s2</span> <span class="main">∈</span> set_spmf <span class="bound">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">ou</span><span class="main">,</span> <span class="bound">s1'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>rfunc_usr <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">ou</span><span class="main">,</span> <span class="bound">s2'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>rfunc_usr <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> rfunc_usr <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> rfunc_usr <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_rest_eq <span class="free">rest1</span> <span class="free">rest2</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> trace_rest_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'iadv_rest</span> <span class="main">×</span> <span class="tfree">'oadv_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list <span class="main">+</span> <span class="tfree">'iusr_rest</span> <span class="main">×</span> <span class="tfree">'ousr_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list<span class="main">)</span> list"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">tr</span> <span class="main">⊆</span> <span class="free">IA</span> <span class="main">×</span> UNIV <span class="main">&lt;+&gt;</span> <span class="free">IU</span> <span class="main">×</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">ia</span><span class="main">∈</span><span class="free">IA</span><span class="main">.</span> fst <span class="main">(</span>trace_rest' <span class="free">rest1</span> <span class="free">p</span> <span class="skolem">tr</span><span class="main">)</span> <span class="bound">ia</span> <span class="main">=</span> fst <span class="main">(</span>trace_rest' <span class="free">rest2</span> <span class="free">q</span> <span class="skolem">tr</span><span class="main">)</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">iu</span><span class="main">∈</span><span class="free">IU</span><span class="main">.</span> snd <span class="main">(</span>trace_rest' <span class="free">rest1</span> <span class="free">p</span> <span class="skolem">tr</span><span class="main">)</span> <span class="bound">iu</span> <span class="main">=</span> snd <span class="main">(</span>trace_rest' <span class="free">rest2</span> <span class="free">q</span> <span class="skolem">tr</span><span class="main">)</span> <span class="bound">iu</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> start
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">tr</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_rfunc_adv step_rfunc_usr<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">tr</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> tr<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">tr</span> <span class="main">⊆</span> <span class="free">IA</span> <span class="main">×</span> UNIV <span class="main">&lt;+&gt;</span> <span class="free">IU</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>rfunc_adv<span class="main">)</span> <span class="skolem">ia</span> <span class="skolem">oa</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inl <span class="main">(</span><span class="skolem">ia</span><span class="main">,</span> <span class="skolem">oa</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">∈</span> <span class="free">IA</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>rfunc_usr<span class="main">)</span> <span class="skolem">iu</span> <span class="skolem">ou</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">iu</span><span class="main">,</span> <span class="skolem">ou</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iu</span> <span class="main">∈</span> <span class="free">IU</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> rfunc_adv
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> rfunc_adv <span class="free">rest1</span> <span class="bound">s1</span> <span class="skolem">ia</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> rfunc_adv <span class="free">rest2</span> <span class="bound">s2</span> <span class="skolem">ia</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">oa</span> <span class="main">∈</span> fst <span class="main">`</span> set_spmf <span class="var">?p</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> step_rfunc_adv<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rfunc_adv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">set_spmf</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">oa</span> <span class="main">∈</span> fst <span class="main">`</span> set_spmf <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> set_map_spmf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True Cons.prems rfunc_adv
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sim_rfunc_adv<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="var">?p</span> <span class="skolem">oa</span> <span class="main">=</span> return_pmf None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> step_rfunc_adv<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rfunc_adv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">set_spmf</span><span class="main"><span class="main">]</span></span><span class="main">]</span> False
        <span class="keyword1"><span class="command">have</span></span> oa'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">oa</span> <span class="main">∉</span> fst <span class="main">`</span> set_spmf <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> set_map_spmf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def<span class="main">)</span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="var">?q</span> <span class="skolem">oa</span> <span class="main">=</span> return_pmf None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rfunc_adv <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_eq_return_None<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> rfunc_usr
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> rfunc_usr <span class="free">rest1</span> <span class="bound">s1</span> <span class="skolem">iu</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> rfunc_usr <span class="free">rest2</span> <span class="bound">s2</span> <span class="skolem">iu</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ou</span> <span class="main">∈</span> fst <span class="main">`</span> set_spmf <span class="var">?p</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> step_rfunc_usr<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rfunc_usr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">set_spmf</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ou</span> <span class="main">∈</span> fst <span class="main">`</span> set_spmf <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> set_map_spmf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True Cons.prems rfunc_usr
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sim_rfunc_usr<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="var">?p</span> <span class="skolem">ou</span> <span class="main">=</span> return_pmf None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> step_rfunc_usr<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rfunc_usr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">set_spmf</span><span class="main"><span class="main">]</span></span><span class="main">]</span> False
        <span class="keyword1"><span class="command">have</span></span> oa'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ou</span> <span class="main">∉</span> fst <span class="main">`</span> set_spmf <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> set_map_spmf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def<span class="main">)</span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="var">?q</span> <span class="skolem">ou</span> <span class="main">=</span> return_pmf None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rfunc_usr <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_eq_return_None<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟹</span> fst <span class="main">(</span>trace_rest' <span class="free">rest1</span> <span class="free">p</span> <span class="skolem">tr</span><span class="main">)</span> <span class="skolem">ia</span> <span class="main">=</span> fst <span class="main">(</span>trace_rest' <span class="free">rest2</span> <span class="free">q</span> <span class="skolem">tr</span><span class="main">)</span> <span class="skolem">ia</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟹</span> snd <span class="main">(</span>trace_rest' <span class="free">rest1</span> <span class="free">p</span> <span class="skolem">tr</span><span class="main">)</span> <span class="skolem">iu</span> <span class="main">=</span> snd <span class="main">(</span>trace_rest' <span class="free">rest2</span> <span class="free">q</span> <span class="skolem">tr</span><span class="main">)</span> <span class="skolem">iu</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ia</span> <span class="skolem">iu</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> rest_scheme"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">trace_rest_aux</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s_rest</span> spmf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'iadv_rest</span> <span class="main">×</span> <span class="tfree">'oadv_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list <span class="main">+</span> <span class="tfree">'iusr_rest</span> <span class="main">×</span> <span class="tfree">'ousr_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'s_rest</span> spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_rest_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">trace_rest_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Inl <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ia</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">oaes</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">trace_rest_aux</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rfunc_adv <span class="free">rest</span> <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">ia</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">oaes</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">trace_rest_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Inr <span class="main">(</span><span class="free"><span class="bound"><span class="entity">iu</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">oues</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">trace_rest_aux</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> rfunc_usr <span class="free">rest</span> <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">iu</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">oues</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Fused_Resource-trace_rest_conv_trace_rest_aux"><span class="command">lemma</span></span> trace_rest_conv_trace_rest_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_rest' <span class="free">rest</span> <span class="free">p</span> <span class="free">tr</span> <span class="main">=</span> 
   <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> bind_spmf <span class="main">(</span>trace_rest_aux <span class="free">rest</span> <span class="free">p</span> <span class="free">tr</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_adv <span class="free">rest</span> <span class="bound">s</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">λ</span><span class="bound">iu</span><span class="main">.</span> bind_spmf <span class="main">(</span>trace_rest_aux <span class="free">rest</span> <span class="free">p</span> <span class="free">tr</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_usr <span class="free">rest</span> <span class="bound">s</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">tr</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_rest_aux.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Fused_Resource-trace_rest_aux_append"><span class="command">lemma</span></span> trace_rest_aux_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_rest_aux <span class="free">rest</span> <span class="free">p</span> <span class="main">(</span><span class="free">tr</span> <span class="main">@</span> <span class="free">tr'</span><span class="main">)</span> <span class="main">=</span> trace_rest_aux <span class="free">rest</span> <span class="main">(</span>trace_rest_aux <span class="free">rest</span> <span class="free">p</span> <span class="free">tr</span><span class="main">)</span> <span class="free">tr'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">tr</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace_rest_aux.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">trace_rest_closure</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> rest_scheme
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s_rest'</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more'</span><span class="main">)</span> rest_scheme
  <span class="main">⇒</span> <span class="tfree">'iadv_rest</span> set <span class="main">⇒</span> <span class="tfree">'iusr_rest</span> set
  <span class="main">⇒</span> <span class="tfree">'s_rest</span> spmf <span class="main">⇒</span> <span class="tfree">'s_rest'</span> spmf <span class="main">⇒</span> <span class="tfree">'s_rest</span> spmf <span class="main">⇒</span> <span class="tfree">'s_rest'</span> spmf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">rest1</span> <span class="entity">rest2</span> <span class="entity">IA</span> <span class="entity">IU</span> <span class="entity">p</span> <span class="entity">q</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_rest_closure</span> <span class="free">rest1</span> <span class="free">rest2</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span> <span class="main">(</span>trace_rest_aux <span class="free">rest1</span> <span class="free">p</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span><span class="main">)</span> <span class="main">(</span>trace_rest_aux <span class="free">rest2</span> <span class="free">q</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"set <span class="free"><span class="bound"><span class="entity">tr</span></span></span> <span class="main">⊆</span> <span class="free">IA</span> <span class="main">×</span> UNIV <span class="main">&lt;+&gt;</span> <span class="free">IU</span> <span class="main">×</span> UNIV"</span></span>

<span class="keyword1" id="Fused_Resource-trace_rest_closure_start"><span class="command">lemma</span></span> trace_rest_closure_start<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_rest_closure <span class="free">rest1</span> <span class="free">rest2</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_rest_closure.simps exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Fused_Resource-trace_rest_closure_step"><span class="command">lemma</span></span> trace_rest_closure_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace_rest_eq <span class="free">rest1</span> <span class="free">rest2</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace_rest_closure <span class="free">rest1</span> <span class="free">rest2</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span> <span class="free">p'</span> <span class="free">q'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> trace_rest_closure_step_rfunc_adv<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟹</span> bind_spmf <span class="free">p'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_adv <span class="free">rest1</span> <span class="bound">s1</span> <span class="free">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="free">q'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_adv <span class="free">rest2</span> <span class="bound">s2</span> <span class="free">ia</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis1</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> trace_rest_closure_step_rfunc_usr<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟹</span> bind_spmf <span class="free">p'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_usr <span class="free">rest1</span> <span class="bound">s1</span> <span class="free">iu</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="free">q'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_usr <span class="free">rest2</span> <span class="bound">s2</span> <span class="free">iu</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tr</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> trace_rest_aux <span class="free">rest1</span> <span class="free">p</span> <span class="skolem">tr</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">=</span> trace_rest_aux <span class="free">rest2</span> <span class="free">q</span> <span class="skolem">tr</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tr<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">tr</span> <span class="main">⊆</span> <span class="free">IA</span> <span class="main">×</span> UNIV <span class="main">&lt;+&gt;</span> <span class="free">IU</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command">from</span></span> trace_rest_eqD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> tr<span class="main">]</span> p q
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_rest_conv_trace_rest_aux<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fused_Resource-trace_rest_closure_sim"><span class="command">lemma</span></span> trace_rest_closure_sim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rest1</span> <span class="free">rest2</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> trace_rest_closure <span class="free">rest1</span> <span class="free">rest2</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">p'</span> <span class="free">q'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> trace_rest_closure_sim_rfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ia</span> <span class="main">∈</span> <span class="free">IA</span> 
    <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">p'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> rfunc_adv <span class="free">rest1</span> <span class="bound">s1</span> <span class="free">ia</span><span class="main">)</span><span class="main">)</span> <span class="free">oa</span><span class="main">)</span> 
          <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">q'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> rfunc_adv <span class="free">rest2</span> <span class="bound">s2</span> <span class="free">ia</span><span class="main">)</span><span class="main">)</span> <span class="free">oa</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis1</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> trace_rest_closure_sim_rfunc_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">iu</span> <span class="main">∈</span> <span class="free">IU</span> 
    <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">p'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> rfunc_usr <span class="free">rest1</span> <span class="bound">s1</span> <span class="free">iu</span><span class="main">)</span><span class="main">)</span> <span class="free">ou</span><span class="main">)</span>
          <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">q'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> rfunc_usr <span class="free">rest2</span> <span class="bound">s2</span> <span class="free">iu</span><span class="main">)</span><span class="main">)</span> <span class="free">ou</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tr</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> trace_rest_aux <span class="free">rest1</span> <span class="free">p</span> <span class="skolem">tr</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">=</span> trace_rest_aux <span class="free">rest2</span> <span class="free">q</span> <span class="skolem">tr</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tr<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">tr</span> <span class="main">⊆</span> <span class="free">IA</span> <span class="main">×</span> UNIV <span class="main">&lt;+&gt;</span> <span class="free">IU</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p q tr
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def trace_rest_closure.simps trace_rest_aux_append <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">tr</span> <span class="main">@</span> <span class="main">[</span>Inl <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="var">?thesis2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p q tr
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def trace_rest_closure.simps trace_rest_aux_append <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">tr</span> <span class="main">@</span> <span class="main">[</span>Inr <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> trace_rest_eq_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace_rest_eq <span class="free">rest1</span> <span class="free">rest2</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">S</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_adv <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_adv <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span> <span class="bound">oa</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> rfunc_adv <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> rfunc_adv <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_usr <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_usr <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span> <span class="bound">ou</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> rfunc_usr <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> rfunc_usr <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"trace_rest_closure <span class="free">rest1</span> <span class="free">rest2</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_rest_closure_start trace_rest_closure_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> trace_rest_closure_sim <span class="comment1">(* trace_rest_closure_weight[OF assms] *)</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">callee_of_core</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span> <span class="main">+</span> <span class="tfree">'iadv_core</span> <span class="main">+</span> <span class="tfree">'iusr_core</span><span class="main">,</span> unit <span class="main">+</span> <span class="tfree">'oadv_core</span> <span class="main">+</span> <span class="tfree">'ousr_core</span><span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">callee_of_core</span> <span class="free"><span class="bound"><span class="entity">core</span></span></span> <span class="main">=</span>
   map_fun id <span class="main">(</span>map_fun id <span class="main">(</span>map_spmf <span class="main">(</span>Pair <span class="main">()</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cpoke <span class="free"><span class="bound"><span class="entity">core</span></span></span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> cfunc_adv <span class="free"><span class="bound"><span class="entity">core</span></span></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> cfunc_usr <span class="free"><span class="bound"><span class="entity">core</span></span></span>"</span></span>

<span class="keyword1" id="Fused_Resource-callee_of_core_simps"><span class="command">lemma</span></span> callee_of_core_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"callee_of_core <span class="free">core</span> <span class="free">s</span> <span class="main">(</span>Inl <span class="free">e</span><span class="main">)</span> <span class="main">=</span> map_spmf <span class="main">(</span>Pair <span class="main">(</span>Inl <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cpoke <span class="free">core</span> <span class="free">s</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"callee_of_core <span class="free">core</span> <span class="free">s</span> <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="free">iadv_core</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map_spmf <span class="main">(</span>apfst <span class="main">(</span>Inr <span class="main">∘</span> Inl<span class="main">)</span><span class="main">)</span> <span class="main">(</span>cfunc_adv <span class="free">core</span> <span class="free">s</span> <span class="free">iadv_core</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"callee_of_core <span class="free">core</span> <span class="free">s</span> <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="free">iusr_core</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map_spmf <span class="main">(</span>apfst <span class="main">(</span>Inr <span class="main">∘</span> Inr<span class="main">)</span><span class="main">)</span> <span class="main">(</span>cfunc_usr <span class="free">core</span> <span class="free">s</span> <span class="free">iusr_core</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> callee_of_core_def spmf.map_comp o_def apfst_def prod.map_comp id_def<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-WT_callee_of_core"><span class="command">lemma</span></span> WT_callee_of_core <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"WT_core <span class="free">ℐ_adv</span> <span class="free">ℐ_usr</span> <span class="free">I</span> <span class="free">core</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr</span><span class="main">)</span> <span class="keyword1">⊢c</span> callee_of_core <span class="free">core</span> <span class="free">s</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y s' <span class="keyword1"><span class="command">using</span></span> I WT_coreD<span class="main">[</span><span class="operator">OF</span> WT<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> callee_of_core_def plus_oracle_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Fused_Resource-WT_core_callee_invariant_on"><span class="command">lemma</span></span> WT_core_callee_invariant_on <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"WT_core <span class="free">ℐ_adv</span> <span class="free">ℐ_usr</span> <span class="free">I</span> <span class="free">core</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>callee_of_core <span class="free">core</span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> callee_of_core_def plus_oracle_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_coreD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_callee_of_core<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">callee_of_rest</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> rest_scheme
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'iadv_rest</span> <span class="main">+</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list <span class="main">+</span> <span class="tfree">'ousr_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">callee_of_rest</span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span> <span class="main">=</span> rfunc_adv <span class="free"><span class="bound"><span class="entity">rest</span></span></span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> rfunc_usr <span class="free"><span class="bound"><span class="entity">rest</span></span></span>"</span></span>

<span class="keyword1" id="Fused_Resource-callee_of_rest_simps"><span class="command">lemma</span></span> callee_of_rest_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"callee_of_rest <span class="free">rest</span> <span class="free">s</span> <span class="main">(</span>Inl <span class="free">iadv_rest</span><span class="main">)</span> <span class="main">=</span> map_spmf <span class="main">(</span>apfst Inl<span class="main">)</span> <span class="main">(</span>rfunc_adv <span class="free">rest</span> <span class="free">s</span> <span class="free">iadv_rest</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"callee_of_rest <span class="free">rest</span> <span class="free">s</span> <span class="main">(</span>Inr <span class="free">iusr_rest</span><span class="main">)</span> <span class="main">=</span> map_spmf <span class="main">(</span>apfst Inr<span class="main">)</span> <span class="main">(</span>rfunc_usr <span class="free">rest</span> <span class="free">s</span> <span class="free">iusr_rest</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> callee_of_rest_def<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-WT_callee_of_rest"><span class="command">lemma</span></span> WT_callee_of_rest <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv</span> <span class="free">ℐ_usr</span> <span class="free">I</span> <span class="free">rest</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eℐ <span class="free">ℐ_adv</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> eℐ <span class="free">ℐ_usr</span> <span class="keyword1">⊢c</span> callee_of_rest <span class="free">rest</span> <span class="free">s</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y s' <span class="keyword1"><span class="command">using</span></span> I WT_restD<span class="main">[</span><span class="operator">OF</span> WT<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> callee_of_core_def plus_oracle_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fuse_callee</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'iadv_core</span> <span class="main">+</span> <span class="tfree">'iadv_rest</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'iusr_core</span> <span class="main">+</span> <span class="tfree">'iusr_rest</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="main">(</span><span class="tfree">'oadv_core</span> <span class="main">+</span> <span class="tfree">'oadv_rest</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'ousr_core</span> <span class="main">+</span> <span class="tfree">'ousr_rest</span><span class="main">)</span><span class="main">,</span>
       <span class="main">(</span><span class="tfree">'event</span> <span class="main">+</span> <span class="tfree">'iadv_core</span> <span class="main">+</span> <span class="tfree">'iusr_core</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'iadv_rest</span> <span class="main">+</span> <span class="tfree">'iusr_rest</span><span class="main">)</span><span class="main">,</span>
       <span class="main">(</span>unit <span class="main">+</span> <span class="tfree">'oadv_core</span> <span class="main">+</span> <span class="tfree">'ousr_core</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'oadv_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list <span class="main">+</span> <span class="tfree">'ousr_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list<span class="main">)</span><span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fuse_callee</span> <span class="main">(</span>Inl <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">iadv_core</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Pause <span class="main">(</span>Inl <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">iadv_core</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
       Inl <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="bound">oadv_core</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> Done <span class="main">(</span>Inl <span class="main">(</span>Inl <span class="bound">oadv_core</span><span class="main">)</span><span class="main">)</span>
     <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fuse_callee</span> <span class="main">(</span>Inl <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">iadv_rest</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Pause <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">iadv_rest</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
       Inr <span class="main">(</span>Inl <span class="main">(</span><span class="bound">oadv_rest</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bind_gpv <span class="main">(</span>pauses <span class="main">(</span>map <span class="main">(</span>Inl <span class="main">∘</span> Inl<span class="main">)</span> <span class="bound">es</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Done <span class="main">(</span>Inl <span class="main">(</span>Inr <span class="bound">oadv_rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fuse_callee</span> <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">iusr_core</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Pause <span class="main">(</span>Inl <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">iusr_core</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
       Inl <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="bound">oadv_core</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> Done <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="bound">oadv_core</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fuse_callee</span> <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">iusr_rest</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Pause <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">iusr_rest</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
       Inr <span class="main">(</span>Inr <span class="main">(</span><span class="bound">ousr_rest</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bind_gpv <span class="main">(</span>pauses <span class="main">(</span>map <span class="main">(</span>Inl <span class="main">∘</span> Inl<span class="main">)</span> <span class="bound">es</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Done <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="bound">ousr_rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">case_of_simps</span></span> fuse_callee_case<span class="main">:</span> fuse_callee.simps

<span class="comment1">(* parametric_constant fuse_callee_parametric [transfer_rule]: fuse_callee_case *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fuse_converter</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'iadv_core</span> <span class="main">+</span> <span class="tfree">'iadv_rest</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'iusr_core</span> <span class="main">+</span> <span class="tfree">'iusr_rest</span><span class="main">)</span><span class="main">,</span> 
       <span class="main">(</span><span class="tfree">'oadv_core</span> <span class="main">+</span> <span class="tfree">'oadv_rest</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'ousr_core</span> <span class="main">+</span> <span class="tfree">'ousr_rest</span><span class="main">)</span><span class="main">,</span>
       <span class="main">(</span><span class="tfree">'event</span> <span class="main">+</span> <span class="tfree">'iadv_core</span> <span class="main">+</span> <span class="tfree">'iusr_core</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'iadv_rest</span> <span class="main">+</span> <span class="tfree">'iusr_rest</span><span class="main">)</span><span class="main">,</span>
       <span class="main">(</span>unit <span class="main">+</span> <span class="tfree">'oadv_core</span> <span class="main">+</span> <span class="tfree">'ousr_core</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'oadv_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list <span class="main">+</span> <span class="tfree">'ousr_rest</span> <span class="main">×</span> <span class="tfree">'event</span> list<span class="main">)</span><span class="main">)</span> converter"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fuse_converter</span> <span class="main">=</span> converter_of_callee <span class="main">(</span>stateless_callee fuse_callee<span class="main">)</span> <span class="main">()</span>"</span></span>

<span class="keyword1" id="Fused_Resource-fuse_converter"><span class="command">lemma</span></span> fuse_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"resource_of_oracle <span class="main">(</span>fused_resource.fuse <span class="free">core</span> <span class="free">rest</span><span class="main">)</span> <span class="main">(</span><span class="free">s_core</span><span class="main">,</span> <span class="free">s_rest</span><span class="main">)</span> <span class="main">=</span> 
  fuse_converter <span class="main">⊳</span> <span class="main">(</span>resource_of_oracle <span class="main">(</span>callee_of_core <span class="free">core</span><span class="main">)</span> <span class="free">s_core</span> <span class="main">∥</span> resource_of_oracle <span class="main">(</span>callee_of_rest <span class="free">rest</span><span class="main">)</span> <span class="free">s_rest</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fuse_converter_def resource_of_parallel_oracle<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> attach_CNV_RES attach_stateless_callee resource_of_oracle_extend_state_oracle
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">resource_of_oracle</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> fused_resource <span class="quoted"><span class="free">core</span></span> <span class="quoted"><span class="skolem">core_init</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">core_init</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl_spmf <span class="main">(</span>map_fun id <span class="main">(</span>map_fun <span class="main">(</span>Inl <span class="main">∘</span> Inl<span class="main">)</span> id<span class="main">)</span> <span class="main">(</span>map_fun id <span class="main">(</span>map_fun id <span class="main">(</span>map_spmf snd<span class="main">)</span><span class="main">)</span> <span class="main">(</span>callee_of_core <span class="free">core</span> <span class="keyword1">‡<span class="hidden">⇩</span><sub>O</sub></span> callee_of_rest <span class="free">rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="skolem">s_core</span><span class="main">,</span> <span class="skolem">s_rest</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>
     <span class="main">=</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s_core</span><span class="main">.</span> <span class="main">(</span><span class="bound">s_core</span><span class="main">,</span> <span class="skolem">s_rest</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="main">(</span>cpoke <span class="free">core</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="skolem">s_core</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s_core</span> <span class="skolem">s_rest</span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s_core</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp foldl_spmf_Cons' map_bind_spmf bind_map_spmf o_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> foldl_spmf_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fuse <span class="free">rest</span> <span class="main">(</span><span class="skolem">s_core</span><span class="main">,</span> <span class="skolem">s_rest</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> exec_gpv <span class="main">(</span>callee_of_core <span class="free">core</span> <span class="keyword1">‡<span class="hidden">⇩</span><sub>O</sub></span> callee_of_rest <span class="free">rest</span><span class="main">)</span> <span class="main">(</span>fuse_callee <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s_core</span><span class="main">,</span> <span class="skolem">s_rest</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s_core</span> <span class="skolem">s_rest</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fuse_callee.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf bind_map_spmf exec_gpv_bind exec_gpv_pauses <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fused_Resource-trace_eq_callee_of_coreI"><span class="command">lemma</span></span> trace_eq_callee_of_coreI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_callee_eq <span class="main">(</span>callee_of_core <span class="free">core1</span><span class="main">)</span> <span class="main">(</span>callee_of_core <span class="free">core2</span><span class="main">)</span> <span class="main">(</span><span class="free">E</span> <span class="main">&lt;+&gt;</span> <span class="free">IA</span> <span class="main">&lt;+&gt;</span> <span class="free">IU</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"trace_core_eq <span class="free">core1</span> <span class="free">core2</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S_core</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> core_start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S_core</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> step_cpoke<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">e</span><span class="main">.</span> <span class="skolem">S_core</span> <span class="bound">p</span> <span class="bound">q</span> <span class="main">⟹</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span>
        <span class="main">⟹</span> weight_spmf <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core1</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> weight_spmf <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core2</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sim_cpoke<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">e</span><span class="main">.</span> <span class="skolem">S_core</span> <span class="bound">p</span> <span class="bound">q</span> <span class="main">⟹</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span> 
       <span class="main">⟹</span> <span class="skolem">S_core</span> <span class="main">(</span>mk_lossless <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core1</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mk_lossless <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core2</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> step_cfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">S_core</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟧</span>
       <span class="main">⟹</span> bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sim_cfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span> <span class="bound">oa</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">S_core</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟧</span> <span class="main">⟹</span>
        <span class="skolem">S_core</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span>
               <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> step_cfunc_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">S_core</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟧</span>
        <span class="main">⟹</span> bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sim_cfunc_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span> <span class="bound">ou</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">S_core</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟧</span> <span class="main">⟹</span>
        <span class="skolem">S_core</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span>
               <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace_core_eq_complete<span class="main">)</span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> core_start
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace'_eqI_sim<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> step sim<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>cpoke<span class="main">)</span> <span class="skolem">e</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inl <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="free">E</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>cfunc_adv<span class="main">)</span> <span class="skolem">ia</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inr <span class="main">(</span>Inl <span class="skolem">ia</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">∈</span> <span class="free">IA</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>cfunc_usr<span class="main">)</span> <span class="skolem">iu</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inr <span class="main">(</span>Inr <span class="skolem">iu</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iu</span> <span class="main">∈</span> <span class="free">IU</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> cpoke
      <span class="keyword1"><span class="command">with</span></span> step_cpoke<span class="main">[</span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp o_def map_spmf_const weight_bind_spmf<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spmf_eqI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_bind spmf_scale_spmf max_def min_absorb2 weight_spmf_le_1<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> cfunc_adv
      <span class="keyword1"><span class="command">with</span></span> step_cfunc_adv<span class="main">[</span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cfunc_adv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> cfunc_usr
      <span class="keyword1"><span class="command">with</span></span> step_cfunc_usr<span class="main">[</span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cfunc_usr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sim <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">res</span> <span class="skolem">b</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>cpoke<span class="main">)</span> <span class="skolem">e</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inl <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="free">E</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>cfunc_adv<span class="main">)</span> <span class="skolem">ia</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inr <span class="main">(</span>Inl <span class="skolem">ia</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">∈</span> <span class="free">IA</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>cfunc_usr<span class="main">)</span> <span class="skolem">iu</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inr <span class="main">(</span>Inr <span class="skolem">iu</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iu</span> <span class="main">∈</span> <span class="free">IU</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> cpoke
      <span class="keyword1"><span class="command">with</span></span> sim_cpoke<span class="main">[</span><span class="operator">OF</span> sim<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span> sim <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> cfunc_adv
      <span class="keyword1"><span class="command">with</span></span> sim_cfunc_adv<span class="main">[</span><span class="operator">OF</span> sim<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cfunc_adv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> sim <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> apfst_def map_prod_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_prod_inj<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> inj_compose <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> cfunc_usr
      <span class="keyword1"><span class="command">with</span></span> sim_cfunc_usr<span class="main">[</span><span class="operator">OF</span> sim<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cfunc_usr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> sim <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> apfst_def map_prod_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_prod_inj<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> inj_compose <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fused_Resource-trace_eq_callee_of_restI"><span class="command">lemma</span></span> trace_eq_callee_of_restI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_callee_eq <span class="main">(</span>callee_of_rest <span class="free">rest1</span><span class="main">)</span> <span class="main">(</span>callee_of_rest <span class="free">rest2</span><span class="main">)</span> <span class="main">(</span><span class="free">IA</span> <span class="main">&lt;+&gt;</span> <span class="free">IU</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"trace_rest_eq <span class="free">rest1</span> <span class="free">rest2</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S_rest</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> rest_start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S_rest</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> step_rfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">S_rest</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟧</span>
       <span class="main">⟹</span> bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_adv <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_adv <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sim_rfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span> <span class="bound">oa</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">S_rest</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟧</span> <span class="main">⟹</span>
        <span class="skolem">S_rest</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> rfunc_adv <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span>
               <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> rfunc_adv <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> step_rfunc_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">S_rest</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟧</span>
        <span class="main">⟹</span> bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_usr <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>rfunc_usr <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sim_rfunc_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span> <span class="bound">ou</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">S_rest</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟧</span> <span class="main">⟹</span>
        <span class="skolem">S_rest</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> rfunc_usr <span class="free">rest1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span>
               <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> rfunc_usr <span class="free">rest2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace_rest_eq_complete<span class="main">)</span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rest_start
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace'_eqI_sim<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> step sim<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>rfunc_adv<span class="main">)</span> <span class="skolem">ia</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inl <span class="skolem">ia</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">∈</span> <span class="free">IA</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>rfunc_usr<span class="main">)</span> <span class="skolem">iu</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inr <span class="skolem">iu</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iu</span> <span class="main">∈</span> <span class="free">IU</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> rfunc_adv
      <span class="keyword1"><span class="command">with</span></span> step_rfunc_adv<span class="main">[</span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rfunc_adv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> rfunc_usr
      <span class="keyword1"><span class="command">with</span></span> step_rfunc_usr<span class="main">[</span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rfunc_usr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sim <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">a</span> <span class="skolem">res</span> <span class="skolem">b</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>rfunc_adv<span class="main">)</span> <span class="skolem">ia</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inl <span class="skolem">ia</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">∈</span> <span class="free">IA</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>rfunc_usr<span class="main">)</span> <span class="skolem">iu</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inr <span class="skolem">iu</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">iu</span> <span class="main">∈</span> <span class="free">IU</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> rfunc_adv
      <span class="keyword1"><span class="command">with</span></span> sim_rfunc_adv<span class="main">[</span><span class="operator">OF</span> sim<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rfunc_adv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> sim <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> apfst_def map_prod_def<span class="main">)</span>
          <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_prod_inj<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> rfunc_usr
      <span class="keyword1"><span class="command">with</span></span> sim_rfunc_usr<span class="main">[</span><span class="operator">OF</span> sim<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rfunc_usr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> sim <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> apfst_def map_prod_def<span class="main">)</span>
          <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_prod_inj<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fused_Resource-trace_callee_resource_of_oracle"><span class="command">lemma</span></span> trace_callee_resource_of_oracle<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_callee run_resource <span class="main">(</span>map_spmf <span class="main">(</span>resource_of_oracle <span class="free">callee</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> trace_callee <span class="free">callee</span> <span class="free">p</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">tr</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="skolem">tr</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">tr</span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">tr</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def spmf.map_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">tr</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace_callee run_resource <span class="main">(</span>map_spmf <span class="main">(</span>RES <span class="free">callee</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">tr</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span>
      trace_callee run_resource <span class="main">(</span>cond_spmf_fst <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> RES <span class="free">callee</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">callee</span> <span class="bound">x</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span><span class="main">)</span> <span class="skolem">tr</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def map_prod_def map_bind_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> trace_callee run_resource <span class="main">(</span>map_spmf <span class="main">(</span>RES <span class="free">callee</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">callee</span> <span class="bound">x</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tr</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> cond_spmf_fst_map_prod_inj<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fused_Resource-trace_callee_resource_of_oracle'"><span class="command">lemma</span></span> trace_callee_resource_of_oracle'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_callee run_resource <span class="main">(</span>return_spmf <span class="main">(</span>resource_of_oracle <span class="free">callee</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> trace_callee <span class="free">callee</span> <span class="main">(</span>return_spmf <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trace_callee_resource_of_oracle<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"return_spmf <span class="free">s</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Fused_Resource-trace_eq_resource_of_oracle"><span class="command">lemma</span></span> trace_eq_resource_of_oracle<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_eq <span class="free">A</span> <span class="main">(</span>map_spmf <span class="main">(</span>resource_of_oracle <span class="free">callee1</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>map_spmf <span class="main">(</span>resource_of_oracle <span class="free">callee2</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span>
   trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trace_callee_eq_def trace_callee_resource_of_oracle <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-WT_fuse_converter"><span class="command">lemma</span></span> WT_fuse_converter <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℐAC</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> map_ℐ id fst <span class="free">ℐAR</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐUC</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> map_ℐ id fst <span class="free">ℐUR</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">ℐE</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐAC</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐUC</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐAR</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐUR</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> fuse_converter <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">∈</span>responses_ℐ <span class="free">ℐAR</span> <span class="bound">x</span><span class="main">.</span> set <span class="bound">es</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐE</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">∈</span>responses_ℐ <span class="free">ℐUR</span> <span class="bound">x</span><span class="main">.</span> set <span class="bound">es</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐE</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fuse_converter_def <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> WT_converter_of_callee<span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def image_image <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_gpv_pauses <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">theorem</span></span> fuse_trace_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">core1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">core2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core'</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rest1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more1</span><span class="main">)</span> rest_scheme"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rest2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest'</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more2</span><span class="main">)</span> rest_scheme"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> core<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_core_eq <span class="free">core1</span> <span class="free">core2</span> <span class="main">(</span>outs_ℐ <span class="free">ℐE</span><span class="main">)</span> <span class="main">(</span>outs_ℐ <span class="free">ℐCA</span><span class="main">)</span> <span class="main">(</span>outs_ℐ <span class="free">ℐCU</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="free">s_core</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="free">s_core'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rest<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_rest_eq <span class="free">rest1</span> <span class="free">rest2</span> <span class="main">(</span>outs_ℐ <span class="free">ℐRA</span><span class="main">)</span> <span class="main">(</span>outs_ℐ <span class="free">ℐRU</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="free">s_rest</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="free">s_rest'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IC1<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>callee_of_core <span class="free">core1</span><span class="main">)</span> <span class="free">IC1</span> <span class="main">(</span><span class="free">ℐE</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐCA</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐCU</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">IC1</span> <span class="free">s_core</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IC2<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>callee_of_core <span class="free">core2</span><span class="main">)</span> <span class="free">IC2</span> <span class="main">(</span><span class="free">ℐE</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐCA</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐCU</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">IC2</span> <span class="free">s_core'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IR1<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>callee_of_rest <span class="free">rest1</span><span class="main">)</span> <span class="free">IR1</span> <span class="main">(</span><span class="free">ℐRA</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐRU</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">IR1</span> <span class="free">s_rest</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IR2<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>callee_of_rest <span class="free">rest2</span><span class="main">)</span> <span class="free">IR2</span> <span class="main">(</span><span class="free">ℐRA</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐRU</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">IR2</span> <span class="free">s_rest'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> E1 <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">∈</span>responses_ℐ <span class="free">ℐRA</span> <span class="bound">x</span><span class="main">.</span> set <span class="bound">es</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐE</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> E2 <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">∈</span>responses_ℐ <span class="free">ℐRU</span> <span class="bound">x</span><span class="main">.</span> set <span class="bound">es</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐE</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="main">(</span>fused_resource.fuse <span class="free">core1</span> <span class="free">rest1</span><span class="main">)</span> <span class="main">(</span>fused_resource.fuse <span class="free">core2</span> <span class="free">rest2</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span>outs_ℐ <span class="free">ℐCA</span> <span class="main">&lt;+&gt;</span> outs_ℐ <span class="free">ℐRA</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span>outs_ℐ <span class="free">ℐCU</span> <span class="main">&lt;+&gt;</span> outs_ℐ <span class="free">ℐRU</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">s_core</span><span class="main">,</span> <span class="free">s_rest</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">s_core'</span><span class="main">,</span> <span class="free">s_rest'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℐC</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">ℐE</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐCA</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐCU</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℐR</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">ℐRA</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐRU</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ℐC</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐR</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℐCA</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> map_ℐ id fst <span class="free">ℐRA</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐCU</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> map_ℐ id fst <span class="free">ℐRU</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">interpret</span></span> fuse1<span class="main">:</span> fused_resource <span class="quoted"><span class="free">core1</span></span> <span class="quoted"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s1</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> fuse2<span class="main">:</span> fused_resource <span class="quoted"><span class="free">core2</span></span> <span class="quoted"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s2</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> IC1<span class="main">:</span> callee_invariant_on <span class="quoted"><span class="quoted">"callee_of_core <span class="free">core1</span>"</span></span> <span class="quoted"><span class="free">IC1</span></span> <span class="var"><span class="quoted"><span class="var">?ℐC</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> IC2<span class="main">:</span> callee_invariant_on <span class="quoted"><span class="quoted">"callee_of_core <span class="free">core2</span>"</span></span> <span class="quoted"><span class="free">IC2</span></span> <span class="var"><span class="quoted"><span class="var">?ℐC</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> IR1<span class="main">:</span> callee_invariant_on <span class="quoted"><span class="quoted">"callee_of_rest <span class="free">rest1</span>"</span></span> <span class="quoted"><span class="free">IR1</span></span> <span class="var"><span class="quoted"><span class="var">?ℐR</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> IR2<span class="main">:</span> callee_invariant_on <span class="quoted"><span class="quoted">"callee_of_rest <span class="free">rest2</span>"</span></span> <span class="quoted"><span class="free">IR2</span></span> <span class="var"><span class="quoted"><span class="var">?ℐR</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">from</span></span> core <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="var">?ℐC</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> callee_of_core <span class="free">core1</span><span class="main">(</span><span class="free">s_core</span><span class="main">)</span> <span class="main">≈</span> callee_of_core <span class="free">core2</span><span class="main">(</span><span class="free">s_core'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_eq_callee_of_coreI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="var">?ℐC</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> RES <span class="main">(</span>callee_of_core <span class="free">core1</span><span class="main">)</span> <span class="free">s_core</span> <span class="main">≈</span> RES <span class="main">(</span>callee_of_core <span class="free">core2</span><span class="main">)</span> <span class="free">s_core'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="var">?ℐR</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> callee_of_rest <span class="free">rest1</span><span class="main">(</span><span class="free">s_rest</span><span class="main">)</span> <span class="main">≈</span> callee_of_rest <span class="free">rest2</span><span class="main">(</span><span class="free">s_rest'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rest
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_eq_callee_of_restI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="var">?ℐR</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> RES <span class="main">(</span>callee_of_rest <span class="free">rest1</span><span class="main">)</span> <span class="free">s_rest</span> <span class="main">≈</span> RES <span class="main">(</span>callee_of_rest <span class="free">rest2</span><span class="main">)</span> <span class="free">s_rest'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="var">?ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span>
    RES <span class="main">(</span>callee_of_core <span class="free">core1</span><span class="main">)</span> <span class="free">s_core</span> <span class="main">∥</span> RES <span class="main">(</span>callee_of_rest <span class="free">rest1</span><span class="main">)</span> <span class="free">s_rest</span> <span class="main">≈</span>
    RES <span class="main">(</span>callee_of_core <span class="free">core2</span><span class="main">)</span> <span class="free">s_core'</span> <span class="main">∥</span> RES <span class="main">(</span>callee_of_rest <span class="free">rest2</span><span class="main">)</span> <span class="free">s_rest'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_eq'_parallel_resource<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="var">?ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> fuse_converter <span class="main">⊳</span> <span class="main">(</span>RES <span class="main">(</span>callee_of_core <span class="free">core1</span><span class="main">)</span> <span class="free">s_core</span> <span class="main">∥</span> RES <span class="main">(</span>callee_of_rest <span class="free">rest1</span><span class="main">)</span> <span class="free">s_rest</span><span class="main">)</span> <span class="main">≈</span>
                      fuse_converter <span class="main">⊳</span> <span class="main">(</span>RES <span class="main">(</span>callee_of_core <span class="free">core2</span><span class="main">)</span> <span class="free">s_core'</span> <span class="main">∥</span> RES <span class="main">(</span>callee_of_rest <span class="free">rest2</span><span class="main">)</span> <span class="free">s_rest'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> attach_trace_eq'<span class="main">)</span><span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> IC1.WT_resource_of_oracle IC1 IC2.WT_resource_of_oracle IC2 IR1.WT_resource_of_oracle IR1 IR2.WT_resource_of_oracle IR2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"trace_eq' <span class="main">(</span>outs_ℐ <span class="var">?ℐ</span><span class="main">)</span> <span class="main">(</span>resource_of_oracle <span class="main">(</span>fuse1.fuse <span class="free">rest1</span><span class="main">)</span> <span class="main">(</span><span class="free">s_core</span><span class="main">,</span> <span class="free">s_rest</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>resource_of_oracle <span class="main">(</span>fuse2.fuse <span class="free">rest2</span><span class="main">)</span> <span class="main">(</span><span class="free">s_core'</span><span class="main">,</span> <span class="free">s_rest'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fuse_converter <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">trace_eq_simcl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s1</span> spmf <span class="main">⇒</span> <span class="tfree">'s2</span> spmf <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s1</span> spmf <span class="main">⇒</span> <span class="tfree">'s2</span> spmf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">S</span> <span class="keyword2"><span class="keyword">where</span></span>
  base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">trace_eq_simcl</span> <span class="free">S</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">p</span> <span class="free">q</span>
<span class="main">|</span> bind_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">trace_eq_simcl</span> <span class="free">S</span> <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">::</span> nat<span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Fused_Resource-trace_eq_simcl_bindI"><span class="command">lemma</span></span> trace_eq_simcl_bindI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_spmf <span class="free">p</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> bind_spmf_to_nat_on<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.bind_nat <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-trace_eq_simcl_bind"><span class="command">lemma</span></span> trace_eq_simcl_bind<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_spmf <span class="free">p</span> <span class="main">⟹</span> trace_eq_simcl <span class="free">S</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat spmf"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_spmf <span class="free">p</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> bind_spmf <span class="main">(</span><span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> bind_spmf <span class="main">(</span><span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">G</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set_spmf <span class="main">(</span><span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span><span class="skolem">F</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">G</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">atomize_elim</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> choice_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> * <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"return_spmf <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bind_spmf <span class="free">p</span> <span class="free">f</span> <span class="main">=</span> bind_spmf <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_spmf <span class="main">(</span>Pair <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="skolem">F</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def ** <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bind_spmf <span class="free">p</span> <span class="free">g</span> <span class="main">=</span> bind_spmf <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_spmf <span class="main">(</span>Pair <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="skolem">G</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def ** <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bindI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> **<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fused_Resource-trace_eq_simcl_bind1_scale"><span class="command">lemma</span></span> trace_eq_simcl_bind1_scale<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>scale_spmf <span class="main">(</span>weight_spmf <span class="free">p</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set_spmf <span class="free">p</span><span class="main">.</span> trace_eq_simcl <span class="free">S</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bind<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_const<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fused_Resource-trace_eq_simcl_bind1"><span class="command">lemma</span></span> trace_eq_simcl_bind1<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set_spmf <span class="free">p</span><span class="main">.</span> trace_eq_simcl <span class="free">S</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trace_eq_simcl_bind1_scale<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless_weight_spmfD<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-trace_eq_simcl_bind2_scale"><span class="command">lemma</span></span> trace_eq_simcl_bind2_scale<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="main">(</span>scale_spmf <span class="main">(</span>weight_spmf <span class="free">q</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>bind_spmf <span class="free">q</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set_spmf <span class="free">q</span><span class="main">.</span> trace_eq_simcl <span class="free">S</span> <span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="main">(</span>bind_spmf <span class="free">q</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>bind_spmf <span class="free">q</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bind<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_const<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fused_Resource-trace_eq_simcl_bind2"><span class="command">lemma</span></span> trace_eq_simcl_bind2<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="free">p</span> <span class="main">(</span>bind_spmf <span class="free">q</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set_spmf <span class="free">q</span><span class="main">.</span> trace_eq_simcl <span class="free">S</span> <span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trace_eq_simcl_bind2_scale<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless_weight_spmfD<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-trace_eq_simcl_return_pmf_None"><span class="command">lemma</span></span> trace_eq_simcl_return_pmf_None <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="main">(</span>return_pmf None<span class="main">)</span> <span class="main">(</span>return_pmf None<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s1</span> spmf <span class="main">⇒</span> <span class="tfree">'s2</span> spmf <span class="main">⇒</span> bool"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="main">(</span>bind_spmf <span class="main">(</span>return_pmf None<span class="main">)</span> <span class="main">(</span>undefined <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'s1</span> spmf<span class="main">)</span><span class="main">)</span> <span class="main">(</span>bind_spmf <span class="main">(</span>return_pmf None<span class="main">)</span> <span class="main">(</span>undefined <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'s2</span> spmf<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bindI<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fused_Resource-trace_eq_simcl_map"><span class="command">lemma</span></span> trace_eq_simcl_map<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="main">(</span>map_spmf <span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>map_spmf <span class="free">g</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set_spmf <span class="free">p</span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_spmf_conv_bind_spmf
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bindI<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-trace_eq_simcl_map1"><span class="command">lemma</span></span> trace_eq_simcl_map1<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="main">(</span>map_spmf <span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set_spmf <span class="free">p</span><span class="main">.</span> trace_eq_simcl <span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_spmf_conv_bind_spmf
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bind1<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-trace_eq_simcl_map2"><span class="command">lemma</span></span> trace_eq_simcl_map2<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="free">p</span> <span class="main">(</span>map_spmf <span class="free">f</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set_spmf <span class="free">q</span><span class="main">.</span> trace_eq_simcl <span class="free">S</span> <span class="free">p</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_spmf_conv_bind_spmf
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bind2<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-trace_eq_simcl_return_spmf"><span class="command">lemma</span></span> trace_eq_simcl_return_spmf <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="main">(</span>return_spmf <span class="free">x</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">S</span> <span class="main">(</span>return_spmf <span class="free">x</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">erule</span> trace_eq_simcl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sym<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"return_spmf <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_return_spmf <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lossless_spmfD_set_spmf_nonempty<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base<span class="main">)</span>

<span class="keyword1" id="Fused_Resource-trace_eq_simcl_callee"><span class="command">lemma</span></span> trace_eq_simcl_callee<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">callee1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> callee"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">callee2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> callee"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span>
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span> <span class="bound">res</span> <span class="bound">b</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="bound">res</span> <span class="main">∈</span> set_spmf <span class="bound">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee2</span> <span class="bound">res</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> trace_eq_simcl <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>
            <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> trace_eq_simcl_callee_step<span class="main">:</span> <span class="quoted"><span class="quoted">"bind_spmf <span class="free">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee1</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="free">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?step</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> trace_eq_simcl_callee_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">res</span> <span class="bound">b</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">res</span> <span class="main">∈</span> set_spmf <span class="free">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee2</span> <span class="bound">res</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> trace_eq_simcl <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>
                            <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">res</span> <span class="bound">b</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="var">?res</span> <span class="bound">res</span><span class="main">;</span> <span class="var">?b</span> <span class="bound">res</span> <span class="bound">b</span> <span class="bound">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="var">?sim</span> <span class="bound">res</span> <span class="bound">b</span> <span class="bound">s'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> eq<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?step</span></span></span> <span class="keyword1"><span class="command">using</span></span> start a <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sim</span> <span class="skolem">res</span> <span class="skolem">b</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?res</span> <span class="skolem">res</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="skolem">res</span> <span class="skolem">b</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">res</span> <span class="skolem">b</span> <span class="skolem">s'</span> <span class="keyword1"><span class="command">using</span></span> start
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sim<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>bind_nat <span class="skolem">X</span> <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cond_bind_spmf_fst <span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> map_spmf fst <span class="main">(</span>bind_spmf <span class="main">(</span><span class="skolem">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cond_bind_spmf_fst <span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> map_spmf fst <span class="main">(</span>bind_spmf <span class="main">(</span><span class="skolem">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">=</span> bind_spmf <span class="var">?Y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cond_spmf_fst <span class="main">(</span>bind_spmf <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bind_nat <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_bind o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">=</span> bind_spmf <span class="var">?Y'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cond_spmf_fst <span class="main">(</span>bind_spmf <span class="main">(</span><span class="skolem">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bind_nat <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_bind o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="main">=</span> <span class="var">?Y'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bind_nat eq
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> spmf_eqI<span class="main">)</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def spmf_eq_0_set_spmf <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ a<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span><span class="main">)</span>
        <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bind_nat a
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bind<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sim <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> trace'_eqI_sim_upto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">callee1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> callee"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">callee2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> callee"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span>
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span> <span class="bound">res</span> <span class="bound">b</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="bound">res</span> <span class="main">∈</span> set_spmf <span class="bound">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee2</span> <span class="bound">res</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> trace_eq_simcl <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>
            <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> start <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl.base<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace'_eqI_sim<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_callee<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step sim<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fused_Resource-trace_core_eq_simI_upto"><span class="command">lemma</span></span> trace_core_eq_simI_upto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">core1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">core2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core'</span><span class="main">,</span> <span class="tfree">'event</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s_core</span> spmf <span class="main">⇒</span> <span class="tfree">'s_core'</span> spmf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_cpoke<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      weight_spmf <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core1</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> weight_spmf <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core2</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim_cpoke<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      trace_eq_simcl <span class="free">S</span> <span class="main">(</span>mk_lossless <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core1</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mk_lossless <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core2</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_cfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim_cfunc_adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">ia</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s1'</span> <span class="bound">s2'</span> <span class="bound">oa</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">ia</span> <span class="main">∈</span> <span class="free">IA</span><span class="main">;</span> 
      <span class="bound">s1</span> <span class="main">∈</span> set_spmf <span class="bound">p</span><span class="main">;</span> <span class="bound">s2</span> <span class="main">∈</span> set_spmf <span class="bound">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">oa</span><span class="main">,</span> <span class="bound">s1'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">oa</span><span class="main">,</span> <span class="bound">s2'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> trace_eq_simcl <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="bound">oa</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_cfunc_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span> <span class="main">⟧</span> <span class="main">⟹</span> 
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> map_spmf fst <span class="main">(</span>cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim_cfunc_usr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">iu</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s1'</span> <span class="bound">s2'</span> <span class="bound">ou</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">iu</span> <span class="main">∈</span> <span class="free">IU</span><span class="main">;</span> 
      <span class="bound">s1</span> <span class="main">∈</span> set_spmf <span class="bound">p</span><span class="main">;</span> <span class="bound">s2</span> <span class="main">∈</span> set_spmf <span class="bound">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">ou</span><span class="main">,</span> <span class="bound">s1'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">ou</span><span class="main">,</span> <span class="bound">s2'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> trace_eq_simcl <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="bound">iu</span><span class="main">)</span><span class="main">)</span> <span class="bound">ou</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_core_eq <span class="free">core1</span> <span class="free">core2</span> <span class="free">E</span> <span class="free">IA</span> <span class="free">IU</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"trace_eq_simcl <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> start <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl.base<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> trace_core_eq_simI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> Step_cpoke Sim_cpoke Step_cfunc_adv Sim_cfunc_adv Step_cfunc_usr Sim_cfunc_usr<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Step_cpoke <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">e</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step_cpoke
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weight_bind_spmf o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Bochner_Integration.integral_cong_AE<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> eq <span class="main">=</span> this

    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sim_cpoke <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">e</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Sim_cpoke<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sim_cpoke<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>bind_nat <span class="skolem">X</span> <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cond_bind_spmf <span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">y</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core1</span> <span class="bound">s</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">=</span> cond_bind_spmf <span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">y</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> cpoke <span class="free">core2</span> <span class="bound">s</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq<span class="main">[</span><span class="operator">OF</span> Sim_cpoke<span class="main">]</span> step_cpoke Sim_cpoke
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> spmf_eqI<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weight_spmf_def measure_spmf_zero_iff bind_UNION spmf_eq_0_set_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> bind_nat Sim_cpoke sim_cpoke
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_bind_spmf cond_spmf_UNIV<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cond_spmf_UNIV <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bind<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Step_cfunc_adv <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">ia</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step_cfunc_adv <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> eq <span class="main">=</span> this

    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sim_cfunc_adv <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">ia</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s1'</span> <span class="skolem">s2'</span> <span class="skolem">oa</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Sim_cfunc_adv<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sim_cfunc_adv<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>bind_nat <span class="skolem">X</span> <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cond_bind_spmf_fst <span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="skolem">f</span> <span class="bound">y</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_adv <span class="free">core1</span> <span class="bound">s1</span> <span class="skolem">ia</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">oa</span> <span class="main">=</span>
            cond_bind_spmf_fst <span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="skolem">g</span> <span class="bound">y</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_adv <span class="free">core2</span> <span class="bound">s2</span> <span class="skolem">ia</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">oa</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq<span class="main">[</span><span class="operator">OF</span> Sim_cfunc_adv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> spmf_eqI<span class="main">)</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def spmf_eq_0_set_spmf <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> step_cfunc_adv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Sim_cfunc_adv<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> bind_nat<span class="main">(</span>3-<span class="main">)</span> Sim_cfunc_adv<span class="main">(</span>1-2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> bind_nat<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> bind_spmf_assoc
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bind<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> step_cfunc_adv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bind_nat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Sim_cfunc_adv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"set_spmf"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> equalityD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def bind_UNION<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> subsetD<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sim_cfunc_adv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Step_cfunc_usr <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">iu</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step_cfunc_usr <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> eq <span class="main">=</span> this

    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sim_cfunc_usr <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">iu</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s1'</span> <span class="skolem">s2'</span> <span class="skolem">ou</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Sim_cfunc_usr<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sim_cfunc_usr<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>bind_nat <span class="skolem">X</span> <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cond_bind_spmf_fst <span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="skolem">f</span> <span class="bound">y</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s1</span><span class="main">.</span> cfunc_usr <span class="free">core1</span> <span class="bound">s1</span> <span class="skolem">iu</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ou</span> <span class="main">=</span>
            cond_bind_spmf_fst <span class="skolem">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="skolem">g</span> <span class="bound">y</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s2</span><span class="main">.</span> cfunc_usr <span class="free">core2</span> <span class="bound">s2</span> <span class="skolem">iu</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ou</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq<span class="main">[</span><span class="operator">OF</span> Sim_cfunc_usr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> spmf_eqI<span class="main">)</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def spmf_eq_0_set_spmf <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> step_cfunc_usr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Sim_cfunc_usr<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> bind_nat<span class="main">(</span>3-<span class="main">)</span> Sim_cfunc_usr<span class="main">(</span>1-2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> bind_nat<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> bind_spmf_assoc
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bind<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> step_cfunc_usr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bind_nat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Sim_cfunc_usr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"set_spmf"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> equalityD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def bind_UNION<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> subsetD<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sim_cfunc_usr<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event1</span> <span class="main">+</span> <span class="tfree">'event2</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event2</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> rest_scheme"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">core_with_rest</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span> <span class="main">×</span> <span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'event1</span><span class="main">,</span> <span class="tfree">'iadv_core</span> <span class="main">+</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_core</span> <span class="main">+</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_core</span> <span class="main">+</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_core</span> <span class="main">+</span> <span class="tfree">'ousr_rest</span><span class="main">)</span> core"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"cpoke <span class="free">core_with_rest</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_core</span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span> <span class="bound">e</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s_core'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s_core'</span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cpoke <span class="free">core</span> <span class="bound">s_core</span> <span class="main">(</span>Inl <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">core_with_rest</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_core</span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span> <span class="bound">iadv</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">iadv</span> <span class="keyword1">of</span>
       Inl <span class="bound">iadv_core</span> <span class="main">⇒</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">oadv_core</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Inl <span class="bound">oadv_core</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_core'</span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cfunc_adv <span class="free">core</span> <span class="bound">s_core</span> <span class="bound">iadv_core</span><span class="main">)</span>
     <span class="main">|</span> Inr <span class="bound">iadv_rest</span> <span class="main">⇒</span> 
       bind_spmf <span class="main">(</span>rfunc_adv <span class="free">rest</span> <span class="bound">s_rest</span> <span class="bound">iadv_rest</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">oadv_rest</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_rest'</span><span class="main">)</span><span class="main">.</span> 
         map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s_core'</span><span class="main">.</span> <span class="main">(</span>Inr <span class="bound">oadv_rest</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_core'</span><span class="main">,</span> <span class="bound">s_rest'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="main">(</span>cpoke <span class="free">core</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="bound">s_core</span><span class="main">)</span> <span class="main">(</span>map Inr <span class="bound">es</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">core_with_rest</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_core</span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span> <span class="bound">iusr</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">iusr</span> <span class="keyword1">of</span>
       Inl <span class="bound">iusr_core</span> <span class="main">⇒</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">ousr_core</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Inl <span class="bound">ousr_core</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_core'</span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cfunc_usr <span class="free">core</span> <span class="bound">s_core</span> <span class="bound">iusr_core</span><span class="main">)</span>
     <span class="main">|</span> Inr <span class="bound">iusr_rest</span> <span class="main">⇒</span>
       bind_spmf <span class="main">(</span>rfunc_usr <span class="free">rest</span> <span class="bound">s_rest</span> <span class="bound">iusr_rest</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">ousr_rest</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_rest'</span><span class="main">)</span><span class="main">.</span>
         map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s_core'</span><span class="main">.</span> <span class="main">(</span>Inr <span class="bound">ousr_rest</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_core'</span><span class="main">,</span> <span class="bound">s_rest'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="main">(</span>cpoke <span class="free">core</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="bound">s_core</span><span class="main">)</span> <span class="main">(</span>map Inr <span class="bound">es</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Fused_Resource-fuse_core_with_rest"><span class="command">lemma</span></span> fuse_core_with_rest<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'event1</span> <span class="main">+</span> <span class="tfree">'event2</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rest1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest1</span><span class="main">,</span> <span class="tfree">'event1</span><span class="main">,</span> <span class="tfree">'iadv_rest1</span><span class="main">,</span> <span class="tfree">'iusr_rest1</span><span class="main">,</span> <span class="tfree">'oadv_rest1</span><span class="main">,</span> <span class="tfree">'ousr_rest1</span><span class="main">,</span> <span class="tfree">'more1</span><span class="main">)</span> rest_scheme"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rest2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest2</span><span class="main">,</span> <span class="tfree">'event2</span><span class="main">,</span> <span class="tfree">'iadv_rest2</span><span class="main">,</span> <span class="tfree">'iusr_rest2</span><span class="main">,</span> <span class="tfree">'oadv_rest2</span><span class="main">,</span> <span class="tfree">'ousr_rest2</span><span class="main">,</span> <span class="tfree">'more2</span><span class="main">)</span> rest_scheme"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"fused_resource.fuse <span class="free">core</span> <span class="main">(</span>parallel_rest <span class="free">rest1</span> <span class="free">rest2</span><span class="main">)</span> <span class="main">(</span><span class="free">s_core</span><span class="main">,</span> <span class="main">(</span><span class="free">s_rest1</span><span class="main">,</span> <span class="free">s_rest2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
   map_fun <span class="main">(</span>map_sum <span class="main">(</span>lsumr <span class="main">∘</span> map_sum id swap_sum<span class="main">)</span> <span class="main">(</span>lsumr <span class="main">∘</span> map_sum id swap_sum<span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_spmf <span class="main">(</span>map_prod <span class="main">(</span>map_sum <span class="main">(</span>map_sum id swap_sum <span class="main">∘</span> rsuml<span class="main">)</span> <span class="main">(</span>map_sum id swap_sum <span class="main">∘</span> rsuml<span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_prod id prod.swap <span class="main">∘</span> rprodl<span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">(</span>fused_resource.fuse <span class="main">(</span>core_with_rest <span class="free">core</span> <span class="free">rest2</span><span class="main">)</span> <span class="free">rest1</span> <span class="main">(</span><span class="main">(</span><span class="free">s_core</span><span class="main">,</span> <span class="free">s_rest2</span><span class="main">)</span><span class="main">,</span> <span class="free">s_rest1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>parallel_rest <span class="free">rest1</span> <span class="free">rest2</span><span class="main">,</span> <span class="main">(</span><span class="free">s_core</span><span class="main">,</span> <span class="main">(</span><span class="free">s_rest1</span><span class="main">,</span> <span class="free">s_rest2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fused_resource.fuse.cases<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fused_resource.fuse.simps map_bind_spmf bind_map_spmf map_prod_def split_def o_def parallel_eoracle_def parallel_oracle_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> foldl_spmf_pair_left<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> split_def<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_fun_def o_def bind_map_spmf<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="State_Isomorphism">
<div class="head">
<h1>Theory State_Isomorphism</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> State_Isomorphism
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#More_CC">More_CC</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹State Isomorphism›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> state_iso <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">state_iso</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> state_iso <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">state_iso</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">.</span> type_definition <span class="bound">f</span> <span class="bound">g</span> UNIV<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">apply_state_iso</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="tfree">'s1</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> state_iso <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s1</span><span class="main">,</span> <span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> oracle' <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s2</span><span class="main">,</span> <span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> oracle'"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">apply_state_iso</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">.</span> map_fun <span class="bound">g</span> <span class="main">(</span>map_fun id <span class="main">(</span>map_spmf <span class="main">(</span>map_prod id <span class="bound">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="State_Isomorphism-apply_state_iso_id"><span class="command">lemma</span></span> apply_state_iso_id<span class="main">:</span> <span class="quoted"><span class="quoted">"apply_state_iso <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_state_iso_def map_prod.id spmf.map_id0 map_fun_id<span class="main">)</span> 

<span class="keyword1" id="State_Isomorphism-apply_state_iso_compose"><span class="command">lemma</span></span> apply_state_iso_compose<span class="main">:</span> <span class="quoted"><span class="quoted">"apply_state_iso <span class="free">si1</span> <span class="main">(</span>apply_state_iso <span class="free">si2</span> <span class="free">oracle</span><span class="main">)</span> <span class="main">=</span> 
    apply_state_iso <span class="main">(</span>map_prod <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">o</span> <span class="main">(</span>fst <span class="free">si2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">(o)</span> <span class="main">(</span>snd <span class="free">si2</span><span class="main">)</span><span class="main">)</span> <span class="free">si1</span><span class="main">)</span> <span class="free">oracle</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> apply_state_iso_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def id_def o_def map_prod_def map_fun_def map_spmf_conv_bind_spmf<span class="main">)</span>

<span class="keyword1" id="State_Isomorphism-apply_wiring_state_iso_assoc"><span class="command">lemma</span></span> apply_wiring_state_iso_assoc<span class="main">:</span>
    <span class="quoted"><span class="quoted">"apply_wiring <span class="free">wr</span> <span class="main">(</span>apply_state_iso <span class="free">si</span> <span class="free">oracle</span><span class="main">)</span> <span class="main">=</span> apply_state_iso <span class="free">si</span> <span class="main">(</span>apply_wiring <span class="free">wr</span> <span class="free">oracle</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> apply_state_iso_def apply_wiring_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def id_def o_def map_prod_def map_fun_def map_spmf_conv_bind_spmf<span class="main">)</span>

<span class="keyword1" id="State_Isomorphism-resource_of_oracle_state_iso"><span class="command">lemma</span></span> 
  resource_of_oracle_state_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"state_iso <span class="free">fg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"resource_of_oracle <span class="main">(</span>apply_state_iso <span class="free">fg</span> <span class="free">oracle</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> resource_of_oracle <span class="free">oracle</span> <span class="main">(</span>snd <span class="free">fg</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="free">fg</span> <span class="main">(</span>fst <span class="free">fg</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_iso_def split_beta type_definition.Rep_inverse<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def spmf_rel_map apply_state_iso_def split_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Parallel State Isomorphism›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">parallel_state_iso</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">(</span><span class="tfree">'s_core1</span> <span class="main">×</span> <span class="tfree">'s_core2</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'s_rest1</span> <span class="main">×</span> <span class="tfree">'s_rest2</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="tfree">'s_core1</span> <span class="main">×</span> <span class="tfree">'s_rest1</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'s_core2</span> <span class="main">×</span> <span class="tfree">'s_rest2</span><span class="main">)</span><span class="main">)</span> state_iso"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">parallel_state_iso</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s11</span><span class="main">,</span> <span class="bound">s12</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">s21</span><span class="main">,</span> <span class="bound">s22</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">s11</span><span class="main">,</span> <span class="bound">s21</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">s12</span><span class="main">,</span> <span class="bound">s22</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s11</span><span class="main">,</span> <span class="bound">s21</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">s12</span><span class="main">,</span> <span class="bound">s22</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">s11</span><span class="main">,</span> <span class="bound">s12</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">s21</span><span class="main">,</span> <span class="bound">s22</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="State_Isomorphism-state_iso_parallel_state_iso"><span class="command">lemma</span></span> 
  state_iso_parallel_state_iso <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"state_iso parallel_state_iso"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> type_definition_def state_iso_def parallel_state_iso_def<span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Trisplit State Isomorphism›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">iso_trisplit</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">iso_trisplit</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">s11</span><span class="main">,</span> <span class="bound">s12</span><span class="main">)</span><span class="main">,</span> <span class="bound">s13</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">s21</span><span class="main">,</span> <span class="bound">s22</span><span class="main">)</span><span class="main">,</span> <span class="bound">s23</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">s11</span><span class="main">,</span> <span class="bound">s21</span><span class="main">)</span><span class="main">,</span> <span class="bound">s12</span><span class="main">,</span> <span class="bound">s22</span><span class="main">)</span><span class="main">,</span> <span class="bound">s13</span><span class="main">,</span> <span class="bound">s23</span><span class="main">)</span><span class="main">,</span>
        <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">s11</span><span class="main">,</span> <span class="bound">s21</span><span class="main">)</span><span class="main">,</span> <span class="bound">s12</span><span class="main">,</span> <span class="bound">s22</span><span class="main">)</span><span class="main">,</span> <span class="bound">s13</span><span class="main">,</span> <span class="bound">s23</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">s11</span><span class="main">,</span> <span class="bound">s12</span><span class="main">)</span><span class="main">,</span> <span class="bound">s13</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">s21</span><span class="main">,</span> <span class="bound">s22</span><span class="main">)</span><span class="main">,</span> <span class="bound">s23</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="State_Isomorphism-state_iso_fuse_par"><span class="command">lemma</span></span> 
  state_iso_fuse_par <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"state_iso iso_trisplit"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_iso_def iso_trisplit_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Assocl-Swap State Isomorphism›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">iso_swapar</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">iso_swapar</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">sm</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">sm</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">,</span> <span class="main">λ</span><span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">sm</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">sm</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="State_Isomorphism-state_iso_swapar"><span class="command">lemma</span></span> 
  state_iso_swapar <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"state_iso iso_swapar"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_iso_def iso_swapar_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Construction_Utility">
<div class="head">
<h1>Theory Construction_Utility</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Construction_Utility
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#Fused_Resource">Fused_Resource</a>
    <a href="#State_Isomorphism">State_Isomorphism</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹Dummy converters that return a constant value on their external interface›</span>

<span class="keyword1"><span class="command">primcorec</span></span> 
  <span class="entity">ldummy_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i_cnv</span><span class="main">,</span> <span class="tfree">'o_cnv</span><span class="main">,</span> <span class="tfree">'i_res</span><span class="main">,</span> <span class="tfree">'o_res</span><span class="main">)</span> converter <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'i_cnv</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'o_cnv</span><span class="main">,</span> <span class="tfree">'i_res</span><span class="main">,</span> <span class="tfree">'o_res</span><span class="main">)</span> converter"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span><span class="free">ldummy_converter</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">inp</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">inp</span> <span class="keyword1">of</span>
      Inl <span class="bound">x</span> <span class="main">⇒</span> map_gpv <span class="main">(</span>map_prod Inl <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">ldummy_converter</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>Done <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> map_gpv <span class="main">(</span>map_prod Inr <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="free">ldummy_converter</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> 
  <span class="entity">rdummy_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i_cnv</span><span class="main">,</span> <span class="tfree">'o_cnv</span><span class="main">,</span> <span class="tfree">'i_res</span><span class="main">,</span> <span class="tfree">'o_res</span><span class="main">)</span> converter <span class="main">⇒</span> 
    <span class="main">(</span><span class="tfree">'i_cnv</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'o_cnv</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'i_res</span><span class="main">,</span> <span class="tfree">'o_res</span><span class="main">)</span> converter"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span><span class="free">rdummy_converter</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">inp</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">inp</span> <span class="keyword1">of</span>
      Inl <span class="bound">x</span> <span class="main">⇒</span> map_gpv <span class="main">(</span>map_prod Inl <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="free">rdummy_converter</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">x</span><span class="main">)</span>
    <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> map_gpv <span class="main">(</span>map_prod Inr <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">rdummy_converter</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>Done <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Construction_Utility-ldummy_converter_of_callee"><span class="command">lemma</span></span> ldummy_converter_of_callee<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"ldummy_converter <span class="free">f</span> <span class="main">(</span>converter_of_callee <span class="free">callee</span> <span class="free">state</span><span class="main">)</span> <span class="main">=</span> 
    converter_of_callee <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">ql</span><span class="main">.</span> Done <span class="main">(</span>Inl <span class="main">(</span><span class="free">f</span> <span class="bound">ql</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">qr</span><span class="main">.</span> map_gpv <span class="main">(</span>map_prod Inr id<span class="main">)</span> id <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">qr</span><span class="main">)</span><span class="main">)</span>  <span class="bound">q</span><span class="main">)</span>  <span class="free">state</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">callee</span></span> <span class="quoted"><span class="free">state</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>rel_funI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map map_prod_def split_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gpv.rel_mono_strong0<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_eq<span class="main">)</span>

<span class="keyword1" id="Construction_Utility-rdummy_converter_of_callee"><span class="command">lemma</span></span> rdummy_converter_of_callee<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"rdummy_converter <span class="free">f</span> <span class="main">(</span>converter_of_callee <span class="free">callee</span> <span class="free">state</span><span class="main">)</span> <span class="main">=</span> 
    converter_of_callee <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">ql</span><span class="main">.</span> map_gpv <span class="main">(</span>map_prod Inl id<span class="main">)</span> id <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">ql</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">qr</span><span class="main">.</span> Done <span class="main">(</span>Inr <span class="main">(</span><span class="free">f</span> <span class="bound">qr</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>  <span class="bound">q</span><span class="main">)</span> <span class="free">state</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">callee</span></span> <span class="quoted"><span class="free">state</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>rel_funI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map map_prod_def split_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gpv.rel_mono_strong0<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_eq<span class="main">)</span>



<span class="comment1">― ‹Commonly used wirings›</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">cnv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'icnv_usr1</span><span class="main">,</span> <span class="tfree">'ocnv_usr1</span><span class="main">,</span> <span class="tfree">'iusr1_res1</span> <span class="main">+</span> <span class="tfree">'iusr1_res2</span><span class="main">,</span> <span class="tfree">'ousr1_res1</span> <span class="main">+</span> <span class="tfree">'ousr1_res2</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">cnv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'icnv_usr2</span><span class="main">,</span> <span class="tfree">'ocnv_usr2</span><span class="main">,</span> <span class="tfree">'iusr2_res1</span> <span class="main">+</span> <span class="tfree">'iusr2_res2</span><span class="main">,</span> <span class="tfree">'ousr2_res1</span> <span class="main">+</span> <span class="tfree">'ousr2_res2</span><span class="main">)</span> converter"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹c1r22: a converter that has 1 interface and sends queries to two resources,
   where the first and second resources have 2 and 2 interfaces respectively›</span>
  
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">wiring_c1r22_c1r22</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'icnv_usr1</span> <span class="main">+</span> <span class="tfree">'icnv_usr2</span><span class="main">,</span> <span class="tfree">'ocnv_usr1</span> <span class="main">+</span> <span class="tfree">'ocnv_usr2</span><span class="main">,</span> 
    <span class="main">(</span><span class="tfree">'iusr1_res1</span> <span class="main">+</span> <span class="tfree">'iusr2_res1</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'iusr1_res2</span> <span class="main">+</span> <span class="tfree">'iusr2_res2</span><span class="main">,</span> 
    <span class="main">(</span><span class="tfree">'ousr1_res1</span> <span class="main">+</span> <span class="tfree">'ousr2_res1</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'ousr1_res2</span> <span class="main">+</span> <span class="tfree">'ousr2_res2</span><span class="main">)</span> converter"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">wiring_c1r22_c1r22</span>  <span class="main">≡</span> <span class="main">(</span><span class="free">cnv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">cnv2</span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="comment1">― ‹Special wiring converters used for the parallel composition of Fused resources›</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fused_wiring</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="tfree">'iadv_core1</span> <span class="main">+</span> <span class="tfree">'iadv_core2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'iadv_rest1</span> <span class="main">+</span> <span class="tfree">'iadv_rest2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
      <span class="main">(</span><span class="main">(</span><span class="tfree">'iusr_core1</span> <span class="main">+</span> <span class="tfree">'iusr_core2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'iusr_rest1</span> <span class="main">+</span> <span class="tfree">'iusr_rest2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
    <span class="main">(</span><span class="main">(</span><span class="tfree">'oadv_core1</span> <span class="main">+</span> <span class="tfree">'oadv_core2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'oadv_rest1</span> <span class="main">+</span> <span class="tfree">'oadv_rest2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
      <span class="main">(</span><span class="main">(</span><span class="tfree">'ousr_core1</span> <span class="main">+</span> <span class="tfree">'ousr_core2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'ousr_rest1</span> <span class="main">+</span> <span class="tfree">'ousr_rest2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'iadv_core1</span> <span class="main">+</span> <span class="tfree">'iadv_rest1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'iusr_core1</span> <span class="main">+</span> <span class="tfree">'iusr_rest1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
      <span class="main">(</span><span class="main">(</span><span class="tfree">'iadv_core2</span> <span class="main">+</span> <span class="tfree">'iadv_rest2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'iusr_core2</span> <span class="main">+</span> <span class="tfree">'iusr_rest2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'oadv_core1</span> <span class="main">+</span> <span class="tfree">'oadv_rest1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'ousr_core1</span> <span class="main">+</span> <span class="tfree">'ousr_rest1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
      <span class="main">(</span><span class="main">(</span><span class="tfree">'oadv_core2</span> <span class="main">+</span> <span class="tfree">'oadv_rest2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'ousr_core2</span> <span class="main">+</span> <span class="tfree">'ousr_rest2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> converter"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">fused_wiring</span> <span class="main">≡</span> <span class="main">(</span>parallel_wiring <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> parallel_wiring<span class="main">)</span> <span class="main">⊙</span> parallel_wiring"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">fused_wiring<span class="hidden">⇩</span><sub>w</sub></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">fused_wiring<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">≡</span> <span class="main">(</span>parallel_wiring<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> parallel_wiring<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> parallel_wiring<span class="hidden">⇩</span><sub>w</sub>"</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  wiring_fused_wiring<span class="main">[</span><span class="operator">wiring_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wiring <span class="var">?ℐ1</span> <span class="var">?ℐ2</span> fused_wiring fused_wiring<span class="hidden">⇩</span><sub>w</sub>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fused_wiring_def fused_wiring<span class="hidden">⇩</span><sub>w</sub>_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wiring_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> WT_fused_wiring <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ1</span><span class="main">,</span> <span class="var">?ℐ2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> fused_wiring <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fused_wiring_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>



<span class="comment1">― ‹Commonlu used attachments›</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">cnv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'icnv_usr1</span><span class="main">,</span> <span class="tfree">'ocnv_usr1</span><span class="main">,</span> <span class="tfree">'iusr1_core1</span> <span class="main">+</span> <span class="tfree">'iusr1_core2</span><span class="main">,</span> <span class="tfree">'ousr1_core1</span> <span class="main">+</span> <span class="tfree">'ousr1_core2</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">cnv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'icnv_usr2</span><span class="main">,</span> <span class="tfree">'ocnv_usr2</span><span class="main">,</span> <span class="tfree">'iusr2_core1</span> <span class="main">+</span> <span class="tfree">'iusr2_core2</span><span class="main">,</span> <span class="tfree">'ousr2_core1</span> <span class="main">+</span> <span class="tfree">'ousr2_core2</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">res1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'iadv_core1</span> <span class="main">+</span> <span class="tfree">'iadv_rest1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'iusr1_core1</span> <span class="main">+</span> <span class="tfree">'iusr2_core1</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'iusr_rest1</span><span class="main">,</span>
      <span class="main">(</span><span class="tfree">'oadv_core1</span> <span class="main">+</span> <span class="tfree">'oadv_rest1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'ousr1_core1</span> <span class="main">+</span> <span class="tfree">'ousr2_core1</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'ousr_rest1</span><span class="main">)</span> resource"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">res2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'iadv_core2</span> <span class="main">+</span> <span class="tfree">'iadv_rest2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'iusr1_core2</span> <span class="main">+</span> <span class="tfree">'iusr2_core2</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'iusr_rest2</span><span class="main">,</span>
      <span class="main">(</span><span class="tfree">'oadv_core2</span> <span class="main">+</span> <span class="tfree">'oadv_rest2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'ousr1_core2</span> <span class="main">+</span> <span class="tfree">'ousr2_core2</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'ousr_rest2</span><span class="main">)</span> resource"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹Attachement of two c1f22 ('f' instead of 'r' to indicate Fused Resources) converters 
  to two 2-interface Fused Resources, the results will be a new 2-interface Fused Resource›</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">attach_c1f22_c1f22</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="tfree">'iadv_core1</span> <span class="main">+</span> <span class="tfree">'iadv_core2</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'iadv_rest1</span> <span class="main">+</span> <span class="tfree">'iadv_rest2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'icnv_usr1</span> <span class="main">+</span> <span class="tfree">'icnv_usr2</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'iusr_rest1</span> <span class="main">+</span> <span class="tfree">'iusr_rest2</span><span class="main">,</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'oadv_core1</span> <span class="main">+</span> <span class="tfree">'oadv_core2</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'oadv_rest1</span> <span class="main">+</span> <span class="tfree">'oadv_rest2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'ocnv_usr1</span> <span class="main">+</span> <span class="tfree">'ocnv_usr2</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'ousr_rest1</span> <span class="main">+</span> <span class="tfree">'ousr_rest2</span><span class="main">)</span> resource"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">attach_c1f22_c1f22</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="main">(</span>wiring_c1r22_c1r22 <span class="free">cnv1</span> <span class="free">cnv2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊙</span> fused_wiring<span class="main">)</span> <span class="main">⊳</span> <span class="main">(</span><span class="free">res1</span> <span class="main">∥</span> <span class="free">res2</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="comment1">― ‹Properties of Converters attaching to Fused resources›</span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">core1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core1</span><span class="main">,</span> <span class="tfree">'e1</span><span class="main">,</span> <span class="tfree">'iadv_core1</span><span class="main">,</span> <span class="tfree">'iusr_core1</span><span class="main">,</span> <span class="tfree">'oadv_core1</span><span class="main">,</span> <span class="tfree">'ousr_core1</span><span class="main">)</span> core"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">core2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core2</span><span class="main">,</span> <span class="tfree">'e2</span><span class="main">,</span> <span class="tfree">'iadv_core2</span><span class="main">,</span> <span class="tfree">'iusr_core2</span><span class="main">,</span> <span class="tfree">'oadv_core2</span><span class="main">,</span> <span class="tfree">'ousr_core2</span><span class="main">)</span> core"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">rest1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest1</span><span class="main">,</span> <span class="tfree">'e1</span><span class="main">,</span> <span class="tfree">'iadv_rest1</span><span class="main">,</span> <span class="tfree">'iusr_rest1</span><span class="main">,</span> <span class="tfree">'oadv_rest1</span><span class="main">,</span> <span class="tfree">'ousr_rest1</span><span class="main">,</span> <span class="tfree">'m1</span><span class="main">)</span> rest_scheme"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">rest2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest2</span><span class="main">,</span> <span class="tfree">'e2</span><span class="main">,</span> <span class="tfree">'iadv_rest2</span><span class="main">,</span> <span class="tfree">'iusr_rest2</span><span class="main">,</span> <span class="tfree">'oadv_rest2</span><span class="main">,</span> <span class="tfree">'ousr_rest2</span><span class="main">,</span> <span class="tfree">'m2</span><span class="main">)</span> rest_scheme"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Construction_Utility-parallel_oracle_fuse"><span class="command">lemma</span></span> parallel_oracle_fuse<span class="main">:</span>
  <span class="quoted"><span class="quoted">"apply_wiring fused_wiring<span class="hidden">⇩</span><sub>w</sub> <span class="main">(</span>parallel_oracle <span class="main">(</span>fused_resource.fuse <span class="free">core1</span> <span class="free">rest1</span><span class="main">)</span> <span class="main">(</span>fused_resource.fuse <span class="free">core2</span> <span class="free">rest2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    apply_state_iso parallel_state_iso <span class="main">(</span>fused_resource.fuse <span class="main">(</span>parallel_core <span class="free">core1</span> <span class="free">core2</span><span class="main">)</span> <span class="main">(</span>parallel_rest <span class="free">rest1</span> <span class="free">rest2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> fused_resource.fuse.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fused_wiring<span class="hidden">⇩</span><sub>w</sub>_def apply_state_iso_def parallel_state_iso_def parallel_wiring<span class="hidden">⇩</span><sub>w</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_wiring_def comp_wiring_def parallel2_wiring_def lassocr<span class="hidden">⇩</span><sub>w</sub>_def swap_lassocr<span class="hidden">⇩</span><sub>w</sub>_def rassocl<span class="hidden">⇩</span><sub>w</sub>_def swap<span class="hidden">⇩</span><sub>w</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_core1 s_rest1 s_core2 s_rest2 i
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>parallel_rest <span class="free">rest1</span> <span class="free">rest2</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s_core1</span><span class="main">,</span> <span class="skolem">s_core2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s_rest1</span><span class="main">,</span> <span class="skolem">s_rest2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fused_resource.fuse.cases<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> iadv_core
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">iadv_core</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_bind_spmf bind_map_spmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> iadv_rest
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">iadv_rest</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_handler_left parallel_handler_right foldl_spmf_pair_left 
        parallel_eoracle_def foldl_spmf_pair_right split_beta o_def map_spmf_bind_spmf bind_map_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> iusr_core
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">iusr_core</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_bind_spmf bind_map_spmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> iusr_rest
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">iusr_rest</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_handler_left parallel_handler_right foldl_spmf_pair_left 
        parallel_eoracle_def foldl_spmf_pair_right split_beta o_def map_spmf_bind_spmf bind_map_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Construction_Utility-attach_callee_fuse"><span class="command">lemma</span></span> attach_callee_fuse<span class="main">:</span>
  <span class="quoted"><span class="quoted">"attach_callee <span class="main">(</span><span class="main">(</span><span class="free">cnv_adv_core</span> <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">cnv_adv_rest</span><span class="main">)</span> <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">cnv_usr_core</span> <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">cnv_usr_rest</span><span class="main">)</span> <span class="main">(</span>fused_resource.fuse <span class="free">core</span> <span class="free">rest</span><span class="main">)</span> <span class="main">=</span>
   apply_state_iso iso_trisplit <span class="main">(</span>fused_resource.fuse <span class="main">(</span>attach_core <span class="free">cnv_adv_core</span> <span class="free">cnv_usr_core</span> <span class="free">core</span><span class="main">)</span> <span class="main">(</span>attach_rest <span class="free">cnv_adv_rest</span> <span class="free">cnv_usr_rest</span> <span class="free">f_init</span> <span class="free">rest</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> fused_resource.fuse.simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tri</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">s11</span><span class="main">,</span> <span class="bound">s12</span><span class="main">)</span><span class="main">,</span> <span class="bound">s13</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">s21</span><span class="main">,</span> <span class="bound">s22</span><span class="main">)</span><span class="main">,</span> <span class="bound">s23</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">s11</span><span class="main">,</span> <span class="bound">s21</span><span class="main">)</span><span class="main">,</span> <span class="bound">s12</span><span class="main">,</span> <span class="bound">s22</span><span class="main">)</span><span class="main">,</span> <span class="bound">s13</span><span class="main">,</span> <span class="bound">s23</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'g</span> <span class="main">+</span> <span class="tfree">'h</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'i</span> <span class="main">+</span> <span class="tfree">'j</span>"</span></span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>ACore<span class="main">)</span> <span class="skolem">qac</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> Inl <span class="main">(</span>Inl <span class="skolem">qac</span><span class="main">)</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>ARest<span class="main">)</span> <span class="skolem">qar</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> Inl <span class="main">(</span>Inr <span class="skolem">qar</span><span class="main">)</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>UCore<span class="main">)</span> <span class="skolem">quc</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> Inr <span class="main">(</span>Inl <span class="skolem">quc</span><span class="main">)</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>URest<span class="main">)</span> <span class="skolem">qur</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> Inr <span class="main">(</span>Inr <span class="skolem">qur</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fuse_callee.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">sac</span><span class="main">,</span> <span class="skolem">sar</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">suc</span><span class="main">,</span> <span class="skolem">sur</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">sc</span><span class="main">,</span> <span class="skolem">sr</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">sac</span><span class="main">,</span> <span class="skolem">sar</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">suc</span><span class="main">,</span> <span class="skolem">sur</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">sc</span><span class="main">,</span> <span class="skolem">sr</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">sac</span> <span class="skolem">sar</span> <span class="skolem">suc</span> <span class="skolem">sur</span> <span class="skolem">sc</span> <span class="skolem">sr</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> ACore
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_spmf rprodl <span class="main">(</span>exec_gpv <span class="main">(</span>fused_resource.fuse <span class="free">core</span> <span class="free">rest</span><span class="main">)</span>
       <span class="main">(</span>left_gpv <span class="main">(</span>map_gpv <span class="main">(</span>map_prod Inl <span class="main">(</span><span class="main">λ</span><span class="bound">s1'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="skolem">suc</span><span class="main">,</span> <span class="skolem">sur</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>left_gpv <span class="main">(</span>map_gpv <span class="main">(</span>map_prod Inl <span class="main">(</span><span class="main">λ</span><span class="bound">s1'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="skolem">sar</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span><span class="free">cnv_adv_core</span> <span class="skolem">sac</span> <span class="skolem">qac</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span><span class="skolem">sc</span><span class="main">,</span> <span class="skolem">sr</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>map_spmf <span class="main">(</span>map_prod <span class="main">(</span>Inl <span class="main">∘</span> Inl<span class="main">)</span> <span class="main">(</span><span class="var">?tri</span> <span class="main">∘</span> prod.swap <span class="main">∘</span> Pair <span class="main">(</span><span class="main">(</span><span class="skolem">sar</span><span class="main">,</span> <span class="skolem">sur</span><span class="main">)</span><span class="main">,</span> <span class="skolem">sr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">oadv</span><span class="main">,</span> <span class="bound">s_adv'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">oadv</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_adv'</span><span class="main">,</span> <span class="skolem">suc</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>exec_gpv <span class="main">(</span>cfunc_adv <span class="free">core</span><span class="main">)</span> <span class="main">(</span><span class="free">cnv_adv_core</span> <span class="skolem">sac</span> <span class="skolem">qac</span><span class="main">)</span> <span class="skolem">sc</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sc</span></span> <span class="quoted"><span class="free">cnv_adv_core</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec_gpv_fixp_parallel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">execl</span> <span class="skolem">execr</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel map_bind_spmf bind_map_spmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp o_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ACore
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_state_iso_def iso_trisplit_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> spmf.map_comp o_def split_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ARest
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bind_spmf <span class="main">(</span>foldl_spmf <span class="main">(</span>cpoke <span class="free">core</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="skolem">sc</span><span class="main">)</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">sc'</span><span class="main">.</span>
      map_spmf rprodl <span class="main">(</span>exec_gpv <span class="main">(</span>fused_resource.fuse <span class="free">core</span> <span class="free">rest</span><span class="main">)</span>
        <span class="main">(</span>left_gpv <span class="main">(</span>map_gpv <span class="main">(</span>map_prod Inl <span class="main">(</span><span class="main">λ</span><span class="bound">s1'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="skolem">suc</span><span class="main">,</span> <span class="skolem">sur</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>right_gpv <span class="main">(</span>map_gpv <span class="main">(</span>map_prod Inr <span class="main">(</span>Pair <span class="skolem">sac</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span><span class="free">cnv_adv_rest</span> <span class="skolem">sar</span> <span class="skolem">qar</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="bound">sc'</span><span class="main">,</span> <span class="skolem">sr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      bind_spmf
        <span class="main">(</span>exec_gpv <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">es</span> <span class="main">@</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_adv <span class="free">rest</span> <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnv_adv_rest</span> <span class="skolem">sar</span> <span class="skolem">qar</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sr</span><span class="main">,</span> <span class="skolem">es</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>map_spmf <span class="main">(</span>map_prod id <span class="var">?tri</span><span class="main">)</span> <span class="main">∘</span>
          <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">o_rfunc</span><span class="main">,</span> <span class="bound">e_lst</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_rfunc</span><span class="main">)</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s_notify</span><span class="main">.</span> <span class="main">(</span>Inl <span class="main">(</span>Inr <span class="bound">o_rfunc</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_notify</span><span class="main">,</span> <span class="bound">s_rfunc</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>map_spmf <span class="main">(</span>Pair <span class="main">(</span><span class="skolem">sac</span><span class="main">,</span> <span class="skolem">suc</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="main">(</span>cpoke <span class="free">core</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="skolem">sc</span><span class="main">)</span> <span class="bound">e_lst</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span>
          <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">oadv</span><span class="main">,</span> <span class="bound">s_adv'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_rest'</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">oadv</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_adv'</span><span class="main">,</span> <span class="skolem">sur</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_rest'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">es</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sc</span></span> <span class="quoted"><span class="skolem">sr</span></span> <span class="quoted"><span class="skolem">es</span></span> <span class="quoted"><span class="free">cnv_adv_rest</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec_gpv_fixp_parallel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">execl</span> <span class="skolem">execr</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel map_bind_spmf bind_map_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel map_bind_spmf bind_map_spmf spmf.map_comp o_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel map_bind_spmf bind_map_spmf spmf.map_comp o_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> bind_foldl_spmf_return foldl_spmf_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_spmf_assoc <span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def o_def spmf.map_comp<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ARest
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_state_iso_def iso_trisplit_def map_bind_spmf bind_map_spmf map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> foldl_spmf_pair_right<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> UCore
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_spmf rprodl <span class="main">(</span>exec_gpv <span class="main">(</span>fused_resource.fuse <span class="free">core</span> <span class="free">rest</span><span class="main">)</span>
       <span class="main">(</span>right_gpv <span class="main">(</span>map_gpv <span class="main">(</span>map_prod Inr <span class="main">(</span>Pair <span class="main">(</span><span class="skolem">sac</span><span class="main">,</span> <span class="skolem">sar</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>left_gpv <span class="main">(</span>map_gpv <span class="main">(</span>map_prod Inl <span class="main">(</span><span class="main">λ</span><span class="bound">s1'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s1'</span><span class="main">,</span> <span class="skolem">sur</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span><span class="free">cnv_usr_core</span> <span class="skolem">suc</span> <span class="skolem">quc</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span><span class="skolem">sc</span><span class="main">,</span> <span class="skolem">sr</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>map_spmf <span class="main">(</span>map_prod <span class="main">(</span>Inr <span class="main">∘</span> Inl<span class="main">)</span> <span class="main">(</span><span class="var">?tri</span> <span class="main">∘</span> prod.swap <span class="main">∘</span> Pair <span class="main">(</span><span class="main">(</span><span class="skolem">sar</span><span class="main">,</span> <span class="skolem">sur</span><span class="main">)</span><span class="main">,</span> <span class="skolem">sr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">ousr</span><span class="main">,</span> <span class="bound">s_usr'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">ousr</span><span class="main">,</span> <span class="main">(</span><span class="skolem">sac</span><span class="main">,</span> <span class="bound">s_usr'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>exec_gpv <span class="main">(</span>cfunc_usr <span class="free">core</span><span class="main">)</span> <span class="main">(</span><span class="free">cnv_usr_core</span> <span class="skolem">suc</span> <span class="skolem">quc</span><span class="main">)</span> <span class="skolem">sc</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sc</span></span> <span class="quoted"><span class="free">cnv_usr_core</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec_gpv_fixp_parallel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">execl</span> <span class="skolem">execr</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel map_bind_spmf bind_map_spmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp o_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> UCore
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_state_iso_def iso_trisplit_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> spmf.map_comp o_def split_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> URest
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bind_spmf <span class="main">(</span>foldl_spmf <span class="main">(</span>cpoke <span class="free">core</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="skolem">sc</span><span class="main">)</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">sc'</span><span class="main">.</span>
      map_spmf rprodl <span class="main">(</span>exec_gpv <span class="main">(</span>fused_resource.fuse <span class="free">core</span> <span class="free">rest</span><span class="main">)</span>
        <span class="main">(</span>right_gpv <span class="main">(</span>map_gpv <span class="main">(</span>map_prod Inr <span class="main">(</span>Pair <span class="main">(</span><span class="skolem">sac</span><span class="main">,</span> <span class="skolem">sar</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>right_gpv <span class="main">(</span>map_gpv <span class="main">(</span>map_prod Inr <span class="main">(</span>Pair <span class="skolem">suc</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span><span class="free">cnv_usr_rest</span> <span class="skolem">sur</span> <span class="skolem">qur</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="bound">sc'</span><span class="main">,</span> <span class="skolem">sr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      bind_spmf
        <span class="main">(</span>exec_gpv <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="bound">es</span> <span class="main">@</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_usr <span class="free">rest</span> <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cnv_usr_rest</span> <span class="skolem">sur</span> <span class="skolem">qur</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sr</span><span class="main">,</span> <span class="skolem">es</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>map_spmf <span class="main">(</span>map_prod id <span class="var">?tri</span><span class="main">)</span> <span class="main">∘</span>
           <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">o_rfunc</span><span class="main">,</span> <span class="bound">e_lst</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_rfunc</span><span class="main">)</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s_notify</span><span class="main">.</span> <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="bound">o_rfunc</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_notify</span><span class="main">,</span> <span class="bound">s_rfunc</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>map_spmf <span class="main">(</span>Pair <span class="main">(</span><span class="skolem">sac</span><span class="main">,</span> <span class="skolem">suc</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="main">(</span>cpoke <span class="free">core</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="skolem">sc</span><span class="main">)</span> <span class="bound">e_lst</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span>
           <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">ousr</span><span class="main">,</span> <span class="bound">s_usr'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_rest'</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">ousr</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">sar</span><span class="main">,</span> <span class="bound">s_usr'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_rest'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">es</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sc</span></span> <span class="quoted"><span class="skolem">sr</span></span> <span class="quoted"><span class="skolem">es</span></span> <span class="quoted"><span class="free">cnv_usr_rest</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec_gpv_fixp_parallel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">execl</span> <span class="skolem">execr</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel map_bind_spmf bind_map_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel map_bind_spmf bind_map_spmf spmf.map_comp o_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel map_bind_spmf bind_map_spmf spmf.map_comp o_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> bind_foldl_spmf_return foldl_spmf_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_spmf_assoc <span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def o_def spmf.map_comp<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> URest
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_state_iso_def iso_trisplit_def map_bind_spmf bind_map_spmf map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> foldl_spmf_pair_right<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Construction_Utility-attach_parallel_fuse'"><span class="command">lemma</span></span> attach_parallel_fuse'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>CNV <span class="free">cnv_adv_core</span> <span class="free">s_a_c</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> CNV <span class="free">cnv_adv_rest</span> <span class="free">s_a_r</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span>CNV <span class="free">cnv_usr_core</span> <span class="free">s_u_c</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> CNV <span class="free">cnv_usr_rest</span> <span class="free">s_u_r</span><span class="main">)</span> <span class="main">⊳</span> 
   RES <span class="main">(</span>fused_resource.fuse <span class="free">core</span> <span class="free">rest</span><span class="main">)</span> <span class="main">(</span><span class="free">s_r_c</span><span class="main">,</span> <span class="free">s_r_r</span><span class="main">)</span> <span class="main">=</span> 
   RES <span class="main">(</span>fused_resource.fuse <span class="main">(</span>attach_core <span class="free">cnv_adv_core</span> <span class="free">cnv_usr_core</span> <span class="free">core</span><span class="main">)</span> <span class="main">(</span>attach_rest <span class="free">cnv_adv_rest</span> <span class="free">cnv_usr_rest</span> <span class="free">f_init</span> <span class="free">rest</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">s_a_c</span><span class="main">,</span> <span class="free">s_u_c</span><span class="main">)</span><span class="main">,</span> <span class="free">s_r_c</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="free">s_a_r</span><span class="main">,</span> <span class="free">s_u_r</span><span class="main">)</span><span class="main">,</span> <span class="free">s_r_r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> conv_callee_parallel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> attach_CNV_RES<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> attach_callee_fuse<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> resource_of_oracle_state_iso<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iso_trisplit_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">― ‹Moving event translators from rest to the core›</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">einit</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s_event</span></span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">etran</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_event</span><span class="main">,</span> <span class="tfree">'ievent</span><span class="main">,</span> <span class="tfree">'oevent</span> list<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'ievent</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">)</span> rest_wstate"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'oevent</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span>
  <span class="entity">translate_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_event</span> <span class="main">×</span> <span class="tfree">'s_rest</span><span class="main">,</span> <span class="tfree">'oevent</span><span class="main">,</span> <span class="tfree">'iadv_rest</span><span class="main">,</span> <span class="tfree">'iusr_rest</span><span class="main">,</span> <span class="tfree">'oadv_rest</span><span class="main">,</span> <span class="tfree">'ousr_rest</span><span class="main">)</span> rest_wstate"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"rinit <span class="free">translate_rest</span> <span class="main">=</span> <span class="main">(</span><span class="free">einit</span><span class="main">,</span> rinit <span class="free">rest</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="free">translate_rest</span> <span class="main">=</span> translate_eoracle <span class="free">etran</span> <span class="main">(</span>extend_state_oracle <span class="main">(</span>rfunc_adv <span class="free">rest</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="free">translate_rest</span> <span class="main">=</span> translate_eoracle <span class="free">etran</span> <span class="main">(</span>extend_state_oracle <span class="main">(</span>rfunc_usr <span class="free">rest</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span>
  <span class="entity">translate_core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s_event</span> <span class="main">×</span> <span class="tfree">'s_core</span><span class="main">,</span> <span class="tfree">'ievent</span><span class="main">,</span> <span class="tfree">'iadv_core</span><span class="main">,</span> <span class="tfree">'iusr_core</span><span class="main">,</span> <span class="tfree">'oadv_core</span><span class="main">,</span> <span class="tfree">'ousr_core</span><span class="main">)</span> core"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"cpoke <span class="free">translate_core</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_event</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">event</span><span class="main">.</span> 
      bind_spmf <span class="main">(</span><span class="free">etran</span> <span class="bound">s_event</span> <span class="bound">event</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">events</span><span class="main">,</span> <span class="bound">s_event'</span><span class="main">)</span><span class="main">.</span> 
        map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">s_core'</span><span class="main">.</span> <span class="main">(</span><span class="bound">s_event'</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl_spmf <span class="main">(</span>cpoke <span class="free">core</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="bound">s_core</span><span class="main">)</span> <span class="bound">events</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">translate_core</span> <span class="main">=</span> extend_state_oracle <span class="main">(</span>cfunc_adv <span class="free">core</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">translate_core</span> <span class="main">=</span> extend_state_oracle <span class="main">(</span>cfunc_usr <span class="free">core</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Construction_Utility-WT_translate_rest"><span class="command">lemma</span></span> WT_translate_rest <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv</span> <span class="free">ℐ_usr</span> <span class="free">I_rest</span> <span class="free">rest</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv</span> <span class="free">ℐ_usr</span> <span class="main">(</span>pred_prod <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">I_rest</span><span class="main">)</span> translate_rest"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_rest.intros<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> translate_eoracle_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WT_restD_rinit<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_restD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1" id="Construction_Utility-fused_resource_move_translate"><span class="command">lemma</span></span> fused_resource_move_translate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fused_resource.fuse <span class="free">core</span> translate_rest <span class="main">=</span> apply_state_iso iso_swapar <span class="main">(</span>fused_resource.fuse translate_core <span class="free">rest</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> exec_gpv_bind spmf.map_comp o_def map_bind_spmf bind_map_spmf bind_spmf_const

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_core s_event s_rest
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_adv
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_adv</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_acore
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_state_iso_def iso_swapar_def fused_resource.fuse.simps split_def map_prod_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_arest
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_state_iso_def iso_swapar_def fused_resource.fuse.simps<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> translate_eoracle_def split_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> foldl_spmf_chain<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_usr</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_ucore
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_state_iso_def iso_swapar_def fused_resource.fuse.simps split_def map_prod_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_urest
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_state_iso_def iso_swapar_def fused_resource.fuse.simps<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> translate_eoracle_def split_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> foldl_spmf_chain<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword2"><span class="keyword">end</span></span>


<span class="comment1">― ‹Moving interfaces between rest and core›</span>

<span class="keyword1" id="Construction_Utility-fuse_ishift_core_to_rest"><span class="command">lemma</span></span>
  fuse_ishift_core_to_rest<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cpoke <span class="free">core'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">fn</span> <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>cpoke <span class="free">core</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">core</span> <span class="main">=</span> cfunc_adv <span class="free">core'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">core</span> <span class="main">=</span> cfunc_usr <span class="free">core'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">i</span><span class="main">.</span> map_spmf <span class="main">(</span>Pair <span class="main">(</span><span class="free">h_out</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">fn</span> <span class="bound">s</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="free">rest'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span>apfst <span class="main">(</span>apsnd <span class="main">(</span>map Inr<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_adv <span class="free">rest</span> <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="free">rest'</span> <span class="main">=</span> plus_eoracle <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">i</span><span class="main">.</span> return_spmf <span class="main">(</span><span class="main">(</span><span class="free">h_out</span> <span class="bound">i</span><span class="main">,</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_usr <span class="free">rest</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fused_resource.fuse <span class="free">core</span> <span class="free">rest</span> <span class="main">=</span> apply_wiring <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> lassocr<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span> <span class="main">(</span>fused_resource.fuse <span class="free">core'</span> <span class="free">rest'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> fused_resource.fuse.simps apply_wiring_def lassocr<span class="hidden">⇩</span><sub>w</sub>_def parallel2_wiring_def 
    plus_eoracle_def map_spmf_conv_bind_spmf map_prod_def map_fun_def split_def o_def

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="skolem">s</span> <span class="skolem">q</span> <span class="main">=</span> <span class="var">?R</span> <span class="skolem">s</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_adv
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_adv</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span> 2<span class="main"><span class="main">,</span></span> 4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_usr</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr_core
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_usr_core</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_nrm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">,</span></span> 5<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span> 5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Construction_Utility-move_simulator_interface"><span class="command">lemma</span></span> move_simulator_interface<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">x_ifunc</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ifunc</span> <span class="bound">core</span> <span class="main">(</span><span class="bound">se</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="bound">se'</span><span class="main">)</span> <span class="main">←</span> <span class="bound">ifunc</span> <span class="bound">se</span> <span class="bound">q</span><span class="main">;</span>
      <span class="bound">sc'</span> <span class="main">←</span> foldl_spmf <span class="main">(</span>cpoke <span class="bound">core</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="bound">sc</span><span class="main">)</span> <span class="bound">es</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">se'</span><span class="main">,</span> <span class="bound">sc'</span><span class="main">)</span>   <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cpoke <span class="free">core'</span> <span class="main">=</span> cpoke <span class="main">(</span>translate_core <span class="free">etran</span> <span class="free">core</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">core'</span> <span class="main">=</span> <span class="main">†</span><span class="main">(</span>cfunc_adv <span class="free">core</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">x_ifunc</span> <span class="free">ifunc</span> <span class="free">core</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">core'</span> <span class="main">=</span> cfunc_usr <span class="main">(</span>translate_core <span class="free">etran</span> <span class="free">core</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rinit <span class="free">rest</span> <span class="main">=</span> <span class="main">(</span><span class="free">einit</span><span class="main">,</span> rinit <span class="free">rest'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="free">rest</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">q</span> <span class="keyword1">of</span> 
        Inl <span class="bound">ql</span> <span class="main">⇒</span> map_spmf <span class="main">(</span>apfst <span class="main">(</span>map_prod Inl id<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">ifunc</span><span class="main">†</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">ql</span><span class="main">)</span>
      <span class="main">|</span> Inr <span class="bound">qr</span> <span class="main">⇒</span> map_spmf <span class="main">(</span>apfst <span class="main">(</span>map_prod Inr id<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>translate_eoracle <span class="free">etran</span> <span class="main">(</span><span class="main">†</span><span class="main">(</span>rfunc_adv <span class="free">rest'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">qr</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="free">rest</span> <span class="main">=</span> translate_eoracle <span class="free">etran</span> <span class="main">(</span><span class="main">†</span><span class="main">(</span>rfunc_usr <span class="free">rest'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fused_resource.fuse <span class="free">core</span> <span class="free">rest</span> <span class="main">=</span>  apply_wiring <span class="main">(</span>rassocl<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>apply_state_iso <span class="main">(</span>rprodl <span class="keyword1">o</span> <span class="main">(</span>apfst prod.swap<span class="main">)</span><span class="main">,</span> <span class="main">(</span>apfst prod.swap<span class="main">)</span> <span class="keyword1">o</span> lprodr<span class="main">)</span>
         <span class="main">(</span>fused_resource.fuse <span class="free">core'</span> <span class="free">rest'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> fused_resource.fuse.simps apply_wiring_def rassocl<span class="hidden">⇩</span><sub>w</sub>_def parallel2_wiring_def apply_state_iso_def
    exec_gpv_bind spmf.map_comp map_bind_spmf bind_map_spmf bind_spmf_const o_def split_def

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">(</span><span class="skolem">sc</span><span class="main">,</span> <span class="skolem">st</span><span class="main">,</span> <span class="skolem">sr</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> <span class="var">?R</span> <span class="main">(</span><span class="skolem">sc</span><span class="main">,</span> <span class="skolem">st</span><span class="main">,</span> <span class="skolem">sr</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">sc</span> <span class="skolem">st</span> <span class="skolem">sr</span> <span class="skolem">q</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_fun_def map_prod_def prod.swap_def apfst_def lprodr_def rprodl_def id_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_adv
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_adv</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_adv_core
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_prod_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_adv_rest
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_adv_rest</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_adv_rest_ifunc
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_adv_rest_etran
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> translate_eoracle_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> foldl_spmf_chain<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_usr</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr_core
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_prod_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr_rest
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> translate_eoracle_def extend_state_oracle_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> foldl_spmf_chain<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Concrete_Security">
<div class="head">
<h1>Theory Concrete_Security</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Concrete_Security 
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="#Observe_Failure">Observe_Failure</a>
  <a href="#Construction_Utility">Construction_Utility</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Concrete security definition›</span></span>

<span class="keyword1"><span class="command">locale</span></span> constructive_security_aux_obsf <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">real_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ideal_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_real</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_ideal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_common</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">adv</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT_real <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="keyword1">⊢res</span> <span class="free">real_resource</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_ideal <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="keyword1">⊢res</span> <span class="free">ideal_resource</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_sim <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">sim</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite_sim <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">sim</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> adv_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">adv</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> constructive_security_sim_obsf <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">real_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ideal_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_real</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_common</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> distinguisher_obsf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">adv</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span> <span class="main">⟧</span>
      <span class="main">⟹</span> advantage <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">real_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">adv</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> constructive_security_obsf <span class="main">=</span> constructive_security_aux_obsf <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_ideal</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="free">adv</span></span>
  <span class="main">+</span> constructive_security_sim_obsf <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="free">𝒜</span></span> <span class="quoted"><span class="free">adv</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">real_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ideal_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_real</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_ideal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_common</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> distinguisher_obsf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">adv</span> <span class="main">::</span> <span class="quoted">real</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Concrete_Security-constructive_security_aux_obsf"><span class="command">lemma</span></span> constructive_security_aux_obsf<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_aux_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="free">adv</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1" id="Concrete_Security-constructive_security_sim_obsf"><span class="command">lemma</span></span> constructive_security_sim_obsf<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_sim_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span> <span class="free">adv</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> constructive_security_aux_obsf <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Concrete_Security-constructive_security_obsf_refl"><span class="command">lemma</span></span> constructive_security_obsf_refl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span>
    <span class="main">(</span>advantage <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">real_resource</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Concrete_Security-constructive_security_obsf_absorb_cong"><span class="command">lemma</span></span> constructive_security_obsf_absorb_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="free">cnv</span><span class="main">)</span> <span class="free">adv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="free">ℐ</span><span class="main">,</span> exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">cnv</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="free">ℐ</span><span class="main">,</span> exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">cnv'</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cong<span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="free">ℐ</span><span class="main">,</span> exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">cnv</span> <span class="main">∼</span> <span class="free">cnv'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="free">cnv'</span><span class="main">)</span> <span class="free">adv</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> constructive_security_obsf <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_ideal</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="quoted">"absorb <span class="free">𝒜</span> <span class="free">cnv</span>"</span></span> <span class="quoted"><span class="free">adv</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connect_obsf <span class="free">𝒜</span> <span class="main">(</span><span class="free">cnv'</span> <span class="main">⊳</span> obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> connect_obsf <span class="free">𝒜</span> <span class="main">(</span><span class="free">cnv</span> <span class="main">⊳</span> obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"connect_obsf <span class="free">𝒜</span> <span class="main">(</span><span class="free">cnv'</span> <span class="main">⊳</span> obsf_resource <span class="free">real_resource</span><span class="main">)</span> <span class="main">=</span> connect_obsf <span class="free">𝒜</span> <span class="main">(</span><span class="free">cnv</span> <span class="main">⊳</span> obsf_resource <span class="free">real_resource</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong eq_ℐ_attach_on' <span class="dynamic"><span class="dynamic">WT_intro</span></span> cong<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> order_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"advantage <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="free">cnv'</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">real_resource</span><span class="main">)</span> <span class="main">=</span>
          advantage <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="free">cnv</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">real_resource</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> advantage_def distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">adv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> adv<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"advantage <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="free">cnv'</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">real_resource</span><span class="main">)</span> <span class="main">≤</span> <span class="free">adv</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Concrete_Security-constructive_security_obsf_sim_cong"><span class="command">lemma</span></span> constructive_security_obsf_sim_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span> <span class="free">adv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">sim</span> <span class="main">∼</span> <span class="free">sim'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">sim'</span>"</span></span> <span class="comment1">(* This could probably be derived from cong and sec.pfinite_sim *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim'</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span> <span class="free">adv</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> constructive_security_obsf <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_ideal</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="free">𝒜</span></span> <span class="quoted"><span class="free">adv</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="keyword1">⊢res</span> <span class="free">real_resource</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="keyword1">⊢res</span> <span class="free">ideal_resource</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> cong <span class="keyword3"><span class="command">show</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">sim'</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converterD_WT1<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">sim'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">adv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> adv_nonneg<span class="main">)</span>

  <span class="keyword3"><span class="command">assume</span></span> WT <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim'</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong <span class="dynamic"><span class="dynamic">WT_intro</span></span> obsf_resource_eq_ℐ_cong eq_ℐ_attach_on' parallel_converter2_eq_ℐ_cong cong<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> eq_ℐ_converter_reflI <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> adv<span class="main">[</span><span class="operator">OF</span> WT<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"advantage <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim'</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">real_resource</span><span class="main">)</span> <span class="main">≤</span> <span class="free">adv</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> advantage_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Concrete_Security-constructive_security_obsfI_core_rest"><span class="command">lemma</span></span> constructive_security_obsfI_core_rest <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security_aux_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="main">(</span><span class="free">ℐ_common_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common_rest</span><span class="main">)</span> <span class="free">adv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common_rest</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span> <span class="main">⟧</span>
      <span class="main">⟹</span> advantage <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">real_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">adv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="main">(</span><span class="free">ℐ_common_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common_rest</span><span class="main">)</span> <span class="free">𝒜</span> <span class="free">adv</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> constructive_security_aux_obsf <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_ideal</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common_rest</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> A <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common_rest</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> outs<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_gpv <span class="main">(</span>exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common_rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">𝒜</span> <span class="main">⊆</span> outs_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common_rest</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> WT_gpv_iff_outs_gpv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_cong_trace trace_eq_obsf_resourceI eq_resource_on_imp_trace_eq eq_ℐ_attach_on'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> parallel_converter2_eq_ℐ_cong eq_ℐ_converter_reflI parallel_converter2_id_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> order_refl outs<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"advantage <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">real_resource</span><span class="main">)</span> <span class="main">≤</span> <span class="free">adv</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> adv<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Composition theorems›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> constructive_security_obsf_composability<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">middle</span> <span class="free">ideal</span> <span class="free">sim_inner</span> <span class="free">ℐ_middle</span> <span class="free">ℐ_inner</span> <span class="free">ℐ_common</span> <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span><span class="free">sim_outer</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">adv1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">real</span> <span class="free">middle</span> <span class="free">sim_outer</span> <span class="free">ℐ_real</span> <span class="free">ℐ_middle</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span> <span class="free">adv2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">real</span> <span class="free">ideal</span> <span class="main">(</span><span class="free">sim_outer</span> <span class="main">⊙</span> <span class="free">sim_inner</span><span class="main">)</span> <span class="free">ℐ_real</span> <span class="free">ℐ_inner</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span> <span class="main">(</span><span class="free">adv1</span> <span class="main">+</span> <span class="free">adv2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span><span class="free">sim_outer</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> inner<span class="main">:</span> constructive_security_obsf <span class="quoted"><span class="free">middle</span></span> <span class="quoted"><span class="free">ideal</span></span> <span class="quoted"><span class="free">sim_inner</span></span> <span class="quoted"><span class="free">ℐ_middle</span></span> <span class="quoted"><span class="free">ℐ_inner</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="quoted"><span class="free">adv1</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> outer<span class="main">:</span> constructive_security_obsf <span class="quoted"><span class="free">real</span></span> <span class="quoted"><span class="free">middle</span></span> <span class="quoted"><span class="free">sim_outer</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_middle</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="free">𝒜</span></span> <span class="quoted"><span class="free">adv2</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="keyword1">⊢res</span> <span class="free">real</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_inner</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="keyword1">⊢res</span> <span class="free">ideal</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span><span class="main">,</span> <span class="free">ℐ_inner</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">sim_outer</span> <span class="main">⊙</span> <span class="free">sim_inner</span> <span class="main">√</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_real</span> <span class="free">ℐ_inner</span> <span class="main">(</span><span class="free">sim_outer</span> <span class="main">⊙</span> <span class="free">sim_inner</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">adv1</span> <span class="main">+</span> <span class="free">adv2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inner.adv_nonneg outer.adv_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">assume</span></span> WT_adv<span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"connect_obsf <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span><span class="free">sim_outer</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim_inner</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim_outer</span> <span class="main">⊙</span> <span class="free">sim_inner</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> outs_plus_ℐ <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_converter2_comp1_out attach_compose<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obsf_attach<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"connect_obsf <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span><span class="free">sim_outer</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">middle</span><span class="main">)</span> <span class="main">=</span>
      connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim_outer</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">middle</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> outs_plus_ℐ <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_converter2_comp1_out attach_compose<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obsf_attach<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"advantage <span class="var">?𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim_inner</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">middle</span><span class="main">)</span> <span class="main">≤</span> <span class="free">adv1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> inner.adv<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"advantage <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim_outer</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">middle</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">real</span><span class="main">)</span> <span class="main">≤</span> <span class="free">adv2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> outer.adv<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"advantage <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim_outer</span> <span class="main">⊙</span> <span class="free">sim_inner</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">real</span><span class="main">)</span> <span class="main">≤</span> <span class="free">adv1</span> <span class="main">+</span> <span class="free">adv2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def eq1 eq2 abs_diff_triangle_ineq2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> constructive_security_obsf_lifting<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_aux_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="free">adv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sec2<span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="free">ℐ_real'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span> 
    <span class="main">⟹</span> constructive_security_sim_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_common</span> <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span><span class="free">w_adv_real</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">w_usr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">adv</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> constructive_security_sim_obsf <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?𝒜</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT_usr <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common'</span><span class="main">,</span> <span class="free">ℐ_common</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">w_usr</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_common'</span> <span class="free">ℐ_common</span> <span class="free">w_usr</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_adv_real <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real'</span><span class="main">,</span> <span class="free">ℐ_real</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">w_adv_real</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_w_adv_ideal <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal'</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">w_adv_ideal</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_adv_ideal_inv <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span><span class="main">,</span> <span class="free">ℐ_ideal'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">w_adv_ideal_inv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ideal_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">w_adv_ideal_inv</span> <span class="main">⊙</span> <span class="free">w_adv_ideal</span> <span class="main">∼</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite_real <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_real'</span> <span class="free">ℐ_real</span> <span class="free">w_adv_real</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite_ideal <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_ideal</span> <span class="free">ℐ_ideal'</span> <span class="free">w_adv_ideal_inv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span><span class="free">w_adv_real</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">w_usr</span> <span class="main">⊳</span> <span class="free">real_resource</span><span class="main">)</span> <span class="main">(</span><span class="free">w_adv_ideal</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">w_usr</span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span> <span class="main">(</span><span class="free">w_adv_real</span> <span class="main">⊙</span> <span class="free">sim</span> <span class="main">⊙</span> <span class="free">w_adv_ideal_inv</span><span class="main">)</span> <span class="free">ℐ_real'</span> <span class="free">ℐ_ideal'</span> <span class="free">ℐ_common'</span> <span class="free">𝒜</span> <span class="free">adv</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="var">?real</span> <span class="var">?ideal</span> <span class="var">?sim</span> <span class="var">?ℐ_real</span> <span class="var">?ℐ_ideal</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> constructive_security_aux_obsf <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_ideal</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="keyword1">⊢res</span> <span class="var">?real</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="keyword1">⊢res</span> <span class="var">?ideal</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real'</span><span class="main">,</span> <span class="free">ℐ_ideal'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?sim</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_real'</span> <span class="free">ℐ_ideal'</span> <span class="var">?sim</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">adv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> adv_nonneg<span class="main">)</span>

  <span class="keyword3"><span class="command">assume</span></span> WT_adv <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="free">ℐ_real'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> constructive_security_sim_obsf <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="quoted"><span class="free">adv</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sec2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"advantage <span class="var">?𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">real_resource</span><span class="main">)</span> <span class="main">≤</span> <span class="free">adv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> adv<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> ideal<span class="main">:</span> <span class="quoted"><span class="quoted">"connect_obsf <span class="var">?𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="var">?sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="var">?ideal</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> outs_plus_ℐ<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> obsf_attach<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obsf_resource_eq_ℐ_cong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> attach_compose<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> comp_converter_parallel2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_attach_on'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> parallel_converter2_eq_ℐ_cong<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> comp_converter_assoc<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ideal_inverse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> comp_converter_id_right comp_converter_id_left<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> real<span class="main">:</span> <span class="quoted"><span class="quoted">"connect_obsf <span class="var">?𝒜</span> <span class="main">(</span>obsf_resource <span class="free">real_resource</span><span class="main">)</span> <span class="main">=</span> connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="var">?real</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> outs_plus_ℐ<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obsf_attach<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"advantage <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="main">(</span><span class="var">?sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> <span class="var">?ideal</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="var">?real</span><span class="main">)</span> <span class="main">≤</span> <span class="free">adv</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">unfolding</span></span> advantage_def ideal<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> real<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> constructive_security_obsf_lifting_<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span><span class="free">w_adv_real</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">w_usr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">adv</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT_usr <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common'</span><span class="main">,</span> <span class="free">ℐ_common</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">w_usr</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_common'</span> <span class="free">ℐ_common</span> <span class="free">w_usr</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_adv_real <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real'</span><span class="main">,</span> <span class="free">ℐ_real</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">w_adv_real</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_w_adv_ideal <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal'</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">w_adv_ideal</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_adv_ideal_inv <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span><span class="main">,</span> <span class="free">ℐ_ideal'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">w_adv_ideal_inv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ideal_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">w_adv_ideal_inv</span> <span class="main">⊙</span> <span class="free">w_adv_ideal</span> <span class="main">∼</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite_real <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_real'</span> <span class="free">ℐ_real</span> <span class="free">w_adv_real</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite_ideal <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_ideal</span> <span class="free">ℐ_ideal'</span> <span class="free">w_adv_ideal_inv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span><span class="free">w_adv_real</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">w_usr</span> <span class="main">⊳</span> <span class="free">real_resource</span><span class="main">)</span> <span class="main">(</span><span class="free">w_adv_ideal</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">w_usr</span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span> <span class="main">(</span><span class="free">w_adv_real</span> <span class="main">⊙</span> <span class="free">sim</span> <span class="main">⊙</span> <span class="free">w_adv_ideal_inv</span><span class="main">)</span> <span class="free">ℐ_real'</span> <span class="free">ℐ_ideal'</span> <span class="free">ℐ_common'</span> <span class="free">𝒜</span> <span class="free">adv</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> constructive_security_obsf <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_ideal</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="quoted">"absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span><span class="free">w_adv_real</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">w_usr</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">adv</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> constructive_security_aux_obsf constructive_security_sim_obsf assms<span class="main">(</span>2-<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf_lifting<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> constructive_security_obsf_lifting_usr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_aux_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="free">adv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sec2<span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span> 
    <span class="main">⟹</span> constructive_security_sim_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_common</span> <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">adv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_conv <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common'</span><span class="main">,</span> <span class="free">ℐ_common</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_common'</span> <span class="free">ℐ_common</span> <span class="free">conv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="main">⊳</span> <span class="free">real_resource</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common'</span> <span class="free">𝒜</span> <span class="free">adv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf_lifting<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sec sec2<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?w_adv_ideal</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?w_adv_ideal_inv</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> comp_converter_id_left comp_converter_id_right<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> id_converter_eq_self order_refl <span class="main"><span class="keyword3">|</span></span> <span class="operator">assumption</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">theorem</span></span> constructive_security_obsf_lifting2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_aux_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="main">(</span><span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_ideal2</span><span class="main">)</span> <span class="free">ℐ_common</span> <span class="free">adv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sec2<span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="main">(</span><span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span> 
    <span class="main">⟹</span> constructive_security_sim_obsf <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="main">(</span><span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span><span class="main">)</span> <span class="free">ℐ_common</span> <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">adv</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT_conv <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common'</span><span class="main">,</span> <span class="free">ℐ_common</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_common'</span> <span class="free">ℐ_common</span> <span class="free">conv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="main">⊳</span> <span class="free">real_resource</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="main">⊳</span> <span class="free">ideal_resource</span><span class="main">)</span> <span class="free">sim</span> <span class="main">(</span><span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_ideal2</span><span class="main">)</span> <span class="free">ℐ_common'</span> <span class="free">𝒜</span> <span class="free">adv</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="var">?real</span> <span class="var">?ideal</span> <span class="main">_</span> <span class="var">?ℐ_real</span> <span class="var">?ℐ_ideal</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> constructive_security_aux_obsf <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_ideal2</span>"</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="free">adv</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> sim <span class="main">[</span><span class="operator">unfolded</span> comp_converter_id_left<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span><span class="main">,</span><span class="free">ℐ_ideal1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_ideal2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> <span class="free">sim</span> <span class="main">∼</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊙</span> <span class="free">sim</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> parallel_converter2_id_id eq_ℐ_converter_reflI <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf_sim_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf_lifting<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sec sec2<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?w_adv_ideal</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?w_adv_ideal_inv</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> comp_converter_id_left comp_converter_id_right<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">assumption</span><span class="main"><span class="keyword3">|</span></span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> sim <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> parallel_converter2_id_id<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> constructive_security_obsf_trivial<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">res</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">res</span> <span class="free">res</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">ℐ</span> <span class="free">ℐ</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ</span> <span class="free">ℐ</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">assume</span></span> WT <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="free">ℐ</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">res</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">res</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> eq_ℐ_attach_on' obsf_resource_eq_ℐ_cong parallel_converter2_id_id<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"advantage <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">res</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="free">res</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> advantage_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Concrete_Security-parallel_constructive_security_aux_obsf"><span class="command">lemma</span></span> parallel_constructive_security_aux_obsf <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security_aux_obsf <span class="free">real1</span> <span class="free">ideal1</span> <span class="free">sim1</span> <span class="free">ℐ_real1</span> <span class="free">ℐ_inner1</span> <span class="free">ℐ_common1</span> <span class="free">adv1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security_aux_obsf <span class="free">real2</span> <span class="free">ideal2</span> <span class="free">sim2</span> <span class="free">ℐ_real2</span> <span class="free">ℐ_inner2</span> <span class="free">ℐ_common2</span> <span class="free">adv2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_aux_obsf <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">real2</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="main">∥</span> <span class="free">ideal2</span><span class="main">)</span> <span class="main">(</span><span class="free">sim1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span> 
    <span class="main">(</span><span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_inner1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span><span class="main">)</span>
    <span class="main">(</span><span class="free">adv1</span> <span class="main">+</span> <span class="free">adv2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> sec1<span class="main">:</span> constructive_security_aux_obsf <span class="quoted"><span class="free">real1</span></span> <span class="quoted"><span class="free">ideal1</span></span> <span class="quoted"><span class="free">sim1</span></span> <span class="quoted"><span class="free">ℐ_real1</span></span> <span class="quoted"><span class="free">ℐ_inner1</span></span> <span class="quoted"><span class="free">ℐ_common1</span></span> <span class="quoted"><span class="free">adv1</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> sec2<span class="main">:</span> constructive_security_aux_obsf <span class="quoted"><span class="free">real2</span></span> <span class="quoted"><span class="free">ideal2</span></span> <span class="quoted"><span class="free">sim2</span></span> <span class="quoted"><span class="free">ℐ_real2</span></span> <span class="quoted"><span class="free">ℐ_inner2</span></span> <span class="quoted"><span class="free">ℐ_common2</span></span> <span class="quoted"><span class="free">adv2</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span><span class="main">)</span> <span class="keyword1">⊢res</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">real2</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℐ_inner1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span><span class="main">)</span> <span class="keyword1">⊢res</span> parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span><span class="main">,</span> <span class="free">ℐ_inner1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">sim1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="main">(</span><span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_inner1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span><span class="main">)</span> <span class="main">(</span><span class="free">sim1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">adv1</span> <span class="main">+</span> <span class="free">adv2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sec1.adv_nonneg sec2.adv_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> parallel_constructive_security_obsf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">real1</span> <span class="free">ideal1</span> <span class="free">sim1</span> <span class="free">ℐ_real1</span> <span class="free">ℐ_inner1</span> <span class="free">ℐ_common1</span> <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span>parallel_wiring <span class="main">⊙</span> parallel_converter <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span>converter_of_resource <span class="main">(</span><span class="free">sim2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">adv1</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?𝒜1</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">real2</span> <span class="free">ideal2</span> <span class="free">sim2</span> <span class="free">ℐ_real2</span> <span class="free">ℐ_inner2</span> <span class="free">ℐ_common2</span> <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span>parallel_wiring <span class="main">⊙</span> parallel_converter <span class="main">(</span>converter_of_resource <span class="free">real1</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">adv2</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?𝒜2</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">real2</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="main">∥</span> <span class="free">ideal2</span><span class="main">)</span> <span class="main">(</span><span class="free">sim1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span> 
    <span class="main">(</span><span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_inner1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span><span class="main">)</span>
    <span class="free">𝒜</span> <span class="main">(</span><span class="free">adv1</span> <span class="main">+</span> <span class="free">adv2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> sec1<span class="main">:</span> constructive_security_obsf <span class="quoted"><span class="free">real1</span></span> <span class="quoted"><span class="free">ideal1</span></span> <span class="quoted"><span class="free">sim1</span></span> <span class="quoted"><span class="free">ℐ_real1</span></span> <span class="quoted"><span class="free">ℐ_inner1</span></span> <span class="quoted"><span class="free">ℐ_common1</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜1</span></span></span> <span class="quoted"><span class="free">adv1</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> sec2<span class="main">:</span> constructive_security_obsf <span class="quoted"><span class="free">real2</span></span> <span class="quoted"><span class="free">ideal2</span></span> <span class="quoted"><span class="free">sim2</span></span> <span class="quoted"><span class="free">ℐ_real2</span></span> <span class="quoted"><span class="free">ℐ_inner2</span></span> <span class="quoted"><span class="free">ℐ_common2</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜2</span></span></span> <span class="quoted"><span class="free">adv2</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> WT <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="main">(</span><span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="main">(</span><span class="main">(</span><span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span>
    <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="main">∼</span>
    parallel_wiring <span class="main">⊙</span> <span class="main">(</span>converter_of_resource <span class="free">real1</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> <span class="free">sim2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> comp_parallel_wiring
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_attach_on<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> conv'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
          <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_comp_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_converter_mono<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def attach_compose attach_parallel2 attach_converter_of_resource_conv_parallel_resource
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> parallel_converter2_eq_ℐ_cong parallel_converter2_id_id eq_ℐ_converter_reflI<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> ideal2<span class="main">:</span>
      <span class="quoted"><span class="quoted">"connect_obsf <span class="var">?𝒜2</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">ideal2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> outs_plus_ℐ<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> obsf_attach<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obsf_resource_eq_ℐ_cong<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_sym<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> attach_compose<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> **<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">have</span></span> real2<span class="main">:</span> <span class="quoted"><span class="quoted">"connect_obsf <span class="var">?𝒜2</span> <span class="main">(</span>obsf_resource <span class="free">real2</span><span class="main">)</span> <span class="main">=</span> connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">real2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> outs_plus_ℐ<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> obsf_attach<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obsf_resource_eq_ℐ_cong<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_sym<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_compose attach_converter_of_resource_conv_parallel_resource<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> adv2<span class="main">:</span> <span class="quoted"><span class="quoted">"advantage <span class="free">𝒜</span>
     <span class="main">(</span>obsf_resource <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">ideal2</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>obsf_resource <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">real2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">adv2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> advantage_def ideal2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> real2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sec2.adv<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> advantage_def<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> ideal1<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"connect_obsf <span class="var">?𝒜1</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="main">(</span><span class="free">sim1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="main">∥</span> <span class="free">ideal2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>outs_ℐ <span class="free">ℐ_real1</span> <span class="main">&lt;+&gt;</span> outs_ℐ <span class="free">ℐ_real2</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> outs_ℐ <span class="free">ℐ_common1</span> <span class="main">&lt;+&gt;</span> outs_ℐ <span class="free">ℐ_common2</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span>
    <span class="main">(</span><span class="free">sim1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="main">∼</span>
    parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> converter_of_resource <span class="main">(</span><span class="free">sim2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal2</span><span class="main">)</span><span class="main">)</span> <span class="main">⊳</span> <span class="free">sim1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def comp_parallel_wiring' attach_compose attach_parallel2 attach_converter_of_resource_conv_parallel_resource2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> outs_plus_ℐ<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> obsf_attach<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obsf_resource_eq_ℐ_cong<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_sym<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> *<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> real1<span class="main">:</span> <span class="quoted"><span class="quoted">"connect_obsf <span class="var">?𝒜1</span> <span class="main">(</span>obsf_resource <span class="free">real1</span><span class="main">)</span> <span class="main">=</span> connect_obsf <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">ideal2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="main">(</span><span class="main">(</span><span class="free">ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span>
    parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="main">∼</span>
    parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> converter_of_resource <span class="main">(</span><span class="free">sim2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal2</span> <span class="main">)</span><span class="main">)</span> <span class="main">⊳</span> <span class="free">real1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_attach_on<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> conv'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
            <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_comp_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_converter_mono<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def attach_compose attach_converter_of_resource_conv_parallel_resource2 attach_parallel2 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> parallel_converter2_eq_ℐ_cong parallel_converter2_id_id eq_ℐ_converter_reflI<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> outs_plus_ℐ<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> obsf_attach<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obsf_resource_eq_ℐ_cong<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_sym<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> attach_compose<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> comp_parallel_wiring<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> *<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> adv1<span class="main">:</span> <span class="quoted"><span class="quoted">"advantage <span class="free">𝒜</span> 
     <span class="main">(</span>obsf_resource <span class="main">(</span><span class="main">(</span><span class="free">sim1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="main">∥</span> <span class="free">ideal2</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>obsf_resource <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">ideal2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">adv1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> advantage_def ideal1<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> real1<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sec1.adv<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> advantage_def<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">from</span></span> adv1 adv2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"advantage <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="main">(</span><span class="free">sim1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="main">∥</span> <span class="free">ideal2</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>obsf_resource <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">real2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">adv1</span> <span class="main">+</span> <span class="free">adv2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> parallel_constructive_security_obsf_fuse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">real1</span> <span class="free">ideal1</span> <span class="free">sim1</span> <span class="main">(</span><span class="free">ℐ_real1_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real1_rest</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal1_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_ideal1_rest</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common1_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common1_rest</span><span class="main">)</span> <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span>fused_wiring <span class="main">⊙</span> parallel_converter <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span>converter_of_resource <span class="main">(</span><span class="free">sim2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">adv1</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?ℐ_real1</span> <span class="var">?ℐ_ideal1</span> <span class="var">?ℐ_common1</span> <span class="var">?𝒜1</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="free">real2</span> <span class="free">ideal2</span> <span class="free">sim2</span> <span class="main">(</span><span class="free">ℐ_real2_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2_rest</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal2_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_ideal2_rest</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common2_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2_rest</span><span class="main">)</span> <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span>fused_wiring <span class="main">⊙</span> parallel_converter <span class="main">(</span>converter_of_resource <span class="free">real1</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">adv2</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?ℐ_real2</span> <span class="var">?ℐ_ideal2</span> <span class="var">?ℐ_common2</span> <span class="var">?𝒜2</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span>fused_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">real2</span><span class="main">)</span> <span class="main">(</span>fused_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="main">∥</span> <span class="free">ideal2</span><span class="main">)</span> 
    <span class="main">(</span>parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="free">sim1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring<span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="free">ℐ_real1_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2_core</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_real1_rest</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2_rest</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">(</span><span class="free">ℐ_ideal1_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_ideal2_core</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_ideal1_rest</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_ideal2_rest</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="free">ℐ_common1_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2_core</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1_rest</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2_rest</span><span class="main">)</span><span class="main">)</span>
    <span class="free">𝒜</span> <span class="main">(</span><span class="free">adv1</span> <span class="main">+</span> <span class="free">adv2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> sec1<span class="main">:</span> constructive_security_obsf <span class="quoted"><span class="free">real1</span></span> <span class="quoted"><span class="free">ideal1</span></span> <span class="quoted"><span class="free">sim1</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ_real1</span></span></span> <span class="var"><span class="quoted"><span class="var">?ℐ_ideal1</span></span></span> <span class="var"><span class="quoted"><span class="var">?ℐ_common1</span></span></span> <span class="var"><span class="quoted"><span class="var">?𝒜1</span></span></span> <span class="quoted"><span class="free">adv1</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> sec2<span class="main">:</span> constructive_security_obsf <span class="quoted"><span class="free">real2</span></span> <span class="quoted"><span class="free">ideal2</span></span> <span class="quoted"><span class="free">sim2</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ_real2</span></span></span> <span class="var"><span class="quoted"><span class="var">?ℐ_ideal2</span></span></span> <span class="var"><span class="quoted"><span class="var">?ℐ_common2</span></span></span> <span class="var"><span class="quoted"><span class="var">?𝒜2</span></span></span> <span class="quoted"><span class="free">adv2</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">have</span></span> aux1<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_aux_obsf <span class="free">real1</span> <span class="free">ideal1</span> <span class="free">sim1</span> <span class="var">?ℐ_real1</span> <span class="var">?ℐ_ideal1</span> <span class="var">?ℐ_common1</span> <span class="free">adv1</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> aux2<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_aux_obsf <span class="free">real2</span> <span class="free">ideal2</span> <span class="free">sim2</span> <span class="var">?ℐ_real2</span> <span class="var">?ℐ_ideal2</span> <span class="var">?ℐ_common2</span> <span class="free">adv2</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

  <span class="keyword1"><span class="command">have</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_sim_obsf <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">real2</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="main">∥</span> <span class="free">ideal2</span><span class="main">)</span> <span class="main">(</span><span class="free">sim1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span><span class="main">)</span>
      <span class="main">(</span><span class="var">?ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_real2</span><span class="main">)</span> <span class="main">(</span><span class="var">?ℐ_common1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_common2</span><span class="main">)</span>
      <span class="main">(</span>absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span>parallel_wiring <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> parallel_wiring<span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="free">adv1</span> <span class="main">+</span> <span class="free">adv2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">ℐ_real1_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2_core</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_real1_rest</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2_rest</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="main">(</span><span class="free">ℐ_common1_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2_core</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1_rest</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2_rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> constructive_security_obsf 
      <span class="quoted"><span class="quoted">"parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="main">∥</span> <span class="free">real2</span>"</span></span>
      <span class="quoted"><span class="quoted">"parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="main">∥</span> <span class="free">ideal2</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">sim1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?ℐ_real1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_real2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ_ideal1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_ideal2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ_common1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_common2</span>"</span></span>
      <span class="quoted"><span class="quoted">"absorb <span class="free">𝒜</span> <span class="main">(</span>obsf_converter <span class="main">(</span>parallel_wiring <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> parallel_wiring<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">adv1</span> <span class="main">+</span> <span class="free">adv2</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> parallel_constructive_security_obsf<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> absorb_comp_converter<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf_absorb_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> fused_wiring_def comp_converter_assoc<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obsf_comp_converter<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf_absorb_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> fused_wiring_def<span class="main">)</span>                                               
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> comp_converter_assoc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> obsf_comp_converter<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">wiring_intro</span></span> parallel_wiring_inverse<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fused_wiring_def attach_compose
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf_lifting<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w_adv_ideal_inv<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">parallel_wiring</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> parallel_constructive_security_aux_obsf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> aux1 aux2<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> sim<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> parallel_wiring_inverse<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Asymptotic_Security">
<div class="head">
<h1>Theory Asymptotic_Security</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Asymptotic_Security <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Concrete_Security">Concrete_Security</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Asymptotic security definition›</span></span>

<span class="keyword1"><span class="command">locale</span></span> constructive_security_obsf' <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">real_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ideal_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_real</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_ideal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_common</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> distinguisher_obsf"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> constructive_security_aux_obsf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span>
    constructive_security_aux_obsf <span class="main">(</span><span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="bound">η</span> <span class="main">√</span> <span class="main">⟧</span>
      <span class="main">⟹</span> negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="free">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> constructive_security_aux_obsf 
  <span class="quoted"><span class="quoted">"<span class="free">real_resource</span> <span class="free">η</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ideal_resource</span> <span class="free">η</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="free">η</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="free">η</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="free">η</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℐ_common</span> <span class="free">η</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_aux_obsf<span class="main">)</span>

<span class="keyword1" id="Asymptotic_Security-constructive_security_obsf'D"><span class="command">lemma</span></span> constructive_security_obsf'D<span class="main">:</span>
  <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span><span class="free">real_resource</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒜</span> <span class="free">η</span><span class="main">)</span>
    <span class="main">(</span>advantage <span class="main">(</span><span class="free">𝒜</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="free">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">real_resource</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf_refl<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Asymptotic_Security-constructive_security_obsf'I"><span class="command">lemma</span></span> constructive_security_obsf'I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> constructive_security_obsf <span class="main">(</span><span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">adv</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="bound">η</span> <span class="main">√</span><span class="main">)</span> <span class="main">⟹</span> negligible <span class="free">adv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf' <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> constructive_security_obsf 
    <span class="quoted"><span class="quoted">"<span class="free">real_resource</span> <span class="skolem">η</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ideal_resource</span> <span class="skolem">η</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="skolem">η</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ℐ_common</span> <span class="skolem">η</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">𝒜</span> <span class="skolem">η</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">adv</span> <span class="skolem">η</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="free">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="bound">η</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> negligible_mono<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventuallyI landau_o.big_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_nonneg adv_nonneg adv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> order_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Asymptotic_Security-constructive_security_obsf'_into_constructive_security"><span class="command">lemma</span></span> constructive_security_obsf'_into_constructive_security<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝒜</span> <span class="main">::</span> security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">)</span> distinguisher_obsf<span class="main">.</span> 
   <span class="main">⟦</span>  <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> interaction_bounded_by <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="bound">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span><span class="main">;</span>
      <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟹</span> plossless_gpv <span class="main">(</span>exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">⟧</span>
   <span class="main">⟹</span> constructive_security_obsf' <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="bound">𝒜</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cnv</span><span class="main">.</span> <span class="main">∀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
               Negligible.negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="free">bound</span> <span class="free">lossless</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> constructive_security_obsf' <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_ideal</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Done undefined›</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span> <span class="operator">simp_all</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢res</span> <span class="free">real_resource</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢res</span> <span class="free">ideal_resource</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">sim</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cnv</span><span class="main">.</span> <span class="main">∀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
               Negligible.negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">)</span> distinguisher"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> WT_adv <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_real</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒜</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bound <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟹</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> obsf_distinguisher <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> constructive_security_obsf' <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_ideal</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">interaction_bound</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="main">(</span>exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="free">lossless</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">using</span></span> WT_adv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span> lossless that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="var">?𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> adv<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> advantage_obsf_distinguisher <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Composition theorems›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> constructive_security_obsf'_composability<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf' <span class="free">middle</span> <span class="free">ideal</span> <span class="free">sim_inner</span> <span class="free">ℐ_middle</span> <span class="free">ℐ_inner</span> <span class="free">ℐ_common</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="free">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="main">(</span><span class="free">sim_outer</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf' <span class="free">real</span> <span class="free">middle</span> <span class="free">sim_outer</span> <span class="free">ℐ_real</span> <span class="free">ℐ_middle</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf' <span class="free">real</span> <span class="free">ideal</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">sim_outer</span> <span class="bound">η</span> <span class="main">⊙</span> <span class="free">sim_inner</span> <span class="bound">η</span><span class="main">)</span> <span class="free">ℐ_real</span> <span class="free">ℐ_inner</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf'I<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="free">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="main">(</span><span class="free">sim_outer</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> inner<span class="main">:</span> constructive_security_obsf' <span class="quoted"><span class="free">middle</span></span> <span class="quoted"><span class="free">ideal</span></span> <span class="quoted"><span class="free">sim_inner</span></span> <span class="quoted"><span class="free">ℐ_middle</span></span> <span class="quoted"><span class="free">ℐ_inner</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> outer<span class="main">:</span> constructive_security_obsf' <span class="quoted"><span class="free">real</span></span> <span class="quoted"><span class="free">middle</span></span> <span class="quoted"><span class="free">sim_outer</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_middle</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="free">𝒜</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?adv1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="var">?𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim_inner</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">middle</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?adv2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="free">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim_outer</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">middle</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">real</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?adv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="var">?adv1</span> <span class="bound">η</span> <span class="main">+</span> <span class="var">?adv2</span> <span class="bound">η</span>"</span></span>    
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span><span class="free">real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim_outer</span> <span class="skolem">η</span> <span class="main">⊙</span> <span class="free">sim_inner</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_inner</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?adv</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">using</span></span> inner.constructive_security_obsf'D outer.constructive_security_obsf'D
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf_composability<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negligible <span class="var">?adv1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> inner.adv<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negligible <span class="var">?adv2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> outer.adv<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>negligible_plus<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="var">?adv</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> constructive_security_obsf'_lifting<span class="main">:</span> <span class="comment1">(* TODO: generalize! *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sec<span class="main">:</span> <span class="quoted"><span class="quoted">"constructive_security_obsf' <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="free">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT_conv <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_common'</span> <span class="bound">η</span><span class="main">,</span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pfinite <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> pfinite_converter <span class="main">(</span><span class="free">ℐ_common'</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">conv</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf'
     <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="free">sim</span>
     <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common'</span> <span class="free">𝒜</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf'I<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="free">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> constructive_security_obsf' <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_ideal</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?adv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="var">?𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span> 

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">η</span> <span class="main">::</span> <span class="quoted">security</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="skolem">η</span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="skolem">η</span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim</span> <span class="skolem">η</span><span class="main">)</span>
     <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common'</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒜</span> <span class="skolem">η</span><span class="main">)</span>
     <span class="main">(</span><span class="var">?adv</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> constructive_security_obsf.constructive_security_aux_obsf<span class="main">[</span><span class="operator">OF</span> constructive_security_obsf'D<span class="main">]</span>
     constructive_security_obsf.constructive_security_sim_obsf<span class="main">[</span><span class="operator">OF</span> constructive_security_obsf'D<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf_lifting_usr<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="var">?adv</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> adv<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> constructive_security_obsf'_trivial<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">res</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf' <span class="free">res</span> <span class="free">res</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="free">ℐ</span> <span class="free">ℐ</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf'I<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span><span class="free">res</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">res</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span><span class="free">ℐ</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf_trivial<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> parallel_constructive_security_obsf'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf' <span class="free">real1</span> <span class="free">ideal1</span> <span class="free">sim1</span> <span class="free">ℐ_real1</span> <span class="free">ℐ_inner1</span> <span class="free">ℐ_common1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="free">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="main">(</span>parallel_wiring <span class="main">⊙</span> parallel_converter <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span>converter_of_resource <span class="main">(</span><span class="free">sim2</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf' <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?𝒜1</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf' <span class="free">real2</span> <span class="free">ideal2</span> <span class="free">sim2</span> <span class="free">ℐ_real2</span> <span class="free">ℐ_inner2</span> <span class="free">ℐ_common2</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="free">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_converter <span class="main">(</span>parallel_wiring <span class="main">⊙</span> parallel_converter <span class="main">(</span>converter_of_resource <span class="main">(</span><span class="free">real1</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf' <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?𝒜2</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf' <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">real2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">sim1</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="bound">η</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_real1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_inner1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_common1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="bound">η</span><span class="main">)</span> <span class="free">𝒜</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf'I<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> sec1<span class="main">:</span> constructive_security_obsf' <span class="quoted"><span class="free">real1</span></span> <span class="quoted"><span class="free">ideal1</span></span> <span class="quoted"><span class="free">sim1</span></span> <span class="quoted"><span class="free">ℐ_real1</span></span> <span class="quoted"><span class="free">ℐ_inner1</span></span> <span class="quoted"><span class="free">ℐ_common1</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜1</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> sec2<span class="main">:</span> constructive_security_obsf' <span class="quoted"><span class="free">real2</span></span> <span class="quoted"><span class="free">ideal2</span></span> <span class="quoted"><span class="free">sim2</span></span> <span class="quoted"><span class="free">ℐ_real2</span></span> <span class="quoted"><span class="free">ℐ_inner2</span></span> <span class="quoted"><span class="free">ℐ_common2</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜2</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?adv1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="var">?𝒜1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim1</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal1</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">real1</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?adv2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="var">?𝒜2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">sim2</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="free">real2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?adv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="var">?adv1</span> <span class="bound">η</span> <span class="main">+</span> <span class="var">?adv2</span> <span class="bound">η</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="skolem">η</span><span class="main">)</span>
     <span class="main">(</span><span class="free">sim1</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_inner1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒜</span> <span class="skolem">η</span><span class="main">)</span>
     <span class="main">(</span><span class="var">?adv</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">using</span></span> sec1.constructive_security_obsf'D sec2.constructive_security_obsf'D
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> parallel_constructive_security_obsf<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negligible <span class="var">?adv1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sec1.adv<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negligible <span class="var">?adv2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sec2.adv<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>negligible_plus<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="var">?adv</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Key">
<div class="head">
<h1>Theory Key</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Key
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="#Fused_Resource">../Fused_Resource</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Key specification›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ideal_key <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">valid_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'key</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data-types for Parties, State, Events, Input, and Output›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> party <span class="main">=</span> Alice <span class="main">|</span> Bob

<span class="keyword1"><span class="command">type_synonym</span></span> s_shell <span class="main">=</span> <span class="quoted"><span class="quoted">"party set"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'key'</span> s_kernel <span class="main">=</span> PState_Store <span class="main">|</span> State_Store <span class="tfree"><span class="quoted"><span class="tfree">'key'</span></span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'key'</span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'key'</span> s_kernel <span class="main">×</span> s_shell"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> event <span class="main">=</span> Event_Shell <span class="quoted">party</span> <span class="main">|</span> Event_Kernel

<span class="keyword1"><span class="command">datatype</span></span> iadv <span class="main">=</span> Inp_Adversary

<span class="keyword1"><span class="command">datatype</span></span> iusr_alice <span class="main">=</span> Inp_Alice
<span class="keyword1"><span class="command">datatype</span></span> iusr_bob <span class="main">=</span> Inp_Bob
<span class="keyword1"><span class="command">type_synonym</span></span> iusr <span class="main">=</span> <span class="quoted"><span class="quoted">"iusr_alice <span class="main">+</span> iusr_bob"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> oadv <span class="main">=</span> Out_Adversary

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'key'</span> ousr_alice <span class="main">=</span> Out_Alice <span class="tfree"><span class="quoted"><span class="tfree">'key'</span></span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'key'</span> ousr_bob <span class="main">=</span> Out_Bob <span class="tfree"><span class="quoted"><span class="tfree">'key'</span></span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'key'</span> ousr <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'key'</span> ousr_alice <span class="main">+</span> <span class="tfree">'key'</span> ousr_bob"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic lemmas for automated handling of party sets (i.e. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s_shell</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)›</span></span>

<span class="keyword1" id="Key-Alice_neq_iff"><span class="command">lemma</span></span> Alice_neq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Alice <span class="main">≠</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> Bob"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Key-neq_Alice_iff"><span class="command">lemma</span></span> neq_Alice_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> Alice <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> Bob"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Key-Bob_neq_iff"><span class="command">lemma</span></span> Bob_neq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Bob <span class="main">≠</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> Alice"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Key-neq_Bob_iff"><span class="command">lemma</span></span> neq_Bob_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> Bob <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> Alice"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Key-Alice_in_iff_nonempty"><span class="command">lemma</span></span> Alice_in_iff_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"Alice <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Bob <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> party.exhaust<span class="main">)</span>

<span class="keyword1" id="Key-Bob_in_iff_nonempty"><span class="command">lemma</span></span> Bob_in_iff_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"Bob <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Alice <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> party.exhaust<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining the event handler›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">poke</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span> state<span class="main">,</span> event<span class="main">)</span> handler"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">poke</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_kernel</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span> <span class="main">(</span>Event_Shell <span class="free"><span class="bound"><span class="entity">party</span></span></span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">party</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span> <span class="keyword1">then</span> 
        return_pmf None
      <span class="keyword1">else</span> 
        return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_kernel</span></span></span><span class="main">,</span> insert <span class="free"><span class="bound"><span class="entity">party</span></span></span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">poke</span> <span class="main">(</span>PState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_shell</span></span></span><span class="main">)</span> <span class="main">(</span>Event_Kernel<span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">key</span> <span class="main">←</span> spmf_of_set <span class="free">valid_keys</span><span class="main">;</span>
      return_spmf <span class="main">(</span>State_Store <span class="bound">key</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_shell</span></span></span><span class="main">)</span>  <span class="main">}</span> "</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">poke</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf None"</span></span>

<span class="keyword1" id="Key-in_set_spmf_poke"><span class="command">lemma</span></span> in_set_spmf_poke<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">∈</span> set_spmf <span class="main">(</span>poke <span class="free">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">s_kernel</span> <span class="bound">parties</span> <span class="bound">party</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s_kernel</span><span class="main">,</span> <span class="bound">parties</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> Event_Shell <span class="bound">party</span> <span class="main">∧</span> <span class="bound">party</span> <span class="main">∉</span> <span class="bound">parties</span> <span class="main">∧</span> <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s_kernel</span><span class="main">,</span> insert <span class="bound">party</span> <span class="bound">parties</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">s_shell</span> <span class="bound">key</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>PState_Store<span class="main">,</span> <span class="bound">s_shell</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> Event_Kernel <span class="main">∧</span> <span class="bound">key</span> <span class="main">∈</span> <span class="free">valid_keys</span> <span class="main">∧</span> finite <span class="free">valid_keys</span> <span class="main">∧</span> <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span>State_Store <span class="bound">key</span><span class="main">,</span> <span class="bound">s_shell</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> poke.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_spmf_of_set<span class="main">)</span>

<span class="keyword1" id="Key-foldl_poke_invar"><span class="command">lemma</span></span> foldl_poke_invar<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s_kernel'</span><span class="main">,</span> <span class="free">parties'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>foldl_spmf poke <span class="free">p</span> <span class="free">events</span><span class="main">)</span><span class="main">;</span> <span class="main">∀</span><span class="main">(</span><span class="bound">s_kernel</span><span class="main">,</span> <span class="bound">parties</span><span class="main">)</span><span class="main">∈</span>set_spmf <span class="free">p</span><span class="main">.</span> set_s_kernel <span class="bound">s_kernel</span> <span class="main">⊆</span> <span class="free">valid_keys</span> <span class="main">⟧</span>
  <span class="main">⟹</span> set_s_kernel <span class="free">s_kernel'</span> <span class="main">⊆</span> <span class="free">valid_keys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">events</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">parties'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def foldl_spmf_append in_set_spmf_poke <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bspec<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining the adversary interface›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iface_adv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span> state<span class="main">,</span> iadv<span class="main">,</span> oadv<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">iface_adv</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_spmf <span class="main">(</span>Out_Adversary<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining the user interfaces›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">iface_usr_func</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"party <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'inp</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'wrap_key</span> <span class="main">×</span> <span class="tfree">'key</span> state<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">iface_usr_func</span> <span class="free"><span class="bound"><span class="entity">party</span></span></span> <span class="free"><span class="bound"><span class="entity">wrap</span></span></span> <span class="main">(</span>State_Store <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">inp</span></span></span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">party</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span> <span class="keyword1">then</span>
        return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">wrap</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">,</span> State_Store <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span>
        return_pmf None<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">iface_usr_func</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">iface_alice</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span> state<span class="main">,</span> iusr_alice<span class="main">,</span> <span class="tfree">'key</span> ousr_alice<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">iface_alice</span> <span class="main">≡</span> iface_usr_func Alice Out_Alice"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">iface_bob</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span> state<span class="main">,</span> iusr_bob<span class="main">,</span> <span class="tfree">'key</span> ousr_bob<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">iface_bob</span> <span class="main">≡</span> iface_usr_func Bob Out_Bob"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">iface_usr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span> state<span class="main">,</span> iusr<span class="main">,</span> <span class="tfree">'key</span> ousr<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">iface_usr</span> <span class="main">≡</span> plus_oracle iface_alice iface_bob"</span></span>

<span class="keyword1" id="Key-in_set_iface_usr_func"><span class="command">lemma</span></span> in_set_iface_usr_func <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set_spmf <span class="main">(</span>iface_usr_func <span class="free">party</span> <span class="free">wrap</span> <span class="free">state</span> <span class="free">inp</span><span class="main">)</span> <span class="main">⟷</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">key</span> <span class="bound">parties</span><span class="main">.</span> <span class="free">state</span> <span class="main">=</span> <span class="main">(</span>State_Store <span class="bound">key</span><span class="main">,</span> <span class="bound">parties</span><span class="main">)</span> <span class="main">∧</span> <span class="free">party</span> <span class="main">∈</span> <span class="bound">parties</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">wrap</span> <span class="bound">key</span><span class="main">,</span> State_Store <span class="bound">key</span><span class="main">,</span> <span class="bound">parties</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">party</span><span class="main">,</span> <span class="free">wrap</span><span class="main">,</span> <span class="free">state</span><span class="main">,</span> <span class="free">inp</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iface_usr_func.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining the Fuse Resource›</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span> state<span class="main">,</span> event<span class="main">,</span> iadv<span class="main">,</span> iusr<span class="main">,</span> oadv<span class="main">,</span><span class="tfree">'key</span> ousr<span class="main">)</span> core"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"cpoke <span class="free">core</span> <span class="main">=</span> poke"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">core</span> <span class="main">=</span> iface_adv"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">core</span> <span class="main">=</span> iface_usr"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> fused_resource <span class="quoted">core</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>PState_Store<span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma showing that the resulting resource is well-typed›</span></span>

<span class="keyword1" id="Key-WT_core"><span class="command">lemma</span></span> WT_core <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"WT_core ℐ_full <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>Out_Alice <span class="main">`</span> <span class="free">valid_keys</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>Out_Bob <span class="main">`</span> <span class="free">valid_keys</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>pred_prod <span class="main">(</span>pred_s_kernel <span class="main">(</span><span class="main">λ</span><span class="bound">key</span><span class="main">.</span> <span class="bound">key</span> <span class="main">∈</span> <span class="free">valid_keys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span><span class="main">)</span> core"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_core.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s e s' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> poke.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_spmf_of_set<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Key-WT_fuse"><span class="command">lemma</span></span> WT_fuse <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_rest</span> <span class="free">ℐ_usr_rest</span> <span class="free">I_rest</span> <span class="free">rest</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_rest</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>Out_Alice <span class="main">`</span> <span class="free">valid_keys</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>Out_Bob <span class="main">`</span> <span class="free">valid_keys</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_rest</span><span class="main">)</span> <span class="keyword1">⊢res</span> resource <span class="free">rest</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">simp</span>
 
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Channel">
<div class="head">
<h1>Theory Channel</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Channel
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="#Fused_Resource">../Fused_Resource</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Channel specification›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ideal_channel <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
  <span class="comment1">(*TODO: decide to either include or exlude this fixation,
    - if it is not included, then the types must be manually stated whenever channel locale is imported (c.f. OTP and DH)
    - also, the WT_intro rules for channel will have an unspecified valid_messages*)</span>
  <span class="comment1">(*  valid_messages :: "'msg set" and*)</span>
    <span class="free">leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg</span> <span class="main">⇒</span> <span class="tfree">'leak</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">editable</span> <span class="main">::</span> <span class="quoted">bool</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data-types for Parties, State, Events, Input, and Output›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> party <span class="main">=</span> Alice <span class="main">|</span> Bob

<span class="keyword1"><span class="command">type_synonym</span></span> s_shell <span class="main">=</span> <span class="quoted"><span class="quoted">"party set"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'msg'</span> s_kernel <span class="main">=</span>  State_Void <span class="main">|</span> State_Store <span class="tfree"><span class="quoted"><span class="tfree">'msg'</span></span></span> <span class="main">|</span> State_Collect <span class="tfree"><span class="quoted"><span class="tfree">'msg'</span></span></span> <span class="main">|</span> State_Collected
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'msg'</span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg'</span> s_kernel <span class="main">×</span> s_shell"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> event <span class="main">=</span> Event_Shell <span class="quoted">party</span>

<span class="keyword1"><span class="command">datatype</span></span> iadv_drop <span class="main">=</span> Inp_Drop
<span class="keyword1"><span class="command">datatype</span></span> iadv_look <span class="main">=</span> Inp_Look
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'msg'</span> iadv_fedit <span class="main">=</span> Inp_Fedit <span class="tfree"><span class="quoted"><span class="tfree">'msg'</span></span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'msg'</span> iadv <span class="main">=</span> <span class="quoted"><span class="quoted">"iadv_drop <span class="main">+</span> iadv_look <span class="main">+</span> <span class="tfree">'msg'</span> iadv_fedit"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'msg'</span> iusr_alice <span class="main">=</span> Inp_Send <span class="tfree"><span class="quoted"><span class="tfree">'msg'</span></span></span>
<span class="keyword1"><span class="command">datatype</span></span> iusr_bob <span class="main">=</span> Inp_Recv
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'msg'</span> iusr <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg'</span> iusr_alice <span class="main">+</span> iusr_bob"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> oadv_drop <span class="main">=</span> Out_Drop
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'leak'</span> oadv_look <span class="main">=</span> Out_Look <span class="tfree"><span class="quoted"><span class="tfree">'leak'</span></span></span>
<span class="keyword1"><span class="command">datatype</span></span> oadv_fedit <span class="main">=</span> Out_Fedit
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'leak'</span> oadv <span class="main">=</span> <span class="quoted"><span class="quoted">"oadv_drop <span class="main">+</span> <span class="tfree">'leak'</span> oadv_look <span class="main">+</span> oadv_fedit"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> ousr_alice <span class="main">=</span> Out_Send
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'msg'</span> ousr_bob <span class="main">=</span> Out_Recv <span class="tfree"><span class="quoted"><span class="tfree">'msg'</span></span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'msg'</span> ousr <span class="main">=</span> <span class="quoted"><span class="quoted">"ousr_alice <span class="main">+</span> <span class="tfree">'msg'</span> ousr_bob"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic lemmas for automated handling of party sets (i.e. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s_shell</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)›</span></span>

<span class="keyword1" id="Channel-Alice_neq_iff"><span class="command">lemma</span></span> Alice_neq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Alice <span class="main">≠</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> Bob"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Channel-neq_Alice_iff"><span class="command">lemma</span></span> neq_Alice_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> Alice <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> Bob"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Channel-Bob_neq_iff"><span class="command">lemma</span></span> Bob_neq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Bob <span class="main">≠</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> Alice"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Channel-neq_Bob_iff"><span class="command">lemma</span></span> neq_Bob_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> Bob <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> Alice"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Channel-Alice_in_iff_nonempty"><span class="command">lemma</span></span> Alice_in_iff_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"Alice <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Bob <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> party.exhaust<span class="main">)</span>

<span class="keyword1" id="Channel-Bob_in_iff_nonempty"><span class="command">lemma</span></span> Bob_in_iff_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"Bob <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Alice <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> party.exhaust<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining the event handler›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">poke</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msg</span> state<span class="main">,</span> event<span class="main">)</span> handler"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">poke</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_kernel</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span> <span class="main">(</span>Event_Shell <span class="free"><span class="bound"><span class="entity">party</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">party</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span> <span class="keyword1">then</span> 
        return_pmf None 
      <span class="keyword1">else</span> 
        return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_kernel</span></span></span><span class="main">,</span> insert <span class="free"><span class="bound"><span class="entity">party</span></span></span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Channel-poke_alt_def"><span class="command">lemma</span></span> poke_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"poke <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">ps</span><span class="main">)</span> <span class="bound">e</span><span class="main">.</span> map_spmf <span class="main">(</span>Pair <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">e</span> <span class="keyword1">of</span> Event_Shell <span class="bound">party</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">party</span> <span class="main">∈</span> <span class="bound">ps</span> <span class="keyword1">then</span> return_pmf None <span class="keyword1">else</span> return_spmf <span class="main">(</span>insert <span class="bound">party</span> <span class="bound">ps</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> event.split<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining the adversary interfaces›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iface_drop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msg</span> state<span class="main">,</span> iadv_drop<span class="main">,</span> oadv_drop<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">iface_drop</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iface_look</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msg</span> state<span class="main">,</span> iadv_look<span class="main">,</span> <span class="tfree">'leak</span> oadv_look<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">iface_look</span> <span class="main">(</span>State_Store <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span>
      return_spmf <span class="main">(</span>Out_Look <span class="main">(</span><span class="free">leak</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span><span class="main">,</span> State_Store <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">iface_look</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iface_fedit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msg</span> state<span class="main">,</span> <span class="tfree">'msg</span> iadv_fedit<span class="main">,</span> oadv_fedit<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">iface_fedit</span> <span class="main">(</span>State_Store <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span> <span class="main">(</span>Inp_Fedit <span class="free"><span class="bound"><span class="entity">msg'</span></span></span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">editable</span> <span class="keyword1">then</span>
        return_spmf <span class="main">(</span>Out_Fedit<span class="main">,</span> State_Collect <span class="free"><span class="bound"><span class="entity">msg'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span>
        return_spmf <span class="main">(</span>Out_Fedit<span class="main">,</span> State_Collect <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">iface_fedit</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">iface_adv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msg</span> state<span class="main">,</span> <span class="tfree">'msg</span> iadv<span class="main">,</span> <span class="tfree">'leak</span> oadv<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">iface_adv</span> <span class="main">≡</span> plus_oracle iface_drop <span class="main">(</span>plus_oracle iface_look iface_fedit<span class="main">)</span>"</span></span>

<span class="keyword1" id="Channel-in_set_spmf_iface_drop"><span class="command">lemma</span></span> in_set_spmf_iface_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys'</span> <span class="main">∈</span> set_spmf <span class="main">(</span>iface_drop <span class="free">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Channel-in_set_spmf_iface_look"><span class="command">lemma</span></span> in_set_spmf_iface_look<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys'</span> <span class="main">∈</span> set_spmf <span class="main">(</span>iface_look <span class="free">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">msg</span> <span class="bound">parties</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>State_Store <span class="bound">msg</span><span class="main">,</span> <span class="bound">parties</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ys'</span> <span class="main">=</span> <span class="main">(</span>Out_Look <span class="main">(</span><span class="free">leak</span> <span class="bound">msg</span><span class="main">)</span><span class="main">,</span> State_Store <span class="bound">msg</span><span class="main">,</span> <span class="bound">parties</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iface_look.cases<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Channel-in_set_spmf_iface_fedit"><span class="command">lemma</span></span> in_set_spmf_iface_fedit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys'</span> <span class="main">∈</span> set_spmf <span class="main">(</span>iface_fedit <span class="free">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">msg</span> <span class="bound">parties</span> <span class="bound">msg'</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>State_Store <span class="bound">msg</span><span class="main">,</span> <span class="bound">parties</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>Inp_Fedit <span class="bound">msg'</span><span class="main">)</span> <span class="main">∧</span>
      <span class="free">ys'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">editable</span> <span class="keyword1">then</span> <span class="main">(</span>Out_Fedit<span class="main">,</span> State_Collect <span class="bound">msg'</span><span class="main">,</span> <span class="bound">parties</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>Out_Fedit<span class="main">,</span> State_Collect <span class="bound">msg</span><span class="main">,</span> <span class="bound">parties</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iface_fedit.cases<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining the user interfaces›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iface_alice</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msg</span> state<span class="main">,</span> <span class="tfree">'msg</span> iusr_alice<span class="main">,</span> ousr_alice<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">iface_alice</span> <span class="main">(</span>State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span> <span class="main">(</span>Inp_Send <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">if</span> Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span> <span class="keyword1">then</span>
        return_spmf <span class="main">(</span>Out_Send<span class="main">,</span> State_Store <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span>
        return_pmf None<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">iface_alice</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iface_bob</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msg</span> state<span class="main">,</span> iusr_bob<span class="main">,</span> <span class="tfree">'msg</span> ousr_bob<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">iface_bob</span> <span class="main">(</span>State_Collect <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">if</span> Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span> <span class="keyword1">then</span>
        return_spmf <span class="main">(</span>Out_Recv <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">,</span> State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span>
        return_pmf None<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">iface_bob</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">iface_usr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msg</span> state<span class="main">,</span> <span class="tfree">'msg</span> iusr<span class="main">,</span> <span class="tfree">'msg</span> ousr<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">iface_usr</span> <span class="main">≡</span> plus_oracle iface_alice iface_bob"</span></span>

<span class="keyword1" id="Channel-in_set_spmf_iface_alice"><span class="command">lemma</span></span> in_set_spmf_iface_alice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys'</span> <span class="main">∈</span> set_spmf <span class="main">(</span>iface_alice <span class="free">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">parties</span> <span class="bound">msg</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>State_Void<span class="main">,</span> <span class="bound">parties</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> Inp_Send <span class="bound">msg</span> <span class="main">∧</span> Alice <span class="main">∈</span> <span class="bound">parties</span> <span class="main">∧</span> <span class="free">ys'</span> <span class="main">=</span> <span class="main">(</span>Out_Send<span class="main">,</span> State_Store <span class="bound">msg</span><span class="main">,</span> <span class="bound">parties</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iface_alice.cases<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Channel-in_set_spmf_iface_bob"><span class="command">lemma</span></span> in_set_spmf_iface_bob<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys'</span> <span class="main">∈</span> set_spmf <span class="main">(</span>iface_bob <span class="free">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">msg</span> <span class="bound">parties</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>State_Collect <span class="bound">msg</span><span class="main">,</span> <span class="bound">parties</span><span class="main">)</span> <span class="main">∧</span> Bob <span class="main">∈</span> <span class="bound">parties</span> <span class="main">∧</span> <span class="free">ys'</span> <span class="main">=</span> <span class="main">(</span>Out_Recv <span class="bound">msg</span><span class="main">,</span> State_Collected<span class="main">,</span> <span class="bound">parties</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iface_bob.cases<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining the Fused Resource›</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msg</span> state<span class="main">,</span> event<span class="main">,</span> <span class="tfree">'msg</span> iadv<span class="main">,</span> <span class="tfree">'msg</span> iusr<span class="main">,</span> <span class="tfree">'leak</span> oadv<span class="main">,</span> <span class="tfree">'msg</span> ousr<span class="main">)</span> core"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"cpoke <span class="free">core</span> <span class="main">=</span> poke"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">core</span> <span class="main">=</span> iface_adv"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">core</span> <span class="main">=</span> iface_usr"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> fused_resource <span class="quoted">core</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>State_Void<span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma showing that the resulting resource is well-typed›</span></span>

<span class="keyword1" id="Channel-WT_core"><span class="command">lemma</span></span> WT_core <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"WT_core <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>Inp_Fedit <span class="main">`</span> <span class="free">valid_messages</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">(</span>ℐ_uniform <span class="main">(</span>Inp_Send <span class="main">`</span> <span class="free">valid_messages</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>Out_Recv <span class="main">`</span> <span class="free">valid_messages</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>pred_prod <span class="main">(</span>pred_s_kernel <span class="main">(</span><span class="main">λ</span><span class="bound">msg</span><span class="main">.</span> <span class="bound">msg</span> <span class="main">∈</span> <span class="free">valid_messages</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span><span class="main">)</span> core"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_core.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s e s' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> poke.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> projl <span class="main">(</span>projr <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iface_look.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> projl <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iface_alice.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Channel-WT_fuse"><span class="command">lemma</span></span> WT_fuse <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_rest</span> <span class="free">ℐ_usr_rest</span> <span class="free">I_rest</span> <span class="free">rest</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>Inp_Fedit <span class="main">`</span> <span class="free">valid_messages</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_rest</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> 
      <span class="main">(</span><span class="main">(</span>ℐ_uniform <span class="main">(</span>Inp_Send <span class="main">`</span> <span class="free">valid_messages</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>Out_Recv <span class="main">`</span> <span class="free">valid_messages</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_rest</span><span class="main">)</span> <span class="keyword1">⊢res</span> resource <span class="free">rest</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">simp</span>


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="One_Time_Pad">
<div class="head">
<h1>Theory One_Time_Pad</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> One_Time_Pad
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../../sigma_commit_crypto/theories/#Xor">Sigma_Commit_Crypto.Xor</a>
    <span class="quoted">"<a href="#Asymptotic_Security">../Asymptotic_Security</a>"</span>
    <span class="quoted">"<a href="#Construction_Utility">../Construction_Utility</a>"</span>
    <span class="quoted">"<a href="#Key">../Specifications/Key</a>"</span>
    <span class="quoted">"<a href="#Channel">../Specifications/Channel</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹One-time-pad construction›</span></span>

<span class="keyword1"><span class="command">locale</span></span> one_time_pad <span class="main">=</span>
    key<span class="main">:</span> ideal_key <span class="quoted"><span class="quoted">"carrier <span class="free">ℒ</span>"</span></span>  <span class="main">+</span>
    auth<span class="main">:</span> ideal_channel <span class="quoted"><span class="quoted">"id <span class="main">::</span> <span class="tfree">'msg</span> <span class="main">⇒</span> <span class="tfree">'msg</span>"</span></span> <span class="quoted">False</span> <span class="main">+</span>
    sec<span class="main">:</span> ideal_channel <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">::</span> <span class="tfree">'msg</span><span class="main">.</span> carrier <span class="free">ℒ</span>"</span></span> <span class="quoted">False</span> <span class="main">+</span>
    boolean_algebra <span class="quoted"><span class="free">ℒ</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> 
    <span class="free">ℒ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msg</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> boolean_algebra_scheme"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">structure</span></span><span class="main">)</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    nempty_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="free">ℒ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    finite_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>carrier <span class="free">ℒ</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining user callees›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enc_callee</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" unit <span class="main">⇒</span> <span class="tfree">'msg</span> sec.iusr_alice 
  <span class="main">⇒</span> <span class="main">(</span>sec.ousr_alice <span class="main">×</span> unit<span class="main">,</span> key.iusr_alice <span class="main">+</span> <span class="tfree">'msg</span> sec.iusr_alice<span class="main">,</span> <span class="tfree">'msg</span> key.ousr_alice <span class="main">+</span> auth.ousr_alice<span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">enc_callee</span> <span class="main">≡</span> stateless_callee <span class="main">(</span><span class="main">λ</span><span class="bound">inp</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">inp</span> <span class="keyword1">of</span> sec.Inp_Send <span class="bound">msg</span> <span class="main">⇒</span>
      <span class="keyword1">if</span> <span class="bound">msg</span> <span class="main">∈</span> carrier <span class="free">ℒ</span> <span class="keyword1">then</span>
        Pause 
          <span class="main">(</span>Inl key.Inp_Alice<span class="main">)</span> 
          <span class="main">(</span><span class="main">λ</span><span class="bound">kout</span><span class="main">.</span> <span class="keyword1">case</span> projl <span class="bound">kout</span> <span class="keyword1">of</span> key.Out_Alice <span class="bound">key</span> <span class="main">⇒</span> 
            <span class="keyword1">let</span> <span class="bound">cipher</span> <span class="main">=</span> <span class="bound">key</span> <span class="main">⊕</span> <span class="bound">msg</span> <span class="keyword1">in</span>
            Pause <span class="main">(</span>Inr <span class="main">(</span>auth.Inp_Send <span class="bound">cipher</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Done sec.Out_Send<span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span>
        Fail<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dec_callee</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" unit <span class="main">⇒</span> sec.iusr_bob 
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'msg</span> sec.ousr_bob <span class="main">×</span> unit<span class="main">,</span> key.iusr_bob <span class="main">+</span> auth.iusr_bob<span class="main">,</span> <span class="tfree">'msg</span> key.ousr_bob <span class="main">+</span> <span class="tfree">'msg</span> auth.ousr_bob<span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">dec_callee</span> <span class="main">≡</span> stateless_callee <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span>
      Pause 
        <span class="main">(</span>Inr auth.Inp_Recv<span class="main">)</span> 
        <span class="main">(</span><span class="main">λ</span><span class="bound">cout</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">cout</span> <span class="keyword1">of</span> 
          Inr <span class="main">(</span>auth.Out_Recv <span class="bound">cipher</span><span class="main">)</span> <span class="main">⇒</span>
            Pause 
              <span class="main">(</span>Inl key.Inp_Bob<span class="main">)</span> 
              <span class="main">(</span><span class="main">λ</span><span class="bound">kout</span><span class="main">.</span> <span class="keyword1">case</span> projl <span class="bound">kout</span> <span class="keyword1">of</span> key.Out_Bob <span class="bound">key</span> <span class="main">⇒</span>
                Done <span class="main">(</span>sec.Out_Recv <span class="main">(</span><span class="bound">key</span> <span class="main">⊕</span> <span class="bound">cipher</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail<span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining adversary converter›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'msg'</span> astate <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg'</span> option"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">look_callee</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg</span> astate <span class="main">⇒</span> sec.iadv_look 
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'msg</span> sec.oadv_look <span class="main">×</span> <span class="tfree">'msg</span> astate<span class="main">,</span> sec.iadv_look<span class="main">,</span>  <span class="tfree">'msg</span> set sec.oadv_look<span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">look_callee</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">state</span> <span class="bound">inp</span><span class="main">.</span>   
      Pause 
        sec.Inp_Look
        <span class="main">(</span><span class="main">λ</span><span class="bound">cout</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">cout</span> <span class="keyword1">of</span>
          sec.Out_Look <span class="bound">msg_set</span> <span class="main">⇒</span> 
            <span class="main">(</span><span class="keyword1">case</span> <span class="bound">state</span> <span class="keyword1">of</span>
              None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
                <span class="bound">msg</span> <span class="main">←</span> lift_spmf <span class="main">(</span>spmf_of_set <span class="main">(</span><span class="bound">msg_set</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                Done <span class="main">(</span>auth.Out_Look <span class="bound">msg</span><span class="main">,</span> Some <span class="bound">msg</span><span class="main">)</span>  <span class="main">}</span>
            <span class="main">|</span> Some <span class="bound">msg</span> <span class="main">⇒</span> Done <span class="main">(</span>auth.Out_Look <span class="bound">msg</span><span class="main">,</span> Some <span class="bound">msg</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span>key.iadv <span class="main">+</span> auth.iadv_drop <span class="main">+</span> auth.iadv_look <span class="main">+</span> <span class="tfree">'msg</span> auth.iadv_fedit<span class="main">,</span>
    key.oadv <span class="main">+</span> auth.oadv_drop <span class="main">+</span> <span class="tfree">'msg</span> auth.oadv_look <span class="main">+</span> auth.oadv_fedit<span class="main">,</span>
    sec.iadv_drop <span class="main">+</span> sec.iadv_look <span class="main">+</span> <span class="tfree">'msg</span> sec.iadv_fedit<span class="main">,</span>
    sec.oadv_drop <span class="main">+</span> <span class="tfree">'msg</span> set sec.oadv_look <span class="main">+</span> sec.oadv_fedit<span class="main">)</span> converter"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="main">≡</span> 
      <span class="keyword1">let</span> <span class="bound">look_converter</span> <span class="main">=</span> converter_of_callee look_callee None <span class="keyword1">in</span>
      ldummy_converter <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> key.Out_Adversary<span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="bound">look_converter</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining event-translator›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> estate <span class="main">=</span> <span class="quoted"><span class="quoted">"bool <span class="main">×</span> <span class="main">(</span>key.party <span class="main">+</span> auth.party<span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">einit</span> <span class="main">::</span> <span class="quoted">estate</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">einit</span> <span class="main">≡</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sec_party_of_key_party</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"key.party <span class="main">⇒</span> sec.party"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">sec_party_of_key_party</span> <span class="main">≡</span> key.case_party sec.Alice sec.Bob"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">etran_base_helper</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"estate <span class="main">⇒</span> key.party <span class="main">+</span> auth.party <span class="main">⇒</span> sec.event list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">etran_base_helper</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_flg</span><span class="main">,</span> <span class="bound">s_kap</span><span class="main">)</span> <span class="bound">item</span><span class="main">.</span> 
      <span class="keyword1">let</span> <span class="bound">sp_of</span> <span class="main">=</span> case_sum sec_party_of_key_party id <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">se_of</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">chk</span> <span class="bound">out</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">s_flg</span> <span class="main">∧</span> <span class="bound">chk</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">out</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">chk_alice</span> <span class="main">=</span> Inl key.Alice <span class="main">∈</span> <span class="bound">s_kap</span> <span class="main">∧</span> Inr auth.Alice <span class="main">∈</span> <span class="bound">s_kap</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">chk_bob</span> <span class="main">=</span> Inl key.Bob <span class="main">∈</span> <span class="bound">s_kap</span> <span class="main">∧</span> Inr auth.Bob <span class="main">∈</span> <span class="bound">s_kap</span> <span class="keyword1">in</span>
      sec.case_party
        <span class="main">(</span><span class="bound">se_of</span> <span class="bound">chk_alice</span> <span class="main">(</span>sec.Event_Shell sec.Alice<span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="bound">se_of</span> <span class="bound">chk_bob</span> <span class="main">(</span>sec.Event_Shell sec.Bob<span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="bound">sp_of</span> <span class="bound">item</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">etran_base</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>estate<span class="main">,</span> key.party <span class="main">+</span> auth.party<span class="main">,</span> sec.event list<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">etran_base</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_flg</span><span class="main">,</span> <span class="bound">s_kap</span><span class="main">)</span> <span class="bound">item</span><span class="main">.</span>  
      <span class="keyword1">let</span> <span class="bound">s_kap'</span> <span class="main">=</span> insert <span class="bound">item</span> <span class="bound">s_kap</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">event</span> <span class="main">=</span> etran_base_helper <span class="main">(</span><span class="bound">s_flg</span><span class="main">,</span> <span class="bound">s_kap'</span><span class="main">)</span> <span class="bound">item</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> <span class="bound">item</span> <span class="main">∉</span> <span class="bound">s_kap</span> <span class="keyword1">then</span> return_spmf <span class="main">(</span><span class="bound">event</span><span class="main">,</span> <span class="bound">s_flg</span><span class="main">,</span> <span class="bound">s_kap'</span><span class="main">)</span> <span class="keyword1">else</span> return_pmf None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">etran</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>estate<span class="main">,</span> key.event <span class="main">+</span> auth.event<span class="main">,</span> sec.event list<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">etran</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>Inl <span class="main">(</span>key.Event_Shell <span class="free"><span class="bound"><span class="entity">party</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> etran_base <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">party</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">etran</span> <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_kap</span></span></span><span class="main">)</span> <span class="main">(</span>Inl key.Event_Kernel<span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">check_alice</span> <span class="main">=</span> Inl key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_kap</span></span></span> <span class="main">∧</span> Inr auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_kap</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">check_bob</span> <span class="main">=</span> Inl key.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_kap</span></span></span> <span class="main">∧</span> Inr auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_kap</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">e_alice</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">check_alice</span> <span class="keyword1">then</span> <span class="main">[</span>sec.Event_Shell sec.Alice<span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">e_bob</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">check_bob</span> <span class="keyword1">then</span> <span class="main">[</span>sec.Event_Shell sec.Bob<span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span> <span class="keyword1">in</span>
      return_spmf <span class="main">(</span><span class="bound">e_alice</span> <span class="main">@</span> <span class="bound">e_bob</span><span class="main">,</span> True<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_kap</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">etran</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>Inr <span class="main">(</span>auth.Event_Shell <span class="free"><span class="bound"><span class="entity">party</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> etran_base <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">party</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">etran</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf None"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic lemmas for automated handling of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sec_party_of_key_party</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="One_Time_Pad-sec_party_of_key_party_simps"><span class="command">lemma</span></span> sec_party_of_key_party_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sec_party_of_key_party key.Alice <span class="main">=</span> sec.Alice"</span></span>
  <span class="quoted"><span class="quoted">"sec_party_of_key_party key.Bob <span class="main">=</span> sec.Bob"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sec_party_of_key_party_def<span class="main">)</span>

<span class="keyword1" id="One_Time_Pad-sec_party_of_key_party_eq_simps"><span class="command">lemma</span></span> sec_party_of_key_party_eq_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sec_party_of_key_party <span class="free">p</span> <span class="main">=</span> sec.Alice <span class="main">⟷</span> <span class="free">p</span> <span class="main">=</span> key.Alice"</span></span>
  <span class="quoted"><span class="quoted">"sec_party_of_key_party <span class="free">p</span> <span class="main">=</span> sec.Bob <span class="main">⟷</span> <span class="free">p</span> <span class="main">=</span> key.Bob"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sec_party_of_key_party_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> key.party.split<span class="main">)</span>

<span class="keyword1" id="One_Time_Pad-key_case_party_collapse"><span class="command">lemma</span></span> key_case_party_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"key.case_party <span class="free">x</span> <span class="free">x</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> key.party.split<span class="main">)</span>

<span class="keyword1" id="One_Time_Pad-sec_case_party_collapse"><span class="command">lemma</span></span> sec_case_party_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sec.case_party <span class="free">x</span> <span class="free">x</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sec.party.split<span class="main">)</span>

<span class="keyword1" id="One_Time_Pad-Alice_in_sec_party_of_key_party"><span class="command">lemma</span></span> Alice_in_sec_party_of_key_party <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sec.Alice <span class="main">∈</span> sec_party_of_key_party <span class="main">`</span> <span class="free">P</span> <span class="main">⟷</span> key.Alice <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sec_party_of_key_party_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> key.party.splits<span class="main">)</span>

<span class="keyword1" id="One_Time_Pad-Bob_in_sec_party_of_key_party"><span class="command">lemma</span></span> Bob_in_sec_party_of_key_party <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sec.Bob <span class="main">∈</span> sec_party_of_key_party <span class="main">`</span> <span class="free">P</span> <span class="main">⟷</span> key.Bob <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sec_party_of_key_party_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> key.party.splits<span class="main">)</span>

<span class="keyword1" id="One_Time_Pad-case_sec_party_of_key_party"><span class="command">lemma</span></span> case_sec_party_of_key_party <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sec.case_party <span class="free">a</span> <span class="free">b</span> <span class="main">(</span>sec_party_of_key_party <span class="free">x</span><span class="main">)</span> <span class="main">=</span> key.case_party <span class="free">a</span> <span class="free">b</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sec_party_of_key_party_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sec.party.split key.party.split<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining Ideal and Real constructions›</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">key_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key_s_rest</span><span class="main">,</span> key.event<span class="main">,</span> <span class="tfree">'key_iadv_rest</span><span class="main">,</span> <span class="tfree">'key_iusr_rest</span><span class="main">,</span> <span class="tfree">'key_oadv_rest</span><span class="main">,</span> <span class="tfree">'key_ousr_rest</span><span class="main">)</span> rest_wstate"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">auth_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'auth_s_rest</span><span class="main">,</span> auth.event<span class="main">,</span> <span class="tfree">'auth_iadv_rest</span><span class="main">,</span> <span class="tfree">'auth_iusr_rest</span><span class="main">,</span> <span class="tfree">'auth_oadv_rest</span><span class="main">,</span> <span class="tfree">'auth_ousr_rest</span><span class="main">)</span> rest_wstate"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ideal_rest</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ideal_rest</span> <span class="main">≡</span> translate_rest einit etran <span class="main">(</span>parallel_rest <span class="free">key_rest</span> <span class="free">auth_rest</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ideal_resource</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ideal_resource</span> <span class="main">≡</span> <span class="main">(</span>sim <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>  <span class="main">⊳</span> <span class="main">(</span>sec.resource ideal_rest<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_resource</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">real_resource</span> <span class="main">≡</span> attach_c1f22_c1f22 <span class="main">(</span>CNV enc_callee <span class="main">()</span><span class="main">)</span> <span class="main">(</span>CNV dec_callee <span class="main">()</span><span class="main">)</span> <span class="main">(</span>key.resource <span class="free">key_rest</span><span class="main">)</span> <span class="main">(</span>auth.resource <span class="free">auth_rest</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Wiring and simplifying the Ideal construction›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ideal_s_core'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">_</span> <span class="main">×</span> <span class="tfree">'msg</span> astate <span class="main">×</span> <span class="main">_</span><span class="main">)</span> <span class="main">×</span> <span class="main">_</span><span class="main">)</span> <span class="main">×</span> estate <span class="main">×</span> <span class="tfree">'msg</span> sec.state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ideal_s_core'</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">,</span> sec.State_Void<span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ideal_s_rest'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">×</span> <span class="tfree">'key_s_rest</span> <span class="main">×</span> <span class="tfree">'auth_s_rest</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ideal_s_rest'</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> rinit <span class="free">key_rest</span><span class="main">,</span> rinit <span class="free">auth_rest</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">ideal_core'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>unit <span class="main">×</span> <span class="main">_</span> <span class="main">×</span> unit<span class="main">)</span> <span class="main">×</span> unit<span class="main">)</span> <span class="main">×</span>  <span class="main">_</span><span class="main">,</span>  <span class="main">_</span><span class="main">,</span> key.iadv <span class="main">+</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> core"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"cpoke <span class="free">ideal_core'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_advusr</span><span class="main">,</span> <span class="bound">s_event</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">event</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="main">(</span><span class="bound">events</span><span class="main">,</span> <span class="bound">s_event'</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span>etran <span class="bound">s_event</span> <span class="bound">event</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">s_core'</span> <span class="main">←</span> foldl_spmf sec.poke <span class="main">(</span>return_spmf <span class="bound">s_core</span><span class="main">)</span> <span class="bound">events</span><span class="main">;</span>
        return_spmf <span class="main">(</span><span class="bound">s_advusr</span><span class="main">,</span> <span class="bound">s_event'</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">ideal_core'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s_adv</span><span class="main">,</span> <span class="bound">s_usr</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">iadv</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="bound">handle_l</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Done <span class="main">(</span>Inl key.Out_Adversary<span class="main">,</span> <span class="bound">s_adv</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">handle_r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">qr</span><span class="main">.</span> map_gpv <span class="main">(</span>map_prod Inr id<span class="main">)</span> id <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> look_callee <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span><span class="main">)</span> <span class="bound">s_adv</span> <span class="bound">qr</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      map_spmf 
        <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">oadv</span><span class="main">,</span> <span class="bound">s_adv'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">oadv</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_adv'</span><span class="main">,</span> <span class="bound">s_usr</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>exec_gpv <span class="main">†</span>sec.iface_adv <span class="main">(</span>case_sum <span class="bound">handle_l</span> <span class="bound">handle_r</span> <span class="bound">iadv</span><span class="main">)</span> <span class="bound">s_core</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">ideal_core'</span> <span class="main">=</span> <span class="main">†</span><span class="main">†</span>sec.iface_usr"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">ideal_rest'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>unit <span class="main">×</span> unit<span class="main">)</span> <span class="main">×</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> rest_scheme"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"rinit <span class="free">ideal_rest'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> rinit <span class="free">key_rest</span><span class="main">,</span> rinit <span class="free">auth_rest</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="free">ideal_rest'</span> <span class="main">=</span> <span class="main">†</span><span class="main">(</span>parallel_eoracle <span class="main">(</span>rfunc_adv <span class="free">key_rest</span><span class="main">)</span> <span class="main">(</span>rfunc_adv <span class="free">auth_rest</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="free">ideal_rest'</span> <span class="main">=</span> <span class="main">†</span><span class="main">(</span>parallel_eoracle <span class="main">(</span>rfunc_usr <span class="free">key_rest</span><span class="main">)</span> <span class="main">(</span>rfunc_usr <span class="free">auth_rest</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The ideal attachment lemma›</span></span>
  
<span class="keyword1" id="One_Time_Pad-attach_ideal"><span class="command">lemma</span></span> attach_ideal<span class="main">:</span> <span class="quoted"><span class="quoted">"ideal_resource <span class="main">=</span> RES <span class="main">(</span>fused_resource.fuse ideal_core' ideal_rest'<span class="main">)</span> <span class="main">(</span>ideal_s_core'<span class="main">,</span> ideal_s_rest'<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword1"><span class="command">have</span></span> fact1<span class="main">:</span> <span class="quoted"><span class="quoted">"ideal_rest' <span class="main">=</span> attach_rest <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">(</span>Pair <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>parallel_rest <span class="free">key_rest</span> <span class="free">auth_rest</span><span class="main">)</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rinit <span class="var">?L</span> <span class="main">=</span> rinit <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="var">?L</span> <span class="main">=</span> rfunc_adv <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> attach_rest_id_oracle_adv parallel_eoracle_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_state_oracle_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="var">?L</span> <span class="main">=</span> rfunc_usr <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> attach_rest_id_oracle_usr parallel_eoracle_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_state_oracle_def<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> fact2<span class="main">:</span> <span class="quoted"><span class="quoted">"ideal_core' <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">handle_l</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">ql</span><span class="main">.</span> Generative_Probabilistic_Value.Done <span class="main">(</span>Inl key.Out_Adversary<span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
     <span class="keyword1">let</span> <span class="bound">handle_r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">qr</span><span class="main">.</span> map_gpv <span class="main">(</span>map_prod Inr id<span class="main">)</span> id <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> look_callee <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span><span class="main">)</span> <span class="bound">s</span> <span class="bound">qr</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
     <span class="keyword1">let</span> <span class="bound">tcore</span> <span class="main">=</span> translate_core etran sec.core <span class="keyword1">in</span>
    attach_core <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> case_sum <span class="main">(</span><span class="bound">handle_l</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="bound">handle_r</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="bound">tcore</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cpoke <span class="var">?L</span> <span class="main">=</span> cpoke <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def map_spmf_conv_bind_spmf<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="var">?L</span> <span class="main">=</span> cfunc_adv <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> attach_core_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="var">?L</span> <span class="main">=</span> cfunc_usr <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Let_def attach_core_id_oracle_usr
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_state_oracle_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ideal_resource_def sec.resource_def sim_def ideal_rest_def ideal_s_core'_def ideal_s_rest'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conv_callee_parallel_id_right<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conv_callee_parallel_id_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ldummy_converter_of_callee<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> fused_resource_move_translate<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">einit</span> <span class="quoted">etran</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> resource_of_oracle_state_iso<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iso_swapar_def split_beta ideal_rest_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> converter_of_callee_id_oracle<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> attach_parallel_fuse'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f_init<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Pair <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fact1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fact2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> Let_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Wiring and simplifying the Real construction›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_s_core'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">×</span> <span class="tfree">'msg</span> key.state <span class="main">×</span> <span class="tfree">'msg</span> auth.state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">real_s_core'</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>key.PState_Store<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_s_rest'</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">real_s_rest'</span> <span class="main">≡</span> ideal_s_rest'"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">real_core'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>unit <span class="main">×</span> <span class="main">_</span><span class="main">)</span> <span class="main">×</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> core"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"cpoke <span class="free">real_core'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_advusr</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">event</span><span class="main">.</span> 
      map_spmf <span class="main">(</span>Pair <span class="bound">s_advusr</span><span class="main">)</span> <span class="main">(</span>parallel_handler key.poke auth.poke <span class="bound">s_core</span> <span class="bound">event</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">real_core'</span> <span class="main">=</span> <span class="main">†</span><span class="main">(</span>key.iface_adv <span class="keyword1">‡<span class="hidden">⇩</span><sub>O</sub></span> auth.iface_adv<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">real_core'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s_adv</span><span class="main">,</span> <span class="bound">s_usr</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">iusr</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="bound">handle_req</span> <span class="main">=</span> lsumr <span class="main">∘</span> map_sum id <span class="main">(</span>rsuml <span class="main">∘</span> map_sum swap_sum id <span class="main">∘</span> lsumr<span class="main">)</span> <span class="main">∘</span> rsuml <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">handle_ret</span> <span class="main">=</span> lsumr <span class="main">∘</span> <span class="main">(</span>map_sum id <span class="main">(</span>rsuml <span class="main">∘</span> <span class="main">(</span>map_sum swap_sum id <span class="main">∘</span> lsumr<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> rsuml<span class="main">)</span> <span class="keyword1">in</span>
      map_spmf 
        <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">ousr</span><span class="main">,</span> <span class="bound">s_usr'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">ousr</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_adv</span><span class="main">,</span> <span class="bound">s_usr'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>exec_gpv 
          <span class="main">(</span>key.iface_usr <span class="keyword1">‡<span class="hidden">⇩</span><sub>O</sub></span> auth.iface_usr<span class="main">)</span>
          <span class="main">(</span>map_gpv' id <span class="bound">handle_req</span>  <span class="bound">handle_ret</span> <span class="main">(</span><span class="main">(</span>enc_callee <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> dec_callee<span class="main">)</span> <span class="bound">s_usr</span> <span class="bound">iusr</span><span class="main">)</span><span class="main">)</span> <span class="bound">s_core</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_rest'</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">real_rest'</span> <span class="main">≡</span> ideal_rest'"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The real attachment lemma›</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="One_Time_Pad-WT_callee_real1"><span class="command">lemma</span></span> WT_callee_real1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢c</span> 
  <span class="main">(</span>key.fuse <span class="free">key_rest</span> <span class="keyword1">‡<span class="hidden">⇩</span><sub>O</sub></span> auth.fuse <span class="free">auth_rest</span><span class="main">)</span> <span class="free">s</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">call</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> y<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span></span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fused_resource.fuse.simps<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="One_Time_Pad-WT_callee_real2"><span class="command">lemma</span></span> WT_callee_real2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊢c</span>
  fused_resource.fuse <span class="main">(</span>parallel_core key.core auth.core<span class="main">)</span> <span class="main">(</span>parallel_rest <span class="free">key_rest</span> <span class="free">auth_rest</span><span class="main">)</span> <span class="free">s</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">call</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> y<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span></span></span></span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span>5<span class="main"><span class="improper">]</span></span> z<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span>6<span class="main"><span class="improper">]</span></span> z<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>5<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper">z</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>7<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper">z</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fused_resource.fuse.simps<span class="main">)</span>


<span class="keyword1" id="One_Time_Pad-attach_real"><span class="command">lemma</span></span> attach_real<span class="main">:</span> <span class="quoted"><span class="quoted">"real_resource <span class="main">=</span> RES <span class="main">(</span>fused_resource.fuse real_core' real_rest'<span class="main">)</span> <span class="main">(</span>real_s_core'<span class="main">,</span> real_s_rest'<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword1"><span class="command">have</span></span> fact1<span class="main">:</span> <span class="quoted"><span class="quoted">"real_core' <span class="main">=</span> attach_core <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">(</span>attach_wiring_right parallel_wiring<span class="hidden">⇩</span><sub>w</sub> <span class="main">(</span>enc_callee <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> dec_callee<span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>parallel_core key.core auth.core<span class="main">)</span> "</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cpoke <span class="var">?L</span> <span class="main">=</span> cpoke <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="var">?L</span> <span class="main">=</span> cfunc_adv <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> attach_core_id_oracle_adv
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_state_oracle_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="var">?L</span> <span class="main">=</span> cfunc_usr <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> parallel_wiring<span class="hidden">⇩</span><sub>w</sub>_def swap_lassocr<span class="hidden">⇩</span><sub>w</sub>_def swap<span class="hidden">⇩</span><sub>w</sub>_def lassocr<span class="hidden">⇩</span><sub>w</sub>_def rassocl<span class="hidden">⇩</span><sub>w</sub>_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_wiring_right_simps parallel2_wiring_simps comp_wiring_simps<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> fact2<span class="main">:</span> <span class="quoted"><span class="quoted">"real_rest' <span class="main">=</span> attach_rest <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">(</span>Pair <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>parallel_rest <span class="free">key_rest</span> <span class="free">auth_rest</span><span class="main">)</span> "</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rinit <span class="var">?L</span> <span class="main">=</span> rinit <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> real_rest'_def ideal_rest'_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="var">?L</span> <span class="main">=</span> rfunc_adv <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> real_rest'_def ideal_rest'_def attach_rest_id_oracle_adv 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_state_oracle_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="var">?L</span> <span class="main">=</span> rfunc_usr <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> real_rest'_def ideal_rest'_def attach_rest_id_oracle_usr
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_state_oracle_def<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_resource_def attach_c1f22_c1f22_def wiring_c1r22_c1r22_def key.resource_def auth.resource_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> resource_of_parallel_oracle<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> attach_compose<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> attach_wiring_resource_of_oracle<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wiring_intro</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_callee_real1<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> parallel_oracle_fuse<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> resource_of_oracle_state_iso<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_state_iso_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> conv_callee_parallel<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> eq_resource_on_UNIV_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_attach_on'<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_callee_real2<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> parallel_converter2_eq_ℐ_cong<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> parallel_converter2_eq_ℐ_cong<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> comp_converter_of_callee_wiring<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wiring_intro</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> conv_callee_parallel<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐ'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_gpv_ℐ_mono<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_gpv_full<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℐ_full_le_plus_ℐ<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enc_callee_def stateless_callee_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sec.iusr_alice.splits key.ousr_alice.splits<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐ'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_gpv_ℐ_mono<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_gpv_full<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℐ_full_le_plus_ℐ<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enc_callee_def stateless_callee_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sec.iusr_alice.splits key.ousr_alice.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> id_converter_eq_self<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> eq_resource_on_UNIV_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> converter_of_callee_id_oracle<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> attach_parallel_fuse'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fact1 fact2 real_s_core'_def real_s_rest'_def ideal_s_rest'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proving the trace-equivalence of simplified Ideal and Real constructions›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proving the trace-equivalence of cores›</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">a_I</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a_R</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">asm_act</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">flg</span> <span class="bound">pset_sec</span> <span class="bound">pset_key</span> <span class="bound">pset_auth</span> <span class="bound">pset_union</span><span class="main">.</span>
     <span class="bound">pset_union</span> <span class="main">=</span> <span class="bound">pset_key</span> <span class="main">&lt;+&gt;</span> <span class="bound">pset_auth</span> <span class="main">∧</span>
     <span class="main">(</span><span class="bound">flg</span> <span class="main">⟶</span> <span class="bound">pset_sec</span> <span class="main">=</span> sec_party_of_key_party <span class="main">`</span> <span class="bound">pset_key</span> <span class="main">∩</span> <span class="bound">pset_auth</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">_</span> <span class="main">×</span> <span class="tfree">'msg</span> option <span class="main">×</span> <span class="main">_</span><span class="main">)</span> <span class="main">×</span> <span class="main">_</span><span class="main">)</span> <span class="main">×</span> estate <span class="main">×</span> <span class="tfree">'msg</span> sec.state<span class="main">)</span> spmf 
  <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span> <span class="main">×</span> <span class="tfree">'msg</span> key.state <span class="main">×</span> <span class="tfree">'msg</span> auth.state<span class="main">)</span> spmf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
<span class="comment1">― ‹(Auth =a)@(Key =0)›</span>
    s_0_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>a_I <span class="main">(</span>None<span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span><span class="main">)</span><span class="main">,</span> sec.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>return_spmf <span class="main">(</span>a_R <span class="main">(</span><span class="main">(</span>key.PState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"asm_act False <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="comment1">― ‹(Auth =a)@(Key =1)›</span>
  <span class="main">|</span> s_0_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>a_I <span class="main">(</span>None<span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span><span class="main">)</span><span class="main">,</span> sec.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">key</span><span class="main">.</span> a_R <span class="main">(</span><span class="main">(</span>key.State_Store <span class="bound">key</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"asm_act True <span class="free"><span class="bound"><span class="entity">s_act</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span>"</span></span>
<span class="comment1">― ‹../(Auth =a)@(Key =1) \# wl›</span>
  <span class="main">|</span> s_1_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>a_I <span class="main">(</span>None<span class="main">,</span> <span class="main">(</span>True <span class="main">,</span><span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span><span class="main">)</span><span class="main">,</span> sec.State_Store <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">key</span><span class="main">.</span> a_R <span class="main">(</span><span class="main">(</span>key.State_Store <span class="bound">key</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">(</span><span class="bound">key</span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"asm_act True <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">∈</span> carrier <span class="free">ℒ</span>"</span></span>
  <span class="main">|</span> s_2_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>a_I <span class="main">(</span>None<span class="main">,</span> <span class="main">(</span>True <span class="main">,</span><span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span><span class="main">)</span><span class="main">,</span> sec.State_Collect <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">key</span><span class="main">.</span> a_R <span class="main">(</span><span class="main">(</span>key.State_Store <span class="bound">key</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">(</span><span class="bound">key</span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"asm_act True <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">∈</span> carrier <span class="free">ℒ</span>"</span></span>
  <span class="main">|</span> s_3_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>a_I <span class="main">(</span>None<span class="main">,</span> <span class="main">(</span>True <span class="main">,</span><span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span><span class="main">)</span><span class="main">,</span> sec.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">key</span><span class="main">.</span> a_R <span class="main">(</span><span class="main">(</span>key.State_Store <span class="bound">key</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"asm_act True <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span> <span class="main">=</span> <span class="main">{</span>key.Alice<span class="main">,</span> key.Bob<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span> <span class="main">=</span> <span class="main">{</span>auth.Alice<span class="main">,</span> auth.Bob<span class="main">}</span>"</span></span>
<span class="comment1">― ‹../(Auth =a)@(Key =1) \# look›</span>
  <span class="main">|</span> s_1'_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>a_I <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True <span class="main">,</span><span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span><span class="main">)</span><span class="main">,</span> sec.State_Store <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span>a_R <span class="main">(</span><span class="main">(</span>key.State_Store <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">(</span><span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"asm_act True <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">∈</span> carrier <span class="free">ℒ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">∈</span> carrier <span class="free">ℒ</span>"</span></span>
  <span class="main">|</span> s_2'_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>a_I <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True <span class="main">,</span><span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span><span class="main">)</span><span class="main">,</span> sec.State_Collect <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span>a_R <span class="main">(</span><span class="main">(</span>key.State_Store <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">(</span><span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"asm_act True <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">∈</span> carrier <span class="free">ℒ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">∈</span> carrier <span class="free">ℒ</span>"</span></span>
  <span class="main">|</span> s_3'_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>a_I <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True <span class="main">,</span><span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span><span class="main">)</span><span class="main">,</span> sec.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span>a_R <span class="main">(</span><span class="main">(</span>key.State_Store <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"asm_act True <span class="free"><span class="bound"><span class="entity">s_act_s</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span> <span class="free"><span class="bound"><span class="entity">s_act_ka</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s_act_k</span></span></span> <span class="main">=</span> <span class="main">{</span>key.Alice<span class="main">,</span> key.Bob<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s_act_a</span></span></span> <span class="main">=</span> <span class="main">{</span>auth.Alice<span class="main">,</span> auth.Bob<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">∈</span> carrier <span class="free">ℒ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">∈</span> carrier <span class="free">ℒ</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="One_Time_Pad-trace_eq_core"><span class="command">lemma</span></span> trace_eq_core<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_core_eq ideal_core' real_core' 
  UNIV <span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> <span class="main">(</span>auth.Inp_Fedit <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>sec.Inp_Send <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> 
  <span class="main">(</span>return_spmf ideal_s_core'<span class="main">)</span> <span class="main">(</span>return_spmf real_s_core'<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword1"><span class="command">have</span></span> inj_xor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="skolem">msg</span> <span class="main">∈</span> carrier <span class="free">ℒ</span> <span class="main">;</span> <span class="skolem">x</span> <span class="main">∈</span> carrier <span class="free">ℒ</span><span class="main">;</span> <span class="skolem">y</span> <span class="main">∈</span> carrier <span class="free">ℒ</span><span class="main">;</span> <span class="skolem">x</span> <span class="main">⊕</span> <span class="skolem">msg</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⊕</span> <span class="skolem">msg</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">msg</span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> local.xor_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> local.xor_left_inverse<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> enc_callee_def dec_callee_def look_callee_def nempty_carrier finite_carrier
    exec_gpv_bind spmf.map_comp map_bind_spmf bind_map_spmf bind_spmf_const o_def Let_def
      
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_core_eq_simI_upto<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">S</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> Init_OK 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ideal_s_core'_def real_s_core'_def S.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> POut_OK <span class="keyword2"><span class="keyword">for</span></span> s_i s_r query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_key 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_key</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_shell <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> key.party.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> e_kernel <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_auth
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_auth</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_shell
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>auth.party.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> PState_OK <span class="keyword2"><span class="keyword">for</span></span> s_i s_r query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_key
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_key</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_shell <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S.intros<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> key.party.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> e_kernel <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sec_party_of_key_party_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S.intros<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> key.party.splits<span class="main">)</span>    
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_auth
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_auth</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_shell <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S.intros<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>auth.party.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> AOut_OK <span class="keyword2"><span class="keyword">for</span></span> s_i s_r query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_key <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main">)</span> <span class="operator">simp_all</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_auth</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_oracle_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth_lfe
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_auth_lfe</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth_look
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s_act_s</span> <span class="skolem">s_act_k</span> <span class="skolem">s_act_a</span> <span class="skolem">s_act_ka</span> <span class="skolem">msg</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] s_1_1<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exec_gpv_extend_state_oracle exec_gpv_map_gpv_id exec_gpv_plus_oracle_right exec_gpv_plus_oracle_left<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> one_time_pad<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">msg</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xor_comm<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xor_comm<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth_fedit  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_oracle_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>auth.iadv_fedit.split<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> AState_OK <span class="keyword2"><span class="keyword">for</span></span> s_i s_r query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_key <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S.intros<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_auth</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_oracle_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth_lfe
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_auth_lfe</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth_look
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s_act_s</span> <span class="skolem">s_act_k</span> <span class="skolem">s_act_a</span> <span class="skolem">s_act_ka</span> <span class="skolem">msg</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] s_1_1<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exec_gpv_extend_state_oracle exec_gpv_map_gpv_id exec_gpv_plus_oracle_right exec_gpv_plus_oracle_left<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_spmf_of_set inj_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_xor<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inj_xor<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>             
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S.simps inj_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_xor<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S.intros<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth_fedit <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> id_oracle_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S.intros<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> UOut_OK <span class="keyword2"><span class="keyword">for</span></span> s_i s_r query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_alice
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s_act_s</span> <span class="skolem">s_act_k</span> <span class="skolem">s_act_a</span> <span class="skolem">s_act_ka</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] s_0_1<span class="antiquote">}</span></span>›</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="skolem">s_act_a</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∈</span> <span class="skolem">s_act_k</span>"</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def split_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> auth.iusr_alice.split<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> auth.iusr_alice.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_bob
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s_act_s</span> <span class="skolem">s_act_k</span> <span class="skolem">s_act_a</span> <span class="skolem">s_act_ka</span> <span class="skolem">msg</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] s_2_1<span class="antiquote">}</span></span>›</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sec.Bob <span class="main">∈</span> <span class="skolem">s_act_s</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rel_spmf_bindI2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sec.Bob <span class="main">∈</span> <span class="skolem">s_act_a</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> UState_OK <span class="keyword2"><span class="keyword">for</span></span> s_i s_r query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_alice
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s_act</span> <span class="skolem">s_act_k</span> <span class="skolem">s_act_a</span> <span class="skolem">s_act_ka</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] s_0_1<span class="antiquote">}</span></span>›</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="skolem">s_act_a</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∈</span> <span class="skolem">s_act_k</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> stateless_callee_def split_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> auth.iusr_alice.split if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl.base<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> S.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> stateless_callee_def split_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> auth.iusr_alice.split<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> auth.iusr_alice.split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_bob
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s_act_s</span> <span class="skolem">s_act_k</span> <span class="skolem">s_act_a</span> <span class="skolem">s_act_ka</span> <span class="skolem">msg</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] s_2_1<span class="antiquote">}</span></span>›</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sec.Bob <span class="main">∈</span> <span class="skolem">s_act_s</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_spmf_of_set_inj_on<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_spmf_of_set_inj_on<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> trace_eq_simcl.base<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> S.intros<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sec.party.splits <span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">s_act_s</span> <span class="skolem">s_act_k</span> <span class="skolem">s_act_a</span> <span class="skolem">s_act_ka</span> <span class="skolem">msg</span> <span class="skolem">key</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] s_2'_1<span class="antiquote">}</span></span>›</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sec.Bob <span class="main">∈</span> <span class="skolem">s_act_s</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> S.intros<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> auth.iusr_alice.split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proving the trace equivalence of fused cores and rests›</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ℐ_adv_core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>key.iadv <span class="main">+</span> <span class="tfree">'msg</span> auth.iadv<span class="main">,</span> key.oadv <span class="main">+</span> <span class="tfree">'msg</span> auth.oadv<span class="main">)</span> ℐ"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_adv_core</span> <span class="main">≡</span> ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>sec.Inp_Fedit <span class="main">`</span> <span class="main">(</span>carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ℐ_usr_core</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msg</span> sec.iusr<span class="main">,</span> <span class="tfree">'msg</span> sec.ousr<span class="main">)</span> ℐ"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_usr_core</span> <span class="main">≡</span> ℐ_uniform <span class="main">(</span>sec.Inp_Send <span class="main">`</span> <span class="main">(</span>carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>sec.Out_Recv <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">invar_ideal'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">_</span> <span class="main">×</span> <span class="tfree">'msg</span> astate <span class="main">×</span> <span class="main">_</span><span class="main">)</span> <span class="main">×</span> <span class="main">_</span><span class="main">)</span> <span class="main">×</span> estate <span class="main">×</span> <span class="tfree">'msg</span> sec.state <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">invar_ideal'</span> <span class="main">=</span> pred_prod <span class="main">(</span>pred_prod <span class="main">(</span>pred_prod <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span>pred_prod <span class="main">(</span>pred_option <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span><span class="main">)</span> <span class="main">(</span>pred_prod <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span>pred_prod <span class="main">(</span>sec.pred_s_kernel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">invar_real'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'msg</span> key.s_kernel <span class="main">×</span> <span class="main">_</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'msg</span> sec.s_kernel <span class="main">×</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">invar_real'</span> <span class="main">=</span> pred_prod <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span>pred_prod <span class="main">(</span>pred_prod <span class="main">(</span>key.pred_s_kernel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span><span class="main">)</span> <span class="main">(</span>pred_prod <span class="main">(</span>sec.pred_s_kernel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="One_Time_Pad-invar_ideal_s_core'"><span class="command">lemma</span></span> invar_ideal_s_core' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"invar_ideal' ideal_s_core'"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_ideal'_def ideal_s_core'_def<span class="main">)</span>

<span class="keyword1" id="One_Time_Pad-invar_real_s_core'"><span class="command">lemma</span></span> invar_real_s_core' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"invar_real' real_s_core'"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_real'_def real_s_core'_def<span class="main">)</span>

<span class="keyword1" id="One_Time_Pad-WT_ideal_core'"><span class="command">lemma</span></span> WT_ideal_core' <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_core ℐ_adv_core ℐ_usr_core invar_ideal' ideal_core'"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_core.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span>                
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits option.splits if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_adv_core_def ℐ_usr_core_def exec_gpv_map_gpv_id exec_gpv_extend_state_oracle exec_gpv_plus_oracle_left exec_gpv_plus_oracle_right invar_ideal'_def sec.in_set_spmf_iface_drop sec.in_set_spmf_iface_look sec.in_set_spmf_iface_fedit sec.in_set_spmf_iface_alice sec.in_set_spmf_iface_bob id_oracle_def look_callee_def exec_gpv_bind set_spmf_of_set sec.poke_alt_def foldl_spmf_pair_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="One_Time_Pad-WT_ideal_rest'"><span class="command">lemma</span></span> WT_ideal_rest' <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_restk</span> <span class="free">ℐ_usr_restk</span> <span class="free">I_key_rest</span> <span class="free">key_rest</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_resta</span> <span class="free">ℐ_usr_resta</span> <span class="free">I_auth_rest</span> <span class="free">auth_rest</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="main">(</span><span class="free">ℐ_adv_restk</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_resta</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_usr_restk</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_resta</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span><span class="main">.</span> pred_prod <span class="free">I_key_rest</span> <span class="free">I_auth_rest</span> <span class="bound">s_rest</span><span class="main">)</span> ideal_rest'"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_rest.intros<span class="main">)</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fused_resource.fuse.simps parallel_eoracle_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_restD_rfunc_adv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> WT_restD_rfunc_adv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> WT_restD_rfunc_usr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> WT_restD_rfunc_usr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> WT_restD_rinit<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1" id="One_Time_Pad-WT_real_core'"><span class="command">lemma</span></span> WT_real_core' <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_core ℐ_adv_core ℐ_usr_core invar_real' real_core'"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_core.intros<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_adv_core_def ℐ_usr_core_def enc_callee_def dec_callee_def
        stateless_callee_def Let_def exec_gpv_extend_state_oracle exec_gpv_map_gpv' exec_gpv_plus_oracle_left exec_gpv_plus_oracle_right
        invar_real'_def in_set_spmf_parallel_handler key.in_set_spmf_poke sec.poke_alt_def auth.in_set_spmf_iface_look auth.in_set_spmf_iface_fedit
        sec.in_set_spmf_iface_alice sec.in_set_spmf_iface_bob
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> key.ousr_alice.splits key.ousr_bob.splits auth.ousr_alice.splits auth.ousr_bob.splits sum.splits if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="One_Time_Pad-trace_eq_sec"><span class="command">lemma</span></span> trace_eq_sec<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ℐ_adv_restk</span> <span class="free">ℐ_adv_resta</span> <span class="free">ℐ_usr_restk</span> <span class="free">ℐ_usr_resta</span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">outs_adv</span> <span class="main">≡</span> <span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> sec.Inp_Fedit <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> outs_ℐ <span class="main">(</span><span class="free">ℐ_adv_restk</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_resta</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">outs_usr</span> <span class="main">≡</span> <span class="main">(</span>sec.Inp_Send <span class="main">`</span> carrier <span class="free">ℒ</span> <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> outs_ℐ <span class="main">(</span><span class="free">ℐ_usr_restk</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_resta</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT_key <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_restk</span> <span class="free">ℐ_usr_restk</span> <span class="free">I_key_rest</span> <span class="free">key_rest</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> WT_auth <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_resta</span> <span class="free">ℐ_usr_resta</span> <span class="free">I_auth_rest</span> <span class="free">auth_rest</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">outs_adv</span> <span class="main">&lt;+&gt;</span> <span class="free">outs_usr</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> fused_resource.fuse ideal_core' ideal_rest' <span class="main">(</span><span class="main">(</span>ideal_s_core'<span class="main">,</span> ideal_s_rest'<span class="main">)</span><span class="main">)</span> <span class="main">≈</span> 
      fused_resource.fuse real_core' real_rest' <span class="main">(</span><span class="main">(</span>real_s_core'<span class="main">,</span> real_s_rest'<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">eℐ_adv_rest</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span> <span class="main">×</span> <span class="main">(</span>key.event <span class="main">+</span> auth.event<span class="main">)</span> list<span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">eℐ_adv_rest</span> <span class="main">≡</span> map_ℐ id <span class="main">(</span>case_sum <span class="main">(</span>map_prod Inl <span class="main">(</span>map Inl<span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_prod Inr <span class="main">(</span>map Inr<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eℐ <span class="free">ℐ_adv_restk</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> eℐ <span class="free">ℐ_adv_resta</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">eℐ_usr_rest</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span> <span class="main">×</span> <span class="main">(</span>key.event <span class="main">+</span> auth.event<span class="main">)</span> list<span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">eℐ_usr_rest</span> <span class="main">≡</span> map_ℐ id <span class="main">(</span>case_sum <span class="main">(</span>map_prod Inl <span class="main">(</span>map Inl<span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_prod Inr <span class="main">(</span>map Inr<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eℐ <span class="free">ℐ_usr_restk</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> eℐ <span class="free">ℐ_usr_resta</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">note</span></span> I_defs <span class="main">=</span> ℐ_adv_core_def ℐ_usr_core_def
  <span class="keyword1"><span class="command">note</span></span> eI_defs <span class="main">=</span> eℐ_adv_rest_def eℐ_usr_rest_def 

  <span class="keyword1"><span class="command">have</span></span> fact1<span class="main">[</span><span class="operator">unfolded</span> outs_plus_ℐ<span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"trace_rest_eq ideal_rest' ideal_rest' <span class="main">(</span>outs_ℐ <span class="main">(</span><span class="free">ℐ_adv_restk</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_resta</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>outs_ℐ <span class="main">(</span><span class="free">ℐ_usr_restk</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_resta</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_rest'_into_trace_rest_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> eq_onp_def<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> <span class="dynamic"><span class="dynamic">relator_eq</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_rest'_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> HOL.refl<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted">ideal_rest'</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">folded</span> <span class="dynamic"><span class="dynamic">relator_eq</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> fact2 <span class="main">[</span><span class="operator">unfolded</span> eI_defs<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>callee_of_rest ideal_rest'<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span><span class="main">.</span> pred_prod <span class="free">I_key_rest</span> <span class="free">I_auth_rest</span> <span class="bound">s_rest</span><span class="main">)</span> <span class="main">(</span><span class="skolem">eℐ_adv_rest</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="skolem">eℐ_usr_rest</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_oracle.cases<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_eoracle_def eI_defs <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_restD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_key<span class="main"><span class="main">]</span></span> WT_restD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_calleeI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_eoracle_def eI_defs image_image <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_restD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_key<span class="main"><span class="main">]</span></span> WT_restD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> fact3<span class="main">[</span><span class="operator">unfolded</span> I_defs<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>callee_of_core ideal_core'<span class="main">)</span> invar_ideal' <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_adv_core <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_usr_core<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> fact4<span class="main">[</span><span class="operator">unfolded</span> I_defs<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>callee_of_core real_core'<span class="main">)</span> invar_real' <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_adv_core <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_usr_core<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">note</span></span> nempty_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> WT_key<span class="main">[</span><span class="operator">THEN</span> WT_restD_rinit<span class="main">]</span> WT_auth<span class="main">[</span><span class="operator">THEN</span> WT_restD_rinit<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_rest'_def real_s_rest'_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span> 2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">thm</span></span> fuse_trace_eq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐE<span class="main"><span class="main">=</span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ℐCA<span class="main"><span class="main">=</span></span><span class="quoted">ℐ_adv_core</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ℐCU<span class="main"><span class="main">=</span></span><span class="quoted">ℐ_usr_core</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ℐRA<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">eℐ_adv_rest</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ℐRU<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">eℐ_usr_rest</span></span><span class="main">,</span><span class="operator">unfolded</span> eI_defs ℐ_adv_core_def ℐ_usr_core_def<span class="main">,</span><span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fuse_trace_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐE<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐCA<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_adv_core</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐCU<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_usr_core</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐRA<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">eℐ_adv_rest</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐRU<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">eℐ_usr_rest</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?IR1.0</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span><span class="main">.</span> pred_prod <span class="free">I_key_rest</span> <span class="free">I_auth_rest</span> <span class="bound">s_rest</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?IR2.0</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span><span class="main">.</span> pred_prod <span class="free">I_key_rest</span> <span class="free">I_auth_rest</span> <span class="bound">s_rest</span>"</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?IC1.0</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">invar_ideal'</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?IC2.0</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">invar_real'</span><span class="main"><span class="main">,</span></span>
      <span class="operator">unfolded</span> eI_defs ℐ_adv_core_def ℐ_usr_core_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_eq_core fact1 fact2 fact3 fact4 ideal_s_rest'_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simplifying the final resource by moving the interfaces from core to rest›</span></span>


<span class="keyword1" id="One_Time_Pad-connect"><span class="command">lemma</span></span> connect<span class="main">[</span><span class="operator">unfolded</span> ℐ_adv_core_def ℐ_usr_core_def<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ℐ_adv_restk</span> <span class="free">ℐ_adv_resta</span> <span class="free">ℐ_usr_restk</span> <span class="free">ℐ_usr_resta</span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="main">≡</span> <span class="main">(</span>ℐ_adv_core <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv_restk</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_resta</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_usr_core <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_usr_restk</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_resta</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_restk</span> <span class="free">ℐ_usr_restk</span> <span class="free">I_key_rest</span> <span class="free">key_rest</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_resta</span> <span class="free">ℐ_usr_resta</span> <span class="free">I_auth_rest</span> <span class="free">auth_rest</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">D</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"connect <span class="free">D</span> <span class="main">(</span>obsf_resource ideal_resource<span class="main">)</span> <span class="main">=</span> connect <span class="free">D</span> <span class="main">(</span>obsf_resource real_resource<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> I_defs <span class="main">=</span> ℐ_adv_core_def ℐ_usr_core_def

  <span class="keyword1"><span class="command">have</span></span> fact1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> RES <span class="main">(</span>fused_resource.fuse ideal_core' ideal_rest'<span class="main">)</span> <span class="skolem">s</span> <span class="main">√</span>"</span></span> 
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pred_prod <span class="free">I_key_rest</span> <span class="free">I_auth_rest</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"invar_ideal' <span class="main">(</span>fst <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"pred_prod invar_ideal' <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span><span class="main">.</span> pred_prod <span class="free">I_key_rest</span> <span class="free">I_auth_rest</span> <span class="bound">s_rest</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> fused_resource.callee_invariant_on_fuse<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> fact2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> RES <span class="main">(</span>fused_resource.fuse real_core' real_rest'<span class="main">)</span> <span class="skolem">s</span> <span class="main">√</span>"</span></span> 
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pred_prod <span class="free">I_key_rest</span> <span class="free">I_auth_rest</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"invar_real' <span class="main">(</span>fst <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_rest'_def assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"pred_prod invar_real' <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s_rest</span><span class="main">)</span><span class="main">.</span> pred_prod <span class="free">I_key_rest</span> <span class="free">I_auth_rest</span> <span class="bound">s_rest</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> fused_resource.callee_invariant_on_fuse<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> attach_ideal attach_real
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> connect_cong_trace<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"exception_ℐ <span class="free">ℐ</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_eq_obsf_resourceI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> trace_eq'_resource_of_oracle<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_eq_sec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> WT_gpv_outs_gpv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I_defs assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nempty_carrier<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> WT_restD_rinit<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> WT_obsf_resource<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> fact1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ideal_s_rest'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> WT_restD_rinit<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> WT_obsf_resource<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> fact2<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_s_rest'_def ideal_s_rest'_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Concrete security›</span></span>

<span class="keyword1"><span class="command">context</span></span> one_time_pad <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="One_Time_Pad-WT_enc_callee"><span class="command">lemma</span></span> WT_enc_callee <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ℐ_uniform <span class="main">(</span>sec.Inp_Send <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> UNIV<span class="main">,</span> ℐ_uniform UNIV <span class="main">(</span>key.Out_Alice <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span>  ℐ_uniform <span class="main">(</span>sec.Inp_Send <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> UNIV <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CNV enc_callee <span class="main">()</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enc_callee_def stateless_callee_def image_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> key.ousr_alice.split<span class="main">)</span>

<span class="keyword1" id="One_Time_Pad-WT_dec_callee"><span class="command">lemma</span></span> WT_dec_callee <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ℐ_uniform UNIV <span class="main">(</span>sec.Out_Recv <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">,</span> ℐ_uniform UNIV <span class="main">(</span>key.Out_Bob <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>sec.Out_Recv <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CNV dec_callee <span class="main">()</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dec_callee_def stateless_callee_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sec.ousr_bob.splits<span class="main">)</span>

<span class="keyword1" id="One_Time_Pad-pfinite_enc_callee"><span class="command">lemma</span></span> pfinite_enc_callee <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span> 
   <span class="quoted"><span class="quoted">"pfinite_converter <span class="main">(</span>ℐ_uniform <span class="main">(</span>sec.Inp_Send <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> UNIV<span class="main">)</span> <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>key.Out_Alice <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>sec.Inp_Send <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> UNIV<span class="main">)</span> <span class="main">(</span>CNV enc_callee <span class="main">()</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> raw_converter_invariant.pfinite_converter_of_callee<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enc_callee_def stateless_callee_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enc_callee_def stateless_callee_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="One_Time_Pad-pfinite_dec_callee"><span class="command">lemma</span></span> pfinite_dec_callee <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pfinite_converter <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>sec.Out_Recv <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>key.Out_Bob <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>sec.Out_Recv <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CNV dec_callee <span class="main">()</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> raw_converter_invariant.pfinite_converter_of_callee<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dec_callee_def stateless_callee_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dec_callee_def stateless_callee_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">key_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key_s_rest</span><span class="main">,</span> key.event<span class="main">,</span> <span class="tfree">'key_iadv_rest</span><span class="main">,</span> <span class="tfree">'key_iusr_rest</span><span class="main">,</span> <span class="tfree">'key_oadv_rest</span><span class="main">,</span> <span class="tfree">'key_ousr_rest</span><span class="main">)</span> rest_wstate"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">auth_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'auth_s_rest</span><span class="main">,</span> auth.event<span class="main">,</span> <span class="tfree">'auth_iadv_rest</span><span class="main">,</span> <span class="tfree">'auth_iusr_rest</span><span class="main">,</span> <span class="tfree">'auth_oadv_rest</span><span class="main">,</span> <span class="tfree">'auth_ousr_rest</span><span class="main">)</span> rest_wstate"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ℐ_adv_restk</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_adv_resta</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_usr_restk</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_usr_resta</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">I_key_rest</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">I_auth_rest</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    WT_key_rest <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_restk</span> <span class="free">ℐ_usr_restk</span> <span class="free">I_key_rest</span> <span class="free">key_rest</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    WT_auth_rest <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_resta</span> <span class="free">ℐ_usr_resta</span> <span class="free">I_auth_rest</span> <span class="free">auth_rest</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> secure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>sec.Inp_Fedit <span class="main">`</span> <span class="main">(</span>carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv_restk</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_resta</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common_core</span> <span class="main">≡</span> ℐ_uniform <span class="main">(</span>sec.Inp_Send <span class="main">`</span> <span class="main">(</span>carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>sec.Out_Recv <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common_rest</span> <span class="main">≡</span> <span class="free">ℐ_usr_restk</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_resta</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="main">≡</span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>sec.Inp_Fedit <span class="main">`</span> <span class="main">(</span>carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv_restk</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_resta</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span>real_resource <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="free">key_rest</span> <span class="free">auth_rest</span><span class="main">)</span> <span class="main">(</span>sec.resource <span class="main">(</span>ideal_rest <span class="free">key_rest</span> <span class="free">auth_rest</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sim <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="main">(</span><span class="free">ℐ_common_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common_rest</span><span class="main">)</span> <span class="free">𝒜</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ_common</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common_core</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common_rest</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_common</span> <span class="keyword1">⊢res</span> real_resource <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="free">key_rest</span> <span class="free">auth_rest</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ℐ_real_def ℐ_common_core_def ℐ_common_rest_def real_resource_def attach_c1f22_c1f22_def wiring_c1r22_c1r22_def fused_wiring_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_common</span> <span class="keyword1">⊢res</span> sec.resource <span class="main">(</span>ideal_rest <span class="free">key_rest</span> <span class="free">auth_rest</span><span class="main">)</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ℐ_common_core_def ℐ_common_rest_def ℐ_ideal_def ideal_rest_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> sim <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">√</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> ℐ_real_def ℐ_ideal_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sim_def Let_def look_callee_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> conv_callee_parallel_id_right<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> conv_callee_parallel_id_left<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ldummy_converter_of_callee<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_oracle_def map_gpv_conv_bind<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_lift_spmf
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> auth.oadv_look.split option.split <span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="main">(</span>sim <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ℐ_real_def ℐ_ideal_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> sim_def Let_def look_callee_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> conv_callee_parallel_id_right<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> conv_callee_parallel_id_left<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ldummy_converter_of_callee<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> raw_converter_invariant.pfinite_converter_of_callee<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split sec.oadv_look.split option.split 
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_gpv_map id_oracle_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> WT_gpv_right_gpv WT_gpv_left_gpv<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits sec.oadv_look.splits option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">assume</span></span> WT <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_common</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"advantage <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="main">(</span>sim <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> sec.resource <span class="main">(</span>ideal_rest <span class="free">key_rest</span> <span class="free">auth_rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>obsf_resource <span class="main">(</span>real_resource <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="free">key_rest</span> <span class="free">auth_rest</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> connect<span class="main">[</span><span class="operator">OF</span> WT_key_rest<span class="main">,</span> <span class="operator">OF</span> WT_auth_rest<span class="main">,</span> <span class="operator">OF</span> WT<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span> 2<span class="main"><span class="main"><span class="main">,</span></span></span> 3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> advantage_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ideal_resource_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Asymptotic security›</span></span>

<span class="keyword1"><span class="command">locale</span></span> one_time_pad' <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ℒ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'msg</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> boolean_algebra_scheme"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> one_time_pad <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> one_time_pad <span class="main">(</span><span class="free">ℒ</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> one_time_pad <span class="quoted"><span class="quoted">"<span class="free">ℒ</span> <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">η</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_resource'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">real_resource'</span> <span class="free"><span class="bound"><span class="entity">rest1</span></span></span> <span class="free"><span class="bound"><span class="entity">rest2</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">=</span> real_resource <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rest1</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rest2</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ideal_resource'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ideal_resource'</span> <span class="free"><span class="bound"><span class="entity">rest1</span></span></span> <span class="free"><span class="bound"><span class="entity">rest2</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">=</span> sec.resource <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">(</span>ideal_rest <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rest1</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rest2</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sim'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sim'</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">=</span> <span class="main">(</span>sim <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">key_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'key_s_rest</span><span class="main">,</span> key.event<span class="main">,</span> <span class="tfree">'key_iadv_rest</span><span class="main">,</span> <span class="tfree">'key_iusr_rest</span><span class="main">,</span> <span class="tfree">'key_oadv_rest</span><span class="main">,</span> <span class="tfree">'key_ousr_rest</span><span class="main">)</span> rest_wstate"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">auth_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'auth_s_rest</span><span class="main">,</span> auth.event<span class="main">,</span> <span class="tfree">'auth_iadv_rest</span><span class="main">,</span> <span class="tfree">'auth_iusr_rest</span><span class="main">,</span> <span class="tfree">'auth_oadv_rest</span><span class="main">,</span> <span class="tfree">'auth_ousr_rest</span><span class="main">)</span> rest_wstate"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ℐ_adv_restk</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_adv_resta</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_usr_restk</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_usr_resta</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">I_key_rest</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">I_auth_rest</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    WT_key_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> WT_rest <span class="main">(</span><span class="free">ℐ_adv_restk</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_usr_restk</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">I_key_rest</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">key_rest</span> <span class="bound">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    WT_auth_rest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> WT_rest <span class="main">(</span><span class="free">ℐ_adv_resta</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_usr_resta</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">I_auth_rest</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">auth_rest</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> secure'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>sec.Inp_Fedit <span class="main">`</span> <span class="main">(</span>carrier <span class="main">(</span><span class="free">ℒ</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv_restk</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_resta</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>ℐ_uniform <span class="main">(</span>sec.Inp_Send <span class="main">`</span> <span class="main">(</span>carrier <span class="main">(</span><span class="free">ℒ</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>sec.Out_Recv <span class="main">`</span> carrier <span class="main">(</span><span class="free">ℒ</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_usr_restk</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_resta</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>sec.Inp_Fedit <span class="main">`</span> <span class="main">(</span>carrier <span class="main">(</span><span class="free">ℒ</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv_restk</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_resta</span> <span class="bound">η</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf' <span class="main">(</span>real_resource' <span class="free">key_rest</span> <span class="free">auth_rest</span><span class="main">)</span> <span class="main">(</span>ideal_resource' <span class="free">key_rest</span> <span class="free">auth_rest</span><span class="main">)</span> sim' <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf'I<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span>real_resource' <span class="free">key_rest</span> <span class="free">auth_rest</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>ideal_resource' <span class="free">key_rest</span> <span class="free">auth_rest</span> <span class="skolem">η</span><span class="main">)</span>
          <span class="main">(</span>sim' <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_resource'_def ideal_resource'_def sim'_def ℐ_real_def ℐ_common_def ℐ_ideal_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> secure<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> WT_key_res WT_auth_rest<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Diffie_Hellman_CC">
<div class="head">
<h1>Theory Diffie_Hellman_CC</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Diffie_Hellman_CC
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../../game_based_crypto/theories/#Diffie_Hellman">Game_Based_Crypto.Diffie_Hellman</a>
    <span class="quoted">"<a href="#Asymptotic_Security">../Asymptotic_Security</a>"</span>
    <span class="quoted">"<a href="#Construction_Utility">../Construction_Utility</a>"</span>
    <span class="quoted">"<a href="#Key">../Specifications/Key</a>"</span> 
    <span class="quoted">"<a href="#Channel">../Specifications/Channel</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Resumption.Pause Monomorphic_Monad.Pause Monomorphic_Monad.Done

<span class="keyword1"><span class="command">no_notation</span></span> Sublist.parallel <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∥</span>"</span> 50<span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> plus_oracle <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span>"</span> 500<span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Diffie-Hellman construction›</span></span>

<span class="keyword1"><span class="command">locale</span></span> diffie_hellman <span class="main">=</span>
    auth<span class="main">:</span> ideal_channel <span class="quoted"><span class="quoted">"id <span class="main">::</span> <span class="tfree">'grp</span> <span class="main">⇒</span> <span class="tfree">'grp</span>"</span></span> <span class="quoted">False</span> <span class="main">+</span>
    key<span class="main">:</span> ideal_key <span class="quoted"><span class="quoted">"carrier <span class="free">𝒢</span>"</span></span> <span class="main">+</span>
    cyclic_group <span class="quoted"><span class="free">𝒢</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">𝒢</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> cyclic_group"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">structure</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining user callees›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'grp'</span> cstate <span class="main">=</span> CState_Void <span class="main">|</span> CState_Half <span class="quoted">nat</span> <span class="main">|</span> CState_Full <span class="quoted"><span class="quoted">"nat <span class="main">×</span> <span class="tfree">'grp'</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> icnv_alice <span class="main">=</span> Inp_Activation_Alice
<span class="keyword1"><span class="command">datatype</span></span> icnv_bob <span class="main">=</span> Iact_Activation_Bob

<span class="keyword1"><span class="command">datatype</span></span> ocnv_alice <span class="main">=</span> Out_Activation_Alice
<span class="keyword1"><span class="command">datatype</span></span> ocnv_bob <span class="main">=</span> Out_Activation_Bob

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">alice_callee</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> cstate <span class="main">⇒</span> key.iusr_alice <span class="main">+</span> icnv_alice 
  <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'grp</span> key.ousr_alice <span class="main">+</span> ocnv_alice<span class="main">)</span> <span class="main">×</span> <span class="tfree">'grp</span> cstate<span class="main">,</span> <span class="tfree">'grp</span> auth.iusr_alice <span class="main">+</span> auth.iusr_bob<span class="main">,</span> auth.ousr_alice <span class="main">+</span> <span class="tfree">'grp</span> auth.ousr_bob<span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">alice_callee</span> CState_Void <span class="main">(</span>Inr <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">x</span> <span class="main">←</span> lift_spmf <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">msg</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">;</span>
      Pause
        <span class="main">(</span>Inl <span class="main">(</span>auth.Inp_Send <span class="bound">msg</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">rsp</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">rsp</span> <span class="keyword1">of</span>
          Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Done <span class="main">(</span>Inr Out_Activation_Alice<span class="main">,</span> CState_Half <span class="bound">x</span><span class="main">)</span>
        <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail<span class="main">)</span> <span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">alice_callee</span> <span class="main">(</span>CState_Half <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span>
      Pause
        <span class="main">(</span>Inr auth.Inp_Recv<span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">rsp</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">rsp</span> <span class="keyword1">of</span>
          Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail
        <span class="main">|</span> Inr <span class="bound">msg</span> <span class="main">⇒</span> <span class="keyword1">case</span> <span class="bound">msg</span> <span class="keyword1">of</span>
            auth.Out_Recv <span class="bound">gy</span> <span class="main">⇒</span> 
              <span class="keyword1">let</span> <span class="bound">key</span> <span class="main">=</span> <span class="bound">gy</span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">in</span> 
              Done <span class="main">(</span>Inl <span class="main">(</span>key.Out_Alice <span class="bound">key</span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">key</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">alice_callee</span> <span class="main">(</span>CState_Full <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Done <span class="main">(</span>Inl <span class="main">(</span>key.Out_Alice <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">alice_callee</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Fail"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bob_callee</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> cstate  <span class="main">⇒</span> key.iusr_bob <span class="main">+</span> icnv_bob 
  <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'grp</span> key.ousr_bob <span class="main">+</span> ocnv_bob<span class="main">)</span> <span class="main">×</span> <span class="tfree">'grp</span> cstate<span class="main">,</span> auth.iusr_bob <span class="main">+</span> <span class="tfree">'grp</span> auth.iusr_alice<span class="main">,</span> <span class="tfree">'grp</span> auth.ousr_bob <span class="main">+</span> auth.ousr_alice<span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">bob_callee</span> CState_Void <span class="main">(</span>Inr <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">y</span> <span class="main">←</span> lift_spmf <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">msg</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">;</span>
      Pause
        <span class="main">(</span>Inr <span class="main">(</span>auth.Inp_Send <span class="bound">msg</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">rsp</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">rsp</span> <span class="keyword1">of</span>
          Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail
        <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Done <span class="main">(</span>Inr Out_Activation_Bob<span class="main">,</span> CState_Half <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bob_callee</span> <span class="main">(</span>CState_Half <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span>
      Pause
        <span class="main">(</span>Inl auth.Inp_Recv<span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">rsp</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">rsp</span> <span class="keyword1">of</span>
          Inl <span class="bound">msg</span> <span class="main">⇒</span> <span class="keyword1">case</span> <span class="bound">msg</span> <span class="keyword1">of</span>
            auth.Out_Recv <span class="bound">gx</span> <span class="main">⇒</span>
              <span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">gx</span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">in</span> 
              Done <span class="main">(</span>Inl <span class="main">(</span>key.Out_Bob <span class="bound">k</span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bob_callee</span> <span class="main">(</span>CState_Full <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span>  Done <span class="main">(</span>Inl <span class="main">(</span>key.Out_Bob <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bob_callee</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Fail"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining adversary callee›</span></span>
<span class="comment1">(*
astate_rbase ⟶ ranmed to ⟶ asate_chann
datatype astate_chann = AState_Available | AState_Unavailable
type_synonym 'grp' astate_lbase = "('grp' × 'grp') option"
type_synonym 'grp' astate_single = "'grp' astate_lbase × astate_rbase"*)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'grp'</span> astate <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp'</span> <span class="main">×</span> <span class="tfree">'grp'</span><span class="main">)</span> option"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'grp'</span> isim <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp'</span> auth.iadv <span class="main">+</span> <span class="tfree">'grp'</span> auth.iadv"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> osim <span class="main">=</span> Out_Simulator

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sim_callee_base</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'grp</span> <span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'grp</span> astate<span class="main">,</span> <span class="tfree">'grp</span> auth.iadv<span class="main">,</span> <span class="tfree">'grp</span> auth.oadv<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">sim_callee_base</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> return_pmf None"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sim_callee_base</span> <span class="free"><span class="bound"><span class="entity">pick</span></span></span> <span class="free"><span class="bound"><span class="entity">gpair_opt</span></span></span> <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">sample</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">x</span> <span class="main">←</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">y</span> <span class="main">←</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">;</span>
        return_spmf <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span> <span class="main">}</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">sample'</span> <span class="main">=</span> case_option <span class="bound">sample</span> id <span class="free"><span class="bound"><span class="entity">gpair_opt</span></span></span><span class="main">;</span>
      return_spmf <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="main">(</span>auth.Out_Look <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pick</span></span></span> <span class="bound">sample'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Some <span class="bound">sample'</span><span class="main">)</span>  <span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sim_callee_base</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">gpair_opt</span></span></span> <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">)</span><span class="main">)</span> <span class="main">=</span> return_spmf <span class="main">(</span>Inr <span class="main">(</span>Inr auth.Out_Fedit<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gpair_opt</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sim_callee</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> astate <span class="main">⇒</span> <span class="tfree">'grp</span> auth.iadv <span class="main">+</span> <span class="tfree">'grp</span> auth.iadv 
  <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'grp</span> auth.oadv <span class="main">+</span> <span class="tfree">'grp</span> auth.oadv<span class="main">)</span> <span class="main">×</span> <span class="tfree">'grp</span> astate<span class="main">,</span> key.iadv <span class="main">+</span> <span class="tfree">'grp</span> isim<span class="main">,</span> key.oadv <span class="main">+</span> osim<span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">sim_callee</span> <span class="free"><span class="bound"><span class="entity">s_gpair</span></span></span> <span class="free"><span class="bound"><span class="entity">query</span></span></span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">handle</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">gpair_pick</span> <span class="bound">wrap_out</span> <span class="bound">q_split</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="main"><span class="bound">_</span></span> <span class="main">←</span> Pause <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">query</span></span></span><span class="main">)</span> Done<span class="main">;</span>
        <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s_gpair'</span><span class="main">)</span> <span class="main">←</span> lift_spmf <span class="main">(</span>sim_callee_base <span class="bound">gpair_pick</span> <span class="free"><span class="bound"><span class="entity">s_gpair</span></span></span> <span class="bound">q_split</span><span class="main">)</span><span class="main">;</span>
        Done <span class="main">(</span><span class="bound">wrap_out</span> <span class="bound">out</span><span class="main">,</span> <span class="bound">s_gpair'</span><span class="main">)</span>  <span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span> 
      case_sum <span class="main">(</span><span class="bound">handle</span> fst Inl<span class="main">)</span> <span class="main">(</span><span class="bound">handle</span> snd Inr<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">query</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining event-translator›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> estate_base <span class="main">=</span> EState_Void <span class="main">|</span> EState_Store <span class="main">|</span> EState_Collect
<span class="keyword1"><span class="command">type_synonym</span></span> estate <span class="main">=</span> <span class="quoted"><span class="quoted">"bool <span class="main">×</span> <span class="main">(</span>estate_base <span class="main">×</span> auth.s_shell<span class="main">)</span> <span class="main">×</span> estate_base <span class="main">×</span> auth.s_shell"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">einit</span> <span class="main">::</span> <span class="quoted">estate</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">einit</span> <span class="main">≡</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">(</span>EState_Void<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">,</span> EState_Void<span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eleak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>estate<span class="main">,</span> key.event<span class="main">,</span> <span class="tfree">'grp</span> isim<span class="main">,</span> osim<span class="main">)</span> eoracle"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">eleak</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_flg</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_event1</span><span class="main">,</span> <span class="bound">s_shell1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_event2</span><span class="main">,</span> <span class="bound">s_shell2</span><span class="main">)</span> <span class="bound">query</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="bound">handle_arg1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">case</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>EState_Store<span class="main">,</span> Some <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>True<span class="main">,</span> EState_Collect<span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>False<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">handle_arg2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span> <span class="bound">D</span><span class="main">.</span> <span class="keyword1">case</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>EState_Store<span class="main">,</span> Inr  <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">D</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return_pmf None<span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">is_ch1</span><span class="main">,</span> <span class="bound">s_event1'</span><span class="main">)</span> <span class="main">=</span> <span class="bound">handle_arg1</span> <span class="bound">s_event1</span> <span class="main">(</span>case_sum Some <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> <span class="bound">query</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">is_ch2</span><span class="main">,</span> <span class="bound">s_event2'</span><span class="main">)</span> <span class="main">=</span> <span class="bound">handle_arg1</span> <span class="bound">s_event2</span> <span class="main">(</span>case_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span> Some <span class="bound">query</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">check_pst1</span> <span class="main">=</span> <span class="bound">is_ch1</span> <span class="main">∧</span> <span class="bound">s_event2'</span> <span class="main">≠</span> EState_Void <span class="main">∧</span> auth.Bob <span class="main">∈</span> <span class="bound">s_shell1</span> <span class="main">∧</span> auth.Alice <span class="main">∈</span> <span class="bound">s_shell2</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">check_pst2</span> <span class="main">=</span> <span class="bound">is_ch2</span> <span class="main">∧</span> <span class="bound">s_event1'</span> <span class="main">≠</span> EState_Void <span class="main">∧</span> auth.Alice <span class="main">∈</span> <span class="bound">s_shell1</span> <span class="main">∧</span> auth.Bob <span class="main">∈</span> <span class="bound">s_shell2</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">e_pstfix1</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">check_pst1</span> <span class="keyword1">then</span> <span class="main">[</span>key.Event_Shell key.Bob<span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">e_pstfix2</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">check_pst2</span> <span class="keyword1">then</span> <span class="main">[</span>key.Event_Shell key.Alice<span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">e_prefix</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="main">¬</span><span class="bound">s_flg</span> <span class="keyword1">then</span> <span class="main">[</span>key.Event_Kernel<span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s_flg'</span><span class="main">,</span> <span class="bound">event</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">is_ch2</span> <span class="main">∨</span> <span class="bound">is_ch1</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> <span class="bound">e_prefix</span> <span class="main">@</span> <span class="bound">e_pstfix1</span> <span class="main">@</span> <span class="bound">e_pstfix2</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">s_flg</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">result_base</span> <span class="main">=</span> return_spmf <span class="main">(</span><span class="main">(</span>Out_Simulator<span class="main">,</span> <span class="bound">event</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_flg'</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_event1'</span><span class="main">,</span> <span class="bound">s_shell1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_event2'</span><span class="main">,</span> <span class="bound">s_shell2</span><span class="main">)</span> <span class="keyword1">in</span>
      case_sum <span class="main">(</span><span class="bound">handle_arg2</span> <span class="bound">s_event1</span><span class="main">)</span> <span class="main">(</span><span class="bound">handle_arg2</span> <span class="bound">s_event2</span><span class="main">)</span> <span class="bound">query</span> <span class="bound">result_base</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">etran_base</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>key.party <span class="main">×</span> key.party <span class="main">⇒</span> key.party <span class="main">×</span> key.party<span class="main">)</span> 
  <span class="main">⇒</span> <span class="main">(</span>estate<span class="main">,</span> auth.event<span class="main">,</span> key.event list<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>                                                         
    <span class="quoted"><span class="quoted">"<span class="free">etran_base</span> <span class="free"><span class="bound"><span class="entity">mod_event</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_flg</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_event1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_shell1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_event2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_shell2</span></span></span><span class="main">)</span> <span class="main">(</span>auth.Event_Shell <span class="free"><span class="bound"><span class="entity">party</span></span></span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">party_dual</span> <span class="main">=</span> auth.case_party <span class="main">(</span>auth.Bob<span class="main">)</span> <span class="main">(</span>auth.Alice<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">party</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">epair</span> <span class="main">=</span> auth.case_party prod.swap id <span class="free"><span class="bound"><span class="entity">party</span></span></span> <span class="main">(</span>key.Bob<span class="main">,</span> key.Alice<span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s_event_eq</span><span class="main">,</span> <span class="bound">s_event_neq</span><span class="main">)</span> <span class="main">=</span> auth.case_party prod.swap id <span class="free"><span class="bound"><span class="entity">party</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_event1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_event2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">check</span> <span class="main">=</span> <span class="bound">party_dual</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_shell2</span></span></span> <span class="main">∧</span> <span class="bound">s_event_eq</span> <span class="main">=</span> EState_Collect <span class="main">∧</span> <span class="bound">s_event_neq</span> <span class="main">≠</span> EState_Void <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">event</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">check</span> <span class="keyword1">then</span> <span class="main">[</span>key.Event_Shell <span class="main">(</span><span class="main">(</span>fst <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">mod_event</span></span></span><span class="main">)</span> <span class="bound">epair</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">s_shell1'</span> <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">party</span></span></span> <span class="free"><span class="bound"><span class="entity">s_shell1</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">party</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_shell1</span></span></span> <span class="keyword1">then</span>
        return_pmf None
      <span class="keyword1">else</span>
        return_spmf <span class="main">(</span><span class="bound">event</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_flg</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_event1</span></span></span><span class="main">,</span> <span class="bound">s_shell1'</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_event2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_shell2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">etran</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>estate<span class="main">,</span> <span class="main">(</span>icnv_alice <span class="main">+</span> icnv_bob<span class="main">)</span> <span class="main">+</span> auth.event <span class="main">+</span> auth.event<span class="main">,</span> key.event list<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">etran</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_flg</span></span></span><span class="main">,</span> <span class="main">(</span>EState_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_shell1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_event2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_shell2</span></span></span><span class="main">)</span> <span class="main">(</span>Inl <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">check</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_event2</span></span></span> <span class="main">=</span> EState_Collect <span class="main">∧</span> auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_shell1</span></span></span> <span class="main">∧</span> auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_shell2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">event</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">check</span> <span class="keyword1">then</span> <span class="main">[</span>key.Event_Shell key.Alice<span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">state</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_flg</span></span></span><span class="main">,</span> <span class="main">(</span>EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_shell1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_event2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_shell2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_shell1</span></span></span> <span class="keyword1">then</span> return_spmf <span class="main">(</span><span class="bound">event</span><span class="main">,</span> <span class="bound">state</span><span class="main">)</span> <span class="keyword1">else</span> return_pmf None<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">etran</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_flg</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_event1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_shell1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_shell2</span></span></span><span class="main">)</span> <span class="main">(</span>Inl <span class="main">(</span>Inr <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">check</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_event1</span></span></span> <span class="main">=</span> EState_Collect <span class="main">∧</span> auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_shell1</span></span></span> <span class="main">∧</span> auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_shell2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">event</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">check</span> <span class="keyword1">then</span> <span class="main">[</span>key.Event_Shell key.Bob<span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">state</span> <span class="main">=</span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_flg</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_event1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_shell1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_shell2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_shell2</span></span></span> <span class="keyword1">then</span> return_spmf <span class="main">(</span><span class="bound">event</span><span class="main">,</span> <span class="bound">state</span><span class="main">)</span> <span class="keyword1">else</span> return_pmf None<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">etran</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">query</span></span></span><span class="main">)</span> <span class="main">=</span>  
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">handle</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">mod_s</span> <span class="bound">mod_e</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="main">(</span><span class="bound">evt</span><span class="main">,</span> <span class="bound">state'</span><span class="main">)</span> <span class="main">←</span> etran_base <span class="bound">mod_e</span> <span class="main">(</span><span class="bound">mod_s</span> <span class="free"><span class="bound"><span class="entity">state</span></span></span><span class="main">)</span> <span class="bound">q</span><span class="main">;</span>
        return_spmf <span class="main">(</span><span class="bound">evt</span><span class="main">,</span> <span class="bound">mod_s</span> <span class="bound">state'</span><span class="main">)</span>  <span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
      case_sum <span class="main">(</span><span class="bound">handle</span> id id<span class="main">)</span> <span class="main">(</span><span class="bound">handle</span> <span class="main">(</span>apsnd prod.swap<span class="main">)</span> prod.swap<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">query</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">etran</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf None"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining Ideal and Real constructions›</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">auth1_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'auth1_s_rest</span><span class="main">,</span> auth.event<span class="main">,</span> <span class="tfree">'auth1_iadv_rest</span><span class="main">,</span> <span class="tfree">'auth1_iusr_rest</span><span class="main">,</span> <span class="tfree">'auth1_oadv_rest</span><span class="main">,</span> <span class="tfree">'auth1_ousr_rest</span><span class="main">)</span> rest_wstate"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="free">auth2_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'auth2_s_rest</span><span class="main">,</span> auth.event<span class="main">,</span> <span class="tfree">'auth2_iadv_rest</span><span class="main">,</span> <span class="tfree">'auth2_iusr_rest</span><span class="main">,</span> <span class="tfree">'auth2_oadv_rest</span><span class="main">,</span> <span class="tfree">'auth2_ousr_rest</span><span class="main">)</span> rest_wstate"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">ideal_core_alt</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"cpoke <span class="free">ideal_core_alt</span> <span class="main">=</span>  cpoke <span class="main">(</span>translate_core etran key.core<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">ideal_core_alt</span> <span class="main">=</span> <span class="main">†</span><span class="main">(</span>cfunc_adv key.core<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">se</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="bound">se'</span><span class="main">)</span> <span class="main">←</span> eleak <span class="bound">se</span> <span class="bound">q</span><span class="main">;</span>
      <span class="bound">sc'</span> <span class="main">←</span> foldl_spmf <span class="main">(</span>cpoke key.core<span class="main">)</span> <span class="main">(</span>return_spmf <span class="bound">sc</span><span class="main">)</span> <span class="bound">es</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">se'</span><span class="main">,</span> <span class="bound">sc'</span><span class="main">)</span>   <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">ideal_core_alt</span> <span class="main">=</span> cfunc_usr <span class="main">(</span>translate_core etran key.core<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">ideal_rest_alt</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"rinit <span class="free">ideal_rest_alt</span> <span class="main">=</span> rinit <span class="main">(</span>parallel_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="free">ideal_rest_alt</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span>apfst <span class="main">(</span>apsnd <span class="main">(</span>map Inr<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_adv <span class="main">(</span>parallel_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="free">ideal_rest_alt</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">let</span> <span class="bound">handle</span> <span class="main">=</span> map_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">::</span> icnv_alice<span class="main">.</span> Out_Activation_Alice<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">::</span> icnv_bob<span class="main">.</span> Out_Activation_Bob<span class="main">)</span> <span class="keyword1">in</span>
      plus_eoracle <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> return_spmf <span class="main">(</span><span class="main">(</span><span class="bound">handle</span> <span class="bound">q</span><span class="main">,</span> <span class="main">[</span><span class="bound">q</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_usr <span class="main">(</span>parallel_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">ideal_rest</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"rinit <span class="free">ideal_rest</span> <span class="main">=</span> <span class="main">(</span>einit<span class="main">,</span> rinit ideal_rest_alt<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="free">ideal_rest</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">q</span> <span class="keyword1">of</span> 
      Inl <span class="bound">ql</span> <span class="main">⇒</span> map_spmf <span class="main">(</span>apfst <span class="main">(</span>map_prod Inl id<span class="main">)</span><span class="main">)</span> <span class="main">(</span>eleak<span class="main">†</span> <span class="bound">s</span> <span class="bound">ql</span><span class="main">)</span>
    <span class="main">|</span> Inr <span class="bound">qr</span> <span class="main">⇒</span> map_spmf <span class="main">(</span>apfst <span class="main">(</span>map_prod Inr id<span class="main">)</span><span class="main">)</span> <span class="main">(</span>translate_eoracle etran <span class="main">†</span><span class="main">(</span>rfunc_adv ideal_rest_alt<span class="main">)</span> <span class="bound">s</span> <span class="bound">qr</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="free">ideal_rest</span> <span class="main">=</span> translate_eoracle etran <span class="main">†</span><span class="main">(</span>rfunc_usr ideal_rest_alt<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ideal_resource</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ideal_resource</span> <span class="main">≡</span> 
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">sim</span> <span class="main">=</span> CNV sim_callee None <span class="keyword1">in</span>
      attach <span class="main">(</span><span class="main">(</span><span class="bound">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">)</span> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">(</span>key.resource ideal_rest<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_resource</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">real_resource</span> <span class="main">≡</span> 
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">dh_wiring</span> <span class="main">=</span> parallel_wiring <span class="main">⊙</span> <span class="main">(</span>CNV alice_callee CState_Void <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> CNV bob_callee CState_Void<span class="main">)</span> <span class="main">⊙</span> parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> swap<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span> <span class="keyword1">in</span>
      attach <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span><span class="bound">dh_wiring</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⊙</span> fused_wiring<span class="main">)</span> <span class="main">(</span><span class="main">(</span>auth.resource <span class="free">auth1_rest</span><span class="main">)</span> <span class="main">∥</span> <span class="main">(</span>auth.resource <span class="free">auth2_rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Wiring and simplifying the Ideal construction›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">basic_rest_sinit</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">basic_rest_sinit</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> rinit <span class="free">auth1_rest</span><span class="main">,</span> rinit <span class="free">auth2_rest</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">basic_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>unit <span class="main">×</span> unit<span class="main">)</span> <span class="main">×</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> rest_scheme"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"rinit <span class="free">basic_rest</span> <span class="main">=</span> <span class="main">(</span>rinit <span class="free">auth1_rest</span><span class="main">,</span> rinit <span class="free">auth2_rest</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="free">basic_rest</span> <span class="main">=</span> <span class="main">†</span><span class="main">(</span>parallel_eoracle <span class="main">(</span>rfunc_adv <span class="free">auth1_rest</span><span class="main">)</span> <span class="main">(</span>rfunc_adv <span class="free">auth2_rest</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="free">basic_rest</span> <span class="main">=</span> <span class="main">†</span><span class="main">(</span>parallel_eoracle <span class="main">(</span>rfunc_usr <span class="free">auth1_rest</span><span class="main">)</span> <span class="main">(</span>rfunc_usr <span class="free">auth2_rest</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ideal_s_core'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> astate <span class="main">×</span> <span class="main">_</span><span class="main">)</span> <span class="main">×</span> <span class="main">_</span> <span class="main">×</span> <span class="tfree">'grp</span> key.state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ideal_s_core'</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> einit<span class="main">,</span> key.PState_Store<span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ideal_s_rest'</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ideal_s_rest'</span> <span class="main">≡</span> basic_rest_sinit"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">ideal_core'</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"cpoke <span class="free">ideal_core'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_cnv</span><span class="main">,</span> <span class="bound">s_event</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">event</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">events</span><span class="main">,</span> <span class="bound">s_event'</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span>etran <span class="bound">s_event</span> <span class="bound">event</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">s_core'</span> <span class="main">←</span> foldl_spmf key.poke <span class="main">(</span>return_spmf <span class="bound">s_core</span><span class="main">)</span> <span class="bound">events</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="bound">s_cnv</span><span class="main">,</span> <span class="bound">s_event'</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span>  <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">ideal_core'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s_sim</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="bound">s_event_core</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> 
      map_spmf 
        <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s_sim'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_event_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_sim'</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_event_core'</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>exec_gpv
          <span class="main">(</span><span class="main">†</span>key.iface_adv <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">se</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span> <span class="bound">isim</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="main">(</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="bound">se'</span><span class="main">)</span> <span class="main">←</span> eleak <span class="bound">se</span> <span class="bound">isim</span><span class="main">;</span>
            <span class="bound">sc'</span> <span class="main">←</span> foldl_spmf <span class="main">(</span>cpoke key.core<span class="main">)</span> <span class="main">(</span>return_spmf <span class="bound">sc</span><span class="main">)</span> <span class="bound">es</span><span class="main">;</span>
            return_spmf <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">se'</span><span class="main">,</span> <span class="bound">sc'</span><span class="main">)</span>   <span class="main">}</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>sim_callee <span class="bound">s_sim</span> <span class="bound">q</span><span class="main">)</span> <span class="bound">s_event_core</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">ideal_core'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_cnv</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> 
      map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">s_cnv</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">†</span>key.iface_usr <span class="bound">s_core</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">ideal_rest'</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"rinit <span class="free">ideal_rest'</span> <span class="main">=</span> rinit basic_rest"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="free">ideal_rest'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span>apfst <span class="main">(</span>apsnd <span class="main">(</span>map Inr<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_adv basic_rest <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="free">ideal_rest'</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">let</span> <span class="bound">handle</span> <span class="main">=</span> map_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">::</span> icnv_alice<span class="main">.</span> Out_Activation_Alice<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">::</span> icnv_bob<span class="main">.</span> Out_Activation_Bob<span class="main">)</span> <span class="keyword1">in</span>
      plus_eoracle <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> return_spmf <span class="main">(</span><span class="main">(</span><span class="bound">handle</span> <span class="bound">q</span><span class="main">,</span> <span class="main">[</span><span class="bound">q</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rfunc_usr basic_rest<span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The ideal attachment lemma›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Diffie_Hellman_CC-ideal_resource_shift_interface"><span class="command">lemma</span></span> ideal_resource_shift_interface<span class="main">:</span> <span class="quoted"><span class="quoted">"key.resource ideal_rest <span class="main">=</span> RES 
    <span class="main">(</span>apply_wiring <span class="main">(</span>rassocl<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span><span class="main">)</span> <span class="main">(</span>fused_resource.fuse ideal_core_alt ideal_rest_alt<span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">(</span>einit<span class="main">,</span> key.PState_Store<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">,</span> rinit ideal_rest_alt<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state_iso <span class="main">(</span>rprodl <span class="main">∘</span> apfst prod.swap<span class="main">,</span> apfst prod.swap <span class="main">∘</span> lprodr<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_iso_def rprodl_def lprodr_def apfst_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> f1<span class="main">=</span> resource_of_oracle_state_iso<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"key.fuse ideal_rest <span class="main">=</span> apply_state_iso <span class="main">(</span>rprodl <span class="main">∘</span> apfst prod.swap<span class="main">,</span> apfst prod.swap <span class="main">∘</span> lprodr<span class="main">)</span>
         <span class="main">(</span>apply_wiring <span class="main">(</span>rassocl<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span><span class="main">)</span> <span class="main">(</span>fused_resource.fuse ideal_core_alt ideal_rest_alt<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> move_simulator_interface<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> apply_wiring_state_iso_assoc<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> etran<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">etran</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ifunc<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">eleak</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> einit<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">einit</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> 
          core<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">key.core</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> rest<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ideal_rest</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> core'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ideal_core_alt</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> rest'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ideal_rest_alt</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> key.resource_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> f2<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> f1<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Diffie_Hellman_CC-ideal_resource_alt_def"><span class="command">lemma</span></span> ideal_resource_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"ideal_resource <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">sim</span> <span class="main">=</span> CNV sim_callee None <span class="keyword1">in</span>
  <span class="keyword1">let</span> <span class="bound">s_init</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>einit<span class="main">,</span> key.PState_Store<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">,</span> rinit ideal_rest_alt<span class="main">)</span> <span class="keyword1">in</span>
  attach <span class="main">(</span><span class="main">(</span><span class="bound">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">(</span>RES <span class="main">(</span>fused_resource.fuse ideal_core_alt ideal_rest_alt<span class="main">)</span> <span class="bound">s_init</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> ideal_resource_shift_interface
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sim</span> <span class="main">=</span> CNV sim_callee None <span class="main">⟹</span>
  <span class="main">(</span><span class="skolem">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> RES <span class="main">(</span>apply_wiring <span class="main">(</span>rassocl<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span><span class="main">)</span> <span class="main">(</span>fused_resource.fuse ideal_core_alt ideal_rest_alt<span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> 
  <span class="main">(</span><span class="skolem">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> RES <span class="main">(</span>fused_resource.fuse ideal_core_alt ideal_rest_alt<span class="main">)</span> <span class="skolem">s</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟹</span> <span class="var">?R</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">sim</span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> fact1<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full<span class="main">,</span> ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CNV sim_callee <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> WT_converter_of_callee<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_gpv_ℐ_mono<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_gpv_full<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℐ_full_le_plus_ℐ<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> fact2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊢c</span>
      apply_wiring <span class="main">(</span>rassocl<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span><span class="main">)</span> <span class="main">(</span>fused_resource.fuse ideal_core_alt ideal_rest_alt<span class="main">)</span> <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> call
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">call</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> y<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper">y</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_wiring_def rassocl<span class="hidden">⇩</span><sub>w</sub>_def parallel2_wiring_def fused_resource.fuse.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> spmf.map_comp map_bind_spmf bind_map_spmf bind_spmf_const o_def

    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> conv_callee_parallel_id_right<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> eq_resource_on_UNIV_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_resource_on_trans<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_ℐ_attach_on'<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_converter2_eq_ℐ_cong<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> comp_converter_of_callee_wiring<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wiring_lassocr<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> conv_callee_parallel_id_right<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fact1<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> converter_of_callee_id_oracle<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> conv_callee_parallel<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> attach_CNV_RES<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_resource_on_resource_of_oracleI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.rel_eq eq_on_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s' s q' q 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> y<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>4<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper">y</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_wiring_def parallel2_wiring_def attach_wiring_right_def 
                rassocl<span class="hidden">⇩</span><sub>w</sub>_def lassocr<span class="hidden">⇩</span><sub>w</sub>_def map_fun_def map_prod_def split_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_flg _ _ _ _ _ _ _ _ _ q
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s_flg</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sim_callee.cases<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split if_splits <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_spmf_bindI'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split if_splits 
                <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def map_gpv_conv_bind<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_lift_spmf map'_lift_spmf<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_eq map_fun_def id_oracle_def split_def<span class="main"><span class="keyword3">;</span></span> 
              <span class="operator">rule</span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split if_splits 
                <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def map_gpv_conv_bind<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_lift_spmf map'_lift_spmf<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fact2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ideal_resource_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Diffie_Hellman_CC-attach_ideal"><span class="command">lemma</span></span> attach_ideal<span class="main">:</span> <span class="quoted"><span class="quoted">"ideal_resource <span class="main">=</span> RES <span class="main">(</span>fused_resource.fuse ideal_core' ideal_rest'<span class="main">)</span> <span class="main">(</span>ideal_s_core'<span class="main">,</span> ideal_s_rest'<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword1"><span class="command">have</span></span> fact1<span class="main">:</span> <span class="quoted"><span class="quoted">"ideal_rest' <span class="main">=</span> attach_rest <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> id ideal_rest_alt"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> spmf.map_comp map_bind_spmf bind_map_spmf bind_spmf_const o_def

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rinit <span class="var">?L</span> <span class="main">=</span> rinit <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="var">?L</span> <span class="main">=</span> rfunc_adv <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> attach_rest_id_oracle_adv 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_state_oracle_def split_def map_spmf_conv_bind_spmf<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="var">?L</span> <span class="main">=</span> rfunc_usr <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> attach_rest_id_oracle_usr 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def extend_state_oracle_def plus_eoracle_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> fact2<span class="main">:</span> <span class="quoted"><span class="quoted">"ideal_core' <span class="main">=</span> attach_core sim_callee <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> ideal_core_alt"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cpoke <span class="var">?L</span> <span class="main">=</span> cpoke <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def map_spmf_conv_bind_spmf<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="var">?L</span> <span class="main">=</span> cfunc_adv <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> attach_core_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="var">?L</span> <span class="main">=</span> cfunc_usr <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> attach_core_id_oracle_usr
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ideal_resource_alt_def Let_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> converter_of_callee_id_oracle<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> attach_parallel_fuse'<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fact1 fact2 ideal_s_core'_def ideal_s_rest'_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Wiring and simplifying the Real construction›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_s_core'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">×</span> <span class="tfree">'grp</span> cstate <span class="main">×</span> <span class="tfree">'grp</span> cstate<span class="main">)</span> <span class="main">×</span> <span class="tfree">'grp</span> auth.state <span class="main">×</span> <span class="tfree">'grp</span> auth.state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">real_s_core'</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Void<span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_s_rest'</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">real_s_rest'</span> <span class="main">≡</span> basic_rest_sinit"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">real_core'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>unit <span class="main">×</span> <span class="main">_</span><span class="main">)</span> <span class="main">×</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> core"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"cpoke <span class="free">real_core'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_advusr</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">event</span><span class="main">.</span> 
      map_spmf <span class="main">(</span>Pair <span class="bound">s_advusr</span><span class="main">)</span> <span class="main">(</span>parallel_handler auth.poke auth.poke <span class="bound">s_core</span> <span class="bound">event</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">real_core'</span> <span class="main">=</span> <span class="main">†</span><span class="main">(</span>auth.iface_adv <span class="keyword1">‡<span class="hidden">⇩</span><sub>O</sub></span> auth.iface_adv<span class="main">)</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">real_core'</span> <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s_adv</span><span class="main">,</span> <span class="bound">s_usr</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">iusr</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="bound">handle_req</span> <span class="main">=</span> lsumr <span class="main">∘</span> map_sum id <span class="main">(</span>rsuml <span class="main">∘</span> map_sum swap_sum id <span class="main">∘</span> lsumr<span class="main">)</span> <span class="main">∘</span> rsuml <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">handle_ret</span> <span class="main">=</span> lsumr <span class="main">∘</span> <span class="main">(</span>map_sum id <span class="main">(</span>rsuml <span class="main">∘</span> <span class="main">(</span>map_sum swap_sum id <span class="main">∘</span> lsumr<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> rsuml<span class="main">)</span> <span class="main">∘</span> map_sum id swap_sum <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">handle_inp</span> <span class="main">=</span>  map_sum id swap_sum <span class="main">∘</span> <span class="main">(</span>lsumr <span class="main">∘</span> map_sum id <span class="main">(</span>rsuml <span class="main">∘</span> map_sum swap_sum id <span class="main">∘</span> lsumr<span class="main">)</span> <span class="main">∘</span> rsuml<span class="main">)</span> <span class="keyword1">in</span>      
      <span class="keyword1">let</span> <span class="bound">handle_out</span> <span class="main">=</span> apfst <span class="main">(</span>lsumr <span class="main">∘</span> <span class="main">(</span>map_sum id <span class="main">(</span>rsuml <span class="main">∘</span> <span class="main">(</span>map_sum swap_sum id <span class="main">∘</span> lsumr<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> rsuml<span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      map_spmf 
        <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">ousr</span><span class="main">,</span> <span class="bound">s_usr'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">ousr</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_adv</span><span class="main">,</span> <span class="bound">s_usr'</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_core'</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>exec_gpv 
          <span class="main">(</span>auth.iface_usr <span class="keyword1">‡<span class="hidden">⇩</span><sub>O</sub></span> auth.iface_usr<span class="main">)</span>
          <span class="main">(</span>map_gpv' 
            <span class="bound">handle_out</span> <span class="bound">handle_inp</span> <span class="bound">handle_ret</span>
            <span class="main">(</span><span class="main">(</span>alice_callee <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> bob_callee<span class="main">)</span> <span class="bound">s_usr</span> <span class="main">(</span><span class="bound">handle_req</span> <span class="bound">iusr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="bound">s_core</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_rest'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>unit <span class="main">×</span> unit<span class="main">)</span> <span class="main">×</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> rest_scheme"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">real_rest'</span> <span class="main">≡</span> basic_rest"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The real attachment lemma›</span></span>

<span class="keyword1" id="Diffie_Hellman_CC-attach_real"><span class="command">lemma</span></span> attach_real<span class="main">:</span> <span class="quoted"><span class="quoted">"real_resource <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊳</span> RES <span class="main">(</span>fused_resource.fuse real_core' real_rest'<span class="main">)</span> <span class="main">(</span>real_s_core'<span class="main">,</span> real_s_rest'<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword1"><span class="command">have</span></span> att_core<span class="main">:</span> <span class="quoted"><span class="quoted">"real_core' <span class="main">=</span> attach_core <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span>
            <span class="main">(</span>attach_wiring parallel_wiring<span class="hidden">⇩</span><sub>w</sub>
              <span class="main">(</span>attach_wiring_right <span class="main">(</span>parallel_wiring<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> swap<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span> <span class="main">(</span>alice_callee <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> bob_callee<span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>parallel_core auth.core auth.core<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cpoke <span class="var">?L</span> <span class="main">=</span> cpoke <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="var">?L</span> <span class="main">=</span> cfunc_adv <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> attach_core_id_oracle_adv
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_state_oracle_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="var">?L</span> <span class="main">=</span> cfunc_usr <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> parallel_wiring<span class="hidden">⇩</span><sub>w</sub>_def swap_lassocr<span class="hidden">⇩</span><sub>w</sub>_def swap<span class="hidden">⇩</span><sub>w</sub>_def lassocr<span class="hidden">⇩</span><sub>w</sub>_def rassocl<span class="hidden">⇩</span><sub>w</sub>_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel2_wiring_simps comp_wiring_simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_wiring_simps attach_wiring_right_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_gpv_conv_map_gpv' map_gpv'_comp apfst_def<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> att_rest<span class="main">:</span> <span class="quoted"><span class="quoted">"real_rest' <span class="main">=</span> attach_rest <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span> id <span class="main">(</span>parallel_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rinit <span class="var">?L</span> <span class="main">=</span> rinit <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> real_rest'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rfunc_adv <span class="var">?L</span> <span class="main">=</span> rfunc_adv <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> real_rest'_def attach_rest_id_oracle_adv
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_state_oracle_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rfunc_usr <span class="var">?L</span> <span class="main">=</span> rfunc_usr <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> real_rest'_def attach_rest_id_oracle_usr
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_state_oracle_def<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> fact1<span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span><span class="main">,</span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> 
      CNV <span class="main">(</span>alice_callee <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> bob_callee<span class="main">)</span> <span class="main">(</span>CState_Void<span class="main">,</span> CState_Void<span class="main">)</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> conv_callee_parallel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐ'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_gpv_ℐ_mono<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_gpv_full<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℐ_full_le_plus_ℐ<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s q
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def  <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cstate.splits if_splits auth.ousr_bob.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> auth.ousr_bob.exhaust range_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐ'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_gpv_ℐ_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_gpv_full<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℐ_full_le_plus_ℐ<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s q
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def  <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cstate.splits if_splits auth.ousr_bob.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> auth.ousr_bob.exhaust range_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


  <span class="keyword1"><span class="command">have</span></span> fact2<span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span><span class="main">,</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> 
      CNV <span class="main">(</span>alice_callee <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> bob_callee<span class="main">)</span> <span class="main">(</span>CState_Void<span class="main">,</span> CState_Void<span class="main">)</span> <span class="main">⊙</span> parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> swap<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fact1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> fact3<span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span><span class="main">,</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span>  <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> 
      CNV <span class="main">(</span>alice_callee <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> bob_callee<span class="main">)</span> <span class="main">(</span>CState_Void<span class="main">,</span> CState_Void<span class="main">)</span> <span class="main">⊙</span> parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> swap<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span> <span class="main">∼</span> 
      CNV <span class="main">(</span>attach_wiring_right <span class="main">(</span>parallel_wiring<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> swap<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span> <span class="main">(</span>alice_callee <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> bob_callee<span class="main">)</span><span class="main">)</span> <span class="main">(</span>CState_Void<span class="main">,</span> CState_Void<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> comp_converter_of_callee_wiring<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wiring_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fact1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> fact4<span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span><span class="main">,</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> 
      parallel_wiring <span class="main">⊙</span> CNV <span class="main">(</span>alice_callee <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> bob_callee<span class="main">)</span> <span class="main">(</span>CState_Void<span class="main">,</span> CState_Void<span class="main">)</span> <span class="main">⊙</span> parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> swap<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span> <span class="main">∼</span>
      CNV <span class="main">(</span>attach_wiring parallel_wiring<span class="hidden">⇩</span><sub>w</sub> <span class="main">(</span>attach_wiring_right <span class="main">(</span>parallel_wiring<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> swap<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span> <span class="main">(</span>alice_callee <span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span> bob_callee<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CState_Void<span class="main">,</span> CState_Void<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_trans<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fact3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> comp_wiring_converter_of_callee<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wiring_intro</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq_ℐ_converterD_WT<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fact3<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> fact2<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> real_resource_def auth.resource_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> resource_of_parallel_oracle<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> attach_compose<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> attach_wiring_resource_of_oracle<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wiring_intro</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">call</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> y<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span></span></span></span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fused_resource.fuse.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> parallel_oracle_fuse<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> resource_of_oracle_state_iso<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_state_iso_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> parallel_converter2_comp2_out<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> conv_callee_parallel<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> eq_resource_on_UNIV_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_attach_on'<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> parallel_converter2_eq_ℐ_cong<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> parallel_converter2_eq_ℐ_cong<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> fact4<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> attach_compose<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> converter_of_callee_id_oracle<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> attach_parallel_fuse'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f_init<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> converter_of_callee_id_oracle<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> eq_resource_on_UNIV_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> att_core<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> att_rest<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> real_s_core'_def real_s_rest'_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">call</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> y<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span></span></span></span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span>5<span class="main">-</span>6<span class="main"><span class="improper">]</span></span> z<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>5<span class="main">-</span>6<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">z</span></span></span></span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fused_resource.fuse.simps parallel_eoracle_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A lazy construction and its DH reduction›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Defining a lazy construction with an inlined sampler›</span></span>

<span class="comment1">― ‹"sample triple" and  "basic core" states›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'grp'</span> st_state <span class="main">=</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp'</span> <span class="main">×</span> <span class="tfree">'grp'</span> <span class="main">×</span> <span class="tfree">'grp'</span><span class="main">)</span> option"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'grp'</span> bc_state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp'</span> st_state <span class="main">×</span> <span class="tfree">'grp'</span> cstate <span class="main">×</span> <span class="tfree">'grp'</span> cstate<span class="main">)</span> <span class="main">×</span> <span class="tfree">'grp'</span> auth.state <span class="main">×</span> <span class="tfree">'grp'</span> auth.state"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sample_triple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span><span class="main">)</span> spmf"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">basic_core_sinit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> bc_state"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">basic_core_sinit</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Void<span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">basic_core_helper_base</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> bc_state<span class="main">,</span> unit<span class="main">,</span> unit<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">basic_core_helper_base</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_key</span></span></span><span class="main">,</span> CState_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_auth2</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">parties1</span></span></span> 
      <span class="keyword1">then</span> return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_key</span></span></span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_auth2</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> return_pmf None<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basic_core_helper_base</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basic_core_helper</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> bc_state<span class="main">,</span> icnv_alice <span class="main">+</span> icnv_bob<span class="main">)</span> handler"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">basic_core_helper</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">state</span> <span class="bound">query</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="bound">handle</span> <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">sk</span><span class="main">,</span> <span class="main">(</span><span class="bound">sc1</span><span class="main">,</span> <span class="bound">sc2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">sa1</span><span class="main">,</span> <span class="bound">sa2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">sk</span><span class="main">,</span> <span class="main">(</span><span class="bound">sc2</span><span class="main">,</span> <span class="bound">sc1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">sa2</span><span class="main">,</span> <span class="bound">sa1</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">func</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">h_s</span> <span class="bound">f</span> <span class="bound">s</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="bound">h_s</span> <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="main">(</span><span class="bound">h_s</span> <span class="bound">s</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="keyword1">in</span>      
      <span class="keyword1">let</span> <span class="bound">func_alc</span> <span class="main">=</span> <span class="bound">func</span> id basic_core_helper_base <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">func_bob</span> <span class="main">=</span> <span class="bound">func</span> <span class="bound">handle</span> basic_core_helper_base <span class="keyword1">in</span>
      case_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">func_alc</span> <span class="bound">state</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">func_bob</span> <span class="bound">state</span><span class="main">)</span> <span class="bound">query</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">basic_core_oracle_adv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" unit <span class="main">+</span> unit <span class="main">⇒</span>  <span class="main">(</span><span class="tfree">'grp</span> st_state <span class="main">×</span> <span class="tfree">'grp</span> auth.state<span class="main">,</span> <span class="tfree">'grp</span> auth.iadv<span class="main">,</span> <span class="tfree">'grp</span> auth.oadv<span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">basic_core_oracle_adv</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="main">(</span>None<span class="main">,</span> auth.State_Store <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span> <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span> <span class="main">←</span> <span class="free">sample_triple</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">out</span> <span class="main">=</span> case_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">gx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">gy</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span><span class="main">;</span>
      return_spmf <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="main">(</span>auth.Out_Look <span class="bound">out</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span>
    <span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basic_core_oracle_adv</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">dhs</span></span></span><span class="main">,</span> auth.State_Store <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span> <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">dhs</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">let</span> <span class="bound">out</span> <span class="main">=</span> case_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">gx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">gy</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="keyword1">in</span>
        return_spmf <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="main">(</span>auth.Out_Look <span class="bound">out</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">dhs</span></span></span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basic_core_oracle_adv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_key</span></span></span><span class="main">,</span> auth.State_Store <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span> <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      return_spmf <span class="main">(</span>Inr <span class="main">(</span>Inr auth.Out_Fedit<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_key</span></span></span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basic_core_oracle_adv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf None"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">basic_core_oracle_usr_base</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> bc_state<span class="main">,</span> unit<span class="main">,</span> <span class="tfree">'grp</span><span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">basic_core_oracle_usr_base</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_key</span></span></span><span class="main">,</span> CState_Half <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_auth1</span></span></span><span class="main">,</span> auth.State_Collect <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties2</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">h_state</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="bound">k</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_auth1</span></span></span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">parties2</span></span></span>  <span class="keyword1">then</span> 
        <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">s_key</span></span></span> <span class="keyword1">of</span>
          None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span> <span class="main">←</span> <span class="free">sample_triple</span><span class="main">;</span>
            return_spmf <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">h_state</span> <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>
        <span class="main">|</span> Some <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span> <span class="main">⇒</span> return_spmf <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">h_state</span> <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> return_pmf None<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basic_core_oracle_usr_base</span> <span class="main">(</span><span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">dhs</span></span></span><span class="main">,</span> CState_Full <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_auth1</span></span></span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties2</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">dhs</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span> <span class="main">⇒</span>
        return_spmf <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">dhs</span></span></span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_auth1</span></span></span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">basic_core_oracle_usr_base</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf None"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basic_core_oracle_usr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> key.iusr_alice <span class="main">+</span> key.iusr_bob<span class="main">,</span> <span class="main">_</span><span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">basic_core_oracle_usr</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">state</span> <span class="bound">query</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="bound">handle</span> <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">sk</span><span class="main">,</span> <span class="main">(</span><span class="bound">sc1</span><span class="main">,</span> <span class="bound">sc2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">sa1</span><span class="main">,</span> <span class="bound">sa2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">sk</span><span class="main">,</span> <span class="main">(</span><span class="bound">sc2</span><span class="main">,</span> <span class="bound">sc1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">sa2</span><span class="main">,</span> <span class="bound">sa1</span><span class="main">)</span> <span class="keyword1">in</span>      
      <span class="keyword1">let</span> <span class="bound">func</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">h_o</span> <span class="bound">h_s</span> <span class="bound">f</span> <span class="bound">s</span><span class="main">.</span> map_spmf <span class="main">(</span>map_prod <span class="bound">h_o</span> <span class="bound">h_s</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="main">(</span><span class="bound">h_s</span> <span class="bound">s</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">func_alc</span> <span class="main">=</span> <span class="bound">func</span> <span class="main">(</span>Inl <span class="keyword1">o</span> key.Out_Alice<span class="main">)</span> id basic_core_oracle_usr_base <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">func_bob</span> <span class="main">=</span> <span class="bound">func</span> <span class="main">(</span>Inr <span class="keyword1">o</span> key.Out_Bob<span class="main">)</span> <span class="bound">handle</span> basic_core_oracle_usr_base <span class="keyword1">in</span>
      case_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">func_alc</span> <span class="bound">state</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">func_bob</span> <span class="bound">state</span><span class="main">)</span> <span class="bound">query</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">basic_core</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"cpoke <span class="free">basic_core</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s_other</span><span class="main">,</span> <span class="bound">s_core</span><span class="main">)</span> <span class="bound">event</span><span class="main">.</span> 
      map_spmf <span class="main">(</span>Pair <span class="bound">s_other</span><span class="main">)</span> <span class="main">(</span>parallel_handler auth.poke auth.poke <span class="bound">s_core</span> <span class="bound">event</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">basic_core</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">s_key</span><span class="main">,</span> <span class="bound">s_cnv</span><span class="main">)</span><span class="main">,</span> <span class="bound">s_auth1</span><span class="main">,</span> <span class="bound">s_auth2</span><span class="main">)</span> <span class="bound">iadv</span><span class="main">.</span> 
      <span class="keyword1">let</span> <span class="bound">handle</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">sel</span> <span class="bound">s_init</span> <span class="bound">h_out</span> <span class="bound">h_state</span> <span class="bound">query</span><span class="main">.</span> 
        map_spmf 
          <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_key'</span><span class="main">,</span> <span class="bound">s_auth'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">h_out</span> <span class="bound">out</span><span class="main">,</span> <span class="main">(</span><span class="bound">s_key'</span><span class="main">,</span> <span class="bound">s_cnv</span><span class="main">)</span><span class="main">,</span> <span class="bound">h_state</span> <span class="bound">s_auth'</span> <span class="bound">s_auth1</span> <span class="bound">s_auth2</span><span class="main">)</span><span class="main">)</span> 
          <span class="main">(</span>basic_core_oracle_adv <span class="bound">sel</span> <span class="main">(</span><span class="bound">s_key</span><span class="main">,</span> <span class="bound">s_init</span><span class="main">)</span> <span class="bound">query</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      case_sum <span class="main">(</span><span class="bound">handle</span> <span class="main">(</span>Inl <span class="main">()</span><span class="main">)</span> <span class="bound">s_auth1</span> Inl <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">handle</span> <span class="main">(</span>Inr <span class="main">()</span><span class="main">)</span> <span class="bound">s_auth2</span> Inr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">iadv</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">basic_core</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">handle</span> <span class="main">=</span> map_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Out_Activation_Alice<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Out_Activation_Bob<span class="main">)</span> <span class="keyword1">in</span>
      basic_core_oracle_usr <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span>Pair <span class="main">(</span><span class="bound">handle</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>basic_core_helper <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">lazy_core</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"cpoke <span class="free">lazy_core</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> basic_core_helper <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>cpoke basic_core <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_adv <span class="free">lazy_core</span> <span class="main">=</span> cfunc_adv basic_core "</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"cfunc_usr <span class="free">lazy_core</span> <span class="main">=</span> basic_core_oracle_usr"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lazy_rest</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">lazy_rest</span> <span class="main">≡</span> ideal_rest'"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Defining a lazy construction with an external sampler›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">type_synonym</span></span>  <span class="main">(</span><span class="tfree">'grp'</span><span class="main">,</span> <span class="tfree">'iadv_rest'</span><span class="main">,</span> <span class="tfree">'iusr_rest'</span><span class="main">)</span> dh_inp <span class="main">=</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="main">(</span><span class="tfree">'grp'</span> auth.iadv <span class="main">+</span> <span class="tfree">'grp'</span> auth.iadv<span class="main">)</span> <span class="main">+</span> <span class="tfree">'iadv_rest'</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>key.iusr_alice <span class="main">+</span> key.iusr_bob<span class="main">)</span> <span class="main">+</span> <span class="main">(</span>icnv_alice <span class="main">+</span> icnv_bob<span class="main">)</span> <span class="main">+</span> <span class="tfree">'iusr_rest'</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">type_synonym</span></span>  <span class="main">(</span><span class="tfree">'grp'</span><span class="main">,</span> <span class="tfree">'oadv_rest'</span><span class="main">,</span> <span class="tfree">'ousr_rest'</span><span class="main">)</span> dh_out <span class="main">=</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="main">(</span><span class="tfree">'grp'</span> auth.oadv <span class="main">+</span> <span class="tfree">'grp'</span> auth.oadv<span class="main">)</span> <span class="main">+</span> <span class="tfree">'oadv_rest'</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'grp'</span> key.ousr_alice <span class="main">+</span> <span class="tfree">'grp'</span> key.ousr_bob<span class="main">)</span> <span class="main">+</span> <span class="main">(</span>ocnv_alice <span class="main">+</span> ocnv_bob<span class="main">)</span> <span class="main">+</span> <span class="tfree">'ousr_rest'</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">interceptor_base_look</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" unit <span class="main">+</span> unit <span class="main">⇒</span> <span class="tfree">'grp</span> st_state <span class="main">×</span> <span class="tfree">'grp</span> auth.state 
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'grp</span> auth.oadv_look <span class="main">×</span> <span class="tfree">'grp</span> st_state<span class="main">,</span> unit<span class="main">,</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span><span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">interceptor_base_look</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="main">(</span>None<span class="main">,</span> auth.State_Store <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span> <span class="main">←</span> Pause <span class="main">()</span> Done<span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">out</span> <span class="main">=</span> case_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">gx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">gy</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span><span class="main">;</span>
      Done <span class="main">(</span>auth.Out_Look <span class="bound">out</span><span class="main">,</span> Some <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span><span class="main">)</span>  <span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interceptor_base_look</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">dhs</span></span></span><span class="main">,</span> auth.State_Store <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">dhs</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="keyword1">let</span> <span class="bound">out</span> <span class="main">=</span> case_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">gx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">gy</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="keyword1">in</span>
      Done <span class="main">(</span>auth.Out_Look <span class="bound">out</span><span class="main">,</span> Some <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interceptor_base_look</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Fail"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">interceptor_base_recv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> bc_state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span> bc_state<span class="main">,</span> unit<span class="main">,</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span><span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">interceptor_base_recv</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_key</span></span></span><span class="main">,</span> CState_Half <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_auth1</span></span></span><span class="main">,</span> auth.State_Collect <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">let</span> <span class="bound">h_state</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="bound">k</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_auth1</span></span></span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">parties2</span></span></span> <span class="keyword1">then</span> 
        <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">s_key</span></span></span> <span class="keyword1">of</span> 
          None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span> <span class="main">←</span> Pause <span class="main">()</span> Done<span class="main">;</span> 
            Done <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">h_state</span> <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span><span class="main">)</span>  <span class="main">}</span>
        <span class="main">|</span> Some <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span> <span class="main">⇒</span> Done <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">h_state</span> <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span>
        Fail<span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interceptor_base_recv</span> <span class="main">(</span><span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">dhs</span></span></span><span class="main">,</span> CState_Full <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_auth1</span></span></span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">dhs</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="bound">gx</span><span class="main">,</span> <span class="bound">gy</span><span class="main">)</span> <span class="main">⇒</span>
        Done <span class="main">(</span><span class="bound">gxy</span><span class="main">,</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">dhs</span></span></span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_auth1</span></span></span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">parties2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interceptor_base_recv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Fail"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">interceptor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> dh_inp  <span class="main">⇒</span>  <span class="main">(</span><span class="main">(</span><span class="tfree">'grp</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> dh_out <span class="main">×</span> <span class="main">_</span><span class="main">,</span> unit<span class="main">,</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span><span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">interceptor</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sr</span></span></span><span class="main">)</span> <span class="main">(</span>Inl <span class="main">(</span>Inl <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">let</span> <span class="bound">select_s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">sc</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="main">(</span><span class="bound">sk</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="bound">sa1</span><span class="main">,</span> <span class="bound">sa2</span><span class="main">)</span> <span class="main">⇒</span> case_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">(</span><span class="bound">sk</span><span class="main">,</span> <span class="bound">sa1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">(</span><span class="bound">sk</span><span class="main">,</span> <span class="bound">sa2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">handle_s</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">sc</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="main">(</span><span class="bound">sk</span><span class="main">,</span> <span class="main">(</span><span class="bound">sc1</span><span class="main">,</span> <span class="bound">sc2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">sa1</span><span class="main">,</span> <span class="bound">sa2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">(</span><span class="bound">sc1</span><span class="main">,</span> <span class="bound">sc2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">sa1</span><span class="main">,</span> <span class="bound">sa2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">func_look</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">sel</span> <span class="bound">h_o</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="main">(</span><span class="bound">o_look</span><span class="main">,</span> <span class="bound">dhs</span><span class="main">)</span> <span class="main">←</span> interceptor_base_look <span class="main">(</span><span class="bound">sel</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="bound">select_s</span> <span class="main">(</span><span class="bound">sel</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
        Done <span class="main">(</span>Inl <span class="main">(</span>Inl <span class="main">(</span><span class="bound">h_o</span> <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="bound">o_look</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">handle_s</span> <span class="bound">dhs</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sr</span></span></span><span class="main">)</span>  <span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">func_dfe</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">sc'</span><span class="main">)</span> <span class="main">←</span> lift_spmf <span class="main">(</span>cfunc_adv <span class="main">(</span>lazy_core undefined<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sc</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">;</span>
        Done <span class="main">(</span>Inl <span class="main">(</span>Inl <span class="bound">out</span><span class="main">)</span><span class="main">,</span> <span class="bound">sc'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sr</span></span></span><span class="main">)</span>  <span class="main">}</span> <span class="keyword1">in</span>
      <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">of</span>
        <span class="main">(</span>Inl <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">func_look</span> Inl Inl
      <span class="main">|</span> <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">func_look</span> Inr Inr
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">func_dfe</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interceptor</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sr</span></span></span><span class="main">)</span> <span class="main">(</span>Inl <span class="main">(</span>Inr <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> 
      <span class="main">(</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="bound">sr'</span><span class="main">)</span> <span class="main">←</span> lift_spmf <span class="main">(</span>rfunc_adv lazy_rest <span class="free"><span class="bound"><span class="entity">sr</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">sc'</span> <span class="main">←</span> lift_spmf <span class="main">(</span>foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">e</span><span class="main">.</span> cpoke <span class="main">(</span>lazy_core undefined<span class="main">)</span> <span class="bound">a</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="free"><span class="bound"><span class="entity">sc</span></span></span><span class="main">)</span> <span class="bound">es</span><span class="main">)</span><span class="main">;</span>
      Done <span class="main">(</span>Inl <span class="main">(</span>Inr <span class="bound">out</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">sc'</span><span class="main">,</span> <span class="bound">sr'</span><span class="main">)</span><span class="main">)</span>  <span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interceptor</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sr</span></span></span><span class="main">)</span> <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">let</span> <span class="bound">handle</span> <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">sk</span><span class="main">,</span> <span class="main">(</span><span class="bound">sc1</span><span class="main">,</span> <span class="bound">sc2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">sa1</span><span class="main">,</span> <span class="bound">sa2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">sk</span><span class="main">,</span> <span class="main">(</span><span class="bound">sc2</span><span class="main">,</span> <span class="bound">sc1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">sa2</span><span class="main">,</span> <span class="bound">sa1</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">func_recv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h_o</span> <span class="bound">h_s</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="main">(</span><span class="bound">o_recv</span><span class="main">,</span> <span class="bound">sc'</span><span class="main">)</span> <span class="main">←</span> interceptor_base_recv <span class="main">(</span><span class="bound">h_s</span> <span class="free"><span class="bound"><span class="entity">sc</span></span></span><span class="main">)</span><span class="main">;</span>
        Done <span class="main">(</span>Inr <span class="main">(</span>Inl <span class="main">(</span><span class="bound">h_o</span> <span class="bound">o_recv</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">h_s</span> <span class="bound">sc'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sr</span></span></span><span class="main">)</span>  <span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span> 
      case_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">func_recv</span> <span class="main">(</span>Inl <span class="keyword1">o</span> key.Out_Alice<span class="main">)</span> id<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">func_recv</span> <span class="main">(</span>Inr <span class="keyword1">o</span> key.Out_Bob<span class="main">)</span> <span class="bound">handle</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">interceptor</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sr</span></span></span><span class="main">)</span> <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> 
      <span class="main">(</span><span class="main">(</span><span class="bound">out</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="bound">sr'</span><span class="main">)</span> <span class="main">←</span> lift_spmf <span class="main">(</span>rfunc_usr lazy_rest <span class="free"><span class="bound"><span class="entity">sr</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">sc'</span> <span class="main">←</span> lift_spmf <span class="main">(</span>foldl_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">e</span><span class="main">.</span> cpoke <span class="main">(</span>lazy_core undefined<span class="main">)</span> <span class="bound">a</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="free"><span class="bound"><span class="entity">sc</span></span></span><span class="main">)</span> <span class="bound">es</span><span class="main">)</span><span class="main">;</span>
      Done <span class="main">(</span>Inr <span class="main">(</span>Inr <span class="bound">out</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">sc'</span><span class="main">,</span> <span class="bound">sr'</span><span class="main">)</span><span class="main">)</span>  <span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Reduction to Diffie-Hellman game›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DH0_sample</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">DH0_sample</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">x</span> <span class="main">←</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">y</span> <span class="main">←</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span>  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DH1_sample</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">DH1_sample</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">x</span> <span class="main">←</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">y</span> <span class="main">←</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">z</span> <span class="main">←</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">z</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span>  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Diffie_Hellman_CC-lossless_DH0_sample"><span class="command">lemma</span></span> lossless_DH0_sample <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf DH0_sample"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def sample_uniform_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_gt_0<span class="main">)</span>

<span class="keyword1" id="Diffie_Hellman_CC-lossless_DH1_sample"><span class="command">lemma</span></span> lossless_DH1_sample <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf DH1_sample"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH1_sample_def sample_uniform_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_gt_0<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DH_adversary_curry</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span> <span class="main">⇒</span> bool spmf<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'grp</span> <span class="main">⇒</span> <span class="tfree">'grp</span> <span class="main">⇒</span> <span class="tfree">'grp</span> <span class="main">⇒</span> bool spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">DH_adversary_curry</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> bind_spmf <span class="main">(</span>return_spmf <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">A</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DH_adversary</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">DH_adversary</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≡</span> DH_adversary_curry <span class="main">(</span><span class="main">λ</span><span class="bound">xyz</span><span class="main">.</span> 
      run_gpv <span class="main">(</span>obsf_oracle <span class="main">(</span>obsf_oracle <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tpl</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span>apsnd <span class="main">(</span>Pair <span class="bound">tpl</span><span class="main">)</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="main">(</span>exec_gpv <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> return_spmf <span class="main">(</span><span class="bound">tpl</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>interceptor <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>obsf_distinguisher <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">(</span>OK <span class="main">(</span>OK <span class="main">(</span><span class="bound">xyz</span><span class="main">,</span> basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">S_ic_asm</span> <span class="free"><span class="bound"><span class="entity">s_cnv1</span></span></span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span> <span class="free"><span class="bound"><span class="entity">s_krn1</span></span></span> <span class="free"><span class="bound"><span class="entity">s_krn2</span></span></span> <span class="main">≡</span> 
  <span class="keyword1">let</span> <span class="bound">s_cnvs</span> <span class="main">=</span> <span class="main">{</span>CState_Void<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>CState_Half <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">}</span> <span class="keyword1">in</span>
  <span class="keyword1">let</span> <span class="bound">s_krns</span> <span class="main">=</span> <span class="main">{</span>auth.State_Void<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>auth.State_Store  <span class="main">𝟭</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>auth.State_Collect  <span class="main">𝟭</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>auth.State_Collected<span class="main">}</span> <span class="keyword1">in</span>
  <span class="free"><span class="bound"><span class="entity">s_cnv1</span></span></span> <span class="main">∈</span> <span class="bound">s_cnvs</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span> <span class="main">∈</span> <span class="bound">s_cnvs</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s_krn1</span></span></span> <span class="main">∈</span> <span class="bound">s_krns</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s_krn2</span></span></span> <span class="main">∈</span> <span class="bound">s_krns</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">S_ic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span><span class="main">)</span> spmf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'grp</span> bc_state <span class="main">×</span> <span class="main">(</span>unit <span class="main">×</span> unit<span class="main">)</span> <span class="main">×</span> <span class="tfree">'auth1_s_rest</span> <span class="main">×</span> <span class="tfree">'auth2_s_rest</span><span class="main">)</span> spmf  <span class="main">⇒</span> 
    <span class="main">(</span><span class="main">(</span><span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'grp</span> bc_state <span class="main">×</span> <span class="main">(</span>unit <span class="main">×</span> unit<span class="main">)</span> <span class="main">×</span> <span class="tfree">'auth1_s_rest</span> <span class="main">×</span> <span class="tfree">'auth2_s_rest</span><span class="main">)</span> spmf  <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">𝒮</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span><span class="main">)</span> spmf"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">S_ic</span> <span class="free">𝒮</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_krn1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_krn2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_rest1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_rest2</span></span></span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_krn1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_krn2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_rest1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_rest2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">𝒮</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"S_ic_asm <span class="free"><span class="bound"><span class="entity">s_cnv1</span></span></span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span> <span class="free"><span class="bound"><span class="entity">s_krn1</span></span></span> <span class="free"><span class="bound"><span class="entity">s_krn2</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S_ic</span> <span class="free">𝒮</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_krn1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_krn2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_rest1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_rest2</span></span></span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s_krn1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_krn2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_rest1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_rest2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"S_ic_asm <span class="free"><span class="bound"><span class="entity">s_cnv1</span></span></span> <span class="free"><span class="bound"><span class="entity">s_cnv2</span></span></span> <span class="free"><span class="bound"><span class="entity">s_krn1</span></span></span> <span class="free"><span class="bound"><span class="entity">s_krn2</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Diffie_Hellman_CC-trace_eq_intercept"><span class="command">lemma</span></span> trace_eq_intercept<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">outs_adv</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span>  UNIV <span class="main">&lt;+&gt;</span> UNIV"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">outs_usr</span> <span class="main">≡</span> <span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> <span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="free">sample_triple</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="main">(</span>fused_resource.fuse <span class="main">(</span>lazy_core <span class="free">sample_triple</span><span class="main">)</span> lazy_rest<span class="main">)</span> 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tpl</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span>apsnd <span class="main">(</span>Pair <span class="bound">tpl</span><span class="main">)</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="main">(</span>exec_gpv <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> return_spmf <span class="main">(</span><span class="bound">tpl</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>interceptor <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">outs_adv</span> <span class="main">&lt;+&gt;</span> <span class="free">outs_usr</span><span class="main">)</span> 
    <span class="main">(</span>return_spmf <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span><span class="main">)</span> <span class="main">(</span>pair_spmf <span class="free">sample_triple</span> <span class="main">(</span>return_spmf <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="var">?L</span> <span class="var">?R</span> <span class="var">?OI</span> <span class="var">?sl</span> <span class="var">?sr</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> auth_poke_alt<span class="main">[</span><span class="operator">simplified</span> split_def Let_def<span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"auth.poke <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">sl</span><span class="main">,</span> <span class="bound">sr</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">p</span> <span class="main">=</span> auth.case_event id <span class="bound">q</span> <span class="keyword1">in</span>
      map_spmf <span class="main">(</span>Pair <span class="bound">sl</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">sr</span> <span class="keyword1">then</span> return_pmf None <span class="keyword1">else</span> return_spmf <span class="main">(</span>insert <span class="bound">p</span> <span class="bound">sr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> auth.event.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> S_ic_cases <span class="main">=</span> S_ic.cases<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 𝒮<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">sample_triple</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> S_ic_intros <span class="main">=</span> S_ic.intros<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 𝒮<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">sample_triple</span></span></span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> lossless_spmf_def<span class="main">]</span> mk_lossless_lossless<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> 
    fused_resource.fuse.simps lazy_rest_def basic_core_oracle_usr_def basic_core_helper_def
    exec_gpv_bind spmf.map_comp map_bind_spmf bind_map_spmf bind_spmf_const o_def Let_def split_def
    extend_state_oracle_def plus_eoracle_def parallel_eoracle_def map_fun_def
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="var">?L</span> <span class="var">?R</span> <span class="var">?OI</span> <span class="var">?sl</span> <span class="var">?sr</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace'_eqI_sim_upto<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"S_ic <span class="free">sample_triple</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> Init_OK
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> pair_spmf_alt_def S_ic_intros<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> Out_OK <span class="keyword2"><span class="keyword">for</span></span> sl sr q
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_adv
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_adv</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_adv_core
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_adv_core</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_acore1
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_acore1</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span> <span class="operator">simp_all</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_lfe
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_lfe</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_look
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2  s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inl <span class="main">()</span><span class="main">,</span> <span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interceptor_base_look.cases<span class="main">)</span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inl <span class="main">()</span><span class="main">,</span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interceptor_base_look.cases<span class="main">)</span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_fedit
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inl <span class="main">()</span><span class="main">,</span> <span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> Inr <span class="main">(</span>Inr <span class="skolem">q_fedit</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_adv.cases<span class="main">)</span> <span class="operator">simp_all</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inl <span class="main">()</span><span class="main">,</span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> Inr <span class="main">(</span>Inr <span class="skolem">q_fedit</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_adv.cases<span class="main">)</span> <span class="operator">simp_all</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_acore2
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_acore2</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span> <span class="operator">simp_all</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_lfe
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_lfe</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_look
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interceptor_base_look.cases<span class="main">)</span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interceptor_base_look.cases<span class="main">)</span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_fedit
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> Inr <span class="main">(</span>Inr <span class="skolem">q_fedit</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_adv.cases<span class="main">)</span> <span class="operator">simp_all</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> Inr <span class="main">(</span>Inr <span class="skolem">q_fedit</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_adv.cases<span class="main">)</span> <span class="operator">simp_all</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_adv_rest
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_adv_rest</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_arest1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_arest2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_usr</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr_core
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_usr_core</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_alice
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 s_act1 s_act2 s_rest1 s_rest2
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_cnv1</span><span class="main">,</span> <span class="skolem">s_cnv2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_usr_base.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_cnv1</span><span class="main">,</span> <span class="skolem">s_cnv2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_usr_base.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_bob
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 s_act1 s_act2 s_rest1 s_rest2
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_cnv2</span><span class="main">,</span> <span class="skolem">s_cnv1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_usr_base.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_cnv2</span><span class="main">,</span> <span class="skolem">s_cnv1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_usr_base.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr_rest
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_usr_rest</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_act
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_act</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a_alice <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span> <span class="operator">simp_all</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a_bob <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span> <span class="operator">simp_all</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_urest
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_urest</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_urest1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span> <span class="operator">simp_all</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_urest2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span> <span class="operator">simp_all</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> State_OK <span class="keyword2"><span class="keyword">for</span></span> sl sr q
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_adv
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_adv</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_adv_core
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_adv_core</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_acore1
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_acore1</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span> <span class="operator">simp_all</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_lfe
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_lfe</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_look
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inl <span class="main">()</span><span class="main">,</span> <span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interceptor_base_look.cases<span class="main">)</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cond_spmf_fst_def vimage_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_map S_ic_intros<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inl <span class="main">()</span><span class="main">,</span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interceptor_base_look.cases<span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> S_ic_intros<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_fedit
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inl <span class="main">()</span><span class="main">,</span> <span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> Inr <span class="main">(</span>Inr <span class="skolem">q_fedit</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_adv.cases<span class="main">)</span>
                    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inl <span class="main">()</span><span class="main">,</span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> Inr <span class="main">(</span>Inr <span class="skolem">q_fedit</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_adv.cases<span class="main">)</span>
                    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_acore2
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_acore2</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span> <span class="operator">simp_all</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_lfe
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_lfe</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_look
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interceptor_base_look.cases<span class="main">)</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cond_spmf_fst_def vimage_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_map S_ic_intros<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interceptor_base_look.cases<span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> S_ic_intros<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_fedit
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> Inr <span class="main">(</span>Inr <span class="skolem">q_fedit</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_adv.cases<span class="main">)</span>
                    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> Inr <span class="main">(</span>Inr <span class="skolem">q_fedit</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_adv.cases<span class="main">)</span>
                    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_adv_rest
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_adv_rest</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_urest1
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bind <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> auth_poke_alt set_scale_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> foldl_spmf_helper2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> acc<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"return_spmf <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span>"</span></span>
                    <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bind <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> auth_poke_alt set_scale_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> foldl_spmf_helper2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> acc<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"return_spmf <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span>"</span></span>
                    <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> S_ic_intros<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_urest2
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bind <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> auth_poke_alt set_scale_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> foldl_spmf_helper2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> acc<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"return_spmf <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span>"</span></span>
                    <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bind <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> auth_poke_alt set_scale_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> foldl_spmf_helper2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> acc<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"return_spmf <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span>"</span></span>
                    <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> S_ic_intros<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_usr</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr_core
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_usr_core</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_alice
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 s_act1 s_act2 s_rest1 s_rest2
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_cnv1</span><span class="main">,</span> <span class="skolem">s_cnv2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_usr_base.cases<span class="main">)</span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">goal_cases</span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s_key</span> _ <span class="skolem">s_cnv2</span> <span class="skolem">s_auth1</span> _ <span class="skolem">parties2</span> _<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cond_spmf_fst_def vimage_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_map S_ic_intros<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_cnv1</span><span class="main">,</span> <span class="skolem">s_cnv2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_usr_base.cases<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_bob
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 s_act1 s_act2 s_rest1 s_rest2
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_cnv2</span><span class="main">,</span> <span class="skolem">s_cnv1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_usr_base.cases<span class="main">)</span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">goal_cases</span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s_key</span> _ <span class="skolem">s_cnv2</span> <span class="skolem">s_auth1</span> _ <span class="skolem">parties2</span> _<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cond_spmf_fst_def vimage_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_map S_ic_intros<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_cnv2</span><span class="main">,</span> <span class="skolem">s_cnv1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_oracle_usr_base.cases<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr_rest
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_usr_rest</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_act
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_act</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a_alice
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 s_act1 s_act2 s_rest1 s_rest2
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_cnv1</span><span class="main">,</span> <span class="skolem">s_cnv2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_helper_base.cases<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_cnv1</span><span class="main">,</span> <span class="skolem">s_cnv2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_helper_base.cases<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a_bob
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 s_act1 s_act2 s_rest1 s_rest2
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="skolem">s_cnv2</span><span class="main">,</span> <span class="skolem">s_cnv1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_helper_base.cases<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv1 s_cnv2 s_krn1 s_krn2 x s_act1 s_act2 s_rest1 s_rest2
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>Some <span class="skolem">x</span><span class="main">,</span> <span class="skolem">s_cnv2</span><span class="main">,</span> <span class="skolem">s_cnv1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s_krn2</span><span class="main">,</span> <span class="skolem">s_act2</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s_krn1</span><span class="main">,</span> <span class="skolem">s_act1</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> basic_core_helper_base.cases<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_urest
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_urest</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_urest1
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bind <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> auth_poke_alt set_scale_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> foldl_spmf_helper2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> acc<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"return_spmf <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span>"</span></span>
                      <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bind <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> auth_poke_alt set_scale_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> foldl_spmf_helper2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> acc<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"return_spmf <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span>"</span></span>
                      <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> S_ic_intros<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_urest2
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_ic_cases<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bind <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> auth_poke_alt set_scale_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> foldl_spmf_helper2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> acc<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"return_spmf <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span>"</span></span>
                      <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_ic_intros<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bind <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> auth_poke_alt set_scale_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> foldl_spmf_helper2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> acc<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"return_spmf <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span>"</span></span>
                      <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> S_ic_intros<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">TRY</span> map_spmf OK <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">ELSE</span> return_spmf Fault"</span></span> 

<span class="keyword1" id="Diffie_Hellman_CC-reduction"><span class="command">lemma</span></span> reduction<span class="main">:</span> <span class="quoted"><span class="quoted">"advantage <span class="free">D</span> <span class="main">(</span>obsf_resource <span class="main">(</span>RES <span class="main">(</span>fused_resource.fuse <span class="main">(</span>lazy_core DH1_sample<span class="main">)</span> lazy_rest<span class="main">)</span> <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>obsf_resource <span class="main">(</span>RES <span class="main">(</span>fused_resource.fuse <span class="main">(</span>lazy_core DH0_sample<span class="main">)</span> lazy_rest<span class="main">)</span> <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ddh.advantage <span class="free">𝒢</span> <span class="main">(</span>DH_adversary <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fact1<span class="main">:</span> <span class="quoted"><span class="quoted">"bind_spmf <span class="main">(</span>DH0_sample<span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">x</span> <span class="main">←</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">y</span> <span class="main">←</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span>DH_adversary_curry <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def DH_adversary_curry_def nat_pow_pow<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> fact2<span class="main">:</span> <span class="quoted"><span class="quoted">"bind_spmf DH1_sample <span class="skolem">A</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">x</span> <span class="main">←</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">y</span> <span class="main">←</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">z</span> <span class="main">←</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span>DH_adversary_curry <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="bound">z</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH1_sample_def DH_adversary_curry_def<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sample_triple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span> <span class="main">×</span> <span class="tfree">'grp</span><span class="main">)</span> spmf"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="skolem">sample_triple</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s_init</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s_init</span> <span class="main">≡</span> <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">unfolded</span> s_init_def<span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dummy <span class="main">(</span>dummy <span class="main">(</span>return_spmf <span class="skolem">s_init</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> return_spmf <span class="main">(</span>OK <span class="main">(</span>OK <span class="skolem">s_init</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">unfolded</span> s_init_def<span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dummy <span class="main">(</span>dummy <span class="main">(</span>pair_spmf <span class="skolem">sample_triple</span> <span class="main">(</span>return_spmf <span class="skolem">s_init</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      map_spmf <span class="main">(</span>OK <span class="main">∘</span> OK<span class="main">)</span> <span class="main">(</span>pair_spmf <span class="skolem">sample_triple</span> <span class="main">(</span>return_spmf <span class="skolem">s_init</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def map_spmf_conv_bind_spmf pair_spmf_alt_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connect <span class="skolem">D</span> <span class="main">(</span>RES <span class="main">(</span>obsf_oracle <span class="main">(</span>obsf_oracle <span class="main">(</span>fused_resource.fuse <span class="main">(</span>lazy_core <span class="skolem">sample_triple</span><span class="main">)</span> lazy_rest<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>OK <span class="main">(</span>OK <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      bind_spmf <span class="main">(</span>map_spmf <span class="main">(</span>OK <span class="keyword1">o</span> OK<span class="main">)</span> <span class="main">(</span>pair_spmf <span class="skolem">sample_triple</span> <span class="main">(</span>return_spmf <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">(</span>run_gpv <span class="main">(</span>obsf_oracle <span class="main">(</span>obsf_oracle <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tpl</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">(</span>apsnd <span class="main">(</span>Pair <span class="bound">tpl</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> fst<span class="main">)</span> <span class="main">(</span>exec_gpv <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> return_spmf <span class="main">(</span><span class="bound">tpl</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>interceptor <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">D</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">D</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> connect_def exec_gpv_resource_of_oracle spmf.map_comp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> return_bind_spmf<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"OK <span class="main">(</span>OK <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_callee_eq_run_gpv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?I1.0</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?I2.0</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">UNIV</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trace_eq_intercept<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> trace_callee_eq_obsf_oracleI<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> trace_callee_eq_obsf_oracleI<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * pair_spmf_alt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> detach_sampler  <span class="main">=</span> this
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> advantage_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> spmf_obsf_distinguisher_obsf_resource_True<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> obsf_resource_of_oracle<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> detach_sampler pair_spmf_alt_def bind_map_spmf fact1 fact2<span class="main">)</span>
      <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ddh.advantage_def ddh.ddh_0_def ddh.ddh_1_def DH_adversary_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proving the trace-equivalence of simplified Ideal and Lazy constructions›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">isample_nat</span> <span class="main">≡</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">isample_key</span> <span class="main">≡</span> spmf_of_set <span class="main">(</span>carrier <span class="free">𝒢</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">isample_pair_nn</span> <span class="main">≡</span> pair_spmf isample_nat isample_nat"</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">isample_pair_nk</span> <span class="main">≡</span> pair_spmf isample_nat isample_key"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">S_il</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'grp</span> astate <span class="main">×</span> unit<span class="main">)</span> <span class="main">×</span> estate <span class="main">×</span> <span class="tfree">'grp</span> key.state<span class="main">)</span> spmf <span class="main">⇒</span> <span class="tfree">'grp</span> bc_state spmf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
<span class="comment1">― ‹(Auth1 =a)@(Auth2 =0)›</span>
    sil_0_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">(</span>EState_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.PState_Store<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Void<span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =0) \# wl›</span>
  <span class="main">|</span> sil_1_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">(</span>EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.PState_Store<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span>
  <span class="main">|</span> sil_2_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="bound">k</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> isample_key<span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =0) \# look›</span>
  <span class="main">|</span> sil_1'_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">(</span>EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.PState_Store<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> isample_nat<span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">yz</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> snd <span class="bound">yz</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">yz</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> isample_pair_nn<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> 
  <span class="main">|</span> sil_2'_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">yk</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">yk</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="main">(</span>snd <span class="bound">yk</span><span class="main">)</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> isample_pair_nk<span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">yz</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> snd <span class="bound">yz</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">yz</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> isample_pair_nn<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> 
<span class="comment1">― ‹(Auth1 =a)@(Auth2 =1)›</span>
  <span class="main">|</span> sil_0_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">(</span>EState_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.PState_Store<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Void<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =1) \# wl›</span>
  <span class="main">|</span> sil_1_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">(</span>EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.PState_Store<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span>
  <span class="main">|</span> sil_2_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span>  <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="bound">k</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span> isample_key<span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span> <span class="main">⟷</span> key.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span>
  <span class="main">|</span> sil_3_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">xy</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span>  <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">xy</span><span class="main">,</span>  <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> snd <span class="bound">xy</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> isample_pair_nn<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =1) \# look›</span>
  <span class="main">|</span> sil_1c_1c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">(</span>EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.PState_Store<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">z</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> isample_nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span>
  <span class="main">|</span> sil_2c_1c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span> <span class="main">⟷</span> key.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">∈</span> set_spmf isample_nat"</span></span>
  <span class="main">|</span> sil_3c_1c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
<span class="comment1">― ‹(Auth1 =a)@(Auth2 =2)›</span>
  <span class="main">|</span> sil_0_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="bound">k</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> isample_key<span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Void<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =2) \# wl›</span>
  <span class="main">|</span> sil_1_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="bound">k</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span> isample_key<span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span> <span class="main">⟷</span> key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Bob <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span>
  <span class="main">|</span> sil_2_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="bound">k</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span> isample_key<span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span> <span class="main">⟷</span> key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span> <span class="main">⟷</span> key.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span>
  <span class="main">|</span> sil_3_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">xy</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span>  <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">xy</span><span class="main">,</span>  <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> snd <span class="bound">xy</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> isample_pair_nn<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span> <span class="main">⟷</span> key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =2) \# look›</span>
  <span class="main">|</span> sil_1c_2c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span> <span class="main">⟷</span> key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Bob <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">∈</span> set_spmf isample_nat"</span></span>
  <span class="main">|</span> sil_2c_2c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span> <span class="main">⟷</span> key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span> <span class="main">⟷</span> key.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">∈</span> set_spmf isample_nat"</span></span>
  <span class="main">|</span> sil_3c_2c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span> <span class="main">⟷</span> key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
<span class="comment1">― ‹(Auth1 =a)@(Auth2 =3)›</span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =3) \# wl›</span>
  <span class="main">|</span> sil_1_3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">xy</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">xy</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> snd <span class="bound">xy</span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> isample_pair_nn<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Bob <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
  <span class="main">|</span> sil_2_3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">xy</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">xy</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> snd <span class="bound">xy</span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> isample_pair_nn<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span> <span class="main">⟷</span> key.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
  <span class="main">|</span> sil_3_3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">xy</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">xy</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> snd <span class="bound">xy</span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> isample_pair_nn<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =3) \# look›</span>
  <span class="main">|</span> sil_1c_3c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Bob <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
  <span class="main">|</span> sil_2c_3c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span> <span class="main">⟷</span> key.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
  <span class="main">|</span> sil_3c_3c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"auth.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"key.Bob <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_actk</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
<span class="comment1">― ‹(Auth1 =a)@(Auth2 =1')›</span>
  <span class="main">|</span> sil_0_1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">(</span>EState_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Store<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.PState_Store<span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> isample_nat<span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">xz</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> snd <span class="bound">xz</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">xz</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> CState_Void<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> isample_pair_nn<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> 
<span class="comment1">― ‹(Auth1 =a)@(Auth2 =2')›</span>
  <span class="main">|</span> sil_0_2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_il</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">xk</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">xk</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">(</span>EState_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> EState_Collect<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">,</span> key.State_Store <span class="main">(</span>snd <span class="bound">xk</span><span class="main">)</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> isample_pair_nk<span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">xz</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> snd <span class="bound">xz</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">xz</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> CState_Void<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> isample_pair_nn<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"auth.Alice <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span>"</span></span> 
  
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Diffie_Hellman_CC-trac_eq_core_il"><span class="command">lemma</span></span> trac_eq_core_il<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_core_eq  ideal_core' <span class="main">(</span>lazy_core DH1_sample<span class="main">)</span>
  <span class="main">(</span><span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">(</span><span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span>     
  <span class="main">(</span>return_spmf ideal_s_core'<span class="main">)</span> <span class="main">(</span>return_spmf basic_core_sinit<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> isample_key_conv_nat<span class="main">[</span><span class="operator">simplified</span> map_spmf_conv_bind_spmf<span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"map_spmf <span class="skolem">f</span> isample_key <span class="main">=</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> isample_nat"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">unfolding</span></span> sample_uniform_def carrier_conv_generator
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_of_set_inj_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_on_generator<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> spmf.map_comp o_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"weight_spmf isample_nat <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_carrier order_gt_0_iff_finite<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"weight_spmf isample_key <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> carrier_not_empty cyclic_group.finite_carrier cyclic_group_axioms<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mk_lossless isample_nat <span class="main">=</span> isample_nat"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_lossless_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mk_lossless isample_pair_nn <span class="main">=</span> isample_pair_nn"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_lossless_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mk_lossless isample_pair_nk <span class="main">=</span> isample_pair_nk"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_lossless_def<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> basic_core_helper_def basic_core_oracle_usr_def eleak_def DH1_sample_def
    Let_def split_def exec_gpv_bind spmf.map_comp o_def map_bind_spmf bind_map_spmf bind_spmf_const

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_core_eq_simI_upto<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">S_il</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> Init_OK
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ideal_s_core'_def einit_def sil_0_0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> POut_OK <span class="keyword2"><span class="keyword">for</span></span> sl sr query 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_usrs
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_usrs</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_alice <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_bob <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_chns
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_chns</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_chn1
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_chn1</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_shell
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_shell</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> a_alice <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> a_bob <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_chn2
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_chn2</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_shell
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_shell</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> a_alice <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> a_bob <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> PState_OK <span class="keyword2"><span class="keyword">for</span></span> sl sr query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_usrs
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_usrs</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_alice
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>26 <span class="skolem">s_act2</span> <span class="skolem">y</span> <span class="skolem">s_act1</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_0_1'<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def map_spmf_conv_bind_spmf<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bindI<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>27 <span class="skolem">s_act2</span> <span class="skolem">y</span> <span class="skolem">s_act1</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_0_2'<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def isample_key_conv_nat<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl_map<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_bob
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s_act1</span> <span class="skolem">x</span> <span class="skolem">s_act2</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_1'_0<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def map_spmf_conv_bind_spmf<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bindI<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">s_act1</span> <span class="skolem">x</span> <span class="skolem">s_act2</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_2'_0<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def isample_key_conv_nat<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl_map<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_chns
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_chns</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_auth1
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_auth1</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_shell
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_shell</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> a_alice <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> a_bob <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_auth2
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_auth2</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_shell
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_shell</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> a_alice <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> a_bob <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> AOut_OK <span class="keyword2"><span class="keyword">for</span></span> sl sr query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth1
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_auth1</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_lfe
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_lfe</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_look <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_spmf_const <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_fedit <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_spmf_const <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth2
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_auth2</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_lfe
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_lfe</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_look <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_spmf_const <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_fedit <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_spmf_const <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> AState_OK <span class="keyword2"><span class="keyword">for</span></span> sl sr query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth1
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_auth1</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_lfe
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_lfe</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_look
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_1_0<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bindI S_il.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_1_1<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def map_spmf_conv_bind_spmf pair_spmf_alt_def isample_key_conv_nat<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bindI<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span> <span class="skolem">s_actk</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_1_2<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def map_spmf_conv_bind_spmf pair_spmf_alt_def isample_key_conv_nat<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bindI S_il.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>20 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span> <span class="skolem">s_actk</span> <span class="skolem">k</span> <span class="skolem">z</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_1_3<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def map_spmf_conv_bind_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bindI S_il.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_fedit
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s_act1</span> <span class="skolem">x</span> <span class="skolem">s_act2</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_1'_0<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_1c_1c<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def isample_key_conv_nat<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_map S_il.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
              <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base trace_eq_simcl_map<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth2
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_auth2</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_lfe
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_lfe</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_look
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">s_act2</span> <span class="skolem">s_act1</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_0_1<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 3<span class="main"><span class="main">)</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bindI S_il.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_1_1<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 3<span class="main"><span class="main">)</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def map_spmf_conv_bind_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pair_spmf_alt_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_spmf_assoc<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_eq_simcl_bindI<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span> <span class="skolem">s_actk</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_2_1<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 3<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2 4<span class="main"><span class="main">)</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def map_spmf_conv_bind_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def isample_key_conv_nat<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bindI S_il.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span> <span class="skolem">s_actk</span> <span class="skolem">k</span> <span class="skolem">z</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_3_1<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_spmf_const <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def map_spmf_conv_bind_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bindI S_il.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_spmf_const <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="keyword3">,</span></span> 
              <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_fedit
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_1c_1c<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf pair_spmf_alt_def isample_key_conv_nat<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl_map<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>26 <span class="skolem">s_act2</span> <span class="skolem">y</span> <span class="skolem">s_act1</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_0_1'<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
              <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base trace_eq_simcl_map<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> UOut_OK <span class="keyword2"><span class="keyword">for</span></span> sl sr query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_alice
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def isample_key_conv_nat<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_bob
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def isample_key_conv_nat<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> UState_OK <span class="keyword2"><span class="keyword">for</span></span> sl sr query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_alice
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span> <span class="skolem">s_actk</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_1_2<span class="antiquote">}</span></span>›</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>15 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span> <span class="skolem">s_actk</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_2_2<span class="antiquote">}</span></span>›</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base trace_eq_simcl_map<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_bob
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_il.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span> <span class="skolem">s_actk</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_2_1<span class="antiquote">}</span></span>›</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_bind_conv_pair_spmf<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>15 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span> <span class="skolem">s_actk</span><span class="main">)</span>  <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] sil_2_2<span class="antiquote">}</span></span>›</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bind_bind_conv_pair_spmf<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_il.intros trace_eq_simcl.base trace_eq_simcl_map<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Diffie_Hellman_CC-connect_ideal"><span class="command">lemma</span></span> connect_ideal<span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="free">D</span> <span class="main">(</span>obsf_resource ideal_resource<span class="main">)</span> <span class="main">=</span> 
  connect <span class="free">D</span> <span class="main">(</span>obsf_resource <span class="main">(</span>RES <span class="main">(</span>fused_resource.fuse <span class="main">(</span>lazy_core DH1_sample<span class="main">)</span> lazy_rest<span class="main">)</span> <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fact1<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_rest_eq ideal_rest' ideal_rest' UNIV UNIV <span class="skolem">s</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_rest'_into_trace_rest_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def rel_rest'_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> fact2<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full <span class="keyword1">⊢c</span> callee_of_rest ideal_rest' <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">call</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main"><span class="keyword3">,</span></span>  <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> fact3<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊢c</span> callee_of_core ideal_core' <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">call</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main"><span class="keyword3">,</span></span>  <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> fact4<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊢c</span> callee_of_core <span class="main">(</span>lazy_core <span class="skolem">xyz</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xyz</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">call</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main"><span class="keyword3">,</span></span>  <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> connect_cong_trace<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"UNIV"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_eq_obsf_resourceI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_ideal<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fuse_trace_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐE<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐCA<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐCU<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐRA<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐRU<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ideal_s_rest'_def lazy_rest_def trac_eq_core_il<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> fact1 fact2 fact3 fact4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_ideal<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proving the trace-equivalence of simplified Real and Lazy constructions›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">rsample_nat</span> <span class="main">≡</span> sample_uniform <span class="main">(</span>order <span class="free">𝒢</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">rsample_pair_nn</span> <span class="main">≡</span> pair_spmf rsample_nat rsample_nat"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">S_rl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>unit <span class="main">×</span> <span class="tfree">'grp</span> cstate <span class="main">×</span> <span class="tfree">'grp</span> cstate<span class="main">)</span> <span class="main">×</span> <span class="tfree">'grp</span> auth.state <span class="main">×</span> <span class="tfree">'grp</span> auth.state<span class="main">)</span> spmf
  <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'grp</span> st_state <span class="main">×</span> <span class="tfree">'grp</span> cstate <span class="main">×</span> <span class="tfree">'grp</span> cstate<span class="main">)</span> <span class="main">×</span>  <span class="tfree">'grp</span> auth.state <span class="main">×</span> <span class="tfree">'grp</span> auth.state<span class="main">)</span> spmf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
<span class="comment1">― ‹(Auth1 =a)@(Auth2 =0)›</span>
    srl_0_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Void<span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Void<span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =0) \# wl›</span>
  <span class="main">|</span> srl_1_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="bound">x</span><span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> rsample_nat<span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> srl_2_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="bound">x</span><span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> rsample_nat<span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =0) \# look›</span>
  <span class="main">|</span> srl_1'_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> rsample_nat<span class="main">)</span>"</span></span>
  <span class="main">|</span> srl_2'_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Void<span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> rsample_nat<span class="main">)</span>"</span></span>
<span class="comment1">― ‹(Auth1 =a)@(Auth2 =1)›</span>
  <span class="main">|</span> srl_0_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Void<span class="main">,</span> CState_Half <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> rsample_nat<span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Void<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =1) \# wl›</span>
  <span class="main">|</span> srl_1_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">yx</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="main">(</span>snd <span class="bound">yx</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">(</span>fst <span class="bound">yx</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> snd <span class="bound">yx</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">yx</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> rsample_pair_nn<span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> srl_2_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">yx</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="main">(</span>snd <span class="bound">yx</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">(</span>fst <span class="bound">yx</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> snd <span class="bound">yx</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">yx</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> rsample_pair_nn<span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =1) \# look›</span>
  <span class="main">|</span> srl_1c_1c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> srl_2c_1c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> srl_3c_1c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> CState_Full <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="comment1">― ‹(Auth1 =a)@(Auth2 =2)›</span>
  <span class="main">|</span> srl_0_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Void<span class="main">,</span> CState_Half <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> rsample_nat<span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Void<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =2) \# wl›</span>
  <span class="main">|</span> srl_1_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">yx</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="main">(</span>snd <span class="bound">yx</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">(</span>fst <span class="bound">yx</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> snd <span class="bound">yx</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">yx</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> rsample_pair_nn<span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> srl_2_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">yx</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="main">(</span>snd <span class="bound">yx</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">(</span>fst <span class="bound">yx</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> snd <span class="bound">yx</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> fst <span class="bound">yx</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> rsample_pair_nn<span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>None<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹../(Auth1 =a)@(Auth2 =2) \# look›</span>
  <span class="main">|</span> srl_1c_2c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> srl_2c_2c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> srl_3c_2c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> CState_Full <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="comment1">― ‹(Auth1 =a)@(Auth2 =3)›</span>
  <span class="main">|</span> srl_1c_3c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="main">|</span> srl_2c_3c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span><span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="main">|</span> srl_3c_3c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">,</span> CState_Full <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">𝟭</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collected<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="comment1">― ‹(Auth1 =0)@(Auth2 =1')›</span>  
  <span class="main">|</span> srl_0_1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Void<span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">)</span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> CState_Void<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Store <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> rsample_nat<span class="main">)</span>"</span></span>
<span class="comment1">― ‹(Auth1 =0)@(Auth2 =2')›</span>
  <span class="main">|</span> srl_0_2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_rl</span> <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> CState_Void<span class="main">,</span> CState_Half <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Some <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">)</span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">,</span> <span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> CState_Void<span class="main">,</span> CState_Half <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>auth.State_Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act1</span></span></span><span class="main">)</span><span class="main">,</span> auth.State_Collect <span class="main">𝟭</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s_act2</span></span></span><span class="main">)</span><span class="main">)</span> rsample_nat<span class="main">)</span>"</span></span>


<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Diffie_Hellman_CC-trac_eq_core_rl"><span class="command">lemma</span></span> trac_eq_core_rl<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_core_eq real_core' <span class="main">(</span>basic_core DH0_sample<span class="main">)</span>
  <span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">(</span><span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">(</span><span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> 
  <span class="main">(</span>return_spmf real_s_core'<span class="main">)</span> <span class="main">(</span>return_spmf basic_core_sinit<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> power_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_pow mult.commute<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"weight_spmf rsample_nat <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_carrier order_gt_0_iff_finite<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mk_lossless rsample_nat <span class="main">=</span> rsample_nat"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_lossless_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mk_lossless rsample_pair_nn <span class="main">=</span> rsample_pair_nn"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_lossless_def<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> basic_core_oracle_usr_def basic_core_helper_def
    exec_gpv_bind spmf.map_comp map_bind_spmf bind_map_spmf bind_spmf_const o_def Let_def split_def

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trace_core_eq_simI_upto<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">S_rl</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> Init_OK 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_s_core'_def srl_0_0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> POut_OK <span class="keyword2"><span class="keyword">for</span></span> s_l s_r query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_auth1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_auth1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_auth2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_auth2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> PState_OK <span class="keyword2"><span class="keyword">for</span></span> s_l s_r query
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_auth1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_auth1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_rl.intros trace_eq_simcl.base<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e_auth2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e_auth2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_rl.intros trace_eq_simcl.base<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> AOut_OK <span class="keyword2"><span class="keyword">for</span></span> sl sr q  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth1
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_auth1</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_lfe
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_lfe</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_look <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def pair_spmf_alt_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_fedit <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_fedit</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def pair_spmf_alt_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth2
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_auth2</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_lfe
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_lfe</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_look <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def pair_spmf_alt_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_fedit <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_fedit</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def pair_spmf_alt_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> AState_OK <span class="keyword2"><span class="keyword">for</span></span> sl sr q s1 s2 s1' s2' oa 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth1
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_auth1</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_lfe
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_lfe</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_look
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_1_0<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s1'</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def trace_eq_simcl.base S_rl.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_1'_0<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_rl.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_1_1<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def pair_spmf_alt_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def trace_eq_simcl_map S_rl.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>13 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_1_2<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def pair_spmf_alt_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def trace_eq_simcl_map S_rl.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_rl.intros<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_fedit
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_fedit</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_rl.intros<span class="main">)</span>            
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_auth2
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_auth2</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_lfe
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_lfe</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_look
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_0_1<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def trace_eq_simcl.base S_rl.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_1_1<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def trace_eq_simcl_map S_rl.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_2_1<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_pair_spmf1<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> map_prod_def split_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3 4<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def trace_eq_simcl_map S_rl.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>21 <span class="skolem">y</span> <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_0_1'<span class="antiquote">}</span></span>›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_rl.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_rl.intros<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_fedit
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_fedit</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_rl.intros<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> UOut_OK <span class="keyword2"><span class="keyword">for</span></span> sl sr q  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_usr</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_alice <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def pair_spmf_alt_def power_commute<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_bob <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf apfst_def DH0_sample_def power_commute <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_act
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_act</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_alice
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_gpv_bind_gpv exec_gpv_parallel_oracle_left map_gpv_bind_gpv gpv.map_id map_gpv'_bind_gpv map'_lift_spmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_bob
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_gpv_bind_gpv exec_gpv_parallel_oracle_right map_gpv_bind_gpv gpv.map_id map_gpv'_bind_gpv map'_lift_spmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> UState_OK <span class="keyword2"><span class="keyword">for</span></span> sl sr q  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_usr
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_usr</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_alice
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>13 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_1_2<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def pair_spmf_alt_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bind S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_2_2<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def pair_spmf_alt_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bind S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_bob
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_2_1<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf power_commute<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bind S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_2_2<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DH0_sample_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf power_commute<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_bind<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trace_eq_simcl_bind S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q_act
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q_act</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a_alice
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_0_0<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_gpv_bind_gpv pair_spmf_alt_def map_gpv_bind_gpv gpv.map_id map_gpv'_bind_gpv map'_lift_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_0_1<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_gpv_bind_gpv pair_spmf_alt_def map_gpv_bind_gpv gpv.map_id map_gpv'_bind_gpv map'_lift_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>12 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_0_2<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_gpv_bind_gpv pair_spmf_alt_def map_gpv_bind_gpv gpv.map_id map_gpv'_bind_gpv map'_lift_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>21 <span class="skolem">y</span> <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_0_2'<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_gpv_bind_gpv pair_spmf_alt_def map_gpv_bind_gpv gpv.map_id map_gpv'_bind_gpv map'_lift_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl_map S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>22 <span class="skolem">y</span> <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_0_1'<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_gpv_bind_gpv pair_spmf_alt_def map_gpv_bind_gpv gpv.map_id map_gpv'_bind_gpv map'_lift_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl_map S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a_bob
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> S_rl.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_0_0<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_gpv_bind_gpv pair_spmf_alt_def map_gpv_bind_gpv gpv.map_id map_gpv'_bind_gpv map'_lift_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_1_0<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_gpv_bind_gpv pair_spmf_alt_def map_gpv_bind_gpv gpv.map_id map_gpv'_bind_gpv map'_lift_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_2_0<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_gpv_bind_gpv pair_spmf_alt_def map_gpv_bind_gpv gpv.map_id map_gpv'_bind_gpv map'_lift_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_bind_conv_pair_spmf<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl.base S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_1'_0<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_gpv_bind_gpv pair_spmf_alt_def map_gpv_bind_gpv gpv.map_id map_gpv'_bind_gpv map'_lift_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl_map S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">x</span> <span class="skolem">s_act1</span> <span class="skolem">s_act2</span><span class="main">)</span> <span class="comment1">― ‹Corresponds to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] srl_2'_0<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_gpv_bind_gpv pair_spmf_alt_def map_gpv_bind_gpv gpv.map_id map_gpv'_bind_gpv map'_lift_spmf <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_eq_simcl_map S_rl.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Diffie_Hellman_CC-trace_eq_fuse_rl"><span class="command">lemma</span></span> trace_eq_fuse_rl<span class="main">:</span> <span class="quoted"><span class="quoted">"UNIV <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊳</span> RES <span class="main">(</span>fused_resource.fuse real_core' real_rest'<span class="main">)</span> <span class="main">(</span>real_s_core'<span class="main">,</span> real_s_rest'<span class="main">)</span>
  <span class="main">≈</span> RES <span class="main">(</span>fused_resource.fuse <span class="main">(</span>lazy_core DH0_sample<span class="main">)</span> lazy_rest<span class="main">)</span> <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fact1<span class="main">:</span> <span class="quoted"><span class="quoted">"UNIV <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊳</span> RES <span class="main">(</span>fused_resource.fuse <span class="main">(</span>basic_core DH0_sample<span class="main">)</span> basic_rest<span class="main">)</span> <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span> <span class="main">∼</span> 
    RES <span class="main">(</span>fused_resource.fuse <span class="main">(</span>lazy_core DH0_sample<span class="main">)</span> lazy_rest<span class="main">)</span> <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊢res</span> RES <span class="main">(</span>fused_resource.fuse <span class="main">(</span>basic_core DH0_sample<span class="main">)</span> basic_rest<span class="main">)</span> <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_resource_of_oracle<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> WT_calleeI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">call</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> y<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">y</span></span></span></span></span></span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fused_resource.fuse.simps parallel_eoracle_def<span class="main">)</span>

    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>  exec_gpv_bind spmf.map_comp o_def map_bind_spmf bind_map_spmf bind_spmf_const

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> attach_wiring_resource_of_oracle<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wiring_parallel_converter2 wiring_id_converter<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span><span class="main"><span class="main">]</span></span> wiring_rassocl<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">ℐ_full</span> <span class="quoted">ℐ_full</span> <span class="quoted">ℐ_full</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_resource_on_resource_of_oracleI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_on_def <span class="dynamic"><span class="dynamic">relator_eq</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> fuse_ishift_core_to_rest<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> core<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"basic_core DH0_sample"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> rest<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">basic_rest</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> core'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"lazy_core DH0_sample"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> 
            rest'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">lazy_rest</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> fn<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">basic_core_helper</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> h_out<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Out_Activation_Alice<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Out_Activation_Bob<span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_rest_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> apply_comp_wiring<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_wiring_def parallel2_wiring_def split_def sum.map_comp lassocr<span class="hidden">⇩</span><sub>w</sub>_def rassocl<span class="hidden">⇩</span><sub>w</sub>_def id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sum.map_id<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> fact2<span class="main">:</span> <span class="quoted"><span class="quoted">"UNIV <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊳</span> RES <span class="main">(</span>fused_resource.fuse real_core' real_rest'<span class="main">)</span> <span class="main">(</span>real_s_core'<span class="main">,</span> real_s_rest'<span class="main">)</span> <span class="main">≈</span>
    <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊳</span> RES <span class="main">(</span>fused_resource.fuse <span class="main">(</span>basic_core DH0_sample<span class="main">)</span> basic_rest<span class="main">)</span> <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">_</span> <span class="main">⊳</span> RES <span class="var">?L</span> <span class="var">?s_l</span> <span class="main">≈</span> <span class="main">_</span> <span class="main">⊳</span> RES <span class="var">?R</span> <span class="var">?s_r</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace_rest_eq basic_rest basic_rest UNIV UNIV <span class="skolem">s</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_rest'_into_trace_rest_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def rel_rest'_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full <span class="keyword1">⊢c</span> callee_of_rest basic_rest <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command">unfolding</span></span> callee_of_core_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">call</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main"><span class="keyword3">,</span></span>  <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊢c</span>  callee_of_core <span class="main">(</span>basic_core DH0_sample<span class="main">)</span> <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command">unfolding</span></span> callee_of_core_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">call</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main"><span class="keyword3">,</span></span>  <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊢c</span>  callee_of_core real_core' <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command">unfolding</span></span> callee_of_core_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">call</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main"><span class="keyword3">,</span></span>  <span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> loc<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?L</span><span class="main">(</span><span class="var">?s_l</span><span class="main">)</span> <span class="main">≈</span> <span class="var">?R</span><span class="main">(</span><span class="var">?s_r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fuse_trace_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐE<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐCA<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span>  ℐCU<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐRA<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐRU<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> outs_plus_ℐ outs_ℐ_full<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_rest'_def real_s_rest'_def trac_eq_core_rl<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> attach_trace_eq'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐ'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> outs_plus_ℐ outs_ℐ_full<span class="main"><span class="main">]</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> trace_eq'_resource_of_oracle<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> loc<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WT_converter_ℐ_full<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fact2<span class="main">[</span><span class="operator">simplified</span> eq_resource_on_UNIV_D<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fact1<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Diffie_Hellman_CC-connect_real"><span class="command">lemma</span></span> connect_real<span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="free">D</span> <span class="main">(</span>obsf_resource real_resource<span class="main">)</span> <span class="main">=</span> connect <span class="free">D</span> <span class="main">(</span>obsf_resource <span class="main">(</span>RES <span class="main">(</span>fused_resource.fuse <span class="main">(</span>lazy_core DH0_sample<span class="main">)</span> lazy_rest<span class="main">)</span> <span class="main">(</span>basic_core_sinit<span class="main">,</span> basic_rest_sinit<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊢res</span> real_resource <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊢res</span> RES <span class="main">(</span>fused_resource.fuse real_core' real_rest'<span class="main">)</span> <span class="main">(</span>real_s_core'<span class="main">,</span> real_s_rest'<span class="main">)</span> <span class="main">√</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_resource_of_oracle<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s q
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s_cnv_core _ _ _ _ y
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s_cnv_core</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> s_cnvs s_auth1 s_kern2 s_shell2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s_auth1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> s_kern1 s_shell1<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s_cnvs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> su s_cnv1 s_cnv2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> z<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">z</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> query<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fused_resource.fuse.simps split_def apfst_def<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">s_cnv1</span><span class="main">,</span> Inl <span class="improper">query</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alice_callee.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits auth.ousr_bob.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def o_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">s_cnv2</span><span class="main">,</span> Inl <span class="improper">query</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bob_callee.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits auth.ousr_bob.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def o_def<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">s_cnv1</span><span class="main">,</span> Inr <span class="improper">query</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alice_callee.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits 
              <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def o_def map_gpv_bind_gpv left_gpv_bind_gpv map_gpv'_bind_gpv exec_gpv_bind<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">s_cnv2</span><span class="main">,</span> Inr <span class="improper">query</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bob_callee.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits 
              <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def o_def map_gpv_bind_gpv right_gpv_bind_gpv map_gpv'_bind_gpv exec_gpv_bind<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fused_resource.fuse.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> attach_real
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_resource_attach<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_converter_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_converter_parallel_converter2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_full_le_plus_ℐ<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> trace_eq_obsf_resourceI<span class="main">[</span><span class="operator">OF</span> trace_eq_fuse_rl<span class="main">,</span> <span class="operator">folded</span> attach_real<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> connect_cong_trace<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"UNIV"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_obsf_resource<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">ℐ_full</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> exception_ℐ_full<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Concrete security›</span></span>

<span class="keyword1"><span class="command">context</span></span> diffie_hellman <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">auth1_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'auth1_s_rest</span><span class="main">,</span> auth.event<span class="main">,</span> <span class="tfree">'auth1_iadv_rest</span><span class="main">,</span> <span class="tfree">'auth1_iusr_rest</span><span class="main">,</span> <span class="tfree">'auth1_oadv_rest</span><span class="main">,</span> <span class="tfree">'auth1_ousr_rest</span><span class="main">)</span> rest_wstate"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="free">auth2_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'auth2_s_rest</span><span class="main">,</span> auth.event<span class="main">,</span> <span class="tfree">'auth2_iadv_rest</span><span class="main">,</span> <span class="tfree">'auth2_iusr_rest</span><span class="main">,</span> <span class="tfree">'auth2_oadv_rest</span><span class="main">,</span> <span class="tfree">'auth2_ousr_rest</span><span class="main">)</span> rest_wstate"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ℐ_adv_rest1</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_adv_rest2</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_usr_rest1</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_usr_rest2</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">I_auth1_rest</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">I_auth2_rest</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    WT_auth1_rest <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_rest1</span> <span class="free">ℐ_usr_rest1</span> <span class="free">I_auth1_rest</span> <span class="free">auth1_rest</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WT_auth2_rest <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_rest2</span> <span class="free">ℐ_usr_rest2</span> <span class="free">I_auth2_rest</span> <span class="free">auth2_rest</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> secure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>auth.Inp_Fedit <span class="main">`</span> <span class="main">(</span>carrier <span class="free">𝒢</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>auth.Inp_Fedit <span class="main">`</span> <span class="main">(</span>carrier <span class="free">𝒢</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv_rest1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_rest2</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common</span> <span class="main">≡</span> <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>key.Out_Alice <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>key.Out_Bob <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_usr_rest1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_rest2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="main">≡</span> ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv_rest1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_rest2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf 
      <span class="main">(</span>real_resource <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span>
      <span class="main">(</span>key.resource <span class="main">(</span>ideal_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">sim</span> <span class="main">=</span> CNV sim_callee None <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">)</span> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span><span class="main">)</span>
      <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span> 
      <span class="main">(</span>ddh.advantage <span class="free">𝒢</span> <span class="main">(</span>DH_adversary <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="free">auth1_rest</span> <span class="free">auth2_rest</span> <span class="free">𝒜</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sim</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">let</span> <span class="bound">sim</span> <span class="main">=</span> CNV sim_callee None <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">)</span> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>auth.Inp_Fedit <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span>
    <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>auth.Inp_Fedit <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">,</span> ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CNV sim_callee <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s q r s'<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">s</span><span class="main">,</span> <span class="improper">q</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sim_callee.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="keyword1">⊢res</span> real_resource <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="free">auth1_rest</span> <span class="free">auth2_rest</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform UNIV <span class="main">(</span>key.Out_Alice <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">,</span> ℐ_uniform <span class="main">(</span>auth.Inp_Send <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>auth.Out_Recv <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span>  CNV alice_callee CState_Void <span class="main">√</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee_invar<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"pred_cstate <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="free">𝒢</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s q  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alice_callee.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> auth.ousr_bob.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s q  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alice_callee.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm auth.ousr_bob.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform UNIV <span class="main">(</span>key.Out_Bob <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">,</span> ℐ_uniform UNIV <span class="main">(</span>auth.Out_Recv <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>auth.Inp_Send <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span> UNIV <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span>  CNV bob_callee CState_Void <span class="main">√</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee_invar<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"pred_cstate <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier <span class="free">𝒢</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s q  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bob_callee.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> auth.ousr_bob.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s q  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bob_callee.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> auth.ousr_bob.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ℐ_real_def ℐ_common_def real_resource_def Let_def fused_wiring_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="keyword1">⊢res</span> key.resource <span class="main">(</span>ideal_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ℐ_ideal_def ℐ_common_def key.resource_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">kernel</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s12</span><span class="main">)</span><span class="main">.</span> key.set_s_kernel <span class="bound">kernel</span> <span class="main">⊆</span> carrier <span class="free">𝒢</span> <span class="main">∧</span> pred_prod <span class="free">I_auth1_rest</span> <span class="free">I_auth2_rest</span> <span class="bound">s12</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WT_restD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth1_rest<span class="main"><span class="main">]</span></span> WT_restD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth2_rest<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s q
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ideal_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">,</span> <span class="skolem">s</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> key.fuse.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> translate_eoracle_def parallel_eoracle_def plus_eoracle_def<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_restD_rfunc_adv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth1_rest<span class="main"><span class="main">]</span></span> WT_restD_rfunc_adv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth2_rest<span class="main"><span class="main">]</span></span>
          WT_restD_rfunc_usr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth1_rest<span class="main"><span class="main">]</span></span> WT_restD_rfunc_usr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth2_rest<span class="main"><span class="main">]</span></span> key.foldl_poke_invar<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> key.foldl_poke_invar <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> plus_oracle_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y s'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> translate_eoracle_def parallel_eoracle_def plus_eoracle_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_restD_rfunc_adv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth1_rest<span class="main"><span class="main">]</span></span> WT_restD_rfunc_adv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth2_rest<span class="main"><span class="main">]</span></span>
          WT_restD_rfunc_usr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth1_rest<span class="main"><span class="main">]</span></span> WT_restD_rfunc_usr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth2_rest<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xa</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?sim</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ℐ_real_def ℐ_ideal_def Let_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pfinite_converter <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="var">?sim</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">pfinite_intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"pfinite_converter <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>auth.Inp_Fedit <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span>
      <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>auth.Inp_Fedit <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="main">(</span>CNV sim_callee <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> raw_converter_invariant.pfinite_converter_of_callee<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s1 s2
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span> <span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sim_callee.cases<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.splits if_splits option.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s2 s1  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s1</span><span class="main">,</span> <span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sim_callee.cases<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ℐ_real_def ℐ_ideal_def Let_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> ddh.advantage <span class="free">𝒢</span> <span class="main">(</span>diffie_hellman.DH_adversary <span class="free">𝒢</span> <span class="free">auth1_rest</span> <span class="free">auth2_rest</span> <span class="free">𝒜</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ddh.advantage_def<span class="main">)</span>

  <span class="keyword3"><span class="command">assume</span></span> WT <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"advantage <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="var">?sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> key.resource <span class="main">(</span>ideal_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>obsf_resource <span class="main">(</span>real_resource <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> ddh.advantage <span class="free">𝒢</span> <span class="main">(</span>diffie_hellman.DH_adversary <span class="free">𝒢</span> <span class="free">auth1_rest</span> <span class="free">auth2_rest</span> <span class="free">𝒜</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> id_split<span class="main">[</span><span class="operator">unfolded</span> Let_def<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="var">?sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> key.resource <span class="main">(</span>ideal_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      connect <span class="free">𝒜</span> <span class="main">(</span>obsf_resource <span class="main">(</span><span class="var">?sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> key.resource <span class="main">(</span>ideal_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"connect <span class="main">_</span> <span class="var">?L</span> <span class="main">=</span> connect <span class="main">_</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">unfolded</span> ℐ_ideal_def<span class="main">,</span> <span class="operator">WT_intro</span><span class="main">]</span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">ℐ_real</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?sim</span> <span class="main">√</span>›</span></span> 
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">unfolded</span> ℐ_ideal_def<span class="main">,</span> <span class="operator">WT_intro</span><span class="main">]</span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">ℐ_ideal</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="keyword1">⊢res</span> key.resource <span class="main">(</span>ideal_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span> <span class="main">√</span>›</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv_rest1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_rest2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_usr_rest1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_rest2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s12</span><span class="main">)</span><span class="main">.</span> pred_prod <span class="free">I_auth1_rest</span> <span class="free">I_auth2_rest</span> <span class="bound">s12</span><span class="main">)</span>
       <span class="main">(</span>ideal_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WT_rest.intros<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s q
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> translate_eoracle_def parallel_eoracle_def<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span>  WT_restD_rfunc_adv<span class="main">[</span><span class="operator">OF</span> WT_auth1_rest<span class="main">]</span> WT_restD_rfunc_adv<span class="main">[</span><span class="operator">OF</span> WT_auth2_rest<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s q
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> translate_eoracle_def parallel_eoracle_def plus_eoracle_def<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span>  WT_restD_rfunc_usr<span class="main">[</span><span class="operator">OF</span> WT_auth1_rest<span class="main">]</span> WT_restD_rfunc_usr<span class="main">[</span><span class="operator">OF</span> WT_auth2_rest<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WT_restD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth1_rest<span class="main"><span class="main">]</span></span> WT_restD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_auth2_rest<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="main">(</span>exception_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="var">?L</span> <span class="main">∼</span> <span class="var">?R</span>"</span></span>        
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> obsf_resource_eq_ℐ_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_ℐ_attach_on'<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> parallel_converter2_eq_ℐ_cong<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="free">ℐ_real</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?sim</span> <span class="main">√</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> assms Let_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_sym<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_converter2_id_id<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_real_def ℐ_common_def<span class="main">)</span>  

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> * connect_eq_resource_cong <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> advantage_def Let_def id_split
      <span class="keyword1"><span class="command">unfolding</span></span> Let_def connect_real connect_ideal<span class="main">[</span><span class="operator">unfolded</span> ideal_resource_def Let_def<span class="main">]</span> reduction<span class="main">[</span><span class="operator">unfolded</span> advantage_def<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Asymptotic security›</span></span>

<span class="keyword1"><span class="command">locale</span></span> diffie_hellman' <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">𝒢</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="tfree">'grp</span> cyclic_group"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> diffie_hellman <span class="main">[</span><span class="operator">locale_witness</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> diffie_hellman <span class="main">(</span><span class="free">𝒢</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> diffie_hellman <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">η</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_resource'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">real_resource'</span> <span class="free"><span class="bound"><span class="entity">rest1</span></span></span> <span class="free"><span class="bound"><span class="entity">rest2</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">=</span> real_resource <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rest1</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rest2</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ideal_resource'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ideal_resource'</span> <span class="free"><span class="bound"><span class="entity">rest1</span></span></span> <span class="free"><span class="bound"><span class="entity">rest2</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">=</span> key.resource <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">(</span>ideal_rest <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rest1</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rest2</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sim'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sim'</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">sim</span> <span class="main">=</span> CNV <span class="main">(</span>sim_callee <span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">)</span> None <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">)</span> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">auth1_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'auth1_s_rest</span><span class="main">,</span> auth.event<span class="main">,</span> <span class="tfree">'auth1_iadv_rest</span><span class="main">,</span> <span class="tfree">'auth1_iusr_rest</span><span class="main">,</span> <span class="tfree">'auth1_oadv_rest</span><span class="main">,</span> <span class="tfree">'auth1_ousr_rest</span><span class="main">)</span> rest_wstate"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    <span class="free">auth2_rest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'auth2_s_rest</span><span class="main">,</span> auth.event<span class="main">,</span> <span class="tfree">'auth2_iadv_rest</span><span class="main">,</span> <span class="tfree">'auth2_iusr_rest</span><span class="main">,</span> <span class="tfree">'auth2_oadv_rest</span><span class="main">,</span> <span class="tfree">'auth2_ousr_rest</span><span class="main">)</span> rest_wstate"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ℐ_adv_rest1</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_adv_rest2</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_usr_rest1</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_usr_rest2</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">I_auth1_rest</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">I_auth2_rest</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    WT_auth1_rest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> WT_rest <span class="main">(</span><span class="free">ℐ_adv_rest1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_usr_rest1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">I_auth1_rest</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">auth1_rest</span> <span class="bound">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WT_auth2_rest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> WT_rest <span class="main">(</span><span class="free">ℐ_adv_rest2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_usr_rest2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">I_auth2_rest</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">auth2_rest</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> secure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>auth.Inp_Fedit <span class="main">`</span> <span class="main">(</span>carrier <span class="main">(</span><span class="free">𝒢</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>auth.Inp_Fedit <span class="main">`</span> <span class="main">(</span>carrier <span class="main">(</span><span class="free">𝒢</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv_rest1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_rest2</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>key.Out_Alice <span class="main">`</span> carrier <span class="main">(</span><span class="free">𝒢</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>key.Out_Bob <span class="main">`</span> carrier <span class="main">(</span><span class="free">𝒢</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_usr_rest1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_rest2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv_rest1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_rest2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> DDH<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ddh.advantage <span class="main">(</span><span class="free">𝒢</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>DH_adversary <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="bound">η</span> <span class="main">(</span><span class="free">auth1_rest</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">auth2_rest</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒜</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf' <span class="main">(</span>real_resource' <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span> <span class="main">(</span>ideal_resource' <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span> sim' <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="free">𝒜</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf'I<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"constructive_security_obsf <span class="main">(</span>real_resource' <span class="free">auth1_rest</span> <span class="free">auth2_rest</span> <span class="skolem">η</span><span class="main">)</span>
          <span class="main">(</span>ideal_resource' <span class="free">auth1_rest</span> <span class="free">auth2_rest</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>sim' <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span>
          <span class="main">(</span><span class="free">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>ddh.advantage <span class="main">(</span><span class="free">𝒢</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>DH_adversary <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">_</span><span class="main">)</span> <span class="skolem">η</span> <span class="main">(</span><span class="free">auth1_rest</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">auth2_rest</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒜</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_resource'_def ideal_resource'_def sim'_def ℐ_real_def ℐ_common_def ℐ_ideal_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> secure<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> WT_auth1_rest WT_auth2_rest<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">rule</span> DDH<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DH_OTP">
<div class="head">
<h1>Theory DH_OTP</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> DH_OTP <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#One_Time_Pad">One_Time_Pad</a>
  <a href="#Diffie_Hellman_CC">Diffie_Hellman_CC</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We need both a group structure and a boolean algebra.
  Unfortunately, records allow only one extension slot, so we can't have just a single
  structure with both operations.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> diffie_hellman <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="DH_OTP-WT_ideal_rest"><span class="command">lemma</span></span> WT_ideal_rest <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT_auth1_rest <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_rest1</span> <span class="free">ℐ_usr_rest1</span> <span class="free">I_auth1_rest</span> <span class="free">auth1_rest</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_auth2_rest <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_rest2</span> <span class="free">ℐ_usr_rest2</span> <span class="free">I_auth2_rest</span> <span class="free">auth2_rest</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv_rest1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_rest2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_usr_rest1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_rest2</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> pred_prod <span class="free">I_auth1_rest</span> <span class="free">I_auth2_rest</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ideal_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_rest.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> translate_eoracle_def parallel_eoracle_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> WT_restD_rfunc_adv<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> translate_eoracle_def parallel_eoracle_def plus_eoracle_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> WT_restD_rfunc_usr<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_sum_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> WT_restD_rinit<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> dh_otp <span class="main">=</span> dh<span class="main">:</span> diffie_hellman <span class="quoted"><span class="free">𝒢</span></span> <span class="main">+</span> otp<span class="main">:</span> one_time_pad <span class="quoted"><span class="free">ℒ</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒢</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> cyclic_group"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℒ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> boolean_algebra"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> carrier_𝒢_ℒ<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="free">𝒢</span> <span class="main">=</span> carrier <span class="free">ℒ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> secure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_resta</span> <span class="free">ℐ_usr_resta</span> <span class="free">I_auth_rest</span> <span class="free">auth_rest</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_rest1</span> <span class="free">ℐ_usr_rest1</span> <span class="free">I_auth1_rest</span> <span class="free">auth1_rest</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"WT_rest <span class="free">ℐ_adv_rest2</span> <span class="free">ℐ_usr_rest2</span> <span class="free">I_auth2_rest</span> <span class="free">auth2_rest</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"constructive_security_obsf
      <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> wiring_c1r22_c1r22 <span class="main">(</span>CNV otp.enc_callee <span class="main">()</span><span class="main">)</span> <span class="main">(</span>CNV otp.dec_callee <span class="main">()</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span>
       fused_wiring <span class="main">⊳</span> diffie_hellman.real_resource <span class="free">𝒢</span> <span class="free">auth1_rest</span> <span class="free">auth2_rest</span> <span class="main">∥</span> dh.auth.resource <span class="free">auth_rest</span><span class="main">)</span>
      <span class="main">(</span>otp.sec.resource <span class="main">(</span>otp.ideal_rest <span class="main">(</span>dh.ideal_rest <span class="free">auth1_rest</span> <span class="free">auth2_rest</span><span class="main">)</span> <span class="free">auth_rest</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊙</span>
        <span class="main">(</span>parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">let</span> <span class="bound">sim</span> <span class="main">=</span> CNV dh.sim_callee None <span class="keyword1">in</span> <span class="main">(</span><span class="bound">sim</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring<span class="main">)</span> <span class="main">⊙</span>
        <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span>
       <span class="main">(</span>otp.sim <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>otp.sec.Inp_Fedit <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span>
         <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>otp.sec.Inp_Fedit <span class="main">`</span> carrier <span class="free">𝒢</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span>
        <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>otp.sec.Inp_Fedit <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span>
       <span class="main">(</span><span class="main">(</span><span class="free">ℐ_adv_rest1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_rest2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_resta</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>otp.sec.Inp_Fedit <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span>
       <span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_adv_rest1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_rest2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_adv_resta</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span>ℐ_uniform <span class="main">(</span>otp.sec.Inp_Send <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>otp.sec.Out_Recv <span class="main">`</span> carrier <span class="free">ℒ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span>
       <span class="main">(</span><span class="main">(</span><span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_usr_rest1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_rest2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_usr_resta</span><span class="main">)</span><span class="main">)</span>
      <span class="free">𝒜</span> <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="main">(</span>ddh.advantage <span class="free">𝒢</span>
                <span class="main">(</span>diffie_hellman.DH_adversary <span class="free">𝒢</span> <span class="free">auth1_rest</span> <span class="free">auth2_rest</span>
                  <span class="main">(</span>absorb
                    <span class="main">(</span>absorb <span class="free">𝒜</span>
                      <span class="main">(</span>obsf_converter <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> wiring_c1r22_c1r22 <span class="main">(</span>CNV otp.enc_callee <span class="main">()</span><span class="main">)</span> <span class="main">(</span>CNV otp.dec_callee <span class="main">()</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">(</span>obsf_converter
                      <span class="main">(</span>fused_wiring <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> converter_of_resource <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> dh.auth.resource <span class="free">auth_rest</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
               <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf_composability<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> otp.secure<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> otp.real_resource_def attach_c1f22_c1f22_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> attach_compose
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> constructive_security_obsf_lifting_<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w_adv_real<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> w_adv_ideal_inv<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> parallel_constructive_security_obsf_fuse<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> carrier_𝒢_ℒ<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> dh.secure<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> constructive_security_obsf_trivial<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_id_left<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> parallel_converter2_id_id <span class="dynamic"><span class="dynamic">pfinite_intro</span></span> <span class="dynamic"><span class="dynamic">wiring_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main"><span class="keyword3">|</span></span><span class="operator">assumption</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> wiring_c1r22_c1r22_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> carrier_𝒢_ℒ<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> carrier_𝒢_ℒ<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">pfinite_intro</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>