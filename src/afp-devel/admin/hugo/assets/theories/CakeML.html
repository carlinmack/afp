<div id="Doc_Generated">
<div class="head">
<h1>Theory Doc_Generated</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Doc_Generated
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\part{Generated Isabelle code}›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div><div id="Lib">
<div class="head">
<h1>Theory Lib</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>misc/lem_lib_stub/lib.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Lib"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives">LEM.Lem_pervasives</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_list_extra">LEM.Lem_list_extra</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_string">LEM.Lem_string</a>"</span>
  <span class="quoted">"<a href="../../coinductive/theories/#Coinductive_List">Coinductive.Coinductive_List</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>
   Extensions to Lem's built-in library to target things we need in HOL.
›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>import List_extra›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>import String›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> TODO: look for these in the built-in library ›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val rtc : forall 'a. ('a -&gt; 'a -&gt; bool) -&gt; ('a -&gt; 'a -&gt; bool)›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val disjoint : forall 'a. set 'a -&gt; set 'a -&gt; bool›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val all2 : forall 'a 'b. ('a -&gt; 'b -&gt; bool) -&gt; list 'a -&gt; list 'b -&gt; bool›</span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span>  <span class="entity">the</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">the</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">)</span>"</span></span> <span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">the</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> None <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fapply : forall 'a 'b. MapKeyType 'b =&gt; 'a -&gt; 'b -&gt; Map.map 'b 'a -&gt; 'a›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fapply</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span><span class="main">(</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>Map.map <span class="main">⇒</span> <span class="tfree">'a</span> "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">fapply</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="keyword1">case</span>   <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> Some <span class="bound">d</span> <span class="main">=&gt;</span> <span class="bound">d</span> <span class="main">|</span> None <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span> 
<span class="entity">lunion</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">lunion</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">lunion</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> Set.member <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
  <span class="keyword1">then</span> <span class="free">lunion</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span><span class="main">(</span><span class="free">lunion</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> TODO: proper support for nat sets as sptrees... ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import {hol} `sptreeTheory`›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>type nat_set›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_set_empty : nat_set›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_set_is_empty : nat_set -&gt; bool›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_set_insert : nat_set -&gt; nat -&gt; nat_set›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_set_delete : nat_set -&gt; nat -&gt; nat_set›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_set_to_set : nat_set -&gt; set nat›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_set_elem : nat_set -&gt; nat -&gt; bool›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_set_from_list : list nat -&gt; nat_set›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_set_upto : nat -&gt; nat_set›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>type nat_map 'a›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_map_empty : forall 'a. nat_map 'a›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_map_domain : forall 'a. nat_map 'a -&gt; set nat›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_map_insert : forall 'a. nat_map 'a -&gt; nat -&gt; 'a -&gt; nat_map 'a›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_map_lookup : forall 'a. nat_map 'a -&gt; nat -&gt; maybe 'a›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_map_to_list : forall 'a. nat_map 'a -&gt; list 'a›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nat_map_map : forall 'a 'b. ('a -&gt; 'b) -&gt; nat_map 'a -&gt; nat_map 'b›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> TODO: proper support for lazy lists ›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import {hol} `llistTheory`›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import {isabelle} `Coinductive.Coinductive_List`›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>type llist 'a›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val lhd : forall 'a. llist 'a -&gt; maybe 'a›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val ltl : forall 'a. llist 'a -&gt; maybe (llist 'a)›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val lnil : forall 'a. llist 'a›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val lcons : forall 'a. 'a -&gt; llist 'a -&gt; llist 'a›</span></span>›</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> TODO: proper support for words... ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import {hol} `wordsTheory` `integer_wordTheory`›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>type word8›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val natFromWord8 : word8 -&gt; nat›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val word_to_hex_string : word8 -&gt; string›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val word8FromNat : nat -&gt; word8›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val word8FromInteger : integer -&gt; word8›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val integerFromWord8 : word8 -&gt; integer›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>type word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val natFromWord64 : word64 -&gt; nat›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val word64FromNat : nat -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val word64FromInteger : integer -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val integerFromWord64 : word64 -&gt; integer›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val word8FromWord64 : word64 -&gt; word8›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val word64FromWord8 : word8 -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W8and : word8 -&gt; word8 -&gt; word8›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W8or : word8 -&gt; word8 -&gt; word8›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W8xor : word8 -&gt; word8 -&gt; word8›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W8add : word8 -&gt; word8 -&gt; word8›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W8sub : word8 -&gt; word8 -&gt; word8›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W64and : word64 -&gt; word64 -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W64or : word64 -&gt; word64 -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W64xor : word64 -&gt; word64 -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W64add : word64 -&gt; word64 -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W64sub : word64 -&gt; word64 -&gt; word64›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W8lsl : word8 -&gt; nat -&gt; word8›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W8lsr : word8 -&gt; nat -&gt; word8›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W8asr : word8 -&gt; nat -&gt; word8›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W8ror : word8 -&gt; nat -&gt; word8›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W64lsl : word64 -&gt; nat -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W64lsr : word64 -&gt; nat -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W64asr : word64 -&gt; nat -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val W64ror : word64 -&gt; nat -&gt; word64›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import {hol} `alistTheory`›</span></span>›</span>
<span class="keyword1"><span class="command">type_synonym</span></span><span class="main">(</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> alist <span class="main">=</span><span class="quoted"><span class="quoted">" <span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span> list "</span></span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val alistToFmap : forall 'k 'v. alist 'k 'v -&gt; Map.map 'k 'v›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val opt_bind : forall 'a 'b. maybe 'a -&gt; 'b -&gt; alist 'a 'b -&gt; alist 'a 'b›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">opt_bind</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span><span class="main">(</span><span class="tfree">'a</span><span class="main">*</span><span class="tfree">'b</span><span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="tfree">'a</span><span class="main">*</span><span class="tfree">'b</span><span class="main">)</span>list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">opt_bind</span> None <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opt_bind</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Lists of indices ›</span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> 
<span class="entity">lshift</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" nat <span class="main">⇒</span><span class="main">(</span>nat<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>nat<span class="main">)</span>list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">lshift</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">::</span> nat<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> <span class="main">(</span>
  List.map <span class="main">(</span><span class="main">λ</span> <span class="bound">v2</span> <span class="main">.</span>  <span class="bound">v2</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>List.filter <span class="main">(</span><span class="main">λ</span> <span class="bound">v2</span> <span class="main">.</span>  <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≤</span> <span class="bound">v2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import {hol} `locationTheory`›</span></span>›</span>
<span class="keyword1"><span class="command">datatype_record</span></span> locn <span class="main">=</span> 
 <span class="free"><span class="entity">row</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" nat "</span></span> 
  <span class="free"><span class="entity">col</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" nat "</span></span> 
 <span class="free"><span class="entity">offset</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" nat "</span></span> 

<span class="keyword1"><span class="command">type_synonym</span></span> locs <span class="main">=</span><span class="quoted"><span class="quoted">" <span class="main">(</span>locn <span class="main">*</span> locn<span class="main">)</span>"</span></span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val unknown_loc : locs›</span></span>›</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Namespace">
<div class="head">
<h1>Theory Namespace</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/namespace.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Namespace"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives">LEM.Lem_pervasives</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_set_extra">LEM.Lem_set_extra</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Set_extra›</span></span>›</span>

<span class="keyword1"><span class="command">type_synonym</span></span><span class="main">(</span> <span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> alist0 <span class="main">=</span><span class="quoted"><span class="quoted">" <span class="main">(</span><span class="tfree">'k</span> <span class="main">*</span> <span class="tfree">'v</span><span class="main">)</span> list "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Identifiers ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span><span class="main">(</span> <span class="tfree">'m</span><span class="main">,</span> <span class="tfree">'n</span><span class="main">)</span> id0 <span class="main">=</span>
    Short <span class="quoted"><span class="quoted">" <span class="tfree">'n</span> "</span></span>
  <span class="main">|</span> Long <span class="quoted"><span class="quoted">" <span class="tfree">'m</span> "</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="tfree">'m</span><span class="main">,</span> <span class="tfree">'n</span><span class="main">)</span> id0 "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val mk_id : forall 'n 'm. list 'm -&gt; 'n -&gt; id 'm 'n›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span>  <span class="entity">mk_id</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'m</span> list <span class="main">⇒</span> <span class="tfree">'n</span> <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span>id0 "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">mk_id</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span> Short <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">)</span>"</span></span>
    <span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">mk_id</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">mns</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span> Long <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="main">(</span><span class="free">mk_id</span> <span class="free"><span class="bound"><span class="entity">mns</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val id_to_n : forall 'n 'm. id 'm 'n -&gt; 'n›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span>  <span class="entity">id_to_n</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span>id0 <span class="main">⇒</span> <span class="tfree">'n</span> "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">id_to_n</span> <span class="main">(</span>Short <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">)</span>"</span></span>
    <span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">id_to_n</span> <span class="main">(</span>Long <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">id1</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="free">id_to_n</span> <span class="free"><span class="bound"><span class="entity">id1</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val id_to_mods : forall 'n 'm. id 'm 'n -&gt; list 'm›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span>  <span class="entity">id_to_mods</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span>id0 <span class="main">⇒</span> <span class="tfree">'m</span> list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">id_to_mods</span> <span class="main">(</span>Short <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">id_to_mods</span> <span class="main">(</span>Long <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">id1</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="main">#</span> <span class="free">id_to_mods</span> <span class="free"><span class="bound"><span class="entity">id1</span></span></span> <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">datatype</span></span><span class="main">(</span> <span class="tfree">'m</span><span class="main">,</span> <span class="tfree">'n</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> namespace <span class="main">=</span>
  Bind <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="tfree">'n</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> alist0 "</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="tfree">'m</span><span class="main">,</span> <span class="main">(</span> <span class="main">(</span><span class="tfree">'m</span><span class="main">,</span> <span class="tfree">'n</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span>namespace<span class="main">)</span><span class="main">)</span> alist0 "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsLookup : forall 'v 'm 'n. Eq 'n, Eq 'm =&gt; namespace 'm 'n 'v -&gt; id 'm 'n -&gt; maybe 'v›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span>  <span class="entity">nsLookup</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span>id0 <span class="main">⇒</span> <span class="tfree">'v</span> option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsLookup</span> <span class="main">(</span>Bind <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>Short <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Map.map_of <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">)</span>"</span></span>
    <span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">nsLookup</span> <span class="main">(</span>Bind <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>Long <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">id1</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="main">(</span><span class="keyword1">case</span>  Map.map_of <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="keyword1">of</span>
        None <span class="main">=&gt;</span> None
      <span class="main">|</span> Some <span class="bound">env</span> <span class="main">=&gt;</span> <span class="free">nsLookup</span> <span class="bound">env</span> <span class="free"><span class="bound"><span class="entity">id1</span></span></span>
      <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsLookupMod : forall 'm 'n 'v. Eq 'n, Eq 'm =&gt; namespace 'm 'n 'v -&gt; list 'm -&gt; maybe (namespace 'm 'n 'v)›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span>  <span class="entity">nsLookupMod</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace <span class="main">⇒</span> <span class="tfree">'m</span> list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsLookupMod</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span> Some <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">)</span>"</span></span>
    <span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">nsLookupMod</span> <span class="main">(</span>Bind <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">path</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="main">(</span><span class="keyword1">case</span>  Map.map_of <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="keyword1">of</span>
        None <span class="main">=&gt;</span> None
      <span class="main">|</span> Some <span class="bound">env</span> <span class="main">=&gt;</span> <span class="free">nsLookupMod</span> <span class="bound">env</span> <span class="free"><span class="bound"><span class="entity">path</span></span></span>
      <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsEmpty : forall 'v 'm 'n. namespace 'm 'n 'v›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nsEmpty</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsEmpty</span> <span class="main">=</span> <span class="main">(</span> Bind <span class="main">[]</span> <span class="main">[]</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsAppend : forall 'v 'm 'n. namespace 'm 'n 'v -&gt; namespace 'm 'n 'v -&gt; namespace 'm 'n 'v›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nsAppend</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsAppend</span> <span class="main">(</span>Bind <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">)</span> <span class="main">(</span>Bind <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Bind <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsLift : forall 'v 'm 'n. 'm -&gt; namespace 'm 'n 'v -&gt; namespace 'm 'n 'v›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nsLift</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'m</span> <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsLift</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span> Bind <span class="main">[]</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">mn</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val alist_to_ns : forall 'v 'm 'n. alist 'n 'v -&gt; namespace 'm 'n 'v›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">alist_to_ns</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span><span class="main">*</span><span class="tfree">'v</span><span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">alist_to_ns</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span> Bind <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[]</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsBind : forall 'v 'm 'n. 'n -&gt; 'v -&gt; namespace 'm 'n 'v -&gt; namespace 'm 'n 'v›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nsBind</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsBind</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Bind <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Bind <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsBindList : forall 'v 'm 'n. list ('n * 'v) -&gt; namespace 'm 'n 'v -&gt; namespace 'm 'n 'v›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nsBindList</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span><span class="main">*</span><span class="tfree">'v</span><span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsBindList</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span> List.foldr <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">v2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">λ</span> <span class="bound">e</span> <span class="main">.</span>  nsBind <span class="bound">x</span> <span class="bound">v2</span> <span class="bound">e</span> <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsOptBind : forall 'v 'm 'n. maybe 'n -&gt; 'v -&gt; namespace 'm 'n 'v -&gt; namespace 'm 'n 'v›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nsOptBind</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'n</span> option <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsOptBind</span> None <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">nsOptBind</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span> nsBind <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsSing : forall 'v 'm 'n. 'n -&gt; 'v -&gt; namespace 'm 'n 'v›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nsSing</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsSing</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span> Bind <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsSub : forall 'v1 'v2 'm 'n. Eq 'm, Eq 'n, Eq 'v1, Eq 'v2 =&gt;
  (id 'm 'n -&gt; 'v1 -&gt; 'v2 -&gt; bool) -&gt; namespace 'm 'n 'v1 -&gt; namespace 'm 'n 'v2 -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nsSub</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span>id0 <span class="main">⇒</span> <span class="tfree">'v1</span> <span class="main">⇒</span> <span class="tfree">'v2</span> <span class="main">⇒</span> bool<span class="main">)</span><span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v1</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v2</span><span class="main">)</span>namespace <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsSub</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">env1</span></span></span> <span class="free"><span class="bound"><span class="entity">env2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">id0</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">v1</span><span class="main">.</span> 
    <span class="main">(</span>nsLookup <span class="free"><span class="bound"><span class="entity">env1</span></span></span> <span class="bound">id0</span> <span class="main">=</span> Some <span class="bound">v1</span><span class="main">)</span>
    <span class="main">⟶</span>
    <span class="main">(</span><span class="main">(</span><span class="main">∃</span> <span class="bound">v2</span><span class="main">.</span>  <span class="main">(</span>nsLookup <span class="free"><span class="bound"><span class="entity">env2</span></span></span> <span class="bound">id0</span> <span class="main">=</span> Some <span class="bound">v2</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">id0</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">path</span><span class="main">.</span> 
    <span class="main">(</span>nsLookupMod <span class="free"><span class="bound"><span class="entity">env2</span></span></span> <span class="bound">path</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>nsLookupMod <span class="free"><span class="bound"><span class="entity">env1</span></span></span> <span class="bound">path</span> <span class="main">=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsAll : forall 'v 'm 'n. Eq 'm, Eq 'n, Eq 'v =&gt; (id 'm 'n -&gt; 'v -&gt; bool) -&gt; namespace 'm 'n 'v -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span>  <span class="entity">nsAll</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span>id0 <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> bool<span class="main">)</span><span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsAll</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">id0</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">v1</span><span class="main">.</span> 
     <span class="main">(</span>nsLookup <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">id0</span> <span class="main">=</span> Some <span class="bound">v1</span><span class="main">)</span>
     <span class="main">⟶</span>
     <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">id0</span> <span class="bound">v1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val eAll2 : forall 'v1 'v2 'm 'n. Eq 'm, Eq 'n, Eq 'v1, Eq 'v2 =&gt;
   (id 'm 'n -&gt; 'v1 -&gt; 'v2 -&gt; bool) -&gt; namespace 'm 'n 'v1 -&gt; namespace 'm 'n 'v2 -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nsAll2</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span>id0 <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span><span class="main">⇒</span><span class="main">(</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>namespace <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsAll2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">env1</span></span></span> <span class="free"><span class="bound"><span class="entity">env2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  nsSub <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">env1</span></span></span> <span class="free"><span class="bound"><span class="entity">env2</span></span></span> <span class="main">∧</span>
  nsSub <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">.</span>  <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">x</span> <span class="bound">z</span> <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env2</span></span></span> <span class="free"><span class="bound"><span class="entity">env1</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsDom : forall 'v 'm 'n. Eq 'm, Eq 'n, Eq 'v, SetType 'v =&gt; namespace 'm 'n 'v -&gt; set (id 'm 'n)›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nsDom</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span>id0<span class="main">)</span>set "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsDom</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x2</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">{}</span><span class="main">)</span> <span class="keyword1">in</span>  Finite_Set.fold
   <span class="main">(</span><span class="main">λ</span><span class="bound">v2</span> <span class="bound">x2</span> <span class="main">.</span>  Finite_Set.fold
                        <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="bound">x2</span> <span class="main">.</span> 
                         <span class="keyword1">if</span> nsLookup <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">v2</span> <span class="keyword1">then</span> Set.insert <span class="bound">n</span> <span class="bound">x2</span>
                         <span class="keyword1">else</span> <span class="bound">x2</span><span class="main">)</span> <span class="bound">x2</span> UNIV<span class="main">)</span> <span class="bound">x2</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsDomMod : forall 'v 'm 'n. SetType 'm, Eq 'm, Eq 'n, Eq 'v =&gt; namespace 'm 'n 'v -&gt; set (list 'm)›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nsDomMod</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span> list<span class="main">)</span>set "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsDomMod</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x2</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">{}</span><span class="main">)</span> <span class="keyword1">in</span>  Finite_Set.fold
   <span class="main">(</span><span class="main">λ</span><span class="bound">v2</span> <span class="bound">x2</span> <span class="main">.</span>  Finite_Set.fold
                        <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="bound">x2</span> <span class="main">.</span> 
                         <span class="keyword1">if</span> nsLookupMod <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">v2</span> <span class="keyword1">then</span> Set.insert <span class="bound">n</span> <span class="bound">x2</span>
                         <span class="keyword1">else</span> <span class="bound">x2</span><span class="main">)</span> <span class="bound">x2</span> UNIV<span class="main">)</span> <span class="bound">x2</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val nsMap : forall 'v 'w 'm 'n. ('v -&gt; 'w) -&gt; namespace 'm 'n 'v -&gt; namespace 'm 'n 'w›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span>  <span class="entity">nsMap</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'w</span><span class="main">)</span><span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'w</span><span class="main">)</span>namespace "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">nsMap</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Bind <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  Bind <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>
       <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">mn</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">mn</span><span class="main">,</span> <span class="free">nsMap</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">e</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FpSem">
<div class="head">
<h1>Theory FpSem</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/fpSem.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"FpSem"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives">LEM.Lem_pervasives</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>
  <span class="quoted">"<a href="../../ieee_floating_point/theories/#FP64">IEEE_Floating_Point.FP64</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Lib›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import {hol} `machine_ieeeTheory`›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import {isabelle} `IEEE_Floating_Point.FP64`›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>type rounding›</span></span>›</span>

<span class="keyword1"><span class="command">datatype</span></span> fp_cmp_op <span class="main">=</span> FP_Less <span class="main">|</span> FP_LessEqual <span class="main">|</span> FP_Greater <span class="main">|</span> FP_GreaterEqual <span class="main">|</span> FP_Equal
<span class="keyword1"><span class="command">datatype</span></span> fp_uop_op <span class="main">=</span> FP_Abs <span class="main">|</span> FP_Neg <span class="main">|</span> FP_Sqrt
<span class="keyword1"><span class="command">datatype</span></span> fp_bop_op <span class="main">=</span> FP_Add <span class="main">|</span> FP_Sub <span class="main">|</span> FP_Mul <span class="main">|</span> FP_Div

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp64_lessThan     : word64 -&gt; word64 -&gt; bool›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp64_lessEqual    : word64 -&gt; word64 -&gt; bool›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp64_greaterThan  : word64 -&gt; word64 -&gt; bool›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp64_greaterEqual : word64 -&gt; word64 -&gt; bool›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp64_equal        : word64 -&gt; word64 -&gt; bool›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp64_abs    : word64 -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp64_negate : word64 -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp64_sqrt   : rounding -&gt; word64 -&gt; word64›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp64_add : rounding -&gt; word64 -&gt; word64 -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp64_sub : rounding -&gt; word64 -&gt; word64 -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp64_mul : rounding -&gt; word64 -&gt; word64 -&gt; word64›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp64_div : rounding -&gt; word64 -&gt; word64 -&gt; word64›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val roundTiesToEven : rounding›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp_cmp : fp_cmp -&gt; word64 -&gt; word64 -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fp_cmp</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" fp_cmp_op <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">fp_cmp</span> FP_Less <span class="main">=</span> <span class="main">(</span> fp64_lessThan <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">fp_cmp</span> FP_LessEqual <span class="main">=</span> <span class="main">(</span> fp64_lessEqual <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">fp_cmp</span> FP_Greater <span class="main">=</span> <span class="main">(</span> fp64_greaterThan <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">fp_cmp</span> FP_GreaterEqual <span class="main">=</span> <span class="main">(</span> fp64_greaterEqual <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">fp_cmp</span> FP_Equal <span class="main">=</span> <span class="main">(</span> fp64_equal <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp_uop : fp_uop -&gt; word64 -&gt; word64›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fp_uop</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" fp_uop_op <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">fp_uop</span> FP_Abs <span class="main">=</span> <span class="main">(</span> fp64_abs <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">fp_uop</span> FP_Neg <span class="main">=</span> <span class="main">(</span> fp64_negate <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">fp_uop</span> FP_Sqrt <span class="main">=</span> <span class="main">(</span> fp64_sqrt To_nearest <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val fp_bop : fp_bop -&gt; word64 -&gt; word64 -&gt; word64›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fp_bop</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" fp_bop_op <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">fp_bop</span> FP_Add <span class="main">=</span> <span class="main">(</span> fp64_add To_nearest <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">fp_bop</span> FP_Sub <span class="main">=</span> <span class="main">(</span> fp64_sub To_nearest <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">fp_bop</span> FP_Mul <span class="main">=</span> <span class="main">(</span> fp64_mul To_nearest <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">fp_bop</span> FP_Div <span class="main">=</span> <span class="main">(</span> fp64_div To_nearest <span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ast">
<div class="head">
<h1>Theory Ast</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/ast.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Ast"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives">LEM.Lem_pervasives</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>
  <span class="quoted">"<a href="#Namespace">Namespace</a>"</span>
  <span class="quoted">"<a href="#FpSem">FpSem</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Lib›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Namespace›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import FpSem›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Literal constants ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> lit <span class="main">=</span>
    IntLit <span class="quoted"><span class="quoted">" int "</span></span>
  <span class="main">|</span> Char <span class="quoted"><span class="quoted">" char "</span></span>
  <span class="main">|</span> StrLit <span class="quoted"><span class="quoted">" string "</span></span>
  <span class="main">|</span> Word8 <span class="quoted"><span class="quoted">" <span class="numeral">8</span> word "</span></span>
  <span class="main">|</span> Word64 <span class="quoted"><span class="quoted">" <span class="numeral">64</span> word "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Built-in binary operations ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> opn <span class="main">=</span> Plus <span class="main">|</span> Minus <span class="main">|</span> Times <span class="main">|</span> Divide <span class="main">|</span> Modulo
<span class="keyword1"><span class="command">datatype</span></span> opb <span class="main">=</span> Lt <span class="main">|</span> Gt <span class="main">|</span> Leq <span class="main">|</span> Geq
<span class="keyword1"><span class="command">datatype</span></span> opw <span class="main">=</span> Andw <span class="main">|</span> Orw <span class="main">|</span> Xor <span class="main">|</span> Add <span class="main">|</span> Sub
<span class="keyword1"><span class="command">datatype</span></span> shift <span class="main">=</span> Lsl <span class="main">|</span> Lsr <span class="main">|</span> Asr <span class="main">|</span> Ror

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Module names ›</span></span>›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> modN <span class="main">=</span><span class="quoted"><span class="quoted">" string "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Variable names ›</span></span>›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> varN <span class="main">=</span><span class="quoted"><span class="quoted">" string "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Constructor names (from datatype definitions) ›</span></span>›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> conN <span class="main">=</span><span class="quoted"><span class="quoted">" string "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Type names ›</span></span>›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> typeN <span class="main">=</span><span class="quoted"><span class="quoted">" string "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Type variable names ›</span></span>›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> tvarN <span class="main">=</span><span class="quoted"><span class="quoted">" string "</span></span>

<span class="keyword1"><span class="command">datatype</span></span> word_size <span class="main">=</span> W8 <span class="main">|</span> W64

<span class="keyword1"><span class="command">datatype</span></span> op0 <span class="main">=</span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Operations on integers ›</span></span>›</span>
    Opn <span class="quoted"><span class="quoted">" opn "</span></span>
  <span class="main">|</span> Opb <span class="quoted"><span class="quoted">" opb "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Operations on words ›</span></span>›</span>
  <span class="main">|</span> Opw <span class="quoted"><span class="quoted">" word_size "</span></span> <span class="quoted"><span class="quoted">" opw "</span></span>
  <span class="main">|</span> Shift <span class="quoted"><span class="quoted">" word_size "</span></span> <span class="quoted"><span class="quoted">" shift "</span></span> <span class="quoted"><span class="quoted">" nat "</span></span>
  <span class="main">|</span> Equality
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> FP operations ›</span></span>›</span>
  <span class="main">|</span> FP_cmp <span class="quoted"><span class="quoted">" fp_cmp_op "</span></span>
  <span class="main">|</span> FP_uop <span class="quoted"><span class="quoted">" fp_uop_op "</span></span>
  <span class="main">|</span> FP_bop <span class="quoted"><span class="quoted">" fp_bop_op "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Function application ›</span></span>›</span>
  <span class="main">|</span> Opapp
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Reference operations ›</span></span>›</span>
  <span class="main">|</span> Opassign
  <span class="main">|</span> Opref
  <span class="main">|</span> Opderef
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Word8Array operations ›</span></span>›</span>
  <span class="main">|</span> Aw8alloc
  <span class="main">|</span> Aw8sub
  <span class="main">|</span> Aw8length
  <span class="main">|</span> Aw8update
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Word/integer conversions ›</span></span>›</span>
  <span class="main">|</span> WordFromInt <span class="quoted"><span class="quoted">" word_size "</span></span>
  <span class="main">|</span> WordToInt <span class="quoted"><span class="quoted">" word_size "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> string/bytearray conversions ›</span></span>›</span>
  <span class="main">|</span> CopyStrStr
  <span class="main">|</span> CopyStrAw8
  <span class="main">|</span> CopyAw8Str
  <span class="main">|</span> CopyAw8Aw8
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Char operations ›</span></span>›</span>
  <span class="main">|</span> Ord
  <span class="main">|</span> Chr
  <span class="main">|</span> Chopb <span class="quoted"><span class="quoted">" opb "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> String operations ›</span></span>›</span>
  <span class="main">|</span> Implode
  <span class="main">|</span> Strsub
  <span class="main">|</span> Strlen
  <span class="main">|</span> Strcat
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Vector operations ›</span></span>›</span>
  <span class="main">|</span> VfromList
  <span class="main">|</span> Vsub
  <span class="main">|</span> Vlength
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Array operations ›</span></span>›</span>
  <span class="main">|</span> Aalloc
  <span class="main">|</span> AallocEmpty
  <span class="main">|</span> Asub
  <span class="main">|</span> Alength
  <span class="main">|</span> Aupdate
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Configure the GC ›</span></span>›</span>
  <span class="main">|</span> ConfigGC
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Call a given foreign function ›</span></span>›</span>
  <span class="main">|</span> FFI <span class="quoted"><span class="quoted">" string "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Logical operations ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> lop <span class="main">=</span>
    And
  <span class="main">|</span> Or

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Type constructors.
 * 0-ary type applications represent unparameterised types (e.g., num or string)
 ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> tctor <span class="main">=</span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> User defined types ›</span></span>›</span>
    TC_name <span class="quoted"><span class="quoted">" <span class="main">(</span>modN<span class="main">,</span> typeN<span class="main">)</span> id0 "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Built-in types ›</span></span>›</span>
  <span class="main">|</span> TC_int
  <span class="main">|</span> TC_char
  <span class="main">|</span> TC_string
  <span class="main">|</span> TC_ref
  <span class="main">|</span> TC_word8
  <span class="main">|</span> TC_word64
  <span class="main">|</span> TC_word8array
  <span class="main">|</span> TC_fn
  <span class="main">|</span> TC_tup
  <span class="main">|</span> TC_exn
  <span class="main">|</span> TC_vector
  <span class="main">|</span> TC_array

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Types ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> t <span class="main">=</span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Type variables that the user writes down ('a, 'b, etc.) ›</span></span>›</span>
    Tvar <span class="quoted"><span class="quoted">" tvarN "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> deBruijn indexed type variables.
     The type system uses these internally. ›</span></span>›</span>
  <span class="main">|</span> Tvar_db <span class="quoted"><span class="quoted">" nat "</span></span>
  <span class="main">|</span> Tapp <span class="quoted"><span class="quoted">" t list "</span></span> <span class="quoted"><span class="quoted">" tctor "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Some abbreviations ›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Tint</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">Tint</span> <span class="main">=</span> <span class="main">(</span> Tapp <span class="main">[]</span> TC_int <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Tchar</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">Tchar</span> <span class="main">=</span> <span class="main">(</span> Tapp <span class="main">[]</span> TC_char <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Tstring</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">Tstring</span> <span class="main">=</span> <span class="main">(</span> Tapp <span class="main">[]</span> TC_string <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Tref</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" t <span class="main">⇒</span> t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">Tref</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> Tapp <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">]</span> TC_ref <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>  <span class="entity">TC_word</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" word_size <span class="main">⇒</span> tctor "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">TC_word</span> W8 <span class="main">=</span> <span class="main">(</span> TC_word8 <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"     <span class="free">TC_word</span> W64 <span class="main">=</span> <span class="main">(</span> TC_word64 <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Tword</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" word_size <span class="main">⇒</span> t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">Tword</span> <span class="free"><span class="bound"><span class="entity">wz</span></span></span> <span class="main">=</span> <span class="main">(</span> Tapp <span class="main">[]</span> <span class="main">(</span>TC_word <span class="free"><span class="bound"><span class="entity">wz</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Tword8</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">Tword8</span> <span class="main">=</span> <span class="main">(</span> Tword W8 <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Tword64</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">Tword64</span> <span class="main">=</span> <span class="main">(</span> Tword W64 <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Tword8array</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">Tword8array</span> <span class="main">=</span> <span class="main">(</span> Tapp <span class="main">[]</span> TC_word8array <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Tfn</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" t <span class="main">⇒</span> t <span class="main">⇒</span> t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">Tfn</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span> Tapp <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">]</span> TC_fn <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Texn</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">Texn</span> <span class="main">=</span> <span class="main">(</span> Tapp <span class="main">[]</span> TC_exn <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Patterns ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> pat <span class="main">=</span>
    Pany
  <span class="main">|</span> Pvar <span class="quoted"><span class="quoted">" varN "</span></span>
  <span class="main">|</span> Plit <span class="quoted"><span class="quoted">" lit "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Constructor applications.
     A Nothing constructor indicates a tuple pattern. ›</span></span>›</span>
  <span class="main">|</span> Pcon <span class="quoted"><span class="quoted">"  <span class="main">(</span> <span class="main">(</span>modN<span class="main">,</span> conN<span class="main">)</span>id0<span class="main">)</span>option "</span></span> <span class="quoted"><span class="quoted">" pat list "</span></span>
  <span class="main">|</span> Pref <span class="quoted"><span class="quoted">" pat "</span></span>
  <span class="main">|</span> Ptannot <span class="quoted"><span class="quoted">" pat "</span></span> <span class="quoted"><span class="quoted">" t "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Expressions ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> exp0 <span class="main">=</span>
    Raise <span class="quoted"><span class="quoted">" exp0 "</span></span>
  <span class="main">|</span> Handle <span class="quoted"><span class="quoted">" exp0 "</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>pat <span class="main">*</span> exp0<span class="main">)</span> list "</span></span>
  <span class="main">|</span> Lit <span class="quoted"><span class="quoted">" lit "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Constructor application.
     A Nothing constructor indicates a tuple pattern. ›</span></span>›</span>
  <span class="main">|</span> Con <span class="quoted"><span class="quoted">"  <span class="main">(</span> <span class="main">(</span>modN<span class="main">,</span> conN<span class="main">)</span>id0<span class="main">)</span>option "</span></span> <span class="quoted"><span class="quoted">" exp0 list "</span></span>
  <span class="main">|</span> Var <span class="quoted"><span class="quoted">" <span class="main">(</span>modN<span class="main">,</span> varN<span class="main">)</span> id0 "</span></span>
  <span class="main">|</span> Fun <span class="quoted"><span class="quoted">" varN "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Application of a primitive operator to arguments.
     Includes function application. ›</span></span>›</span>
  <span class="main">|</span> App <span class="quoted"><span class="quoted">" op0 "</span></span> <span class="quoted"><span class="quoted">" exp0 list "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Logical operations (and, or) ›</span></span>›</span>
  <span class="main">|</span> Log <span class="quoted"><span class="quoted">" lop "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span>
  <span class="main">|</span> If <span class="quoted"><span class="quoted">" exp0 "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Pattern matching ›</span></span>›</span>
  <span class="main">|</span> Mat <span class="quoted"><span class="quoted">" exp0 "</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>pat <span class="main">*</span> exp0<span class="main">)</span> list "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> A let expression
     A Nothing value for the binding indicates that this is a
     sequencing expression, that is: (e1; e2). ›</span></span>›</span>
  <span class="main">|</span> Let <span class="quoted"><span class="quoted">"  varN option "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Local definition of (potentially) mutually recursive
     functions.
     The first varN is the function's name, and the second varN
     is its parameter. ›</span></span>›</span>
  <span class="main">|</span> Letrec <span class="quoted"><span class="quoted">" <span class="main">(</span>varN <span class="main">*</span> varN <span class="main">*</span> exp0<span class="main">)</span> list "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span>
  <span class="main">|</span> Tannot <span class="quoted"><span class="quoted">" exp0 "</span></span> <span class="quoted"><span class="quoted">" t "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Location annotated expressions, not expected in source programs ›</span></span>›</span>
  <span class="main">|</span> Lannot <span class="quoted"><span class="quoted">" exp0 "</span></span> <span class="quoted"><span class="quoted">" locs "</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> type_def <span class="main">=</span><span class="quoted"><span class="quoted">" <span class="main">(</span> tvarN list <span class="main">*</span> typeN <span class="main">*</span> <span class="main">(</span>conN <span class="main">*</span> t list<span class="main">)</span> list<span class="main">)</span> list "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Declarations ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> dec <span class="main">=</span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Top-level bindings
   * The pattern allows several names to be bound at once ›</span></span>›</span>
    Dlet <span class="quoted"><span class="quoted">" locs "</span></span> <span class="quoted"><span class="quoted">" pat "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Mutually recursive function definition ›</span></span>›</span>
  <span class="main">|</span> Dletrec <span class="quoted"><span class="quoted">" locs "</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>varN <span class="main">*</span> varN <span class="main">*</span> exp0<span class="main">)</span> list "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Type definition
     Defines several data types, each of which has several
     named variants, which can in turn have several arguments.
   ›</span></span>›</span>
  <span class="main">|</span> Dtype <span class="quoted"><span class="quoted">" locs "</span></span> <span class="quoted"><span class="quoted">" type_def "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Type abbreviations ›</span></span>›</span>
  <span class="main">|</span> Dtabbrev <span class="quoted"><span class="quoted">" locs "</span></span> <span class="quoted"><span class="quoted">" tvarN list "</span></span> <span class="quoted"><span class="quoted">" typeN "</span></span> <span class="quoted"><span class="quoted">" t "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> New exceptions ›</span></span>›</span>
  <span class="main">|</span> Dexn <span class="quoted"><span class="quoted">" locs "</span></span> <span class="quoted"><span class="quoted">" conN "</span></span> <span class="quoted"><span class="quoted">" t list "</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> decs <span class="main">=</span><span class="quoted"><span class="quoted">" dec list "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Specifications
   For giving the signature of a module ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> spec <span class="main">=</span>
    Sval <span class="quoted"><span class="quoted">" varN "</span></span> <span class="quoted"><span class="quoted">" t "</span></span>
  <span class="main">|</span> Stype <span class="quoted"><span class="quoted">" type_def "</span></span>
  <span class="main">|</span> Stabbrev <span class="quoted"><span class="quoted">" tvarN list "</span></span> <span class="quoted"><span class="quoted">" typeN "</span></span> <span class="quoted"><span class="quoted">" t "</span></span>
  <span class="main">|</span> Stype_opq <span class="quoted"><span class="quoted">" tvarN list "</span></span> <span class="quoted"><span class="quoted">" typeN "</span></span>
  <span class="main">|</span> Sexn <span class="quoted"><span class="quoted">" conN "</span></span> <span class="quoted"><span class="quoted">" t list "</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> specs <span class="main">=</span><span class="quoted"><span class="quoted">" spec list "</span></span>

<span class="keyword1"><span class="command">datatype</span></span> top0 <span class="main">=</span>
    Tmod <span class="quoted"><span class="quoted">" modN "</span></span> <span class="quoted"><span class="quoted">"  specs option "</span></span> <span class="quoted"><span class="quoted">" decs "</span></span>
  <span class="main">|</span> Tdec <span class="quoted"><span class="quoted">" dec "</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> prog <span class="main">=</span><span class="quoted"><span class="quoted">" top0 list "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Accumulates the bindings of a pattern ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val pat_bindings : pat -&gt; list varN -&gt; list varN›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span> 
<span class="entity">pats_bindings</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pat<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>string<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>string<span class="main">)</span>list "</span></span>  
                   <span class="keyword2"><span class="keyword">and</span></span>
<span class="entity">pat_bindings</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" pat <span class="main">⇒</span><span class="main">(</span>string<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>string<span class="main">)</span>list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">pat_bindings</span> Pany <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pat_bindings</span> <span class="main">(</span>Pvar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pat_bindings</span> <span class="main">(</span>Plit <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pat_bindings</span> <span class="main">(</span>Pcon <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="free">pats_bindings</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pat_bindings</span> <span class="main">(</span>Pref <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="free">pat_bindings</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pat_bindings</span> <span class="main">(</span>Ptannot <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="free">pat_bindings</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pats_bindings</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pats_bindings</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="free">pats_bindings</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">(</span><span class="free">pat_bindings</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">already_bound</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="AstAuxiliary">
<div class="head">
<h1>Theory AstAuxiliary</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/ast.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"AstAuxiliary"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives">LEM.Lem_pervasives</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>
  <span class="quoted">"<a href="#Namespace">Namespace</a>"</span>
  <span class="quoted">"<a href="#FpSem">FpSem</a>"</span>
  <span class="quoted">"<a href="#Ast">Ast</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>**************************************************›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>                                                  ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Termination Proofs                               ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>                                                  ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>**************************************************›</span></span>›</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">pat_bindings</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ffi">
<div class="head">
<h1>Theory Ffi</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/ffi/ffi.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Ffi"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives">LEM.Lem_pervasives</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives_extra">LEM.Lem_pervasives_extra</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives_extra›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Lib›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> An oracle says how to perform an ffi call based on its internal state,
* represented by the type variable 'ffi. ›</span></span>›</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'ffi</span> oracle_result <span class="main">=</span> Oracle_return <span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> "</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">8</span> word list "</span></span> <span class="main">|</span> Oracle_diverge <span class="main">|</span> Oracle_fail
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'ffi</span> oracle_function <span class="main">=</span><span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> <span class="main">⇒</span> <span class="numeral">8</span> word list <span class="main">⇒</span> <span class="numeral">8</span> word list <span class="main">⇒</span> <span class="tfree">'ffi</span> oracle_result "</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'ffi</span> oracle0 <span class="main">=</span><span class="quoted"><span class="quoted">" string <span class="main">⇒</span> <span class="tfree">'ffi</span> oracle_function "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> An I/O event, IO_event s bytes bytes2, represents the call of FFI function s with
* immutable input bytes and mutable input map fst bytes2,
* returning map snd bytes2 in the mutable array. ›</span></span>›</span>

<span class="keyword1"><span class="command">datatype</span></span> io_event <span class="main">=</span> IO_event <span class="quoted"><span class="quoted">" string "</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">8</span> word list "</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span> <span class="main">(</span><span class="numeral">8</span> word <span class="main">*</span> <span class="numeral">8</span> word<span class="main">)</span>list<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> ffi_outcome <span class="main">=</span> FFI_diverged <span class="main">|</span> FFI_failed
<span class="keyword1"><span class="command">datatype</span></span> final_event <span class="main">=</span> Final_event <span class="quoted"><span class="quoted">" string "</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">8</span> word list "</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">8</span> word list "</span></span> <span class="quoted"><span class="quoted">" ffi_outcome "</span></span>

<span class="keyword1"><span class="command">datatype_record</span></span> <span class="tfree">'ffi</span> ffi_state <span class="main">=</span>

 <span class="free"><span class="entity">oracle0</span></span>      <span class="main">::</span><span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> oracle0 "</span></span>
 
 <span class="free"><span class="entity">ffi_state</span></span>   <span class="main">::</span><span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> "</span></span>
 
 <span class="free"><span class="entity">final_event</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">"  final_event option "</span></span>
 
 <span class="free"><span class="entity">io_events</span></span>   <span class="main">::</span><span class="quoted"><span class="quoted">" io_event list "</span></span>
 


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val initial_ffi_state : forall 'ffi. oracle 'ffi -&gt; 'ffi -&gt; ffi_state 'ffi›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">initial_ffi_state</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string <span class="main">⇒</span> <span class="tfree">'ffi</span> oracle_function<span class="main">)</span><span class="main">⇒</span> <span class="tfree">'ffi</span> <span class="main">⇒</span> <span class="tfree">'ffi</span> ffi_state "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">initial_ffi_state</span> <span class="free"><span class="bound"><span class="entity">oc</span></span></span> <span class="free"><span class="bound"><span class="entity">ffi1</span></span></span> <span class="main">=</span> <span class="main">(</span>
<span class="main">(|</span> oracle0      <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">oc</span></span></span>
 <span class="main">,</span> ffi_state   <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ffi1</span></span></span>
 <span class="main">,</span> final_event <span class="main">=</span> None
 <span class="main">,</span> io_events   <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">)</span>
 <span class="main">|)</span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val call_FFI : forall 'ffi. ffi_state 'ffi -&gt; string -&gt; list word8 -&gt; list word8 -&gt; ffi_state 'ffi * list word8›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">call_FFI</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> ffi_state <span class="main">⇒</span> string <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> ffi_state<span class="main">*</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">call_FFI</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="free"><span class="bound"><span class="entity">bytes</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span>final_event   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>oracle0   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span>ffi_state   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="free"><span class="bound"><span class="entity">bytes</span></span></span> <span class="keyword1">of</span>
      Oracle_return <span class="bound">ffi'</span> <span class="bound">bytes'</span> <span class="main">=&gt;</span>
        <span class="keyword1">if</span> List.length <span class="bound">bytes'</span> <span class="main">=</span> List.length <span class="free"><span class="bound"><span class="entity">bytes</span></span></span> <span class="keyword1">then</span>
          <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(|</span> ffi_state <span class="main">:=</span> <span class="bound">ffi'</span>
                    <span class="main">,</span> io_events <span class="main">:=</span>
                        <span class="main">(</span><span class="main">(</span>io_events   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">@</span>
                          <span class="main">[</span>IO_event <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="main">(</span>zipSameLength <span class="free"><span class="bound"><span class="entity">bytes</span></span></span> <span class="bound">bytes'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
            <span class="main">|)</span><span class="main">)</span><span class="main">,</span> <span class="bound">bytes'</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(|</span> final_event <span class="main">:=</span> <span class="main">(</span>Some <span class="main">(</span>Final_event <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="free"><span class="bound"><span class="entity">bytes</span></span></span> FFI_failed<span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bytes</span></span></span><span class="main">)</span>
    <span class="main">|</span> Oracle_diverge <span class="main">=&gt;</span>
          <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(|</span> final_event <span class="main">:=</span> <span class="main">(</span>Some <span class="main">(</span>Final_event <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="free"><span class="bound"><span class="entity">bytes</span></span></span> FFI_diverged<span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bytes</span></span></span><span class="main">)</span>
    <span class="main">|</span> Oracle_fail <span class="main">=&gt;</span>
        <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(|</span> final_event <span class="main">:=</span> <span class="main">(</span>Some <span class="main">(</span>Final_event <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="free"><span class="bound"><span class="entity">bytes</span></span></span> FFI_failed<span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bytes</span></span></span><span class="main">)</span>
    <span class="main">)</span>
  <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bytes</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">datatype</span></span> outcome <span class="main">=</span> Success <span class="main">|</span> Resource_limit_hit <span class="main">|</span> FFI_outcome <span class="quoted"><span class="quoted">" final_event "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> A program can Diverge, Terminate, or Fail. We prove that Fail is
   avoided. For Diverge and Terminate, we keep track of what I/O
   events are valid I/O events for this behaviour. ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span>  behaviour <span class="main">=</span>
    <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> There cannot be any non-returning FFI calls in a diverging
       exeuction. The list of I/O events can be finite or infinite,
       hence the llist (lazy list) type. ›</span></span>›</span>
    Diverge <span class="quoted"><span class="quoted">"  io_event llist "</span></span>
    <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Terminating executions can only perform a finite number of
       FFI calls. The execution can be terminated by a non-returning
       FFI call. ›</span></span>›</span>
  <span class="main">|</span> Terminate <span class="quoted"><span class="quoted">" outcome "</span></span> <span class="quoted"><span class="quoted">" io_event list "</span></span>
    <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Failure is a behaviour which we prove cannot occur for any
       well-typed program. ›</span></span>›</span>
  <span class="main">|</span> Fail

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> trace-based semantics can be recovered as an instance of oracle-based
 * semantics as follows. ›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val trace_oracle : oracle (llist io_event)›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trace_oracle</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" string <span class="main">⇒</span><span class="main">(</span>io_event<span class="main">)</span>llist <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>io_event<span class="main">)</span>llist<span class="main">)</span>oracle_result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">trace_oracle</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">io_trace</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="free"><span class="bound"><span class="entity">input1</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  lhd' <span class="free"><span class="bound"><span class="entity">io_trace</span></span></span> <span class="keyword1">of</span>
    Some <span class="main">(</span>IO_event <span class="bound">s'</span> <span class="bound">conf'</span> <span class="bound">bytes2</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span>List.map fst <span class="bound">bytes2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">input1</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="main">=</span> <span class="bound">conf'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
        Oracle_return <span class="main">(</span>Option.the <span class="main">(</span>ltl' <span class="free"><span class="bound"><span class="entity">io_trace</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>List.map snd <span class="bound">bytes2</span><span class="main">)</span>
      <span class="keyword1">else</span> Oracle_fail
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> Oracle_fail
  <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SemanticPrimitives">
<div class="head">
<h1>Theory SemanticPrimitives</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/semanticPrimitives.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"SemanticPrimitives"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives">LEM.Lem_pervasives</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_list_extra">LEM.Lem_list_extra</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_string">LEM.Lem_string</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>
  <span class="quoted">"<a href="#Namespace">Namespace</a>"</span>
  <span class="quoted">"<a href="#Ast">Ast</a>"</span>
  <span class="quoted">"<a href="#Ffi">Ffi</a>"</span>
  <span class="quoted">"<a href="#FpSem">FpSem</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_string_extra">LEM.Lem_string_extra</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Lib›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>import List_extra›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>import String›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>import String_extra›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Ast›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Namespace›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Ffi›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import FpSem›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> The type that a constructor builds is either a named datatype or an exception.
 * For exceptions, we also keep the module that the exception was declared in. ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> tid_or_exn <span class="main">=</span>
    TypeId <span class="quoted"><span class="quoted">" <span class="main">(</span>modN<span class="main">,</span> typeN<span class="main">)</span> id0 "</span></span>
  <span class="main">|</span> TypeExn <span class="quoted"><span class="quoted">" <span class="main">(</span>modN<span class="main">,</span> conN<span class="main">)</span> id0 "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val type_defs_to_new_tdecs : list modN -&gt; type_def -&gt; set tid_or_exn›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">type_defs_to_new_tdecs</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>tvarN<span class="main">)</span>list<span class="main">*</span>string<span class="main">*</span><span class="main">(</span>conN<span class="main">*</span><span class="main">(</span>t<span class="main">)</span>list<span class="main">)</span>list<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>tid_or_exn<span class="main">)</span>set "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">type_defs_to_new_tdecs</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">tdefs</span></span></span> <span class="main">=</span> <span class="main">(</span>
  List.set <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span><span class="bound">tn</span><span class="main">,</span><span class="bound">ctors</span><span class="main">)</span> <span class="main">=&gt;</span> TypeId <span class="main">(</span>mk_id <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="bound">tn</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tdefs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">datatype_record</span></span> <span class="tfree">'v</span> sem_env <span class="main">=</span>
  
 <span class="free"><span class="entity">v</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" <span class="main">(</span>modN<span class="main">,</span> varN<span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> namespace "</span></span>
   
 <span class="free"><span class="entity">c</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" <span class="main">(</span>modN<span class="main">,</span> conN<span class="main">,</span> <span class="main">(</span>nat <span class="main">*</span> tid_or_exn<span class="main">)</span><span class="main">)</span> namespace "</span></span>
   


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Value forms ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> v <span class="main">=</span>
    Litv <span class="quoted"><span class="quoted">" lit "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Constructor application. ›</span></span>›</span>
  <span class="main">|</span> Conv <span class="quoted"><span class="quoted">"  <span class="main">(</span>conN <span class="main">*</span> tid_or_exn<span class="main">)</span>option "</span></span> <span class="quoted"><span class="quoted">" v list "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Function closures
     The environment is used for the free variables in the function ›</span></span>›</span>
  <span class="main">|</span> Closure <span class="quoted"><span class="quoted">" v sem_env "</span></span> <span class="quoted"><span class="quoted">" varN "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Function closure for recursive functions
   * See Closure and Letrec above
   * The last variable name indicates which function from the mutually
   * recursive bundle this closure value represents ›</span></span>›</span>
  <span class="main">|</span> Recclosure <span class="quoted"><span class="quoted">" v sem_env "</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>varN <span class="main">*</span> varN <span class="main">*</span> exp0<span class="main">)</span> list "</span></span> <span class="quoted"><span class="quoted">" varN "</span></span>
  <span class="main">|</span> Loc <span class="quoted"><span class="quoted">" nat "</span></span>
  <span class="main">|</span> Vectorv <span class="quoted"><span class="quoted">" v list "</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> env_ctor <span class="main">=</span><span class="quoted"><span class="quoted">" <span class="main">(</span>modN<span class="main">,</span> conN<span class="main">,</span> <span class="main">(</span>nat <span class="main">*</span> tid_or_exn<span class="main">)</span><span class="main">)</span> namespace "</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> env_val <span class="main">=</span><span class="quoted"><span class="quoted">" <span class="main">(</span>modN<span class="main">,</span> varN<span class="main">,</span> v<span class="main">)</span> namespace "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Bindv</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" v "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">Bindv</span> <span class="main">=</span> <span class="main">(</span> Conv <span class="main">(</span>Some<span class="main">(</span><span class="main">(</span><span class="inner_quoted">''Bind''</span><span class="main">)</span><span class="main">,</span>TypeExn<span class="main">(</span>Short<span class="main">(</span><span class="inner_quoted">''Bind''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> The result of evaluation ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> abort <span class="main">=</span>
    Rtype_error
  <span class="main">|</span> Rtimeout_error

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> error_result <span class="main">=</span>
    Rraise <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> "</span></span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Should only be a value of type exn ›</span></span>›</span>
  <span class="main">|</span> Rabort <span class="quoted"><span class="quoted">" abort "</span></span>

<span class="keyword1"><span class="command">datatype</span></span><span class="main">(</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> result <span class="main">=</span>
    Rval <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> "</span></span>
  <span class="main">|</span> Rerr <span class="quoted"><span class="quoted">" <span class="tfree">'b</span> error_result "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Stores ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> store_v <span class="main">=</span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> A ref cell ›</span></span>›</span>
    Refv <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> A byte array ›</span></span>›</span>
  <span class="main">|</span> W8array <span class="quoted"><span class="quoted">" <span class="numeral">8</span> word list "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> An array of values ›</span></span>›</span>
  <span class="main">|</span> Varray <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> list "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val store_v_same_type : forall 'a. store_v 'a -&gt; store_v 'a -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">store_v_same_type</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> store_v <span class="main">⇒</span> <span class="tfree">'a</span> store_v <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">store_v_same_type</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>Refv <span class="main"><span class="bound">_</span></span><span class="main">,</span> Refv <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> True
  <span class="main">|</span> <span class="main">(</span>W8array <span class="main"><span class="bound">_</span></span><span class="main">,</span>W8array <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> True
  <span class="main">|</span> <span class="main">(</span>Varray <span class="main"><span class="bound">_</span></span><span class="main">,</span>Varray <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> True
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> The nth item in the list is the value at location n ›</span></span>›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> store <span class="main">=</span><span class="quoted"><span class="quoted">" <span class="main">(</span> <span class="tfree">'a</span> store_v<span class="main">)</span> list "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val empty_store : forall 'a. store 'a›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_store</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> store_v<span class="main">)</span>list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">empty_store</span> <span class="main">=</span> <span class="main">(</span> <span class="main">[]</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val store_lookup : forall 'a. nat -&gt; store 'a -&gt; maybe (store_v 'a)›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">store_lookup</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" nat <span class="main">⇒</span><span class="main">(</span><span class="tfree">'a</span> store_v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="tfree">'a</span> store_v<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">store_lookup</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">&lt;</span> List.length <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">then</span>
    Some <span class="main">(</span>List.nth <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span>
    None <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val store_alloc : forall 'a. store_v 'a -&gt; store 'a -&gt; store 'a * nat›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">store_alloc</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> store_v <span class="main">⇒</span><span class="main">(</span><span class="tfree">'a</span> store_v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="tfree">'a</span> store_v<span class="main">)</span>list<span class="main">*</span>nat "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">store_alloc</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">,</span> List.length <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val store_assign : forall 'a. nat -&gt; store_v 'a -&gt; store 'a -&gt; maybe (store 'a)›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">store_assign</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" nat <span class="main">⇒</span> <span class="tfree">'a</span> store_v <span class="main">⇒</span><span class="main">(</span><span class="tfree">'a</span> store_v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> store_v<span class="main">)</span>list<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">store_assign</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> List.length <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">∧</span>
     store_v_same_type <span class="main">(</span>List.nth <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>
  <span class="keyword1">then</span>
    Some <span class="main">(</span>List.list_update <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span>
    None <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">datatype_record</span></span> <span class="tfree">'ffi</span> state <span class="main">=</span>
  
 <span class="free"><span class="entity">clock</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" nat "</span></span>
   
 <span class="free"><span class="entity">refs</span></span>  <span class="main">::</span><span class="quoted"><span class="quoted">" v store "</span></span>
   
 <span class="free"><span class="entity">ffi</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> ffi_state "</span></span>
   
 <span class="free"><span class="entity">defined_types</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" tid_or_exn set "</span></span>
   
 <span class="free"><span class="entity">defined_mods</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" <span class="main">(</span> modN list<span class="main">)</span> set "</span></span>
   


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Other primitives ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Check that a constructor is properly applied ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val do_con_check : env_ctor -&gt; maybe (id modN conN) -&gt; nat -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">do_con_check</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>nat<span class="main">*</span>tid_or_exn<span class="main">)</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">)</span>id0<span class="main">)</span>option <span class="main">⇒</span> nat <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">do_con_check</span> <span class="free"><span class="bound"><span class="entity">cenv</span></span></span> None <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span> True <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">do_con_check</span> <span class="free"><span class="bound"><span class="entity">cenv</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span>
        <span class="main">(</span><span class="keyword1">case</span>  nsLookup <span class="free"><span class="bound"><span class="entity">cenv</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span>
            None <span class="main">=&gt;</span> False
          <span class="main">|</span> Some <span class="main">(</span><span class="bound">l'</span><span class="main">,</span><span class="bound">ns</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="bound">l'</span>
        <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val build_conv : env_ctor -&gt; maybe (id modN conN) -&gt; list v -&gt; maybe v›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">build_conv</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>nat<span class="main">*</span>tid_or_exn<span class="main">)</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">)</span>id0<span class="main">)</span>option <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">build_conv</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> None <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">=</span> <span class="main">(</span>
        Some <span class="main">(</span>Conv None <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">build_conv</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">id1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">=</span> <span class="main">(</span>
        <span class="main">(</span><span class="keyword1">case</span>  nsLookup <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">id1</span></span></span> <span class="keyword1">of</span>
            None <span class="main">=&gt;</span> None
          <span class="main">|</span> Some <span class="main">(</span><span class="bound">len</span><span class="main">,</span><span class="bound">t1</span><span class="main">)</span> <span class="main">=&gt;</span> Some <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span>id_to_n <span class="free"><span class="bound"><span class="entity">id1</span></span></span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span>
        <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val lit_same_type : lit -&gt; lit -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lit_same_type</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" lit <span class="main">⇒</span> lit <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">lit_same_type</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>IntLit <span class="main"><span class="bound">_</span></span><span class="main">,</span> IntLit <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> True
    <span class="main">|</span> <span class="main">(</span>Char <span class="main"><span class="bound">_</span></span><span class="main">,</span> Char <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> True
    <span class="main">|</span> <span class="main">(</span>StrLit <span class="main"><span class="bound">_</span></span><span class="main">,</span> StrLit <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> True
    <span class="main">|</span> <span class="main">(</span>Word8 <span class="main"><span class="bound">_</span></span><span class="main">,</span> Word8 <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> True
    <span class="main">|</span> <span class="main">(</span>Word64 <span class="main"><span class="bound">_</span></span><span class="main">,</span> Word64 <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> True
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> match_result <span class="main">=</span>
    No_match
  <span class="main">|</span> Match_type_error
  <span class="main">|</span> Match <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val same_tid : tid_or_exn -&gt; tid_or_exn -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span>  <span class="entity">same_tid</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" tid_or_exn <span class="main">⇒</span> tid_or_exn <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">same_tid</span> <span class="main">(</span>TypeId <span class="free"><span class="bound"><span class="entity">tn1</span></span></span><span class="main">)</span> <span class="main">(</span>TypeId <span class="free"><span class="bound"><span class="entity">tn2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">tn1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tn2</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">same_tid</span> <span class="main">(</span>TypeExn <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>TypeExn <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> True <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">same_tid</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span> False <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val same_ctor : conN * tid_or_exn -&gt; conN * tid_or_exn -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span>  <span class="entity">same_ctor</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" string<span class="main">*</span>tid_or_exn <span class="main">⇒</span> string<span class="main">*</span>tid_or_exn <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">same_ctor</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn1</span></span></span><span class="main">,</span> TypeExn <span class="free"><span class="bound"><span class="entity">mn1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn2</span></span></span><span class="main">,</span> TypeExn <span class="free"><span class="bound"><span class="entity">mn2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">cn2</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mn1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mn2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">same_ctor</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn1</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn2</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">cn1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">cn2</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val ctor_same_type : maybe (conN * tid_or_exn) -&gt; maybe (conN * tid_or_exn) -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ctor_same_type</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="main">*</span>tid_or_exn<span class="main">)</span>option <span class="main">⇒</span><span class="main">(</span>string<span class="main">*</span>tid_or_exn<span class="main">)</span>option <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">ctor_same_type</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>None<span class="main">,</span> None<span class="main">)</span> <span class="main">=&gt;</span> True
    <span class="main">|</span> <span class="main">(</span>Some <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">t1</span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> same_tid <span class="bound">t1</span> <span class="bound">t2</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> A big-step pattern matcher.  If the value matches the pattern, return an
 * environment with the pattern variables bound to the corresponding sub-terms
 * of the value; this environment extends the environment given as an argument.
 * No_match is returned when there is no match, but any constructors
 * encountered in determining the match failure are applied to the correct
 * number of arguments, and constructors in corresponding positions in the
 * pattern and value come from the same type.  Match_type_error is returned
 * when one of these conditions is violated ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val pmatch : env_ctor -&gt; store v -&gt; pat -&gt; v -&gt; alist varN v -&gt; match_result (alist varN v)›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span> 
<span class="entity">pmatch_list</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>nat<span class="main">*</span>tid_or_exn<span class="main">)</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>store_v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>pat<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>string<span class="main">*</span>v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>string<span class="main">*</span>v<span class="main">)</span>list<span class="main">)</span>match_result "</span></span>  
                   <span class="keyword2"><span class="keyword">and</span></span>
<span class="entity">pmatch</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>nat<span class="main">*</span>tid_or_exn<span class="main">)</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>store_v<span class="main">)</span>list <span class="main">⇒</span> pat <span class="main">⇒</span> v <span class="main">⇒</span><span class="main">(</span>string<span class="main">*</span>v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>string<span class="main">*</span>v<span class="main">)</span>list<span class="main">)</span>match_result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">pmatch</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> Pany <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span> Match <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pmatch</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Pvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span> Match <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pmatch</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Plit <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>Litv <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="keyword1">then</span>
    Match <span class="free"><span class="bound"><span class="entity">env</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> lit_same_type <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="keyword1">then</span>
    No_match
  <span class="keyword1">else</span>
    Match_type_error <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pmatch</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Pcon <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  nsLookup <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span>
      Some <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword1">if</span> same_tid <span class="bound">t1</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">∧</span> <span class="main">(</span>List.length <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="bound">l</span><span class="main">)</span> <span class="keyword1">then</span>
          <span class="keyword1">if</span> same_ctor <span class="main">(</span>id_to_n <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
            <span class="keyword1">if</span> List.length <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">=</span> <span class="bound">l</span> <span class="keyword1">then</span>
              <span class="free">pmatch_list</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>
            <span class="keyword1">else</span>
              Match_type_error
          <span class="keyword1">else</span>
            No_match
        <span class="keyword1">else</span>
          Match_type_error
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> Match_type_error
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pmatch</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Pcon None <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">(</span>Conv None <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> List.length <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> List.length <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="keyword1">then</span>
    <span class="free">pmatch_list</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>
  <span class="keyword1">else</span>
    Match_type_error <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pmatch</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Pref <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">lnum</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  store_lookup <span class="free"><span class="bound"><span class="entity">lnum</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
      Some <span class="main">(</span>Refv <span class="bound">v2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="free">pmatch</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">v2</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>
    <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> Match_type_error
    <span class="main">|</span> None <span class="main">=&gt;</span> Match_type_error
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pmatch</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Ptannot <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="free">pmatch</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pmatch</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span> Match_type_error <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pmatch_list</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span> Match <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pmatch_list</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free">pmatch</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1">of</span>
      No_match <span class="main">=&gt;</span> No_match
    <span class="main">|</span> Match_type_error <span class="main">=&gt;</span> Match_type_error
    <span class="main">|</span> Match <span class="bound">env'</span> <span class="main">=&gt;</span> <span class="free">pmatch_list</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="bound">env'</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">pmatch_list</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span> Match_type_error <span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Bind each function of a mutually recursive set of functions to its closure ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val build_rec_env : list (varN * varN * exp) -&gt; sem_env v -&gt; env_val -&gt; env_val›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">build_rec_env</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>varN<span class="main">*</span>varN<span class="main">*</span>exp0<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>namespace "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">build_rec_env</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">cl_env</span></span></span> <span class="free"><span class="bound"><span class="entity">add_to_env</span></span></span> <span class="main">=</span> <span class="main">(</span>
  List.foldr <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">λ</span> <span class="bound">env'</span> <span class="main">.</span>  nsBind <span class="bound">f</span> <span class="main">(</span>Recclosure <span class="free"><span class="bound"><span class="entity">cl_env</span></span></span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="bound">f</span><span class="main">)</span> <span class="bound">env'</span>
  <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">add_to_env</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Lookup in the list of mutually recursive functions ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val find_recfun : forall 'a 'b. varN -&gt; list (varN * 'a * 'b) -&gt; maybe ('a * 'b)›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span>  <span class="entity">find_recfun</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" string <span class="main">⇒</span><span class="main">(</span>string<span class="main">*</span><span class="tfree">'a</span><span class="main">*</span><span class="tfree">'b</span><span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="tfree">'a</span><span class="main">*</span><span class="tfree">'b</span><span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">find_recfun</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> None <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">find_recfun</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span>
          Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="free">find_recfun</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">datatype</span></span> eq_result <span class="main">=</span>
    Eq_val <span class="quoted"><span class="quoted">" bool "</span></span>
  <span class="main">|</span> Eq_type_error

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val do_eq : v -&gt; v -&gt; eq_result›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span> 
<span class="entity">do_eq_list</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>list <span class="main">⇒</span> eq_result "</span></span>  
                   <span class="keyword2"><span class="keyword">and</span></span>
<span class="entity">do_eq</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" v <span class="main">⇒</span> v <span class="main">⇒</span> eq_result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">do_eq</span> <span class="main">(</span>Litv <span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">)</span> <span class="main">(</span>Litv <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> lit_same_type <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="keyword1">then</span> Eq_val <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> Eq_type_error <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">do_eq</span> <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">)</span> <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Eq_val <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">do_eq</span> <span class="main">(</span>Conv <span class="free"><span class="bound"><span class="entity">cn1</span></span></span> <span class="free"><span class="bound"><span class="entity">vs1</span></span></span><span class="main">)</span> <span class="main">(</span>Conv <span class="free"><span class="bound"><span class="entity">cn2</span></span></span> <span class="free"><span class="bound"><span class="entity">vs2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">cn2</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>List.length <span class="free"><span class="bound"><span class="entity">vs1</span></span></span> <span class="main">=</span> List.length <span class="free"><span class="bound"><span class="entity">vs2</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="free">do_eq_list</span> <span class="free"><span class="bound"><span class="entity">vs1</span></span></span> <span class="free"><span class="bound"><span class="entity">vs2</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> ctor_same_type <span class="free"><span class="bound"><span class="entity">cn1</span></span></span> <span class="free"><span class="bound"><span class="entity">cn2</span></span></span> <span class="keyword1">then</span>
    Eq_val False
  <span class="keyword1">else</span>
    Eq_type_error <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">do_eq</span> <span class="main">(</span>Vectorv <span class="free"><span class="bound"><span class="entity">vs1</span></span></span><span class="main">)</span> <span class="main">(</span>Vectorv <span class="free"><span class="bound"><span class="entity">vs2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> List.length <span class="free"><span class="bound"><span class="entity">vs1</span></span></span> <span class="main">=</span> List.length <span class="free"><span class="bound"><span class="entity">vs2</span></span></span> <span class="keyword1">then</span>
    <span class="free">do_eq_list</span> <span class="free"><span class="bound"><span class="entity">vs1</span></span></span> <span class="free"><span class="bound"><span class="entity">vs2</span></span></span>
  <span class="keyword1">else</span>
    Eq_val False <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">do_eq</span> <span class="main">(</span>Closure <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>Closure <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Eq_val True <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">do_eq</span> <span class="main">(</span>Closure <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>Recclosure <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Eq_val True <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">do_eq</span> <span class="main">(</span>Recclosure <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>Closure <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Eq_val True <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">do_eq</span> <span class="main">(</span>Recclosure <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>Recclosure <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Eq_val True <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">do_eq</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span> Eq_type_error <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">do_eq_list</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span> Eq_val True <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">do_eq_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free">do_eq</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="keyword1">of</span>
      Eq_type_error <span class="main">=&gt;</span> Eq_type_error
    <span class="main">|</span> Eq_val <span class="bound">r</span> <span class="main">=&gt;</span>
        <span class="keyword1">if</span> <span class="main">¬</span> <span class="bound">r</span> <span class="keyword1">then</span>
          Eq_val False
        <span class="keyword1">else</span>
          <span class="free">do_eq_list</span> <span class="free"><span class="bound"><span class="entity">vs1</span></span></span> <span class="free"><span class="bound"><span class="entity">vs2</span></span></span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">do_eq_list</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span> Eq_val False <span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val prim_exn : conN -&gt; v›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prim_exn</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" string <span class="main">⇒</span> v "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">prim_exn</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">=</span> <span class="main">(</span> Conv <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn</span></span></span><span class="main">,</span> TypeExn <span class="main">(</span>Short <span class="free"><span class="bound"><span class="entity">cn</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Do an application ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val do_opapp : list v -&gt; maybe (sem_env v * exp)›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">do_opapp</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">*</span>exp0<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">do_opapp</span> <span class="main">(</span><span class="main">[</span>Closure <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      Some <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(|</span> v <span class="main">:=</span> <span class="main">(</span>nsBind <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">do_opapp</span> <span class="main">(</span><span class="main">[</span>Recclosure <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">if</span> allDistinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">x</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">f</span> <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="keyword1">case</span>  find_recfun <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="keyword1">of</span>
            Some <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">=&gt;</span> Some <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(|</span> v <span class="main">:=</span> <span class="main">(</span>nsBind <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span>build_rec_env <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span>
          <span class="main">|</span> None <span class="main">=&gt;</span> None
        <span class="main">)</span>
      <span class="keyword1">else</span>
        None <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">do_opapp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span> None <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> If a value represents a list, get that list. Otherwise return Nothing ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val v_to_list : v -&gt; maybe (list v)›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span>  <span class="entity">v_to_list</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" v <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>list<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">v_to_list</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn</span></span></span><span class="main">,</span> TypeId <span class="main">(</span>Short <span class="free"><span class="bound"><span class="entity">tn</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''nil''</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tn</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''list''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
    Some <span class="main">[]</span>
  <span class="keyword1">else</span>
    None <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">v_to_list</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn</span></span></span><span class="main">,</span>TypeId <span class="main">(</span>Short <span class="free"><span class="bound"><span class="entity">tn</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''::''</span><span class="main">)</span><span class="main">)</span>  <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tn</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''list''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">case</span>  <span class="free">v_to_list</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="keyword1">of</span>
        Some <span class="bound">vs</span> <span class="main">=&gt;</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">#</span> <span class="bound">vs</span><span class="main">)</span>
      <span class="main">|</span> None <span class="main">=&gt;</span> None
    <span class="main">)</span>
  <span class="keyword1">else</span>
    None <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">v_to_list</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span> None <span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val v_to_char_list : v -&gt; maybe (list char)›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span>  <span class="entity">v_to_char_list</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" v <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>char<span class="main">)</span>list<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">v_to_char_list</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn</span></span></span><span class="main">,</span> TypeId <span class="main">(</span>Short <span class="free"><span class="bound"><span class="entity">tn</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''nil''</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tn</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''list''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
    Some <span class="main">[]</span>
  <span class="keyword1">else</span>
    None <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">v_to_char_list</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn</span></span></span><span class="main">,</span>TypeId <span class="main">(</span>Short <span class="free"><span class="bound"><span class="entity">tn</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Litv <span class="main">(</span>Char <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''::''</span><span class="main">)</span><span class="main">)</span>  <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tn</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''list''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">case</span>  <span class="free">v_to_char_list</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="keyword1">of</span>
        Some <span class="bound">cs</span> <span class="main">=&gt;</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">#</span> <span class="bound">cs</span><span class="main">)</span>
      <span class="main">|</span> None <span class="main">=&gt;</span> None
    <span class="main">)</span>
  <span class="keyword1">else</span>
    None <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">v_to_char_list</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span> None <span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val vs_to_string : list v -&gt; maybe string›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span>  <span class="entity">vs_to_string</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>string<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">vs_to_string</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span> Some <span class="main">(</span><span class="inner_quoted">''''</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">vs_to_string</span> <span class="main">(</span>Litv<span class="main">(</span>StrLit <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free">vs_to_string</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="keyword1">of</span>
    Some <span class="bound">s2</span> <span class="main">=&gt;</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">@</span> <span class="bound">s2</span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">vs_to_string</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span> None <span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val copy_array : forall 'a. list 'a * integer -&gt; integer -&gt; maybe (list 'a * integer) -&gt; maybe (list 'a)›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">copy_array</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> list<span class="main">*</span>int <span class="main">⇒</span> int <span class="main">⇒</span><span class="main">(</span><span class="tfree">'a</span> list<span class="main">*</span>int<span class="main">)</span>option <span class="main">⇒</span><span class="main">(</span><span class="tfree">'a</span> list<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">copy_array</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">src</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">srcoff</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">srcoff</span></span></span> <span class="main">&lt;</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> int<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="main">&lt;</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> int<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>List.length <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="main">&lt;</span> nat <span class="main">(</span>abs <span class="main">(</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">srcoff</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> None <span class="keyword1">else</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">copied</span> <span class="main">=</span> <span class="main">(</span>List.take <span class="main">(</span>nat <span class="main">(</span>abs <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>List.drop <span class="main">(</span>nat <span class="main">(</span>abs <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">srcoff</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">src</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">of</span>
      Some <span class="main">(</span><span class="bound">dst</span><span class="main">,</span><span class="bound">dstoff</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword1">if</span> <span class="main">(</span><span class="bound">dstoff</span> <span class="main">&lt;</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> int<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>List.length <span class="bound">dst</span> <span class="main">&lt;</span> nat <span class="main">(</span>abs <span class="main">(</span> <span class="main">(</span><span class="bound">dstoff</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> None <span class="keyword1">else</span>
          Some <span class="main">(</span><span class="main">(</span>List.take <span class="main">(</span>nat <span class="main">(</span>abs <span class="main">(</span> <span class="bound">dstoff</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">dst</span> <span class="main">@</span>
                <span class="bound">copied</span><span class="main">)</span> <span class="main">@</span>
                List.drop <span class="main">(</span>nat <span class="main">(</span>abs <span class="main">(</span> <span class="main">(</span><span class="bound">dstoff</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">dst</span><span class="main">)</span>
    <span class="main">|</span> None <span class="main">=&gt;</span> Some <span class="bound">copied</span>
    <span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val ws_to_chars : list word8 -&gt; list char›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ws_to_chars</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>char<span class="main">)</span>list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">ws_to_chars</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">=</span> <span class="main">(</span> List.map <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span> <span class="main">.</span>  <span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> char_of <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span><span class="main">(</span>unat <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val chars_to_ws : list char -&gt; list word8›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">chars_to_ws</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>char<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">chars_to_ws</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="main">(</span> List.map <span class="main">(</span><span class="main">λ</span> <span class="bound">c2</span> <span class="main">.</span>  word_of_int<span class="main">(</span>int<span class="main">(</span>of_char <span class="bound">c2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val opn_lookup : opn -&gt; integer -&gt; integer -&gt; integer›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">opn_lookup</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" opn <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> int "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">opn_lookup</span> Plus <span class="main">=</span> <span class="main">(</span> <span class="main">(+)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opn_lookup</span> Minus <span class="main">=</span> <span class="main">(</span> <span class="main">(-)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opn_lookup</span> Times <span class="main">=</span> <span class="main">(</span> <span class="main">(*)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opn_lookup</span> Divide <span class="main">=</span> <span class="main">(</span> <span class="keyword1">(div)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opn_lookup</span> Modulo <span class="main">=</span> <span class="main">(</span> <span class="keyword1">(mod)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val opb_lookup : opb -&gt; integer -&gt; integer -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">opb_lookup</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" opb <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">opb_lookup</span> Lt <span class="main">=</span> <span class="main">(</span> <span class="main">(&lt;)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opb_lookup</span> Gt <span class="main">=</span> <span class="main">(</span> <span class="main">(&gt;)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opb_lookup</span> Leq <span class="main">=</span> <span class="main">(</span> <span class="main">(≤)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opb_lookup</span> Geq <span class="main">=</span> <span class="main">(</span> <span class="main">(≥)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val opw8_lookup : opw -&gt; word8 -&gt; word8 -&gt; word8›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">opw8_lookup</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" opw <span class="main">⇒</span> <span class="numeral">8</span> word <span class="main">⇒</span> <span class="numeral">8</span> word <span class="main">⇒</span> <span class="numeral">8</span> word "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">opw8_lookup</span> Andw <span class="main">=</span> <span class="main">(</span> <span class="keyword1">(AND)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opw8_lookup</span> Orw <span class="main">=</span> <span class="main">(</span> <span class="keyword1">(OR)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opw8_lookup</span> Xor <span class="main">=</span> <span class="main">(</span> <span class="keyword1">(XOR)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opw8_lookup</span> Add <span class="main">=</span> <span class="main">(</span> Groups.plus <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opw8_lookup</span> Sub <span class="main">=</span> <span class="main">(</span> Groups.minus <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val opw64_lookup : opw -&gt; word64 -&gt; word64 -&gt; word64›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">opw64_lookup</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" opw <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> <span class="numeral">64</span> word "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">opw64_lookup</span> Andw <span class="main">=</span> <span class="main">(</span> <span class="keyword1">(AND)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opw64_lookup</span> Orw <span class="main">=</span> <span class="main">(</span> <span class="keyword1">(OR)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opw64_lookup</span> Xor <span class="main">=</span> <span class="main">(</span> <span class="keyword1">(XOR)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opw64_lookup</span> Add <span class="main">=</span> <span class="main">(</span> Groups.plus <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opw64_lookup</span> Sub <span class="main">=</span> <span class="main">(</span> Groups.minus <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val shift8_lookup : shift -&gt; word8 -&gt; nat -&gt; word8›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">shift8_lookup</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" shift <span class="main">⇒</span> <span class="numeral">8</span> word <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="numeral">8</span> word "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">shift8_lookup</span> Lsl <span class="main">=</span> <span class="main">(</span> shiftl <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">shift8_lookup</span> Lsr <span class="main">=</span> <span class="main">(</span> shiftr <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">shift8_lookup</span> Asr <span class="main">=</span> <span class="main">(</span> sshiftr <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">shift8_lookup</span> Ror <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="main">%</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> word_rotr <span class="bound">b</span> <span class="bound">a</span><span class="main">)</span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val shift64_lookup : shift -&gt; word64 -&gt; nat -&gt; word64›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">shift64_lookup</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" shift <span class="main">⇒</span> <span class="numeral">64</span> word <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="numeral">64</span> word "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">shift64_lookup</span> Lsl <span class="main">=</span> <span class="main">(</span> shiftl <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">shift64_lookup</span> Lsr <span class="main">=</span> <span class="main">(</span> shiftr <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">shift64_lookup</span> Asr <span class="main">=</span> <span class="main">(</span> sshiftr <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">shift64_lookup</span> Ror <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="main">%</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> word_rotr <span class="bound">b</span> <span class="bound">a</span><span class="main">)</span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val Boolv : bool -&gt; v›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Boolv</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" bool <span class="main">⇒</span> v "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">Boolv</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>
  <span class="keyword1">then</span> Conv <span class="main">(</span>Some <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''true''</span><span class="main">)</span><span class="main">,</span> TypeId <span class="main">(</span>Short <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span>
  <span class="keyword1">else</span> Conv <span class="main">(</span>Some <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''false''</span><span class="main">)</span><span class="main">,</span> TypeId <span class="main">(</span>Short <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">datatype</span></span> exp_or_val <span class="main">=</span>
    Exp <span class="quoted"><span class="quoted">" exp0 "</span></span>
  <span class="main">|</span> Val <span class="quoted"><span class="quoted">" v "</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span><span class="main">(</span> <span class="tfree">'ffi</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> store_ffi <span class="main">=</span><span class="quoted"><span class="quoted">" <span class="tfree">'v</span> store <span class="main">*</span> <span class="tfree">'ffi</span> ffi_state "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val do_app : forall 'ffi. store_ffi 'ffi v -&gt; op -&gt; list v -&gt; maybe (store_ffi 'ffi v * result v v)›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">do_app</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>v<span class="main">)</span>store_v<span class="main">)</span>list<span class="main">*</span><span class="tfree">'ffi</span> ffi_state <span class="main">⇒</span> op0 <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>store_v<span class="main">)</span>list<span class="main">*</span><span class="tfree">'ffi</span> ffi_state<span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">do_app</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">::</span> v store<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">::</span> <span class="tfree">'ffi</span> ffi_state<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">op1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>Opn <span class="bound">op1</span><span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>IntLit <span class="bound">n1</span><span class="main">)</span><span class="main">,</span> Litv <span class="main">(</span>IntLit <span class="bound">n2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="bound">op1</span> <span class="main">=</span> Divide<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">op1</span> <span class="main">=</span> Modulo<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">n2</span> <span class="main">=</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> int<span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
          Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Div''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span>
          Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>IntLit <span class="main">(</span>opn_lookup <span class="bound">op1</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Opb <span class="bound">op1</span><span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>IntLit <span class="bound">n1</span><span class="main">)</span><span class="main">,</span> Litv <span class="main">(</span>IntLit <span class="bound">n2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Boolv <span class="main">(</span>opb_lookup <span class="bound">op1</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Opw W8 <span class="bound">op1</span><span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>Word8 <span class="bound">w1</span><span class="main">)</span><span class="main">,</span> Litv <span class="main">(</span>Word8 <span class="bound">w2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>Word8 <span class="main">(</span>opw8_lookup <span class="bound">op1</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Opw W64 <span class="bound">op1</span><span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>Word64 <span class="bound">w1</span><span class="main">)</span><span class="main">,</span> Litv <span class="main">(</span>Word64 <span class="bound">w2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>Word64 <span class="main">(</span>opw64_lookup <span class="bound">op1</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>FP_bop <span class="bound">bop</span><span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>Word64 <span class="bound">w1</span><span class="main">)</span><span class="main">,</span> Litv <span class="main">(</span>Word64 <span class="bound">w2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span>Rval <span class="main">(</span>Litv <span class="main">(</span>Word64 <span class="main">(</span>fp_bop <span class="bound">bop</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>FP_uop <span class="bound">uop</span><span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>Word64 <span class="bound">w</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span>Rval <span class="main">(</span>Litv <span class="main">(</span>Word64 <span class="main">(</span>fp_uop <span class="bound">uop</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>FP_cmp <span class="bound">cmp</span><span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>Word64 <span class="bound">w1</span><span class="main">)</span><span class="main">,</span> Litv <span class="main">(</span>Word64 <span class="bound">w2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span>Rval <span class="main">(</span>Boolv <span class="main">(</span>fp_cmp <span class="bound">cmp</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Shift W8 <span class="bound">op1</span> <span class="bound">n</span><span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>Word8 <span class="bound">w</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>Word8 <span class="main">(</span>shift8_lookup <span class="bound">op1</span> <span class="bound">w</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Shift W64 <span class="bound">op1</span> <span class="bound">n</span><span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>Word64 <span class="bound">w</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>Word64 <span class="main">(</span>shift64_lookup <span class="bound">op1</span> <span class="bound">w</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Equality<span class="main">,</span> <span class="main">[</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">case</span>  do_eq <span class="bound">v1</span> <span class="bound">v2</span> <span class="keyword1">of</span>
            Eq_type_error <span class="main">=&gt;</span> None
          <span class="main">|</span> Eq_val <span class="bound">b</span> <span class="main">=&gt;</span> Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Boolv <span class="bound">b</span><span class="main">)</span><span class="main">)</span>
        <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Opassign<span class="main">,</span> <span class="main">[</span>Loc <span class="bound">lnum</span><span class="main">,</span> <span class="bound">v2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">case</span>  store_assign <span class="bound">lnum</span> <span class="main">(</span>Refv <span class="bound">v2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
            Some <span class="bound">s'</span> <span class="main">=&gt;</span> Some <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Conv None <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> None <span class="main">=&gt;</span> None
        <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Opref<span class="main">,</span> <span class="main">[</span><span class="bound">v2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>store_alloc <span class="main">(</span>Refv <span class="bound">v2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
          Some <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Loc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Opderef<span class="main">,</span> <span class="main">[</span>Loc <span class="bound">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">case</span>  store_lookup <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
            Some <span class="main">(</span>Refv <span class="bound">v2</span><span class="main">)</span> <span class="main">=&gt;</span> Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span>Rval <span class="bound">v2</span><span class="main">)</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
        <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Aw8alloc<span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>IntLit <span class="bound">n</span><span class="main">)</span><span class="main">,</span> Litv <span class="main">(</span>Word8 <span class="bound">w</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> int<span class="main">)</span> <span class="keyword1">then</span>
          Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">lnum</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span>store_alloc <span class="main">(</span>W8array <span class="main">(</span>List.replicate <span class="main">(</span>nat <span class="main">(</span>abs <span class="main">(</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
          <span class="keyword1">in</span>
            Some <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Loc <span class="bound">lnum</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Aw8sub<span class="main">,</span> <span class="main">[</span>Loc <span class="bound">lnum</span><span class="main">,</span> Litv <span class="main">(</span>IntLit <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">case</span>  store_lookup <span class="bound">lnum</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
            Some <span class="main">(</span>W8array <span class="bound">ws</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> int<span class="main">)</span> <span class="keyword1">then</span>
                Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">(</span>nat <span class="main">(</span>abs <span class="main">(</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
                  <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≥</span> List.length <span class="bound">ws</span> <span class="keyword1">then</span>
                    Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                  <span class="keyword1">else</span>
                    Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>Word8 <span class="main">(</span>List.nth <span class="bound">ws</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
        <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Aw8length<span class="main">,</span> <span class="main">[</span>Loc <span class="bound">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">case</span>  store_lookup <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
            Some <span class="main">(</span>W8array <span class="bound">ws</span><span class="main">)</span> <span class="main">=&gt;</span>
              Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span>Rval <span class="main">(</span>Litv<span class="main">(</span>IntLit<span class="main">(</span>int<span class="main">(</span>List.length <span class="bound">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
         <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Aw8update<span class="main">,</span> <span class="main">[</span>Loc <span class="bound">lnum</span><span class="main">,</span> Litv<span class="main">(</span>IntLit <span class="bound">i</span><span class="main">)</span><span class="main">,</span> Litv<span class="main">(</span>Word8 <span class="bound">w</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">case</span>  store_lookup <span class="bound">lnum</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
          Some <span class="main">(</span>W8array <span class="bound">ws</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> int<span class="main">)</span> <span class="keyword1">then</span>
              Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1">else</span>
              <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">(</span>nat <span class="main">(</span>abs <span class="main">(</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
                <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≥</span> List.length <span class="bound">ws</span> <span class="keyword1">then</span>
                  Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                <span class="keyword1">else</span>
                  <span class="main">(</span><span class="keyword1">case</span>  store_assign <span class="bound">lnum</span> <span class="main">(</span>W8array <span class="main">(</span>List.list_update <span class="bound">ws</span> <span class="bound">n</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
                      None <span class="main">=&gt;</span> None
                    <span class="main">|</span> Some <span class="bound">s'</span> <span class="main">=&gt;</span> Some <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Conv None <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
      <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>WordFromInt W8<span class="main">,</span> <span class="main">[</span>Litv<span class="main">(</span>IntLit <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>Word8 <span class="main">(</span>word_of_int <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>WordFromInt W64<span class="main">,</span> <span class="main">[</span>Litv<span class="main">(</span>IntLit <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>Word64 <span class="main">(</span>word_of_int <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>WordToInt W8<span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>Word8 <span class="bound">w</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>IntLit <span class="main">(</span>int<span class="main">(</span>unat <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>WordToInt W64<span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>Word64 <span class="bound">w</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>IntLit <span class="main">(</span>int<span class="main">(</span>unat <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>CopyStrStr<span class="main">,</span> <span class="main">[</span>Litv<span class="main">(</span>StrLit <span class="bound">str</span><span class="main">)</span><span class="main">,</span>Litv<span class="main">(</span>IntLit <span class="bound">off</span><span class="main">)</span><span class="main">,</span>Litv<span class="main">(</span>IntLit <span class="bound">len</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="keyword1">case</span>  copy_array <span class="main">(</span> <span class="bound">str</span><span class="main">,</span><span class="bound">off</span><span class="main">)</span> <span class="bound">len</span> None <span class="keyword1">of</span>
          None <span class="main">=&gt;</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> Some <span class="bound">cs</span> <span class="main">=&gt;</span> Rval <span class="main">(</span>Litv<span class="main">(</span>StrLit<span class="main">(</span><span class="main">(</span><span class="bound">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>CopyStrAw8<span class="main">,</span> <span class="main">[</span>Litv<span class="main">(</span>StrLit <span class="bound">str</span><span class="main">)</span><span class="main">,</span>Litv<span class="main">(</span>IntLit <span class="bound">off</span><span class="main">)</span><span class="main">,</span>Litv<span class="main">(</span>IntLit <span class="bound">len</span><span class="main">)</span><span class="main">,</span>
                    Loc <span class="bound">dst</span><span class="main">,</span>Litv<span class="main">(</span>IntLit <span class="bound">dstoff</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">case</span>  store_lookup <span class="bound">dst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
          Some <span class="main">(</span>W8array <span class="bound">ws</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="main">(</span><span class="keyword1">case</span>  copy_array <span class="main">(</span> <span class="bound">str</span><span class="main">,</span><span class="bound">off</span><span class="main">)</span> <span class="bound">len</span> <span class="main">(</span>Some<span class="main">(</span>ws_to_chars <span class="bound">ws</span><span class="main">,</span><span class="bound">dstoff</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span>
              None <span class="main">=&gt;</span> Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">|</span> Some <span class="bound">cs</span> <span class="main">=&gt;</span>
              <span class="main">(</span><span class="keyword1">case</span>  store_assign <span class="bound">dst</span> <span class="main">(</span>W8array <span class="main">(</span>chars_to_ws <span class="bound">cs</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
                Some <span class="bound">s'</span> <span class="main">=&gt;</span>  Some <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Conv None <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
              <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
              <span class="main">)</span>
            <span class="main">)</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
        <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>CopyAw8Str<span class="main">,</span> <span class="main">[</span>Loc <span class="bound">src</span><span class="main">,</span>Litv<span class="main">(</span>IntLit <span class="bound">off</span><span class="main">)</span><span class="main">,</span>Litv<span class="main">(</span>IntLit <span class="bound">len</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="main">(</span><span class="keyword1">case</span>  store_lookup <span class="bound">src</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
        Some <span class="main">(</span>W8array <span class="bound">ws</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span>
          <span class="main">(</span><span class="keyword1">case</span>  copy_array <span class="main">(</span><span class="bound">ws</span><span class="main">,</span><span class="bound">off</span><span class="main">)</span> <span class="bound">len</span> None <span class="keyword1">of</span>
            None <span class="main">=&gt;</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> Some <span class="bound">ws</span> <span class="main">=&gt;</span> Rval <span class="main">(</span>Litv<span class="main">(</span>StrLit<span class="main">(</span><span class="main">(</span>ws_to_chars <span class="bound">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
      <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>CopyAw8Aw8<span class="main">,</span> <span class="main">[</span>Loc <span class="bound">src</span><span class="main">,</span>Litv<span class="main">(</span>IntLit <span class="bound">off</span><span class="main">)</span><span class="main">,</span>Litv<span class="main">(</span>IntLit <span class="bound">len</span><span class="main">)</span><span class="main">,</span>
                    Loc <span class="bound">dst</span><span class="main">,</span>Litv<span class="main">(</span>IntLit <span class="bound">dstoff</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="main">(</span><span class="keyword1">case</span>  <span class="main">(</span>store_lookup <span class="bound">src</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> store_lookup <span class="bound">dst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
        <span class="main">(</span>Some <span class="main">(</span>W8array <span class="bound">ws</span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span>W8array <span class="bound">ds</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="main">(</span><span class="keyword1">case</span>  copy_array <span class="main">(</span><span class="bound">ws</span><span class="main">,</span><span class="bound">off</span><span class="main">)</span> <span class="bound">len</span> <span class="main">(</span>Some<span class="main">(</span><span class="bound">ds</span><span class="main">,</span><span class="bound">dstoff</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span>
            None <span class="main">=&gt;</span> Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> Some <span class="bound">ws</span> <span class="main">=&gt;</span>
              <span class="main">(</span><span class="keyword1">case</span>  store_assign <span class="bound">dst</span> <span class="main">(</span>W8array <span class="bound">ws</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
                Some <span class="bound">s'</span> <span class="main">=&gt;</span> Some <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Conv None <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
              <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
              <span class="main">)</span>
          <span class="main">)</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
      <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Ord<span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>Char <span class="bound">c2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
          Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv<span class="main">(</span>IntLit<span class="main">(</span>int<span class="main">(</span>of_char <span class="bound">c2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Chr<span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>IntLit <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> int<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">i</span> <span class="main">&gt;</span><span class="main">(</span> <span class="numeral">255</span> <span class="main">::</span> int<span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
            Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Chr''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1">else</span>
            Rval <span class="main">(</span>Litv<span class="main">(</span>Char<span class="main">(</span><span class="main">(</span><span class="main">%</span><span class="bound">n</span><span class="main">.</span> char_of <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span><span class="main">(</span>nat <span class="main">(</span>abs <span class="main">(</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Chopb <span class="bound">op1</span><span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>Char <span class="bound">c1</span><span class="main">)</span><span class="main">,</span> Litv <span class="main">(</span>Char <span class="bound">c2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Boolv <span class="main">(</span>opb_lookup <span class="bound">op1</span> <span class="main">(</span>int<span class="main">(</span>of_char <span class="bound">c1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>int<span class="main">(</span>of_char <span class="bound">c2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Implode<span class="main">,</span> <span class="main">[</span><span class="bound">v2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="main">(</span><span class="keyword1">case</span>  v_to_char_list <span class="bound">v2</span> <span class="keyword1">of</span>
            Some <span class="bound">ls</span> <span class="main">=&gt;</span>
              Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>StrLit <span class="main">(</span> <span class="bound">ls</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> None <span class="main">=&gt;</span> None
          <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Strsub<span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>StrLit <span class="bound">str</span><span class="main">)</span><span class="main">,</span> Litv <span class="main">(</span>IntLit <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> int<span class="main">)</span> <span class="keyword1">then</span>
          Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">(</span>nat <span class="main">(</span>abs <span class="main">(</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
            <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≥</span> List.length <span class="bound">str</span> <span class="keyword1">then</span>
              Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1">else</span>
              Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>Char <span class="main">(</span>List.nth <span class="main">(</span> <span class="bound">str</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Strlen<span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>StrLit <span class="bound">str</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv<span class="main">(</span>IntLit<span class="main">(</span>int<span class="main">(</span>List.length <span class="bound">str</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Strcat<span class="main">,</span> <span class="main">[</span><span class="bound">v2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">case</span>  v_to_list <span class="bound">v2</span> <span class="keyword1">of</span>
          Some <span class="bound">vs</span> <span class="main">=&gt;</span>
            <span class="main">(</span><span class="keyword1">case</span>  vs_to_string <span class="bound">vs</span> <span class="keyword1">of</span>
              Some <span class="bound">str</span> <span class="main">=&gt;</span>
                Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv<span class="main">(</span>StrLit <span class="bound">str</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
            <span class="main">)</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
        <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>VfromList<span class="main">,</span> <span class="main">[</span><span class="bound">v2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="main">(</span><span class="keyword1">case</span>  v_to_list <span class="bound">v2</span> <span class="keyword1">of</span>
              Some <span class="bound">vs</span> <span class="main">=&gt;</span>
                Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Vectorv <span class="bound">vs</span><span class="main">)</span><span class="main">)</span>
            <span class="main">|</span> None <span class="main">=&gt;</span> None
          <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Vsub<span class="main">,</span> <span class="main">[</span>Vectorv <span class="bound">vs</span><span class="main">,</span> Litv <span class="main">(</span>IntLit <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> int<span class="main">)</span> <span class="keyword1">then</span>
          Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">(</span>nat <span class="main">(</span>abs <span class="main">(</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
            <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≥</span> List.length <span class="bound">vs</span> <span class="keyword1">then</span>
              Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1">else</span>
              Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>List.nth <span class="bound">vs</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Vlength<span class="main">,</span> <span class="main">[</span>Vectorv <span class="bound">vs</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>IntLit <span class="main">(</span>int <span class="main">(</span>List.length <span class="bound">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Aalloc<span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>IntLit <span class="bound">n</span><span class="main">)</span><span class="main">,</span> <span class="bound">v2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> int<span class="main">)</span> <span class="keyword1">then</span>
          Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">lnum</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span>store_alloc <span class="main">(</span>Varray <span class="main">(</span>List.replicate <span class="main">(</span>nat <span class="main">(</span>abs <span class="main">(</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">v2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
          <span class="keyword1">in</span>
            Some <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Loc <span class="bound">lnum</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>AallocEmpty<span class="main">,</span> <span class="main">[</span>Conv None <span class="main">[]</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">lnum</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>store_alloc <span class="main">(</span>Varray <span class="main">[]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
          Some <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Loc <span class="bound">lnum</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Asub<span class="main">,</span> <span class="main">[</span>Loc <span class="bound">lnum</span><span class="main">,</span> Litv <span class="main">(</span>IntLit <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">case</span>  store_lookup <span class="bound">lnum</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
            Some <span class="main">(</span>Varray <span class="bound">vs</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> int<span class="main">)</span> <span class="keyword1">then</span>
                Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">(</span>nat <span class="main">(</span>abs <span class="main">(</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
                  <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≥</span> List.length <span class="bound">vs</span> <span class="keyword1">then</span>
                    Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                  <span class="keyword1">else</span>
                    Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>List.nth <span class="bound">vs</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
        <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Alength<span class="main">,</span> <span class="main">[</span>Loc <span class="bound">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">case</span>  store_lookup <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
            Some <span class="main">(</span>Varray <span class="bound">ws</span><span class="main">)</span> <span class="main">=&gt;</span>
              Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span>Rval <span class="main">(</span>Litv<span class="main">(</span>IntLit<span class="main">(</span>int<span class="main">(</span>List.length <span class="bound">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
         <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Aupdate<span class="main">,</span> <span class="main">[</span>Loc <span class="bound">lnum</span><span class="main">,</span> Litv <span class="main">(</span>IntLit <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="bound">v2</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">case</span>  store_lookup <span class="bound">lnum</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
          Some <span class="main">(</span>Varray <span class="bound">vs</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> int<span class="main">)</span> <span class="keyword1">then</span>
              Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1">else</span>
              <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">(</span>nat <span class="main">(</span>abs <span class="main">(</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
                <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≥</span> List.length <span class="bound">vs</span> <span class="keyword1">then</span>
                  Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>prim_exn <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                <span class="keyword1">else</span>
                  <span class="main">(</span><span class="keyword1">case</span>  store_assign <span class="bound">lnum</span> <span class="main">(</span>Varray <span class="main">(</span>List.list_update <span class="bound">vs</span> <span class="bound">n</span> <span class="bound">v2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
                      None <span class="main">=&gt;</span> None
                    <span class="main">|</span> Some <span class="bound">s'</span> <span class="main">=&gt;</span> Some <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Conv None <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
      <span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>ConfigGC<span class="main">,</span> <span class="main">[</span>Litv <span class="main">(</span>IntLit <span class="bound">i</span><span class="main">)</span><span class="main">,</span> Litv <span class="main">(</span>IntLit <span class="bound">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Conv None <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>FFI <span class="bound">n</span><span class="main">,</span> <span class="main">[</span>Litv<span class="main">(</span>StrLit <span class="bound">conf</span><span class="main">)</span><span class="main">,</span> Loc <span class="bound">lnum</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">case</span>  store_lookup <span class="bound">lnum</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
          Some <span class="main">(</span>W8array <span class="bound">ws</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="main">(</span><span class="keyword1">case</span>  call_FFI <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="bound">n</span> <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span> <span class="bound">c2</span> <span class="main">.</span>  of_nat<span class="main">(</span>of_char <span class="bound">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span> <span class="bound">conf</span><span class="main">)</span><span class="main">)</span> <span class="bound">ws</span> <span class="keyword1">of</span>
              <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="bound">ws'</span><span class="main">)</span> <span class="main">=&gt;</span>
               <span class="main">(</span><span class="keyword1">case</span>  store_assign <span class="bound">lnum</span> <span class="main">(</span>W8array <span class="bound">ws'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
                 Some <span class="bound">s'</span> <span class="main">=&gt;</span> Some <span class="main">(</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(</span>Conv None <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
               <span class="main">|</span> None <span class="main">=&gt;</span> None
               <span class="main">)</span>
            <span class="main">)</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
        <span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
  <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Do a logical operation ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val do_log : lop -&gt; v -&gt; exp -&gt; maybe exp_or_val›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">do_log</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" lop <span class="main">⇒</span> v <span class="main">⇒</span> exp0 <span class="main">⇒</span><span class="main">(</span>exp_or_val<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">do_log</span> And <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="keyword1">of</span>
      Litv <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
    <span class="main">|</span> Conv <span class="bound">m</span> <span class="bound">l2</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">m</span> <span class="keyword1">of</span>
                       None <span class="main">=&gt;</span> None
                     <span class="main">|</span> Some <span class="bound">p</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">p</span> <span class="keyword1">of</span>
                                     <span class="main">(</span><span class="bound">s1</span><span class="main">,</span><span class="bound">t1</span><span class="main">)</span> <span class="main">=&gt;</span>
                                 <span class="keyword1">if</span><span class="main">(</span><span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''true''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
                                   <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t1</span> <span class="keyword1">of</span>
                                        TypeId <span class="bound">i</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">i</span> <span class="keyword1">of</span>
                                                        Short <span class="bound">s2</span> <span class="main">=&gt;</span>
                                                    <span class="keyword1">if</span><span class="main">(</span><span class="bound">s2</span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
                                                      <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l2</span> <span class="keyword1">of</span>
                                                           <span class="main">[]</span> <span class="main">=&gt;</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>
                                                         <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
                                                       <span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None
                                                      <span class="main">|</span> Long <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
                                                    <span class="main">)</span>
                                      <span class="main">|</span> TypeExn <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
                                    <span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span>
                                   <span class="main">(</span>
                                   <span class="keyword1">if</span><span class="main">(</span><span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''false''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
                                     <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t1</span> <span class="keyword1">of</span>
                                          TypeId <span class="bound">i2</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">i2</span> <span class="keyword1">of</span>
                                                           Short <span class="bound">s4</span> <span class="main">=&gt;</span>
                                                       <span class="keyword1">if</span><span class="main">(</span><span class="bound">s4</span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
                                                         <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l2</span> <span class="keyword1">of</span>
                                                              <span class="main">[]</span> <span class="main">=&gt;</span> Some
                                                                    <span class="main">(</span>Val <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>
                                                            <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
                                                          <span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None
                                                         <span class="main">|</span> Long <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                       None
                                                       <span class="main">)</span>
                                        <span class="main">|</span> TypeExn <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
                                      <span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>
                                 <span class="main">)</span>
                   <span class="main">)</span>
    <span class="main">|</span> Closure <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
    <span class="main">|</span> Recclosure <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
    <span class="main">|</span> Loc <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
    <span class="main">|</span> Vectorv <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">do_log</span> Or <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="keyword1">of</span>
      Litv <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
    <span class="main">|</span> Conv <span class="bound">m0</span> <span class="bound">l6</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">m0</span> <span class="keyword1">of</span>
                        None <span class="main">=&gt;</span> None
                      <span class="main">|</span> Some <span class="bound">p0</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">p0</span> <span class="keyword1">of</span>
                                       <span class="main">(</span><span class="bound">s8</span><span class="main">,</span><span class="bound">t0</span><span class="main">)</span> <span class="main">=&gt;</span>
                                   <span class="keyword1">if</span><span class="main">(</span><span class="bound">s8</span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''false''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
                                     <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t0</span> <span class="keyword1">of</span>
                                          TypeId <span class="bound">i5</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">i5</span> <span class="keyword1">of</span>
                                                           Short <span class="bound">s9</span> <span class="main">=&gt;</span>
                                                       <span class="keyword1">if</span><span class="main">(</span><span class="bound">s9</span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
                                                         <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l6</span> <span class="keyword1">of</span>
                                                              <span class="main">[]</span> <span class="main">=&gt;</span> Some
                                                                    <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>
                                                            <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
                                                          <span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None
                                                         <span class="main">|</span> Long <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                       None
                                                       <span class="main">)</span>
                                        <span class="main">|</span> TypeExn <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
                                      <span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span>
                                     <span class="main">(</span>
                                     <span class="keyword1">if</span><span class="main">(</span><span class="bound">s8</span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''true''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
                                       <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t0</span> <span class="keyword1">of</span>
                                            TypeId <span class="bound">i8</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">i8</span> <span class="keyword1">of</span>
                                                             Short <span class="bound">s11</span> <span class="main">=&gt;</span>
                                                         <span class="keyword1">if</span><span class="main">(</span><span class="bound">s11</span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
                                                           <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l6</span> <span class="keyword1">of</span>
                                                                <span class="main">[]</span> <span class="main">=&gt;</span> 
                                                            Some <span class="main">(</span>Val <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>
                                                              <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                            None
                                                            <span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None
                                                           <span class="main">|</span> Long <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                         None
                                                         <span class="main">)</span>
                                          <span class="main">|</span> TypeExn <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
                                        <span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>
                                   <span class="main">)</span>
                    <span class="main">)</span>
    <span class="main">|</span> Closure <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
    <span class="main">|</span> Recclosure <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
    <span class="main">|</span> Loc <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
    <span class="main">|</span> Vectorv <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
  <span class="main">)</span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Do an if-then-else ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val do_if : v -&gt; exp -&gt; exp -&gt; maybe exp›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">do_if</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" v <span class="main">⇒</span> exp0 <span class="main">⇒</span> exp0 <span class="main">⇒</span><span class="main">(</span>exp0<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">do_if</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> <span class="main">(</span>Boolv True<span class="main">)</span> <span class="keyword1">then</span>
    Some <span class="free"><span class="bound"><span class="entity">e1</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> <span class="main">(</span>Boolv False<span class="main">)</span> <span class="keyword1">then</span>
    Some <span class="free"><span class="bound"><span class="entity">e2</span></span></span>
  <span class="keyword1">else</span>
    None <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Semantic helpers for definitions ›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Build a constructor environment for the type definition tds ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val build_tdefs : list modN -&gt; list (list tvarN * typeN * list (conN * list t)) -&gt; env_ctor›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">build_tdefs</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>tvarN<span class="main">)</span>list<span class="main">*</span>string<span class="main">*</span><span class="main">(</span>string<span class="main">*</span><span class="main">(</span>t<span class="main">)</span>list<span class="main">)</span>list<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>nat<span class="main">*</span>tid_or_exn<span class="main">)</span><span class="main">)</span>namespace "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">build_tdefs</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">tds</span></span></span> <span class="main">=</span> <span class="main">(</span>
  alist_to_ns
    <span class="main">(</span>List.rev
      <span class="main">(</span>List.concat
        <span class="main">(</span>List.map
          <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span> <span class="bound">tn</span><span class="main">,</span> <span class="bound">condefs</span><span class="main">)</span> <span class="main">=&gt;</span>
  List.map
    <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span>
                        <span class="main">(</span><span class="bound">conN</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">=&gt;</span>
                    <span class="main">(</span><span class="bound">conN</span><span class="main">,</span> <span class="main">(</span>List.length <span class="bound">ts</span><span class="main">,</span> TypeId <span class="main">(</span>mk_id <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="bound">tn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">)</span><span class="main">)</span> <span class="bound">condefs</span>
  <span class="main">)</span><span class="main">)</span>
          <span class="free"><span class="bound"><span class="entity">tds</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Checks that no constructor is defined twice in a type ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val check_dup_ctors : list (list tvarN * typeN * list (conN * list t)) -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_dup_ctors</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>tvarN<span class="main">)</span>list<span class="main">*</span>string<span class="main">*</span><span class="main">(</span>string<span class="main">*</span><span class="main">(</span>t<span class="main">)</span>list<span class="main">)</span>list<span class="main">)</span>list <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">check_dup_ctors</span> <span class="free"><span class="bound"><span class="entity">tds</span></span></span> <span class="main">=</span> <span class="main">(</span>
  Lem_list.allDistinct <span class="main">(</span><span class="main">(</span><span class="keyword1">let</span> <span class="bound">x2</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">[]</span><span class="main">)</span> <span class="keyword1">in</span>  List.foldr
   <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span>
                      <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span> <span class="bound">tn</span><span class="main">,</span> <span class="bound">condefs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">λ</span> <span class="bound">x2</span> <span class="main">.</span>  List.foldr
                                                              <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
                                                               <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span>
                                                                   <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">=&gt;</span> 
                                                               <span class="main">λ</span> <span class="bound">x2</span> <span class="main">.</span> 
                                                                 <span class="keyword1">if</span> True <span class="keyword1">then</span>
                                                                   <span class="bound">n</span> <span class="main">#</span> <span class="bound">x2</span>
                                                                 <span class="keyword1">else</span> 
                                                                 <span class="bound">x2</span>
                                                               <span class="main">)</span><span class="main">)</span> <span class="bound">condefs</span> 
                                                            <span class="bound">x2</span>
                  <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tds</span></span></span> <span class="bound">x2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val combine_dec_result : forall 'a. sem_env v -&gt; result (sem_env v) 'a -&gt; result (sem_env v) 'a›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine_dec_result</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>result <span class="main">⇒</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span>result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">combine_dec_result</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Rerr <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Rerr <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">combine_dec_result</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Rval <span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Rval <span class="main">(|</span> v <span class="main">=</span> <span class="main">(</span>nsAppend<span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">)</span><span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> c <span class="main">=</span> <span class="main">(</span>nsAppend<span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">)</span><span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val extend_dec_env : sem_env v -&gt; sem_env v -&gt; sem_env v›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extend_dec_env</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">extend_dec_env</span> <span class="free"><span class="bound"><span class="entity">new_env</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(|</span> v <span class="main">=</span> <span class="main">(</span>nsAppend<span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">new_env</span></span></span><span class="main">)</span><span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> c <span class="main">=</span> <span class="main">(</span>nsAppend<span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">new_env</span></span></span><span class="main">)</span><span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span>  <span class="main">|)</span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val decs_to_types : list dec -&gt; list typeN›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">decs_to_types</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dec<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>string<span class="main">)</span>list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">decs_to_types</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">=</span> <span class="main">(</span>
  List.concat <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span> <span class="bound">d</span> <span class="main">.</span> 
        <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">d</span> <span class="keyword1">of</span>
            Dtype <span class="bound">locs</span> <span class="bound">tds</span> <span class="main">=&gt;</span> List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span><span class="bound">tn</span><span class="main">,</span><span class="bound">ctors</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">tn</span> <span class="main">)</span><span class="main">)</span> <span class="bound">tds</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="main">[]</span> <span class="main">)</span><span class="main">)</span>
     <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val no_dup_types : list dec -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">no_dup_types</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dec<span class="main">)</span>list <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">no_dup_types</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">=</span> <span class="main">(</span>
  Lem_list.allDistinct <span class="main">(</span>decs_to_types <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val prog_to_mods : list top -&gt; list (list modN)›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prog_to_mods</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>top0<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>string<span class="main">)</span>list<span class="main">)</span>list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">prog_to_mods</span> <span class="free"><span class="bound"><span class="entity">tops</span></span></span> <span class="main">=</span> <span class="main">(</span>
  List.concat <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span> <span class="bound">top1</span> <span class="main">.</span> 
        <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">top1</span> <span class="keyword1">of</span>
            Tmod <span class="bound">mn</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">[</span><span class="bound">mn</span><span class="main">]</span><span class="main">]</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="main">[]</span> <span class="main">)</span><span class="main">)</span>
     <span class="free"><span class="bound"><span class="entity">tops</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val no_dup_mods : list top -&gt; set (list modN) -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">no_dup_mods</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>top0<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>modN<span class="main">)</span>list<span class="main">)</span>set <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">no_dup_mods</span> <span class="free"><span class="bound"><span class="entity">tops</span></span></span> <span class="free"><span class="bound"><span class="entity">defined_mods2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  Lem_list.allDistinct <span class="main">(</span>prog_to_mods <span class="free"><span class="bound"><span class="entity">tops</span></span></span><span class="main">)</span> <span class="main">∧</span>
  disjnt <span class="main">(</span>List.set <span class="main">(</span>prog_to_mods <span class="free"><span class="bound"><span class="entity">tops</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">defined_mods2</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val prog_to_top_types : list top -&gt; list typeN›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prog_to_top_types</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>top0<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>string<span class="main">)</span>list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">prog_to_top_types</span> <span class="free"><span class="bound"><span class="entity">tops</span></span></span> <span class="main">=</span> <span class="main">(</span>
  List.concat <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span> <span class="bound">top1</span> <span class="main">.</span> 
        <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">top1</span> <span class="keyword1">of</span>
            Tdec <span class="bound">d</span> <span class="main">=&gt;</span> decs_to_types <span class="main">[</span><span class="bound">d</span><span class="main">]</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="main">[]</span> <span class="main">)</span><span class="main">)</span>
     <span class="free"><span class="bound"><span class="entity">tops</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val no_dup_top_types : list top -&gt; set tid_or_exn -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">no_dup_top_types</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>top0<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>tid_or_exn<span class="main">)</span>set <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">no_dup_top_types</span> <span class="free"><span class="bound"><span class="entity">tops</span></span></span> <span class="free"><span class="bound"><span class="entity">defined_types2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  Lem_list.allDistinct <span class="main">(</span>prog_to_top_types <span class="free"><span class="bound"><span class="entity">tops</span></span></span><span class="main">)</span> <span class="main">∧</span>
  disjnt <span class="main">(</span>List.set <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span> <span class="bound">tn</span> <span class="main">.</span>  TypeId <span class="main">(</span>Short <span class="bound">tn</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>prog_to_top_types <span class="free"><span class="bound"><span class="entity">tops</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">defined_types2</span></span></span> <span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SmallStep">
<div class="head">
<h1>Theory SmallStep</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/alt_semantics/smallStep.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"SmallStep"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives_extra">LEM.Lem_pervasives_extra</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>
  <span class="quoted">"<a href="#Namespace">Namespace</a>"</span>
  <span class="quoted">"<a href="#Ast">Ast</a>"</span>
  <span class="quoted">"<a href="#SemanticPrimitives">SemanticPrimitives</a>"</span>
  <span class="quoted">"<a href="#Ffi">Ffi</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives_extra›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Lib›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Ast›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Namespace›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import SemanticPrimitives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Ffi›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Small-step semantics for expression only.  Modules and definitions have
 * big-step semantics only ›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Evaluation contexts
 * The hole is denoted by the unit type
 * The env argument contains bindings for the free variables of expressions in
     the context ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> ctxt_frame <span class="main">=</span>
    Craise <span class="quoted"><span class="quoted">" unit "</span></span>
  <span class="main">|</span> Chandle <span class="quoted"><span class="quoted">" unit "</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>pat <span class="main">*</span> exp0<span class="main">)</span> list "</span></span>
  <span class="main">|</span> Capp <span class="quoted"><span class="quoted">" op0 "</span></span> <span class="quoted"><span class="quoted">" v list "</span></span> <span class="quoted"><span class="quoted">" unit "</span></span> <span class="quoted"><span class="quoted">" exp0 list "</span></span>
  <span class="main">|</span> Clog <span class="quoted"><span class="quoted">" lop "</span></span> <span class="quoted"><span class="quoted">" unit "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span>
  <span class="main">|</span> Cif <span class="quoted"><span class="quoted">" unit "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> The value is raised if none of the patterns match ›</span></span>›</span>
  <span class="main">|</span> Cmat <span class="quoted"><span class="quoted">" unit "</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>pat <span class="main">*</span> exp0<span class="main">)</span> list "</span></span> <span class="quoted"><span class="quoted">" v "</span></span>
  <span class="main">|</span> Clet <span class="quoted"><span class="quoted">"  varN option "</span></span> <span class="quoted"><span class="quoted">" unit "</span></span> <span class="quoted"><span class="quoted">" exp0 "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Evaluating a constructor's arguments
   * The v list should be in reverse order. ›</span></span>›</span>
  <span class="main">|</span> Ccon <span class="quoted"><span class="quoted">"  <span class="main">(</span> <span class="main">(</span>modN<span class="main">,</span> conN<span class="main">)</span>id0<span class="main">)</span>option "</span></span> <span class="quoted"><span class="quoted">" v list "</span></span> <span class="quoted"><span class="quoted">" unit "</span></span> <span class="quoted"><span class="quoted">" exp0 list "</span></span>
  <span class="main">|</span> Ctannot <span class="quoted"><span class="quoted">" unit "</span></span> <span class="quoted"><span class="quoted">" t "</span></span>
  <span class="main">|</span> Clannot <span class="quoted"><span class="quoted">" unit "</span></span> <span class="quoted"><span class="quoted">" locs "</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> ctxt <span class="main">=</span><span class="quoted"><span class="quoted">" ctxt_frame <span class="main">*</span> v sem_env "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> State for CEK-style expression evaluation
 * - constructor data
 * - the store
 * - the environment for the free variables of the current expression
 * - the current expression to evaluate, or a value if finished
 * - the context stack (continuation) of what to do once the current expression
 *   is finished.  Each entry has an environment for it's free variables ›</span></span>›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'ffi</span> small_state <span class="main">=</span><span class="quoted"><span class="quoted">" v sem_env <span class="main">*</span> <span class="main">(</span><span class="tfree">'ffi</span><span class="main">,</span> v<span class="main">)</span> store_ffi <span class="main">*</span> exp_or_val <span class="main">*</span> ctxt list "</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'ffi</span> e_step_result <span class="main">=</span>
    Estep <span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> small_state "</span></span>
  <span class="main">|</span> Eabort <span class="quoted"><span class="quoted">" abort "</span></span>
  <span class="main">|</span> Estuck

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> The semantics are deterministic, and presented functionally instead of
 * relationally for proof rather that readability; the steps are very small: we
 * push individual frames onto the context stack instead of finding a redex in a
 * single step ›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val push : forall 'ffi. sem_env v -&gt; store_ffi 'ffi v -&gt; exp -&gt; ctxt_frame -&gt; list ctxt -&gt; e_step_result 'ffi›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">push</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>store<span class="main">*</span><span class="tfree">'ffi</span> ffi_state <span class="main">⇒</span> exp0 <span class="main">⇒</span> ctxt_frame <span class="main">⇒</span><span class="main">(</span>ctxt_frame<span class="main">*</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> e_step_result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">push</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="main">(</span> Estep <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val return : forall 'ffi. sem_env v -&gt; store_ffi 'ffi v -&gt; v -&gt; list ctxt -&gt; e_step_result 'ffi›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">return</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>store<span class="main">*</span><span class="tfree">'ffi</span> ffi_state <span class="main">⇒</span> v <span class="main">⇒</span><span class="main">(</span>ctxt<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> e_step_result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">return</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">=</span> <span class="main">(</span> Estep <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Val <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val application : forall 'ffi. op -&gt; sem_env v -&gt; store_ffi 'ffi v -&gt; list v -&gt; list ctxt -&gt; e_step_result 'ffi›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">application</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" op0 <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>store<span class="main">*</span><span class="tfree">'ffi</span> ffi_state <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>ctxt<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> e_step_result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">application</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="keyword1">of</span>
      Opapp <span class="main">=&gt;</span>
      <span class="main">(</span><span class="keyword1">case</span>  do_opapp <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="keyword1">of</span>
          Some <span class="main">(</span><span class="bound">env</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">=&gt;</span> Estep <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Exp <span class="bound">e</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>
        <span class="main">|</span> None <span class="main">=&gt;</span> Eabort Rtype_error
      <span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span>
      <span class="main">(</span><span class="keyword1">case</span>  do_app <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="keyword1">of</span>
          Some <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">r</span> <span class="keyword1">of</span>
              Rerr <span class="main">(</span>Rraise <span class="bound">v2</span><span class="main">)</span> <span class="main">=&gt;</span> Estep <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span><span class="bound">s'</span><span class="main">,</span>Val <span class="bound">v2</span><span class="main">,</span><span class="main">(</span><span class="main">(</span>Craise <span class="main">()</span> <span class="main">,</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span><span class="main">)</span>
            <span class="main">|</span> Rerr <span class="main">(</span>Rabort <span class="bound">a</span><span class="main">)</span> <span class="main">=&gt;</span> Eabort <span class="bound">a</span>
            <span class="main">|</span> Rval <span class="bound">v2</span> <span class="main">=&gt;</span> return <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">s'</span> <span class="bound">v2</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
          <span class="main">)</span>
        <span class="main">|</span> None <span class="main">=&gt;</span> Eabort Rtype_error
      <span class="main">)</span>
    <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> apply a context to a value ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val continue : forall 'ffi. store_ffi 'ffi v -&gt; v -&gt; list ctxt -&gt; e_step_result 'ffi›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">continue</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>store<span class="main">*</span><span class="tfree">'ffi</span> ffi_state <span class="main">⇒</span> v <span class="main">⇒</span><span class="main">(</span>ctxt_frame<span class="main">*</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> e_step_result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Estuck <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span>Craise <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="keyword1">of</span>
            <span class="main">[]</span> <span class="main">=&gt;</span> Estuck
          <span class="main">|</span> <span class="main">(</span><span class="main">(</span>Chandle <span class="main"><span class="bound">_</span></span> <span class="bound">pes</span><span class="main">,</span><span class="bound">env'</span><span class="main">)</span> <span class="main">#</span> <span class="bound">c2</span><span class="main">)</span> <span class="main">=&gt;</span>
              Estep <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>Val <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span><span class="main">(</span><span class="main">(</span>Cmat <span class="main">()</span>  <span class="bound">pes</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span><span class="main">#</span> <span class="bound">c2</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="bound">c2</span> <span class="main">=&gt;</span> Estep <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>Val <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span><span class="main">(</span><span class="main">(</span>Craise <span class="main">()</span> <span class="main">,</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">#</span> <span class="bound">c2</span><span class="main">)</span><span class="main">)</span>
        <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span>Chandle <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        return <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span>Capp <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        application <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span>Capp <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        push <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Capp <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">()</span>  <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span>Clog <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="main">(</span><span class="keyword1">case</span>  do_log <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span>
            Some <span class="main">(</span>Exp <span class="bound">e</span><span class="main">)</span> <span class="main">=&gt;</span> Estep <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Exp <span class="bound">e</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>
          <span class="main">|</span> Some <span class="main">(</span>Val <span class="bound">v2</span><span class="main">)</span> <span class="main">=&gt;</span> return <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">v2</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
          <span class="main">|</span> None <span class="main">=&gt;</span> Eabort Rtype_error
        <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span>Cif <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="main">(</span><span class="keyword1">case</span>  do_if <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="keyword1">of</span>
            Some <span class="bound">e</span> <span class="main">=&gt;</span> Estep <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Exp <span class="bound">e</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>
          <span class="main">|</span> None <span class="main">=&gt;</span> Eabort Rtype_error
        <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span>Cmat <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">err_v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        Estep <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Val <span class="free"><span class="bound"><span class="entity">err_v</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Craise <span class="main">()</span> <span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span>Cmat <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">err_v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword1">if</span> Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">then</span>
          <span class="main">(</span><span class="keyword1">case</span>  pmatch<span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">[]</span> <span class="keyword1">of</span>
              Match_type_error <span class="main">=&gt;</span> Eabort Rtype_error
            <span class="main">|</span> No_match <span class="main">=&gt;</span> Estep <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Val <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Cmat <span class="main">()</span>  <span class="free"><span class="bound"><span class="entity">pes</span></span></span> <span class="free"><span class="bound"><span class="entity">err_v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span><span class="main">)</span>
            <span class="main">|</span> Match <span class="bound">env'</span> <span class="main">=&gt;</span> Estep <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(|</span> v <span class="main">:=</span> <span class="main">(</span>nsAppend <span class="main">(</span>alist_to_ns <span class="bound">env'</span><span class="main">)</span><span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>
          <span class="main">)</span>
        <span class="keyword1">else</span>
          Eabort Rtype_error <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span>Clet <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        Estep <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(|</span> v <span class="main">:=</span> <span class="main">(</span>nsOptBind <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span>Ccon <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword1">if</span> do_con_check<span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>List.length <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">+</span><span class="main">(</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
           <span class="main">(</span><span class="keyword1">case</span>  build_conv<span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
               None <span class="main">=&gt;</span> Eabort Rtype_error
             <span class="main">|</span> Some <span class="bound">v2</span> <span class="main">=&gt;</span> return <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">v2</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
           <span class="main">)</span>
        <span class="keyword1">else</span>
          Eabort Rtype_error <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span>Ccon <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword1">if</span> do_con_check<span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>List.length <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">+</span><span class="main">(</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">+</span><span class="main">(</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">+</span> List.length <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
          push <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Ccon <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">()</span>  <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
        <span class="keyword1">else</span>
          Eabort Rtype_error <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span>Ctannot <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        return <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">continue</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span>Clannot <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        return <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> The single step expression evaluator.  Returns None if there is nothing to
 * do, but no type error.  Returns Type_error on encountering free variables,
 * mis-applied (or non-existent) constructors, and when the wrong kind of value
 * if given to a primitive.  Returns Bind_error when no pattern in a match
 * matches the value.  Otherwise it returns the next state ›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val e_step : forall 'ffi. small_state 'ffi -&gt; e_step_result 'ffi›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">e_step</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">*</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>store<span class="main">*</span><span class="tfree">'ffi</span> ffi_state<span class="main">)</span><span class="main">*</span>exp_or_val<span class="main">*</span><span class="main">(</span>ctxt<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> e_step_result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">e_step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="main">(</span>Val <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        continue <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">e_step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span>
            Lit <span class="bound">l</span> <span class="main">=&gt;</span> return <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Litv <span class="bound">l</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
          <span class="main">|</span> Raise <span class="bound">e</span> <span class="main">=&gt;</span>
              push <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">e</span> <span class="main">(</span>Craise <span class="main">()</span> <span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
          <span class="main">|</span> Handle <span class="bound">e</span> <span class="bound">pes</span> <span class="main">=&gt;</span>
              push <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">e</span> <span class="main">(</span>Chandle <span class="main">()</span>  <span class="bound">pes</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
          <span class="main">|</span> Con <span class="bound">n</span> <span class="bound">es</span> <span class="main">=&gt;</span>
              <span class="keyword1">if</span> do_con_check<span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="bound">n</span> <span class="main">(</span>List.length <span class="bound">es</span><span class="main">)</span> <span class="keyword1">then</span>
                <span class="main">(</span><span class="keyword1">case</span>  List.rev <span class="bound">es</span> <span class="keyword1">of</span>
                    <span class="main">[]</span> <span class="main">=&gt;</span>
                      <span class="main">(</span><span class="keyword1">case</span>  build_conv<span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="bound">n</span> <span class="main">[]</span> <span class="keyword1">of</span>
                          None <span class="main">=&gt;</span> Eabort Rtype_error
                        <span class="main">|</span> Some <span class="bound">v2</span> <span class="main">=&gt;</span> return <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">v2</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
                      <span class="main">)</span>
                  <span class="main">|</span> <span class="bound">e</span> <span class="main">#</span> <span class="bound">es</span> <span class="main">=&gt;</span>
                      push <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">e</span> <span class="main">(</span>Ccon <span class="bound">n</span> <span class="main">[]</span> <span class="main">()</span>  <span class="bound">es</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
                <span class="main">)</span>
              <span class="keyword1">else</span>
                Eabort Rtype_error
          <span class="main">|</span> Var <span class="bound">n</span> <span class="main">=&gt;</span>
              <span class="main">(</span><span class="keyword1">case</span>  nsLookup<span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="bound">n</span> <span class="keyword1">of</span>
                  None <span class="main">=&gt;</span> Eabort Rtype_error
                <span class="main">|</span> Some <span class="bound">v2</span> <span class="main">=&gt;</span>
                    return <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">v2</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
              <span class="main">)</span>
          <span class="main">|</span> Fun <span class="bound">n</span> <span class="bound">e</span> <span class="main">=&gt;</span> return <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Closure <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">n</span> <span class="bound">e</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
          <span class="main">|</span> App <span class="bound">op1</span> <span class="bound">es</span> <span class="main">=&gt;</span>
              <span class="main">(</span><span class="keyword1">case</span>  List.rev <span class="bound">es</span> <span class="keyword1">of</span>
                  <span class="main">[]</span> <span class="main">=&gt;</span> application <span class="bound">op1</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
                <span class="main">|</span> <span class="main">(</span><span class="bound">e</span> <span class="main">#</span> <span class="bound">es</span><span class="main">)</span> <span class="main">=&gt;</span> push <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">e</span> <span class="main">(</span>Capp <span class="bound">op1</span> <span class="main">[]</span> <span class="main">()</span>  <span class="bound">es</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
              <span class="main">)</span>
          <span class="main">|</span> Log <span class="bound">l</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="main">=&gt;</span> push <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">e1</span> <span class="main">(</span>Clog <span class="bound">l</span> <span class="main">()</span>  <span class="bound">e2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
          <span class="main">|</span> If <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="main">=&gt;</span> push <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">e1</span> <span class="main">(</span>Cif <span class="main">()</span>  <span class="bound">e2</span> <span class="bound">e3</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
          <span class="main">|</span> Mat <span class="bound">e</span> <span class="bound">pes</span> <span class="main">=&gt;</span> push <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">e</span> <span class="main">(</span>Cmat <span class="main">()</span>  <span class="bound">pes</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''Bind''</span><span class="main">)</span><span class="main">,</span> TypeExn <span class="main">(</span>Short <span class="main">(</span><span class="inner_quoted">''Bind''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
          <span class="main">|</span> Let <span class="bound">n</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="main">=&gt;</span> push <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">e1</span> <span class="main">(</span>Clet <span class="bound">n</span> <span class="main">()</span>  <span class="bound">e2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
          <span class="main">|</span> Letrec <span class="bound">funs</span> <span class="bound">e</span> <span class="main">=&gt;</span>
              <span class="keyword1">if</span> <span class="main">¬</span> <span class="main">(</span>allDistinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">x</span> <span class="main">)</span><span class="main">)</span> <span class="bound">funs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
                Eabort Rtype_error
              <span class="keyword1">else</span>
                Estep <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(|</span> v <span class="main">:=</span> <span class="main">(</span>build_rec_env <span class="bound">funs</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span>
                       <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Exp <span class="bound">e</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>
          <span class="main">|</span> Tannot <span class="bound">e</span> <span class="bound">t1</span> <span class="main">=&gt;</span> push <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">e</span> <span class="main">(</span>Ctannot <span class="main">()</span>  <span class="bound">t1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
          <span class="main">|</span> Lannot <span class="bound">e</span> <span class="bound">l</span> <span class="main">=&gt;</span> push <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">e</span> <span class="main">(</span>Clannot <span class="main">()</span>  <span class="bound">l</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
        <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Define a semantic function using the steps ›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val e_step_reln : forall 'ffi. small_state 'ffi -&gt; small_state 'ffi -&gt; bool›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val small_eval : forall 'ffi. sem_env v -&gt; store_ffi 'ffi v -&gt; exp -&gt; list ctxt -&gt; store_ffi 'ffi v * result v v -&gt; bool›</span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e_step_reln</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">*</span><span class="main">(</span><span class="tfree">'ffi</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>store_ffi<span class="main">*</span>exp_or_val<span class="main">*</span><span class="main">(</span>ctxt<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">*</span><span class="main">(</span><span class="tfree">'ffi</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>store_ffi<span class="main">*</span>exp_or_val<span class="main">*</span><span class="main">(</span>ctxt<span class="main">)</span>list <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">e_step_reln</span> <span class="free"><span class="bound"><span class="entity">st1</span></span></span> <span class="free"><span class="bound"><span class="entity">st2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span>e_step <span class="free"><span class="bound"><span class="entity">st1</span></span></span> <span class="main">=</span> Estep <span class="free"><span class="bound"><span class="entity">st2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> 
<span class="entity">small_eval</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>store<span class="main">*</span><span class="tfree">'ffi</span> ffi_state <span class="main">⇒</span> exp0 <span class="main">⇒</span><span class="main">(</span>ctxt<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>store<span class="main">*</span><span class="tfree">'ffi</span> ffi_state<span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">small_eval</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>
  <span class="main">∃</span> <span class="bound">env'</span><span class="main">.</span>  <span class="main">(</span>rtranclp <span class="main">(</span>e_step_reln<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>Exp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">env'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span>Val <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">small_eval</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>
  <span class="main">∃</span> <span class="bound">env'</span><span class="main">.</span> 
  <span class="main">∃</span> <span class="bound">env''</span><span class="main">.</span>  <span class="main">(</span>rtranclp <span class="main">(</span>e_step_reln<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>Exp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">env'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span>Val <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span><span class="main">[</span><span class="main">(</span>Craise <span class="main">()</span> <span class="main">,</span> <span class="bound">env''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">small_eval</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>
  <span class="main">∃</span> <span class="bound">env'</span><span class="main">.</span> 
  <span class="main">∃</span> <span class="bound">e'</span><span class="main">.</span> 
  <span class="main">∃</span> <span class="bound">c'</span><span class="main">.</span> 
    <span class="main">(</span>rtranclp <span class="main">(</span>e_step_reln<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>Exp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">env'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span><span class="bound">e'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>e_step <span class="main">(</span><span class="bound">env'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span><span class="bound">e'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span> <span class="main">=</span> Eabort <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val e_diverges : forall 'ffi. sem_env v -&gt; store_ffi 'ffi v -&gt; exp -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e_diverges</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>store<span class="main">*</span><span class="tfree">'ffi</span> ffi_state <span class="main">⇒</span> exp0 <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">e_diverges</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>
  <span class="main">∀</span> <span class="bound">env'</span><span class="main">.</span> 
  <span class="main">∀</span> <span class="bound">s'</span><span class="main">.</span> 
  <span class="main">∀</span> <span class="bound">e'</span><span class="main">.</span> 
  <span class="main">∀</span> <span class="bound">c'</span><span class="main">.</span> 
    <span class="main">(</span>rtranclp <span class="main">(</span>e_step_reln<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>Exp <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="bound">env'</span><span class="main">,</span><span class="bound">s'</span><span class="main">,</span><span class="bound">e'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span>
    <span class="main">⟶</span>
<span class="main">(</span><span class="main">(</span><span class="main">∃</span> <span class="bound">env''</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">s''</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">e''</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">c''</span><span class="main">.</span> 
      e_step_reln <span class="main">(</span><span class="bound">env'</span><span class="main">,</span><span class="bound">s'</span><span class="main">,</span><span class="bound">e'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span> <span class="main">(</span><span class="bound">env''</span><span class="main">,</span><span class="bound">s''</span><span class="main">,</span><span class="bound">e''</span><span class="main">,</span><span class="bound">c''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BigStep">
<div class="head">
<h1>Theory BigStep</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/alt_semantics/bigStep.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"BigStep"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives_extra">LEM.Lem_pervasives_extra</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>
  <span class="quoted">"<a href="#Namespace">Namespace</a>"</span>
  <span class="quoted">"<a href="#Ast">Ast</a>"</span>
  <span class="quoted">"<a href="#SemanticPrimitives">SemanticPrimitives</a>"</span>
  <span class="quoted">"<a href="#Ffi">Ffi</a>"</span>
  <span class="quoted">"<a href="#SmallStep">SmallStep</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives_extra›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Lib›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Namespace›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Ast›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import SemanticPrimitives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Ffi›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> To get the definition of expression divergence to use in defining definition
 * divergence ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import SmallStep›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> ------------------------ Big step semantics -------------------------- ›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> If the first argument is true, the big step semantics counts down how many
   functions applications have happened, and raises an exception when the counter
   runs out. ›</span></span>›</span>

<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">evaluate_match</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" bool <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> v <span class="main">⇒</span><span class="main">(</span>pat<span class="main">*</span>exp0<span class="main">)</span>list <span class="main">⇒</span> v <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>  
      <span class="keyword2"><span class="keyword">and</span></span>
<span class="entity">evaluate_list</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" bool <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span><span class="main">(</span>exp0<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>list<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>  
      <span class="keyword2"><span class="keyword">and</span></span>
<span class="entity">evaluate</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" bool <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> exp0 <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"lit"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">l</span> <span class="bound">s</span><span class="main">.</span>

<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Lit <span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"raise1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">v1</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">env</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">env</span> <span class="main">(</span>Raise <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="bound">v1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"raise2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">err</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">env</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">env</span> <span class="main">(</span>Raise <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"handle1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">v1</span> <span class="bound">pes</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">env</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">env</span> <span class="main">(</span>Handle <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"handle2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">v1</span> <span class="bound">bv</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="bound">v1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate_match</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">v1</span> <span class="bound">pes</span> <span class="bound">v1</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Handle <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"handle3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">a</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort <span class="bound">a</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Handle <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"con1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">cn</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">v1</span><span class="main">.</span>
do_con_check<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">(</span>List.length <span class="bound">es</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span>build_conv<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v1</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Con <span class="bound">cn</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"con2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">cn</span> <span class="bound">es</span> <span class="bound">s</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span>do_con_check<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">(</span>List.length <span class="bound">es</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Con <span class="bound">cn</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"con3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">cn</span> <span class="bound">es</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
do_con_check<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">(</span>List.length <span class="bound">es</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Con <span class="bound">cn</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"var1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">n</span> <span class="bound">v1</span> <span class="bound">s</span><span class="main">.</span>
nsLookup<span class="main">(</span>v   <span class="bound">env</span><span class="main">)</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">v1</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Var <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"var2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">.</span>
nsLookup<span class="main">(</span>v   <span class="bound">env</span><span class="main">)</span> <span class="bound">n</span> <span class="main">=</span> None
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Var <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"fn"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">n</span> <span class="bound">e</span> <span class="bound">s</span><span class="main">.</span>

<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Fun <span class="bound">n</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="main">(</span>Closure <span class="bound">env</span> <span class="bound">n</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">env'</span> <span class="bound">e</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span>do_opapp <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">env'</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span><span class="bound">ck</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="main">(</span><span class="main">(</span>clock   <span class="bound">s2</span><span class="main">)</span> <span class="main">=</span><span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env'</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">ck</span> <span class="keyword1">then</span> <span class="main">(</span> <span class="bound">s2</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">(</span><span class="main">(</span>clock   <span class="bound">s2</span><span class="main">)</span> <span class="main">-</span><span class="main">(</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">s2</span><span class="main">)</span> <span class="bound">e</span> <span class="bound">bv</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>App Opapp <span class="bound">es</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"app2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">env'</span> <span class="bound">e</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span>do_opapp <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">env'</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span><span class="main">(</span>clock   <span class="bound">s2</span><span class="main">)</span> <span class="main">=</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="bound">ck</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>App Opapp <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>do_opapp <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> None<span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>App Opapp <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app4"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">res</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">refs'</span> <span class="bound">ffi'</span><span class="main">.</span>
<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span>do_app <span class="main">(</span><span class="main">(</span>refs   <span class="bound">s2</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>ffi   <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="bound">op0</span> <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="bound">refs'</span><span class="main">,</span><span class="bound">ffi'</span><span class="main">)</span><span class="main">,</span> <span class="bound">res</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="bound">op0</span> <span class="main">≠</span> Opapp<span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>App <span class="bound">op0</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span> <span class="bound">s2</span> <span class="main">(|</span> refs <span class="main">:=</span> <span class="bound">refs'</span><span class="main">,</span> ffi <span class="main">:=</span><span class="bound">ffi'</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> <span class="bound">res</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app5"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span>do_app <span class="main">(</span><span class="main">(</span>refs   <span class="bound">s2</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>ffi   <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="bound">op0</span> <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="bound">op0</span> <span class="main">≠</span> Opapp<span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>App <span class="bound">op0</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app6"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">es</span> <span class="bound">err</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>App <span class="bound">op0</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"log1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">v1</span> <span class="bound">e'</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span>do_log <span class="bound">op0</span> <span class="bound">v1</span> <span class="bound">e2</span> <span class="main">=</span> Some <span class="main">(</span>Exp <span class="bound">e'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">e'</span> <span class="bound">bv</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Log <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"log2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">v1</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>do_log <span class="bound">op0</span> <span class="bound">v1</span> <span class="bound">e2</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">bv</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Log <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">bv</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"log3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">v1</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>do_log <span class="bound">op0</span> <span class="bound">v1</span> <span class="bound">e2</span> <span class="main">=</span> None<span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Log <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"log4"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Log <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"if1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="bound">v1</span> <span class="bound">e'</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span>do_if <span class="bound">v1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="main">=</span> Some <span class="bound">e'</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">e'</span> <span class="bound">bv</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>If <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"if2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="bound">v1</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>do_if <span class="bound">v1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="main">=</span> None<span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>If <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"if3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>If <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"mat1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">v1</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate_match</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">v1</span> <span class="bound">pes</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''Bind''</span><span class="main">)</span><span class="main">,</span> TypeExn <span class="main">(</span>Short <span class="main">(</span><span class="inner_quoted">''Bind''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Mat <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"mat2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Mat <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"let1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">n</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">v1</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="main">(</span> <span class="bound">env</span> <span class="main">(|</span> v <span class="main">:=</span> <span class="main">(</span>nsOptBind <span class="bound">n</span> <span class="bound">v1</span><span class="main">(</span>v   <span class="bound">env</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span> <span class="bound">s2</span> <span class="bound">e2</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Let <span class="bound">n</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"let2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">n</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Let <span class="bound">n</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"letrec1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">funs</span> <span class="bound">e</span> <span class="bound">bv</span> <span class="bound">s</span><span class="main">.</span>
Lem_list.allDistinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">x</span> <span class="main">)</span><span class="main">)</span> <span class="bound">funs</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="main">(</span> <span class="bound">env</span> <span class="main">(|</span> v <span class="main">:=</span> <span class="main">(</span>build_rec_env <span class="bound">funs</span> <span class="bound">env</span><span class="main">(</span>v   <span class="bound">env</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">e</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Letrec <span class="bound">funs</span> <span class="bound">e</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"letrec2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">funs</span> <span class="bound">e</span> <span class="bound">s</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span>Lem_list.allDistinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">x</span> <span class="main">)</span><span class="main">)</span> <span class="bound">funs</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Letrec <span class="bound">funs</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"tannot"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">t0</span> <span class="bound">s</span> <span class="bound">bv</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Tannot <span class="bound">e</span> <span class="bound">t0</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"locannot"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">l</span> <span class="bound">s</span> <span class="bound">bv</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Lannot <span class="bound">e</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"empty"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span><span class="main">.</span>

<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">[]</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">es</span> <span class="bound">v1</span> <span class="bound">vs</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s3</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">s3</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span><span class="bound">e</span> <span class="main">#</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s3</span><span class="main">,</span> Rval <span class="main">(</span><span class="bound">v1</span> <span class="main">#</span> <span class="bound">vs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">es</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span><span class="bound">e</span> <span class="main">#</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">es</span> <span class="bound">v1</span> <span class="bound">err</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s3</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">s3</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_list</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span><span class="bound">e</span> <span class="main">#</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s3</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"mat_empty"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">v1</span> <span class="bound">err_v</span> <span class="bound">s</span><span class="main">.</span>

<span class="free">evaluate_match</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v1</span> <span class="main">[]</span> <span class="bound">err_v</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="bound">err_v</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"mat_cons1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">env'</span> <span class="bound">v1</span> <span class="bound">p</span> <span class="bound">pes</span> <span class="bound">e</span> <span class="bound">bv</span> <span class="bound">err_v</span> <span class="bound">s</span><span class="main">.</span>
Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span>pmatch<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span><span class="main">(</span>refs   <span class="bound">s</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">v1</span> <span class="main">[]</span> <span class="main">=</span> Match <span class="bound">env'</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate</span> <span class="bound">ck</span> <span class="main">(</span> <span class="bound">env</span> <span class="main">(|</span> v <span class="main">:=</span> <span class="main">(</span>nsAppend <span class="main">(</span>alist_to_ns <span class="bound">env'</span><span class="main">)</span><span class="main">(</span>v   <span class="bound">env</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">e</span> <span class="bound">bv</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_match</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v1</span> <span class="main">(</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">#</span> <span class="bound">pes</span><span class="main">)</span> <span class="bound">err_v</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"mat_cons2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">v1</span> <span class="bound">p</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">bv</span> <span class="bound">s</span> <span class="bound">err_v</span><span class="main">.</span>
Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span>pmatch<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span><span class="main">(</span>refs   <span class="bound">s</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">v1</span> <span class="main">[]</span> <span class="main">=</span> No_match<span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate_match</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v1</span> <span class="bound">pes</span> <span class="bound">err_v</span> <span class="bound">bv</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_match</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v1</span> <span class="main">(</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">#</span> <span class="bound">pes</span><span class="main">)</span> <span class="bound">err_v</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"mat_cons3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">v1</span> <span class="bound">p</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">s</span> <span class="bound">err_v</span><span class="main">.</span>
pmatch<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span><span class="main">(</span>refs   <span class="bound">s</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">v1</span> <span class="main">[]</span> <span class="main">=</span> Match_type_error
<span class="main">==&gt;</span>
<span class="free">evaluate_match</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v1</span> <span class="main">(</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">#</span> <span class="bound">pes</span><span class="main">)</span> <span class="bound">err_v</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"mat_cons4"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">v1</span> <span class="bound">p</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">s</span> <span class="bound">err_v</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span>Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_match</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v1</span> <span class="main">(</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">#</span> <span class="bound">pes</span><span class="main">)</span> <span class="bound">err_v</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> The set tid_or_exn part of the state tracks all of the types and exceptions
 * that have been declared ›</span></span>›</span>
<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">evaluate_dec</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" bool <span class="main">⇒</span><span class="main">(</span>modN<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> dec <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"dlet1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">p</span> <span class="bound">e</span> <span class="bound">v1</span> <span class="bound">env'</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">locs</span><span class="main">.</span>
evaluate <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>pmatch<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span><span class="main">(</span>refs   <span class="bound">s2</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">v1</span> <span class="main">[]</span> <span class="main">=</span> Match <span class="bound">env'</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_dec</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Dlet <span class="bound">locs</span> <span class="bound">p</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="main">(|</span> v <span class="main">=</span> <span class="main">(</span>alist_to_ns <span class="bound">env'</span><span class="main">)</span><span class="main">,</span> c <span class="main">=</span> nsEmpty <span class="main">|)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"dlet2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">p</span> <span class="bound">e</span> <span class="bound">v1</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">locs</span><span class="main">.</span>
evaluate <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>pmatch<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span><span class="main">(</span>refs   <span class="bound">s2</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">v1</span> <span class="main">[]</span> <span class="main">=</span> No_match<span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_dec</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Dlet <span class="bound">locs</span> <span class="bound">p</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise Bindv<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"dlet3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">p</span> <span class="bound">e</span> <span class="bound">v1</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">locs</span><span class="main">.</span>
evaluate <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>pmatch<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span><span class="main">(</span>refs   <span class="bound">s2</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">v1</span> <span class="main">[]</span> <span class="main">=</span> Match_type_error<span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_dec</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Dlet <span class="bound">locs</span> <span class="bound">p</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"dlet4"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">p</span> <span class="bound">e</span> <span class="bound">s</span> <span class="bound">locs</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span>Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_dec</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Dlet <span class="bound">locs</span> <span class="bound">p</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"dlet5"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">p</span> <span class="bound">e</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">locs</span><span class="main">.</span>
evaluate <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span> <span class="main">∧</span>
Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_dec</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Dlet <span class="bound">locs</span> <span class="bound">p</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"dletrec1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">funs</span> <span class="bound">s</span> <span class="bound">locs</span><span class="main">.</span>
Lem_list.allDistinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">x</span> <span class="main">)</span><span class="main">)</span> <span class="bound">funs</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_dec</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Dletrec <span class="bound">locs</span> <span class="bound">funs</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="main">(|</span> v <span class="main">=</span> <span class="main">(</span>build_rec_env <span class="bound">funs</span> <span class="bound">env</span> nsEmpty<span class="main">)</span><span class="main">,</span> c <span class="main">=</span> nsEmpty <span class="main">|)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"dletrec2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">funs</span> <span class="bound">s</span> <span class="bound">locs</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span>Lem_list.allDistinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">x</span> <span class="main">)</span><span class="main">)</span> <span class="bound">funs</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_dec</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Dletrec <span class="bound">locs</span> <span class="bound">funs</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"dtype1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">tds</span> <span class="bound">s</span> <span class="bound">new_tdecs</span> <span class="bound">locs</span><span class="main">.</span>
check_dup_ctors <span class="bound">tds</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span><span class="bound">new_tdecs</span> <span class="main">=</span> type_defs_to_new_tdecs <span class="bound">mn</span> <span class="bound">tds</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>disjnt <span class="bound">new_tdecs</span><span class="main">(</span>defined_types   <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
Lem_list.allDistinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span><span class="bound">tn</span><span class="main">,</span><span class="bound">ctors</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">tn</span> <span class="main">)</span><span class="main">)</span> <span class="bound">tds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_dec</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Dtype <span class="bound">locs</span> <span class="bound">tds</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span> <span class="bound">s</span> <span class="main">(|</span> defined_types <span class="main">:=</span> <span class="main">(</span><span class="bound">new_tdecs</span> <span class="main">∪</span><span class="main">(</span>defined_types   <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(|</span> v <span class="main">=</span> nsEmpty<span class="main">,</span> c <span class="main">=</span> <span class="main">(</span>build_tdefs <span class="bound">mn</span> <span class="bound">tds</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"dtype2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">tds</span> <span class="bound">s</span> <span class="bound">locs</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span>check_dup_ctors <span class="bound">tds</span><span class="main">)</span> <span class="main">∨</span>
<span class="main">(</span><span class="main">¬</span> <span class="main">(</span>disjnt <span class="main">(</span>type_defs_to_new_tdecs <span class="bound">mn</span> <span class="bound">tds</span><span class="main">)</span><span class="main">(</span>defined_types   <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
<span class="main">¬</span> <span class="main">(</span>Lem_list.allDistinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span><span class="bound">tn</span><span class="main">,</span><span class="bound">ctors</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">tn</span> <span class="main">)</span><span class="main">)</span> <span class="bound">tds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_dec</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Dtype <span class="bound">locs</span> <span class="bound">tds</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"dtabbrev"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">tvs</span> <span class="bound">tn</span> <span class="bound">t0</span> <span class="bound">s</span> <span class="bound">locs</span><span class="main">.</span>

<span class="free">evaluate_dec</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Dtabbrev <span class="bound">locs</span> <span class="bound">tvs</span> <span class="bound">tn</span> <span class="bound">t0</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="main">(|</span> v <span class="main">=</span> nsEmpty<span class="main">,</span> c <span class="main">=</span> nsEmpty <span class="main">|)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"dexn1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">cn</span> <span class="bound">ts</span> <span class="bound">s</span> <span class="bound">locs</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span>TypeExn <span class="main">(</span>mk_id <span class="bound">mn</span> <span class="bound">cn</span><span class="main">)</span> <span class="main">∈</span><span class="main">(</span>defined_types   <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_dec</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Dexn <span class="bound">locs</span> <span class="bound">cn</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span> <span class="bound">s</span> <span class="main">(|</span> defined_types <span class="main">:=</span> <span class="main">(</span><span class="main">{</span>TypeExn <span class="main">(</span>mk_id <span class="bound">mn</span> <span class="bound">cn</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span><span class="main">(</span>defined_types   <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> Rval  <span class="main">(|</span> v <span class="main">=</span> nsEmpty<span class="main">,</span> c <span class="main">=</span> <span class="main">(</span>nsSing <span class="bound">cn</span> <span class="main">(</span>List.length <span class="bound">ts</span><span class="main">,</span> TypeExn <span class="main">(</span>mk_id <span class="bound">mn</span> <span class="bound">cn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"dexn2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">cn</span> <span class="bound">ts</span> <span class="bound">s</span> <span class="bound">locs</span><span class="main">.</span>
TypeExn <span class="main">(</span>mk_id <span class="bound">mn</span> <span class="bound">cn</span><span class="main">)</span> <span class="main">∈</span><span class="main">(</span>defined_types   <span class="bound">s</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_dec</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Dexn <span class="bound">locs</span> <span class="bound">cn</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">evaluate_decs</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" bool <span class="main">⇒</span><span class="main">(</span>modN<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span><span class="main">(</span>dec<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"empty"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s</span><span class="main">.</span>

<span class="free">evaluate_decs</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">[]</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="main">(|</span> v <span class="main">=</span> nsEmpty<span class="main">,</span> c <span class="main">=</span> nsEmpty <span class="main">|)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">d</span> <span class="bound">ds</span> <span class="bound">e</span><span class="main">.</span>
evaluate_dec <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">e</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_decs</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span><span class="bound">d</span> <span class="main">#</span> <span class="bound">ds</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">e</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s3</span> <span class="bound">env</span> <span class="bound">d</span> <span class="bound">ds</span> <span class="bound">new_env</span> <span class="bound">r</span><span class="main">.</span>
evaluate_dec <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">new_env</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate_decs</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="main">(</span>extend_dec_env <span class="bound">new_env</span> <span class="bound">env</span><span class="main">)</span> <span class="bound">s2</span> <span class="bound">ds</span> <span class="main">(</span><span class="bound">s3</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_decs</span> <span class="bound">ck</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span><span class="bound">d</span> <span class="main">#</span> <span class="bound">ds</span><span class="main">)</span> <span class="main">(</span><span class="bound">s3</span><span class="main">,</span> combine_dec_result <span class="bound">new_env</span> <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">evaluate_top</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" bool <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> top0 <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"tdec1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">d</span> <span class="bound">new_env</span><span class="main">.</span>
evaluate_dec <span class="bound">ck</span> <span class="main">[]</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">new_env</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_top</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Tdec <span class="bound">d</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">new_env</span><span class="main">)</span>"</span></span>
<span class="main">|</span>

<span class="quoted">"tdec2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">d</span> <span class="bound">err</span><span class="main">.</span>
evaluate_dec <span class="bound">ck</span> <span class="main">[]</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_top</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Tdec <span class="bound">d</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"tmod1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">ds</span> <span class="bound">mn</span> <span class="bound">specs</span> <span class="bound">new_env</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span><span class="main">[</span><span class="bound">mn</span><span class="main">]</span> <span class="main">∈</span><span class="main">(</span>defined_mods   <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>no_dup_types <span class="bound">ds</span> <span class="main">∧</span>
evaluate_decs <span class="bound">ck</span> <span class="main">[</span><span class="bound">mn</span><span class="main">]</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">ds</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">new_env</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_top</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Tmod <span class="bound">mn</span> <span class="bound">specs</span> <span class="bound">ds</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span> <span class="bound">s2</span> <span class="main">(|</span> defined_mods <span class="main">:=</span> <span class="main">(</span><span class="main">{</span><span class="main">[</span><span class="bound">mn</span><span class="main">]</span><span class="main">}</span> <span class="main">∪</span><span class="main">(</span>defined_mods   <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> Rval <span class="main">(|</span> v <span class="main">=</span> <span class="main">(</span>nsLift <span class="bound">mn</span><span class="main">(</span>v   <span class="bound">new_env</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> c <span class="main">=</span> <span class="main">(</span>nsLift <span class="bound">mn</span><span class="main">(</span>c   <span class="bound">new_env</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"tmod2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">ds</span> <span class="bound">mn</span> <span class="bound">specs</span> <span class="bound">err</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span><span class="main">[</span><span class="bound">mn</span><span class="main">]</span> <span class="main">∈</span><span class="main">(</span>defined_mods   <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>no_dup_types <span class="bound">ds</span> <span class="main">∧</span>
evaluate_decs <span class="bound">ck</span> <span class="main">[</span><span class="bound">mn</span><span class="main">]</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">ds</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_top</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Tmod <span class="bound">mn</span> <span class="bound">specs</span> <span class="bound">ds</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span> <span class="bound">s2</span> <span class="main">(|</span> defined_mods <span class="main">:=</span> <span class="main">(</span><span class="main">{</span><span class="main">[</span><span class="bound">mn</span><span class="main">]</span><span class="main">}</span> <span class="main">∪</span><span class="main">(</span>defined_mods   <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"tmod3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">env</span> <span class="bound">ds</span> <span class="bound">mn</span> <span class="bound">specs</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span>no_dup_types <span class="bound">ds</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_top</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Tmod <span class="bound">mn</span> <span class="bound">specs</span> <span class="bound">ds</span><span class="main">)</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"tmod4"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">mn</span> <span class="bound">specs</span> <span class="bound">ds</span><span class="main">.</span>
<span class="main">[</span><span class="bound">mn</span><span class="main">]</span> <span class="main">∈</span><span class="main">(</span>defined_mods   <span class="bound">s</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_top</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Tmod <span class="bound">mn</span> <span class="bound">specs</span> <span class="bound">ds</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">evaluate_prog</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" bool <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> prog <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"empty"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span><span class="main">.</span>

<span class="free">evaluate_prog</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">[]</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="main">(|</span> v <span class="main">=</span> nsEmpty<span class="main">,</span> c <span class="main">=</span> nsEmpty <span class="main">|)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s3</span> <span class="bound">env</span> <span class="bound">top0</span> <span class="bound">tops</span> <span class="bound">new_env</span> <span class="bound">r</span><span class="main">.</span>
evaluate_top <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">top0</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">new_env</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate_prog</span> <span class="bound">ck</span> <span class="main">(</span>extend_dec_env <span class="bound">new_env</span> <span class="bound">env</span><span class="main">)</span> <span class="bound">s2</span> <span class="bound">tops</span> <span class="main">(</span><span class="bound">s3</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_prog</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span><span class="bound">top0</span> <span class="main">#</span> <span class="bound">tops</span><span class="main">)</span> <span class="main">(</span><span class="bound">s3</span><span class="main">,</span> combine_dec_result <span class="bound">new_env</span> <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">ck</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">top0</span> <span class="bound">tops</span> <span class="bound">err</span><span class="main">.</span>
evaluate_top <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">top0</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_prog</span> <span class="bound">ck</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span><span class="bound">top0</span> <span class="main">#</span> <span class="bound">tops</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val evaluate_whole_prog : forall 'ffi. Eq 'ffi =&gt; bool -&gt; sem_env v -&gt; state 'ffi -&gt; prog -&gt;
          state 'ffi * result (sem_env v) v -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">evaluate_whole_prog</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" bool <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span><span class="main">(</span>top0<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">evaluate_whole_prog</span> <span class="free"><span class="bound"><span class="entity">ck</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">tops</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> no_dup_mods <span class="free"><span class="bound"><span class="entity">tops</span></span></span><span class="main">(</span>defined_mods   <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span> <span class="main">∧</span> no_dup_top_types <span class="free"><span class="bound"><span class="entity">tops</span></span></span><span class="main">(</span>defined_types   <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
    evaluate_prog <span class="free"><span class="bound"><span class="entity">ck</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">tops</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="main">=</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val dec_diverges : forall 'ffi. sem_env v -&gt; state 'ffi -&gt; dec -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dec_diverges</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> dec <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">dec_diverges</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span>Dlet <span class="free"><span class="bound"><span class="entity">locs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> e_diverges <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span><span class="main">(</span>refs   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span>ffi   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">dec_diverges</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span>Dletrec <span class="free"><span class="bound"><span class="entity">locs</span></span></span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> False <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">dec_diverges</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span>Dtype <span class="free"><span class="bound"><span class="entity">locs</span></span></span> <span class="free"><span class="bound"><span class="entity">tds</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> False <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">dec_diverges</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span>Dtabbrev <span class="free"><span class="bound"><span class="entity">locs</span></span></span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> False <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">dec_diverges</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span>Dexn <span class="free"><span class="bound"><span class="entity">locs</span></span></span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> False <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">decs_diverges</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>modN<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> decs <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"cons1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">mn</span> <span class="bound">st</span> <span class="bound">env</span> <span class="bound">d</span> <span class="bound">ds</span><span class="main">.</span>
dec_diverges <span class="bound">env</span> <span class="bound">st</span> <span class="bound">d</span>
<span class="main">==&gt;</span>
<span class="free">decs_diverges</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">st</span> <span class="main">(</span><span class="bound">d</span> <span class="main">#</span> <span class="bound">ds</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">mn</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">d</span> <span class="bound">ds</span> <span class="bound">new_env</span><span class="main">.</span>
evaluate_dec False <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">d</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">new_env</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">decs_diverges</span> <span class="bound">mn</span> <span class="main">(</span>extend_dec_env <span class="bound">new_env</span> <span class="bound">env</span><span class="main">)</span> <span class="bound">s2</span> <span class="bound">ds</span>
<span class="main">==&gt;</span>
<span class="free">decs_diverges</span> <span class="bound">mn</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span><span class="bound">d</span> <span class="main">#</span> <span class="bound">ds</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">top_diverges</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> top0 <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"tdec"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">st</span> <span class="bound">env</span> <span class="bound">d</span><span class="main">.</span>
dec_diverges <span class="bound">env</span> <span class="bound">st</span> <span class="bound">d</span>
<span class="main">==&gt;</span>
<span class="free">top_diverges</span> <span class="bound">env</span> <span class="bound">st</span> <span class="main">(</span>Tdec <span class="bound">d</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"tmod"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">ds</span> <span class="bound">mn</span> <span class="bound">specs</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span><span class="main">[</span><span class="bound">mn</span><span class="main">]</span> <span class="main">∈</span><span class="main">(</span>defined_mods   <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>no_dup_types <span class="bound">ds</span> <span class="main">∧</span>
decs_diverges <span class="main">[</span><span class="bound">mn</span><span class="main">]</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">ds</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">top_diverges</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Tmod <span class="bound">mn</span> <span class="bound">specs</span> <span class="bound">ds</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">prog_diverges</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> prog <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"cons1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">st</span> <span class="bound">env</span> <span class="bound">top0</span> <span class="bound">tops</span><span class="main">.</span>
top_diverges <span class="bound">env</span> <span class="bound">st</span> <span class="bound">top0</span>
<span class="main">==&gt;</span>
<span class="free">prog_diverges</span> <span class="bound">env</span> <span class="bound">st</span> <span class="main">(</span><span class="bound">top0</span> <span class="main">#</span> <span class="bound">tops</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">top0</span> <span class="bound">tops</span> <span class="bound">new_env</span><span class="main">.</span>
evaluate_top False <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">top0</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">new_env</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">prog_diverges</span> <span class="main">(</span>extend_dec_env <span class="bound">new_env</span> <span class="bound">env</span><span class="main">)</span> <span class="bound">s2</span> <span class="bound">tops</span>
<span class="main">==&gt;</span>
<span class="free">prog_diverges</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span><span class="bound">top0</span> <span class="main">#</span> <span class="bound">tops</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BigSmallInvariants">
<div class="head">
<h1>Theory BigSmallInvariants</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/alt_semantics/proofs/bigSmallInvariants.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"BigSmallInvariants"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives">LEM.Lem_pervasives</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>
  <span class="quoted">"<a href="#Namespace">Namespace</a>"</span>
  <span class="quoted">"<a href="#Ast">Ast</a>"</span>
  <span class="quoted">"<a href="#SemanticPrimitives">SemanticPrimitives</a>"</span>
  <span class="quoted">"<a href="#SmallStep">SmallStep</a>"</span>
  <span class="quoted">"<a href="#BigStep">BigStep</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Lib›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Namespace›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Ast›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import SemanticPrimitives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import SmallStep›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import BigStep›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> ------ Auxiliary relations for proving big/small step equivalence ------ ›</span></span>›</span>

<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">evaluate_ctxt</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> ctxt_frame <span class="main">⇒</span> v <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"raise"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v1</span><span class="main">.</span>

<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Craise <span class="main">()</span> <span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="bound">v1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"handle"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v1</span> <span class="bound">pes</span><span class="main">.</span>

<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Chandle <span class="main">()</span>  <span class="bound">pes</span><span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">v1</span> <span class="bound">vs1</span> <span class="bound">vs2</span> <span class="bound">es</span> <span class="bound">env'</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
evaluate_list False <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs2</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span>do_opapp <span class="main">(</span><span class="main">(</span>List.rev <span class="bound">vs2</span> <span class="main">@</span> <span class="main">[</span><span class="bound">v1</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="bound">vs1</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">env'</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
evaluate False <span class="bound">env'</span> <span class="bound">s2</span> <span class="bound">e</span> <span class="bound">bv</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Capp Opapp <span class="bound">vs1</span> <span class="main">()</span>  <span class="bound">es</span><span class="main">)</span> <span class="bound">v1</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"app2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">v1</span> <span class="bound">vs1</span> <span class="bound">vs2</span> <span class="bound">es</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
evaluate_list False <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs2</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>do_opapp <span class="main">(</span><span class="main">(</span>List.rev <span class="bound">vs2</span> <span class="main">@</span> <span class="main">[</span><span class="bound">v1</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="bound">vs1</span><span class="main">)</span> <span class="main">=</span> None<span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Capp Opapp <span class="bound">vs1</span> <span class="main">()</span>  <span class="bound">es</span><span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">v1</span> <span class="bound">vs1</span> <span class="bound">vs2</span> <span class="bound">es</span> <span class="bound">res</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">new_refs</span> <span class="bound">new_ffi</span><span class="main">.</span>
<span class="main">(</span><span class="bound">op0</span> <span class="main">≠</span> Opapp<span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>evaluate_list False <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs2</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>do_app <span class="main">(</span><span class="main">(</span>refs   <span class="bound">s2</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>ffi   <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="bound">op0</span> <span class="main">(</span><span class="main">(</span>List.rev <span class="bound">vs2</span> <span class="main">@</span> <span class="main">[</span><span class="bound">v1</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="bound">vs1</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="bound">new_refs</span><span class="main">,</span> <span class="bound">new_ffi</span><span class="main">)</span> <span class="main">,</span><span class="bound">res</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Capp <span class="bound">op0</span> <span class="bound">vs1</span> <span class="main">()</span>  <span class="bound">es</span><span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="main">(</span> <span class="bound">s2</span> <span class="main">(|</span> ffi <span class="main">:=</span> <span class="bound">new_ffi</span><span class="main">,</span> refs <span class="main">:=</span> <span class="bound">new_refs</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> <span class="bound">res</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app4"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">v1</span> <span class="bound">vs1</span> <span class="bound">vs2</span> <span class="bound">es</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="main">(</span><span class="bound">op0</span> <span class="main">≠</span> Opapp<span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>evaluate_list False <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs2</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>do_app <span class="main">(</span><span class="main">(</span>refs   <span class="bound">s2</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>ffi   <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="bound">op0</span> <span class="main">(</span><span class="main">(</span>List.rev <span class="bound">vs2</span> <span class="main">@</span> <span class="main">[</span><span class="bound">v1</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="bound">vs1</span><span class="main">)</span> <span class="main">=</span> None<span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Capp <span class="bound">op0</span> <span class="bound">vs1</span> <span class="main">()</span>  <span class="bound">es</span><span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app5"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">v1</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
evaluate_list False <span class="bound">env</span> <span class="bound">s</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Capp <span class="bound">op0</span> <span class="bound">vs</span> <span class="main">()</span>  <span class="bound">es</span><span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"log1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">e2</span> <span class="bound">v1</span> <span class="bound">e'</span> <span class="bound">bv</span> <span class="bound">s</span><span class="main">.</span>
<span class="main">(</span>do_log <span class="bound">op0</span> <span class="bound">v1</span> <span class="bound">e2</span> <span class="main">=</span> Some <span class="main">(</span>Exp <span class="bound">e'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
evaluate False <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e'</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Clog <span class="bound">op0</span> <span class="main">()</span>  <span class="bound">e2</span><span class="main">)</span> <span class="bound">v1</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"log2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">e2</span> <span class="bound">v1</span> <span class="bound">v'</span> <span class="bound">s</span><span class="main">.</span>
do_log <span class="bound">op0</span> <span class="bound">v1</span> <span class="bound">e2</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v'</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Clog <span class="bound">op0</span> <span class="main">()</span>  <span class="bound">e2</span><span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="bound">v'</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"log3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">e2</span> <span class="bound">v1</span> <span class="bound">s</span><span class="main">.</span>
<span class="main">(</span>do_log <span class="bound">op0</span> <span class="bound">v1</span> <span class="bound">e2</span> <span class="main">=</span> None<span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Clog <span class="bound">op0</span> <span class="main">()</span>  <span class="bound">e2</span><span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>
<span class="quoted">"if1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="bound">v1</span> <span class="bound">e'</span> <span class="bound">bv</span> <span class="bound">s</span><span class="main">.</span>
<span class="main">(</span>do_if <span class="bound">v1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="main">=</span> Some <span class="bound">e'</span><span class="main">)</span> <span class="main">∧</span>
evaluate False <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e'</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Cif <span class="main">()</span>  <span class="bound">e2</span> <span class="bound">e3</span><span class="main">)</span> <span class="bound">v1</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"if2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="bound">v1</span> <span class="bound">s</span><span class="main">.</span>
do_if <span class="bound">v1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="main">=</span> None
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Cif <span class="main">()</span>  <span class="bound">e2</span> <span class="bound">e3</span><span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"mat"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">pes</span> <span class="bound">v1</span> <span class="bound">bv</span> <span class="bound">s</span> <span class="bound">err_v</span><span class="main">.</span>
evaluate_match False <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v1</span> <span class="bound">pes</span> <span class="bound">err_v</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Cmat <span class="main">()</span>  <span class="bound">pes</span> <span class="bound">err_v</span><span class="main">)</span> <span class="bound">v1</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"lt"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">n</span> <span class="bound">e2</span> <span class="bound">v1</span> <span class="bound">bv</span> <span class="bound">s</span><span class="main">.</span>
evaluate False <span class="main">(</span> <span class="bound">env</span> <span class="main">(|</span> v <span class="main">:=</span> <span class="main">(</span>nsOptBind <span class="bound">n</span> <span class="bound">v1</span><span class="main">(</span>v   <span class="bound">env</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">e2</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Clet <span class="bound">n</span> <span class="main">()</span>  <span class="bound">e2</span><span class="main">)</span> <span class="bound">v1</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"con1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">cn</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">v1</span> <span class="bound">vs'</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">v'</span><span class="main">.</span>
do_con_check<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">(</span><span class="main">(</span>List.length <span class="bound">vs</span> <span class="main">+</span> List.length <span class="bound">es</span><span class="main">)</span> <span class="main">+</span><span class="main">(</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span>build_conv<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">(</span><span class="main">(</span>List.rev <span class="bound">vs'</span> <span class="main">@</span> <span class="main">[</span><span class="bound">v1</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v'</span><span class="main">)</span> <span class="main">∧</span>
evaluate_list False <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs'</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Ccon <span class="bound">cn</span> <span class="bound">vs</span> <span class="main">()</span>  <span class="bound">es</span><span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v'</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"con2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">cn</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">v1</span> <span class="bound">s</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span>do_con_check<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">(</span><span class="main">(</span>List.length <span class="bound">vs</span> <span class="main">+</span> List.length <span class="bound">es</span><span class="main">)</span> <span class="main">+</span><span class="main">(</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Ccon <span class="bound">cn</span> <span class="bound">vs</span> <span class="main">()</span>  <span class="bound">es</span><span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"con3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">cn</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">v1</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
do_con_check<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">(</span><span class="main">(</span>List.length <span class="bound">vs</span> <span class="main">+</span> List.length <span class="bound">es</span><span class="main">)</span> <span class="main">+</span><span class="main">(</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
evaluate_list False <span class="bound">env</span> <span class="bound">s</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Ccon <span class="bound">cn</span> <span class="bound">vs</span> <span class="main">()</span>  <span class="bound">es</span><span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"tannot"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">v1</span> <span class="bound">s</span> <span class="bound">t0</span><span class="main">.</span>

<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Ctannot <span class="main">()</span>  <span class="bound">t0</span><span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"lannot"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">v1</span> <span class="bound">s</span> <span class="bound">l</span><span class="main">.</span>

<span class="free">evaluate_ctxt</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Clannot <span class="main">()</span>  <span class="bound">l</span><span class="main">)</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">evaluate_ctxts</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> state <span class="main">⇒</span><span class="main">(</span>ctxt<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"empty"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">res</span> <span class="bound">s</span><span class="main">.</span>

<span class="free">evaluate_ctxts</span> <span class="bound">s</span> <span class="main">[]</span> <span class="bound">res</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">res</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons_val"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">c1</span> <span class="bound">cs</span> <span class="bound">env</span> <span class="bound">v1</span> <span class="bound">res</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
evaluate_ctxt <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">c1</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> <span class="bound">res</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate_ctxts</span> <span class="bound">s2</span> <span class="bound">cs</span> <span class="bound">res</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxts</span> <span class="bound">s1</span> <span class="main">(</span><span class="main">(</span><span class="bound">c1</span><span class="main">,</span><span class="bound">env</span><span class="main">)</span><span class="main">#</span> <span class="bound">cs</span><span class="main">)</span> <span class="main">(</span>Rval <span class="bound">v1</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"cons_err"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">c1</span> <span class="bound">cs</span> <span class="bound">env</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">bv</span><span class="main">.</span>
<span class="free">evaluate_ctxts</span> <span class="bound">s</span> <span class="bound">cs</span> <span class="main">(</span>Rerr <span class="bound">err</span><span class="main">)</span> <span class="bound">bv</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">pes</span><span class="main">.</span>  <span class="bound">c1</span> <span class="main">≠</span> Chandle <span class="main">()</span>  <span class="bound">pes</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
 <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">v1</span><span class="main">.</span>  <span class="bound">err</span> <span class="main">≠</span> Rraise <span class="bound">v1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxts</span> <span class="bound">s</span> <span class="main">(</span><span class="main">(</span><span class="bound">c1</span><span class="main">,</span><span class="bound">env</span><span class="main">)</span><span class="main">#</span> <span class="bound">cs</span><span class="main">)</span> <span class="main">(</span>Rerr <span class="bound">err</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"cons_handle"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">cs</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">res1</span> <span class="bound">res2</span> <span class="bound">pes</span> <span class="bound">v1</span><span class="main">.</span>
evaluate_match False <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v1</span> <span class="bound">pes</span> <span class="bound">v1</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">res1</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">evaluate_ctxts</span> <span class="bound">s'</span> <span class="bound">cs</span> <span class="bound">res1</span> <span class="bound">res2</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_ctxts</span> <span class="bound">s</span> <span class="main">(</span><span class="main">(</span>Chandle <span class="main">()</span>  <span class="bound">pes</span><span class="main">,</span><span class="bound">env</span><span class="main">)</span><span class="main">#</span> <span class="bound">cs</span><span class="main">)</span> <span class="main">(</span>Rerr <span class="main">(</span>Rraise <span class="bound">v1</span><span class="main">)</span><span class="main">)</span> <span class="bound">res2</span> "</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">evaluate_state</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> small_state <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"exp"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">c1</span> <span class="bound">res</span> <span class="bound">bv</span> <span class="bound">ffi0</span> <span class="bound">refs0</span> <span class="bound">st</span><span class="main">.</span>
evaluate False <span class="bound">env</span>  <span class="main">(|</span> clock <span class="main">=</span><span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> refs <span class="main">=</span> <span class="bound">refs0</span><span class="main">,</span> ffi <span class="main">=</span> <span class="bound">ffi0</span><span class="main">,</span> defined_types <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">,</span> defined_mods <span class="main">=</span> 
 <span class="main">(</span><span class="main">{}</span><span class="main">)</span>  <span class="main">|)</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">res</span><span class="main">)</span> <span class="main">∧</span>
evaluate_ctxts <span class="bound">st</span> <span class="bound">c1</span> <span class="bound">res</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_state</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="main">(</span><span class="bound">refs0</span><span class="main">,</span> <span class="bound">ffi0</span><span class="main">)</span><span class="main">,</span> Exp <span class="bound">e</span><span class="main">,</span> <span class="bound">c1</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"vl"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">ffi0</span> <span class="bound">refs0</span> <span class="bound">v1</span> <span class="bound">c1</span> <span class="bound">bv</span><span class="main">.</span>
evaluate_ctxts  <span class="main">(|</span> clock <span class="main">=</span><span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> refs <span class="main">=</span> <span class="bound">refs0</span><span class="main">,</span> ffi <span class="main">=</span> <span class="bound">ffi0</span><span class="main">,</span> defined_types <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">,</span> defined_mods <span class="main">=</span> 
 <span class="main">(</span><span class="main">{}</span><span class="main">)</span>  <span class="main">|)</span> <span class="bound">c1</span> <span class="main">(</span>Rval <span class="bound">v1</span><span class="main">)</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_state</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="main">(</span><span class="bound">refs0</span><span class="main">,</span> <span class="bound">ffi0</span><span class="main">)</span><span class="main">,</span> Val <span class="bound">v1</span><span class="main">,</span> <span class="bound">c1</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Evaluate">
<div class="head">
<h1>Theory Evaluate</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/evaluate.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Evaluate"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives_extra">LEM.Lem_pervasives_extra</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>
  <span class="quoted">"<a href="#Namespace">Namespace</a>"</span>
  <span class="quoted">"<a href="#Ast">Ast</a>"</span>
  <span class="quoted">"<a href="#SemanticPrimitives">SemanticPrimitives</a>"</span>
  <span class="quoted">"<a href="#Ffi">Ffi</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives_extra›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Lib›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Ast›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Namespace›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import SemanticPrimitives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Ffi›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> The semantics is defined here using fix_clock so that HOL4 generates
 * provable termination conditions. However, after termination is proved, we
 * clean up the definition (in HOL4) to remove occurrences of fix_clock. ›</span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fix_clock</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'b</span> state<span class="main">*</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> state<span class="main">*</span><span class="tfree">'c</span> "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">fix_clock</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">(</span><span class="keyword1">if</span><span class="main">(</span>clock   <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">≤</span><span class="main">(</span>clock   <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
                     <span class="keyword1">then</span><span class="main">(</span>clock   <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="keyword1">else</span><span class="main">(</span>clock   <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dec_clock</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> state "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">dec_clock</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">(</span><span class="main">(</span>clock   <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">-</span><span class="main">(</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> list_result is equivalent to map_result (\v. [v]) I, where map_result is
 * defined in evalPropsTheory ›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> 
<span class="entity">list_result</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span>result <span class="main">⇒</span><span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> list<span class="main">)</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span>result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">list_result</span> <span class="main">(</span>Rval <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Rval <span class="main">[</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">list_result</span> <span class="main">(</span>Rerr <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Rerr <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val evaluate : forall 'ffi. state 'ffi -&gt; sem_env v -&gt; list exp -&gt; state 'ffi * result (list v) v›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val evaluate_match : forall 'ffi. state 'ffi -&gt; sem_env v -&gt; v -&gt; list (pat * exp) -&gt; v -&gt; state 'ffi * result (list v) v›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span> 
<span class="entity">fun_evaluate_match</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> state <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> v <span class="main">⇒</span><span class="main">(</span>pat<span class="main">*</span>exp0<span class="main">)</span>list <span class="main">⇒</span> v <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>list<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result "</span></span>  
                   <span class="keyword2"><span class="keyword">and</span></span>
<span class="entity">fun_evaluate</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> state <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span>exp0<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>list<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rval <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  fix_clock <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">]</span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="main">(</span><span class="keyword1">case</span>  <span class="free">fun_evaluate</span> <span class="bound">st'</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
        <span class="main">(</span><span class="bound">st''</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">st''</span><span class="main">,</span> Rval <span class="main">(</span>List.hd <span class="bound">v1</span> <span class="main">#</span> <span class="bound">vs</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> <span class="bound">res</span> <span class="main">=&gt;</span> <span class="bound">res</span>
      <span class="main">)</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">=&gt;</span> <span class="bound">res</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Lit <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rval <span class="main">[</span>Litv <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Raise <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rval <span class="bound">v2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span>List.hd <span class="bound">v2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">=&gt;</span> <span class="bound">res</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Handle <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  fix_clock <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="bound">v2</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="free">fun_evaluate_match</span> <span class="bound">st'</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">v2</span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span> <span class="bound">v2</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">=&gt;</span> <span class="bound">res</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Con <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> do_con_check<span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span>List.length <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">case</span>  <span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>List.rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="keyword1">case</span>  build_conv<span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="keyword1">of</span>
          Some <span class="bound">v2</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rval <span class="main">[</span><span class="bound">v2</span><span class="main">]</span><span class="main">)</span>
        <span class="main">|</span> None <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>
        <span class="main">)</span>
    <span class="main">|</span> <span class="bound">res</span> <span class="main">=&gt;</span> <span class="bound">res</span>
    <span class="main">)</span>
  <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Var <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  nsLookup<span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span>
    Some <span class="bound">v2</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rval <span class="main">[</span><span class="bound">v2</span><span class="main">]</span><span class="main">)</span>
  <span class="main">|</span> None <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Fun <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rval <span class="main">[</span>Closure <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>App <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  fix_clock <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>List.rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">=</span> Opapp <span class="keyword1">then</span>
        <span class="main">(</span><span class="keyword1">case</span>  do_opapp <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="keyword1">of</span>
          Some <span class="main">(</span><span class="bound">env'</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">=&gt;</span>
            <span class="keyword1">if</span><span class="main">(</span>clock   <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span> <span class="keyword1">then</span>
              <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span>
            <span class="keyword1">else</span>
              <span class="free">fun_evaluate</span> <span class="main">(</span>dec_clock <span class="bound">st'</span><span class="main">)</span> <span class="bound">env'</span> <span class="main">[</span><span class="bound">e</span><span class="main">]</span>
        <span class="main">|</span> None <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>
        <span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="main">(</span><span class="keyword1">case</span>  do_app <span class="main">(</span><span class="main">(</span>refs   <span class="bound">st'</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>ffi   <span class="bound">st'</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op1</span></span></span> <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="keyword1">of</span>
          Some <span class="main">(</span><span class="main">(</span><span class="bound">refs1</span><span class="main">,</span><span class="bound">ffi1</span><span class="main">)</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span> <span class="bound">st'</span> <span class="main">(|</span> refs <span class="main">:=</span> <span class="bound">refs1</span><span class="main">,</span> ffi <span class="main">:=</span> <span class="bound">ffi1</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> list_result <span class="bound">r</span><span class="main">)</span>
        <span class="main">|</span> None <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>
        <span class="main">)</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">=&gt;</span> <span class="bound">res</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Log <span class="free"><span class="bound"><span class="entity">lop</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  fix_clock <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">]</span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="main">(</span><span class="keyword1">case</span>  do_log <span class="free"><span class="bound"><span class="entity">lop</span></span></span> <span class="main">(</span>List.hd <span class="bound">v1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="keyword1">of</span>
        Some <span class="main">(</span>Exp <span class="bound">e</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="free">fun_evaluate</span> <span class="bound">st'</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="bound">e</span><span class="main">]</span>
      <span class="main">|</span> Some <span class="main">(</span>Val <span class="bound">v2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rval <span class="main">[</span><span class="bound">v2</span><span class="main">]</span><span class="main">)</span>
      <span class="main">|</span> None <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>
      <span class="main">)</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">=&gt;</span> <span class="bound">res</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>If <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  fix_clock <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">]</span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rval <span class="bound">v2</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="main">(</span><span class="keyword1">case</span>  do_if <span class="main">(</span>List.hd <span class="bound">v2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="keyword1">of</span>
        Some <span class="bound">e</span> <span class="main">=&gt;</span> <span class="free">fun_evaluate</span> <span class="bound">st'</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="bound">e</span><span class="main">]</span>
      <span class="main">|</span> None <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>
      <span class="main">)</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">=&gt;</span> <span class="bound">res</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Mat <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  fix_clock <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rval <span class="bound">v2</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="free">fun_evaluate_match</span> <span class="bound">st'</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>List.hd <span class="bound">v2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span> Bindv
  <span class="main">|</span> <span class="bound">res</span> <span class="main">=&gt;</span> <span class="bound">res</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Let <span class="free"><span class="bound"><span class="entity">xo</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  fix_clock <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">]</span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rval <span class="bound">v2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="free">fun_evaluate</span> <span class="bound">st'</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(|</span> v <span class="main">:=</span> <span class="main">(</span>nsOptBind <span class="free"><span class="bound"><span class="entity">xo</span></span></span> <span class="main">(</span>List.hd <span class="bound">v2</span><span class="main">)</span><span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">]</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">=&gt;</span> <span class="bound">res</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Letrec <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> allDistinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">x</span> <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(|</span> v <span class="main">:=</span> <span class="main">(</span>build_rec_env <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span>
  <span class="keyword1">else</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Tannot <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Lannot <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate_match</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">err_v</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="free"><span class="bound"><span class="entity">err_v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate_match</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">err_v</span></span></span>  <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> allDistinct <span class="main">(</span>pat_bindings <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">case</span>  pmatch<span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">(</span>refs   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">[]</span> <span class="keyword1">of</span>
      Match <span class="bound">env_v'</span> <span class="main">=&gt;</span> <span class="free">fun_evaluate</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(|</span> v <span class="main">:=</span> <span class="main">(</span>nsAppend <span class="main">(</span>alist_to_ns <span class="bound">env_v'</span><span class="main">)</span><span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span>
    <span class="main">|</span> No_match <span class="main">=&gt;</span> <span class="free">fun_evaluate_match</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span> <span class="free"><span class="bound"><span class="entity">err_v</span></span></span>
    <span class="main">|</span> Match_type_error <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>
    <span class="main">)</span>
  <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val evaluate_decs :
  forall 'ffi. list modN -&gt; state 'ffi -&gt; sem_env v -&gt; list dec -&gt; state 'ffi * result (sem_env v) v›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> 
<span class="entity">fun_evaluate_decs</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span>dec<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate_decs</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rval <span class="main">(|</span> v <span class="main">=</span> nsEmpty<span class="main">,</span> c <span class="main">=</span> nsEmpty <span class="main">|)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate_decs</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free">fun_evaluate_decs</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">d1</span></span></span><span class="main">]</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">st1</span><span class="main">,</span> Rval <span class="bound">env1</span><span class="main">)</span> <span class="main">=&gt;</span>
    <span class="main">(</span><span class="keyword1">case</span>  <span class="free">fun_evaluate_decs</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="bound">st1</span> <span class="main">(</span>extend_dec_env <span class="bound">env1</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">st2</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">st2</span><span class="main">,</span> combine_dec_result <span class="bound">env1</span> <span class="bound">r</span><span class="main">)</span>
    <span class="main">)</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">=&gt;</span> <span class="bound">res</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate_decs</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Dlet <span class="free"><span class="bound"><span class="entity">locs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> allDistinct <span class="main">(</span>pat_bindings <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">case</span>  fun_evaluate <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rval <span class="bound">v2</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="bound">st'</span><span class="main">,</span>
         <span class="main">(</span><span class="keyword1">case</span>  pmatch<span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">(</span>refs   <span class="bound">st'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>List.hd <span class="bound">v2</span><span class="main">)</span> <span class="main">[]</span> <span class="keyword1">of</span>
           Match <span class="bound">new_vals</span> <span class="main">=&gt;</span> Rval <span class="main">(|</span> v <span class="main">=</span> <span class="main">(</span>alist_to_ns <span class="bound">new_vals</span><span class="main">)</span><span class="main">,</span> c <span class="main">=</span> nsEmpty <span class="main">|)</span>
         <span class="main">|</span> No_match <span class="main">=&gt;</span> Rerr <span class="main">(</span>Rraise Bindv<span class="main">)</span>
         <span class="main">|</span> Match_type_error <span class="main">=&gt;</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span>
         <span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
    <span class="main">)</span>
  <span class="keyword1">else</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate_decs</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Dletrec <span class="free"><span class="bound"><span class="entity">locs</span></span></span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span>
   <span class="main">(</span><span class="keyword1">if</span> allDistinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">x</span> <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
     Rval <span class="main">(|</span> v <span class="main">=</span> <span class="main">(</span>build_rec_env <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> nsEmpty<span class="main">)</span><span class="main">,</span> c <span class="main">=</span> nsEmpty <span class="main">|)</span>
   <span class="keyword1">else</span>
     Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate_decs</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Dtype <span class="free"><span class="bound"><span class="entity">locs</span></span></span> <span class="free"><span class="bound"><span class="entity">tds</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">new_tdecs</span> <span class="main">=</span> <span class="main">(</span>type_defs_to_new_tdecs <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">tds</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> check_dup_ctors <span class="free"><span class="bound"><span class="entity">tds</span></span></span> <span class="main">∧</span>
       <span class="main">(</span>disjnt <span class="bound">new_tdecs</span><span class="main">(</span>defined_types   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">∧</span>
       allDistinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span><span class="bound">tn</span><span class="main">,</span><span class="bound">ctors</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">tn</span> <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tds</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">then</span>
      <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(|</span> defined_types <span class="main">:=</span> <span class="main">(</span><span class="bound">new_tdecs</span> <span class="main">∪</span><span class="main">(</span>defined_types   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span>
       Rval <span class="main">(|</span> v <span class="main">=</span> nsEmpty<span class="main">,</span> c <span class="main">=</span> <span class="main">(</span>build_tdefs <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">tds</span></span></span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate_decs</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Dtabbrev <span class="free"><span class="bound"><span class="entity">locs</span></span></span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rval <span class="main">(|</span> v <span class="main">=</span> nsEmpty<span class="main">,</span> c <span class="main">=</span> nsEmpty <span class="main">|)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate_decs</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Dexn <span class="free"><span class="bound"><span class="entity">locs</span></span></span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> TypeExn <span class="main">(</span>mk_id <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span><span class="main">)</span> <span class="main">∈</span><span class="main">(</span>defined_types   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span>
    <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(|</span> defined_types <span class="main">:=</span> <span class="main">(</span><span class="main">{</span>TypeExn <span class="main">(</span>mk_id <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span><span class="main">(</span>defined_types   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span>
     Rval <span class="main">(|</span> v <span class="main">=</span> nsEmpty<span class="main">,</span> c <span class="main">=</span> <span class="main">(</span>nsSing <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span>List.length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">,</span> TypeExn <span class="main">(</span>mk_id <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">envLift</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" string <span class="main">⇒</span> <span class="tfree">'a</span> sem_env <span class="main">⇒</span> <span class="tfree">'a</span> sem_env "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">envLift</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(|</span> v <span class="main">=</span> <span class="main">(</span>nsLift <span class="free"><span class="bound"><span class="entity">mn</span></span></span><span class="main">(</span>v   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> c <span class="main">=</span> <span class="main">(</span>nsLift <span class="free"><span class="bound"><span class="entity">mn</span></span></span><span class="main">(</span>c   <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val evaluate_tops :
  forall 'ffi. state 'ffi -&gt; sem_env v -&gt; list top -&gt; state 'ffi *  result (sem_env v) v›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> 
<span class="entity">evaluate_tops</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> state <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span>top0<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">evaluate_tops</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rval <span class="main">(|</span> v <span class="main">=</span> nsEmpty<span class="main">,</span> c <span class="main">=</span> nsEmpty <span class="main">|)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">evaluate_tops</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">top1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">top2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">tops</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free">evaluate_tops</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">top1</span></span></span><span class="main">]</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">st1</span><span class="main">,</span> Rval <span class="bound">env1</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="main">(</span><span class="keyword1">case</span>  <span class="free">evaluate_tops</span> <span class="bound">st1</span> <span class="main">(</span>extend_dec_env <span class="bound">env1</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">top2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">tops</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
        <span class="main">(</span><span class="bound">st2</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">st2</span><span class="main">,</span> combine_dec_result <span class="bound">env1</span> <span class="bound">r</span><span class="main">)</span>
      <span class="main">)</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">=&gt;</span> <span class="bound">res</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">evaluate_tops</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Tdec <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span> fun_evaluate_decs <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">evaluate_tops</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">[</span>Tmod <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">specs</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="main">¬</span> <span class="main">(</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">mn</span></span></span><span class="main">]</span> <span class="main">∈</span><span class="main">(</span>defined_mods   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> no_dup_types <span class="free"><span class="bound"><span class="entity">ds</span></span></span>
  <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">case</span>  fun_evaluate_decs <span class="main">[</span><span class="free"><span class="bound"><span class="entity">mn</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="main">(</span><span class="main">(</span> <span class="bound">st'</span> <span class="main">(|</span> defined_mods <span class="main">:=</span> <span class="main">(</span><span class="main">{</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">mn</span></span></span><span class="main">]</span><span class="main">}</span> <span class="main">∪</span><span class="main">(</span>defined_mods   <span class="bound">st'</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span>
         <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">r</span> <span class="keyword1">of</span>
           Rval <span class="bound">env'</span> <span class="main">=&gt;</span> Rval <span class="main">(|</span> v <span class="main">=</span> <span class="main">(</span>nsLift <span class="free"><span class="bound"><span class="entity">mn</span></span></span><span class="main">(</span>v   <span class="bound">env'</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> c <span class="main">=</span> <span class="main">(</span>nsLift <span class="free"><span class="bound"><span class="entity">mn</span></span></span><span class="main">(</span>c   <span class="bound">env'</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span>
         <span class="main">|</span> Rerr <span class="bound">err</span> <span class="main">=&gt;</span> Rerr <span class="bound">err</span>
         <span class="main">)</span><span class="main">)</span>
    <span class="main">)</span>
  <span class="keyword1">else</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val evaluate_prog : forall 'ffi. state 'ffi -&gt; sem_env v -&gt; prog -&gt; state 'ffi * result (sem_env v) v›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span>
<span class="entity">fun_evaluate_prog</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> state <span class="main">⇒</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span>top0<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">fun_evaluate_prog</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> no_dup_mods <span class="free"><span class="bound"><span class="entity">prog</span></span></span><span class="main">(</span>defined_mods   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">∧</span> no_dup_top_types <span class="free"><span class="bound"><span class="entity">prog</span></span></span><span class="main">(</span>defined_types   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
    evaluate_tops <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">prog</span></span></span>
  <span class="keyword1">else</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LibAuxiliary">
<div class="head">
<h1>Theory LibAuxiliary</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>misc/lem_lib_stub/lib.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"LibAuxiliary"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives">LEM.Lem_pervasives</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_list_extra">LEM.Lem_list_extra</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_string">LEM.Lem_string</a>"</span>
  <span class="quoted">"<a href="../../coinductive/theories/#Coinductive_List">Coinductive.Coinductive_List</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>**************************************************›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>                                                  ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Termination Proofs                               ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>                                                  ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>**************************************************›</span></span>›</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">lunion</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="NamespaceAuxiliary">
<div class="head">
<h1>Theory NamespaceAuxiliary</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/namespace.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"NamespaceAuxiliary"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives">LEM.Lem_pervasives</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_set_extra">LEM.Lem_set_extra</a>"</span>
  <span class="quoted">"<a href="#Namespace">Namespace</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>**************************************************›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>                                                  ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Termination Proofs                               ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>                                                  ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>**************************************************›</span></span>›</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">nsMap</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PrimTypes">
<div class="head">
<h1>Theory PrimTypes</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/primTypes.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"PrimTypes"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives">LEM.Lem_pervasives</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>
  <span class="quoted">"<a href="#Namespace">Namespace</a>"</span>
  <span class="quoted">"<a href="#Ast">Ast</a>"</span>
  <span class="quoted">"<a href="#SemanticPrimitives">SemanticPrimitives</a>"</span>
  <span class="quoted">"<a href="#Ffi">Ffi</a>"</span>
  <span class="quoted">"<a href="#Evaluate">Evaluate</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Ast›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import SemanticPrimitives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Ffi›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Namespace›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Lib›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Evaluate›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val prim_types_program : prog›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prim_types_program</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>top0<span class="main">)</span>list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">prim_types_program</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">[</span>Tdec  <span class="main">(</span>Dexn <span class="main">(</span><span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">,</span> <span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span> <span class="main">(</span><span class="inner_quoted">''Bind''</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>
   Tdec  <span class="main">(</span>Dexn <span class="main">(</span><span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">,</span> <span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span> <span class="main">(</span><span class="inner_quoted">''Chr''</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>
   Tdec  <span class="main">(</span>Dexn <span class="main">(</span><span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">,</span> <span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span> <span class="main">(</span><span class="inner_quoted">''Div''</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>
   Tdec  <span class="main">(</span>Dexn <span class="main">(</span><span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">,</span> <span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span> <span class="main">(</span><span class="inner_quoted">''Subscript''</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>
   Tdec  <span class="main">(</span>Dtype <span class="main">(</span><span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">,</span> <span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="inner_quoted">''false''</span><span class="main">)</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''true''</span><span class="main">)</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
   Tdec  <span class="main">(</span>Dtype <span class="main">(</span><span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">,</span> <span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="keyword1">CHR</span> <span class="numeral">0x27</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''list''</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="inner_quoted">''nil''</span><span class="main">)</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="inner_quoted">''::''</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span>Tvar <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="keyword1">CHR</span> <span class="numeral">0x27</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> Tapp <span class="main">[</span>Tvar <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="keyword1">CHR</span> <span class="numeral">0x27</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>TC_name <span class="main">(</span>Short <span class="main">(</span><span class="inner_quoted">''list''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
   Tdec <span class="main">(</span>Dtype <span class="main">(</span><span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">,</span> <span class="main">(|</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="keyword1">CHR</span> <span class="numeral">0x27</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''option''</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="inner_quoted">''NONE''</span><span class="main">)</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">(</span><span class="inner_quoted">''SOME''</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span>Tvar <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="keyword1">CHR</span> <span class="numeral">0x27</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">]</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val add_to_sem_env :
  forall 'ffi. Eq 'ffi =&gt; (state 'ffi * sem_env v) -&gt; prog -&gt; maybe (state 'ffi * sem_env v)›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_to_sem_env</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span><span class="main">(</span>top0<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">add_to_sem_env</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  fun_evaluate_prog <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rval <span class="bound">env'</span><span class="main">)</span> <span class="main">=&gt;</span> Some <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> extend_dec_env <span class="bound">env'</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> None
  <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val prim_sem_env : forall 'ffi. Eq 'ffi =&gt; ffi_state 'ffi -&gt; maybe (state 'ffi * sem_env v)›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prim_sem_env</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'ffi</span> ffi_state <span class="main">⇒</span><span class="main">(</span><span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span>v<span class="main">)</span>sem_env<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">prim_sem_env</span> <span class="free"><span class="bound"><span class="entity">ffi1</span></span></span> <span class="main">=</span> <span class="main">(</span>
  add_to_sem_env
    <span class="main">(</span><span class="main">(|</span> clock <span class="main">=</span><span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">,</span> refs <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">)</span><span class="main">,</span> ffi <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ffi1</span></span></span><span class="main">,</span> defined_types <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">,</span> defined_mods <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span>  <span class="main">|)</span><span class="main">,</span>
     <span class="main">(|</span> v <span class="main">=</span> nsEmpty<span class="main">,</span> c <span class="main">=</span> nsEmpty <span class="main">|)</span><span class="main">)</span>
        prim_types_program <span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SemanticPrimitivesAuxiliary">
<div class="head">
<h1>Theory SemanticPrimitivesAuxiliary</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/semanticPrimitives.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"SemanticPrimitivesAuxiliary"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives">LEM.Lem_pervasives</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_list_extra">LEM.Lem_list_extra</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_string">LEM.Lem_string</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>
  <span class="quoted">"<a href="#Namespace">Namespace</a>"</span>
  <span class="quoted">"<a href="#Ast">Ast</a>"</span>
  <span class="quoted">"<a href="#Ffi">Ffi</a>"</span>
  <span class="quoted">"<a href="#FpSem">FpSem</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_string_extra">LEM.Lem_string_extra</a>"</span>
  <span class="quoted">"<a href="#SemanticPrimitives">SemanticPrimitives</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>**************************************************›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>                                                  ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Termination Proofs                               ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>                                                  ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>**************************************************›</span></span>›</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">pmatch</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">do_eq</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">v_to_list</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">v_to_char_list</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">vs_to_string</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SimpleIO">
<div class="head">
<h1>Theory SimpleIO</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/ffi/simpleIO.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"SimpleIO"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives">LEM.Lem_pervasives</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives_extra">LEM.Lem_pervasives_extra</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>
  <span class="quoted">"<a href="#Ffi">Ffi</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives_extra›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Lib›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Ffi›</span></span>›</span>

<span class="keyword1"><span class="command">datatype_record</span></span> simpleIO <span class="main">=</span> 
 <span class="free"><span class="entity">input</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">"  <span class="numeral">8</span> word llist "</span></span> 
 <span class="free"><span class="entity">output0</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">"  <span class="numeral">8</span> word llist "</span></span> 


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val isEof : oracle_function simpleIO›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">isEof</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" simpleIO <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>simpleIO<span class="main">)</span>oracle_result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">isEof</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Oracle_fail <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">isEof</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Oracle_return <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span><span class="main">(</span>input   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">=</span> LNil <span class="keyword1">then</span> of_nat <span class="main">(</span><span class="main">(</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> of_nat <span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val getChar : oracle_function simpleIO›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">getChar</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" simpleIO <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>simpleIO<span class="main">)</span>oracle_result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">getChar</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Oracle_fail <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">getChar</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="main">(</span><span class="keyword1">case</span>  lhd'<span class="main">(</span>input   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
        Some <span class="bound">y</span> <span class="main">=&gt;</span> Oracle_return <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(|</span> input <span class="main">:=</span> <span class="main">(</span>Option.the <span class="main">(</span>ltl'<span class="main">(</span>input   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> Oracle_fail
      <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val putChar : oracle_function simpleIO›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">putChar</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" simpleIO <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>simpleIO<span class="main">)</span>oracle_result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">putChar</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="free"><span class="bound"><span class="entity">input1</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">input1</span></span></span> <span class="keyword1">of</span>
    <span class="main">[]</span> <span class="main">=&gt;</span> Oracle_fail
  <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> Oracle_return <span class="main">(</span><span class="main">(</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(|</span> output0 <span class="main">:=</span> <span class="main">(</span>LCons <span class="bound">x</span><span class="main">(</span>output0   <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">input1</span></span></span>
  <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val exit : oracle_function simpleIO›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">exit0</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" simpleIO <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>simpleIO<span class="main">)</span>oracle_result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">exit0</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="free"><span class="bound"><span class="entity">input1</span></span></span> <span class="main">=</span> <span class="main">(</span> Oracle_diverge <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val simpleIO_oracle : oracle simpleIO›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">simpleIO_oracle</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" string <span class="main">⇒</span> simpleIO <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="numeral">8</span> word<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>simpleIO<span class="main">)</span>oracle_result "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">simpleIO_oracle</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="free"><span class="bound"><span class="entity">input1</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''isEof''</span><span class="main">)</span> <span class="keyword1">then</span>
    isEof <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="free"><span class="bound"><span class="entity">input1</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''getChar''</span><span class="main">)</span> <span class="keyword1">then</span>
    getChar <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="free"><span class="bound"><span class="entity">input1</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''putChar''</span><span class="main">)</span> <span class="keyword1">then</span>
    putChar <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="free"><span class="bound"><span class="entity">input1</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="inner_quoted">''exit''</span><span class="main">)</span> <span class="keyword1">then</span>
    exit0 <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="free"><span class="bound"><span class="entity">input1</span></span></span>
  <span class="keyword1">else</span>
    Oracle_fail <span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Tokens">
<div class="head">
<h1>Theory Tokens</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/tokens.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"Tokens"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives_extra">LEM.Lem_pervasives_extra</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives_extra›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Tokens for Standard ML.  NB, not all of them are used in CakeML ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> token <span class="main">=</span>
  WhitespaceT <span class="quoted"><span class="quoted">" nat "</span></span> <span class="main">|</span> NewlineT <span class="main">|</span> LexErrorT
<span class="main">|</span> HashT <span class="main">|</span> LparT <span class="main">|</span> RparT <span class="main">|</span> StarT <span class="main">|</span> CommaT <span class="main">|</span> ArrowT <span class="main">|</span> DotsT <span class="main">|</span> ColonT <span class="main">|</span> SealT
<span class="main">|</span> SemicolonT <span class="main">|</span> EqualsT <span class="main">|</span> DarrowT <span class="main">|</span> LbrackT <span class="main">|</span> RbrackT <span class="main">|</span> UnderbarT <span class="main">|</span> LbraceT
<span class="main">|</span> BarT <span class="main">|</span> RbraceT <span class="main">|</span> AndT <span class="main">|</span> AndalsoT <span class="main">|</span> AsT <span class="main">|</span> CaseT <span class="main">|</span> DatatypeT
<span class="main">|</span> ElseT <span class="main">|</span> EndT <span class="main">|</span> EqtypeT <span class="main">|</span> ExceptionT <span class="main">|</span> FnT <span class="main">|</span> FunT <span class="main">|</span> HandleT <span class="main">|</span> IfT
<span class="main">|</span> InT <span class="main">|</span> IncludeT <span class="main">|</span> LetT <span class="main">|</span> LocalT <span class="main">|</span> OfT <span class="main">|</span> OpT
<span class="main">|</span> OpenT <span class="main">|</span> OrelseT <span class="main">|</span> RaiseT <span class="main">|</span> RecT <span class="main">|</span> RefT <span class="main">|</span> SharingT <span class="main">|</span> SigT <span class="main">|</span> SignatureT <span class="main">|</span> StructT
<span class="main">|</span> StructureT <span class="main">|</span> ThenT <span class="main">|</span> TypeT <span class="main">|</span> ValT <span class="main">|</span> WhereT <span class="main">|</span> WhileT <span class="main">|</span> WithT <span class="main">|</span> WithtypeT
<span class="main">|</span> IntT <span class="quoted"><span class="quoted">" int "</span></span>
<span class="main">|</span> HexintT <span class="quoted"><span class="quoted">" string "</span></span>
<span class="main">|</span> WordT <span class="quoted"><span class="quoted">" nat "</span></span>
<span class="main">|</span> RealT <span class="quoted"><span class="quoted">" string "</span></span>
<span class="main">|</span> StringT <span class="quoted"><span class="quoted">" string "</span></span>
<span class="main">|</span> CharT <span class="quoted"><span class="quoted">" char "</span></span>
<span class="main">|</span> TyvarT <span class="quoted"><span class="quoted">" string "</span></span>
<span class="main">|</span> AlphaT <span class="quoted"><span class="quoted">" string "</span></span>
<span class="main">|</span> SymbolT <span class="quoted"><span class="quoted">" string "</span></span>
<span class="main">|</span> LongidT <span class="quoted"><span class="quoted">" string "</span></span> <span class="quoted"><span class="quoted">" string "</span></span>
<span class="main">|</span> FFIT <span class="quoted"><span class="quoted">" string "</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TypeSystem">
<div class="head">
<h1>Theory TypeSystem</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/typeSystem.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"TypeSystem"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives_extra">LEM.Lem_pervasives_extra</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>
  <span class="quoted">"<a href="#Namespace">Namespace</a>"</span>
  <span class="quoted">"<a href="#Ast">Ast</a>"</span>
  <span class="quoted">"<a href="#SemanticPrimitives">SemanticPrimitives</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Pervasives_extra›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Lib›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Ast›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import Namespace›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>open import SemanticPrimitives›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Check that the free type variables are in the given list. Every deBruijn
 * variable must be smaller than the first argument. So if it is 0, no deBruijn
 * indices are permitted. ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val check_freevars : nat -&gt; list tvarN -&gt; t -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span> 
<span class="entity">check_freevars</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" nat <span class="main">⇒</span><span class="main">(</span>string<span class="main">)</span>list <span class="main">⇒</span> t <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">check_freevars</span> <span class="free"><span class="bound"><span class="entity">dbmax</span></span></span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="main">(</span>Tvar <span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  Set.member <span class="free"><span class="bound"><span class="entity">tv</span></span></span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">tvs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">check_freevars</span> <span class="free"><span class="bound"><span class="entity">dbmax</span></span></span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="main">(</span>Tapp <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span><span class="free">check_freevars</span> <span class="free"><span class="bound"><span class="entity">dbmax</span></span></span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">check_freevars</span> <span class="free"><span class="bound"><span class="entity">dbmax</span></span></span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="main">(</span>Tvar_db <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">dbmax</span></span></span> <span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Simultaneous substitution of types for type variables in a type ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val type_subst : Map.map tvarN t -&gt; t -&gt; t›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span> 
<span class="entity">type_subst</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>t<span class="main">)</span><span class="main">)</span>Map.map <span class="main">⇒</span> t <span class="main">⇒</span> t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">type_subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Tvar <span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>   <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">tv</span></span></span> <span class="keyword1">of</span>
      None <span class="main">=&gt;</span> Tvar <span class="free"><span class="bound"><span class="entity">tv</span></span></span>
    <span class="main">|</span> Some<span class="main">(</span><span class="bound">t1</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">t1</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">type_subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Tapp <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  Tapp <span class="main">(</span>List.map <span class="main">(</span><span class="free">type_subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">type_subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Tvar_db <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Tvar_db <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Increment the deBruijn indices in a type by n levels, skipping all levels
 * less than skip. ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val deBruijn_inc : nat -&gt; nat -&gt; t -&gt; t›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span> 
<span class="entity">deBruijn_inc</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" nat <span class="main">⇒</span> nat <span class="main">⇒</span> t <span class="main">⇒</span> t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">deBruijn_inc</span> <span class="free"><span class="bound"><span class="entity">skip</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Tvar <span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Tvar <span class="free"><span class="bound"><span class="entity">tv</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">deBruijn_inc</span> <span class="free"><span class="bound"><span class="entity">skip</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Tvar_db <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">skip</span></span></span> <span class="keyword1">then</span>
    Tvar_db <span class="free"><span class="bound"><span class="entity">m</span></span></span>
  <span class="keyword1">else</span>
    Tvar_db <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">deBruijn_inc</span> <span class="free"><span class="bound"><span class="entity">skip</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Tapp <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Tapp <span class="main">(</span>List.map <span class="main">(</span><span class="free">deBruijn_inc</span> <span class="free"><span class="bound"><span class="entity">skip</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span> <span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> skip the lowest given indices and replace the next (LENGTH ts) with the given types and reduce all the higher ones ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val deBruijn_subst : nat -&gt; list t -&gt; t -&gt; t›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span> 
<span class="entity">deBruijn_subst</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" nat <span class="main">⇒</span><span class="main">(</span>t<span class="main">)</span>list <span class="main">⇒</span> t <span class="main">⇒</span> t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">deBruijn_subst</span> <span class="free"><span class="bound"><span class="entity">skip</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">(</span>Tvar <span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Tvar <span class="free"><span class="bound"><span class="entity">tv</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">deBruijn_subst</span> <span class="free"><span class="bound"><span class="entity">skip</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">(</span>Tvar_db <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">skip</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="main">(</span>List.length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">skip</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
    List.nth <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">skip</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">skip</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
    Tvar_db <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> List.length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span>
    Tvar_db <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">deBruijn_subst</span> <span class="free"><span class="bound"><span class="entity">skip</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">(</span>Tapp <span class="free"><span class="bound"><span class="entity">ts'</span></span></span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  Tapp <span class="main">(</span>List.map <span class="main">(</span><span class="free">deBruijn_subst</span> <span class="free"><span class="bound"><span class="entity">skip</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span> <span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Type environments ›</span></span>›</span>
<span class="keyword1"><span class="command">datatype</span></span> tenv_val_exp <span class="main">=</span>
    Empty
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Binds several de Bruijn type variables ›</span></span>›</span>
  <span class="main">|</span> Bind_tvar <span class="quoted"><span class="quoted">" nat "</span></span> <span class="quoted"><span class="quoted">" tenv_val_exp "</span></span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> The number is how many de Bruijn type variables the typescheme binds ›</span></span>›</span>
  <span class="main">|</span> Bind_name <span class="quoted"><span class="quoted">" varN "</span></span> <span class="quoted"><span class="quoted">" nat "</span></span> <span class="quoted"><span class="quoted">" t "</span></span> <span class="quoted"><span class="quoted">" tenv_val_exp "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val bind_tvar : nat -&gt; tenv_val_exp -&gt; tenv_val_exp›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bind_tvar</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" nat <span class="main">⇒</span> tenv_val_exp <span class="main">⇒</span> tenv_val_exp "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">bind_tvar</span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="main">=</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="keyword1">else</span> Bind_tvar <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val opt_bind_name : maybe varN -&gt; nat -&gt; t -&gt; tenv_val_exp -&gt; tenv_val_exp›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">opt_bind_name</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="main">)</span>option <span class="main">⇒</span> nat <span class="main">⇒</span> t <span class="main">⇒</span> tenv_val_exp <span class="main">⇒</span> tenv_val_exp "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">opt_bind_name</span> None <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">opt_bind_name</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">=</span> <span class="main">(</span> Bind_name <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val tveLookup : varN -&gt; nat -&gt; tenv_val_exp -&gt; maybe (nat * t)›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> 
<span class="entity">tveLookup</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" string <span class="main">⇒</span> nat <span class="main">⇒</span> tenv_val_exp <span class="main">⇒</span><span class="main">(</span>nat<span class="main">*</span>t<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">tveLookup</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> Empty <span class="main">=</span> <span class="main">(</span> None <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">tveLookup</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="main">(</span>Bind_tvar <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="free">tveLookup</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">tveLookup</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="main">(</span>Bind_name <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span>
    Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tvs</span></span></span><span class="main">,</span> deBruijn_inc <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span>
    <span class="free">tveLookup</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> tenv_abbrev <span class="main">=</span><span class="quoted"><span class="quoted">" <span class="main">(</span>modN<span class="main">,</span> typeN<span class="main">,</span> <span class="main">(</span> tvarN list <span class="main">*</span> t<span class="main">)</span><span class="main">)</span> namespace "</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> tenv_ctor <span class="main">=</span><span class="quoted"><span class="quoted">" <span class="main">(</span>modN<span class="main">,</span> conN<span class="main">,</span> <span class="main">(</span> tvarN list <span class="main">*</span> t list <span class="main">*</span> tid_or_exn<span class="main">)</span><span class="main">)</span> namespace "</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> tenv_val <span class="main">=</span><span class="quoted"><span class="quoted">" <span class="main">(</span>modN<span class="main">,</span> varN<span class="main">,</span> <span class="main">(</span>nat <span class="main">*</span> t<span class="main">)</span><span class="main">)</span> namespace "</span></span>

<span class="keyword1"><span class="command">datatype_record</span></span> type_env <span class="main">=</span>
  
 <span class="free"><span class="entity">v0</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" tenv_val "</span></span>
   
 <span class="free"><span class="entity">c0</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" tenv_ctor "</span></span>
   
 <span class="free"><span class="entity">t</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" tenv_abbrev "</span></span>
   


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val extend_dec_tenv : type_env -&gt; type_env -&gt; type_env›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extend_dec_tenv</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" type_env <span class="main">⇒</span> type_env <span class="main">⇒</span> type_env "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">extend_dec_tenv</span> <span class="free"><span class="bound"><span class="entity">tenv'</span></span></span> <span class="free"><span class="bound"><span class="entity">tenv</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(|</span> v0 <span class="main">=</span> <span class="main">(</span>nsAppend<span class="main">(</span>v0   <span class="free"><span class="bound"><span class="entity">tenv'</span></span></span><span class="main">)</span><span class="main">(</span>v0   <span class="free"><span class="bound"><span class="entity">tenv</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     c0 <span class="main">=</span> <span class="main">(</span>nsAppend<span class="main">(</span>c0   <span class="free"><span class="bound"><span class="entity">tenv'</span></span></span><span class="main">)</span><span class="main">(</span>c0   <span class="free"><span class="bound"><span class="entity">tenv</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     t <span class="main">=</span> <span class="main">(</span>nsAppend<span class="main">(</span>t   <span class="free"><span class="bound"><span class="entity">tenv'</span></span></span><span class="main">)</span><span class="main">(</span>t   <span class="free"><span class="bound"><span class="entity">tenv</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val lookup_varE : id modN varN -&gt; tenv_val_exp -&gt; maybe (nat * t)›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lookup_varE</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">)</span>id0 <span class="main">⇒</span> tenv_val_exp <span class="main">⇒</span><span class="main">(</span>nat<span class="main">*</span>t<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">lookup_varE</span> <span class="main">(</span>Short <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">=</span> <span class="main">(</span> tveLookup <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">lookup_varE</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">=</span> <span class="main">(</span> None <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val lookup_var : id modN varN -&gt; tenv_val_exp -&gt; type_env -&gt; maybe (nat * t)›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lookup_var</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>modN<span class="main">)</span><span class="main">,</span><span class="main">(</span>varN<span class="main">)</span><span class="main">)</span>id0 <span class="main">⇒</span> tenv_val_exp <span class="main">⇒</span> type_env <span class="main">⇒</span><span class="main">(</span>nat<span class="main">*</span>t<span class="main">)</span>option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">lookup_var</span> <span class="free"><span class="bound"><span class="entity">id1</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="free"><span class="bound"><span class="entity">tenv</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  lookup_varE <span class="free"><span class="bound"><span class="entity">id1</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="keyword1">of</span>
    Some <span class="bound">x</span> <span class="main">=&gt;</span> Some <span class="bound">x</span>
  <span class="main">|</span> None <span class="main">=&gt;</span> nsLookup<span class="main">(</span>v0   <span class="free"><span class="bound"><span class="entity">tenv</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">id1</span></span></span>
  <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val num_tvs : tenv_val_exp -&gt; nat›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> 
<span class="entity">num_tvs</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" tenv_val_exp <span class="main">⇒</span> nat "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">num_tvs</span> Empty <span class="main">=</span> <span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">num_tvs</span> <span class="main">(</span>Bind_tvar <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="main">+</span> <span class="free">num_tvs</span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">num_tvs</span> <span class="main">(</span>Bind_name <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="free">num_tvs</span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val bind_var_list : nat -&gt; list (varN * t) -&gt; tenv_val_exp -&gt; tenv_val_exp›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> 
<span class="entity">bind_var_list</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" nat <span class="main">⇒</span><span class="main">(</span>string<span class="main">*</span>t<span class="main">)</span>list <span class="main">⇒</span> tenv_val_exp <span class="main">⇒</span> tenv_val_exp "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">bind_var_list</span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">bind_var_list</span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">binds</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="main">=</span> <span class="main">(</span>
  Bind_name <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">(</span><span class="free">bind_var_list</span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">binds</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> A pattern matches values of a certain type and extends the type environment
 * with the pattern's binders. The number is the maximum deBruijn type variable
 * allowed. ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val type_p : nat -&gt; type_env -&gt; pat -&gt; t -&gt; list (varN * t) -&gt; bool›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> An expression has a type ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val type_e : type_env -&gt; tenv_val_exp -&gt; exp -&gt; t -&gt; bool›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> A list of expressions has a list of types ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val type_es : type_env -&gt; tenv_val_exp -&gt; list exp -&gt; list t -&gt; bool›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Type a mutually recursive bundle of functions.  Unlike pattern typing, the
 * resulting environment does not extend the input environment, but just
 * represents the functions ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val type_funs : type_env -&gt; tenv_val_exp -&gt; list (varN * varN * exp) -&gt; list (varN * t) -&gt; bool›</span></span>›</span>

<span class="keyword1"><span class="command">datatype_record</span></span> decls <span class="main">=</span>
  
 <span class="free"><span class="entity">defined_mods0</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" <span class="main">(</span> modN list<span class="main">)</span> set "</span></span> 

     <span class="free"><span class="entity">defined_types0</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" <span class="main">(</span> <span class="main">(</span>modN<span class="main">,</span> typeN<span class="main">)</span>id0<span class="main">)</span> set "</span></span> 

     <span class="free"><span class="entity">defined_exns</span></span> <span class="main">::</span><span class="quoted"><span class="quoted">" <span class="main">(</span> <span class="main">(</span>modN<span class="main">,</span> conN<span class="main">)</span>id0<span class="main">)</span> set "</span></span> 


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val empty_decls : decls›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_decls</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" decls "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">empty_decls</span> <span class="main">=</span> <span class="main">(</span> <span class="main">(|</span> defined_mods0 <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">,</span> defined_types0 <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">,</span> defined_exns <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">|)</span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val union_decls : decls -&gt; decls -&gt; decls›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">union_decls</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" decls <span class="main">⇒</span> decls <span class="main">⇒</span> decls "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">union_decls</span> <span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(|</span> defined_mods0 <span class="main">=</span> <span class="main">(</span><span class="main">(</span>defined_mods0   <span class="free"><span class="bound"><span class="entity">d1</span></span></span><span class="main">)</span> <span class="main">∪</span><span class="main">(</span>defined_mods0   <span class="free"><span class="bound"><span class="entity">d2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     defined_types0 <span class="main">=</span> <span class="main">(</span><span class="main">(</span>defined_types0   <span class="free"><span class="bound"><span class="entity">d1</span></span></span><span class="main">)</span> <span class="main">∪</span><span class="main">(</span>defined_types0   <span class="free"><span class="bound"><span class="entity">d2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     defined_exns <span class="main">=</span> <span class="main">(</span><span class="main">(</span>defined_exns   <span class="free"><span class="bound"><span class="entity">d1</span></span></span><span class="main">)</span> <span class="main">∪</span><span class="main">(</span>defined_exns   <span class="free"><span class="bound"><span class="entity">d2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Check a declaration and update the top-level environments
 * The arguments are in order:
 * - the module that the declaration is in
 * - the set of all modules, and types, and exceptions that have been previously declared
 * - the type environment
 * - the declaration
 * - the set of all modules, and types, and exceptions that are declared here
 * - the environment of new stuff declared here ›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val type_d : bool -&gt; list modN -&gt; decls -&gt; type_env -&gt; dec -&gt; decls -&gt; type_env -&gt; bool›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val type_ds : bool -&gt; list modN -&gt; decls -&gt; type_env -&gt; list dec -&gt; decls -&gt; type_env -&gt; bool›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val check_signature : list modN -&gt; tenv_abbrev -&gt; decls -&gt; type_env -&gt; maybe specs -&gt; decls -&gt; type_env -&gt; bool›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val type_specs : list modN -&gt; tenv_abbrev -&gt; specs -&gt; decls -&gt; type_env -&gt; bool›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val type_prog : bool -&gt; decls -&gt; type_env -&gt; list top -&gt; decls -&gt; type_env -&gt; bool›</span></span>›</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Check that the operator can have type (t1 -&gt; ... -&gt; tn -&gt; t) ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val type_op : op -&gt; list t -&gt; t -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">type_op</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" op0 <span class="main">⇒</span><span class="main">(</span>t<span class="main">)</span>list <span class="main">⇒</span> t <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">type_op</span> <span class="main">(</span>Opn <span class="free"><span class="bound"><span class="entity">o0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">o0</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_int<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tint<span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> <span class="main">(</span>Opb <span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_int<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span>
                                                   Tapp <span class="main">[]</span>
                                                     <span class="main">(</span>TC_name
                                                        <span class="main">(</span>Short <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> <span class="main">(</span>Opw <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">o2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">o2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span> W8<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_word8<span class="main">,</span> Tapp <span class="main">[]</span> TC_word8<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span>
                                                           Tapp <span class="main">[]</span> TC_word8<span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span> W64<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_word64<span class="main">,</span> Tapp <span class="main">[]</span> TC_word64<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span>
                                                              Tapp <span class="main">[]</span>
                                                                TC_word64<span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> <span class="main">(</span>Shift <span class="free"><span class="bound"><span class="entity">w0</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w0</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n0</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span> W8<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_word8<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_word8<span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span> W64<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_word64<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_word64<span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Equality <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span><span class="bound">t11</span><span class="main">,</span> <span class="bound">t2</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">t11</span> <span class="main">=</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">∧</span>
                     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> <span class="main">(</span>TC_name <span class="main">(</span>Short <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> <span class="main">(</span>FP_cmp <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_word64<span class="main">,</span> Tapp <span class="main">[]</span> TC_word64<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span>
                                                         Tapp <span class="main">[]</span>
                                                           <span class="main">(</span>TC_name
                                                              <span class="main">(</span>Short
                                                                 <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> <span class="main">(</span>FP_uop <span class="free"><span class="bound"><span class="entity">f0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f0</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_word64<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_word64<span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> <span class="main">(</span>FP_bop <span class="free"><span class="bound"><span class="entity">f1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_word64<span class="main">,</span> Tapp <span class="main">[]</span> TC_word64<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_word64<span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Opapp <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[</span><span class="bound">t2'</span><span class="main">,</span> <span class="bound">t3'</span><span class="main">]</span> TC_fn<span class="main">,</span> <span class="bound">t2</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">t2</span> <span class="main">=</span> <span class="bound">t2'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="bound">t3'</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Opassign <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[</span><span class="bound">t11</span><span class="main">]</span> TC_ref<span class="main">,</span> <span class="bound">t2</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">t11</span> <span class="main">=</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_tup<span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Opref <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span> <span class="main">[</span><span class="bound">t11</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[</span><span class="bound">t11</span><span class="main">]</span> TC_ref<span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Opderef <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span> <span class="main">[</span>Tapp <span class="main">[</span><span class="bound">t11</span><span class="main">]</span> TC_ref<span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="bound">t11</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Aw8alloc <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[]</span> TC_int<span class="main">,</span> Tapp <span class="main">[]</span> TC_word8<span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_word8array<span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Aw8sub <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[]</span> TC_word8array<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_word8<span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Aw8length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_word8array<span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_int<span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Aw8update <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[]</span> TC_word8array<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">,</span> Tapp <span class="main">[]</span> TC_word8<span class="main">]</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span>
                                                                    Tapp 
                                                                    <span class="main">[]</span> 
                                                                    TC_tup
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> <span class="main">(</span>WordFromInt <span class="free"><span class="bound"><span class="entity">w1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span> W8<span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_int<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_word8
    <span class="main">|</span> <span class="main">(</span> W64<span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_int<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_word64
    <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> <span class="main">(</span>WordToInt <span class="free"><span class="bound"><span class="entity">w2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span> W8<span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_word8<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_int
    <span class="main">|</span> <span class="main">(</span> W64<span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_word64<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_int
    <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> CopyStrStr <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[]</span> TC_string<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">]</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span>
                                                               Tapp <span class="main">[]</span>
                                                                 TC_string
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> CopyStrAw8 <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[]</span> TC_string<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">,</span> Tapp <span class="main">[]</span> TC_word8array<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">]</span> <span class="main">=&gt;</span> 
  <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_tup
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> CopyAw8Str <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[]</span> TC_word8array<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">]</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span>
                                                                   Tapp 
                                                                   <span class="main">[]</span>
                                                                    TC_string
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> CopyAw8Aw8 <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[]</span> TC_word8array<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">,</span> Tapp <span class="main">[]</span> TC_word8array<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">]</span> <span class="main">=&gt;</span> 
  <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_tup
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Ord <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_char<span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tint<span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Chr <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_int<span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tchar<span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> <span class="main">(</span>Chopb <span class="free"><span class="bound"><span class="entity">o3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">o3</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_char<span class="main">,</span> Tapp <span class="main">[]</span> TC_char<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span>
                                                     Tapp <span class="main">[]</span>
                                                       <span class="main">(</span>TC_name
                                                          <span class="main">(</span>Short <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Implode <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">=&gt;</span> False
    <span class="main">|</span> <span class="bound">t0</span> <span class="main">#</span> <span class="bound">l0</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t0</span> <span class="keyword1">of</span>
                     Tvar <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
                   <span class="main">|</span> Tvar_db <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
                   <span class="main">|</span> Tapp <span class="bound">l1</span> <span class="bound">t4</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l1</span> <span class="keyword1">of</span>
                                       <span class="main">[]</span> <span class="main">=&gt;</span> False
                                     <span class="main">|</span> <span class="bound">t5</span> <span class="main">#</span> <span class="bound">l2</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t5</span> <span class="keyword1">of</span>
                                                      Tvar <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
                                                    <span class="main">|</span> Tvar_db <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
                                                    <span class="main">|</span> Tapp <span class="bound">l3</span> <span class="bound">t7</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l3</span> <span class="keyword1">of</span>
                                                                    <span class="main">[]</span> <span class="main">=&gt;</span> 
                                                                    <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t7</span> <span class="keyword1">of</span>
                                                                    TC_name <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_int <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_char <span class="main">=&gt;</span> 
                                                                    <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l2</span> <span class="keyword1">of</span>
                                                                    <span class="main">[]</span> <span class="main">=&gt;</span> 
                                                                    <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t4</span> <span class="keyword1">of</span>
                                                                    TC_name <span class="bound">i0</span> <span class="main">=&gt;</span> 
                                                                    <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">i0</span> <span class="keyword1">of</span>
                                                                    Short <span class="bound">s1</span> <span class="main">=&gt;</span>
                                                                    <span class="keyword1">if</span>
                                                                    <span class="main">(</span>
                                                                    <span class="bound">s1</span> <span class="main">=</span>
                                                                    <span class="main">(</span><span class="inner_quoted">''list''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
                                                                    <span class="main">(</span>
                                                                    <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l0</span> <span class="keyword1">of</span>
                                                                    <span class="main">[]</span> <span class="main">=&gt;</span> 
                                                                    <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span>
                                                                    Tapp 
                                                                    <span class="main">[]</span>
                                                                    TC_string
                                                                    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span>
                                                                    False
                                                                    <span class="main">|</span> Long <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">)</span>
                                                                    <span class="main">|</span> TC_int <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_char <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_string <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_ref <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_word8 <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_word64 <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_word8array <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_fn <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_tup <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_exn <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_vector <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_array <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">)</span>
                                                                    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">)</span>
                                                                    <span class="main">|</span> TC_string <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_ref <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_word8 <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_word64 <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_word8array <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_fn <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_tup <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_exn <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_vector <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">|</span> TC_array <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">)</span>
                                                                    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">)</span>
                                                  <span class="main">)</span>
                                   <span class="main">)</span>
                 <span class="main">)</span>
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Strsub <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[]</span> TC_string<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">]</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tchar
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Strlen <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_string<span class="main">]</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tint <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Strcat <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">=&gt;</span> False
    <span class="main">|</span> <span class="bound">t10</span> <span class="main">#</span> <span class="bound">l6</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t10</span> <span class="keyword1">of</span>
                      Tvar <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
                    <span class="main">|</span> Tvar_db <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
                    <span class="main">|</span> Tapp <span class="bound">l7</span> <span class="bound">t12</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l7</span> <span class="keyword1">of</span>
                                         <span class="main">[]</span> <span class="main">=&gt;</span> False
                                       <span class="main">|</span> <span class="bound">t13</span> <span class="main">#</span> <span class="bound">l8</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t13</span> <span class="keyword1">of</span>
                                                         Tvar <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
                                                       <span class="main">|</span> Tvar_db <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                     False
                                                       <span class="main">|</span> Tapp <span class="bound">l9</span> <span class="bound">t15</span> <span class="main">=&gt;</span> 
                                                     <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l9</span> <span class="keyword1">of</span>
                                                         <span class="main">[]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t15</span> <span class="keyword1">of</span>
                                                                   TC_name <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_int <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_char <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_string <span class="main">=&gt;</span> 
                                                               <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l8</span> <span class="keyword1">of</span>
                                                                   <span class="main">[]</span> <span class="main">=&gt;</span> 
                                                               <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t12</span> <span class="keyword1">of</span>
                                                                   TC_name <span class="bound">i3</span> <span class="main">=&gt;</span> 
                                                               <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">i3</span> <span class="keyword1">of</span>
                                                                   Short <span class="bound">s3</span> <span class="main">=&gt;</span>
                                                               <span class="keyword1">if</span><span class="main">(</span><span class="bound">s3</span> <span class="main">=</span>
                                                                    <span class="main">(</span><span class="inner_quoted">''list''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
                                                                 <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l6</span> <span class="keyword1">of</span>
                                                                    <span class="main">[]</span> <span class="main">=&gt;</span> 
                                                                  <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span>
                                                                    Tapp 
                                                                    <span class="main">[]</span>
                                                                    TC_string
                                                                    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                                  False
                                                                  <span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span>
                                                                 False
                                                                 <span class="main">|</span> Long <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                               False
                                                               <span class="main">)</span>
                                                                 <span class="main">|</span> TC_int <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_char <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_string <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_ref <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_word8 <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_word64 <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_word8array <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_fn <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_tup <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_exn <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_vector <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_array <span class="main">=&gt;</span> 
                                                               False
                                                               <span class="main">)</span>
                                                                 <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                               False
                                                               <span class="main">)</span>
                                                                 <span class="main">|</span> TC_ref <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_word8 <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_word64 <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_word8array <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_fn <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_tup <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_exn <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_vector <span class="main">=&gt;</span> 
                                                               False
                                                                 <span class="main">|</span> TC_array <span class="main">=&gt;</span> 
                                                               False
                                                               <span class="main">)</span>
                                                       <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
                                                     <span class="main">)</span>
                                                     <span class="main">)</span>
                                     <span class="main">)</span>
                  <span class="main">)</span>
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> VfromList <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">=&gt;</span> False
    <span class="main">|</span> <span class="bound">t18</span> <span class="main">#</span> <span class="bound">l12</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t18</span> <span class="keyword1">of</span>
                       Tvar <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
                     <span class="main">|</span> Tvar_db <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
                     <span class="main">|</span> Tapp <span class="bound">l13</span> <span class="bound">t20</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l13</span> <span class="keyword1">of</span>
                                           <span class="main">[]</span> <span class="main">=&gt;</span> False
                                         <span class="main">|</span> <span class="bound">t21</span> <span class="main">#</span> <span class="bound">l14</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">l14</span> <span class="keyword1">of</span>
                                                            <span class="main">[]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">t20</span> <span class="keyword1">of</span>
                                                                    TC_name <span class="bound">i5</span> <span class="main">=&gt;</span> 
                                                                  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">i5</span> <span class="keyword1">of</span>
                                                                    Short <span class="bound">s5</span> <span class="main">=&gt;</span>
                                                                  <span class="keyword1">if</span><span class="main">(</span>
                                                                    <span class="bound">s5</span> <span class="main">=</span>
                                                                    <span class="main">(</span><span class="inner_quoted">''list''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
                                                                    <span class="main">(</span>
                                                                    <span class="main">(</span><span class="keyword1">case</span> 
                                                                    <span class="main">(</span><span class="bound">t21</span><span class="main">,</span><span class="bound">l12</span><span class="main">)</span> <span class="keyword1">of</span>
                                                                    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=&gt;</span> 
                                                                    <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span>
                                                                    Tapp
                                                                    <span class="main">[</span><span class="bound">t21</span><span class="main">]</span>
                                                                    TC_vector
                                                                    <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> 
                                                                    False
                                                                    <span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span>
                                                                    False
                                                                    <span class="main">|</span> Long <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                                  False
                                                                  <span class="main">)</span>
                                                                    <span class="main">|</span> TC_int <span class="main">=&gt;</span> 
                                                                  False
                                                                    <span class="main">|</span> TC_char <span class="main">=&gt;</span> 
                                                                  False
                                                                    <span class="main">|</span> TC_string <span class="main">=&gt;</span> 
                                                                  False
                                                                    <span class="main">|</span> TC_ref <span class="main">=&gt;</span> 
                                                                  False
                                                                    <span class="main">|</span> TC_word8 <span class="main">=&gt;</span> 
                                                                  False
                                                                    <span class="main">|</span> TC_word64 <span class="main">=&gt;</span> 
                                                                  False
                                                                    <span class="main">|</span> TC_word8array <span class="main">=&gt;</span> 
                                                                  False
                                                                    <span class="main">|</span> TC_fn <span class="main">=&gt;</span> 
                                                                  False
                                                                    <span class="main">|</span> TC_tup <span class="main">=&gt;</span> 
                                                                  False
                                                                    <span class="main">|</span> TC_exn <span class="main">=&gt;</span> 
                                                                  False
                                                                    <span class="main">|</span> TC_vector <span class="main">=&gt;</span> 
                                                                  False
                                                                    <span class="main">|</span> TC_array <span class="main">=&gt;</span> 
                                                                  False
                                                                  <span class="main">)</span>
                                                          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> 
                                                        False
                                                        <span class="main">)</span>
                                       <span class="main">)</span>
                   <span class="main">)</span>
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Vsub <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[</span><span class="bound">t11</span><span class="main">]</span> TC_vector<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">]</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="bound">t11</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Vlength <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span> <span class="main">[</span>Tapp <span class="main">[</span><span class="bound">t11</span><span class="main">]</span> TC_vector<span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_int<span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Aalloc <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[]</span> TC_int<span class="main">,</span> <span class="bound">t11</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[</span><span class="bound">t11</span><span class="main">]</span> TC_array
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> AallocEmpty <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[]</span> TC_tup<span class="main">]</span> <span class="main">=&gt;</span><span class="main">(</span> <span class="main">∃</span> <span class="bound">t10</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[</span><span class="bound">t10</span><span class="main">]</span> TC_array<span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Asub <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[</span><span class="bound">t11</span><span class="main">]</span> TC_array<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">]</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="bound">t11</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Alength <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span> <span class="main">[</span>Tapp <span class="main">[</span><span class="bound">t11</span><span class="main">]</span> TC_array<span class="main">]</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_int <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> Aupdate <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[</span><span class="bound">t11</span><span class="main">]</span> TC_array<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">,</span> <span class="bound">t2</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">t11</span> <span class="main">=</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">∧</span>
                                                     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_tup<span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> ConfigGC <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1">of</span>
      <span class="main">[</span>Tapp <span class="main">[]</span> TC_int<span class="main">,</span> Tapp <span class="main">[]</span> TC_int<span class="main">]</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_tup
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">type_op</span> <span class="main">(</span>FFI <span class="free"><span class="bound"><span class="entity">s0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">(</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s0</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">[</span>Tapp <span class="main">[]</span> TC_string<span class="main">,</span> Tapp <span class="main">[]</span> TC_word8array<span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> TC_tup
    <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> False
  <span class="main">)</span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val check_type_names : tenv_abbrev -&gt; t -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span> 
<span class="entity">check_type_names</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">(</span>string<span class="main">)</span>list<span class="main">*</span>t<span class="main">)</span><span class="main">)</span>namespace <span class="main">⇒</span> t <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">check_type_names</span> <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span> <span class="main">(</span>Tvar <span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  True <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">check_type_names</span> <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span> <span class="main">(</span>Tapp <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">tn</span></span></span> <span class="keyword1">of</span>
     TC_name <span class="bound">tn</span> <span class="main">=&gt;</span>
       <span class="main">(</span><span class="keyword1">case</span>  nsLookup <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span> <span class="bound">tn</span> <span class="keyword1">of</span>
           Some <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">=&gt;</span> List.length <span class="bound">tvs</span> <span class="main">=</span> List.length <span class="free"><span class="bound"><span class="entity">ts</span></span></span>
         <span class="main">|</span> None <span class="main">=&gt;</span> False
       <span class="main">)</span>
   <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> True
  <span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span><span class="free">check_type_names</span> <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">check_type_names</span> <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span> <span class="main">(</span>Tvar_db <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  True <span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Substitution of type names for the type they abbreviate ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val type_name_subst : tenv_abbrev -&gt; t -&gt; t›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span> 
<span class="entity">type_name_subst</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">(</span>string<span class="main">)</span>list<span class="main">*</span>t<span class="main">)</span><span class="main">)</span>namespace <span class="main">⇒</span> t <span class="main">⇒</span> t "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">type_name_subst</span> <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span> <span class="main">(</span>Tvar <span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Tvar <span class="free"><span class="bound"><span class="entity">tv</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">type_name_subst</span> <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span> <span class="main">(</span>Tapp <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">tc</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">args</span> <span class="main">=</span> <span class="main">(</span>List.map <span class="main">(</span><span class="free">type_name_subst</span> <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">case</span>  <span class="free"><span class="bound"><span class="entity">tc</span></span></span> <span class="keyword1">of</span>
        TC_name <span class="bound">tn</span> <span class="main">=&gt;</span>
          <span class="main">(</span><span class="keyword1">case</span>  nsLookup <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span> <span class="bound">tn</span> <span class="keyword1">of</span>
              Some <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">=&gt;</span> type_subst <span class="main">(</span>map_of <span class="main">(</span>Lem_list_extra.zipSameLength <span class="bound">tvs</span> <span class="bound">args</span><span class="main">)</span><span class="main">)</span> <span class="bound">t1</span>
            <span class="main">|</span> None <span class="main">=&gt;</span> Tapp <span class="bound">args</span> <span class="free"><span class="bound"><span class="entity">tc</span></span></span>
          <span class="main">)</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> Tapp <span class="bound">args</span> <span class="free"><span class="bound"><span class="entity">tc</span></span></span>
    <span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">type_name_subst</span> <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span> <span class="main">(</span>Tvar_db <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> Tvar_db <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Check that a type definition defines no already defined types or duplicate
 * constructors, and that the free type variables of each constructor argument
 * type are included in the type's type parameters. Also check that all of the
 * types mentioned are in scope. ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val check_ctor_tenv : tenv_abbrev -&gt; list (list tvarN * typeN * list (conN * list t)) -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_ctor_tenv</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>modN<span class="main">)</span><span class="main">,</span><span class="main">(</span>typeN<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">(</span>tvarN<span class="main">)</span>list<span class="main">*</span>t<span class="main">)</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>tvarN<span class="main">)</span>list<span class="main">*</span>typeN<span class="main">*</span><span class="main">(</span>conN<span class="main">*</span><span class="main">(</span>t<span class="main">)</span>list<span class="main">)</span>list<span class="main">)</span>list <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">check_ctor_tenv</span> <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span> <span class="free"><span class="bound"><span class="entity">tds</span></span></span> <span class="main">=</span> <span class="main">(</span>
  check_dup_ctors <span class="free"><span class="bound"><span class="entity">tds</span></span></span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">tds</span></span></span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span><span class="bound">tn</span><span class="main">,</span><span class="bound">ctors</span><span class="main">)</span> <span class="main">=&gt;</span>
  Lem_list.allDistinct <span class="bound">tvs</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="bound">ctors</span><span class="main">)</span><span class="main">.</span>
       <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span>
                           <span class="main">(</span><span class="bound">cn</span><span class="main">,</span><span class="bound">ts</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="bound">ts</span><span class="main">)</span><span class="main">.</span>
                                         <span class="main">(</span>check_freevars <span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">tvs</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
                                        <span class="main">∧</span>
                                        <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="bound">ts</span><span class="main">)</span><span class="main">.</span>
                                           <span class="main">(</span>check_type_names <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
                       <span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  Lem_list.allDistinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">tn</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">tn</span> <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tds</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val build_ctor_tenv : list modN -&gt; tenv_abbrev -&gt; list (list tvarN * typeN * list (conN * list t)) -&gt; tenv_ctor›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">build_ctor_tenv</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>modN<span class="main">)</span><span class="main">,</span><span class="main">(</span>typeN<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">(</span>tvarN<span class="main">)</span>list<span class="main">*</span>t<span class="main">)</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>tvarN<span class="main">)</span>list<span class="main">*</span>string<span class="main">*</span><span class="main">(</span>string<span class="main">*</span><span class="main">(</span>t<span class="main">)</span>list<span class="main">)</span>list<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">(</span>tvarN<span class="main">)</span>list<span class="main">*</span><span class="main">(</span>t<span class="main">)</span>list<span class="main">*</span>tid_or_exn<span class="main">)</span><span class="main">)</span>namespace "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">build_ctor_tenv</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span> <span class="free"><span class="bound"><span class="entity">tds</span></span></span> <span class="main">=</span> <span class="main">(</span>
  alist_to_ns
    <span class="main">(</span>List.rev
      <span class="main">(</span>List.concat
        <span class="main">(</span>List.map
           <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span><span class="bound">tn</span><span class="main">,</span><span class="bound">ctors</span><span class="main">)</span> <span class="main">=&gt;</span>
  List.map
    <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span>
                        <span class="main">(</span><span class="bound">cn</span><span class="main">,</span><span class="bound">ts</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">cn</span><span class="main">,</span><span class="main">(</span><span class="bound">tvs</span><span class="main">,</span>List.map <span class="main">(</span>type_name_subst <span class="free"><span class="bound"><span class="entity">tenvT</span></span></span><span class="main">)</span>
                                              <span class="bound">ts</span><span class="main">,</span> TypeId <span class="main">(</span>mk_id <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="bound">tn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">)</span><span class="main">)</span> <span class="bound">ctors</span>
  <span class="main">)</span><span class="main">)</span>
           <span class="free"><span class="bound"><span class="entity">tds</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Check that an exception definition defines no already defined (or duplicate)
 * constructors, and that the arguments have no free type variables. ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val check_exn_tenv : list modN -&gt; conN -&gt; list t -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_exn_tenv</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>modN<span class="main">)</span>list <span class="main">⇒</span> string <span class="main">⇒</span><span class="main">(</span>t<span class="main">)</span>list <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">check_exn_tenv</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span>check_freevars<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> For the value restriction on let-based polymorphism ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val is_value : exp -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">,</span>domintros<span class="main">)</span> 
<span class="entity">is_value</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" exp0 <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"
<span class="free">is_value</span> <span class="main">(</span>Lit <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> True <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">is_value</span> <span class="main">(</span>Con <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span><span class="main">.</span>  <span class="free">is_value</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">is_value</span> <span class="main">(</span>Var <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> True <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">is_value</span> <span class="main">(</span>Fun <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> True <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">is_value</span> <span class="main">(</span>Tannot <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="free">is_value</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">is_value</span> <span class="main">(</span>Lannot <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> <span class="free">is_value</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"
<span class="free">is_value</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span> False <span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val tid_exn_to_tc : tid_or_exn -&gt; tctor›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tid_exn_to_tc</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" tid_or_exn <span class="main">⇒</span> tctor "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">tid_exn_to_tc</span> <span class="main">(</span>TypeId <span class="free"><span class="bound"><span class="entity">tid</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> TC_name <span class="free"><span class="bound"><span class="entity">tid</span></span></span> <span class="main">)</span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">tid_exn_to_tc</span> <span class="main">(</span>TypeExn <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span> TC_exn <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">type_ps</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" nat <span class="main">⇒</span> type_env <span class="main">⇒</span><span class="main">(</span>pat<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>t<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>varN<span class="main">*</span>t<span class="main">)</span>list <span class="main">⇒</span> bool "</span></span>  
      <span class="keyword2"><span class="keyword">and</span></span>
<span class="entity">type_p</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" nat <span class="main">⇒</span> type_env <span class="main">⇒</span> pat <span class="main">⇒</span> t <span class="main">⇒</span><span class="main">(</span>varN<span class="main">*</span>t<span class="main">)</span>list <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"pany"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">t0</span><span class="main">.</span>
check_freevars <span class="bound">tvs</span> <span class="main">[]</span> <span class="bound">t0</span>
<span class="main">==&gt;</span>
<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> Pany <span class="bound">t0</span> <span class="main">[]</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"pvar"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">n</span> <span class="bound">t0</span><span class="main">.</span>
check_freevars <span class="bound">tvs</span> <span class="main">[]</span> <span class="bound">t0</span>
<span class="main">==&gt;</span>
<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="main">(</span>Pvar <span class="bound">n</span><span class="main">)</span> <span class="bound">t0</span> <span class="main">[</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">t0</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"plit_int"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">n</span><span class="main">.</span>

<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="main">(</span>Plit <span class="main">(</span>IntLit <span class="bound">n</span><span class="main">)</span><span class="main">)</span> Tint <span class="main">[]</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"plit_char"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">c1</span><span class="main">.</span>

<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="main">(</span>Plit <span class="main">(</span>Char <span class="bound">c1</span><span class="main">)</span><span class="main">)</span> Tchar <span class="main">[]</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"plit_string"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">s</span><span class="main">.</span>

<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="main">(</span>Plit <span class="main">(</span>StrLit <span class="bound">s</span><span class="main">)</span><span class="main">)</span> Tstring <span class="main">[]</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"plit_word8"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">w</span><span class="main">.</span>

<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="main">(</span>Plit <span class="main">(</span>Word8 <span class="bound">w</span><span class="main">)</span><span class="main">)</span> Tword8 <span class="main">[]</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"plit_word64"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">w</span><span class="main">.</span>

<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="main">(</span>Plit <span class="main">(</span>Word64 <span class="bound">w</span><span class="main">)</span><span class="main">)</span> Tword64 <span class="main">[]</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"pcon_some"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">cn</span> <span class="bound">ps</span> <span class="bound">ts</span> <span class="bound">tvs'</span> <span class="bound">tn</span> <span class="bound">ts'</span> <span class="bound">bindings</span><span class="main">.</span>
<span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="bound">ts'</span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span>check_freevars <span class="bound">tvs</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span>List.length <span class="bound">ts'</span> <span class="main">=</span> List.length <span class="bound">tvs'</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="free">type_ps</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">ps</span> <span class="main">(</span>List.map <span class="main">(</span>type_subst <span class="main">(</span>map_of <span class="main">(</span>Lem_list_extra.zipSameLength <span class="bound">tvs'</span> <span class="bound">ts'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">ts</span><span class="main">)</span> <span class="bound">bindings</span> <span class="main">∧</span>
<span class="main">(</span>nsLookup<span class="main">(</span>c0   <span class="bound">tenv</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">tvs'</span><span class="main">,</span> <span class="bound">ts</span><span class="main">,</span> <span class="bound">tn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="main">(</span>Pcon <span class="main">(</span>Some <span class="bound">cn</span><span class="main">)</span> <span class="bound">ps</span><span class="main">)</span> <span class="main">(</span>Tapp <span class="bound">ts'</span> <span class="main">(</span>tid_exn_to_tc <span class="bound">tn</span><span class="main">)</span><span class="main">)</span> <span class="bound">bindings</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"pcon_none"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">ps</span> <span class="bound">ts</span> <span class="bound">bindings</span><span class="main">.</span>
<span class="free">type_ps</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">ps</span> <span class="bound">ts</span> <span class="bound">bindings</span>
<span class="main">==&gt;</span>
<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="main">(</span>Pcon None <span class="bound">ps</span><span class="main">)</span> <span class="main">(</span>Tapp <span class="bound">ts</span> TC_tup<span class="main">)</span> <span class="bound">bindings</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"pref"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">p</span> <span class="bound">t0</span> <span class="bound">bindings</span><span class="main">.</span>
<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">p</span> <span class="bound">t0</span> <span class="bound">bindings</span>
<span class="main">==&gt;</span>
<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="main">(</span>Pref <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>Tref <span class="bound">t0</span><span class="main">)</span> <span class="bound">bindings</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"ptypeannot"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">p</span> <span class="bound">t0</span> <span class="bound">bindings</span><span class="main">.</span>
check_freevars<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="bound">t0</span> <span class="main">∧</span>
<span class="main">(</span>check_type_names<span class="main">(</span>t   <span class="bound">tenv</span><span class="main">)</span> <span class="bound">t0</span> <span class="main">∧</span>
<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">p</span> <span class="main">(</span>type_name_subst<span class="main">(</span>t   <span class="bound">tenv</span><span class="main">)</span> <span class="bound">t0</span><span class="main">)</span> <span class="bound">bindings</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="main">(</span>Ptannot <span class="bound">p</span> <span class="bound">t0</span><span class="main">)</span> <span class="main">(</span>type_name_subst<span class="main">(</span>t   <span class="bound">tenv</span><span class="main">)</span> <span class="bound">t0</span><span class="main">)</span> <span class="bound">bindings</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"empty"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tvs</span> <span class="bound">tenv</span><span class="main">.</span>

<span class="free">type_ps</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">p</span> <span class="bound">ps</span> <span class="bound">t0</span> <span class="bound">ts</span> <span class="bound">bindings</span> <span class="bound">bindings'</span><span class="main">.</span>
<span class="free">type_p</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">p</span> <span class="bound">t0</span> <span class="bound">bindings</span> <span class="main">∧</span>
<span class="free">type_ps</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">ps</span> <span class="bound">ts</span> <span class="bound">bindings'</span>
<span class="main">==&gt;</span>
<span class="free">type_ps</span> <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">ps</span><span class="main">)</span> <span class="main">(</span><span class="bound">t0</span> <span class="main">#</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">(</span><span class="bound">bindings'</span><span class="main">@</span><span class="bound">bindings</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">type_funs</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" type_env <span class="main">⇒</span> tenv_val_exp <span class="main">⇒</span><span class="main">(</span>varN<span class="main">*</span>varN<span class="main">*</span>exp0<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>varN<span class="main">*</span>t<span class="main">)</span>list <span class="main">⇒</span> bool "</span></span>  
      <span class="keyword2"><span class="keyword">and</span></span>
<span class="entity">type_es</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" type_env <span class="main">⇒</span> tenv_val_exp <span class="main">⇒</span><span class="main">(</span>exp0<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>t<span class="main">)</span>list <span class="main">⇒</span> bool "</span></span>  
      <span class="keyword2"><span class="keyword">and</span></span>
<span class="entity">type_e</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" type_env <span class="main">⇒</span> tenv_val_exp <span class="main">⇒</span> exp0 <span class="main">⇒</span> t <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"lit_int"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">n</span><span class="main">.</span>

<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Lit <span class="main">(</span>IntLit <span class="bound">n</span><span class="main">)</span><span class="main">)</span> Tint "</span></span>

<span class="main">|</span>

<span class="quoted">"lit_char"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">c1</span><span class="main">.</span>

<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Lit <span class="main">(</span>Char <span class="bound">c1</span><span class="main">)</span><span class="main">)</span> Tchar "</span></span>

<span class="main">|</span>

<span class="quoted">"lit_string"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">s</span><span class="main">.</span>

<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Lit <span class="main">(</span>StrLit <span class="bound">s</span><span class="main">)</span><span class="main">)</span> Tstring "</span></span>

<span class="main">|</span>

<span class="quoted">"lit_word8"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">w</span><span class="main">.</span>

<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Lit <span class="main">(</span>Word8 <span class="bound">w</span><span class="main">)</span><span class="main">)</span> Tword8 "</span></span>

<span class="main">|</span>

<span class="quoted">"lit_word64"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">w</span><span class="main">.</span>

<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Lit <span class="main">(</span>Word64 <span class="bound">w</span><span class="main">)</span><span class="main">)</span> Tword64 "</span></span>

<span class="main">|</span>

<span class="quoted">"raise"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e</span> <span class="bound">t0</span><span class="main">.</span>
check_freevars <span class="main">(</span>num_tvs <span class="bound">tenvE</span><span class="main">)</span> <span class="main">[]</span> <span class="bound">t0</span> <span class="main">∧</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e</span> Texn
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Raise <span class="bound">e</span><span class="main">)</span> <span class="bound">t0</span> "</span></span>


<span class="main">|</span>

<span class="quoted">"handle"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">t0</span><span class="main">.</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e</span> <span class="bound">t0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="bound">pes</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">∈</span>  
  List.set <span class="bound">pes</span><span class="main">.</span> <span class="main">(</span> <span class="main">∃</span> <span class="bound">bindings</span><span class="main">.</span> 
   Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span>type_p <span class="main">(</span>num_tvs <span class="bound">tenvE</span><span class="main">)</span> <span class="bound">tenv</span> <span class="bound">p</span> Texn <span class="bound">bindings</span> <span class="main">∧</span>
   <span class="free">type_e</span> <span class="bound">tenv</span> <span class="main">(</span>bind_var_list<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">bindings</span> <span class="bound">tenvE</span><span class="main">)</span> <span class="bound">e</span> <span class="bound">t0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Handle <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="bound">t0</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"con_some"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">cn</span> <span class="bound">es</span> <span class="bound">tvs</span> <span class="bound">tn</span> <span class="bound">ts'</span> <span class="bound">ts</span><span class="main">.</span>
<span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="bound">ts'</span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span>check_freevars <span class="main">(</span>num_tvs <span class="bound">tenvE</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span>List.length <span class="bound">tvs</span> <span class="main">=</span> List.length <span class="bound">ts'</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="free">type_es</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">es</span> <span class="main">(</span>List.map <span class="main">(</span>type_subst <span class="main">(</span>map_of <span class="main">(</span>Lem_list_extra.zipSameLength <span class="bound">tvs</span> <span class="bound">ts'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>nsLookup<span class="main">(</span>c0   <span class="bound">tenv</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span> <span class="bound">ts</span><span class="main">,</span> <span class="bound">tn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Con <span class="main">(</span>Some <span class="bound">cn</span><span class="main">)</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span>Tapp <span class="bound">ts'</span> <span class="main">(</span>tid_exn_to_tc <span class="bound">tn</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"con_none"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">es</span> <span class="bound">ts</span><span class="main">.</span>
<span class="free">type_es</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">es</span> <span class="bound">ts</span>
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Con None <span class="bound">es</span><span class="main">)</span> <span class="main">(</span>Tapp <span class="bound">ts</span> TC_tup<span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"var"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">n</span> <span class="bound">t0</span> <span class="bound">targs</span> <span class="bound">tvs</span><span class="main">.</span>
<span class="main">(</span><span class="bound">tvs</span> <span class="main">=</span> List.length <span class="bound">targs</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="bound">targs</span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span>check_freevars <span class="main">(</span>num_tvs <span class="bound">tenvE</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>lookup_var <span class="bound">n</span> <span class="bound">tenvE</span> <span class="bound">tenv</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span><span class="bound">t0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Var <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>deBruijn_subst<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">targs</span> <span class="bound">t0</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"fn"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">n</span> <span class="bound">e</span> <span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span>
check_freevars <span class="main">(</span>num_tvs <span class="bound">tenvE</span><span class="main">)</span> <span class="main">[]</span> <span class="bound">t1</span> <span class="main">∧</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="main">(</span>Bind_name <span class="bound">n</span><span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">t1</span> <span class="bound">tenvE</span><span class="main">)</span> <span class="bound">e</span> <span class="bound">t2</span>
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Fun <span class="bound">n</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>Tfn <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">op0</span> <span class="bound">es</span> <span class="bound">ts</span> <span class="bound">t0</span><span class="main">.</span>
<span class="free">type_es</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">es</span> <span class="bound">ts</span> <span class="main">∧</span>
<span class="main">(</span>type_op <span class="bound">op0</span> <span class="bound">ts</span> <span class="bound">t0</span> <span class="main">∧</span>
check_freevars <span class="main">(</span>num_tvs <span class="bound">tenvE</span><span class="main">)</span> <span class="main">[]</span> <span class="bound">t0</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>App <span class="bound">op0</span> <span class="bound">es</span><span class="main">)</span> <span class="bound">t0</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"log"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">l</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">.</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e1</span> <span class="main">(</span>Tapp <span class="main">[]</span> <span class="main">(</span>TC_name <span class="main">(</span>Short <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e2</span> <span class="main">(</span>Tapp <span class="main">[]</span> <span class="main">(</span>TC_name <span class="main">(</span>Short <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Log <span class="bound">l</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">(</span>Tapp <span class="main">[]</span> <span class="main">(</span>TC_name <span class="main">(</span>Short <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"if'"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="bound">t0</span><span class="main">.</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e1</span> <span class="main">(</span>Tapp <span class="main">[]</span> <span class="main">(</span>TC_name <span class="main">(</span>Short <span class="main">(</span><span class="inner_quoted">''bool''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e2</span> <span class="bound">t0</span> <span class="main">∧</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e3</span> <span class="bound">t0</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>If <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span><span class="main">)</span> <span class="bound">t0</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"mat"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e</span> <span class="bound">t1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="bound">pes</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span> <span class="main">∈</span>  
  List.set <span class="bound">pes</span><span class="main">.</span>  <span class="main">(</span> <span class="main">∃</span> <span class="bound">bindings</span><span class="main">.</span> 
   Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span>type_p <span class="main">(</span>num_tvs <span class="bound">tenvE</span><span class="main">)</span> <span class="bound">tenv</span> <span class="bound">p</span> <span class="bound">t1</span> <span class="bound">bindings</span> <span class="main">∧</span>
   <span class="free">type_e</span> <span class="bound">tenv</span> <span class="main">(</span>bind_var_list<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">bindings</span> <span class="bound">tenvE</span><span class="main">)</span> <span class="bound">e</span> <span class="bound">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Mat <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="bound">t2</span> "</span></span>

<span class="main">|</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>
let_poly : forall tenv tenvE n e1 e2 t1 t2 tvs.
is_value e1 &amp;&amp;
type_e tenv (bind_tvar tvs tenvE) e1 t1 &amp;&amp;
type_e tenv (opt_bind_name n tvs t1 tenvE) e2 t2
==&gt;
type_e tenv tenvE (Let n e1 e2) t2

and
›</span></span>›</span>

<span class="quoted">"let_mono"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">n</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e1</span> <span class="bound">t1</span> <span class="main">∧</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="main">(</span>opt_bind_name <span class="bound">n</span><span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">t1</span> <span class="bound">tenvE</span><span class="main">)</span> <span class="bound">e2</span> <span class="bound">t2</span>
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Let <span class="bound">n</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="bound">t2</span> "</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>
and

letrec : forall tenv tenvE funs e t tenv' tvs.
type_funs tenv (bind_var_list 0 tenv' (bind_tvar tvs tenvE)) funs tenv' &amp;&amp;
type_e tenv (bind_var_list tvs tenv' tenvE) e t
==&gt;
type_e tenv tenvE (Letrec funs e) t
›</span></span>›</span>

<span class="main">|</span>

<span class="quoted">"letrec"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">funs</span> <span class="bound">e</span> <span class="bound">t0</span> <span class="bound">bindings</span><span class="main">.</span>
<span class="free">type_funs</span> <span class="bound">tenv</span> <span class="main">(</span>bind_var_list<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">bindings</span> <span class="bound">tenvE</span><span class="main">)</span> <span class="bound">funs</span> <span class="bound">bindings</span> <span class="main">∧</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="main">(</span>bind_var_list<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">bindings</span> <span class="bound">tenvE</span><span class="main">)</span> <span class="bound">e</span> <span class="bound">t0</span>
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Letrec <span class="bound">funs</span> <span class="bound">e</span><span class="main">)</span> <span class="bound">t0</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"typeannot"</span><span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e</span> <span class="bound">t0</span><span class="main">.</span>
check_freevars<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="bound">t0</span> <span class="main">∧</span>
<span class="main">(</span>check_type_names<span class="main">(</span>t   <span class="bound">tenv</span><span class="main">)</span> <span class="bound">t0</span> <span class="main">∧</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e</span> <span class="main">(</span>type_name_subst<span class="main">(</span>t   <span class="bound">tenv</span><span class="main">)</span> <span class="bound">t0</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Tannot <span class="bound">e</span> <span class="bound">t0</span><span class="main">)</span> <span class="main">(</span>type_name_subst<span class="main">(</span>t   <span class="bound">tenv</span><span class="main">)</span> <span class="bound">t0</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"locannot"</span><span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e</span> <span class="bound">l</span> <span class="bound">t0</span><span class="main">.</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e</span> <span class="bound">t0</span>
<span class="main">==&gt;</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span>Lannot <span class="bound">e</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">t0</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"empty"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span><span class="main">.</span>

<span class="free">type_es</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e</span> <span class="bound">es</span> <span class="bound">t0</span> <span class="bound">ts</span><span class="main">.</span>
<span class="free">type_e</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">e</span> <span class="bound">t0</span> <span class="main">∧</span>
<span class="free">type_es</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">es</span> <span class="bound">ts</span>
<span class="main">==&gt;</span>
<span class="free">type_es</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span><span class="bound">e</span> <span class="main">#</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">t0</span> <span class="main">#</span> <span class="bound">ts</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"no_funs"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span><span class="main">.</span>

<span class="free">type_funs</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"funs"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">fn</span> <span class="bound">n</span> <span class="bound">e</span> <span class="bound">funs</span> <span class="bound">bindings</span> <span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span>
check_freevars <span class="main">(</span>num_tvs <span class="bound">tenvE</span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span>Tfn <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="free">type_e</span> <span class="bound">tenv</span> <span class="main">(</span>Bind_name <span class="bound">n</span><span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">t1</span> <span class="bound">tenvE</span><span class="main">)</span> <span class="bound">e</span> <span class="bound">t2</span> <span class="main">∧</span>
<span class="main">(</span><span class="free">type_funs</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="bound">funs</span> <span class="bound">bindings</span> <span class="main">∧</span>
<span class="main">(</span>Map.map_of <span class="bound">bindings</span> <span class="bound">fn</span> <span class="main">=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_funs</span> <span class="bound">tenv</span> <span class="bound">tenvE</span> <span class="main">(</span><span class="main">(</span><span class="bound">fn</span><span class="main">,</span> <span class="bound">n</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">#</span> <span class="bound">funs</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">fn</span><span class="main">,</span> Tfn <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span><span class="main">#</span> <span class="bound">bindings</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val tenv_add_tvs : nat -&gt; alist varN t -&gt; alist varN (nat * t)›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tenv_add_tvs</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" nat <span class="main">⇒</span><span class="main">(</span>string<span class="main">*</span>t<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span>string<span class="main">*</span><span class="main">(</span>nat<span class="main">*</span>t<span class="main">)</span><span class="main">)</span>list "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">tenv_add_tvs</span> <span class="free"><span class="bound"><span class="entity">tvs</span></span></span> <span class="free"><span class="bound"><span class="entity">bindings</span></span></span> <span class="main">=</span> <span class="main">(</span>
  List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">t1</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">tvs</span></span></span><span class="main">,</span><span class="bound">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bindings</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val type_pe_determ : type_env -&gt; tenv_val_exp -&gt; pat -&gt; exp -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">type_pe_determ</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" type_env <span class="main">⇒</span> tenv_val_exp <span class="main">⇒</span> pat <span class="main">⇒</span> exp0 <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">type_pe_determ</span> <span class="free"><span class="bound"><span class="entity">tenv</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>
  <span class="main">∀</span> <span class="bound">t1</span><span class="main">.</span> 
  <span class="main">∀</span> <span class="bound">tenv1</span><span class="main">.</span> 
  <span class="main">∀</span> <span class="bound">t2</span><span class="main">.</span> 
  <span class="main">∀</span> <span class="bound">tenv2</span><span class="main">.</span> 
    <span class="main">(</span>type_p<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tenv</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">t1</span> <span class="bound">tenv1</span> <span class="main">∧</span> <span class="main">(</span>type_e <span class="free"><span class="bound"><span class="entity">tenv</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">t1</span> <span class="main">∧</span>
    <span class="main">(</span>type_p<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tenv</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">t2</span> <span class="bound">tenv2</span> <span class="main">∧</span> type_e <span class="free"><span class="bound"><span class="entity">tenv</span></span></span> <span class="free"><span class="bound"><span class="entity">tenvE</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">tenv1</span> <span class="main">=</span> <span class="bound">tenv2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val tscheme_inst : (nat * t) -&gt; (nat * t) -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tscheme_inst</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" nat<span class="main">*</span>t <span class="main">⇒</span> nat<span class="main">*</span>t <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">tscheme_inst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tvs_spec</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t_spec</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tvs_impl</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t_impl</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>
  <span class="main">∃</span> <span class="bound">subst</span><span class="main">.</span> 
    <span class="main">(</span>List.length <span class="bound">subst</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tvs_impl</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>check_freevars <span class="free"><span class="bound"><span class="entity">tvs_impl</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">t_impl</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="bound">subst</span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span>check_freevars <span class="free"><span class="bound"><span class="entity">tvs_spec</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>deBruijn_subst<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">subst</span> <span class="free"><span class="bound"><span class="entity">t_impl</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t_spec</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">type_d</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" bool <span class="main">⇒</span><span class="main">(</span>modN<span class="main">)</span>list <span class="main">⇒</span> decls <span class="main">⇒</span> type_env <span class="main">⇒</span> dec <span class="main">⇒</span> decls <span class="main">⇒</span> type_env <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"dlet_poly"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">extra_checks</span> <span class="bound">tvs</span> <span class="bound">mn</span> <span class="bound">tenv</span> <span class="bound">p</span> <span class="bound">e</span> <span class="bound">t0</span> <span class="bound">bindings</span> <span class="bound">decls</span> <span class="bound">locs</span><span class="main">.</span>
is_value <span class="bound">e</span> <span class="main">∧</span>
<span class="main">(</span>Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>type_p <span class="bound">tvs</span> <span class="bound">tenv</span> <span class="bound">p</span> <span class="bound">t0</span> <span class="bound">bindings</span> <span class="main">∧</span>
<span class="main">(</span>type_e <span class="bound">tenv</span> <span class="main">(</span>bind_tvar <span class="bound">tvs</span> Empty<span class="main">)</span> <span class="bound">e</span> <span class="bound">t0</span> <span class="main">∧</span>
<span class="main">(</span><span class="bound">extra_checks</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">tvs'</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">bindings'</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">t'</span><span class="main">.</span> 
    <span class="main">(</span>type_p <span class="bound">tvs'</span> <span class="bound">tenv</span> <span class="bound">p</span> <span class="bound">t'</span> <span class="bound">bindings'</span> <span class="main">∧</span>
    type_e <span class="bound">tenv</span> <span class="main">(</span>bind_tvar <span class="bound">tvs'</span> Empty<span class="main">)</span> <span class="bound">e</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">⟶</span>
      list_all2 tscheme_inst <span class="main">(</span>List.map snd <span class="main">(</span>tenv_add_tvs <span class="bound">tvs'</span> <span class="bound">bindings'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>List.map snd <span class="main">(</span>tenv_add_tvs <span class="bound">tvs</span> <span class="bound">bindings</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_d</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">(</span>Dlet <span class="bound">locs</span> <span class="bound">p</span> <span class="bound">e</span><span class="main">)</span>
  empty_decls <span class="main">(|</span> v0 <span class="main">=</span> <span class="main">(</span>alist_to_ns <span class="main">(</span>tenv_add_tvs <span class="bound">tvs</span> <span class="bound">bindings</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> c0 <span class="main">=</span> nsEmpty<span class="main">,</span> t <span class="main">=</span> nsEmpty <span class="main">|)</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"dlet_mono"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">tenv</span> <span class="bound">p</span> <span class="bound">e</span> <span class="bound">t0</span> <span class="bound">bindings</span> <span class="bound">decls</span> <span class="bound">locs</span><span class="main">.</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> The following line makes sure that when the value restriction prohibits
   generalisation, a type error is given rather than picking an arbitrary
   instantiation. However, we should only do the check when the extra_checks
   argument tells us to. ›</span></span>›</span>
<span class="main">(</span><span class="bound">extra_checks</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span>is_value <span class="bound">e</span><span class="main">)</span> <span class="main">∧</span> type_pe_determ <span class="bound">tenv</span> Empty <span class="bound">p</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>type_p<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">tenv</span> <span class="bound">p</span> <span class="bound">t0</span> <span class="bound">bindings</span> <span class="main">∧</span>
type_e <span class="bound">tenv</span> Empty <span class="bound">e</span> <span class="bound">t0</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_d</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">(</span>Dlet <span class="bound">locs</span> <span class="bound">p</span> <span class="bound">e</span><span class="main">)</span>
  empty_decls <span class="main">(|</span> v0 <span class="main">=</span> <span class="main">(</span>alist_to_ns <span class="main">(</span>tenv_add_tvs<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">bindings</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> c0 <span class="main">=</span> nsEmpty<span class="main">,</span> t <span class="main">=</span> nsEmpty <span class="main">|)</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"dletrec"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">tenv</span> <span class="bound">funs</span> <span class="bound">bindings</span> <span class="bound">tvs</span> <span class="bound">decls</span> <span class="bound">locs</span><span class="main">.</span>
type_funs <span class="bound">tenv</span> <span class="main">(</span>bind_var_list<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">bindings</span> <span class="main">(</span>bind_tvar <span class="bound">tvs</span> Empty<span class="main">)</span><span class="main">)</span> <span class="bound">funs</span> <span class="bound">bindings</span> <span class="main">∧</span>
<span class="main">(</span><span class="bound">extra_checks</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">tvs'</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">bindings'</span><span class="main">.</span> 
    type_funs <span class="bound">tenv</span> <span class="main">(</span>bind_var_list<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">bindings'</span> <span class="main">(</span>bind_tvar <span class="bound">tvs'</span> Empty<span class="main">)</span><span class="main">)</span> <span class="bound">funs</span> <span class="bound">bindings'</span> <span class="main">⟶</span>
      list_all2 tscheme_inst <span class="main">(</span>List.map snd <span class="main">(</span>tenv_add_tvs <span class="bound">tvs'</span> <span class="bound">bindings'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>List.map snd <span class="main">(</span>tenv_add_tvs <span class="bound">tvs</span> <span class="bound">bindings</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_d</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">(</span>Dletrec <span class="bound">locs</span> <span class="bound">funs</span><span class="main">)</span>
  empty_decls <span class="main">(|</span> v0 <span class="main">=</span> <span class="main">(</span>alist_to_ns <span class="main">(</span>tenv_add_tvs <span class="bound">tvs</span> <span class="bound">bindings</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> c0 <span class="main">=</span> nsEmpty<span class="main">,</span> t <span class="main">=</span> nsEmpty <span class="main">|)</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"dtype"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">tenv</span> <span class="bound">tdefs</span> <span class="bound">decls</span> <span class="bound">defined_types'</span> <span class="bound">decls'</span> <span class="bound">tenvT</span> <span class="bound">locs</span><span class="main">.</span>
check_ctor_tenv <span class="main">(</span>nsAppend <span class="bound">tenvT</span><span class="main">(</span>t   <span class="bound">tenv</span><span class="main">)</span><span class="main">)</span> <span class="bound">tdefs</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span><span class="bound">defined_types'</span> <span class="main">=</span> List.set <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span><span class="bound">tn</span><span class="main">,</span><span class="bound">ctors</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>mk_id <span class="bound">mn</span> <span class="bound">tn</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span> <span class="bound">tdefs</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>disjnt <span class="bound">defined_types'</span><span class="main">(</span>defined_types0   <span class="bound">decls</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span><span class="bound">tenvT</span> <span class="main">=</span> alist_to_ns <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span><span class="bound">tn</span><span class="main">,</span><span class="bound">ctors</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">tn</span><span class="main">,</span> <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span> Tapp <span class="main">(</span>List.map Tvar <span class="bound">tvs</span><span class="main">)</span>
                                     <span class="main">(</span>TC_name <span class="main">(</span>mk_id <span class="bound">mn</span> <span class="bound">tn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span> <span class="bound">tdefs</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="bound">decls'</span> <span class="main">=</span> <span class="main">(|</span> defined_mods0 <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">,</span> defined_types0 <span class="main">=</span> <span class="bound">defined_types'</span><span class="main">,</span> defined_exns <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_d</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">(</span>Dtype <span class="bound">locs</span> <span class="bound">tdefs</span><span class="main">)</span>
  <span class="bound">decls'</span> <span class="main">(|</span> v0 <span class="main">=</span> nsEmpty<span class="main">,</span> c0 <span class="main">=</span> <span class="main">(</span>build_ctor_tenv <span class="bound">mn</span> <span class="main">(</span>nsAppend <span class="bound">tenvT</span><span class="main">(</span>t   <span class="bound">tenv</span><span class="main">)</span><span class="main">)</span> <span class="bound">tdefs</span><span class="main">)</span><span class="main">,</span> t <span class="main">=</span> <span class="bound">tenvT</span> <span class="main">|)</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"dtabbrev"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="bound">tvs</span> <span class="bound">tn</span> <span class="bound">t0</span> <span class="bound">locs</span><span class="main">.</span>
check_freevars<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">tvs</span> <span class="bound">t0</span> <span class="main">∧</span>
<span class="main">(</span>check_type_names<span class="main">(</span>t   <span class="bound">tenv</span><span class="main">)</span> <span class="bound">t0</span> <span class="main">∧</span>
Lem_list.allDistinct <span class="bound">tvs</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_d</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">(</span>Dtabbrev <span class="bound">locs</span> <span class="bound">tvs</span> <span class="bound">tn</span> <span class="bound">t0</span><span class="main">)</span>
  empty_decls <span class="main">(|</span> v0 <span class="main">=</span> nsEmpty<span class="main">,</span> c0 <span class="main">=</span> nsEmpty<span class="main">,</span>
                 t <span class="main">=</span> <span class="main">(</span>nsSing <span class="bound">tn</span> <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span>type_name_subst<span class="main">(</span>t   <span class="bound">tenv</span><span class="main">)</span> <span class="bound">t0</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"dexn"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">tenv</span> <span class="bound">cn</span> <span class="bound">ts</span> <span class="bound">decls</span> <span class="bound">decls'</span> <span class="bound">locs</span><span class="main">.</span>
check_exn_tenv <span class="bound">mn</span> <span class="bound">cn</span> <span class="bound">ts</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">¬</span> <span class="main">(</span>mk_id <span class="bound">mn</span> <span class="bound">cn</span> <span class="main">∈</span><span class="main">(</span>defined_exns   <span class="bound">decls</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="bound">ts</span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span>check_type_names<span class="main">(</span>t   <span class="bound">tenv</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span><span class="bound">decls'</span> <span class="main">=</span> <span class="main">(|</span> defined_mods0 <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">,</span> defined_types0 <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">,</span> defined_exns <span class="main">=</span> <span class="main">(</span><span class="main">{</span>mk_id <span class="bound">mn</span> <span class="bound">cn</span><span class="main">}</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_d</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">(</span>Dexn <span class="bound">locs</span> <span class="bound">cn</span> <span class="bound">ts</span><span class="main">)</span>
  <span class="bound">decls'</span> <span class="main">(|</span> v0 <span class="main">=</span> nsEmpty<span class="main">,</span>
            c0 <span class="main">=</span> <span class="main">(</span>nsSing <span class="bound">cn</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> List.map <span class="main">(</span>type_name_subst<span class="main">(</span>t   <span class="bound">tenv</span><span class="main">)</span><span class="main">)</span> <span class="bound">ts</span><span class="main">,</span> TypeExn <span class="main">(</span>mk_id <span class="bound">mn</span> <span class="bound">cn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
            t <span class="main">=</span> nsEmpty <span class="main">|)</span> "</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">type_ds</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" bool <span class="main">⇒</span><span class="main">(</span>modN<span class="main">)</span>list <span class="main">⇒</span> decls <span class="main">⇒</span> type_env <span class="main">⇒</span><span class="main">(</span>dec<span class="main">)</span>list <span class="main">⇒</span> decls <span class="main">⇒</span> type_env <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"empty"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">tenv</span> <span class="bound">decls</span><span class="main">.</span>

<span class="free">type_ds</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">[]</span>
  empty_decls <span class="main">(|</span> v0 <span class="main">=</span> nsEmpty<span class="main">,</span> c0 <span class="main">=</span> nsEmpty<span class="main">,</span> t <span class="main">=</span> nsEmpty <span class="main">|)</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"cons"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">tenv</span> <span class="bound">d</span> <span class="bound">ds</span> <span class="bound">tenv1</span> <span class="bound">tenv2</span> <span class="bound">decls</span> <span class="bound">decls1</span> <span class="bound">decls2</span><span class="main">.</span>
type_d <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="bound">d</span> <span class="bound">decls1</span> <span class="bound">tenv1</span> <span class="main">∧</span>
<span class="free">type_ds</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="main">(</span>union_decls <span class="bound">decls1</span> <span class="bound">decls</span><span class="main">)</span> <span class="main">(</span>extend_dec_tenv <span class="bound">tenv1</span> <span class="bound">tenv</span><span class="main">)</span> <span class="bound">ds</span> <span class="bound">decls2</span> <span class="bound">tenv2</span>
<span class="main">==&gt;</span>
<span class="free">type_ds</span> <span class="bound">extra_checks</span> <span class="bound">mn</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">(</span><span class="bound">d</span> <span class="main">#</span> <span class="bound">ds</span><span class="main">)</span>
  <span class="main">(</span>union_decls <span class="bound">decls2</span> <span class="bound">decls1</span><span class="main">)</span> <span class="main">(</span>extend_dec_tenv <span class="bound">tenv2</span> <span class="bound">tenv1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">type_specs</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>modN<span class="main">)</span>list <span class="main">⇒</span> tenv_abbrev <span class="main">⇒</span> specs <span class="main">⇒</span> decls <span class="main">⇒</span> type_env <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"empty"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">mn</span> <span class="bound">tenvT</span><span class="main">.</span>

<span class="free">type_specs</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="main">[]</span>
  empty_decls <span class="main">(|</span> v0 <span class="main">=</span> nsEmpty<span class="main">,</span> c0 <span class="main">=</span> nsEmpty<span class="main">,</span> t <span class="main">=</span> nsEmpty <span class="main">|)</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"sval"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="bound">x</span> <span class="bound">t0</span> <span class="bound">specs</span> <span class="bound">tenv</span> <span class="bound">fvs</span> <span class="bound">decls</span> <span class="bound">subst</span><span class="main">.</span>
check_freevars<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">fvs</span> <span class="bound">t0</span> <span class="main">∧</span>
<span class="main">(</span>check_type_names <span class="bound">tenvT</span> <span class="bound">t0</span> <span class="main">∧</span>
<span class="main">(</span><span class="free">type_specs</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="bound">specs</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">∧</span>
<span class="main">(</span><span class="bound">subst</span> <span class="main">=</span> map_of <span class="main">(</span>Lem_list_extra.zipSameLength <span class="bound">fvs</span> <span class="main">(</span>List.map Tvar_db <span class="main">(</span>genlist <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span>  <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>List.length <span class="bound">fvs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_specs</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="main">(</span>Sval <span class="bound">x</span> <span class="bound">t0</span> <span class="main">#</span> <span class="bound">specs</span><span class="main">)</span>
  <span class="bound">decls</span>
  <span class="main">(</span>extend_dec_tenv <span class="bound">tenv</span>
    <span class="main">(|</span> v0 <span class="main">=</span> <span class="main">(</span>nsSing <span class="bound">x</span> <span class="main">(</span>List.length <span class="bound">fvs</span><span class="main">,</span> type_subst <span class="bound">subst</span> <span class="main">(</span>type_name_subst <span class="bound">tenvT</span> <span class="bound">t0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       c0 <span class="main">=</span> nsEmpty<span class="main">,</span>
       t <span class="main">=</span> nsEmpty <span class="main">|)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"stype"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="bound">tenv</span> <span class="bound">td</span> <span class="bound">specs</span> <span class="bound">decls'</span> <span class="bound">decls</span> <span class="bound">tenvT'</span><span class="main">.</span>
<span class="main">(</span><span class="bound">tenvT'</span> <span class="main">=</span> alist_to_ns <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span><span class="bound">tn</span><span class="main">,</span><span class="bound">ctors</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="bound">tn</span><span class="main">,</span> <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span> Tapp <span class="main">(</span>List.map Tvar <span class="bound">tvs</span><span class="main">)</span>
                                     <span class="main">(</span>TC_name <span class="main">(</span>mk_id <span class="bound">mn</span> <span class="bound">tn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span> <span class="bound">td</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>check_ctor_tenv <span class="main">(</span>nsAppend <span class="bound">tenvT'</span> <span class="bound">tenvT</span><span class="main">)</span> <span class="bound">td</span> <span class="main">∧</span>
<span class="main">(</span><span class="free">type_specs</span> <span class="bound">mn</span> <span class="main">(</span>nsAppend <span class="bound">tenvT'</span> <span class="bound">tenvT</span><span class="main">)</span> <span class="bound">specs</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">∧</span>
<span class="main">(</span><span class="bound">decls'</span> <span class="main">=</span> <span class="main">(|</span> defined_mods0 <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">,</span>
            defined_types0 <span class="main">=</span> <span class="main">(</span>List.set <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span><span class="bound">tn</span><span class="main">,</span><span class="bound">ctors</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>mk_id <span class="bound">mn</span> <span class="bound">tn</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span> <span class="bound">td</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
            defined_exns <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_specs</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="main">(</span>Stype <span class="bound">td</span> <span class="main">#</span> <span class="bound">specs</span><span class="main">)</span>
  <span class="main">(</span>union_decls <span class="bound">decls</span> <span class="bound">decls'</span><span class="main">)</span>
  <span class="main">(</span>extend_dec_tenv <span class="bound">tenv</span>
   <span class="main">(|</span> v0 <span class="main">=</span> nsEmpty<span class="main">,</span>
      c0 <span class="main">=</span> <span class="main">(</span>build_ctor_tenv <span class="bound">mn</span> <span class="main">(</span>nsAppend <span class="bound">tenvT'</span> <span class="bound">tenvT</span><span class="main">)</span> <span class="bound">td</span><span class="main">)</span><span class="main">,</span>
      t <span class="main">=</span> <span class="bound">tenvT'</span> <span class="main">|)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"stabbrev"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="bound">tenvT'</span> <span class="bound">tvs</span> <span class="bound">tn</span> <span class="bound">t0</span> <span class="bound">specs</span> <span class="bound">decls</span> <span class="bound">tenv</span><span class="main">.</span>
Lem_list.allDistinct <span class="bound">tvs</span> <span class="main">∧</span>
<span class="main">(</span>check_freevars<span class="main">(</span><span class="main">(</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="bound">tvs</span> <span class="bound">t0</span> <span class="main">∧</span>
<span class="main">(</span>check_type_names <span class="bound">tenvT</span> <span class="bound">t0</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span><span class="bound">tenvT'</span> <span class="main">=</span> nsSing <span class="bound">tn</span> <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span>type_name_subst <span class="bound">tenvT</span> <span class="bound">t0</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">type_specs</span> <span class="bound">mn</span> <span class="main">(</span>nsAppend <span class="bound">tenvT'</span> <span class="bound">tenvT</span><span class="main">)</span> <span class="bound">specs</span> <span class="bound">decls</span> <span class="bound">tenv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_specs</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="main">(</span>Stabbrev <span class="bound">tvs</span> <span class="bound">tn</span> <span class="bound">t0</span> <span class="main">#</span> <span class="bound">specs</span><span class="main">)</span>
  <span class="bound">decls</span> <span class="main">(</span>extend_dec_tenv <span class="bound">tenv</span> <span class="main">(|</span> v0 <span class="main">=</span> nsEmpty<span class="main">,</span> c0 <span class="main">=</span> nsEmpty<span class="main">,</span> t <span class="main">=</span> <span class="bound">tenvT'</span> <span class="main">|)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"sexn"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="bound">tenv</span> <span class="bound">cn</span> <span class="bound">ts</span> <span class="bound">specs</span> <span class="bound">decls</span><span class="main">.</span>
check_exn_tenv <span class="bound">mn</span> <span class="bound">cn</span> <span class="bound">ts</span> <span class="main">∧</span>
<span class="main">(</span><span class="free">type_specs</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="bound">specs</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="bound">ts</span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span>check_type_names <span class="bound">tenvT</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_specs</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="main">(</span>Sexn <span class="bound">cn</span> <span class="bound">ts</span> <span class="main">#</span> <span class="bound">specs</span><span class="main">)</span>
  <span class="main">(</span>union_decls <span class="bound">decls</span> <span class="main">(|</span> defined_mods0 <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">,</span> defined_types0 <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">,</span> defined_exns <span class="main">=</span> <span class="main">(</span><span class="main">{</span>mk_id <span class="bound">mn</span> <span class="bound">cn</span><span class="main">}</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span>
  <span class="main">(</span>extend_dec_tenv <span class="bound">tenv</span>
   <span class="main">(|</span> v0 <span class="main">=</span> nsEmpty<span class="main">,</span>
      c0 <span class="main">=</span> <span class="main">(</span>nsSing <span class="bound">cn</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> List.map <span class="main">(</span>type_name_subst <span class="bound">tenvT</span><span class="main">)</span> <span class="bound">ts</span><span class="main">,</span> TypeExn <span class="main">(</span>mk_id <span class="bound">mn</span> <span class="bound">cn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      t <span class="main">=</span> nsEmpty <span class="main">|)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"stype_opq"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="bound">tenv</span> <span class="bound">tn</span> <span class="bound">specs</span> <span class="bound">tvs</span> <span class="bound">decls</span> <span class="bound">tenvT'</span><span class="main">.</span>
Lem_list.allDistinct <span class="bound">tvs</span> <span class="main">∧</span>
<span class="main">(</span><span class="main">(</span><span class="bound">tenvT'</span> <span class="main">=</span> nsSing <span class="bound">tn</span> <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span> Tapp <span class="main">(</span>List.map Tvar <span class="bound">tvs</span><span class="main">)</span> <span class="main">(</span>TC_name <span class="main">(</span>mk_id <span class="bound">mn</span> <span class="bound">tn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="free">type_specs</span> <span class="bound">mn</span> <span class="main">(</span>nsAppend <span class="bound">tenvT'</span> <span class="bound">tenvT</span><span class="main">)</span> <span class="bound">specs</span> <span class="bound">decls</span> <span class="bound">tenv</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_specs</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="main">(</span>Stype_opq <span class="bound">tvs</span> <span class="bound">tn</span> <span class="main">#</span> <span class="bound">specs</span><span class="main">)</span>
  <span class="main">(</span>union_decls <span class="bound">decls</span> <span class="main">(|</span> defined_mods0 <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">,</span> defined_types0 <span class="main">=</span> <span class="main">(</span><span class="main">{</span>mk_id <span class="bound">mn</span> <span class="bound">tn</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> defined_exns <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span>
  <span class="main">(</span>extend_dec_tenv <span class="bound">tenv</span> <span class="main">(|</span> v0 <span class="main">=</span> nsEmpty<span class="main">,</span> c0 <span class="main">=</span> nsEmpty<span class="main">,</span> t <span class="main">=</span> <span class="bound">tenvT'</span> <span class="main">|)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val weak_decls : decls -&gt; decls -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weak_decls</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" decls <span class="main">⇒</span> decls <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">weak_decls</span> <span class="free"><span class="bound"><span class="entity">decls_impl</span></span></span> <span class="free"><span class="bound"><span class="entity">decls_spec</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="main">(</span>defined_mods0   <span class="free"><span class="bound"><span class="entity">decls_impl</span></span></span><span class="main">)</span> <span class="main">=</span><span class="main">(</span>defined_mods0   <span class="free"><span class="bound"><span class="entity">decls_spec</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">(</span><span class="main">(</span>defined_types0   <span class="free"><span class="bound"><span class="entity">decls_spec</span></span></span><span class="main">)</span> <span class="main">⊆</span><span class="main">(</span>defined_types0   <span class="free"><span class="bound"><span class="entity">decls_impl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">(</span>defined_exns   <span class="free"><span class="bound"><span class="entity">decls_spec</span></span></span><span class="main">)</span> <span class="main">⊆</span><span class="main">(</span>defined_exns   <span class="free"><span class="bound"><span class="entity">decls_impl</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val weak_tenvT : id modN typeN -&gt; (list tvarN * t) -&gt; (list tvarN * t) -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">weak_tenvT</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>modN<span class="main">)</span><span class="main">,</span><span class="main">(</span>typeN<span class="main">)</span><span class="main">)</span>id0 <span class="main">⇒</span><span class="main">(</span>string<span class="main">)</span>list<span class="main">*</span>t <span class="main">⇒</span><span class="main">(</span>string<span class="main">)</span>list<span class="main">*</span>t <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">weak_tenvT</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tvs_spec</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t_spec</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tvs_impl</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t_impl</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> For simplicity, we reject matches that differ only by renaming of bound type variables ›</span></span>›</span><span class="free"><span class="bound"><span class="entity">tvs_spec</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tvs_impl</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t_spec</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t_impl</span></span></span><span class="main">)</span> <span class="main">∨</span>
   <span class="main">(</span>
   <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> The specified type is opaque ›</span></span>›</span><span class="free"><span class="bound"><span class="entity">t_spec</span></span></span> <span class="main">=</span> Tapp <span class="main">(</span>List.map Tvar <span class="free"><span class="bound"><span class="entity">tvs_spec</span></span></span><span class="main">)</span> <span class="main">(</span>TC_name <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tscheme_inst2</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">*</span>t <span class="main">⇒</span> nat<span class="main">*</span>t <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">tscheme_inst2</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">ts1</span></span></span> <span class="free"><span class="bound"><span class="entity">ts2</span></span></span> <span class="main">=</span> <span class="main">(</span> tscheme_inst <span class="free"><span class="bound"><span class="entity">ts1</span></span></span> <span class="free"><span class="bound"><span class="entity">ts2</span></span></span> <span class="main">)</span>"</span></span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>val weak_tenv : type_env -&gt; type_env -&gt; bool›</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weak_tenv</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" type_env <span class="main">⇒</span> type_env <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">weak_tenv</span> <span class="free"><span class="bound"><span class="entity">tenv_impl</span></span></span> <span class="free"><span class="bound"><span class="entity">tenv_spec</span></span></span> <span class="main">=</span> <span class="main">(</span>
  nsSub tscheme_inst2<span class="main">(</span>v0   <span class="free"><span class="bound"><span class="entity">tenv_spec</span></span></span><span class="main">)</span><span class="main">(</span>v0   <span class="free"><span class="bound"><span class="entity">tenv_impl</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span>nsSub <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>  
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> <span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">.</span>  <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">)</span><span class="main">)</span><span class="main">(</span>c0   <span class="free"><span class="bound"><span class="entity">tenv_spec</span></span></span><span class="main">)</span><span class="main">(</span>c0   <span class="free"><span class="bound"><span class="entity">tenv_impl</span></span></span><span class="main">)</span> <span class="main">∧</span>
  nsSub weak_tenvT<span class="main">(</span>t   <span class="free"><span class="bound"><span class="entity">tenv_spec</span></span></span><span class="main">)</span><span class="main">(</span>t   <span class="free"><span class="bound"><span class="entity">tenv_impl</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">check_signature</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>modN<span class="main">)</span>list <span class="main">⇒</span> tenv_abbrev <span class="main">⇒</span> decls <span class="main">⇒</span> type_env <span class="main">⇒</span><span class="main">(</span>specs<span class="main">)</span>option <span class="main">⇒</span> decls <span class="main">⇒</span> type_env <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"none"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="bound">decls</span> <span class="bound">tenv</span><span class="main">.</span>

<span class="free">check_signature</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="bound">decls</span> <span class="bound">tenv</span> None <span class="bound">decls</span> <span class="bound">tenv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"some"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">mn</span> <span class="bound">specs</span> <span class="bound">tenv_impl</span> <span class="bound">tenv_spec</span> <span class="bound">decls_impl</span> <span class="bound">decls_spec</span> <span class="bound">tenvT</span><span class="main">.</span>
weak_tenv <span class="bound">tenv_impl</span> <span class="bound">tenv_spec</span> <span class="main">∧</span>
<span class="main">(</span>weak_decls <span class="bound">decls_impl</span> <span class="bound">decls_spec</span> <span class="main">∧</span>
type_specs <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="bound">specs</span> <span class="bound">decls_spec</span> <span class="bound">tenv_spec</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">check_signature</span> <span class="bound">mn</span> <span class="bound">tenvT</span> <span class="bound">decls_impl</span> <span class="bound">tenv_impl</span> <span class="main">(</span>Some <span class="bound">specs</span><span class="main">)</span> <span class="bound">decls_spec</span> <span class="bound">tenv_spec</span> "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tenvLift</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" string <span class="main">⇒</span> type_env <span class="main">⇒</span> type_env "</span></span>  <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">" <span class="free">tenvLift</span> <span class="free"><span class="bound"><span class="entity">mn</span></span></span> <span class="free"><span class="bound"><span class="entity">tenv</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="main">(|</span> v0 <span class="main">=</span> <span class="main">(</span>nsLift <span class="free"><span class="bound"><span class="entity">mn</span></span></span><span class="main">(</span>v0   <span class="free"><span class="bound"><span class="entity">tenv</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> c0 <span class="main">=</span> <span class="main">(</span>nsLift <span class="free"><span class="bound"><span class="entity">mn</span></span></span><span class="main">(</span>c0   <span class="free"><span class="bound"><span class="entity">tenv</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> t <span class="main">=</span> <span class="main">(</span>nsLift <span class="free"><span class="bound"><span class="entity">mn</span></span></span><span class="main">(</span>t   <span class="free"><span class="bound"><span class="entity">tenv</span></span></span><span class="main">)</span><span class="main">)</span>  <span class="main">|)</span> <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">type_top</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" bool <span class="main">⇒</span> decls <span class="main">⇒</span> type_env <span class="main">⇒</span> top0 <span class="main">⇒</span> decls <span class="main">⇒</span> type_env <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"tdec"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">extra_checks</span> <span class="bound">tenv</span> <span class="bound">d</span> <span class="bound">tenv'</span> <span class="bound">decls</span> <span class="bound">decls'</span><span class="main">.</span>
type_d <span class="bound">extra_checks</span> <span class="main">[]</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="bound">d</span> <span class="bound">decls'</span> <span class="bound">tenv'</span>
<span class="main">==&gt;</span>
<span class="free">type_top</span> <span class="bound">extra_checks</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">(</span>Tdec <span class="bound">d</span><span class="main">)</span> <span class="bound">decls'</span> <span class="bound">tenv'</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"tmod"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">extra_checks</span> <span class="bound">tenv</span> <span class="bound">mn</span> <span class="bound">spec</span> <span class="bound">ds</span> <span class="bound">tenv_impl</span> <span class="bound">tenv_spec</span> <span class="bound">decls</span> <span class="bound">decls_impl</span> <span class="bound">decls_spec</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span><span class="main">[</span><span class="bound">mn</span><span class="main">]</span> <span class="main">∈</span><span class="main">(</span>defined_mods0   <span class="bound">decls</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
<span class="main">(</span>type_ds <span class="bound">extra_checks</span> <span class="main">[</span><span class="bound">mn</span><span class="main">]</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="bound">ds</span> <span class="bound">decls_impl</span> <span class="bound">tenv_impl</span> <span class="main">∧</span>
check_signature <span class="main">[</span><span class="bound">mn</span><span class="main">]</span><span class="main">(</span>t   <span class="bound">tenv</span><span class="main">)</span> <span class="bound">decls_impl</span> <span class="bound">tenv_impl</span> <span class="bound">spec</span> <span class="bound">decls_spec</span> <span class="bound">tenv_spec</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">type_top</span> <span class="bound">extra_checks</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">(</span>Tmod <span class="bound">mn</span> <span class="bound">spec</span> <span class="bound">ds</span><span class="main">)</span>
  <span class="main">(</span>union_decls <span class="main">(|</span> defined_mods0 <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="main">[</span><span class="bound">mn</span><span class="main">]</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> defined_types0 <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span><span class="main">,</span> defined_exns <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">)</span> <span class="main">|)</span> <span class="bound">decls_spec</span><span class="main">)</span>
  <span class="main">(</span>tenvLift <span class="bound">mn</span> <span class="bound">tenv_spec</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
<span class="entity">type_prog</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" bool <span class="main">⇒</span> decls <span class="main">⇒</span> type_env <span class="main">⇒</span><span class="main">(</span>top0<span class="main">)</span>list <span class="main">⇒</span> decls <span class="main">⇒</span> type_env <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"empty"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">extra_checks</span> <span class="bound">tenv</span> <span class="bound">decls</span><span class="main">.</span>

<span class="free">type_prog</span> <span class="bound">extra_checks</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">[]</span> empty_decls <span class="main">(|</span> v0 <span class="main">=</span> nsEmpty<span class="main">,</span> c0 <span class="main">=</span> nsEmpty<span class="main">,</span> t <span class="main">=</span> nsEmpty <span class="main">|)</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"cons"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">extra_checks</span> <span class="bound">tenv</span> <span class="bound">top0</span> <span class="bound">tops</span> <span class="bound">tenv1</span> <span class="bound">tenv2</span> <span class="bound">decls</span> <span class="bound">decls1</span> <span class="bound">decls2</span><span class="main">.</span>
type_top <span class="bound">extra_checks</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="bound">top0</span> <span class="bound">decls1</span> <span class="bound">tenv1</span> <span class="main">∧</span>
<span class="free">type_prog</span> <span class="bound">extra_checks</span> <span class="main">(</span>union_decls <span class="bound">decls1</span> <span class="bound">decls</span><span class="main">)</span> <span class="main">(</span>extend_dec_tenv <span class="bound">tenv1</span> <span class="bound">tenv</span><span class="main">)</span> <span class="bound">tops</span> <span class="bound">decls2</span> <span class="bound">tenv2</span>
<span class="main">==&gt;</span>
<span class="free">type_prog</span> <span class="bound">extra_checks</span> <span class="bound">decls</span> <span class="bound">tenv</span> <span class="main">(</span><span class="bound">top0</span> <span class="main">#</span> <span class="bound">tops</span><span class="main">)</span>
  <span class="main">(</span>union_decls <span class="bound">decls2</span> <span class="bound">decls1</span><span class="main">)</span> <span class="main">(</span>extend_dec_tenv <span class="bound">tenv2</span> <span class="bound">tenv1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TypeSystemAuxiliary">
<div class="head">
<h1>Theory TypeSystemAuxiliary</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Generated by Lem from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>semantics/typeSystem.lem›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> <span class="quoted">"TypeSystemAuxiliary"</span> 

<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../lem/theories/#Lem_pervasives_extra">LEM.Lem_pervasives_extra</a>"</span>
  <span class="quoted">"<a href="#Lib">Lib</a>"</span>
  <span class="quoted">"<a href="#Namespace">Namespace</a>"</span>
  <span class="quoted">"<a href="#Ast">Ast</a>"</span>
  <span class="quoted">"<a href="#SemanticPrimitives">SemanticPrimitives</a>"</span>
  <span class="quoted">"<a href="#TypeSystem">TypeSystem</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span> 


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>**************************************************›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>                                                  ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span> Termination Proofs                               ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>                                                  ›</span></span>›</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>**************************************************›</span></span>›</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">check_freevars</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">type_subst</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">deBruijn_inc</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">deBruijn_subst</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">check_type_names</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">type_name_subst</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">is_value</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Doc_Proofs">
<div class="head">
<h1>Theory Doc_Proofs</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Doc_Proofs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\part{Proofs ported from HOL4}›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div><div id="Semantic_Extras">
<div class="head">
<h1>Theory Semantic_Extras</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">"Adaptations for Isabelle"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Semantic_Extras
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="#BigStep">generated/CakeML/BigStep</a>"</span>
  <span class="quoted">"<a href="#SemanticPrimitivesAuxiliary">generated/CakeML/SemanticPrimitivesAuxiliary</a>"</span>
  <span class="quoted">"<a href="#AstAuxiliary">generated/CakeML/AstAuxiliary</a>"</span>
  <span class="quoted">"<a href="#Evaluate">generated/CakeML/Evaluate</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Simps_Case_Conv.html">HOL-Library.Simps_Case_Conv</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> exp <span class="main">=</span> <span class="quoted">exp0</span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> sem_env.v

<span class="keyword1"><span class="command">code_pred</span></span>
  <span class="main">(</span>modes<span class="main">:</span> evaluate<span class="main">:</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> o <span class="main">⇒</span> bool as compute
      <span class="keyword2"><span class="keyword">and</span></span> evaluate_list<span class="main">:</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> o <span class="main">⇒</span> bool
      <span class="keyword2"><span class="keyword">and</span></span> evaluate_match<span class="main">:</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> o <span class="main">⇒</span> bool<span class="main">)</span> <span class="quoted"><span class="quoted">evaluate</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> o <span class="main">⇒</span> bool<span class="main">)</span> <span class="quoted"><span class="quoted">evaluate_dec</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> o <span class="main">⇒</span> bool<span class="main">)</span> <span class="quoted"><span class="quoted">evaluate_decs</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> o <span class="main">⇒</span> bool<span class="main">)</span> <span class="quoted"><span class="quoted">evaluate_top</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> i <span class="main">⇒</span> o <span class="main">⇒</span> bool as compute_prog<span class="main">)</span> <span class="quoted"><span class="quoted">evaluate_prog</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">pmatch_list</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">do_eq_list</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1" id="Semantic_Extras-all_distinct_alt_def"><span class="command">lemma</span></span> all_distinct_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"allDistinct <span class="main">=</span> distinct"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"allDistinct <span class="skolem">xs</span> <span class="main">=</span> distinct <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semantic_Extras-find_recfun_someD"><span class="command">lemma</span></span> find_recfun_someD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_recfun <span class="free">n</span> <span class="free">funs</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">funs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">funs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Semantic_Extras-find_recfun_alt_def"><span class="command">lemma</span></span> find_recfun_alt_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"find_recfun <span class="free">n</span> <span class="free">funs</span> <span class="main">=</span> map_of <span class="free">funs</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">funs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Semantic_Extras-size_list_rev"><span class="command">lemma</span></span> size_list_rev<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size_list <span class="free">f</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> size_list <span class="free">f</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_list_conv_sum_list rev_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Semantic_Extras-do_if_cases"><span class="command">lemma</span></span> do_if_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="main">(</span>none<span class="main">)</span> <span class="quoted"><span class="quoted">"do_if <span class="free">v</span> <span class="free">e1</span> <span class="free">e2</span> <span class="main">=</span> None"</span></span>
  <span class="main">|</span> <span class="main">(</span>true<span class="main">)</span> <span class="quoted"><span class="quoted">"do_if <span class="free">v</span> <span class="free">e1</span> <span class="free">e2</span> <span class="main">=</span> Some <span class="free">e1</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>false<span class="main">)</span> <span class="quoted"><span class="quoted">"do_if <span class="free">v</span> <span class="free">e1</span> <span class="free">e2</span> <span class="main">=</span> Some <span class="free">e2</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> do_if_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>

<span class="keyword1"><span class="command">case_of_simps</span></span> do_log_alt_def<span class="main">:</span> do_log.simps
<span class="keyword1"><span class="command">case_of_simps</span></span> do_con_check_alt_def<span class="main">:</span> do_con_check.simps
<span class="keyword1"><span class="command">case_of_simps</span></span> list_result_alt_def<span class="main">:</span> list_result.simps

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun_cases</span></span> do_logE<span class="main">:</span> <span class="quoted"><span class="quoted">"do_log <span class="free">op</span> <span class="free">v</span> <span class="free">e</span> <span class="main">=</span> <span class="free">res</span>"</span></span>

<span class="keyword1" id="Semantic_Extras-do_log_exp"><span class="command">lemma</span></span> do_log_exp<span class="main">:</span> <span class="quoted"><span class="quoted">"do_log <span class="free">op</span> <span class="free">v</span> <span class="free">e</span> <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free">e'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> do_logE<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> v.splits option.splits if_splits tid_or_exn.splits id0.splits list.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Semantic_Extras-c_of_merge"><span class="command">lemma</span></span> c_of_merge<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c <span class="main">(</span>extend_dec_env <span class="free">env2</span> <span class="free">env1</span><span class="main">)</span> <span class="main">=</span> nsAppend <span class="main">(</span>c <span class="free">env2</span><span class="main">)</span> <span class="main">(</span>c <span class="free">env1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">env1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">env2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_dec_env_def<span class="main">)</span>

<span class="keyword1" id="Semantic_Extras-v_of_merge"><span class="command">lemma</span></span> v_of_merge<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sem_env.v <span class="main">(</span>extend_dec_env <span class="free">env2</span> <span class="free">env1</span><span class="main">)</span> <span class="main">=</span> nsAppend <span class="main">(</span>sem_env.v <span class="free">env2</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="free">env1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">env1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">env2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_dec_env_def<span class="main">)</span>

<span class="keyword1" id="Semantic_Extras-nsEmpty_nsAppend"><span class="command">lemma</span></span> nsEmpty_nsAppend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nsAppend <span class="free">e</span> nsEmpty <span class="main">=</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"nsAppend nsEmpty <span class="free">e</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsEmpty_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Semantic_Extras-do_log_cases"><span class="command">lemma</span></span> do_log_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="main">(</span>none<span class="main">)</span> <span class="quoted"><span class="quoted">"do_log <span class="free">op</span> <span class="free">v</span> <span class="free">e</span> <span class="main">=</span> None"</span></span>
  <span class="main">|</span> <span class="main">(</span>val<span class="main">)</span> <span class="free">v'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"do_log <span class="free">op</span> <span class="free">v</span> <span class="free">e</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="free">v'</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>exp<span class="main">)</span> <span class="quoted"><span class="quoted">"do_log <span class="free">op</span> <span class="free">v</span> <span class="free">e</span> <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"do_log <span class="free">op</span> <span class="free">v</span> <span class="free">e</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> none <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">res</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> val exp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">res</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> do_log_exp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun_cases</span></span> do_opappE<span class="main">:</span> <span class="quoted"><span class="quoted">"do_opapp <span class="free">vs</span> <span class="main">=</span> Some <span class="free">res</span>"</span></span>

<span class="keyword1" id="Semantic_Extras-do_opapp_cases"><span class="command">lemma</span></span> do_opapp_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"do_opapp <span class="free">vs</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">env'</span><span class="main">,</span> <span class="free">exp'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>closure<span class="main">)</span> <span class="free">env</span> <span class="free">n</span> <span class="free">v0</span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">=</span> <span class="main">[</span>Closure <span class="free">env</span> <span class="free">n</span> <span class="free">exp'</span><span class="main">,</span> <span class="free">v0</span><span class="main">]</span>"</span></span>
                  <span class="quoted"><span class="quoted">"<span class="free">env'</span> <span class="main">=</span> <span class="main">(</span><span class="free">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsBind <span class="free">n</span> <span class="free">v0</span> <span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span> <span class="main">⦈</span> <span class="main">)</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>recclosure<span class="main">)</span> <span class="free">env</span> <span class="free">funs</span> <span class="free">name</span> <span class="free">n</span> <span class="free">v0</span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">=</span> <span class="main">[</span>Recclosure <span class="free">env</span> <span class="free">funs</span> <span class="free">name</span><span class="main">,</span> <span class="free">v0</span><span class="main">]</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"allDistinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">)</span> <span class="free">funs</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"find_recfun <span class="free">name</span> <span class="free">funs</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">exp'</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">env'</span> <span class="main">=</span> <span class="main">(</span><span class="free">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsBind <span class="free">n</span> <span class="free">v0</span> <span class="main">(</span>build_rec_env <span class="free">funs</span> <span class="free">env</span> <span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span> <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> do_opappE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> closure<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> recclosure<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> evaluate_induct <span class="main">=</span>
  evaluate_match_evaluate_list_evaluate.inducts<span class="main">[</span><span class="operator">split_format</span><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">complete</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span>

<span class="keyword1" id="Semantic_Extras-evaluate_clock_mono"><span class="command">lemma</span></span> evaluate_clock_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">v'</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span> <span class="main">⟹</span> clock <span class="free">s'</span> <span class="main">≤</span> clock <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span> <span class="main">⟹</span> clock <span class="free">s'</span> <span class="main">≤</span> clock <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r3</span><span class="main">)</span> <span class="main">⟹</span> clock <span class="free">s'</span> <span class="main">≤</span> clock <span class="free">s</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate_induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> do_app.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">datatype_record_update</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> state.splits if_splits<span class="main">)</span>

<span class="keyword1" id="Semantic_Extras-evaluate_list_singleton_valE"><span class="command">lemma</span></span> evaluate_list_singleton_valE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rval <span class="free">vs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">=</span> <span class="main">[</span><span class="free">v</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rval <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> evaluate_list.cases<span class="main">)</span>

<span class="keyword1" id="Semantic_Extras-evaluate_list_singleton_errD"><span class="command">lemma</span></span> evaluate_list_singleton_errD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rerr <span class="free">err</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rerr <span class="free">err</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> evaluate_list.cases<span class="main">)</span>

<span class="keyword1" id="Semantic_Extras-evaluate_list_singleton_cases"><span class="command">lemma</span></span> evaluate_list_singleton_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="free">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>val<span class="main">)</span> <span class="free">s'</span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rval <span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rval <span class="free">v</span><span class="main">)</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>err<span class="main">)</span> <span class="free">s'</span> <span class="free">err</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rerr <span class="free">err</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rerr <span class="free">err</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted">"evaluate_list <span class="free"><span class="free">ck</span></span> <span class="free"><span class="free">env</span></span> <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">[</span></span><span class="free"><span class="free">e</span></span><span class="main"><span class="main">]</span></span> <span class="free"><span class="free">res</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted">"evaluate_list <span class="free"><span class="free">ck</span></span> <span class="free"><span class="free">env</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="main"><span class="main">[]</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">s3</span></span><span class="main"><span class="main">,</span></span> Rval <span class="skolem"><span class="skolem">vs</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="skolem"><span class="skolem">s3</span></span> <span class="skolem"><span class="skolem">vs</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted">" evaluate_list <span class="free"><span class="free">ck</span></span> <span class="free"><span class="free">env</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="main"><span class="main">[]</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">s3</span></span><span class="main"><span class="main">,</span></span> Rerr <span class="skolem"><span class="skolem">err</span></span><span class="main"><span class="main">)</span></span> "</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="skolem"><span class="skolem">s3</span></span> <span class="skolem"><span class="skolem">err</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Semantic_Extras-evaluate_list_singletonI"><span class="command">lemma</span></span> evaluate_list_singletonI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> list_result <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span>

<span class="keyword1" id="Semantic_Extras-prod_result_cases"><span class="command">lemma</span></span> prod_result_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>val<span class="main">)</span> <span class="free">s</span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> Rval <span class="free">v</span><span class="main">)</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>err<span class="main">)</span> <span class="free">s</span> <span class="free">err</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> Rerr <span class="free">err</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ b
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Semantic_Extras-do_con_check_build_conv"><span class="command">lemma</span></span> do_con_check_build_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"do_con_check <span class="main">(</span>c <span class="free">env</span><span class="main">)</span> <span class="free">cn</span> <span class="main">(</span>length <span class="free">es</span><span class="main">)</span> <span class="main">⟹</span> build_conv <span class="main">(</span>c <span class="free">env</span><span class="main">)</span> <span class="free">cn</span> <span class="free">vs</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cn</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">match_result</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> v <span class="main">⇒</span><span class="main">(</span>pat<span class="main">*</span>exp<span class="main">)</span>list <span class="main">⇒</span> v <span class="main">⇒</span> <span class="main">(</span>exp <span class="main">×</span> <span class="main">(</span>char list <span class="main">×</span> v<span class="main">)</span> list<span class="main">,</span> v<span class="main">)</span>result"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">match_result</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">err_v</span></span></span> <span class="main">=</span> Rerr <span class="main">(</span>Rraise <span class="free"><span class="bound"><span class="entity">err_v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">match_result</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">err_v</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">case</span> pmatch <span class="main">(</span>sem_env.c <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">(</span>refs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[]</span> <span class="keyword1">of</span>
      Match <span class="bound">env'</span> <span class="main">⇒</span> Rval <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span> <span class="main">|</span>
      No_match <span class="main">⇒</span> <span class="free">match_result</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span> <span class="free"><span class="bound"><span class="entity">err_v</span></span></span> <span class="main">|</span>
      Match_type_error <span class="main">⇒</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>
   <span class="keyword1">else</span>
      Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">case_of_simps</span></span> match_result_alt_def<span class="main">:</span> match_result.simps

<span class="keyword1" id="Semantic_Extras-match_result_sound"><span class="command">lemma</span></span> match_result_sound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> match_result <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="keyword1">of</span>
    Rerr <span class="bound">err</span> <span class="main">⇒</span> evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
  <span class="main">|</span> Rval <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">∀</span><span class="bound">bv</span><span class="main">.</span>
        evaluate <span class="free">ck</span> <span class="main">(</span><span class="free">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="bound">env'</span><span class="main">)</span><span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">s</span> <span class="bound">e</span> <span class="bound">bv</span> <span class="main">⟶</span>
             evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="bound">bv</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match_result.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> match_result.splits result.splits<span class="main">)</span>

<span class="keyword1" id="Semantic_Extras-match_result_sound_val"><span class="command">lemma</span></span> match_result_sound_val<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match_result <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> Rval <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">env'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="main">(</span><span class="free">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="free">env'</span><span class="main">)</span><span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">s</span> <span class="free">e</span> <span class="free">bv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="free">bv</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> match_result_sound<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> env <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">env</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?v0.0</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">v0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> pes <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">pes</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> err_v <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">err_v</span></span><span class="main">,</span> <span class="operator">unfolded</span> assms result.case prod.case<span class="main">]</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semantic_Extras-match_result_sound_err"><span class="command">lemma</span></span> match_result_sound_err<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match_result <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> Rerr <span class="free">err</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> Rerr <span class="free">err</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> match_result_sound<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> env <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">env</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?v0.0</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">v0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> pes <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">pes</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> err_v <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">err_v</span></span><span class="main">,</span> <span class="operator">unfolded</span> assms result.case prod.case<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semantic_Extras-match_result_correct"><span class="command">lemma</span></span> match_result_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">bv</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="free">bv</span> <span class="keyword1">of</span>
          Rval <span class="bound">v</span> <span class="main">⇒</span>
            <span class="main">∃</span><span class="bound">e</span> <span class="bound">env'</span><span class="main">.</span> match_result <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> Rval <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span> <span class="main">∧</span> evaluate <span class="free">ck</span> <span class="main">(</span><span class="free">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="bound">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">s</span> <span class="bound">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rval <span class="bound">v</span><span class="main">)</span>
        <span class="main">|</span> Rerr <span class="bound">err</span> <span class="main">⇒</span>
            <span class="main">(</span>match_result <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> Rerr <span class="bound">err</span><span class="main">)</span> <span class="main">∨</span>
            <span class="main">(</span><span class="main">∃</span><span class="bound">e</span> <span class="bound">env'</span><span class="main">.</span> match_result <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> Rval <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span> <span class="main">∧</span> evaluate <span class="free">ck</span> <span class="main">(</span><span class="free">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="bound">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">s</span> <span class="bound">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pes</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">pe</span> <span class="skolem">pes</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat_cons1 <span class="skolem">env'</span> <span class="skolem">p</span> <span class="skolem">e</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">bv</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat_cons2 <span class="skolem">p</span> <span class="skolem">e</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons.IH
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">bv</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> evaluate_match.cases<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Evaluate_Termination">
<div class="head">
<h1>Theory Evaluate_Termination</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">"Functional big-step semantics"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Termination proof"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Evaluate_Termination
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Semantic_Extras">Semantic_Extras</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">case_of_simps</span></span> fix_clock_alt_def<span class="main">:</span> fix_clock.simps

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">size_exp'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>Raise <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>Handle <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">+</span> size_list <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">.</span> Suc <span class="main">(</span>size <span class="bound">p</span> <span class="main">+</span> <span class="bound">es</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod id <span class="free">size_exp'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>Con <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>size_list id <span class="main">(</span>map <span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>Fun <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>App <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>size_list id <span class="main">(</span>map <span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>Log <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">+</span> <span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>If <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">+</span> <span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">+</span> <span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>Mat <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">+</span> size_list <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">.</span> Suc <span class="main">(</span>size <span class="bound">p</span> <span class="main">+</span> <span class="bound">es</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod id <span class="free">size_exp'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>Let <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">+</span> <span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>Letrec <span class="free"><span class="bound"><span class="entity">defs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">+</span> size_list <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span><span class="main">.</span> Suc <span class="main">(</span>Suc <span class="bound">es</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod id <span class="main">(</span>map_prod id <span class="free">size_exp'</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">defs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>Tannot <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>Lannot <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">size_exp'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>Lit <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_exp'</span> <span class="main">(</span>Var <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_exp' <span class="main">(</span>Mat <span class="free">e</span> <span class="free">pes</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>size_exp' <span class="free">e</span> <span class="main">+</span> size_list <span class="main">(</span>size_prod size size_exp'<span class="main">)</span> <span class="free">pes</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_exp'.simps size_list_conv_sum_list<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">sum_list</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_exp' <span class="main">(</span>Handle <span class="free">e</span> <span class="free">pes</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>size_exp' <span class="free">e</span> <span class="main">+</span> size_list <span class="main">(</span>size_prod size size_exp'<span class="main">)</span> <span class="free">pes</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_exp'.simps size_list_conv_sum_list<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">sum_list</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_exp' <span class="main">(</span>Letrec <span class="free">defs</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>size_exp' <span class="free">e</span> <span class="main">+</span> size_list <span class="main">(</span>size_prod <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>size_prod <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> size_exp'<span class="main">)</span><span class="main">)</span> <span class="free">defs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_exp'.simps size_list_conv_sum_list<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">sum_list</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_evaluate_relation</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fun_evaluate_relation</span> <span class="main">=</span> inv_image <span class="main">(</span>less_than <span class="keyword1">&lt;*lex*&gt;</span> less_than<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span>
  <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
    Inr <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">es</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>clock <span class="bound">s</span><span class="main">,</span> size_list size_exp' <span class="bound">es</span><span class="main">)</span>
  <span class="main">|</span> Inl <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">pes</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>clock <span class="bound">s</span><span class="main">,</span> size_list <span class="main">(</span>size_prod size size_exp'<span class="main">)</span> <span class="bound">pes</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">fun_evaluate</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted">fun_evaluate_relation</span><span class="main"><span class="keyword3">;</span></span>
    <span class="operator">auto</span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_evaluate_relation_def fix_clock_alt_def dec_clock_def do_if_def do_log_alt_def
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">datatype_record_update</span></span>
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits state.splits lop.splits v.splits option.splits if_splits tid_or_exn.splits id0.splits list.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Evaluate_Clock">
<div class="head">
<h1>Theory Evaluate_Clock</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Simplifiying the definition"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Evaluate_Clock
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Evaluate_Termination">Evaluate_Termination</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> sem_env.v

<span class="keyword1" id="Evaluate_Clock-fix_clock"><span class="command">lemma</span></span> fix_clock<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fix_clock <span class="free">s1</span> <span class="main">(</span><span class="free">s2</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> clock <span class="free">s</span> <span class="main">≤</span> clock <span class="free">s1</span>"</span></span>
  <span class="quoted"><span class="quoted">"fix_clock <span class="free">s1</span> <span class="main">(</span><span class="free">s2</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> clock <span class="free">s</span> <span class="main">≤</span> clock <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fix_clock_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Evaluate_Clock-dec_clock"><span class="command">lemma</span></span> dec_clock<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"clock <span class="main">(</span>dec_clock <span class="free">st</span><span class="main">)</span> <span class="main">=</span> clock <span class="free">st</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dec_clock_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Evaluate_Clock-fun_evaluate_clock0"><span class="command">lemma</span></span> fun_evaluate_clock0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"clock <span class="main">(</span>fst <span class="main">(</span>fun_evaluate_match <span class="free">s1</span> <span class="free">env</span> <span class="free">v</span> <span class="free">p</span> <span class="free">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> clock <span class="free">s1</span>"</span></span>
  <span class="quoted"><span class="quoted">"clock <span class="main">(</span>fst <span class="main">(</span>fun_evaluate <span class="free">s1</span> <span class="free">env</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> clock <span class="free">s1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fun_evaluate_match_fun_evaluate.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">es</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fix_clock <span class="skolem">st</span> <span class="main">(</span>fun_evaluate <span class="skolem">st</span> <span class="skolem">env</span> <span class="main">[</span><span class="skolem">e1</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits result.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps fst_conv le_trans prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps fst_conv le_trans prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps prod.collapse prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fix_clock <span class="skolem">st</span> <span class="main">(</span>fun_evaluate <span class="skolem">st</span> <span class="skolem">env</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits result.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps prod.collapse prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 5<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted">"*"</span> <span class="quoted">"5.IH"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dual_order.trans eq_fst_iff error_result.exhaust error_result.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> error_result.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> fix_clock<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fix_clock.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">op1</span> <span class="skolem">es</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fix_clock <span class="skolem">st</span> <span class="main">(</span>fun_evaluate <span class="skolem">st</span> <span class="skolem">env</span> <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">note</span></span> do_app.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits result.splits option.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps prod.collapse prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps prod.collapse prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted">"*"</span> <span class="quoted">"9.IH"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> One_nat_def Suc_pred dec_clock dual_order.trans fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps fst_conv le_imp_less_Suc nat_less_le prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps fst_conv prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 9<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted">"*"</span> Suc_pred dual_order.trans fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps le_imp_less_Suc less_irrefl_nat nat_le_linear prod.collapse prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps prod.collapse prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 9<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted">"*"</span> Suc_pred dual_order.trans fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps le_imp_less_Suc less_irrefl_nat nat_le_linear prod.collapse prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">lop</span> <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fix_clock <span class="skolem">st</span> <span class="main">(</span>fun_evaluate <span class="skolem">st</span> <span class="skolem">env</span> <span class="main">[</span><span class="skolem">e1</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits result.splits option.splits exp_or_val.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps fst_conv prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 10<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"*"</span> dual_order.trans fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps fstI prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps prod.collapse snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps fst_conv prod.exhaust_sel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fix_clock <span class="skolem">st</span> <span class="main">(</span>fun_evaluate <span class="skolem">st</span> <span class="skolem">env</span> <span class="main">[</span><span class="skolem">e1</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits result.splits option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps fst_conv prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 11<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"*"</span> dual_order.trans eq_fst_iff fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps fst_conv prod.exhaust_sel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>12 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fix_clock <span class="skolem">st</span> <span class="main">(</span>fun_evaluate <span class="skolem">st</span> <span class="skolem">env</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits result.splits option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 12<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"*"</span> dual_order.trans eq_fst_iff fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps fst_conv prod.exhaust_sel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>13 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">xo</span> <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fix_clock <span class="skolem">st</span> <span class="main">(</span>fun_evaluate <span class="skolem">st</span> <span class="skolem">env</span> <span class="main">[</span><span class="skolem">e1</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits result.splits option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 13<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"*"</span> dual_order.trans eq_fst_iff fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> fix_clock<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fix_clock.simps fst_conv prod.exhaust_sel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits result.splits option.splits match_result.splits<span class="main">)</span>

<span class="keyword1" id="Evaluate_Clock-fun_evaluate_clock"><span class="command">lemma</span></span> fun_evaluate_clock<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fun_evaluate_match <span class="free">s1</span> <span class="free">env</span> <span class="free">v</span> <span class="free">p</span> <span class="free">v'</span> <span class="main">=</span> <span class="main">(</span><span class="free">s2</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> clock <span class="free">s2</span> <span class="main">≤</span> clock <span class="free">s1</span>"</span></span>
  <span class="quoted"><span class="quoted">"fun_evaluate <span class="free">s1</span> <span class="free">env</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">s2</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> clock <span class="free">s2</span> <span class="main">≤</span> clock <span class="free">s1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> fun_evaluate_clock0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Evaluate_Clock-fix_clock_evaluate"><span class="command">lemma</span></span> fix_clock_evaluate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fix_clock <span class="free">s1</span> <span class="main">(</span>fun_evaluate <span class="free">s1</span> <span class="free">env</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> fun_evaluate <span class="free">s1</span> <span class="free">env</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fix_clock_alt_def
<span class="keyword1"><span class="command">using</span></span> fun_evaluate_clock <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> fun_evaluate.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> fun_evaluate_match.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> fun_evaluate_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  fun_evaluate.simps<span class="main">[</span><span class="operator">unfolded</span> fix_clock_evaluate<span class="main">]</span>
  fun_evaluate_match.simps<span class="main">[</span><span class="operator">unfolded</span> fix_clock_evaluate<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> fun_evaluate_induct <span class="main">=</span>
  fun_evaluate_match_fun_evaluate.induct<span class="main">[</span><span class="operator">unfolded</span> fix_clock_evaluate<span class="main">]</span>

<span class="keyword1" id="Evaluate_Clock-fun_evaluate_length"><span class="command">lemma</span></span> fun_evaluate_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fun_evaluate_match <span class="free">s</span> <span class="free">env</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">res</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">res</span> <span class="keyword1">of</span> Rval <span class="bound">vs</span> <span class="main">⇒</span> length <span class="bound">vs</span> <span class="main">=</span> <span class="main">1</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"fun_evaluate <span class="free">s</span> <span class="free">env</span> <span class="free">es</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">res</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">res</span> <span class="keyword1">of</span> Rval <span class="bound">vs</span> <span class="main">⇒</span> length <span class="bound">vs</span> <span class="main">=</span> length <span class="free">es</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quoted"><span class="free">res</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fun_evaluate_match_fun_evaluate.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">op1</span> <span class="skolem">es</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> do_app.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits result.splits option.splits exp_or_val.splits match_result.splits error_result.splits
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_result_alt_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span>
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits result.splits option.splits exp_or_val.splits
             match_result.splits error_result.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Evaluate_Clock-fun_evaluate_matchE"><span class="command">lemma</span></span> fun_evaluate_matchE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fun_evaluate_match <span class="free">s</span> <span class="free">env</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rval <span class="free">vs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">=</span> <span class="main">[</span><span class="free">v</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> fun_evaluate_length<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Evaluate_Single">
<div class="head">
<h1>Theory Evaluate_Single</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Simplifiying the definition: no mutual recursion"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Evaluate_Single
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Evaluate_Clock">Evaluate_Clock</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">evaluate_list</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ffi</span> state <span class="main">⇒</span> exp <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span>v<span class="main">,</span> v<span class="main">)</span> result<span class="main">)</span> <span class="main">⇒</span>
    <span class="tfree">'ffi</span> state <span class="main">⇒</span> exp list <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span>v list<span class="main">,</span> v<span class="main">)</span> result"</span></span> <span class="keyword2"><span class="keyword">where</span></span>

Nil<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate_list</span> <span class="free"><span class="bound"><span class="entity">eval</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rval <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>

Cons<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate_list</span> <span class="free"><span class="bound"><span class="entity">eval</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> fix_clock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">eval</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free">evaluate_list</span> <span class="free"><span class="bound"><span class="entity">eval</span></span></span> <span class="bound">s'</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="keyword1">of</span>
        <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> Rval <span class="main">(</span><span class="bound">v</span><span class="main">#</span><span class="bound">vs</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> <span class="bound">res</span> <span class="main">⇒</span> <span class="bound">res</span><span class="main">)</span>
  <span class="main">|</span>  <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Evaluate_Single-evaluate_list_cong"><span class="command">lemma</span></span> evaluate_list_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="free">es1</span> <span class="main">⟹</span> clock <span class="bound">s</span> <span class="main">≤</span> clock <span class="free">s1</span> <span class="main">⟹</span> <span class="free">eval1</span> <span class="bound">s</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">eval2</span> <span class="bound">s</span> <span class="bound">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="free">s2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">es1</span> <span class="main">=</span> <span class="free">es2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_list <span class="free">eval1</span> <span class="free">s1</span> <span class="free">es1</span> <span class="main">=</span> evaluate_list <span class="free">eval2</span> <span class="free">s2</span> <span class="free">es2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">es2</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fix_clock_alt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits result.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span>
<span class="entity">evaluate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" v sem_env <span class="main">⇒</span><span class="tfree">'ffi</span> state <span class="main">⇒</span> exp <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span>v<span class="main">,</span>v<span class="main">)</span> result"</span></span> <span class="keyword2"><span class="keyword">where</span></span>

Lit<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Lit <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

Raise<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Raise <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="main">(</span><span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">⇒</span> <span class="bound">res</span><span class="main">)</span>"</span></span> <span class="main">|</span>

Handle<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Handle <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> match_result <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">s'</span> <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span> <span class="bound">v</span> <span class="keyword1">of</span>
        <span class="main">(</span>Rval <span class="main">(</span><span class="bound">e'</span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
          <span class="free">evaluate</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="bound">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="bound">s'</span> <span class="bound">e'</span>
      <span class="main">|</span> <span class="main">(</span>Rerr <span class="bound">err</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">⇒</span> <span class="bound">res</span><span class="main">)</span>"</span></span> <span class="main">|</span>

Con<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Con <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> do_con_check <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">case</span> evaluate_list <span class="main">(</span><span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="main">(</span><span class="keyword1">case</span> build_conv <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span>rev <span class="bound">vs</span><span class="main">)</span> <span class="keyword1">of</span>
          Some <span class="bound">v</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">v</span><span class="main">)</span>
        <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

Var<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> nsLookup <span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span>
    Some <span class="bound">v</span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rval <span class="bound">v</span><span class="main">)</span>
  <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

Fun<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rval <span class="main">(</span>Closure <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

App<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> evaluate_list <span class="main">(</span><span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="main">=</span> Opapp <span class="keyword1">then</span>
        <span class="main">(</span><span class="keyword1">case</span> do_opapp <span class="main">(</span>rev <span class="bound">vs</span><span class="main">)</span> <span class="keyword1">of</span>
          Some <span class="main">(</span><span class="bound">env'</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span>
            <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>clock <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span>
              <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span>
            <span class="keyword1">else</span>
              <span class="free">evaluate</span> <span class="bound">env'</span> <span class="main">(</span>dec_clock <span class="bound">s'</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span>
        <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="main">(</span><span class="keyword1">case</span> do_app <span class="main">(</span>refs <span class="bound">s'</span><span class="main">,</span> ffi <span class="bound">s'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="main">(</span>rev <span class="bound">vs</span><span class="main">)</span> <span class="keyword1">of</span>
          Some <span class="main">(</span><span class="main">(</span><span class="bound">refs'</span><span class="main">,</span><span class="bound">ffi'</span><span class="main">)</span><span class="main">,</span> <span class="bound">res</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span> <span class="main">⦇</span>refs<span class="main">:=</span><span class="bound">refs'</span><span class="main">,</span>ffi<span class="main">:=</span><span class="bound">ffi'</span><span class="main">⦈</span><span class="main">,</span> <span class="bound">res</span><span class="main">)</span>
        <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

Log<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Log <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> do_log <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="keyword1">of</span>
        Some <span class="main">(</span>Exp <span class="bound">e'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">s'</span> <span class="bound">e'</span>
      <span class="main">|</span> Some <span class="main">(</span>Val <span class="bound">bv</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">bv</span><span class="main">)</span>
      <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">⇒</span> <span class="bound">res</span><span class="main">)</span>"</span></span> <span class="main">|</span>

If<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>If <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> do_if <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="keyword1">of</span>
        Some <span class="bound">e'</span> <span class="main">⇒</span> <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">s'</span> <span class="bound">e'</span>
      <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">⇒</span> <span class="bound">res</span><span class="main">)</span>"</span></span> <span class="main">|</span>

Mat<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Mat <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> match_result <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">s'</span> <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span> Bindv <span class="keyword1">of</span>
        Rval <span class="main">(</span><span class="bound">e'</span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span> <span class="main">⇒</span>
          <span class="free">evaluate</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="bound">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="bound">s'</span> <span class="bound">e'</span>
      <span class="main">|</span> Rerr <span class="bound">err</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">⇒</span> <span class="bound">res</span><span class="main">)</span>"</span></span> <span class="main">|</span>

Let<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="free">evaluate</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> <span class="main">(</span>nsOptBind <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">v</span><span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="bound">s'</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>
  <span class="main">|</span> <span class="bound">res</span> <span class="main">⇒</span> <span class="bound">res</span><span class="main">)</span>"</span></span> <span class="main">|</span>

Letrec<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Letrec <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> distinct <span class="main">(</span>List.map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">x</span> <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="free">evaluate</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> <span class="main">(</span>build_rec_env <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="keyword1">else</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

Tannot<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Tannot <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>

Lannot<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Lannot <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> do_app.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Evaluate_Single-match_result_elem"><span class="command">lemma</span></span> match_result_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match_result <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> Rval <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">env'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pat</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">pes</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pes</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">pe</span> <span class="skolem">pes</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pe</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>match_result_alt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"allDistinct <span class="main">(</span>pat_bindings <span class="skolem">p</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pmatch <span class="main">(</span>c <span class="free">env</span><span class="main">)</span> <span class="main">(</span>refs <span class="free">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="free">v0</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Evaluate_Single-evaluate_list_clock_monotone"><span class="command">lemma</span></span> evaluate_list_clock_monotone<span class="main">:</span> <span class="quoted"><span class="quoted">"clock <span class="main">(</span>fst <span class="main">(</span>evaluate_list <span class="free">eval</span> <span class="free">s</span> <span class="free">es</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> clock <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.splits result.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fix_clock_alt_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>fstI <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> state.record_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Evaluate_Single-i_hate_words_helper"><span class="command">lemma</span></span> i_hate_words_helper<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">k</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">thm</span></span> i_hate_words_helper <span class="main">[</span><span class="operator">THEN</span> le_trans<span class="main">,</span> <span class="operator">no_vars</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Evaluate_Single-evaluate_clock_monotone"><span class="command">lemma</span></span> evaluate_clock_monotone<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹clock <span class="main">(</span>fst <span class="main">(</span>evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> clock <span class="free">s</span>›</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹evaluate_dom <span class="main">(</span><span class="free">env</span><span class="main">,</span> <span class="free">s</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">r</span> <span class="main">⟹</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">r</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="skolem">r</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> evaluate.psimps do_con_check_build_conv evaluate_list_clock_monotone
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits result.splits option.splits exp_or_val.splits error_result.splits
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fstI <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_evaluate_single_relation</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fun_evaluate_single_relation</span> <span class="main">=</span> inv_image <span class="main">(</span>less_than <span class="keyword1">&lt;*lex*&gt;</span> less_than<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span>
  <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>clock <span class="bound">s</span><span class="main">,</span> size_exp' <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Evaluate_Single-pat_elem_less_size"><span class="command">lemma</span></span> pat_elem_less_size<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pat</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">pes</span> <span class="main">⟹</span> size_exp' <span class="free">e</span> <span class="main">&lt;</span> <span class="main">(</span>size_list <span class="main">(</span>size_prod size size_exp'<span class="main">)</span> <span class="free">pes</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pes</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Evaluate_Single-elem_less_size"><span class="command">lemma</span></span> elem_less_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="free">es</span> <span class="main">⟹</span> size_exp' <span class="free">e</span> <span class="main">≤</span> size_list size_exp' <span class="free">es</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Evaluate_Single-evaluate_total"><span class="command">lemma</span></span> evaluate_total<span class="main">:</span> <span class="quoted"><span class="quoted">"All evaluate_dom"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"fun_evaluate_single_relation"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> fun_evaluate_single_relation_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 7
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_list_clock_monotone <span class="quoted">"7"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fstI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>evaluate_list_clock_monotone Suc_le_lessD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_Suc_eq_le Suc_le_lessD do_if_def do_log_alt_def evaluate_list_clock_monotone elem_less_size
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>lop.splits v.splits option.splits tid_or_exn.splits if_splits id0.splits list.splits
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>evaluate_clock_monotone match_result_elem fstI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>sym pat_elem_less_size <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_neq_implies_less<span class="main">)</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">evaluate</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_total<span class="main">)</span>

<span class="keyword1" id="Evaluate_Single-evaluate_clock_monotone'"><span class="command">lemma</span></span> evaluate_clock_monotone'<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate <span class="free">eval</span> <span class="free">s</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>  clock <span class="free">s'</span> <span class="main">≤</span> clock <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fst_conv evaluate_clock_monotone evaluate_total
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">evaluate_list'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> exp list <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span>v list<span class="main">,</span> v<span class="main">)</span> result"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate_list'</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rval <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate_list'</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> evaluate <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free">evaluate_list'</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="bound">s'</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="keyword1">of</span>
        <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> Rval <span class="main">(</span><span class="bound">v</span><span class="main">#</span><span class="bound">vs</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> <span class="bound">res</span> <span class="main">⇒</span> <span class="bound">res</span><span class="main">)</span>
  <span class="main">|</span>  <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Evaluate_Single-fix_clock_evaluate"><span class="command">lemma</span></span> fix_clock_evaluate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fix_clock <span class="free">s</span> <span class="main">(</span>evaluate <span class="free">eval</span> <span class="free">s</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> evaluate <span class="free">eval</span> <span class="free">s</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fix_clock_alt_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">datatype_record_update</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> state.splits prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> evaluate_clock_monotone' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Evaluate_Single-evaluate_list_eq"><span class="command">lemma</span></span> evaluate_list_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate_list <span class="main">(</span>evaluate <span class="free">env</span><span class="main">)</span> <span class="main">=</span> evaluate_list' <span class="free">env</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s es
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_list'.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>prod.splits result.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> evaluate_list.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1" id="Evaluate_Single-fun_evaluate_equiv"><span class="command">lemma</span></span> fun_evaluate_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fun_evaluate_match <span class="free">s</span> <span class="free">env</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> match_result <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="keyword1">of</span>
      Rerr <span class="bound">err</span> <span class="main">⇒</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
    <span class="main">|</span> Rval <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span> <span class="main">⇒</span> evaluate_list <span class="main">(</span>evaluate <span class="main">(</span><span class="free">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> <span class="main">(</span>nsAppend <span class="main">(</span>alist_to_ns <span class="bound">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">[</span><span class="bound">e</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"fun_evaluate <span class="free">s</span> <span class="free">env</span> <span class="free">es</span> <span class="main">=</span> evaluate_list <span class="main">(</span>evaluate <span class="free">env</span><span class="main">)</span> <span class="free">s</span> <span class="free">es</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fun_evaluate_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits result.splits match_result.splits option.splits exp_or_val.splits
                  if_splits match_result.splits error_result.splits
           <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_distinct_alt_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> fun_evaluate_equiv'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">=</span> map_prod id <span class="main">(</span>map_result hd id<span class="main">)</span> <span class="main">(</span>fun_evaluate <span class="free">s</span> <span class="free">env</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fun_evaluate_equiv<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits result.splits <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> error_result.map_id<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Big_Step_Determ">
<div class="head">
<h1>Theory Big_Step_Determ</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">"Relational big-step semantics"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Determinism"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Big_Step_Determ
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Semantic_Extras">Semantic_Extras</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Big_Step_Determ-evaluate_determ"><span class="command">lemma</span></span> evaluate_determ<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">v'</span> <span class="free">r1a</span> <span class="main">⟹</span> evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">v'</span> <span class="free">r1b</span> <span class="main">⟹</span> <span class="free">r1a</span> <span class="main">=</span> <span class="free">r1b</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="free">r2a</span> <span class="main">⟹</span> evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="free">r2b</span> <span class="main">⟹</span> <span class="free">r2a</span> <span class="main">=</span> <span class="free">r2b</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">r3a</span> <span class="main">⟹</span> evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">r3b</span> <span class="main">⟹</span> <span class="free">r3a</span> <span class="main">=</span> <span class="free">r3b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r1b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">r2b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">r3b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>raise1 <span class="skolem">ck</span> <span class="skolem">s1</span> <span class="skolem">e</span> <span class="skolem">env</span> <span class="skolem">s2</span> <span class="skolem">v1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Raise <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>raise2 <span class="skolem">ck</span> <span class="skolem">s1</span> <span class="skolem">e</span> <span class="skolem">env</span> <span class="skolem">s2</span> <span class="skolem">err</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Raise <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>handle1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">s2</span> <span class="skolem">s1</span> <span class="skolem">e</span> <span class="skolem">v1</span> <span class="skolem">pes</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Handle <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">pes</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>handle2 <span class="skolem">ck</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Handle <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">pes</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>handle3 <span class="skolem">ck</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Handle <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">pes</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>con1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">cn</span> <span class="skolem">es</span> <span class="skolem">vs</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">v1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Con <span class="skolem"><span class="skolem"><span class="skolem">cn</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">es</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>con2 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">cn</span> <span class="skolem">es</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Con <span class="skolem"><span class="skolem"><span class="skolem">cn</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">es</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>con3 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">cn</span> <span class="skolem">es</span> <span class="skolem">err</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Con <span class="skolem"><span class="skolem"><span class="skolem">cn</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">es</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">es</span> <span class="skolem">vs</span> <span class="skolem">env'</span> <span class="skolem">e</span> <span class="skolem">bv</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>App Opapp <span class="skolem"><span class="skolem"><span class="skolem">es</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app2 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">es</span> <span class="skolem">vs</span> <span class="skolem">env'</span> <span class="skolem">e</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>App Opapp <span class="skolem"><span class="skolem"><span class="skolem">es</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app3 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">es</span> <span class="skolem">vs</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>App Opapp <span class="skolem"><span class="skolem"><span class="skolem">es</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app4 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">op0</span> <span class="skolem">es</span> <span class="skolem">vs</span> <span class="skolem">res</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">refs'</span> <span class="skolem">ffi'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>App <span class="skolem"><span class="skolem"><span class="skolem">op0</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">es</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app5 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">op0</span> <span class="skolem">es</span> <span class="skolem">vs</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>App <span class="skolem"><span class="skolem"><span class="skolem">op0</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">es</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app6 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">op0</span> <span class="skolem">es</span> <span class="skolem">err</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>App <span class="skolem"><span class="skolem"><span class="skolem">op0</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">es</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>log1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">op0</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v1</span> <span class="skolem">e'</span> <span class="skolem">bv</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Log <span class="skolem"><span class="skolem"><span class="skolem">op0</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e1</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e2</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>log2 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">op0</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v1</span> <span class="skolem">bv</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Log <span class="skolem"><span class="skolem"><span class="skolem">op0</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e1</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e2</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>log3 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">op0</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v1</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Log <span class="skolem"><span class="skolem"><span class="skolem">op0</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e1</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e2</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>log4 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">op0</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">err</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Log <span class="skolem"><span class="skolem"><span class="skolem">op0</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e1</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e2</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span> <span class="skolem">v1</span> <span class="skolem">e'</span> <span class="skolem">bv</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>If <span class="skolem"><span class="skolem"><span class="skolem">e1</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e2</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e3</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if2 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span> <span class="skolem">v1</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>If <span class="skolem"><span class="skolem"><span class="skolem">e1</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e2</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e3</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if3 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span> <span class="skolem">err</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>If <span class="skolem"><span class="skolem"><span class="skolem">e1</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e2</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e3</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="skolem">bv</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Mat <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">pes</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat2 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">err</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Mat <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">pes</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>let1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">n</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v1</span> <span class="skolem">bv</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Let <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e1</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e2</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>let2 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">n</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">err</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Let <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e1</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e2</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>letrec1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">funs</span> <span class="skolem">e</span> <span class="skolem">bv</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Letrec <span class="skolem"><span class="skolem"><span class="skolem">funs</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>letrec2 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">funs</span> <span class="skolem">e</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Letrec <span class="skolem"><span class="skolem"><span class="skolem">funs</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tannot <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">t0</span> <span class="skolem">s</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Tannot <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">t0</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>locannot <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">l</span> <span class="skolem">s</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Lannot <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">l</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r3b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">es</span> <span class="skolem">v1</span> <span class="skolem">vs</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate_list <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">es</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r2b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons2 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">es</span> <span class="skolem">err</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate_list <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">es</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r2b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons3 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">es</span> <span class="skolem">v1</span> <span class="skolem">err</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate_list <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">es</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r2b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat_cons1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">env'</span> <span class="skolem">v1</span> <span class="skolem">p</span> <span class="skolem">pes</span> <span class="skolem">e</span> <span class="skolem">bv</span> <span class="skolem">err_v</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate_match <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">v1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">p</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">pes</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">err_v</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r1b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat_cons2 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">v1</span> <span class="skolem">p</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">bv</span> <span class="skolem">s</span> <span class="skolem">err_v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate_match <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">v1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">p</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">pes</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">err_v</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r1b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat_cons3 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">v1</span> <span class="skolem">p</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">s</span> <span class="skolem">err_v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate_match <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">v1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">p</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">pes</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">err_v</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r1b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat_cons4 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">v1</span> <span class="skolem">p</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">s</span> <span class="skolem">err_v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate_match <span class="skolem"><span class="skolem"><span class="skolem">ck</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">env</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">v1</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">p</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">pes</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">err_v</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r1b</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> evaluate.cases evaluate_list.cases evaluate_match.cases<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Big_Step_Total">
<div class="head">
<h1>Theory Big_Step_Total</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Totality"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Big_Step_Total
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Semantic_Extras">Semantic_Extras</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Big_Step_Total-evaluate_list_total0"><span class="command">lemma</span></span> evaluate_list_total0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span> <span class="bound">env</span> <span class="bound">s'</span><span class="main">::</span><span class="tfree">'a</span> state<span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="free">es</span> <span class="main">⟹</span> clock <span class="bound">s'</span> <span class="main">≤</span> clock <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s''</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="bound">env</span> <span class="bound">s'</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate_list True <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_match_evaluate_list_evaluate.empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">es</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> clock<span class="main">:</span> <span class="quoted"><span class="quoted">"clock <span class="skolem">s'</span> <span class="main">≤</span> clock <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_clock_mono<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rval <span class="skolem">v</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s''</span> <span class="bound">r</span><span class="main">.</span> evaluate_list True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">es</span> <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons clock <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_list True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">es</span> <span class="main">(</span><span class="skolem">s''</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">with</span></span> e Rval <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">metis</span> evaluate_match_evaluate_list_evaluate.cons1 evaluate_match_evaluate_list_evaluate.cons3<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Rerr
      <span class="keyword1"><span class="command">with</span></span> e <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_match_evaluate_list_evaluate.cons2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Big_Step_Total-evaluate_match_total0"><span class="command">lemma</span></span> evaluate_match_total0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">e</span> <span class="bound">env</span> <span class="bound">s'</span><span class="main">::</span><span class="tfree">'a</span> state<span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">pes</span> <span class="main">⟹</span> clock <span class="bound">s'</span> <span class="main">≤</span> clock <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s''</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="bound">env</span> <span class="bound">s'</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate_match True <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">v'</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pes</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mat_empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">pe</span> <span class="skolem">pes</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pe</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"allDistinct <span class="main">(</span>pat_bindings <span class="skolem">p</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> distinct<span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pmatch <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>refs <span class="skolem">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="free">v</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> No_match

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate_match True <span class="skolem">env</span> <span class="skolem">s</span> <span class="free">v</span> <span class="skolem">pes</span> <span class="free">v'</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_match True <span class="skolem">env</span> <span class="skolem">s</span> <span class="free">v</span> <span class="skolem">pes</span> <span class="free">v'</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat_cons2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> Match_type_error
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mat_cons3<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Match <span class="skolem">env'</span><span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="main">(</span><span class="skolem">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> <span class="main">(</span>nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="main">(</span><span class="skolem">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> <span class="main">(</span>nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat_cons1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mat_cons4<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Total-evaluate_total"><span class="command">lemma</span></span> evaluate_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>less_than <span class="keyword1">&lt;*lex*&gt;</span> measure <span class="main">(</span>size<span class="main">::</span>exp <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock <span class="free">s</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> less
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Raise <span class="skolem">e'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e'</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e'</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> Raise <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> raise1 raise2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Con <span class="skolem">cn</span> <span class="skolem">es</span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"do_con_check <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span> <span class="skolem">cn</span> <span class="main">(</span>length <span class="skolem">es</span><span class="main">)</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">vs</span><span class="main">.</span> evaluate_list True <span class="skolem">env</span> <span class="skolem">s</span> <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">vs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_list_total0<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
                <span class="keyword1"><span class="command">unfolding</span></span> Con
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">using</span></span> Con <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> size_list_estimation'<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate_list True <span class="skolem">env</span> <span class="skolem">s</span> <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rval <span class="skolem">vs</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"build_conv <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span> <span class="skolem">cn</span> <span class="main">(</span>rev <span class="skolem">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> True
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cn</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">using</span></span> True es <span class="keyword1"><span class="command">unfolding</span></span> Con <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> con1<span class="main">)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> Rerr
                  <span class="keyword1"><span class="command">with</span></span> True es <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Con <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> con3<span class="main">)</span>
                <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">with</span></span> Con <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> con2<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">n</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nsLookup <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="skolem">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> var1 var2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">op</span> <span class="skolem">es</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">vs</span><span class="main">.</span> evaluate_list True <span class="skolem">env</span> <span class="skolem">s</span> <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">vs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_list_total0<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> App <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> size_list_estimation'<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">where</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate_list True <span class="skolem">env</span> <span class="skolem">s</span> <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s2</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> clock<span class="main">:</span> <span class="quoted"><span class="quoted">"clock <span class="skolem">s2</span> <span class="main">≤</span> clock <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_clock_mono<span class="main">)</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rval <span class="skolem">vs</span><span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">op</span> <span class="main">=</span> Opapp"</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> opapp<span class="main">:</span> True
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"do_opapp <span class="main">(</span>rev <span class="skolem">vs</span><span class="main">)</span>"</span></span><span class="main">)</span>
                      <span class="keyword3"><span class="command">case</span></span> None
                      <span class="keyword1"><span class="command">with</span></span> App opapp Rval es <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> app3<span class="main">)</span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">r</span><span class="main">)</span>
                      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env'</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">env'</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>

                      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"clock <span class="skolem">s2</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
                          <span class="keyword3"><span class="command">case</span></span> True
                          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">op</span> <span class="main">=</span> <span class="main">_</span>›</span></span> App
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app2<span class="main">)</span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                            <span class="keyword1"><span class="command">using</span></span> es <span class="keyword1"><span class="command">unfolding</span></span> Rval <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
                            <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span> <span class="keyword1"><span class="command">..</span></span>
                        <span class="keyword1"><span class="command">next</span></span>
                          <span class="keyword3"><span class="command">case</span></span> False

                          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="skolem">env'</span> <span class="main">(</span><span class="skolem">s2</span> <span class="main">⦇</span> clock <span class="main">:=</span> clock <span class="skolem">s2</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">⦈</span><span class="main">)</span> <span class="skolem">e'</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
                            <span class="keyword1"><span class="command">using</span></span> False clock <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">datatype_record_update</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> state.splits<span class="main">)</span>
                          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="skolem">env'</span> <span class="main">(</span><span class="skolem">s2</span> <span class="main">⦇</span> clock <span class="main">:=</span> clock <span class="skolem">s2</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">⦈</span><span class="main">)</span> <span class="skolem">e'</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
                            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

                          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">op</span> <span class="main">=</span> <span class="main">_</span>›</span></span> App
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app1<span class="main">)</span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                            <span class="keyword1"><span class="command">using</span></span> es <span class="keyword1"><span class="command">unfolding</span></span> Rval <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
                            <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
                            <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                        <span class="keyword1"><span class="command">qed</span></span>
                    <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> False
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"do_app <span class="main">(</span><span class="main">(</span>refs   <span class="skolem">s2</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>ffi   <span class="skolem">s2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">op</span> <span class="main">(</span>rev <span class="skolem">vs</span><span class="main">)</span>"</span></span><span class="main">)</span>
                      <span class="keyword3"><span class="command">case</span></span> None
                      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                        <span class="keyword1"><span class="command">unfolding</span></span> App
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app5<span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                        <span class="keyword1"><span class="command">using</span></span> es <span class="keyword1"><span class="command">unfolding</span></span> Rval <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">r</span><span class="main">)</span>
                      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">refs'</span></span> <span class="skolem"><span class="skolem">ffi'</span></span> <span class="skolem"><span class="skolem">res</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">refs'</span><span class="main">,</span> <span class="skolem">ffi'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">res</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>

                      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                        <span class="keyword1"><span class="command">unfolding</span></span> App
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app4<span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                        <span class="keyword1"><span class="command">using</span></span> es <span class="keyword1"><span class="command">unfolding</span></span> Rval <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
                        <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
                    <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Rerr
              <span class="keyword1"><span class="command">with</span></span> es App <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> app6<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Log <span class="skolem">op</span> <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e1</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e1</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> clock<span class="main">:</span> <span class="quoted"><span class="quoted">"clock <span class="skolem">s'</span> <span class="main">≤</span> clock <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_clock_mono<span class="main">)</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rval <span class="skolem">v</span><span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> e1 Log <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">op</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">e2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> do_log_cases<span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> none
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> Log
                    <span class="keyword1"><span class="command">using</span></span> e1 Rval <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> log3<span class="main">)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> val
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> Log
                    <span class="keyword1"><span class="command">using</span></span> e1 Rval <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> log2<span class="main">)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> exp
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s''</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">e2</span> <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> clock Log <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">e2</span> <span class="main">(</span><span class="skolem">s''</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> Log
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> log1<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> Rval e1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
                <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Rerr
              <span class="keyword1"><span class="command">with</span></span> e1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> Log <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> log4<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>If <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e1</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e1</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> clock<span class="main">:</span> <span class="quoted"><span class="quoted">"clock <span class="skolem">s'</span> <span class="main">≤</span> clock <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_clock_mono<span class="main">)</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rval <span class="skolem">v1</span><span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v1</span></span> <span class="quoted"><span class="skolem">e2</span></span> <span class="quoted"><span class="skolem">e3</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> do_if_cases<span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> none
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> If
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> if2<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> Rval e1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> true
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s''</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">e2</span> <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> clock If <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">e2</span> <span class="main">(</span><span class="skolem">s''</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> If
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> if1<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> Rval e1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> false
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s''</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">e3</span> <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> clock If <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">e3</span> <span class="main">(</span><span class="skolem">s''</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> If
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> if1<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> Rval e1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
                <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Rerr
              <span class="keyword1"><span class="command">with</span></span> e1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> If <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> if3<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Handle <span class="skolem">e'</span> <span class="skolem">pes</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e'</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> e'<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e'</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> clock<span class="main">:</span> <span class="quoted"><span class="quoted">"clock <span class="skolem">s'</span> <span class="main">≤</span> clock <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_clock_mono<span class="main">)</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> Rval
              <span class="keyword1"><span class="command">with</span></span> e' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> Handle <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> handle1<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rerr <span class="skolem">err</span><span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">err</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rraise <span class="skolem">exn</span><span class="main">)</span>

                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s''</span> <span class="bound">r</span><span class="main">.</span> evaluate_match True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">exn</span> <span class="skolem">pes</span> <span class="skolem">exn</span> <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_total0<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> Handle clock <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans_le_add1<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> size_list_estimation'<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_match True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">exn</span> <span class="skolem">pes</span> <span class="skolem">exn</span> <span class="main">(</span><span class="skolem">s''</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> Handle
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> handle2<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
                    <span class="keyword1"><span class="command">using</span></span> e' <span class="keyword1"><span class="command">unfolding</span></span> Rerr Rraise <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rabort <span class="skolem">x2</span><span class="main">)</span>
                  <span class="keyword1"><span class="command">with</span></span> e' Rerr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> Handle
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> handle3<span class="main">)</span>
                <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Mat <span class="skolem">e'</span> <span class="skolem">pes</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e'</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> e'<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e'</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> clock<span class="main">:</span> <span class="quoted"><span class="quoted">"clock <span class="skolem">s'</span> <span class="main">≤</span> clock <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_clock_mono<span class="main">)</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rval <span class="skolem">v</span><span class="main">)</span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s''</span> <span class="bound">r</span><span class="main">.</span> evaluate_match True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">v</span> <span class="skolem">pes</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span><span class="inner_quoted">''Bind''</span><span class="main">,</span> TypeExn <span class="main">(</span>Short <span class="inner_quoted">''Bind''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_total0<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
                <span class="keyword1"><span class="command">unfolding</span></span> Mat <span class="keyword1"><span class="command">using</span></span> clock <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans_le_add1<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> size_list_estimation'<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_match True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">v</span> <span class="skolem">pes</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span><span class="inner_quoted">''Bind''</span><span class="main">,</span> TypeExn <span class="main">(</span>Short <span class="inner_quoted">''Bind''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s''</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> Mat
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat1<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
                <span class="keyword1"><span class="command">using</span></span> e' <span class="keyword1"><span class="command">unfolding</span></span> Rval
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Rerr
              <span class="keyword1"><span class="command">with</span></span> e' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> Mat
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mat2<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">n</span> <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e1</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e1</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> clock<span class="main">:</span> <span class="quoted"><span class="quoted">"clock <span class="skolem">s'</span> <span class="main">≤</span> clock <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_clock_mono<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rval <span class="skolem">v</span><span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s''</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="main">(</span><span class="skolem">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsOptBind <span class="skolem">n</span> <span class="skolem">v</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="skolem">s'</span> <span class="skolem">e2</span> <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> Let clock <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> Let
                <span class="keyword1"><span class="command">using</span></span> e1 Rval <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> let1<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> Rerr
              <span class="keyword1"><span class="command">with</span></span> e1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> Let
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> let2<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Letrec <span class="skolem">funs</span> <span class="skolem">e'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="main">(</span><span class="skolem">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> build_rec_env <span class="skolem">funs</span> <span class="skolem">env</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">e'</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> Letrec
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"allDistinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">funs</span><span class="main">)</span>"</span></span><span class="main">)</span>
               <span class="main">(</span><span class="operator">metis</span> letrec1 letrec2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tannot <span class="skolem">e'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e'</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lannot <span class="skolem">e'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e'</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following are pretty much the same proofs as above, but without additional assumptions;
  instead using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source=true] evaluate_total<span class="antiquote"><span class="antiquote">}</span></span></span></span> directly.
›</span></span>

<span class="keyword1" id="Big_Step_Total-evaluate_list_total"><span class="command">lemma</span></span> evaluate_list_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate_list True <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_match_evaluate_list_evaluate.empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">es</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_total<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rval <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s''</span> <span class="bound">r</span><span class="main">.</span> evaluate_list True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">es</span> <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_list True <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">es</span> <span class="main">(</span><span class="skolem">s''</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">with</span></span> e Rval <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">metis</span> evaluate_match_evaluate_list_evaluate.cons1 evaluate_match_evaluate_list_evaluate.cons3<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Rerr
      <span class="keyword1"><span class="command">with</span></span> e <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_match_evaluate_list_evaluate.cons2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Total-evaluate_match_total"><span class="command">lemma</span></span> evaluate_match_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate_match True <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">v'</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pes</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mat_empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">pe</span> <span class="skolem">pes</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pe</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"allDistinct <span class="main">(</span>pat_bindings <span class="skolem">p</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> distinct<span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pmatch <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>refs <span class="skolem">s</span><span class="main">)</span> <span class="skolem">p</span> <span class="free">v</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> No_match

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate_match True <span class="skolem">env</span> <span class="skolem">s</span> <span class="free">v</span> <span class="skolem">pes</span> <span class="free">v'</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_match True <span class="skolem">env</span> <span class="skolem">s</span> <span class="free">v</span> <span class="skolem">pes</span> <span class="free">v'</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat_cons2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> Match_type_error
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mat_cons3<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Match <span class="skolem">env'</span><span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate True <span class="main">(</span><span class="skolem">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> <span class="main">(</span>nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_total<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="main">(</span><span class="skolem">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> <span class="main">(</span>nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat_cons1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mat_cons4<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Big_Step_Fun_Equiv">
<div class="head">
<h1>Theory Big_Step_Fun_Equiv</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Equivalence to the functional semantics"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Big_Step_Fun_Equiv
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Big_Step_Determ">Big_Step_Determ</a>
  <a href="#Big_Step_Total">Big_Step_Total</a>
  <a href="#Evaluate_Clock">Evaluate_Clock</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> eval <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v sem_env <span class="main">⇒</span> exp <span class="main">⇒</span> <span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> state <span class="main">×</span> <span class="main">(</span>v<span class="main">,</span> v<span class="main">)</span> result"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">eval_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v sem_env <span class="main">⇒</span> exp list <span class="main">⇒</span> <span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> state <span class="main">×</span> <span class="main">(</span>v list<span class="main">,</span> v<span class="main">)</span> result"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">eval_match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v sem_env <span class="main">⇒</span> v <span class="main">⇒</span> <span class="main">(</span>pat <span class="main">×</span> exp<span class="main">)</span> list <span class="main">⇒</span> v <span class="main">⇒</span> <span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> state <span class="main">×</span> <span class="main">(</span>v<span class="main">,</span> v<span class="main">)</span> result"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span>
    valid_eval<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate True <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">eval</span> <span class="free">env</span> <span class="free">e</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    valid_eval_list<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate_list True <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="main">(</span><span class="free">eval_list</span> <span class="free">env</span> <span class="free">es</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    valid_eval_match<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate_match True <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="free">eval_match</span> <span class="free">env</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> eval_all <span class="main">=</span> valid_eval valid_eval_list valid_eval_match

<span class="keyword1" id="Big_Step_Fun_Equiv-evaluate_iff"><span class="command">lemma</span></span> evaluate_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate True <span class="free">env</span> <span class="free">st</span> <span class="free">e</span> <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">r</span> <span class="main">=</span> <span class="free">eval</span> <span class="free">env</span> <span class="free">e</span> <span class="free">st</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list True <span class="free">env</span> <span class="free">st</span> <span class="free">es</span> <span class="free">r'</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">r'</span> <span class="main">=</span> <span class="free">eval_list</span> <span class="free">env</span> <span class="free">es</span> <span class="free">st</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_match True <span class="free">env</span> <span class="free">st</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">v'</span> <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">r</span> <span class="main">=</span> <span class="free">eval_match</span> <span class="free">env</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">v'</span> <span class="free">st</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eval_all evaluate_determ<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Fun_Equiv-evaluate_iff_sym"><span class="command">lemma</span></span> evaluate_iff_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate True <span class="free">env</span> <span class="free">st</span> <span class="free">e</span> <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">eval</span> <span class="free">env</span> <span class="free">e</span> <span class="free">st</span> <span class="main">=</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list True <span class="free">env</span> <span class="free">st</span> <span class="free">es</span> <span class="free">r'</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">eval_list</span> <span class="free">env</span> <span class="free">es</span> <span class="free">st</span> <span class="main">=</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_match True <span class="free">env</span> <span class="free">st</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">v'</span> <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">eval_match</span> <span class="free">env</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">v'</span> <span class="free">st</span> <span class="main">=</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> evaluate_iff<span class="main">)</span>

<span class="keyword1" id="Big_Step_Fun_Equiv-other_eval_eq"><span class="command">lemma</span></span> other_eval_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Big_Step_Fun_Equiv.eval <span class="free">eval'</span> <span class="free">eval_list'</span> <span class="free">eval_match'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval'</span> <span class="main">=</span> <span class="free">eval</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval_list'</span> <span class="main">=</span> <span class="free">eval_list</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval_match'</span> <span class="main">=</span> <span class="free">eval_match</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> other<span class="main">:</span> Big_Step_Fun_Equiv.eval <span class="quoted"><span class="free">eval'</span></span> <span class="quoted"><span class="free">eval_list'</span></span> <span class="quoted"><span class="free">eval_match'</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval'</span> <span class="main">=</span> <span class="free">eval</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_iff other.evaluate_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_determ<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval_list'</span> <span class="main">=</span> <span class="free">eval_list</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_iff other.evaluate_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_determ<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval_match'</span> <span class="main">=</span> <span class="free">eval_match</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_iff other.evaluate_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_determ<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Fun_Equiv-eval_list_singleton"><span class="command">lemma</span></span> eval_list_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_list</span> <span class="free">env</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="free">st</span> <span class="main">=</span> map_prod id list_result <span class="main">(</span><span class="free">eval</span> <span class="free">env</span> <span class="free">e</span> <span class="free">st</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">res</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="free">eval_list</span> <span class="free">env</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="free">st</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate_list True <span class="free">env</span> <span class="free">st</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="skolem">res</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_prod id list_result <span class="main">(</span><span class="free">eval</span> <span class="free">env</span> <span class="free">e</span> <span class="free">st</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rval <span class="skolem">vs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> e <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="free">env</span> <span class="free">st</span> <span class="free">e</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> Rval <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">res</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_list_singleton_valE<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free">env</span> <span class="free">e</span> <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> Rval <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_iff_sym<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">vs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rerr <span class="skolem">err</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="free">env</span> <span class="free">st</span> <span class="free">e</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> Rerr <span class="skolem">err</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">res</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_list_singleton_errD<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free">env</span> <span class="free">e</span> <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> Rerr <span class="skolem">err</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_iff_sym<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">err</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> res_def <span class="quoted"><span class="quoted">‹<span class="skolem">res</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Fun_Equiv-eval_eqI"><span class="command">lemma</span></span> eval_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> evaluate True <span class="free">env</span> <span class="free">st1</span> <span class="free">e1</span> <span class="bound">r</span> <span class="main">⟷</span> evaluate True <span class="free">env</span> <span class="free">st2</span> <span class="free">e2</span> <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free">env</span> <span class="free">e1</span> <span class="free">st1</span> <span class="main">=</span> <span class="free">eval</span> <span class="free">env</span> <span class="free">e2</span> <span class="free">st2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_iff<span class="main">)</span>

<span class="keyword1" id="Big_Step_Fun_Equiv-eval_match_eqI"><span class="command">lemma</span></span> eval_match_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> evaluate_match True <span class="free">env1</span> <span class="free">st1</span> <span class="free">v1</span> <span class="free">pes1</span> <span class="free">err_v1</span> <span class="bound">r</span> <span class="main">⟷</span> evaluate_match True <span class="free">env2</span> <span class="free">st2</span> <span class="free">v2</span> <span class="free">pes2</span> <span class="free">err_v2</span> <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval_match</span> <span class="free">env1</span> <span class="free">v1</span> <span class="free">pes1</span> <span class="free">err_v1</span> <span class="free">st1</span> <span class="main">=</span> <span class="free">eval_match</span> <span class="free">env2</span> <span class="free">v2</span> <span class="free">pes2</span> <span class="free">err_v2</span> <span class="free">st2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_iff<span class="main">)</span>

<span class="keyword1" id="Big_Step_Fun_Equiv-eval_tannot"><span class="command">lemma</span></span> eval_tannot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free">env</span> <span class="main">(</span>Tannot <span class="free">e</span> <span class="free">t1</span><span class="main">)</span> <span class="free">st</span> <span class="main">=</span> <span class="free">eval</span> <span class="free">env</span> <span class="free">e</span> <span class="free">st</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> evaluate.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span>

<span class="keyword1" id="Big_Step_Fun_Equiv-eval_lannot"><span class="command">lemma</span></span> eval_lannot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free">env</span> <span class="main">(</span>Lannot <span class="free">e</span> <span class="free">t1</span><span class="main">)</span> <span class="free">st</span> <span class="main">=</span> <span class="free">eval</span> <span class="free">env</span> <span class="free">e</span> <span class="free">st</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> evaluate.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span>

<span class="keyword1" id="Big_Step_Fun_Equiv-eval_match"><span class="command">lemma</span></span> eval_match<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free">env</span> <span class="main">(</span>Mat <span class="free">e</span> <span class="free">pes</span><span class="main">)</span> <span class="free">st</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">eval</span> <span class="free">env</span> <span class="free">e</span> <span class="free">st</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rval <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">eval_match</span> <span class="free">env</span> <span class="bound">v</span> <span class="free">pes</span> Bindv <span class="bound">st'</span>
    <span class="main">|</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> evaluate_iff_sym<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod.splits result.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> evaluate_iff_sym<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Bindv_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> valid_eval_match<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> evaluate_iff_sym<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Big_Step_Fun_Equiv-eval_match_empty"><span class="command">lemma</span></span> eval_match_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eval_match</span> <span class="free">env</span> <span class="free">v2</span> <span class="main">[]</span> <span class="free">err_v</span> <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="free">st</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="free">err_v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> evaluate_iff_sym<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Big_Step_Fun_Equiv-run_eval"><span class="command">lemma</span></span> run_eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">run_eval</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env</span> <span class="bound">e</span> <span class="bound">s</span><span class="main">.</span> evaluate True <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">run_eval</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">env_e_s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">env_e_s</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">s</span><span class="main">::</span><span class="tfree">'a</span> state<span class="main">)</span> <span class="main">⇒</span> evaluate True <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">env_e_s</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env_e_s</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">env_e_s</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">env_e_s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> choice<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> f_def prod.case<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">env</span> <span class="skolem">e</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_total<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> evaluate True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e</span> <span class="bound">r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Fun_Equiv-run_eval_list"><span class="command">lemma</span></span> run_eval_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">run_eval_list</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env</span> <span class="bound">es</span> <span class="bound">s</span><span class="main">.</span> evaluate_list True <span class="bound">env</span> <span class="bound">s</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">run_eval_list</span> <span class="bound">env</span> <span class="bound">es</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">env_es_s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">env_es_s</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">es</span><span class="main">,</span> <span class="bound">s</span><span class="main">::</span><span class="tfree">'a</span> state<span class="main">)</span> <span class="main">⇒</span> evaluate_list True <span class="bound">env</span> <span class="bound">s</span> <span class="bound">es</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">env_es_s</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env_es_s</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">env_es_s</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">env_es_s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> choice<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> f_def prod.case<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">env</span> <span class="skolem">es</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_list True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">es</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_list_total<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> evaluate_list True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">es</span> <span class="bound">r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Fun_Equiv-run_eval_match"><span class="command">lemma</span></span> run_eval_match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">run_eval_match</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env</span> <span class="bound">v</span> <span class="bound">pes</span> <span class="bound">err_v</span> <span class="bound">s</span><span class="main">.</span> evaluate_match True <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v</span> <span class="bound">pes</span> <span class="bound">err_v</span> <span class="main">(</span><span class="bound">run_eval_match</span> <span class="bound">env</span> <span class="bound">v</span> <span class="bound">pes</span> <span class="bound">err_v</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">env_v_pes_err_v_s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">env_v_pes_err_v_s</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">pes</span><span class="main">,</span> <span class="bound">err_v</span><span class="main">,</span> <span class="bound">s</span><span class="main">::</span><span class="tfree">'a</span> state<span class="main">)</span> <span class="main">⇒</span> evaluate_match True <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v</span> <span class="bound">pes</span> <span class="bound">err_v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">env_v_pes_err_v_s</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env_es_s</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">env_es_s</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">env_es_s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> choice<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> f_def prod.case<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">env</span> <span class="skolem">v</span> <span class="skolem">pes</span> <span class="skolem">err_v</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_match True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">v</span> <span class="skolem">pes</span> <span class="skolem">err_v</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_match_total<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> evaluate_match True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">v</span> <span class="skolem">pes</span> <span class="skolem">err_v</span> <span class="bound">r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> run<span class="main">:</span> eval
  <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env</span> <span class="bound">e</span> <span class="bound">s</span><span class="main">.</span> evaluate True <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env</span> <span class="bound">es</span> <span class="bound">s</span><span class="main">.</span> evaluate_list True <span class="bound">env</span> <span class="bound">s</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">env</span> <span class="bound">es</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env</span> <span class="bound">v</span> <span class="bound">pes</span> <span class="bound">err_v</span> <span class="bound">s</span><span class="main">.</span> evaluate_match True <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v</span> <span class="bound">pes</span> <span class="bound">err_v</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">env</span> <span class="bound">v</span> <span class="bound">pes</span> <span class="bound">err_v</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>
    run_eval <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env</span> <span class="bound">e</span> <span class="bound">s</span><span class="main">.</span> evaluate True <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    run_eval_list <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env</span> <span class="bound">es</span> <span class="bound">s</span><span class="main">.</span> evaluate_list True <span class="bound">env</span> <span class="bound">s</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">env</span> <span class="bound">es</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    run_eval_match <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env</span> <span class="bound">v</span> <span class="bound">pes</span> <span class="bound">err_v</span> <span class="bound">s</span><span class="main">.</span> evaluate_match True <span class="bound">env</span> <span class="bound">s</span> <span class="bound">v</span> <span class="bound">pes</span> <span class="bound">err_v</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">env</span> <span class="bound">v</span> <span class="bound">pes</span> <span class="bound">err_v</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> run_eval<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> run_eval_list<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> run_eval_match<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">hide_fact</span></span> run_eval
<span class="keyword1"><span class="command">hide_fact</span></span> run_eval_list
<span class="keyword1"><span class="command">hide_fact</span></span> run_eval_match

<span class="keyword1" id="Big_Step_Fun_Equiv-fun_evaluate"><span class="command">lemma</span></span> fun_evaluate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_match True <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span>map_prod id <span class="main">(</span>map_result hd id<span class="main">)</span> <span class="main">(</span>fun_evaluate_match <span class="free">s</span> <span class="free">env</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list True <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="main">(</span>fun_evaluate <span class="free">s</span> <span class="free">env</span> <span class="free">es</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fun_evaluate_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 5<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_list_singleton_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.cons1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> handle1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.empty<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s' err
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> error_result.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> exn
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fun_evaluate_match <span class="skolem">s'</span> <span class="skolem">env</span> <span class="skolem">exn</span> <span class="skolem">pes</span> <span class="skolem">exn</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prod_result_cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
          <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>4<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_evaluate_matchE<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.cons1<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> handle2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prems<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> 5<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> refl refl<span class="main">,</span> <span class="operator">unfolded</span> prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.empty<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.cons2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> handle2<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prems<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> error_result.map_ident<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> 5<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> refl refl<span class="main">,</span> <span class="operator">unfolded</span> prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.cons2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> handle3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">cn</span> <span class="skolem">es</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"do_con_check <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span> <span class="skolem">cn</span> <span class="main">(</span>length <span class="skolem">es</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> 6<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fun_evaluate <span class="skolem">st</span> <span class="skolem">env</span> <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prod_result_cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ vs
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> do_con_check_build_conv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> vs <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"rev <span class="skolem">vs</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.cons1<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> con1<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.empty<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.cons2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> con2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">op</span> <span class="skolem">es</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> do_app.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fun_evaluate <span class="skolem">st</span> <span class="skolem">env</span> <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prod_result_cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 9 prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
        <span class="keyword1"><span class="command">using</span></span> 9<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> refl prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> refl<span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate_list_singleton_cases<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.cons1<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> 9 prems
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_clock_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.cons2<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> 9 prems
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_clock_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_list_singletonI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app4<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.cons2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app6<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 9<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>12 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 12<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_list_singleton_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s' v
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fun_evaluate_match <span class="skolem">s'</span> <span class="skolem">env</span> <span class="skolem">v</span> <span class="skolem">pes</span> Bindv"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prod_result_cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
        <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_evaluate_matchE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.cons1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> Bindv_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prems<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> error_result.map_ident<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> 12<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> refl<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">unfolded</span> prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.empty<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.cons2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> Bindv_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prems<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> error_result.map_ident<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> 12<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> refl<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">unfolded</span> prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_match_evaluate_list_evaluate.cons2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">funs</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"allDistinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">funs</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> evaluate_list_singleton_cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>18 <span class="skolem">st</span> <span class="skolem">env</span> <span class="skolem">v2</span> <span class="skolem">p</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">err_v</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"allDistinct <span class="main">(</span>pat_bindings <span class="skolem">p</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pmatch <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>refs <span class="skolem">st</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">v2</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> No_match
          <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> id_apply<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat_cons2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 18<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> Match_type_error
          <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat_cons3<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> Match
          <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> id_apply<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat_cons1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">using</span></span> 18<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_list_singleton_cases<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> error_result.map_ident<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mat_cons4<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> evaluate_list_singleton_cases
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits result.splits if_splits exp_or_val.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> <span class="quoted">"fun"</span><span class="main">:</span> eval
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">env</span> <span class="bound">e</span> <span class="bound">s</span><span class="main">.</span> map_prod id <span class="main">(</span>map_result hd id<span class="main">)</span> <span class="main">(</span>fun_evaluate <span class="bound">s</span> <span class="bound">env</span> <span class="main">[</span><span class="bound">e</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">env</span> <span class="bound">es</span> <span class="bound">s</span><span class="main">.</span> fun_evaluate <span class="bound">s</span> <span class="bound">env</span> <span class="bound">es</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">env</span> <span class="bound">v</span> <span class="bound">pes</span> <span class="bound">err_v</span> <span class="bound">s</span><span class="main">.</span> map_prod id <span class="main">(</span>map_result hd id<span class="main">)</span> <span class="main">(</span>fun_evaluate_match <span class="bound">s</span> <span class="bound">env</span> <span class="bound">v</span> <span class="bound">pes</span> <span class="bound">err_v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evaluate_list True <span class="skolem">env</span> <span class="skolem">s</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span> <span class="main">(</span>fun_evaluate <span class="skolem">s</span> <span class="skolem">env</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_evaluate<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_list_singleton_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> error_result.map_id<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">es</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fun_evaluate<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">v</span> <span class="skolem">pes</span> <span class="skolem">err_v</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fun_evaluate<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> big_fun_equivalence <span class="main">=</span>
  fun.other_eval_eq<span class="main">[</span><span class="operator">OF</span> run.eval_axioms<span class="main">]</span>
<span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [display] big_fun_equivalence<span class="antiquote">}</span></span>›</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Big_Step_Unclocked">
<div class="head">
<h1>Theory Big_Step_Unclocked</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"A simpler version with no clock parameter and factored-out matching"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Big_Step_Unclocked
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Semantic_Extras">Semantic_Extras</a>
  <a href="#Big_Step_Determ">Big_Step_Determ</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span>

<span class="entity">evaluate_list</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span><span class="main">(</span>exp<span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>list<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>
<span class="entity">evaluate</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">" <span class="main">(</span>v<span class="main">)</span>sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> exp <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span><span class="main">,</span><span class="main">(</span>v<span class="main">)</span><span class="main">)</span>result <span class="main">⇒</span> bool "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>

<span class="quoted">"lit"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">l</span> <span class="bound">s</span><span class="main">.</span>

<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Lit <span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"raise1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">v1</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">s1</span> <span class="bound">env</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">s1</span> <span class="bound">env</span> <span class="main">(</span>Raise <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="bound">v1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"raise2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">err</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">s1</span> <span class="bound">env</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">s1</span> <span class="bound">env</span> <span class="main">(</span>Raise <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"handle1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">v1</span> <span class="bound">pes</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">s1</span> <span class="bound">env</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">s1</span> <span class="bound">env</span> <span class="main">(</span>Handle <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"handle2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">v1</span> <span class="bound">bv</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="bound">v1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
match_result <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">v1</span> <span class="bound">pes</span> <span class="bound">v1</span> <span class="main">=</span> Rval <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">)</span> <span class="main">⟹</span>
<span class="free">evaluate</span> <span class="main">(</span><span class="bound">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="bound">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="bound">s2</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Handle <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"handle2b"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">v1</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="bound">v1</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
match_result <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">v1</span> <span class="bound">pes</span> <span class="bound">v1</span> <span class="main">=</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Handle <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"handle3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">a</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort <span class="bound">a</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Handle <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"con1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">cn</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">v1</span><span class="main">.</span>
do_con_check<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">(</span>List.length <span class="bound">es</span><span class="main">)</span> <span class="main">⟹</span>
build_conv<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v1</span> <span class="main">⟹</span>
<span class="free">evaluate_list</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Con <span class="bound">cn</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"con2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">cn</span> <span class="bound">es</span> <span class="bound">s</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span>do_con_check<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">(</span>List.length <span class="bound">es</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Con <span class="bound">cn</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"con3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">cn</span> <span class="bound">es</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
do_con_check<span class="main">(</span>c   <span class="bound">env</span><span class="main">)</span> <span class="bound">cn</span> <span class="main">(</span>List.length <span class="bound">es</span><span class="main">)</span> <span class="main">⟹</span>
<span class="free">evaluate_list</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Con <span class="bound">cn</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"var1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">n</span> <span class="bound">v1</span> <span class="bound">s</span><span class="main">.</span>
nsLookup<span class="main">(</span>sem_env.v   <span class="bound">env</span><span class="main">)</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">v1</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Var <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"var2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">n</span> <span class="bound">s</span><span class="main">.</span>
nsLookup<span class="main">(</span>sem_env.v   <span class="bound">env</span><span class="main">)</span> <span class="bound">n</span> <span class="main">=</span> None
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Var <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"fn"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">n</span> <span class="bound">e</span> <span class="bound">s</span><span class="main">.</span>

<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Fun <span class="bound">n</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="main">(</span>Closure <span class="bound">env</span> <span class="bound">n</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">env'</span> <span class="bound">e</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate_list</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">⟹</span>
do_opapp <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">env'</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">⟹</span>
<span class="free">evaluate</span> <span class="bound">env'</span> <span class="bound">s2</span> <span class="bound">e</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>App Opapp <span class="bound">es</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"app3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate_list</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span>do_opapp <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> None<span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>App Opapp <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app4"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">res</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">refs'</span> <span class="bound">ffi'</span><span class="main">.</span>
<span class="free">evaluate_list</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">⟹</span>
do_app <span class="main">(</span><span class="main">(</span>refs   <span class="bound">s2</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>ffi   <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="bound">op0</span> <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="bound">refs'</span><span class="main">,</span><span class="bound">ffi'</span><span class="main">)</span><span class="main">,</span> <span class="bound">res</span><span class="main">)</span> <span class="main">⟹</span>
<span class="bound">op0</span> <span class="main">≠</span> Opapp
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>App <span class="bound">op0</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span> <span class="bound">s2</span> <span class="main">(|</span> refs <span class="main">:=</span> <span class="bound">refs'</span><span class="main">,</span> ffi <span class="main">:=</span><span class="bound">ffi'</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> <span class="bound">res</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app5"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">es</span> <span class="bound">vs</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate_list</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span> <span class="main">⟹</span>
do_app <span class="main">(</span><span class="main">(</span>refs   <span class="bound">s2</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>ffi   <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="bound">op0</span> <span class="main">(</span>List.rev <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> None <span class="main">⟹</span>
<span class="bound">op0</span> <span class="main">≠</span> Opapp
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>App <span class="bound">op0</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"app6"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">es</span> <span class="bound">err</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate_list</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>List.rev <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>App <span class="bound">op0</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"log1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">v1</span> <span class="bound">e'</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">⟹</span>
do_log <span class="bound">op0</span> <span class="bound">v1</span> <span class="bound">e2</span> <span class="main">=</span> Some <span class="main">(</span>Exp <span class="bound">e'</span><span class="main">)</span> <span class="main">⟹</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">e'</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Log <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"log2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">v1</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span>do_log <span class="bound">op0</span> <span class="bound">v1</span> <span class="bound">e2</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">bv</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Log <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">bv</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"log3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">v1</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span>do_log <span class="bound">op0</span> <span class="bound">v1</span> <span class="bound">e2</span> <span class="main">=</span> None<span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Log <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"log4"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Log <span class="bound">op0</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"if1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="bound">v1</span> <span class="bound">e'</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">⟹</span>
do_if <span class="bound">v1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="main">=</span> Some <span class="bound">e'</span> <span class="main">⟹</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">e'</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>If <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"if2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="bound">v1</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span>do_if <span class="bound">v1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="main">=</span> None<span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>If <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"if3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>If <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">e3</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"mat1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">v1</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">⟹</span>
match_result <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">v1</span> <span class="bound">pes</span> Bindv <span class="main">=</span> Rval <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">)</span> <span class="main">⟹</span>
<span class="free">evaluate</span> <span class="main">(</span><span class="bound">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="bound">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="bound">s2</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Mat <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"mat1b"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">v1</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">⟹</span>
match_result <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">v1</span> <span class="bound">pes</span> Bindv <span class="main">=</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Mat <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"mat2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">pes</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Mat <span class="bound">e</span> <span class="bound">pes</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"let1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">n</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">v1</span> <span class="bound">bv</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">⟹</span>
<span class="free">evaluate</span> <span class="main">(</span> <span class="bound">env</span> <span class="main">(|</span> sem_env.v <span class="main">:=</span> <span class="main">(</span>nsOptBind <span class="bound">n</span> <span class="bound">v1</span><span class="main">(</span>sem_env.v   <span class="bound">env</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span> <span class="bound">s2</span> <span class="bound">e2</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span>Let <span class="bound">n</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"let2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">n</span> <span class="bound">e1</span> <span class="bound">e2</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e1</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Let <span class="bound">n</span> <span class="bound">e1</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"letrec1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">funs</span> <span class="bound">e</span> <span class="bound">bv</span> <span class="bound">s</span><span class="main">.</span>
distinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">x</span> <span class="main">)</span><span class="main">)</span> <span class="bound">funs</span><span class="main">)</span> <span class="main">⟹</span>
<span class="free">evaluate</span> <span class="main">(</span> <span class="bound">env</span> <span class="main">(|</span> sem_env.v <span class="main">:=</span> <span class="main">(</span>build_rec_env <span class="bound">funs</span> <span class="bound">env</span><span class="main">(</span>sem_env.v   <span class="bound">env</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">e</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Letrec <span class="bound">funs</span> <span class="bound">e</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"letrec2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">funs</span> <span class="bound">e</span> <span class="bound">s</span><span class="main">.</span>
<span class="main">¬</span> <span class="main">(</span>distinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>
  <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">x</span> <span class="main">)</span><span class="main">)</span> <span class="bound">funs</span><span class="main">)</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Letrec <span class="bound">funs</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"tannot"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">t0</span> <span class="bound">s</span> <span class="bound">bv</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Tannot <span class="bound">e</span> <span class="bound">t0</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"locannot"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">l</span> <span class="bound">s</span> <span class="bound">bv</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="bound">bv</span>
<span class="main">==&gt;</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span>Lannot <span class="bound">e</span> <span class="bound">l</span><span class="main">)</span> <span class="bound">bv</span> "</span></span>

<span class="main">|</span>

<span class="quoted">"empty"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">s</span><span class="main">.</span>

<span class="free">evaluate_list</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">[]</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> Rval <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons1"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">es</span> <span class="bound">v1</span> <span class="bound">vs</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s3</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">⟹</span>
<span class="free">evaluate_list</span> <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">s3</span><span class="main">,</span> Rval <span class="bound">vs</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_list</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span><span class="bound">e</span> <span class="main">#</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s3</span><span class="main">,</span> Rval <span class="main">(</span><span class="bound">v1</span> <span class="main">#</span> <span class="bound">vs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons2"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">es</span> <span class="bound">err</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_list</span> <span class="bound">env</span> <span class="bound">s</span> <span class="main">(</span><span class="bound">e</span> <span class="main">#</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="main">|</span>

<span class="quoted">"cons3"</span> <span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span> <span class="bound">env</span> <span class="bound">e</span> <span class="bound">es</span> <span class="bound">v1</span> <span class="bound">err</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s3</span><span class="main">.</span>
<span class="free">evaluate</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span> Rval <span class="bound">v1</span><span class="main">)</span> <span class="main">⟹</span>
<span class="free">evaluate_list</span> <span class="bound">env</span> <span class="bound">s2</span> <span class="bound">es</span> <span class="main">(</span><span class="bound">s3</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>
<span class="main">==&gt;</span>
<span class="free">evaluate_list</span> <span class="bound">env</span> <span class="bound">s1</span> <span class="main">(</span><span class="bound">e</span> <span class="main">#</span> <span class="bound">es</span><span class="main">)</span> <span class="main">(</span><span class="bound">s3</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Big_Step_Unclocked-unclocked_sound"><span class="command">lemma</span></span> unclocked_sound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="free">v</span> <span class="free">s</span> <span class="free">es</span> <span class="free">bv</span> <span class="main">⟹</span> BigStep.evaluate_list False <span class="free">v</span> <span class="free">s</span> <span class="free">es</span> <span class="free">bv</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">v</span> <span class="free">s</span> <span class="free">e</span> <span class="free">bv'</span> <span class="main">⟹</span> BigStep.evaluate False <span class="free">v</span> <span class="free">s</span> <span class="free">e</span> <span class="free">bv'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate_list_evaluate.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>handle2 <span class="skolem">e'</span> <span class="skolem">env'</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> BigStep.handle2<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> match_result_sound_val<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>handle2b <span class="skolem">err</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">v1</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> BigStep.handle2<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> match_result_sound_err<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat1 <span class="skolem">e'</span> <span class="skolem">env'</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="skolem">bv</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> BigStep.mat1<span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> Bindv_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> match_result_sound_val<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat1b <span class="skolem">err</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> BigStep.mat1<span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> Bindv_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> match_result_sound_err<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_distinct_alt_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Big_Step_Unclocked-unclocked_complete0"><span class="command">lemma</span></span> unclocked_complete0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"BigStep.evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">bv</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">ck</span> <span class="main">⟹</span> <span class="main">(</span>
    <span class="keyword1">case</span> <span class="free">bv</span> <span class="keyword1">of</span>
        Rval <span class="bound">v</span> <span class="main">⇒</span>
          <span class="main">∃</span><span class="bound">e</span> <span class="bound">env'</span><span class="main">.</span>
            match_result <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> Rval <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span> <span class="main">∧</span>
            evaluate <span class="main">(</span><span class="free">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="bound">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">s</span> <span class="bound">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rval <span class="bound">v</span><span class="main">)</span>
      <span class="main">|</span> Rerr <span class="bound">err</span> <span class="main">⇒</span>
          <span class="main">(</span>match_result <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> Rerr <span class="bound">err</span><span class="main">)</span> <span class="main">∨</span>
          <span class="main">(</span><span class="main">∃</span><span class="bound">e</span> <span class="bound">env'</span><span class="main">.</span>
            match_result <span class="free">env</span> <span class="free">s</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> Rval <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span> <span class="main">∧</span>
            evaluate <span class="main">(</span><span class="free">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="bound">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">s</span> <span class="bound">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rerr <span class="bound">err</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"BigStep.evaluate_list <span class="free">ck</span> <span class="free">v</span> <span class="free">s</span> <span class="free">es</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">bv0</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">ck</span> <span class="main">⟹</span> evaluate_list <span class="free">v</span> <span class="free">s</span> <span class="free">es</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">bv0</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"BigStep.evaluate <span class="free">ck</span> <span class="free">v</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">bv</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">ck</span> <span class="main">⟹</span> evaluate <span class="free">v</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">bv</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>handle2 <span class="skolem">ck</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="skolem">s3</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bv</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rval <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> handle2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">env'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"match_result <span class="skolem">env</span> <span class="skolem">s2</span> <span class="skolem">v1</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="main">=</span> Rval <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="skolem">env'</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"evaluate <span class="main">(</span><span class="skolem">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="skolem">s2</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">s3</span><span class="main">,</span> Rval <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bv</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_list_evaluate.handle2<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> handle2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rerr <span class="skolem">err</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> handle2 <span class="keyword1"><span class="command">consider</span></span>
        <span class="main">(</span>match_err<span class="main">)</span> <span class="quoted"><span class="quoted">"match_result <span class="skolem">env</span> <span class="skolem">s2</span> <span class="skolem">v1</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="main">=</span> Rerr <span class="skolem">err</span>"</span></span> <span class="main">|</span>
        <span class="main">(</span>eval_err<span class="main">)</span> <span class="skolem">e</span> <span class="skolem">env'</span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"match_result <span class="skolem">env</span> <span class="skolem">s2</span> <span class="skolem">v1</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="main">=</span> Rval <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="skolem">env'</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"evaluate <span class="main">(</span><span class="skolem">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="skolem">s2</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">s3</span><span class="main">,</span> Rerr <span class="skolem">err</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> match_err
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evaluate_match <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">s2</span> <span class="skolem">v1</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="main">(</span><span class="skolem">s2</span><span class="main">,</span> Rerr <span class="skolem">err</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> match_result_sound_err<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evaluate_match <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">s2</span> <span class="skolem">v1</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="main">(</span><span class="skolem">s3</span><span class="main">,</span> Rerr <span class="skolem">err</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> handle2 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bv</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">=</span> <span class="skolem">s3</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_determ fst_conv<span class="main">)</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bv</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_list_evaluate.handle2b<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> handle2 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s2</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">using</span></span> match_err <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s2</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> eval_err
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bv</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_list_evaluate.handle2<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> handle2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="skolem">s3</span> <span class="skolem">v'</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="comment1">(* this is the same proof as above, but with less Isar and more apply *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> result.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Bindv_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_list_evaluate.mat1<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> match_result_sound_err<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">=</span> <span class="skolem">s3</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_list_evaluate.mat1b<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> evaluate_determ<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_list_evaluate.mat1<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat_cons1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">env'</span> <span class="skolem">v1</span> <span class="skolem">p</span> <span class="skolem">pes</span> <span class="skolem">e</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">err_v</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> result.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat_cons2 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">v1</span> <span class="skolem">p</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">s</span> <span class="skolem">err_v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> result.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_distinct_alt_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_list_evaluate.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Unclocked-unclocked_complete"><span class="command">lemma</span></span> unclocked_complete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"BigStep.evaluate_list False <span class="free">v</span> <span class="free">s</span> <span class="free">es</span> <span class="free">bv'</span> <span class="main">⟹</span> evaluate_list <span class="free">v</span> <span class="free">s</span> <span class="free">es</span> <span class="free">bv'</span>"</span></span>
  <span class="quoted"><span class="quoted">"BigStep.evaluate False <span class="free">v</span> <span class="free">s</span> <span class="free">e</span> <span class="free">bv</span> <span class="main">⟹</span> evaluate <span class="free">v</span> <span class="free">s</span> <span class="free">e</span> <span class="free">bv</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">bv'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> unclocked_complete0<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">bv</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> unclocked_complete0<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Big_Step_Unclocked-unclocked_eq"><span class="command">lemma</span></span> unclocked_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="main">=</span> BigStep.evaluate_list False"</span></span>
  <span class="quoted"><span class="quoted">"evaluate <span class="main">=</span> BigStep.evaluate False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> unclocked_sound unclocked_complete <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1" id="Big_Step_Unclocked-unclocked_determ"><span class="command">lemma</span></span> unclocked_determ<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="free">r2a</span> <span class="main">⟹</span> evaluate_list <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="free">r2b</span> <span class="main">⟹</span> <span class="free">r2a</span> <span class="main">=</span> <span class="free">r2b</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">r3a</span> <span class="main">⟹</span> evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">r3b</span> <span class="main">⟹</span> <span class="free">r3a</span> <span class="main">=</span> <span class="free">r3b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> unclocked_eq evaluate_determ<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Big_Step_Clocked">
<div class="head">
<h1>Theory Big_Step_Clocked</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Lemmas about the clocked semantics"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Big_Step_Clocked
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="#Semantic_Extras">Semantic_Extras</a>
    <a href="#Big_Step_Total">Big_Step_Total</a>
    <a href="#Big_Step_Determ">Big_Step_Determ</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">―‹From HOL4 bigClockScript.sml›</span>

<span class="keyword1" id="Big_Step_Clocked-do_app_no_runtime_error"><span class="command">lemma</span></span> do_app_no_runtime_error<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"do_app <span class="main">(</span>refs <span class="free">s</span><span class="main">,</span> ffi <span class="free">s</span><span class="main">)</span> <span class="free">op0</span> <span class="main">(</span>rev <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="free">refs'</span><span class="main">,</span> <span class="free">ffi'</span><span class="main">)</span><span class="main">,</span> <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> op0.splits list.splits v.splits lit.splits if_splits word_size.splits
               eq_result.splits option.splits store_v.splits
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> store_alloc_def store_assign_def call_FFI_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> oracle_result.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> do_app.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Big_Step_Clocked-big_unclocked0"><span class="command">lemma</span></span> big_unclocked0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="free">r1</span> <span class="main">⟹</span> <span class="free">ck</span> <span class="main">=</span> False <span class="main">⟹</span> snd <span class="free">r1</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock <span class="main">(</span>fst <span class="free">r1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="free">r2</span> <span class="main">⟹</span> <span class="free">ck</span> <span class="main">=</span> False <span class="main">⟹</span> snd <span class="free">r2</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock <span class="main">(</span>fst <span class="free">r2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">r3</span> <span class="main">⟹</span> <span class="free">ck</span> <span class="main">=</span> False <span class="main">⟹</span> snd <span class="free">r3</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock <span class="main">(</span>fst <span class="free">r3</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.inducts<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> do_app_no_runtime_error<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> big_unclocked_notimeout<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_match False <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r1</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list False <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r2</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate False <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r3</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r3</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> big_unclocked0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">corollary</span></span> big_unclocked_unchanged<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_match False <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span> <span class="main">⟹</span> clock <span class="free">s</span> <span class="main">=</span> clock <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list False <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span> <span class="main">⟹</span> clock <span class="free">s</span> <span class="main">=</span> clock <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate False <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r3</span><span class="main">)</span> <span class="main">⟹</span> clock <span class="free">s</span> <span class="main">=</span> clock <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> big_unclocked0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Big_Step_Clocked-big_unclocked1"><span class="command">lemma</span></span> big_unclocked1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="free">r1</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">st'</span> <span class="bound">r</span><span class="main">.</span> <span class="free">r1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>
  <span class="main">⟶</span> evaluate_match False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="main">(</span><span class="bound">st'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="free">r2</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">st'</span> <span class="bound">r</span><span class="main">.</span> <span class="free">r2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>
  <span class="main">⟶</span> evaluate_list False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">es</span> <span class="main">(</span><span class="main">(</span><span class="bound">st'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">r3</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">st'</span> <span class="bound">r</span><span class="main">.</span> <span class="free">r3</span> <span class="main">=</span> <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>
 <span class="main">⟶</span> evaluate False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="bound">st'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cnt</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">cnt</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">cnt</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.inducts<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-big_unclocked_ignore"><span class="command">lemma</span></span> big_unclocked_ignore<span class="main">:</span>
 <span class="quoted"><span class="quoted">"evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="free">st'</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r1</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">⟹</span>
    evaluate_match False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="free">st'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="main">(</span><span class="free">st'</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r2</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">⟹</span>
    evaluate_list False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">es</span> <span class="main">(</span><span class="free">st'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
 <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">st'</span><span class="main">,</span> <span class="free">r3</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r3</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">⟹</span>
    evaluate False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="free">st'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">,</span> <span class="free">r3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> big_unclocked1<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">assumption</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-big_unclocked"><span class="command">lemma</span></span> big_unclocked<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate False <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate False <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> clock <span class="free">s</span> <span class="main">=</span> clock <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">count1</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">count1</span> <span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">count2</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">count2</span> <span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms big_unclocked0<span class="main">(</span>3<span class="main">)</span> big_unclocked_ignore<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Big_Step_Clocked-add_to_counter0"><span class="command">lemma</span></span> add_to_counter0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="free">r1</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r'</span> <span class="bound">extra</span><span class="main">.</span> <span class="main">(</span><span class="free">r1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r'</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ck</span> <span class="main">=</span> True<span class="main">)</span>
   <span class="main">⟶</span> evaluate_match True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span><span class="main">+</span><span class="bound">extra</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span><span class="main">+</span> <span class="bound">extra</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="free">r2</span> <span class="main">⟹</span>  <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r'</span> <span class="bound">extra</span><span class="main">.</span> <span class="main">(</span><span class="free">r2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r'</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ck</span> <span class="main">=</span> True<span class="main">)</span>
   <span class="main">⟶</span> evaluate_list True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span><span class="main">+</span><span class="bound">extra</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">es</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span><span class="main">+</span> <span class="bound">extra</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">r3</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r'</span> <span class="bound">extra</span><span class="main">.</span> <span class="main">(</span><span class="free">r3</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r'</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ck</span> <span class="main">=</span> True<span class="main">)</span>
   <span class="main">⟶</span> evaluate True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span><span class="main">+</span><span class="bound">extra</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span><span class="main">+</span> <span class="bound">extra</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.inducts<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> add_to_counter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_match True <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r1</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">⟹</span>
     evaluate_match True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> clock <span class="free">s</span> <span class="main">+</span> <span class="free">extra</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> clock <span class="free">s'</span> <span class="main">+</span> <span class="free">extra</span> <span class="main">⦈</span><span class="main">)</span><span class="main">,</span> <span class="free">r1</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list True <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r2</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">⟹</span>
     evaluate_list True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span><span class="main">+</span><span class="free">extra</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">es</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="free">s'</span><span class="main">)</span><span class="main">+</span> <span class="free">extra</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="free">r2</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate True <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r3</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r3</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">⟹</span>
     evaluate True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span><span class="main">+</span><span class="free">extra</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">(</span>clock <span class="free">s'</span><span class="main">)</span><span class="main">+</span> <span class="free">extra</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="free">r3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_to_counter0<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">assumption</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-add_clock"><span class="command">lemma</span></span> add_clock<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="free">r1</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="free">r1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> False
   <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> evaluate_match True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">c</span> <span class="main">|)</span><span class="main">)</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="free">r2</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="free">r2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> False
   <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> evaluate_list True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">c</span> <span class="main">|)</span><span class="main">)</span> <span class="free">es</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">r3</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="free">r3</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> False
   <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> evaluate True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">c</span> <span class="main">|)</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_match_evaluate_list_evaluate.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> app1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s' r' c c'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> add_to_counter<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> extra <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>add_to_counter<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-clock_monotone"><span class="command">lemma</span></span> clock_monotone<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="free">r1</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r'</span><span class="main">.</span> <span class="free">r1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ck</span><span class="main">=</span>True<span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="free">r2</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r'</span><span class="main">.</span> <span class="free">r2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ck</span> <span class="main">=</span> True<span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">r3</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r'</span><span class="main">.</span> <span class="free">r3</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ck</span> <span class="main">=</span> True<span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_match_evaluate_list_evaluate.inducts<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Big_Step_Clocked-big_clocked_unclocked_equiv"><span class="command">lemma</span></span> big_clocked_unclocked_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate False <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r1</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> evaluate True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">c</span> <span class="main">|)</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r1</span><span class="main">)</span> <span class="main">∧</span>
        <span class="free">r1</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock   <span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> big_unclocked_unchanged<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> big_unclocked_unchanged big_unclocked_notimeout add_clock<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE exE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> big_unclocked_ignore<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> big_unclocked state.record_simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-big_clocked_timeout_0"><span class="command">lemma</span></span> big_clocked_timeout_0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="free">r1</span>  <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span><span class="main">.</span> <span class="free">r1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span>Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> True <span class="main">⟶</span> <span class="main">(</span>clock <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="free">r2</span>  <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span><span class="main">.</span> <span class="free">r2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span>Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> True <span class="main">⟶</span> <span class="main">(</span>clock <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">r3</span>  <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span><span class="main">.</span> <span class="free">r3</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span>Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> True <span class="main">⟶</span> <span class="main">(</span>clock <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_match_evaluate_list_evaluate.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> app4
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>do_app_no_runtime_error<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-big_clocked_unclocked_equiv_timeout"><span class="command">lemma</span></span> big_clocked_unclocked_equiv_timeout<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">¬</span>evaluate False <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> evaluate True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="bound">c</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span>Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">rule</span>
  <span class="keyword3"><span class="command">assume</span></span> l<span class="main">:</span><span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span><span class="quoted"><span class="quoted">"evaluate True <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> evaluate_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l big_unclocked_ignore<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> e<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> state.record_simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock <span class="skolem">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r e big_clocked_timeout_0<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> evaluate True <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> clock <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> big_clocked_unclocked_equiv eq_snd_iff evaluate_determ<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-sub_from_counter"><span class="command">lemma</span></span> sub_from_counter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_match <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="free">r1</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">count</span> <span class="bound">count'</span> <span class="bound">s'</span> <span class="bound">r'</span><span class="main">.</span>
    <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="bound">count</span> <span class="main">+</span> <span class="free">extra1</span> <span class="main">∧</span>
    <span class="free">r1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="bound">count'</span> <span class="main">+</span> <span class="free">extra1</span> <span class="main">∧</span>
    <span class="free">ck</span> <span class="main">=</span> True <span class="main">⟶</span>
    evaluate_match True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">count</span> <span class="main">|)</span><span class="main">)</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">count'</span> <span class="main">|)</span> <span class="main">)</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">es</span> <span class="free">r2</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">count</span> <span class="bound">count'</span> <span class="bound">s'</span> <span class="bound">r'</span><span class="main">.</span>
    <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="bound">count</span> <span class="main">+</span> <span class="free">extra2</span> <span class="main">∧</span>
    <span class="free">r2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="bound">count'</span> <span class="main">+</span> <span class="free">extra2</span> <span class="main">∧</span>
    <span class="free">ck</span> <span class="main">=</span> True <span class="main">⟶</span>
    evaluate_list True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">count</span> <span class="main">|)</span><span class="main">)</span> <span class="free">es</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">count'</span> <span class="main">|)</span> <span class="main">)</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">r3</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">count</span> <span class="bound">count'</span> <span class="bound">s'</span> <span class="bound">r'</span><span class="main">.</span>
    <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="bound">count</span> <span class="main">+</span> <span class="free">extra3</span> <span class="main">∧</span>
    <span class="free">r3</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="bound">count'</span> <span class="main">+</span> <span class="free">extra3</span> <span class="main">∧</span>
    <span class="free">ck</span> <span class="main">=</span> True <span class="main">⟶</span>
    evaluate True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">count</span> <span class="main">|)</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">count'</span> <span class="main">|)</span> <span class="main">)</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">extra1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">extra2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">extra3</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_match_evaluate_list_evaluate.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>handle2 <span class="skolem">ck</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">extra3</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">-</span><span class="skolem">extra3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>clock_monotone<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">es</span> <span class="skolem">vs</span> <span class="skolem">env'</span> <span class="skolem">e</span> <span class="skolem">bv</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">-</span><span class="main">1</span><span class="main">≥</span><span class="skolem">extra3</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">-</span><span class="skolem">extra3</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>clock_monotone<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>log1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">op0</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v1</span> <span class="skolem">e'</span> <span class="skolem">bv</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">≥</span><span class="skolem">extra3</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">-</span><span class="skolem">extra3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>clock_monotone<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span> <span class="skolem">v1</span> <span class="skolem">e'</span> <span class="skolem">bv</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">≥</span><span class="skolem">extra3</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">-</span><span class="skolem">extra3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_match_evaluate_list_evaluate.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>clock_monotone<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">pes</span> <span class="skolem">v1</span> <span class="skolem">bv</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">≥</span><span class="skolem">extra3</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">-</span><span class="skolem">extra3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>clock_monotone<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>let1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">n</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">v1</span> <span class="skolem">bv</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">≥</span><span class="skolem">extra3</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">-</span><span class="skolem">extra3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>clock_monotone<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons1 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">es</span> <span class="skolem">v1</span> <span class="skolem">vs</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">≥</span><span class="skolem">extra2</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">-</span><span class="skolem">extra2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>clock_monotone<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons3 <span class="skolem">ck</span> <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">es</span> <span class="skolem">v1</span> <span class="skolem">err</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">≥</span><span class="skolem">extra2</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="skolem">s2</span><span class="main">)</span><span class="main">-</span><span class="skolem">extra2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>clock_monotone<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_match_evaluate_list_evaluate.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-clocked_min_counter"><span class="command">lemma</span></span> clocked_min_counter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>clock   <span class="free">s'</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span>clock   <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>clock_monotone<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">thm</span></span> sub_from_counter<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sub_from_counter<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-dec_evaluate_not_timeout"><span class="command">lemma</span></span> dec_evaluate_not_timeout<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_dec False <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate_dec False <span class="free"><span class="free"><span class="free">mn</span></span></span> <span class="free"><span class="free"><span class="free">env</span></span></span> <span class="free"><span class="free"><span class="free">s</span></span></span> <span class="free"><span class="free"><span class="free">d</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">s'</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="free"><span class="free"><span class="free">r</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> big_unclocked_notimeout<span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-dec_unclocked_ignore"><span class="command">lemma</span></span> dec_unclocked_ignore<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_dec <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="free">res</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r</span> <span class="bound">count</span><span class="main">.</span> <span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">⟶</span>
    evaluate_dec False <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">count</span> <span class="main">|)</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">count</span> <span class="main">|)</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_dec.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> dtype1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_dec.intros state.record_simps<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dexn1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_dec.intros state.record_simps<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_left sup_bot.left_neutral<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_dec.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>big_unclocked_ignore<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Big_Step_Clocked-dec_unclocked_1"><span class="command">lemma</span></span> dec_unclocked_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_dec False <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock   <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> big_unclocked_notimeout big_unclocked_unchanged<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Big_Step_Clocked-dec_unclocked_2"><span class="command">lemma</span></span> dec_unclocked_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_dec False <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">count1</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">count1</span> <span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_dec False <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">count2</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">count2</span> <span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dec_evaluate_not_timeout <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms dec_unclocked_ignore<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-dec_unclocked"><span class="command">lemma</span></span> dec_unclocked<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>evaluate_dec False <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock   <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span>evaluate_dec False <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count1</span> <span class="main">|)</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count1</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">⟶</span>
   evaluate_dec False <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count2</span> <span class="main">|)</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count2</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dec_unclocked_1 dec_unclocked_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> big_clocked_unclocked_equiv_timeout_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">¬</span> evaluate False <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> evaluate True <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">c</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> clock <span class="bound">s'</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> big_clocked_unclocked_equiv_timeout <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Big_Step_Clocked-not_evaluate_dec_timeout"><span class="command">lemma</span></span> not_evaluate_dec_timeout<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">¬</span>evaluate_dec False <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> evaluate_dec True <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="bound">r</span> <span class="main">∧</span> snd <span class="bound">r</span> <span class="main">=</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dlet <span class="skolem">locs</span> <span class="skolem">p</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> evaluate False <span class="free">env</span> <span class="free">s</span> <span class="skolem">e</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="skolem">p</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">hypsubst_thin</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s' r
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">hypsubst_thin</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> v
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pmatch<span class="main">(</span>c   <span class="free">env</span><span class="main">)</span><span class="main">(</span>refs   <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">v</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Dlet <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_dec.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Dlet <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dlet5<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Dlet <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dlet4<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">note</span></span> big_clocked_unclocked_equiv_timeout_1<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> clock <span class="free">s</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evaluate True <span class="free">env</span> <span class="free">s</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="skolem">p</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> dlet4<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms Dlet <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Dlet
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dlet5<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_dec.intros assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-dec_clocked_total"><span class="command">lemma</span></span> dec_clocked_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">res</span><span class="main">.</span> evaluate_dec True <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="bound">res</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dlet <span class="skolem">locs</span> <span class="skolem">p</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span><span class="quoted"><span class="quoted">"evaluate True <span class="free">env</span> <span class="free">s</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_total<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Dlet
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Lem_list.allDistinct <span class="main">(</span>pat_bindings <span class="skolem">p</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> e <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> v
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">hypsubst_thin</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pmatch<span class="main">(</span>c   <span class="free">env</span><span class="main">)</span><span class="main">(</span>refs   <span class="skolem">s'</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">v</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> evaluate_dec.intros <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">using</span></span> evaluate_dec.intros <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_dec.intros <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_dec.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-dec_clocked_min_counter"><span class="command">lemma</span></span> dec_clocked_min_counter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_dec <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="free">res</span> <span class="main">⟹</span> <span class="free">ck</span> <span class="main">=</span> True <span class="main">⟹</span>
   evaluate_dec <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>clock   <span class="main">(</span>fst <span class="free">res</span><span class="main">)</span><span class="main">)</span><span class="main">|)</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>fst <span class="free">res</span><span class="main">)</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">0</span><span class="main">|)</span><span class="main">)</span><span class="main">,</span> snd <span class="free">res</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_dec.inducts<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dtype1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> state.record_simps<span class="main">(</span>4<span class="main">)</span> evaluate_dec.intros
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dexn1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_dec.intros state.record_simps<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_left sup_bot.left_neutral<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_dec.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>clocked_min_counter<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-dec_sub_from_counter"><span class="command">lemma</span></span> dec_sub_from_counter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_dec <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="free">res</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">count</span> <span class="bound">count'</span> <span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="bound">count</span> <span class="main">+</span> <span class="free">extra</span> <span class="main">∧</span> <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="bound">count'</span> <span class="main">+</span> <span class="free">extra</span> <span class="main">∧</span> <span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> True <span class="main">⟶</span>
     evaluate_dec <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">count</span> <span class="main">|)</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">count'</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_dec.inducts<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dtype1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_dec.intros state.record_simps<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dtype2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> evaluate_dec.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dexn1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_dec.intros state.record_simps<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_left sup_bot.left_neutral<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_dec.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sub_from_counter<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-dec_clock_monotone"><span class="command">lemma</span></span> dec_clock_monotone<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_dec <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="free">res</span> <span class="main">⟹</span> <span class="free">ck</span> <span class="main">=</span> True <span class="main">⟹</span> <span class="main">(</span>clock   <span class="main">(</span>fst <span class="free">res</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_dec.inducts<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>clock_monotone<span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-dec_add_clock"><span class="command">lemma</span></span> dec_add_clock<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_dec <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="free">res</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> <span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> False <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> evaluate_dec True <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">c</span> <span class="main">|)</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate_dec.inducts<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> dlet1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> add_clock<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">|</span></span><span class="operator">rule</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dlet2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> add_clock<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dlet3
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> add_clock<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dlet4
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_dec.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dlet5
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> add_clock<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dletrec1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dletrec2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dtype1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> evaluate_dec.dtype1 state.record_simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dtype2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dtabbrev
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dexn1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_dec.intros state.record_simps<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_left sup_bot.left_neutral<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> dexn2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-dec_add_to_counter"><span class="command">lemma</span></span> dec_add_to_counter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_dec <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="free">res</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r</span> <span class="bound">extra</span><span class="main">.</span> <span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> True <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">⟶</span>
     evaluate_dec True <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="bound">extra</span> <span class="main">|)</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span> <span class="main">+</span> <span class="bound">extra</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_dec.inducts<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dtype1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_dec.intros state.record_simps<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> dexn1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_dec.intros state.record_simps<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_left sup_bot.left_neutral<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_dec.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>add_to_counter<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-dec_unclocked_unchanged"><span class="command">lemma</span></span> dec_unclocked_unchanged<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_dec <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">ck</span> <span class="main">=</span> False <span class="main">⟹</span> <span class="main">(</span>snd <span class="free">r</span><span class="main">)</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock   <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate_dec.inducts<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> big_unclocked_notimeout big_clocked_unclocked_equiv<span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-dec_clocked_unclocked_equiv"><span class="command">lemma</span></span> dec_clocked_unclocked_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_dec False <span class="free">mn</span> <span class="free">env</span> <span class="free">s1</span> <span class="free">d</span> <span class="main">(</span><span class="free">s2</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> evaluate_dec True <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s1</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">c</span> <span class="main">|)</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="free">s2</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">∧</span>
       <span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock   <span class="free">s1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock   <span class="free">s2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>dec_unclocked_unchanged dec_add_clock<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> dec_unclocked_ignore
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="comment1">(* sledgehammer proof *)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
      f1<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate_dec True <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">nn</span><span class="main">)</span> <span class="free">s1</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="free">s2</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> clock <span class="free">s1</span> <span class="main">=</span> clock <span class="free">s2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> evaluate_dec True <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">c</span><span class="main">)</span> <span class="free">s1</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="free">s2</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> clock <span class="free">s1</span> <span class="main">=</span> clock <span class="free">s2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> evaluate_dec False <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="bound">na</span><span class="main">.</span> <span class="bound">n</span><span class="main">)</span> <span class="free">s1</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="bound">na</span><span class="main">.</span> <span class="bound">n</span><span class="main">)</span> <span class="free">s2</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dec_unclocked_ignore
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> f1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> state.record_simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-decs_add_clock"><span class="command">lemma</span></span> decs_add_clock<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_decs <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">ds</span> <span class="free">res</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> <span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> False <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> evaluate_decs True <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">c</span> <span class="main">|)</span><span class="main">)</span> <span class="free">ds</span> <span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_decs.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> cons1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> dec_add_clock evaluate_decs.cons1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> cons2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> dec_add_clock<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> dec_add_to_counter<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> evaluate_decs.cons2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_decs.intros<span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-decs_evaluate_not_timeout"><span class="command">lemma</span></span> decs_evaluate_not_timeout<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_decs <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">ds</span> <span class="free">r</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r'</span><span class="main">.</span> <span class="free">ck</span> <span class="main">=</span> False <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">r'</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_decs.inducts<span class="main">)</span>
     <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="improper">r</span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>dec_evaluate_not_timeout<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-decs_unclocked_unchanged"><span class="command">lemma</span></span> decs_unclocked_unchanged<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_decs <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">ds</span> <span class="free">r</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r'</span><span class="main">.</span> <span class="free">ck</span> <span class="main">=</span> False <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">r'</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_decs.inducts<span class="main">)</span>
     <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="improper">r</span></span></span></span></span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dec_unclocked_unchanged <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>dec_evaluate_not_timeout<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-decs_unclocked_ignore"><span class="command">lemma</span></span> decs_unclocked_ignore<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_decs <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="free">res</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r</span> <span class="bound">count</span><span class="main">.</span> <span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">⟶</span>
    evaluate_decs False <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">count</span> <span class="main">|)</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">count</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_decs.inducts<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>evaluate_decs.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dec_unclocked_ignore<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Big_Step_Clocked-decs_unclocked_2"><span class="command">lemma</span></span> decs_unclocked_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_decs False <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count1</span> <span class="main">|)</span><span class="main">)</span> <span class="free">ds</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count1</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_decs False <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count2</span> <span class="main">|)</span><span class="main">)</span> <span class="free">ds</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count2</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> decs_unclocked_ignore<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> assms decs_evaluate_not_timeout <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Big_Step_Clocked-decs_unclocked"><span class="command">lemma</span></span> decs_unclocked<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>evaluate_decs False <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">ds</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock   <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span>evaluate_decs False <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count1</span> <span class="main">|)</span><span class="main">)</span> <span class="free">ds</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count1</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">=</span>
   evaluate_decs False <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count2</span> <span class="main">|)</span><span class="main">)</span> <span class="free">ds</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count2</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>decs_unclocked_unchanged decs_unclocked_2<span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-not_evaluate_decs_timeout"><span class="command">lemma</span></span> not_evaluate_decs_timeout<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">¬</span>evaluate_decs False <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">ds</span> <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> evaluate_decs True <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">ds</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">mn</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms evaluate_decs.intros <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">ds</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span><span class="quoted"><span class="quoted">"evaluate_dec True <span class="skolem">mn</span> <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">d</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dec_clocked_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rval <span class="skolem">new_env</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> evaluate_decs False <span class="skolem">mn</span> <span class="main">(</span>extend_dec_env <span class="skolem">new_env</span> <span class="skolem">env</span><span class="main">)</span> <span class="skolem">s'</span> <span class="skolem">ds</span> <span class="main">(</span><span class="skolem">s3</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s3</span> <span class="skolem">r</span>

    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"evaluate_decs False <span class="skolem">mn</span> <span class="main">(</span>extend_dec_env <span class="skolem">new_env</span> <span class="skolem">env</span><span class="main">)</span> <span class="skolem">s'</span> <span class="skolem">ds</span> <span class="main">(</span><span class="skolem">s3</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evaluate_decs False <span class="skolem">mn</span> <span class="main">(</span>extend_dec_env <span class="skolem">new_env</span> <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s'</span> <span class="main">⦇</span>clock <span class="main">:=</span> <span class="main">(</span>clock <span class="skolem">s</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="skolem">ds</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s3</span> <span class="main">⦇</span>clock <span class="main">:=</span> <span class="main">(</span>clock <span class="skolem">s</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> decs_unclocked decs_unclocked_ignore <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evaluate_dec False <span class="skolem">mn</span> <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">d</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s'</span> <span class="main">⦇</span>clock <span class="main">:=</span> <span class="main">(</span>clock <span class="skolem">s</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span><span class="main">,</span> Rval <span class="skolem">new_env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dec_unclocked_ignore
        <span class="keyword1"><span class="command">unfolding</span></span> Rval
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> result.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> state.record_simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> evaluate_decs.cons2 Cons
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> evaluate_decs.cons2 d
      <span class="keyword1"><span class="command">unfolding</span></span> Rval
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> combine_dec_result.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rerr <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> Rabort Rtimeout_error"</span></span>

    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≠</span> Rabort Rtimeout_error"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_dec False <span class="skolem">mn</span> <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">d</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dec_unclocked_ignore<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> count<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"clock <span class="skolem">s</span>"</span></span><span class="main">]</span> d Rerr state.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">unfolding</span></span> Rerr
        <span class="keyword1"><span class="command">using</span></span> Cons evaluate_decs.cons1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> d evaluate_decs.cons1 Rerr <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-decs_clocked_total"><span class="command">lemma</span></span> decs_clocked_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">res</span><span class="main">.</span> evaluate_decs True <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">ds</span> <span class="bound">res</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">mn</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_decs.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">ds</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span><span class="quoted"><span class="quoted">"evaluate_dec True <span class="skolem">mn</span> <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">d</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dec_clocked_total
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds<span class="main">:</span><span class="quoted"><span class="quoted">"evaluate_decs True <span class="skolem">mn</span> <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">ds</span> <span class="main">(</span><span class="skolem">s''</span><span class="main">,</span><span class="skolem">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> d ds <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_decs.intros Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-decs_clock_monotone"><span class="command">lemma</span></span> decs_clock_monotone<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_decs <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="free">res</span> <span class="main">⟹</span> <span class="free">ck</span> <span class="main">=</span> True <span class="main">⟹</span> <span class="main">(</span>clock <span class="main">(</span>fst <span class="free">res</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>clock <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_decs.inducts<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>dec_clock_monotone<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-decs_sub_from_counter"><span class="command">lemma</span></span> decs_sub_from_counter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_decs <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="free">res</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">extra</span> <span class="bound">count</span> <span class="bound">count'</span> <span class="bound">s'</span> <span class="bound">r'</span><span class="main">.</span>
    <span class="main">(</span>clock <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="bound">count</span> <span class="main">+</span> <span class="bound">extra</span> <span class="main">∧</span> <span class="main">(</span>clock <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="bound">count'</span> <span class="main">+</span> <span class="bound">extra</span> <span class="main">∧</span>
    <span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> True <span class="main">⟶</span> evaluate_decs <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="bound">count</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="bound">count'</span> <span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_decs.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons2 <span class="skolem">ck</span> <span class="skolem">mn</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s3</span> <span class="skolem">env</span> <span class="skolem">d</span> <span class="skolem">ds</span> <span class="skolem">new_env</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> extra
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"clock <span class="skolem">s2</span><span class="main">≥</span><span class="skolem">extra</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> dec_sub_from_counter diff_add_inverse2 eq_diff_iff evaluate_decs.cons2 le_add2<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> decs_clock_monotone <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>evaluate_decs.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dec_sub_from_counter<span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-decs_clocked_min_counter"><span class="command">lemma</span></span> decs_clocked_min_counter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_decs <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">ds</span> <span class="free">res</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ck</span> <span class="main">=</span> True"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_decs <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> clock <span class="free">s</span> <span class="main">-</span> <span class="main">(</span>clock <span class="main">(</span>fst <span class="free">res</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="free">ds</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>fst <span class="free">res</span><span class="main">)</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>snd <span class="free">res</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"clock <span class="main">(</span>fst <span class="free">res</span><span class="main">)</span> <span class="main">≤</span> clock <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> decs_clock_monotone <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> decs_sub_from_counter<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-decs_add_to_counter"><span class="command">lemma</span></span> decs_add_to_counter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_decs <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="free">res</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r</span> <span class="bound">extra</span><span class="main">.</span> <span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> True <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">⟶</span>
    evaluate_decs True <span class="free">mn</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> clock <span class="free">s</span> <span class="main">+</span> <span class="bound">extra</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> clock <span class="bound">s'</span> <span class="main">+</span> <span class="bound">extra</span> <span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_decs.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> cons2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> dec_add_to_counter evaluate_decs.cons2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
 <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>evaluate_decs.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dec_add_to_counter<span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-top_evaluate_not_timeout"><span class="command">lemma</span></span> top_evaluate_not_timeout<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_top False <span class="free">env</span> <span class="free">s</span> <span class="free">tp</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate_top False <span class="free"><span class="free"><span class="free">env</span></span></span> <span class="free"><span class="free"><span class="free">s</span></span></span> <span class="free"><span class="free"><span class="free">tp</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">s'</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="free"><span class="free"><span class="free">r</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>dec_evaluate_not_timeout decs_evaluate_not_timeout<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-top_unclocked_ignore"><span class="command">lemma</span></span> top_unclocked_ignore<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_top <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">tp</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_top False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">tp</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tmod1 <span class="skolem">s2</span> <span class="skolem">ds</span> <span class="skolem">mn</span> <span class="skolem">specs</span> <span class="skolem">new_env</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> tmod1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">mn</span><span class="main">]</span> <span class="main">∉</span> defined_mods <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">cnt</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> tmod1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evaluate_decs False <span class="main">[</span><span class="skolem">mn</span><span class="main">]</span> <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">cnt</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">ds</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">cnt</span><span class="main">)</span> <span class="skolem">s2</span><span class="main">,</span> Rval <span class="skolem">new_env</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> decs_unclocked_ignore <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tmod1
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> evaluate_top.tmod1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> conjI<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> tmod1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> tmod2 <span class="comment1">(* this is the same as tmod1 *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> state.record_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>decs_unclocked_ignore <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_top.tmod2<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tmod3 <span class="skolem">ds</span> <span class="skolem">mn</span> <span class="skolem">specs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_top.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>evaluate_top.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dec_unclocked_ignore<span class="main">)</span>


<span class="keyword1" id="Big_Step_Clocked-top_unclocked"><span class="command">lemma</span></span> top_unclocked<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>evaluate_top False <span class="free">env</span> <span class="free">s</span> <span class="free">tp</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock   <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span>evaluate_top False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count1</span> <span class="main">|)</span><span class="main">)</span> <span class="free">tp</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count1</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">=</span>
    evaluate_top False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count2</span> <span class="main">|)</span><span class="main">)</span> <span class="free">tp</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">count2</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">∧</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>top_evaluate_not_timeout<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate_top False <span class="free"><span class="free"><span class="free">env</span></span></span> <span class="free"><span class="free"><span class="free">s</span></span></span> <span class="free"><span class="free"><span class="free">tp</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">s'</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="free"><span class="free"><span class="free">r</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dec_unclocked decs_unclocked top_evaluate_not_timeout<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> top_unclocked_ignore<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> top_evaluate_not_timeout <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-not_evaluate_top_timeout"><span class="command">lemma</span></span> not_evaluate_top_timeout<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">¬</span>evaluate_top False <span class="free">env</span> <span class="free">s</span> <span class="free">tp</span> <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> evaluate_top True <span class="free">env</span> <span class="free">s</span> <span class="free">tp</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">tp</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tmod <span class="skolem">mn</span> <span class="skolem">specs</span> <span class="skolem">ds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ds<span class="main">:</span><span class="quoted"><span class="quoted">"no_dup_types <span class="skolem">ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Tmod assms tmod3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> mn<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">mn</span><span class="main">]</span> <span class="main">∉</span> defined_mods <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Tmod assms tmod4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> evaluate_decs False <span class="main">[</span><span class="skolem">mn</span><span class="main">]</span> <span class="free">env</span> <span class="free">s</span> <span class="skolem">ds</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s'</span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ds mn Tmod assms tmod1 tmod2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">" evaluate_decs True <span class="main">[</span><span class="skolem">mn</span><span class="main">]</span> <span class="free">env</span> <span class="free">s</span> <span class="skolem">ds</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> not_evaluate_decs_timeout<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Tmod
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tmod2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tdec <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> evaluate_dec False <span class="main">[]</span> <span class="free">env</span> <span class="free">s</span> <span class="skolem">d</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s'</span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> tdec1 tdec2 assms Tdec <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">" evaluate_dec True <span class="main">[]</span> <span class="free">env</span> <span class="free">s</span> <span class="skolem">d</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_evaluate_dec_timeout<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Tdec
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-top_clocked_total"><span class="command">lemma</span></span> top_clocked_total<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> evaluate_top True <span class="free">env</span> <span class="free">s</span> <span class="free">tp</span> <span class="bound">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">tp</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tmod <span class="skolem">mn</span> <span class="skolem">specs</span> <span class="skolem">ds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ds<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate_decs True <span class="main">[</span><span class="skolem">mn</span><span class="main">]</span> <span class="free">env</span> <span class="free">s</span> <span class="skolem">ds</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> decs_clocked_total<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> Tmod <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"no_dup_types <span class="skolem">ds</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
    <span class="keyword1"><span class="command">using</span></span> tmod3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">mn</span><span class="main">]</span> <span class="main">∈</span><span class="main">(</span>defined_mods <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> tmod4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> ds <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s' r
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> evaluate_top.tmod1 evaluate_top.tmod2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Tdec <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> evaluate_dec True <span class="main">[]</span> <span class="free">env</span> <span class="free">s</span> <span class="skolem">d</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dec_clocked_total<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Tdec
    <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s' r
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> evaluate_top.tdec1 evaluate_top.tdec2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-top_clocked_min_counter"><span class="command">lemma</span></span> top_clocked_min_counter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_top <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">tp</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ck</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_top <span class="free">ck</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> clock <span class="free">s</span> <span class="main">-</span> clock <span class="free">s'</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">tp</span> <span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">⦈</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> tmod1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> state.record_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_top.tmod1<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>decs_clocked_min_counter<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> tmod2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> state.record_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_top.tmod2<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>decs_clocked_min_counter<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_top.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>dec_clocked_min_counter<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-top_add_clock"><span class="command">lemma</span></span> top_add_clock<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_top <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">tp</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">ck</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> evaluate_top True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">c</span> <span class="main">|)</span><span class="main">)</span> <span class="free">tp</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tdec1 <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_dec True <span class="main">[]</span> <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="free">s'</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dec_add_clock assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tdec1
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tdec2 <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_dec True <span class="main">[]</span> <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="free">s'</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dec_add_clock assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tdec2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tmod1 <span class="skolem">s2</span> <span class="skolem">ds</span> <span class="skolem">mn</span> <span class="skolem">specs</span> <span class="skolem">new_env</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_decs True <span class="main">[</span><span class="skolem">mn</span><span class="main">]</span> <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">ds</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">s2</span><span class="main">,</span> Rval <span class="skolem">new_env</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> decs_add_clock assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tmod1
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> state.record_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_top.tmod1<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> tmod1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tmod2 <span class="skolem">s2</span> <span class="skolem">ds</span> <span class="skolem">mn</span> <span class="skolem">specs</span> <span class="skolem">err</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_decs True <span class="main">[</span><span class="skolem">mn</span><span class="main">]</span> <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">ds</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">s2</span><span class="main">,</span> Rerr <span class="skolem">err</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> decs_add_clock assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tmod2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> state.record_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_top.tmod2<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> tmod2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> tmod3
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_top.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> tmod4
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tmod4
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-top_clocked_unclocked_equiv"><span class="command">lemma</span></span> top_clocked_unclocked_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_top False <span class="free">env</span> <span class="free">s</span> <span class="free">tp</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> evaluate_top True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="bound">c</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">tp</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">⦈</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span>clock <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock <span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">=</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>top_add_clock top_unclocked <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>top_evaluate_not_timeout<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> top_unclocked_ignore
    <span class="comment1">(* sledgehammer proof *)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
      f1<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate_top True <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">nn</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">tp</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="free">s'</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> clock <span class="free">s</span> <span class="main">=</span> clock <span class="free">s'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> evaluate_top True <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">c</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">tp</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="free">s'</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> clock <span class="free">s</span> <span class="main">=</span> clock <span class="free">s'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> evaluate_top False <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="bound">na</span><span class="main">.</span> <span class="bound">n</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">tp</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="bound">na</span><span class="main">.</span> <span class="bound">n</span><span class="main">)</span> <span class="free">s'</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> top_unclocked_ignore
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> f1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> state.record_simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-top_clock_monotone"><span class="command">lemma</span></span> top_clock_monotone<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_top <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">tp</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ck</span> <span class="main">=</span> True <span class="main">⟹</span> <span class="main">(</span>clock   <span class="free">s'</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">ind_cases</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"evaluate_top <span class="free"><span class="free"><span class="free">ck</span></span></span> <span class="free"><span class="free"><span class="free">env</span></span></span> <span class="free"><span class="free"><span class="free">s</span></span></span> <span class="free"><span class="free"><span class="free">tp</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">s'</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="free"><span class="free"><span class="free">r</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>dec_clock_monotone decs_clock_monotone<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-top_sub_from_counter"><span class="command">lemma</span></span> top_sub_from_counter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_top <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">tp</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ck</span> <span class="main">=</span> True"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">cnt</span> <span class="main">+</span> <span class="free">extra</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>clock   <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="free">cnt'</span> <span class="main">+</span> <span class="free">extra</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_top <span class="free">ck</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">cnt</span> <span class="main">|)</span><span class="main">)</span> <span class="free">tp</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="free">cnt'</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> tmod1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> state.record_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_top.tmod1<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>decs_sub_from_counter<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> tmod2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> state.record_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_top.tmod2<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>decs_sub_from_counter<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_top.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dec_sub_from_counter<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-top_add_to_counter"><span class="command">lemma</span></span> top_add_to_counter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_top True <span class="free">env</span> <span class="free">s</span> <span class="free">d</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_top True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="free">extra</span> <span class="main">|)</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="free">s'</span><span class="main">)</span> <span class="main">+</span> <span class="free">extra</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">case</span></span> tmod1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> state.record_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_top.tmod1<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>decs_add_to_counter<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> tmod2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> state.record_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_top.tmod2<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>decs_add_to_counter<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_top.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>dec_add_to_counter<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-prog_clock_monotone"><span class="command">lemma</span></span> prog_clock_monotone<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_prog <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="free">res</span> <span class="main">⟹</span> <span class="free">ck</span> <span class="main">⟹</span> <span class="main">(</span>clock <span class="main">(</span>fst <span class="free">res</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>clock <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_prog.inducts<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>top_clock_monotone<span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-prog_unclocked_ignore"><span class="command">lemma</span></span> prog_unclocked_ignore<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_prog <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="free">res</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">cnt</span> <span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span> <span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>
    <span class="main">⟶</span> evaluate_prog False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">cnt</span> <span class="main">|)</span><span class="main">)</span> <span class="free">prog</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">cnt</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_prog.inducts<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>evaluate_prog.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>top_unclocked_ignore<span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-prog_unclocked_unchanged"><span class="command">lemma</span></span> prog_unclocked_unchanged<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_prog <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="free">res</span> <span class="main">⟹</span> <span class="main">¬</span><span class="free">ck</span> <span class="main">⟹</span><span class="main">(</span>snd <span class="free">res</span><span class="main">)</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock   <span class="main">(</span>fst <span class="free">res</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_prog.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons1 <span class="skolem">ck</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s3</span> <span class="skolem">env</span> <span class="skolem">top0</span> <span class="skolem">tops</span> <span class="skolem">new_env</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> cons1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"clock <span class="skolem">s1</span> <span class="main">=</span> clock <span class="skolem">s2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> top_unclocked <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> combine_dec_result.simps cons1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> top_clocked_unclocked_equiv<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Big_Step_Clocked-prog_unclocked_1"><span class="command">lemma</span></span> prog_unclocked_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_prog False <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock <span class="free">s</span> <span class="main">=</span> clock <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> prog_unclocked_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Big_Step_Clocked-prog_unclocked_2"><span class="command">lemma</span></span> prog_unclocked_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_prog False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt1</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">prog</span> <span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt1</span> <span class="main">⦈</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_prog False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt2</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">prog</span> <span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt2</span> <span class="main">⦈</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prog_unclocked_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> prog_unclocked_ignore assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-prog_unclocked"><span class="command">lemma</span></span> prog_unclocked<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>evaluate_prog False <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock <span class="free">s</span> <span class="main">=</span> clock <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span>evaluate_prog False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt1</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">prog</span> <span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt1</span> <span class="main">⦈</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">=</span>
   evaluate_prog False <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt2</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">prog</span> <span class="main">(</span><span class="free">s'</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="free">cnt2</span> <span class="main">⦈</span><span class="main">,</span><span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prog_unclocked_1 prog_unclocked_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Big_Step_Clocked-not_evaluate_prog_timeout"><span class="command">lemma</span></span> not_evaluate_prog_timeout<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">res</span><span class="main">.</span> <span class="main">¬</span>evaluate_prog False <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="bound">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> evaluate_prog True <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="bound">r</span> <span class="main">∧</span> snd <span class="bound">r</span> <span class="main">=</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">prog</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_prog.intros<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">top0</span> <span class="skolem">tops</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> top0<span class="main">:</span><span class="quoted"><span class="quoted">"evaluate_top True <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">top0</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> top_clocked_total<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rval <span class="skolem">new_env</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> evaluate_prog False <span class="main">(</span>extend_dec_env <span class="skolem">new_env</span> <span class="skolem">env</span><span class="main">)</span> <span class="skolem">s'</span> <span class="skolem">tops</span> <span class="main">(</span><span class="skolem">s3</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s3</span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> tops<span class="main">:</span><span class="quoted"><span class="quoted">"evaluate_prog False <span class="main">(</span>extend_dec_env <span class="skolem">new_env</span> <span class="skolem">env</span><span class="main">)</span> <span class="skolem">s'</span> <span class="skolem">tops</span> <span class="main">(</span><span class="skolem">s3</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prog_unclocked <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> top0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evaluate_top False <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">top0</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> clock <span class="skolem">s</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">,</span> Rval <span class="skolem">new_env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Rval <span class="keyword1"><span class="command">using</span></span> top_unclocked_ignore
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> result.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> state.record_simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> prog_unclocked_ignore<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> Cons.prems evaluate_prog.cons1 tops <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> evaluate_prog.cons1 top0 <span class="keyword1"><span class="command">unfolding</span></span> Rval
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> combine_dec_result.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rerr <span class="skolem">err</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">err</span> <span class="main">=</span> Rabort Rtimeout_error"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons top0 top_unclocked_ignore <span class="keyword1"><span class="command">unfolding</span></span> Rerr
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_prog.cons2 result.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> state.record_simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> top0 <span class="keyword1"><span class="command">unfolding</span></span> Rerr
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> evaluate_prog.cons2 snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-not_evaluate_whole_prog_timeout"><span class="command">lemma</span></span> not_evaluate_whole_prog_timeout<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">res</span><span class="main">.</span> <span class="main">¬</span>evaluate_whole_prog False <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="bound">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> evaluate_whole_prog True <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="bound">r</span> <span class="main">∧</span> snd <span class="bound">r</span> <span class="main">=</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"no_dup_mods <span class="free">prog</span> <span class="main">(</span>defined_mods <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"no_dup_top_types <span class="free">prog</span> <span class="main">(</span>defined_types <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> not_evaluate_prog_timeout assms  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Big_Step_Clocked-prog_add_to_counter"><span class="command">lemma</span></span> prog_add_to_counter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_prog <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="free">res</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s'</span> <span class="bound">r</span> <span class="bound">extra</span><span class="main">.</span> <span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> True <span class="main">∧</span>  <span class="bound">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">⟶</span>
    evaluate_prog True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="bound">extra</span> <span class="main">|)</span><span class="main">)</span> <span class="free">prog</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span> <span class="main">+</span> <span class="bound">extra</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_prog.inducts<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>evaluate_prog.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>top_add_to_counter<span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-prog_sub_from_counter"><span class="command">lemma</span></span> prog_sub_from_counter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_prog <span class="free">ck</span> <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="free">res</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">extra</span> <span class="bound">cnt</span> <span class="bound">cnt'</span> <span class="bound">s'</span> <span class="bound">r</span><span class="main">.</span>
     <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="bound">extra</span> <span class="main">+</span> <span class="bound">cnt</span> <span class="main">∧</span> <span class="main">(</span>clock   <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="bound">extra</span> <span class="main">+</span> <span class="bound">cnt'</span> <span class="main">∧</span> <span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ck</span> <span class="main">=</span> True <span class="main">⟶</span>
     evaluate_prog <span class="free">ck</span> <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span>  <span class="bound">cnt</span> <span class="main">|)</span><span class="main">)</span> <span class="free">prog</span> <span class="main">(</span><span class="main">(</span><span class="bound">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">cnt'</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_prog.inducts<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons1 <span class="skolem">ck</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s3</span> <span class="skolem">env</span> <span class="skolem">top0</span> <span class="skolem">tops</span> <span class="skolem">new_env</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> extra
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"clock   <span class="skolem">s2</span> <span class="main">≥</span> <span class="skolem">extra</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">extra</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>clock <span class="skolem">s2</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">extra</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>top_sub_from_counter <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>prog_clock_monotone<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>evaluate_prog.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>top_sub_from_counter<span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-prog_clocked_min_counter"><span class="command">lemma</span></span> prog_clocked_min_counter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_prog True <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_prog True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>clock  <span class="free">s'</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span> <span class="free">prog</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">s'</span><span class="main">)</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> prog_clock_monotone<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> prog_sub_from_counter <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Big_Step_Clocked-prog_add_clock"><span class="command">lemma</span></span> prog_add_clock<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_prog False <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">res</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">c</span><span class="main">.</span> evaluate_prog True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">c</span> <span class="main">|)</span><span class="main">)</span> <span class="free">prog</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">res</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted">False</span> <span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">prog</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate_prog.induct<span class="main"><span class="main">[</span></span><span class="operator">split_format</span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="quasi_keyword"><span class="quasi_keyword">complete</span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> cons1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> top_add_clock<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> c c'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> top_add_to_counter<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> extra <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>add.commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_prog.intros<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_prog.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> top_add_clock<span class="main">)</span>

<span class="keyword1" id="Big_Step_Clocked-prog_clocked_unclocked_equiv"><span class="command">lemma</span></span> prog_clocked_unclocked_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_prog False <span class="free">env</span> <span class="free">s</span> <span class="free">prog</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> evaluate_prog True <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="bound">c</span> <span class="main">|)</span><span class="main">)</span> <span class="free">prog</span> <span class="main">(</span><span class="main">(</span><span class="free">s'</span> <span class="main">(|</span> clock <span class="main">:=</span> <span class="main">0</span> <span class="main">|)</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">∧</span>
        <span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock   <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock   <span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">rule</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prog_add_clock
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prog_unclocked<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prog_unclocked<span class="main">)</span>
  <span class="comment1">(* sledgehammer proof *)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"evaluate_prog True <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">prog</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="free">s'</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"clock <span class="free">s</span> <span class="main">=</span> clock <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> evaluate_prog False <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="bound">na</span><span class="main">.</span> <span class="bound">n</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">prog</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="bound">na</span><span class="main">.</span> <span class="bound">n</span><span class="main">)</span> <span class="free">s'</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a2 a1 prog_unclocked_ignore
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> a3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> state.record_simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Big_Step_Clocked-clocked_evaluate"><span class="command">lemma</span></span> clocked_evaluate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> BigStep.evaluate True <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">k</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">≠</span>  Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> BigStep.evaluate True <span class="free">env</span> <span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">k</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span><span class="main">(</span>update_clock <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="free">s'</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">≠</span>  Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> clock_monotone<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> k
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sub_from_counter<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> count' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> count <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span>clock <span class="free">s'</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> add_to_counter<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> extra <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"clock <span class="free"><span class="free"><span class="free">s'</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Big_Step_Unclocked_Single">
<div class="head">
<h1>Theory Big_Step_Unclocked_Single</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"An even simpler version without mutual induction"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Big_Step_Unclocked_Single
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Big_Step_Unclocked">Big_Step_Unclocked</a> <a href="#Big_Step_Clocked">Big_Step_Clocked</a> <a href="#Evaluate_Single">Evaluate_Single</a> <a href="#Big_Step_Fun_Equiv">Big_Step_Fun_Equiv</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">evaluate_list</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ffi</span> state <span class="main">⇒</span> exp <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span>v<span class="main">,</span>v<span class="main">)</span> result <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
    <span class="tfree">'ffi</span> state <span class="main">⇒</span> exp list <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span>v list<span class="main">,</span> v<span class="main">)</span>result <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">P</span> <span class="keyword2"><span class="keyword">where</span></span>
empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate_list</span> <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>Rval <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>

cons1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate_list</span> <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s3</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate_list</span> <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s3</span></span></span><span class="main">,</span> Rval <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

cons2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate_list</span> <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

cons3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate_list</span> <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s3</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate_list</span> <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s3</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Big_Step_Unclocked_Single-evaluate_list_mono_strong"><span class="command">lemma</span></span> evaluate_list_mono_strong<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_list <span class="free">R</span> <span class="free">s</span> <span class="free">es</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">e</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="free">es</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">s</span> <span class="bound">e</span> <span class="bound">r</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span> <span class="bound">e</span> <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_list <span class="free">Q</span> <span class="free">s</span> <span class="free">es</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_list.intros<span class="main">)</span>

<span class="keyword1" id="Big_Step_Unclocked_Single-evaluate_list_mono"><span class="command">lemma</span></span> evaluate_list_mono<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≤</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_list <span class="free">R</span> <span class="main">≤</span> evaluate_list <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> le_fun_def le_bool_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> evaluate_list_mono_strong<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">evaluate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v sem_env <span class="main">⇒</span> <span class="tfree">'ffi</span> state <span class="main">⇒</span> exp <span class="main">⇒</span> <span class="tfree">'ffi</span> state<span class="main">*</span><span class="main">(</span>v<span class="main">,</span>v<span class="main">)</span> result <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>

lit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Lit <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

raise1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Raise <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

raise2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Raise <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

handle1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Handle <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

handle2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   match_result <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Rval <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Handle <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span>"</span></span> <span class="main">|</span>

handle2b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rraise <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   match_result <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Handle <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

handle3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Handle <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

con1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"do_con_check <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   build_conv <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟹</span>
   evaluate_list <span class="main">(</span><span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Con <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

con2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>do_con_check <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Con <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

con3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"do_con_check <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   evaluate_list <span class="main">(</span><span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Con <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

var1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nsLookup <span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

var2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nsLookup <span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> None <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

fn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rval <span class="main">(</span>Closure <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

app1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="main">(</span><span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   do_opapp <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env'</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>App Opapp <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span>"</span></span> <span class="main">|</span>

app3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="main">(</span><span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span>do_opapp <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>App Opapp <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

app4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="main">(</span><span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   do_app <span class="main">(</span>refs <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> ffi <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">refs'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ffi'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="main">≠</span> Opapp <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⦇</span>refs<span class="main">:=</span><span class="free"><span class="bound"><span class="entity">refs'</span></span></span><span class="main">,</span>ffi<span class="main">:=</span><span class="free"><span class="bound"><span class="entity">ffi'</span></span></span><span class="main">⦈</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

app5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="main">(</span><span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   do_app <span class="main">(</span>refs <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> ffi <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> None <span class="main">⟹</span>
   <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="main">≠</span> Opapp <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

app6<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="main">(</span><span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

log1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   do_log <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Log <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> "</span></span> <span class="main">|</span>

log2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span>do_log <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="free"><span class="bound"><span class="entity">bv</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Log <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">bv</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

log3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span>do_log <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> None<span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Log <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

log4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Log <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

if1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   do_if <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>If <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> "</span></span> <span class="main">|</span>

if2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span>do_if <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="main">=</span> None<span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>If <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

if3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>If <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

mat1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   match_result <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span> Bindv <span class="main">=</span> Rval <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Mat <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> "</span></span> <span class="main">|</span>

mat1b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   match_result <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span> Bindv <span class="main">=</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Mat <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

mat2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Mat <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

let1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> <span class="main">(</span>nsOptBind <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> "</span></span> <span class="main">|</span>

let2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

letrec1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>
     <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">x</span> <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> <span class="main">(</span>build_rec_env <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Letrec <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> "</span></span> <span class="main">|</span>

letrec2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>distinct <span class="main">(</span>List.map <span class="main">(</span> <span class="main">λ</span><span class="bound">x</span> <span class="main">.</span>
     <span class="main">(</span><span class="keyword1">case</span>  <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="bound">x</span> <span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Letrec <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

tannot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Tannot <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> "</span></span> <span class="main">|</span>

locannot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> <span class="main">⟹</span>
   <span class="free">evaluate</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Lannot <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> "</span></span>

<span class="keyword1" id="Big_Step_Unclocked_Single-unclocked_single_list_sound"><span class="command">lemma</span></span> unclocked_single_list_sound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="main">(</span>Big_Step_Unclocked.evaluate <span class="free">v</span><span class="main">)</span> <span class="free">s</span> <span class="free">es</span> <span class="free">bv</span> <span class="main">⟹</span> Big_Step_Unclocked.evaluate_list <span class="free">v</span> <span class="free">s</span> <span class="free">es</span> <span class="free">bv</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate_list.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate_list_evaluate.intros<span class="main">)</span>

<span class="keyword1" id="Big_Step_Unclocked_Single-unclocked_single_sound"><span class="command">lemma</span></span> unclocked_single_sound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">v</span> <span class="free">s</span> <span class="free">e</span> <span class="free">bv</span> <span class="main">⟹</span> Big_Step_Unclocked.evaluate <span class="free">v</span> <span class="free">s</span> <span class="free">e</span> <span class="free">bv</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> do_app.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Big_Step_Unclocked.evaluate_list_evaluate.intros unclocked_single_list_sound
         evaluate_list_mono_strong<span class="main">)</span>

<span class="keyword1" id="Big_Step_Unclocked_Single-unclocked_single_complete"><span class="command">lemma</span></span> unclocked_single_complete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Big_Step_Unclocked.evaluate_list <span class="free">v</span> <span class="free">s</span> <span class="free">es</span> <span class="free">bv1</span> <span class="main">⟹</span> evaluate_list <span class="main">(</span>evaluate <span class="free">v</span><span class="main">)</span> <span class="free">s</span> <span class="free">es</span> <span class="free">bv1</span>"</span></span>
  <span class="quoted"><span class="quoted">"Big_Step_Unclocked.evaluate <span class="free">v</span> <span class="free">s</span> <span class="free">e</span> <span class="free">bv2</span> <span class="main">⟹</span> evaluate <span class="free">v</span> <span class="free">s</span> <span class="free">e</span> <span class="free">bv2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate_list_evaluate.inducts<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> evaluate.intros evaluate_list.intros<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> unclocked_single_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate <span class="main">=</span> Big_Step_Unclocked.evaluate"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">metis</span> unclocked_single_sound unclocked_single_complete<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> unclocked_single_eq'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate <span class="main">=</span> BigStep.evaluate False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unclocked_single_eq unclocked_eq<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> unclocked_single_determ<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">r3a</span> <span class="main">⟹</span> evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">r3b</span> <span class="main">⟹</span> <span class="free">r3a</span> <span class="main">=</span> <span class="free">r3b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> unclocked_single_eq unclocked_determ<span class="main">)</span>

<span class="keyword1" id="Big_Step_Unclocked_Single-unclocked_single_fun_eq"><span class="command">lemma</span></span> unclocked_single_fun_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> Evaluate_Single.evaluate <span class="free">env</span> <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock<span class="main">:=</span> <span class="bound">k</span> <span class="main">⦈</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">≠</span>  Rerr <span class="main">(</span>Rabort Rtimeout_error<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>clock <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>clock <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fun_evaluate_equiv'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> unclocked_single_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> unclocked_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fun.evaluate_iff_sym<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> big_clocked_unclocked_equiv<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> clocked_evaluate <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Matching">
<div class="head">
<h1>Theory Matching</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">"Matching adaptation"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Matching
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Semantic_Extras">Semantic_Extras</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">fold2</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fold2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">err</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">fold2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">err</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="main">=</span> <span class="free">fold2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">err</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">init</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">fold2</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">err</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span>  <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">err</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1" id="Matching-fold2_cong"><span class="command">lemma</span></span> fold2_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">init1</span> <span class="main">=</span> <span class="free">init2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">err1</span> <span class="main">=</span> <span class="free">err2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs1</span> <span class="main">=</span> <span class="free">xs2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys1</span> <span class="main">=</span> <span class="free">ys2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">init</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs1</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys1</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">init</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">init</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fold2 <span class="free">f</span> <span class="free">err1</span> <span class="free">xs1</span> <span class="free">ys1</span> <span class="free">init1</span> <span class="main">=</span> fold2 <span class="free">g</span> <span class="free">err2</span> <span class="free">xs2</span> <span class="free">ys2</span> <span class="free">init2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">err1</span></span> <span class="quoted"><span class="free">xs1</span></span> <span class="quoted"><span class="free">ys1</span></span> <span class="quoted"><span class="free">init1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">init2</span></span> <span class="quoted"><span class="free">xs2</span></span> <span class="quoted"><span class="free">ys2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fold2.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pmatch_single</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>nat<span class="main">*</span>tid_or_exn<span class="main">)</span><span class="main">)</span>namespace <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>v<span class="main">)</span>store_v<span class="main">)</span>list <span class="main">⇒</span> pat <span class="main">⇒</span> v <span class="main">⇒</span><span class="main">(</span>string<span class="main">*</span>v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>string<span class="main">*</span>v<span class="main">)</span>list<span class="main">)</span>match_result "</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pmatch_single</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> Pany <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span> Match <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pmatch_single</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Pvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span> Match <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pmatch_single</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Plit <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>Litv <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="keyword1">then</span>
    Match <span class="free"><span class="bound"><span class="entity">env</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> lit_same_type <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="keyword1">then</span>
    No_match
  <span class="keyword1">else</span>
    Match_type_error <span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pmatch_single</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Pcon <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span>  nsLookup <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span>
      Some <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="keyword1">if</span> same_tid <span class="bound">t1</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">∧</span> <span class="main">(</span>List.length <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="bound">l</span><span class="main">)</span> <span class="keyword1">then</span>
          <span class="keyword1">if</span> same_ctor <span class="main">(</span>id_to_n <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
            fold2 <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">m</span> <span class="keyword1">of</span>
               Match <span class="bound">env</span> <span class="main">⇒</span> <span class="free">pmatch_single</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="bound">v</span> <span class="bound">env</span> 
            <span class="main">|</span> <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span> Match_type_error <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">(</span>Match <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
          <span class="keyword1">else</span>
            No_match
        <span class="keyword1">else</span>
          Match_type_error
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> Match_type_error
  <span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pmatch_single</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Pcon None <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">(</span>Conv None <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> List.length <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> List.length <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="keyword1">then</span>
    fold2 <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">m</span> <span class="keyword1">of</span>
       Match <span class="bound">env</span> <span class="main">⇒</span> <span class="free">pmatch_single</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="bound">v</span> <span class="bound">env</span> 
        <span class="main">|</span> <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span>
         Match_type_error <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">(</span>Match <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span>
    Match_type_error <span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pmatch_single</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Pref <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>Loc <span class="free"><span class="bound"><span class="entity">lnum</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span>  store_lookup <span class="free"><span class="bound"><span class="entity">lnum</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
      Some <span class="main">(</span>Refv <span class="bound">v2</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="free">pmatch_single</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">v2</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>
    <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> Match_type_error
    <span class="main">|</span> None <span class="main">=&gt;</span> Match_type_error
  <span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pmatch_single</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Ptannot <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="free">pmatch_single</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pmatch_single</span> <span class="free"><span class="bound"><span class="entity">envC</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> Match_type_error"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Matching-pmatch_list_length_neq"><span class="command">lemma</span></span> pmatch_list_length_neq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">≠</span> length <span class="free">ps</span> <span class="main">⟹</span> fold2<span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">m</span> <span class="keyword1">of</span>
       Match <span class="bound">env</span> <span class="main">⇒</span> pmatch_single <span class="free">cenv</span> <span class="free">s</span> <span class="bound">p</span> <span class="bound">v</span> <span class="bound">env</span> 
        <span class="main">|</span> <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span> Match_type_error <span class="free">ps</span> <span class="free">vs</span> <span class="free">m</span> <span class="main">=</span> Match_type_error"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>List.list_induct2'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Matching-pmatch_list_nomatch"><span class="command">lemma</span></span> pmatch_list_nomatch<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">=</span> length <span class="free">ps</span> <span class="main">⟹</span> fold2<span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">m</span> <span class="keyword1">of</span>
       Match <span class="bound">env</span> <span class="main">⇒</span> pmatch_single <span class="free">cenv</span> <span class="free">s</span> <span class="bound">p</span> <span class="bound">v</span> <span class="bound">env</span> 
        <span class="main">|</span> <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span> Match_type_error <span class="free">ps</span> <span class="free">vs</span> No_match <span class="main">=</span> No_match"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">vs</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>List.list_induct2'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Matching-pmatch_list_typerr"><span class="command">lemma</span></span> pmatch_list_typerr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">=</span> length <span class="free">ps</span> <span class="main">⟹</span> fold2<span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">m</span> <span class="keyword1">of</span>
       Match <span class="bound">env</span> <span class="main">⇒</span> pmatch_single <span class="free">cenv</span> <span class="free">s</span> <span class="bound">p</span> <span class="bound">v</span> <span class="bound">env</span> 
        <span class="main">|</span> <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span> Match_type_error <span class="free">ps</span> <span class="free">vs</span> Match_type_error <span class="main">=</span> Match_type_error"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">vs</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>List.list_induct2'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Matching-pmatch_single_eq0"><span class="command">lemma</span></span> pmatch_single_eq0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">vs</span> <span class="main">⟹</span> pmatch_list <span class="free">cenv</span> <span class="free">s</span> <span class="free">ps</span> <span class="free">vs</span> <span class="free">env</span> <span class="main">=</span> fold2<span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">m</span> <span class="keyword1">of</span>
       Match <span class="bound">env</span> <span class="main">⇒</span> pmatch_single <span class="free">cenv</span> <span class="free">s</span> <span class="bound">p</span> <span class="bound">v</span> <span class="bound">env</span> 
        <span class="main">|</span> <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span> Match_type_error <span class="free">ps</span> <span class="free">vs</span> <span class="main">(</span>Match <span class="free">env</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"pmatch <span class="free">cenv</span> <span class="free">s</span> <span class="free">p</span> <span class="free">v0</span> <span class="free">env</span> <span class="main">=</span> pmatch_single <span class="free">cenv</span> <span class="free">s</span> <span class="free">p</span> <span class="free">v0</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pmatch_list_pmatch.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">envC</span> <span class="skolem">s</span> <span class="skolem">n</span> <span class="skolem">ps</span> <span class="skolem">n'</span> <span class="skolem">t'</span> <span class="skolem">vs</span> <span class="skolem">env</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits match_result.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>pmatch_list_length_neq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"Match <span class="skolem">env</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> cenv <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">envC</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> s <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits match_result.splits store_v.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>pmatch_list_nomatch pmatch_list_typerr<span class="main">)</span>

<span class="keyword1" id="Matching-pmatch_single_equiv"><span class="command">lemma</span></span> pmatch_single_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"pmatch <span class="main">=</span> pmatch_single"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmatch_single_eq0<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">pmatch_single</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CakeML_Code">
<div class="head">
<h1>Theory CakeML_Code</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">"Code generation"</span></span>

<span class="keyword1"><span class="command">theory</span></span> CakeML_Code
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="#Evaluate_Single">Evaluate_Single</a>
  <a href="#Matching">Matching</a>
  <span class="quoted">"<a href="#PrimTypes">generated/CakeML/PrimTypes</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Lib.the

<span class="keyword1"><span class="command">declare</span></span> evaluate_list_eq<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> fix_clock_evaluate<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> fun_evaluate_equiv<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> pmatch_single_equiv<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">abort</span><span class="main"><span class="main">:</span></span> <span class="quoted">failwith</span> <span class="quoted">fp64_negate</span> <span class="quoted">fp64_sqrt</span> <span class="quoted">fp64_sub</span> <span class="quoted">fp64_mul</span> <span class="quoted">fp64_div</span> <span class="quoted">fp64_add</span> <span class="quoted">fp64_abs</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_ffi_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit ffi_state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">empty_ffi_state</span> <span class="main">=</span> initial_ffi_state <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> Oracle_fail<span class="main">)</span> <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">prim_sem_res</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">prim_sem_res</span> <span class="main">=</span> Option.the <span class="main">(</span>prim_sem_env empty_ffi_state<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">local_setup</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lthy</span> <span class="main">=&gt;</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">Code_Simp.dynamic_conv</span> <span class="entity">lthy</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">cterm</span> <span class="quoted">prim_sem_res</span><span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">lthy'</span><span class="main">)</span> <span class="main">=</span> Local_Theory.note <span class="main">(</span><span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> prim_sem_res_code<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">attributes</span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span> <span class="entity">lthy</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">lthy'</span> <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">value</span></span> <span class="main">[</span>simp<span class="main">]</span> <span class="quoted">prim_sem_res</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prim_sem_env</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prim_sem_env</span> <span class="main">=</span> snd prim_sem_res"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prim_sem_state</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prim_sem_state</span> <span class="main">=</span> fst prim_sem_res"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">evaluate</span></span> <span class="quoted"><span class="quoted">fun_evaluate</span></span> <span class="quoted"><span class="quoted">fun_evaluate_prog</span></span> <span class="quoted"><span class="quoted">prim_sem_env</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="comment1">―‹Test›</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>evaluate prim_sem_env prim_sem_state <span class="main">(</span>Lit <span class="main">(</span>IntLit <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Rval <span class="main">(</span>Litv <span class="main">(</span>IntLit <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CakeML_Quickcheck">
<div class="head">
<h1>Theory CakeML_Quickcheck</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">"Quickcheck setup (fishy)"</span></span>

<span class="keyword1"><span class="command">theory</span></span> CakeML_Quickcheck
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="#SemanticPrimitives">generated/CakeML/SemanticPrimitives</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype_compat</span></span> namespace
<span class="keyword1"><span class="command">datatype_compat</span></span> t
<span class="keyword1"><span class="command">datatype_compat</span></span> pat
<span class="keyword1"><span class="command">datatype_compat</span></span> sem_env

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">handle_0</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">handle_0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Handle <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">handle_1</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">handle_1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> Handle <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">handle_2</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">handle_2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> Handle <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">con_0</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">con_0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Con <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">con_1</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">con_1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> Con <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">con_2</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">con_2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> Con <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">app_0</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">app_0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> App <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">app_1</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">app_1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> App <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">app_2</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">app_2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> App <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat_0</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mat_0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Mat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat_1</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mat_1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">=</span> Mat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat_2</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mat_2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">=</span> Mat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">conv_0</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">conv_0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Conv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">conv_1</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">conv_1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">=</span> Conv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">conv_2</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">conv_2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> Conv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">closure_dummy</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">closure_dummy</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="main">=</span> Closure <span class="main">⦇</span> v <span class="main">=</span> Bind <span class="main">[]</span> <span class="main">[]</span><span class="main">,</span> c <span class="main">=</span> Bind <span class="main">[]</span> <span class="main">[]</span> <span class="main">⦈</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">var</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">recclosure_dummy</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">recclosure_dummy</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="main">=</span> Recclosure <span class="main">⦇</span> v <span class="main">=</span> Bind <span class="main">[]</span> <span class="main">[]</span><span class="main">,</span> c <span class="main">=</span> Bind <span class="main">[]</span> <span class="main">[]</span> <span class="main">⦈</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">var</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">vectorv_0</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vectorv_0</span> <span class="main">=</span> Vectorv <span class="main">[]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">vectorv_1</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vectorv_1</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">=</span> Vectorv <span class="main">[</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">vectorv_2</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vectorv_2</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> Vectorv <span class="main">[</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">quickcheck_generator</span></span> exp0
  constructors<span class="main">:</span>
    <span class="quoted">Raise</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.handle_0</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.handle_1</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.handle_2</span><span class="main">,</span>
    <span class="quoted">Lit</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.con_0</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.con_1</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.con_2</span><span class="main">,</span>
    <span class="quoted">Var</span><span class="main">,</span>
    <span class="quoted">Fun</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.app_0</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.app_1</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.app_2</span><span class="main">,</span>
    <span class="quoted">Log</span><span class="main">,</span>
    <span class="quoted">If</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.mat_0</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.mat_1</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.mat_2</span><span class="main">,</span>
    <span class="quoted">Let</span><span class="main">,</span>
    <span class="quoted">Tannot</span><span class="main">,</span>
    <span class="quoted">Lannot</span>

<span class="keyword1"><span class="command">quickcheck_generator</span></span> v
  constructors<span class="main">:</span>
    <span class="quoted">Litv</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.conv_0</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.conv_1</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.conv_2</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.closure_dummy</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.recclosure_dummy</span><span class="main">,</span>
    <span class="quoted">Loc</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.vectorv_0</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.vectorv_1</span><span class="main">,</span>
    <span class="quoted">CakeML_Quickcheck.vectorv_2</span>

<span class="keyword1"><span class="command">quickcheck_generator</span></span> dec
  constructors<span class="main">:</span> <span class="quoted">Dlet</span><span class="main">,</span> <span class="quoted">Dletrec</span><span class="main">,</span> <span class="quoted">Dtype</span><span class="main">,</span> <span class="quoted">Dtabbrev</span><span class="main">,</span> <span class="quoted">Dexn</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dec"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">quickcheck</span></span> <span class="main">[</span>expect <span class="main">=</span> counterexample<span class="main">,</span> timeout <span class="main">=</span> 90<span class="main">]</span>
  <span class="keyword1"><span class="command">quickcheck</span></span> <span class="main">[</span>random<span class="main">,</span> expect <span class="main">=</span> counterexample<span class="main">,</span> timeout <span class="main">=</span> 90<span class="main">]</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">quickcheck</span></span> <span class="main">[</span>expect <span class="main">=</span> counterexample<span class="main">,</span> timeout <span class="main">=</span> 90<span class="main">]</span>
  <span class="keyword1"><span class="command">quickcheck</span></span> <span class="main">[</span>random<span class="main">,</span> expect <span class="main">=</span> counterexample<span class="main">,</span> timeout <span class="main">=</span> 90<span class="main">]</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CakeML_Compiler">
<div class="head">
<h1>Theory CakeML_Compiler</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">"CakeML Compiler"</span></span>

<span class="keyword1"><span class="command">theory</span></span> CakeML_Compiler
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="#Ast">generated/CakeML/Ast</a>"</span>
  <span class="quoted">"<a href="../../show/theories/#Show_Instances">Show.Show_Instances</a>"</span>
<span class="keyword2"><span class="keyword">keywords</span></span> <span class="quoted">"cakeml"</span> <span class="main">::</span> diag
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Lem_string.concat

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹Tools/cakeml_sexp.ML›</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹Tools/cakeml_compiler.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="files/Tools/cakeml_sexp.ML">
<div class="head">
<h1>File ‹Tools/cakeml_sexp.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      CakeML/Tools/cakeml_sexp.ML
    Author:     Johannes Åman Pohjola

Printing of CakeML ASTs as S-expressions, for interfacing with
the bootstrapped CakeML compiler.

Originally developed for HOL4 by Nicholas Coughlin, ported to
Isabelle/ML by Johannes Åman Pohjola.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">CAKEML_SEXP</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> print_prog_buf<span class="main">:</span> <span class="main">(</span>string <span class="main">-&gt;</span> unit<span class="main">)</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> unit
  <span class="keyword1"><span class="keyword">val</span></span> print_prog<span class="main">:</span> term <span class="main">-&gt;</span> string
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">CakeML_Sexp</span> <span class="main">:</span> <span class="entity">CAKEML_SEXP</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">IntLit_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "IntLit"<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">CharLit_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "Char"<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Word8_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "Word8"<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Word64_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "Word64"<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">W8_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "W8"<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">W64_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "W64"<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Shift_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Shift"</span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">WordToInt_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"WordToInt"</span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">WordFromInt_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"WordToInt"</span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">FFI_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"FFI"</span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Pvar_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Pvar"</span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Pany_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Pany"</span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Lit_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "Lit"<span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Plit_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Plit"</span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">App_tm</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> "App"<span class="antiquote">}</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">same_name</span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">c</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span>Const <span class="main">(</span><span class="entity">c'</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">c</span> <span class="main">=</span> <span class="entity">c'</span>
  <span class="main">|</span> <span class="entity">same_name</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="entity">a</span> <span class="main">=</span> <span class="entity">b</span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">exp</span> <span class="main">=</span> <span class="entity">exp_tuple</span> <span class="keyword2"><span class="keyword">of</span></span> exp list <span class="main">|</span> <span class="entity">exp_list</span> <span class="keyword2"><span class="keyword">of</span></span> exp list <span class="main">|</span> <span class="entity">exp_str</span> <span class="keyword2"><span class="keyword">of</span></span> string<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">escape_wrap</span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">"\""</span> ^ <span class="entity">c</span> ^ <span class="inner_quoted">"\""</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">escape_char</span> <span class="entity">c</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">to_hex</span> <span class="main">=</span> <span class="main">(</span>StringCvt.padLeft <span class="inner_quoted">#"0"</span> <span class="inner_numeral">2</span><span class="main">)</span> o <span class="main">(</span>Int.fmt StringCvt.HEX<span class="main">)</span> o Char.ord
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#"\\"</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"\\\\\\\\"</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">c</span> <span class="main">=</span> <span class="inner_quoted">#"\""</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"\\\""</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> Char.isPrint <span class="entity">c</span> <span class="keyword2"><span class="keyword">then</span></span> Char.toString <span class="entity">c</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_quoted">"\\\\"</span> ^ <span class="main">(</span><span class="entity">to_hex</span> <span class="entity">c</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fromHOLchar</span> <span class="main">=</span>
  <span class="entity">escape_wrap</span> o String.translate <span class="entity">escape_char</span> o chr o <span class="entity">HOLogic.dest_char</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fromHOLstring</span> <span class="main">=</span>
  <span class="entity">escape_wrap</span> o <span class="main">(</span>String.translate <span class="entity">escape_char</span><span class="main">)</span> o <span class="entity">HOLogic.dest_string</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fromHOLnum</span> <span class="main">=</span> Int.toString o snd o <span class="entity">HOLogic.dest_number</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">char_to_exp</span> <span class="entity">c</span> <span class="main">=</span> <span class="entity">exp_list</span> <span class="main">[</span><span class="entity">exp_str</span> <span class="inner_quoted">"char"</span><span class="main">,</span> <span class="entity">exp_str</span> <span class="main">(</span><span class="entity">fromHOLchar</span> <span class="entity">c</span><span class="main">)</span><span class="main">]</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">string_to_exp</span> <span class="main">=</span> <span class="entity">exp_str</span> o <span class="entity">fromHOLstring</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">num_to_exp</span> <span class="main">=</span> <span class="entity">exp_str</span> o <span class="entity">fromHOLnum</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">word_to_exp</span> <span class="entity">lit_name</span> <span class="entity">w</span> <span class="main">=</span>
    <span class="entity">exp_list</span> <span class="main">[</span><span class="entity">exp_str</span> <span class="entity">lit_name</span><span class="main">,</span> <span class="entity">num_to_exp</span> <span class="entity">w</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">int_to_exp</span> <span class="entity">i</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> <span class="main">(</span>snd o <span class="entity">HOLogic.dest_number</span><span class="main">)</span> <span class="entity">i</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &lt; <span class="inner_numeral">0</span>
      <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">exp_list</span> <span class="main">[</span><span class="entity">exp_str</span> <span class="inner_quoted">"-"</span><span class="main">,</span> <span class="entity">exp_str</span><span class="main">(</span>Int.toString<span class="main">(</span>abs <span class="entity">n</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">num_to_exp</span> <span class="entity">i</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_loc</span><span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> make_locn<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">l1</span> $ <span class="entity">l2</span> $ <span class="entity">l3</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">HOLogic.dest_number</span> <span class="entity">l1</span> |&gt; snd<span class="main">,</span>
   <span class="entity">HOLogic.dest_number</span> <span class="entity">l2</span> |&gt; snd<span class="main">,</span>
   <span class="entity">HOLogic.dest_number</span> <span class="entity">l3</span> |&gt; snd<span class="main">)</span>
  <span class="main">|</span> <span class="entity">dest_loc</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Domain

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_locs</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Pair<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">loc1</span> $ <span class="entity">loc2</span><span class="main">)</span> <span class="main">=</span>
 <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">r1</span><span class="main">,</span><span class="entity">c1</span><span class="main">,</span><span class="entity">o1</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_loc</span> <span class="entity">loc1</span>
     <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">r2</span><span class="main">,</span><span class="entity">c2</span><span class="main">,</span><span class="entity">o2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">dest_loc</span> <span class="entity">loc2</span>
 <span class="keyword2"><span class="keyword">in</span></span>
   <span class="main">[</span><span class="entity">r1</span><span class="main">,</span><span class="entity">c1</span><span class="main">,</span><span class="entity">o1</span><span class="main">,</span><span class="entity">r2</span><span class="main">,</span><span class="entity">c2</span><span class="main">,</span><span class="entity">o2</span><span class="main">]</span>
 <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="entity">dest_locs</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"locs"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">locs_to_exp</span> <span class="entity">l</span> <span class="main">=</span>
  <span class="entity">exp_list</span> <span class="main">[</span><span class="entity">exp_str</span> <span class="main">(</span><span class="main">(</span>String.concatWith <span class="inner_quoted">" "</span> o map Int.toString<span class="main">)</span> <span class="entity">l</span><span class="main">)</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lit_to_exp</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="entity">t</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">h</span> <span class="main">=</span> hd <span class="entity">xs</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">IntLit_tm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">int_to_exp</span> <span class="entity">h</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">CharLit_tm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">char_to_exp</span> <span class="entity">h</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">Word8_tm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">word_to_exp</span> <span class="inner_quoted">"word8"</span> <span class="entity">h</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">Word64_tm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">word_to_exp</span> <span class="inner_quoted">"word64"</span> <span class="entity">h</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">string_to_exp</span> <span class="entity">h</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">op_to_exp</span> <span class="entity">arg</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">underscore_filter</span> <span class="main">=</span>
      String.implode o filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">n</span> &lt;&gt; <span class="inner_quoted">#"_"</span><span class="main">)</span> o String.explode
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">to_string</span> <span class="main">=</span> <span class="main">#</span><span class="inner_numeral">1</span> o dest_Const
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">filtered_string</span> <span class="entity">t</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">same_name</span><span class="main">(</span><span class="entity">W8_tm</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="inner_quoted">"8"</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">same_name</span><span class="main">(</span><span class="entity">W64_tm</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="inner_quoted">"64"</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">underscore_filter</span><span class="main">(</span>Long_Name.base_name<span class="main">(</span><span class="entity">to_string</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wordInt</span> <span class="entity">xs</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">exp_str</span> <span class="main">(</span><span class="main">(</span>hd <span class="main">(</span>map <span class="entity">to_string</span> <span class="entity">xs</span><span class="main">)</span><span class="main">)</span> ^ <span class="entity">s</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ffi</span> <span class="entity">xs</span> <span class="main">=</span> <span class="entity">exp_tuple</span> <span class="main">[</span><span class="entity">exp_str</span> <span class="inner_quoted">"FFI"</span><span class="main">,</span> <span class="entity">string_to_exp</span> <span class="main">(</span>hd <span class="entity">xs</span><span class="main">)</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">shift</span> <span class="entity">xs</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">consts</span> <span class="main">=</span> List.take <span class="main">(</span><span class="entity">xs</span><span class="main">,</span> <span class="inner_numeral">2</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">str</span> <span class="main">=</span> <span class="inner_quoted">"Shift"</span> ^ String.concat <span class="main">(</span>map <span class="entity">filtered_string</span> <span class="entity">consts</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">exp_tuple</span> <span class="main">[</span><span class="entity">exp_str</span> <span class="entity">str</span><span class="main">,</span> <span class="entity">num_to_exp</span> <span class="main">(</span>List.last <span class="entity">xs</span><span class="main">)</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="entity">arg</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">Shift_tm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">shift</span> <span class="entity">xs</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">WordToInt_tm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">wordInt</span> <span class="entity">xs</span> <span class="inner_quoted">"toInt"</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">WordFromInt_tm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">wordInt</span> <span class="entity">xs</span> <span class="inner_quoted">"fromInt"</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">FFI_tm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">ffi</span> <span class="entity">xs</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">exp_str</span> <span class="main">(</span>String.concat <span class="main">(</span>map <span class="entity">filtered_string</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cons</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Cons"</span><span class="antiquote">}</span></span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">comma</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Pair"</span><span class="antiquote">}</span></span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nil_l</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">[]</span>"</span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ast_to_exp</span> <span class="entity">term</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">list_to_exp</span> <span class="main">=</span> map <span class="entity">ast_to_exp</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">app_to_exp</span> <span class="entity">const</span> <span class="entity">args</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">exp</span> <span class="main">=</span> <span class="main">(</span><span class="entity">exp_str</span> o Long_Name.base_name o <span class="main">#</span><span class="inner_numeral">1</span> o dest_Const<span class="main">)</span> <span class="entity">const</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">op_exp</span> <span class="main">=</span> <span class="entity">op_to_exp</span> <span class="main">(</span>hd <span class="entity">args</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">args_exp</span> <span class="main">=</span> <span class="entity">list_to_exp</span> <span class="main">(</span>tl <span class="entity">args</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">exp_list</span> <span class="main">(</span><span class="entity">exp</span>::<span class="entity">op_exp</span>::<span class="entity">args_exp</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">upc</span> <span class="inner_quoted">"Some"</span> <span class="main">=</span> <span class="inner_quoted">"SOME"</span>
      <span class="main">|</span> <span class="entity">upc</span> <span class="inner_quoted">"None"</span> <span class="main">=</span> <span class="inner_quoted">"NONE"</span>
      <span class="main">|</span> <span class="entity">upc</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">s</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">generic_to_exp</span> <span class="entity">const</span> <span class="entity">args</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">exp</span> <span class="main">=</span> <span class="main">(</span><span class="entity">exp_str</span> o <span class="entity">upc</span> o Long_Name.base_name o <span class="main">#</span><span class="inner_numeral">1</span> o dest_Const<span class="main">)</span> <span class="entity">const</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">args_exp</span> <span class="main">=</span> <span class="entity">list_to_exp</span> <span class="entity">args</span>
      <span class="keyword2"><span class="keyword">in</span></span> 
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">args</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">exp</span>
                   <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">exp_list</span> <span class="main">(</span><span class="entity">exp</span>::<span class="entity">args_exp</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cons_to_exp</span> <span class="entity">term</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> can <span class="entity">HOLogic.dest_string</span> <span class="entity">term</span>
        <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">string_to_exp</span> <span class="entity">term</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">exp_list</span> o <span class="entity">list_to_exp</span> o <span class="entity">HOLogic.dest_list</span><span class="main">)</span> <span class="entity">term</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tuple_to_exp</span> <span class="main">=</span>
      <span class="entity">exp_tuple</span> o <span class="entity">list_to_exp</span> o <span class="entity">HOLogic.strip_tuple</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="entity">term</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">Pvar_tm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">ast_to_exp</span> <span class="main">(</span>hd <span class="entity">xs</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">Pany_tm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">exp_list</span> <span class="main">[</span><span class="entity">exp_str</span> <span class="inner_quoted">"Pany"</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">Lit_tm</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">exp_list</span> <span class="main">[</span><span class="entity">exp_str</span> <span class="inner_quoted">"Lit"</span><span class="main">,</span> <span class="entity">lit_to_exp</span> <span class="main">(</span>hd <span class="entity">xs</span><span class="main">)</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">Plit_tm</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">exp_list</span> <span class="main">[</span><span class="entity">exp_str</span> <span class="inner_quoted">"Plit"</span><span class="main">,</span> <span class="entity">lit_to_exp</span> <span class="main">(</span>hd <span class="entity">xs</span><span class="main">)</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> can <span class="entity">dest_locs</span> <span class="entity">term</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">locs_to_exp</span> o <span class="entity">dest_locs</span><span class="main">)</span> <span class="entity">term</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">nil_l</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">exp_list</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">cons</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">cons_to_exp</span> <span class="entity">term</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">comma</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">tuple_to_exp</span> <span class="entity">term</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>curry <span class="entity">same_name</span><span class="main">)</span> <span class="entity">x</span> <span class="entity">App_tm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">app_to_exp</span> <span class="entity">x</span> <span class="entity">xs</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">generic_to_exp</span> <span class="entity">x</span> <span class="entity">xs</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">exp_to_string</span> <span class="entity">e</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">list_to_string</span> <span class="main">=</span>
      <span class="main">(</span>String.concatWith <span class="inner_quoted">" "</span><span class="main">)</span> o <span class="main">(</span>map <span class="entity">exp_to_string</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tuple_to_string</span> <span class="entity">t</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="inner_quoted">""</span>
              <span class="main">|</span> <span class="main">[</span><span class="entity">x</span><span class="main">,</span> <span class="entity">exp_list</span> <span class="entity">l</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">exp_to_string</span> <span class="entity">x</span><span class="main">)</span> ^ <span class="inner_quoted">" "</span> ^ <span class="main">(</span><span class="entity">list_to_string</span> <span class="entity">l</span><span class="main">)</span>
              <span class="main">|</span> <span class="main">[</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">exp_to_string</span> <span class="entity">x</span><span class="main">)</span> ^ <span class="inner_quoted">" . "</span> ^ <span class="main">(</span><span class="entity">exp_to_string</span> <span class="entity">y</span><span class="main">)</span>
              <span class="main">|</span> <span class="entity">x</span>::<span class="entity">xs</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">exp_to_string</span> <span class="entity">x</span><span class="main">)</span> ^ <span class="inner_quoted">" "</span> ^ <span class="main">(</span><span class="entity">tuple_to_string</span> <span class="entity">xs</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">e</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">exp_str</span> <span class="entity">s</span> <span class="main">=&gt;</span> <span class="entity">s</span>
            <span class="main">|</span> <span class="entity">exp_tuple</span> <span class="entity">l</span> <span class="main">=&gt;</span> <span class="inner_quoted">"("</span> ^ <span class="main">(</span><span class="entity">tuple_to_string</span> <span class="entity">l</span><span class="main">)</span> ^ <span class="inner_quoted">")"</span>
            <span class="main">|</span> <span class="entity">exp_list</span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="inner_quoted">"nil"</span>
            <span class="main">|</span> <span class="entity">exp_list</span> <span class="entity">l</span> <span class="main">=&gt;</span> <span class="inner_quoted">"("</span> ^ <span class="main">(</span><span class="entity">list_to_string</span> <span class="entity">l</span><span class="main">)</span> ^ <span class="inner_quoted">")"</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_prog_buf</span> <span class="entity">pf</span> <span class="entity">prog</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">out</span> <span class="main">=</span> <span class="entity">pf</span> o <span class="entity">exp_to_string</span> o <span class="entity">ast_to_exp</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">step</span> <span class="entity">pl</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">pl</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">)</span>
               <span class="main">|</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">out</span> <span class="entity">x</span>
               <span class="main">|</span> <span class="entity">x</span>::<span class="entity">xs</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">out</span> <span class="entity">x</span><span class="main">;</span> <span class="entity">pf</span> <span class="inner_quoted">" "</span><span class="main">;</span> <span class="entity">step</span> <span class="entity">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">pf</span> <span class="inner_quoted">"("</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pl</span> <span class="main">=</span> <span class="entity">HOLogic.dest_list</span> <span class="entity">prog</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">step</span> <span class="entity">pl</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">pf</span> <span class="inner_quoted">")"</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_prog</span> <span class="entity">prog</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">buf</span> <span class="main">=</span> Unsynchronized.ref Buffer.empty
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pf</span> <span class="entity">s</span> <span class="main">=</span> Unsynchronized.change <span class="entity">buf</span> <span class="main">(</span>Buffer.add <span class="entity">s</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">print_prog_buf</span> <span class="entity">pf</span> <span class="entity">prog</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Buffer.content <span class="main">(</span>!<span class="entity">buf</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="files/Tools/cakeml_compiler.ML">
<div class="head">
<h1>File ‹Tools/cakeml_compiler.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">CAKEML_COMPILER</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">mode</span> <span class="main">=</span>
    <span class="entity">Literal</span> <span class="comment1">(* concrete syntax *)</span> <span class="main">|</span>
    <span class="entity">Prog</span> <span class="comment1">(* sexp syntax *)</span>

  <span class="keyword1"><span class="keyword">val</span></span> compiler<span class="main">:</span> unit <span class="main">-&gt;</span> Path.T
  <span class="keyword1"><span class="keyword">val</span></span> compile_ml<span class="main">:</span> <span class="entity">mode</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span> Path.T
  <span class="keyword1"><span class="keyword">val</span></span> compile_ml_file<span class="main">:</span> <span class="entity">mode</span> <span class="main">-&gt;</span> Path.T <span class="main">-&gt;</span> Path.T
  <span class="keyword1"><span class="keyword">val</span></span> compile_c_file<span class="main">:</span> Path.T <span class="main">-&gt;</span> Path.T
  <span class="keyword1"><span class="keyword">val</span></span> compile_ffi<span class="main">:</span> unit <span class="main">-&gt;</span> Path.T
  <span class="keyword1"><span class="keyword">val</span></span> link<span class="main">:</span> Path.T list <span class="main">-&gt;</span> Path.T

  <span class="keyword1"><span class="keyword">val</span></span> eval<span class="main">:</span> <span class="entity">mode</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span> string
  <span class="keyword1"><span class="keyword">val</span></span> eval_source<span class="main">:</span> <span class="entity">mode</span> <span class="main">-&gt;</span> Input.source <span class="main">-&gt;</span> string

  <span class="keyword1"><span class="keyword">val</span></span> string_of_prog<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> string

  <span class="keyword1"><span class="keyword">val</span></span> cakeml_cmd<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">mode</span> <span class="main">-&gt;</span> Input.source <span class="main">-&gt;</span> unit
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">CakeML_Compiler</span> <span class="main">:</span> <span class="entity">CAKEML_COMPILER</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">mode</span> <span class="main">=</span> <span class="entity">Literal</span> <span class="main">|</span> <span class="entity">Prog</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compiler</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">platform</span> <span class="main">=</span> getenv_strict <span class="inner_quoted">"ISABELLE_PLATFORM64"</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">paths</span> <span class="main">=</span> <span class="main">[</span>getenv_strict <span class="inner_quoted">"ISABELLE_CAKEML_HOME"</span><span class="main">,</span> <span class="inner_quoted">"bin"</span><span class="main">,</span> <span class="entity">platform</span><span class="main">,</span> <span class="inner_quoted">"cake"</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">file</span> <span class="main">=</span> Path.appends <span class="main">(</span>map Path.explode <span class="entity">paths</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> File.exists <span class="entity">file</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">file</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      error <span class="inner_quoted">"CakeML: unsupported platform"</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">basis_ffi</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  Path.append <span class="main">(</span>Path.explode <span class="main">(</span>getenv_strict <span class="inner_quoted">"ISABELLE_CAKEML_HOME"</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Path.basic <span class="inner_quoted">"basis_ffi.c"</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compile_ml_file</span> <span class="entity">mode</span> <span class="entity">source</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id</span> <span class="main">=</span> serial_string <span class="main">(</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">output</span> <span class="main">=</span> File.tmp_path <span class="main">(</span>Path.basic <span class="main">(</span><span class="inner_quoted">"cakeml_out"</span> ^ <span class="entity">id</span> ^ <span class="inner_quoted">".S"</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sexp</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">mode</span> <span class="main">=</span> <span class="entity">Literal</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"false"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_quoted">"true"</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bash_cake</span> <span class="main">=</span> File.bash_path <span class="main">(</span><span class="entity">compiler</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bash_source</span> <span class="main">=</span> File.bash_path <span class="entity">source</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">Isabelle_System.bash_process</span> <span class="main">(</span><span class="entity">bash_cake</span> ^ <span class="inner_quoted">" --sexp="</span> ^ <span class="entity">sexp</span> ^ <span class="inner_quoted">" &lt; "</span> ^ <span class="entity">bash_source</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">err</span> <span class="main">=</span> <span class="entity">Process_Result.err</span> <span class="entity">res</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">out</span> <span class="main">=</span> <span class="entity">Process_Result.out</span> <span class="entity">res</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">err</span> &lt;&gt; <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span> warning <span class="entity">err</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">Process_Result.ok</span> <span class="entity">res</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">err</span> &lt;&gt; <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span>
      error <span class="inner_quoted">"CakeML: ML compilation failed"</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="main">(</span>File.write <span class="entity">output</span> <span class="entity">out</span><span class="main">;</span> <span class="entity">output</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compile_ml</span> <span class="entity">mode</span> <span class="entity">source</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id</span> <span class="main">=</span> serial_string <span class="main">(</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">output</span> <span class="main">=</span> File.tmp_path <span class="main">(</span>Path.basic <span class="main">(</span><span class="inner_quoted">"cakeml_in"</span> ^ <span class="entity">id</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> File.write <span class="entity">output</span> <span class="entity">source</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">compile_ml_file</span> <span class="entity">mode</span> <span class="entity">output</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compile_c_file</span> <span class="entity">source</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id</span> <span class="main">=</span> serial_string <span class="main">(</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">output</span> <span class="main">=</span> File.tmp_path <span class="main">(</span>Path.basic <span class="main">(</span><span class="inner_quoted">"c_out"</span> ^ <span class="entity">id</span> ^ <span class="inner_quoted">".o"</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bash_cc</span> <span class="main">=</span> File.bash_path <span class="main">(</span>Path.explode <span class="main">(</span>getenv_strict <span class="inner_quoted">"ISABELLE_CC"</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bash_source</span> <span class="main">=</span> File.bash_path <span class="entity">source</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bash_output</span> <span class="main">=</span> File.bash_path <span class="entity">output</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">Isabelle_System.bash_process</span> <span class="main">(</span><span class="entity">bash_cc</span> ^ <span class="inner_quoted">" -c -o "</span> ^ <span class="entity">bash_output</span> ^ <span class="inner_quoted">" "</span> ^ <span class="entity">bash_source</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">err</span> <span class="main">=</span> <span class="entity">Process_Result.err</span> <span class="entity">res</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">out</span> <span class="main">=</span> <span class="entity">Process_Result.out</span> <span class="entity">res</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">err</span> &lt;&gt; <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span> warning <span class="entity">err</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> writeln <span class="entity">out</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">Process_Result.ok</span> <span class="entity">res</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">err</span> &lt;&gt; <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span>
      error <span class="inner_quoted">"CakeML: C compilation failed"</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="entity">output</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">compile_ffi</span> <span class="main">=</span>
  <span class="entity">compile_c_file</span> o <span class="entity">basis_ffi</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">link</span> <span class="entity">sources</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">id</span> <span class="main">=</span> serial_string <span class="main">(</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">output</span> <span class="main">=</span> File.tmp_path <span class="main">(</span>Path.basic <span class="main">(</span><span class="inner_quoted">"bin"</span> ^ <span class="entity">id</span> ^ <span class="inner_quoted">".out"</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bash_cc</span> <span class="main">=</span> File.bash_path <span class="main">(</span>Path.explode <span class="main">(</span>getenv_strict <span class="inner_quoted">"ISABELLE_CC"</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bash_sources</span> <span class="main">=</span> Bash.strings <span class="main">(</span>map File.standard_path <span class="entity">sources</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bash_output</span> <span class="main">=</span> File.bash_path <span class="entity">output</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">Isabelle_System.bash_process</span> <span class="main">(</span><span class="entity">bash_cc</span> ^ <span class="inner_quoted">" -o "</span> ^ <span class="entity">bash_output</span> ^ <span class="inner_quoted">" "</span> ^ <span class="entity">bash_sources</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">err</span> <span class="main">=</span> <span class="entity">Process_Result.err</span> <span class="entity">res</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">out</span> <span class="main">=</span> <span class="entity">Process_Result.out</span> <span class="entity">res</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">err</span> &lt;&gt; <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span> warning <span class="entity">err</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> writeln <span class="entity">out</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">Process_Result.ok</span> <span class="entity">res</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">err</span> &lt;&gt; <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span>
      error <span class="inner_quoted">"CakeML: linking failed"</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="entity">output</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eval</span> <span class="entity">mode</span> <span class="entity">source</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cake</span> <span class="main">=</span> <span class="entity">compile_ml</span> <span class="entity">mode</span> <span class="entity">source</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ffi</span> <span class="main">=</span> <span class="entity">compile_ffi</span> <span class="main">(</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bin</span> <span class="main">=</span> <span class="entity">link</span> <span class="main">[</span><span class="entity">cake</span><span class="main">,</span> <span class="entity">ffi</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">Isabelle_System.bash_process</span> <span class="main">(</span>File.bash_path <span class="entity">bin</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">err</span> <span class="main">=</span> <span class="entity">Process_Result.err</span> <span class="entity">res</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">out</span> <span class="main">=</span> <span class="entity">Process_Result.out</span> <span class="entity">res</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">err</span> &lt;&gt; <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span> warning <span class="entity">err</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">Process_Result.ok</span> <span class="entity">res</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">err</span> &lt;&gt; <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span>
      error <span class="inner_quoted">"CakeML: evaluation failed"</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="entity">out</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eval_source</span> <span class="entity">mode</span> <span class="main">=</span>
  <span class="entity">eval</span> <span class="entity">mode</span> o <span class="main">#</span><span class="inner_numeral">1</span> o Input.source_content

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">string_of_prog</span> <span class="entity">ctxt</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">raw_prog</span><span class="main">)</span> <span class="main">=</span>
      Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">t</span>
      |&gt; <span class="entity">Code_Simp.dynamic_conv</span> <span class="entity">ctxt</span>
      |&gt; Thm.prop_of
      |&gt; Logic.dest_equals
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">CakeML_Sexp.print_prog</span> <span class="entity">raw_prog</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_mode</span> <span class="main">=</span>
  Args.parens <span class="main">(</span>Parse.reserved <span class="inner_quoted">"literal"</span> &gt;&gt; K <span class="entity">Literal</span> ||
               Parse.reserved <span class="inner_quoted">"prog"</span> &gt;&gt; K <span class="entity">Prog</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cakeml_cmd</span> <span class="entity">ctxt</span> <span class="entity">mode</span> <span class="entity">source</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">source</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">mode</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="entity">Literal</span> <span class="main">=&gt;</span> <span class="main">#</span><span class="inner_numeral">1</span> <span class="main">(</span>Input.source_content <span class="entity">source</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">Prog</span> <span class="main">=&gt;</span>
          Syntax.implode_input <span class="entity">source</span>
          |&gt; Syntax.parse_term <span class="entity">ctxt</span>
          |&gt; Type.constraint <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">Ast.prog</span><span class="antiquote">}</span></span>
          |&gt; Syntax.check_term <span class="entity">ctxt</span>
          |&gt; <span class="entity">string_of_prog</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> tracing <span class="main">(</span><span class="inner_quoted">"Evaluating: "</span> ^ <span class="entity">source</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">output</span> <span class="main">=</span> <span class="entity">eval</span> <span class="entity">mode</span> <span class="entity">source</span>
  <span class="keyword2"><span class="keyword">in</span></span> writeln <span class="entity">output</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.command</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword1">cakeml</span>›</span></span> <span class="inner_quoted">"evalute CakeML source"</span>
    <span class="main">(</span><span class="entity">parse_mode</span> -- Parse.input Parse.text &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">mode</span><span class="main">,</span> <span class="entity">src</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="entity">Toplevel.keep</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">state</span> <span class="main">=&gt;</span> <span class="entity">cakeml_cmd</span> <span class="main">(</span><span class="entity">Toplevel.context_of</span> <span class="entity">state</span><span class="main">)</span> <span class="entity">mode</span> <span class="entity">src</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Compiler_Test">
<div class="head">
<h1>Theory Compiler_Test</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Compiler_Test
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#CakeML_Compiler">../CakeML_Compiler</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">default_loc</span> <span class="main">::</span> <span class="quoted">locs</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">default_loc</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">⦇</span> locn.row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> locn.col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> locn.offset <span class="main">=</span> <span class="main">0</span> <span class="main">⦈</span><span class="main">,</span>
   <span class="main">⦇</span> locn.row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> locn.col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> locn.offset <span class="main">=</span> <span class="main">0</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_print</span> <span class="main">::</span> <span class="quoted">Ast.prog</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">simple_print</span> <span class="main">=</span>
  <span class="main">[</span>Ast.Tdec <span class="main">(</span>Ast.Dlet default_loc Ast.Pany <span class="main">(</span>Ast.App Ast.Opapp <span class="main">[</span>Ast.Var <span class="main">(</span>Short <span class="inner_quoted">''print''</span><span class="main">)</span><span class="main">,</span> Ast.Lit <span class="main">(</span>Ast.StrLit <span class="inner_quoted">''hi''</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">cakeml</span></span> <span class="main">(</span>literal<span class="main">)</span> <span class="quoted">‹print "hi1";›</span>
<span class="keyword1"><span class="command">cakeml</span></span> <span class="main">(</span>literal<span class="main">)</span> <span class="quoted">‹print "hi2";›</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">out</span> <span class="main">=</span> <span class="entity">CakeML_Compiler.eval_source</span> <span class="entity">CakeML_Compiler.Literal</span> <span class="antiquoted"><span class="entity"><span class="operator">‹</span>val x = 3 + 4; print (Int.toString x);›</span></span><span class="main">;</span>
  <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">assert</span><span class="antiquote">}</span></span></span></span> <span class="main">(</span><span class="entity">out</span> <span class="main">=</span> <span class="inner_quoted">"7"</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">cakeml</span></span> <span class="main">(</span>prog<span class="main">)</span> <span class="quoted"><span class="quoted">‹simple_print›</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Code_Test_Haskell">
<div class="head">
<h1>Theory Code_Test_Haskell</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Code_Test_Haskell
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="#CakeML_Code">../CakeML_Code</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">evaluate</span></span> <span class="quoted"><span class="quoted">fun_evaluate</span></span> <span class="quoted"><span class="quoted">fun_evaluate_prog</span></span> <span class="quoted"><span class="quoted">prim_sem_env</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> Haskell

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>